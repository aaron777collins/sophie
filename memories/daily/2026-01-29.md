# 2026-01-29 Session Notes

## WYDOT Infrastructure S3 Access Fix

### Issue
Aaron reported bugs with WYDOT infrastructure and S3 access.

**Root Cause Found:**
The USDOT ITS CV Pilot S3 bucket (`usdot-its-cvpilot-publicdata`) has changed its access policy:
- **Previously:** Anonymous/public access allowed (no credentials needed)
- **Now:** AWS credentials required for all access

The original code used `botocore.config.signature_version=UNSIGNED` which no longer works.

### Fix Applied (commit `2e9b42a`)
Updated `DataSources/S3DataFetcher.py`:
1. Added `_create_s3_client()` method with proper authentication handling
2. Support for AWS profile configuration via `config.download.aws_profile`
3. Fallback to default credentials from `~/.aws/credentials` or environment
4. Clear error messages with setup instructions when credentials missing
5. Optional anonymous mode via `config.download.use_anonymous=True` (will likely fail)

Updated `DataSources/config.py`:
- Added `aws_profile: Optional[str]` to DownloadConfig
- Added `use_anonymous: bool = False` to DownloadConfig

### To Enable S3 Access
User must configure AWS credentials:
1. Create free AWS account at https://aws.amazon.com
2. Create Access Keys in AWS Console > Security Credentials
3. Configure with `aws configure` or manually create `~/.aws/credentials`:
   ```ini
   [default]
   aws_access_key_id = YOUR_KEY
   aws_secret_access_key = YOUR_SECRET
   ```

### References
- USDOT Sandbox docs: https://github.com/usdot-its-jpo-data-portal/sandbox#prerequisites-for-using-aws-cli
- Sandbox exporter (alternative): https://github.com/usdot-its-jpo-data-portal/sandbox_exporter

### Status
- [x] Identified root cause (bucket policy change)
- [x] Updated code to require/support AWS credentials
- [x] Added clear error messages
- [x] Committed fix
- [ ] AWS credentials need to be configured to test actual data access

---

## Full Test Suite with Synthetic Data

### New Components Created

**SyntheticDataGenerator** (`DataSources/SyntheticDataGenerator.py`)
- Generates realistic WYDOT BSM records
- Wyoming I-80 corridor coordinates
- Vehicle trajectory simulation (50 vehicles)
- NDJSON file output matching S3 structure
- Performance: ~15,600 records/sec

**MockS3DataFetcher** (`DataSources/MockS3DataFetcher.py`)
- Local file-based mock for S3DataFetcher
- Same interface, works without AWS credentials
- Supports date ranges, statistics, object listing

### Bugs Found and Fixed

1. **SchemaValidator.py** - Wrong elevation field path
   - Bug: `payload.data.coreData.elevation`
   - Fix: `payload.data.coreData.position.elevation`

2. **conftest.py** - PySpark import fails tests
   - Made Spark/Dask imports conditional
   - Tests now run without heavy dependencies

3. **Test/Fixtures/__init__.py** - Same conditional import fix

### Test Results
- CacheManager: ✅
- Schema validation: ✅
- MockS3DataFetcher: ✅
- End-to-end pipeline: ✅
- Config validation: ✅
- Large dataset (10K records): ✅
- Validation speed: ~87,400 records/sec

### Archived Test Data
Location: `test_data/synthetic_wydot/`
- 7,200 synthetic BSM records
- 3 days × 24 hours × 100 records/hour
- Matches real WYDOT S3 bucket structure
- Ready for pipeline testing

### Commits
- `2e9b42a` - fix(DataSources): S3 authentication
- `a0993aa` - feat(DataSources): Testing infrastructure + bug fixes
- `7e16bf8` - feat: ML pipeline config + integration tests

---

## Full ML Pipeline Integration Validated

### Created ML Pipeline Config
`configs/dask/wydot-synthetic-ml.yml` - Complete ML pipeline configuration:
- Data source settings (WYDOT BSM)
- Dask cluster config (4 workers, 6GB each)
- Feature extraction (position, motion, derived)
- ML model settings (RandomForest for anomaly detection)
- **Cache settings** (critical for S3 cost control)

### Integration Test Results (tests/test_ml_integration.py)

| Test | Status | Details |
|------|--------|---------|
| Full ML Pipeline | ✅ | 7,200 records in 1.59s |
| Cache Prevents Re-fetch | ✅ | Works even after source deleted |
| Cache TTL | ✅ | TTL config works correctly |

### Cache Performance (Critical for S3 costs)
- **First fetch:** 0.38s
- **Cache fetch:** 0.02s
- **Speedup: 19.7x** faster
- **With real S3:** Every cached fetch saves egress fees

### Bug Fixed
- SyntheticDataGenerator: Vehicles drifted outside valid longitude range
- Added coordinate clamping to Wyoming bounds (-108 to -104)
- Added boundary bounce-back behavior

### System Fully Validated
✅ Data loading from synthetic S3 structure
✅ Schema validation (100% pass rate)
✅ Dask DataFrame processing  
✅ Parquet caching (verified integrity)
✅ Feature extraction (17 features)
✅ Attack simulation (30% anomaly rate)
✅ ML-ready output

**Ready for real data once AWS credentials configured.**
