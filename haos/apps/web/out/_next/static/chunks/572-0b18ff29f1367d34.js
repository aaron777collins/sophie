"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[572],{45922:(e,t,r)=>{r.d(t,{cn:()=>a});var i=r(80728),s=r(97096);function a(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return(0,s.QP)((0,i.$)(t))}},74573:(e,t,r)=>{r.d(t,{MatrixProvider:()=>Q,j:()=>K});var i=r(14034),s=r(86042),a=r(64240);let n={info:console.log,warn:console.warn,error:console.error};class o{async startup(){if(!this.isReady)return new Promise((e,t)=>{let r=indexedDB.open(this.dbName,1);r.onerror=()=>{n.error("Failed to open IndexedDB for crypto store:",r.error),t(r.error)},r.onsuccess=()=>{this.db=r.result,this.isReady=!0,n.info("IndexedDB crypto store initialized successfully"),e()},r.onupgradeneeded=e=>{let t=e.target.result;t.objectStoreNames.contains("account")||t.createObjectStore("account",{keyPath:"key"}),t.objectStoreNames.contains("sessions")||t.createObjectStore("sessions",{keyPath:"key"}),t.objectStoreNames.contains("inbound_group_sessions")||t.createObjectStore("inbound_group_sessions",{keyPath:"key"}),t.objectStoreNames.contains("outbound_group_sessions")||t.createObjectStore("outbound_group_sessions",{keyPath:"key"}),t.objectStoreNames.contains("device_data")||t.createObjectStore("device_data",{keyPath:"key"}),t.objectStoreNames.contains("cross_signing_keys")||t.createObjectStore("cross_signing_keys",{keyPath:"key"}),n.info("IndexedDB crypto store schema created")}})}async shutdown(){this.db&&(this.db.close(),this.db=null),this.isReady=!1,n.info("IndexedDB crypto store shut down")}async setItem(e,t,r){if(!this.isReady||!this.db)throw Error("Crypto store not ready");return new Promise((i,s)=>{let a=this.db.transaction([e],"readwrite").objectStore(e).put({key:t,value:r});a.onerror=()=>{n.error("Failed to store item in ".concat(e,":"),a.error),s(a.error)},a.onsuccess=()=>{i()}})}async getItem(e,t){if(!this.isReady||!this.db)throw Error("Crypto store not ready");return new Promise((r,i)=>{let s=this.db.transaction([e],"readonly").objectStore(e).get(t);s.onerror=()=>{n.error("Failed to get item from ".concat(e,":"),s.error),i(s.error)},s.onsuccess=()=>{let e=s.result;r(e?e.value:void 0)}})}async removeItem(e,t){if(!this.isReady||!this.db)throw Error("Crypto store not ready");return new Promise((r,i)=>{let s=this.db.transaction([e],"readwrite").objectStore(e).delete(t);s.onerror=()=>{n.error("Failed to remove item from ".concat(e,":"),s.error),i(s.error)},s.onsuccess=()=>{r()}})}async getAllKeys(e){if(!this.isReady||!this.db)throw Error("Crypto store not ready");return new Promise((t,r)=>{let i=this.db.transaction([e],"readonly").objectStore(e).getAllKeys();i.onerror=()=>{n.error("Failed to get all keys from ".concat(e,":"),i.error),r(i.error)},i.onsuccess=()=>{t(i.result)}})}async clear(){if(!this.isReady||!this.db)throw Error("Crypto store not ready");for(let e of["account","sessions","inbound_group_sessions","outbound_group_sessions","device_data","cross_signing_keys"])await new Promise((t,r)=>{let i=this.db.transaction([e],"readwrite").objectStore(e).clear();i.onerror=()=>{n.error("Failed to clear ".concat(e,":"),i.error),r(i.error)},i.onsuccess=()=>{t()}});n.info("Crypto store cleared")}isStarted(){return this.isReady}constructor(e){this.db=null,this.isReady=!1,this.dbName="haos-crypto-state-".concat(e.replace(/[^a-zA-Z0-9]/g,"_"))}}let c={info:console.log,warn:console.warn,error:console.error},l=null,d=null;async function u(e,t,r){try{if(c.info("Initializing Matrix client with crypto support"),l&&l.baseUrl===e)return l;l&&await h(),r&&(d=new o(r),await d.startup(),c.info("Crypto store initialized for user:",r));let i={baseUrl:e,userId:r,accessToken:t,deviceId:m(),timelineSupport:!0,unstableClientRelationAggregation:!0};return l=(0,a.UU6)(i),t&&r&&d&&await f(l,r),c.info("Matrix client initialized successfully"),l}catch(e){throw c.error("Failed to initialize Matrix client:",e),e}}async function f(e,t){try{c.info("Initializing Rust crypto...");let t=await Promise.all([r.e(323),r.e(44)]).then(r.t.bind(r,63391,23));await t.initAsync(),await e.initRustCrypto({useIndexedDB:!0}),c.info("Rust crypto initialized successfully")}catch(e){c.error("Failed to initialize Rust crypto:",e)}}async function h(){try{l&&(c.info("Shutting down Matrix client..."),l.stopClient(),l.isCryptoEnabled()&&await l.clearStores(),l=null),d&&(await d.shutdown(),d=null),c.info("Matrix client shut down successfully")}catch(e){c.error("Error shutting down Matrix client:",e)}}function m(){let e=localStorage.getItem("haos-device-id");if(e)return e;let t="HAOS_".concat(Math.random().toString(36).substr(2,9));return localStorage.setItem("haos-device-id",t),t}async function g(e,t,r){try{c.info("Logging in with password...");let i=(0,a.UU6)({baseUrl:e}),s=await i.login("m.login.password",{user:t,password:r,device_id:m(),initial_device_display_name:"HAOS Web Client"}),n={baseUrl:e,accessToken:s.access_token,userId:s.user_id,deviceId:s.device_id};localStorage.setItem("haos-matrix-session",JSON.stringify(n));let o=await u(e,s.access_token,s.user_id);return await o.startClient({initialSyncLimit:20}),c.info("Login completed successfully"),o}catch(e){throw c.error("Login failed:",e),e}}async function v(){try{if(l)try{await l.logout()}catch(e){c.warn("Server logout failed, continuing with local cleanup:",e)}}catch(e){c.error("Logout error:",e)}finally{localStorage.removeItem("haos-matrix-session"),localStorage.removeItem("haos-first-run-completed"),await h()}}var x=r(45374),y=r(22247),p=r(81717),b=r(53917),w=r(31289),j=r(26912),N=r(70745),S=r(13918),I=r(26122),C=r(53703),k=r(68687),E=r(45922);let D=(0,s.createContext)(void 0);function _(e){let{children:t,open:r=!1,onOpenChange:s}=e;return(0,i.jsx)(D.Provider,{value:{open:r,onOpenChange:s||(()=>{})},children:t})}function V(e){let{className:t,children:r,hideCloseButton:a=!1,...n}=e,o=(0,s.useContext)(D);return(null==o?void 0:o.open)?(0,i.jsxs)("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:[(0,i.jsx)("div",{className:"fixed inset-0 bg-background/80 backdrop-blur-sm",onClick:()=>o.onOpenChange(!1)}),(0,i.jsxs)("div",{className:(0,E.cn)("relative z-50 grid w-full max-w-lg gap-4 border bg-background p-6 shadow-lg duration-200","data-[state=open]:animate-in data-[state=closed]:animate-out","data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0","data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95","data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%]","data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%]","sm:rounded-lg",t),...n,children:[r,!a&&(0,i.jsxs)("button",{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none",onClick:()=>o.onOpenChange(!1),children:[(0,i.jsx)(k.A,{className:"h-4 w-4"}),(0,i.jsx)("span",{className:"sr-only",children:"Close"})]})]})]}):null}function R(e){let{className:t,children:r,...s}=e;return(0,i.jsx)("div",{className:(0,E.cn)("flex flex-col space-y-1.5 text-center sm:text-left",t),...s,children:r})}function F(e){let{className:t,children:r,...s}=e;return(0,i.jsx)("h2",{className:(0,E.cn)("text-lg font-semibold leading-none tracking-tight",t),...s,children:r})}let P=s.forwardRef((e,t)=>{let{className:r,variant:s="default",size:a="default",...n}=e,o=(0,E.cn)("inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors","focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2","disabled:pointer-events-none disabled:opacity-50");return(0,i.jsx)("button",{className:(0,E.cn)(o,{default:"bg-primary text-primary-foreground hover:bg-primary/90",destructive:"bg-destructive text-destructive-foreground hover:bg-destructive/90",outline:"border border-input bg-background hover:bg-accent hover:text-accent-foreground",secondary:"bg-secondary text-secondary-foreground hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground"}[s],{default:"h-10 px-4 py-2",sm:"h-9 rounded-md px-3",lg:"h-11 rounded-md px-8"}[a],r),ref:t,...n})});P.displayName="Button";let A={info:console.log,warn:console.warn,error:console.error};class M{getState(){return{...this.state}}updateState(e){this.state={...this.state,...e},this.events.onStateChange(this.state)}async startVerification(e,t){try{A.info("Starting device verification",{userId:e,deviceId:t}),this.updateState({isVerifying:!0,phase:"requesting",error:null});let r={requestId:"verify_".concat(Date.now()),otherUserId:e,targetDevice:t?{deviceId:t}:void 0,phase:"ready"};this.updateState({request:r,phase:"ready"})}catch(t){let e=t instanceof Error?t.message:"Unknown error";A.error("Failed to start verification:",e),this.updateState({error:e,phase:"idle",isVerifying:!1}),this.events.onVerificationFailed(e)}}async acceptVerification(e){try{A.info("Accepting verification request"),this.updateState({request:e,isVerifying:!0,phase:"ready",error:null})}catch(t){let e=t instanceof Error?t.message:"Unknown error";A.error("Failed to accept verification:",e),this.updateState({error:e,phase:"idle",isVerifying:!1}),this.events.onVerificationFailed(e)}}async startEmojiVerification(){try{let{request:e}=this.state;if(!e)throw Error("No verification request available");A.info("Starting emoji verification"),this.updateState({method:"emoji",phase:"showing_sas",emoji:[{emoji:"\uD83C\uDF89",description:"Party"},{emoji:"\uD83D\uDD10",description:"Lock"},{emoji:"\uD83C\uDF1F",description:"Star"},{emoji:"\uD83E\uDD84",description:"Unicorn"},{emoji:"\uD83C\uDFAF",description:"Target"},{emoji:"\uD83C\uDFAA",description:"Circus"},{emoji:"\uD83C\uDFA8",description:"Art"}]})}catch(t){let e=t instanceof Error?t.message:"Unknown error";A.error("Failed to start emoji verification:",e),this.updateState({error:e,phase:"idle",isVerifying:!1}),this.events.onVerificationFailed(e)}}async startQRVerification(){try{let{request:e}=this.state;if(!e)throw Error("No verification request available");A.info("Starting QR verification");let t=await this.generateQRCode(e);this.updateState({method:"qr",phase:"showing_sas",qrCode:t})}catch(t){let e=t instanceof Error?t.message:"Unknown error";A.error("Failed to start QR verification:",e),this.updateState({error:e,phase:"idle",isVerifying:!1}),this.events.onVerificationFailed(e)}}async confirmEmojiMatch(){try{A.info("Confirming emoji match"),this.updateState({phase:"waiting_for_partner"}),setTimeout(()=>{var e;this.updateState({phase:"done",isVerifying:!1});let{request:t}=this.state,r=(null==t?void 0:t.otherUserId)||"",i=(null==t||null==(e=t.targetDevice)?void 0:e.deviceId)||"";this.events.onVerificationComplete(i,r)},2e3)}catch(t){let e=t instanceof Error?t.message:"Unknown error";A.error("Failed to confirm emoji match:",e),this.updateState({error:e}),this.events.onVerificationFailed(e)}}async cancelVerification(){try{A.info("Cancelling verification"),this.updateState({isVerifying:!1,request:null,verifier:null,method:null,phase:"cancelled",emoji:void 0,qrCode:void 0}),this.events.onVerificationCancelled()}catch(t){let e=t instanceof Error?t.message:"Unknown error";A.error("Failed to cancel verification:",e),this.updateState({error:e})}}async generateQRCode(e){return JSON.stringify({action:"verify",version:1,userId:this.client.getUserId(),deviceId:this.client.getDeviceId(),requestId:e.requestId,timestamp:Date.now()})}async isDeviceVerified(e,t){try{return!1}catch(e){return A.error("Failed to check device verification status:",e),!1}}async getUnverifiedDevices(e){try{return[{deviceId:"ABCDEFGH",displayName:"Chrome on Desktop"},{deviceId:"IJKLMNOP",displayName:"Mobile Phone"}]}catch(e){return A.error("Failed to get unverified devices:",e),[]}}destroy(){this.updateState({isVerifying:!1,request:null,verifier:null,method:null,phase:"idle",emoji:void 0,qrCode:void 0})}constructor(e,t){this.client=e,this.events=t,this.state={isVerifying:!1,request:null,verifier:null,method:null,error:null,phase:"idle"}}}async function O(e){try{let t=e.getUserId()||"@demo:matrix.org";return{verified:[{userId:t,deviceId:"VERIFIED01",displayName:"This Device"}],unverified:[{userId:t,deviceId:"ABCDEFGH",displayName:"Chrome on Desktop"},{userId:t,deviceId:"IJKLMNOP",displayName:"Mobile Phone"}]}}catch(e){return A.error("Failed to get verification status:",e),{verified:[],unverified:[]}}}let L={info:console.log,warn:console.warn,error:console.error},T={info:console.log,warn:console.warn,error:console.error},U={DEVICE_REGISTRY:"haos-device-registry",FIRST_LOGIN_COMPLETED:"haos-first-login-completed",DEVICE_PROMPT_SHOWN:"haos-device-prompt-shown",LAST_LOGIN_TIMESTAMP:"haos-last-login-timestamp"};function q(){let{client:e,isAuthenticated:t,userId:r}=K(),[i,a]=(0,s.useState)({isFirstLogin:!1,isNewDevice:!1,hasShownDevicePrompt:!1,deviceInfo:{deviceId:null,isNewDeviceId:!1,lastLoginTimestamp:null}}),n=(0,s.useCallback)(()=>{try{let e=localStorage.getItem(U.DEVICE_REGISTRY);if(!e)return{devices:{},currentDeviceId:null};return JSON.parse(e)}catch(e){return T.warn("Failed to parse device registry, resetting:",e),{devices:{},currentDeviceId:null}}},[]),o=(0,s.useCallback)(e=>{try{localStorage.setItem(U.DEVICE_REGISTRY,JSON.stringify(e))}catch(e){T.error("Failed to save device registry:",e)}},[]),c=(0,s.useCallback)(()=>(null==e?void 0:e.getDeviceId())||localStorage.getItem("haos-device-id")||null,[e]),l=(0,s.useCallback)(()=>!localStorage.getItem(U.FIRST_LOGIN_COMPLETED),[]),d=(0,s.useCallback)(e=>!n().devices[e],[n]),u=(0,s.useCallback)(()=>!!sessionStorage.getItem(U.DEVICE_PROMPT_SHOWN),[]),f=(0,s.useCallback)(function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=n(),i=Date.now();t||!r.devices[e]?(r.devices[e]={deviceId:e,firstSeenAt:i,lastSeenAt:i,displayName:"HAOS Web Client",hasCompletedVerification:!1},T.info("Registered new device:",e)):(r.devices[e].lastSeenAt=i,T.info("Updated existing device timestamp:",e)),r.currentDeviceId=e,o(r),localStorage.setItem(U.LAST_LOGIN_TIMESTAMP,i.toString())},[n,o]),h=(0,s.useCallback)(()=>{if(!t||!r)return void a(e=>({...e,isFirstLogin:!1,isNewDevice:!1,hasShownDevicePrompt:!1,deviceInfo:{deviceId:null,isNewDeviceId:!1,lastLoginTimestamp:null}}));let e=c();if(!e)return void T.warn("No device ID available");let i=l(),s=d(e),n=u(),o=localStorage.getItem(U.LAST_LOGIN_TIMESTAMP);(s||i)&&f(e,s),a({isFirstLogin:i,isNewDevice:s,hasShownDevicePrompt:n,deviceInfo:{deviceId:e,isNewDeviceId:s,lastLoginTimestamp:o?parseInt(o):null}}),T.info("First login detection state updated:",{isFirstLogin:i,isNewDevice:s,hasShownDevicePrompt:n,deviceId:e})},[t,r,c,l,d,u,f]),m=(0,s.useCallback)(()=>{sessionStorage.setItem(U.DEVICE_PROMPT_SHOWN,"true"),a(e=>({...e,hasShownDevicePrompt:!0})),T.info("Device prompt marked as shown")},[]),g=(0,s.useCallback)(()=>{let e=c();if(e){let t=n();t.devices[e]&&(t.devices[e].hasCompletedVerification=!1,o(t))}m(),T.info("Device verification skipped by user")},[c,n,o,m]),v=(0,s.useCallback)(()=>{localStorage.removeItem(U.FIRST_LOGIN_COMPLETED),localStorage.removeItem(U.DEVICE_REGISTRY),localStorage.removeItem(U.LAST_LOGIN_TIMESTAMP),sessionStorage.removeItem(U.DEVICE_PROMPT_SHOWN),h(),T.info("First login state reset")},[h]),x=(0,s.useCallback)(()=>{localStorage.setItem(U.FIRST_LOGIN_COMPLETED,"true"),T.info("First login marked as completed")},[]);return(0,s.useEffect)(()=>{h()},[t,r,e,h]),(0,s.useEffect)(()=>{if(t&&i.isFirstLogin){let e=setTimeout(()=>{x()},1e3);return()=>clearTimeout(e)}},[t,i.isFirstLogin]),{...i,markDevicePromptShown:m,skipDeviceVerification:g,resetFirstLoginState:v}}let z={info:console.log,warn:console.warn,error:console.error};function B(e){let{isOpen:t,onClose:r,reason:a,onVerificationStarted:n}=e,{unverifiedDevices:o,openModal:c,refreshDeviceLists:l}=function(){let{client:e,isAuthenticated:t,isCryptoReady:r}=K(),[i,a]=(0,s.useState)(null),[n,o]=(0,s.useState)({isVerifying:!1,request:null,verifier:null,method:null,error:null,phase:"idle"}),[c,l]=(0,s.useState)([]),[d,u]=(0,s.useState)([]),[f,h]=(0,s.useState)(!1),[m,g]=(0,s.useState)(!1),v=(0,s.useRef)(null);(0,s.useEffect)(()=>{if(!e||!t||!r){v.current&&(v.current.destroy(),v.current=null,a(null));return}L.info("Initializing device verification manager");let i=new M(e,{onStateChange:e=>{L.info("Verification state changed:",e.phase),o(e)},onVerificationComplete:(e,t)=>{L.info("Device verification completed:",{deviceId:e,userId:t}),S(),h(!1)},onVerificationFailed:e=>{L.error("Device verification failed:",e)},onVerificationCancelled:()=>{L.info("Device verification cancelled"),h(!1)}});v.current=i,a(i);let s=e=>{L.info("Incoming verification request received:",e.requestId),h(!0),o(t=>({...t,request:e,phase:"ready"}))};return e.on("crypto.verification.request",s),S(),()=>{e.off("crypto.verification.request",s),v.current&&(v.current.destroy(),v.current=null)}},[e,t,r]);let x=(0,s.useCallback)(async(e,t)=>{if(!i)throw Error("Verification manager not available");h(!0),await i.startVerification(e,t)},[i]),y=(0,s.useCallback)(async e=>{if(!i)throw Error("Verification manager not available");await i.acceptVerification(e)},[i]),p=(0,s.useCallback)(async()=>{if(!i)throw Error("Verification manager not available");await i.startEmojiVerification()},[i]),b=(0,s.useCallback)(async()=>{if(!i)throw Error("Verification manager not available");await i.startQRVerification()},[i]),w=(0,s.useCallback)(async()=>{if(!i)throw Error("Verification manager not available");await i.confirmEmojiMatch()},[i]),j=(0,s.useCallback)(async()=>{if(!i)throw Error("Verification manager not available");await i.cancelVerification(),h(!1)},[i]),N=(0,s.useCallback)(async(e,t)=>!!i&&await i.isDeviceVerified(e,t),[i]),S=(0,s.useCallback)(async()=>{if(e&&r)try{g(!0),L.info("Refreshing device verification status");let t=await O(e);l(t.verified),u(t.unverified),L.info("Device lists updated:",{verified:t.verified.length,unverified:t.unverified.length})}catch(e){L.error("Failed to refresh device lists:",e)}finally{g(!1)}},[e,r]),I=(0,s.useCallback)(()=>{h(!0)},[]),C=(0,s.useCallback)(()=>{h(!1),n.isVerifying&&i&&i.cancelVerification()},[n.isVerifying,i]);return(0,s.useEffect)(()=>{r&&S()},[r,S]),{verificationState:n,manager:i,verifiedDevices:c,unverifiedDevices:d,showModal:f,isLoading:m,startVerification:x,acceptVerification:y,startEmojiVerification:p,startQRVerification:b,confirmEmojiMatch:w,cancelVerification:j,checkDeviceVerification:N,refreshDeviceLists:S,openModal:I,closeModal:C}}(),{skipDeviceVerification:d,markDevicePromptShown:u,deviceInfo:f}=q(),[h,m]=(0,s.useState)("intro"),[g,v]=(0,s.useState)(null);(0,s.useEffect)(()=>{t&&(m("intro"),v(null),l())},[t,l]);let E=()=>{z.info("User chose to start device verification"),v("verify"),u(),null==n||n(),r(),c()},D=()=>{z.info("User chose to skip device verification"),v("skip"),d(),r()},A=()=>{m("explanation")},T=()=>{m("tutorial")},U=e=>{switch(e){case"first-login":return{title:"Welcome to HAOS!",subtitle:"Let's secure your account by verifying this device.",icon:(0,i.jsx)(j.A,{className:"w-8 h-8 text-blue-400"}),iconBg:"bg-blue-500/20"};case"new-device":return{title:"New Device Detected",subtitle:"We notice you're using HAOS on a new device. Let's verify it for security.",icon:(0,i.jsx)(I.A,{className:"w-8 h-8 text-orange-400"}),iconBg:"bg-orange-500/20"};case"unverified-devices":return{title:"Unverified Devices Found",subtitle:"You have ".concat(o.length," unverified device").concat(1!==o.length?"s":""," that can access your messages."),icon:(0,i.jsx)(C.A,{className:"w-8 h-8 text-yellow-400"}),iconBg:"bg-yellow-500/20"};default:return{title:"Device Verification",subtitle:"Secure your account by verifying your devices.",icon:(0,i.jsx)(j.A,{className:"w-8 h-8 text-gray-400"}),iconBg:"bg-gray-500/20"}}};return t?(0,i.jsx)(_,{open:t,onOpenChange:r,children:(0,i.jsxs)(V,{className:"sm:max-w-lg bg-gray-800 border-gray-700 text-white",children:[(0,i.jsx)(R,{children:(0,i.jsxs)("div",{className:"flex items-center justify-between",children:[(0,i.jsxs)(F,{className:"text-white flex items-center gap-2",children:[(0,i.jsx)(j.A,{className:"w-5 h-5 text-blue-400"}),"Device Security"]}),(0,i.jsx)(P,{variant:"outline",size:"sm",onClick:r,className:"h-8 w-8 p-0 border-gray-600 hover:border-gray-500",children:(0,i.jsx)(k.A,{className:"w-4 h-4"})})]})}),(0,i.jsx)("div",{className:"px-6 pb-6",children:(()=>{switch(h){case"intro":default:let e=U(a);return(0,i.jsxs)("div",{className:"space-y-6",children:[(0,i.jsxs)("div",{className:"text-center space-y-3",children:[(0,i.jsx)("div",{className:"w-16 h-16 mx-auto rounded-full flex items-center justify-center ".concat(e.iconBg),children:e.icon}),(0,i.jsxs)("div",{children:[(0,i.jsx)("h3",{className:"text-xl font-semibold text-white mb-2",children:e.title}),(0,i.jsx)("p",{className:"text-gray-300 text-sm max-w-md mx-auto",children:e.subtitle})]})]}),(0,i.jsxs)("div",{className:"bg-gray-700/30 rounded-lg p-4",children:[(0,i.jsxs)("h4",{className:"text-sm font-medium text-white mb-3 flex items-center gap-2",children:[(0,i.jsx)(x.A,{className:"w-4 h-4"}),"Why Verify Your Device?"]}),(0,i.jsxs)("ul",{className:"space-y-2 text-sm text-gray-300",children:[(0,i.jsxs)("li",{className:"flex items-start gap-2",children:[(0,i.jsx)(y.A,{className:"w-4 h-4 text-green-500 flex-shrink-0 mt-0.5"}),(0,i.jsx)("span",{children:"Secure your encrypted messages"})]}),(0,i.jsxs)("li",{className:"flex items-start gap-2",children:[(0,i.jsx)(y.A,{className:"w-4 h-4 text-green-500 flex-shrink-0 mt-0.5"}),(0,i.jsx)("span",{children:"Prevent unauthorized access"})]}),(0,i.jsxs)("li",{className:"flex items-start gap-2",children:[(0,i.jsx)(y.A,{className:"w-4 h-4 text-green-500 flex-shrink-0 mt-0.5"}),(0,i.jsx)("span",{children:"Enable secure device sync"})]})]})]}),f.deviceId&&(0,i.jsxs)("div",{className:"bg-gray-700/30 rounded-lg p-4",children:[(0,i.jsxs)("h4",{className:"text-sm font-medium text-white mb-2 flex items-center gap-2",children:[(0,i.jsx)(p.A,{className:"w-4 h-4"}),"Current Device"]}),(0,i.jsxs)("div",{className:"text-sm text-gray-300",children:[(0,i.jsxs)("p",{className:"font-mono text-xs text-gray-400 mb-1",children:["ID: ",f.deviceId]}),(0,i.jsx)("p",{className:"text-xs",children:f.isNewDeviceId?"New device detected":"Known device"})]})]}),(0,i.jsxs)("div",{className:"flex gap-3",children:[(0,i.jsx)(P,{onClick:D,variant:"outline",className:"flex-1 text-gray-300 border-gray-600 hover:border-gray-500",children:"Skip for Now"}),(0,i.jsxs)(P,{onClick:A,className:"flex-1 bg-blue-600 hover:bg-blue-700",children:["Learn More",(0,i.jsx)(b.A,{className:"w-4 h-4 ml-2"})]})]})]});case"explanation":return(0,i.jsxs)("div",{className:"space-y-6",children:[(0,i.jsxs)("div",{className:"text-center space-y-2",children:[(0,i.jsx)("div",{className:"w-12 h-12 mx-auto bg-blue-500/20 rounded-full flex items-center justify-center",children:(0,i.jsx)(w.A,{className:"w-6 h-6 text-blue-400"})}),(0,i.jsx)("h3",{className:"text-lg font-semibold text-white",children:"How Device Verification Works"})]}),(0,i.jsxs)("div",{className:"space-y-4",children:[(0,i.jsxs)("div",{className:"flex gap-3",children:[(0,i.jsx)("div",{className:"w-8 h-8 bg-blue-500/20 rounded-full flex items-center justify-center flex-shrink-0",children:(0,i.jsx)("span",{className:"text-sm font-medium text-blue-400",children:"1"})}),(0,i.jsxs)("div",{children:[(0,i.jsx)("h4",{className:"text-sm font-medium text-white mb-1",children:"Compare Security Codes"}),(0,i.jsx)("p",{className:"text-xs text-gray-400",children:"We'll show emoji or QR codes on both devices. Make sure they match exactly."})]})]}),(0,i.jsxs)("div",{className:"flex gap-3",children:[(0,i.jsx)("div",{className:"w-8 h-8 bg-blue-500/20 rounded-full flex items-center justify-center flex-shrink-0",children:(0,i.jsx)("span",{className:"text-sm font-medium text-blue-400",children:"2"})}),(0,i.jsxs)("div",{children:[(0,i.jsx)("h4",{className:"text-sm font-medium text-white mb-1",children:"Confirm the Match"}),(0,i.jsx)("p",{className:"text-xs text-gray-400",children:"If the codes match, confirm on both devices. If not, something's wrong."})]})]}),(0,i.jsxs)("div",{className:"flex gap-3",children:[(0,i.jsx)("div",{className:"w-8 h-8 bg-green-500/20 rounded-full flex items-center justify-center flex-shrink-0",children:(0,i.jsx)("span",{className:"text-sm font-medium text-green-400",children:"3"})}),(0,i.jsxs)("div",{children:[(0,i.jsx)("h4",{className:"text-sm font-medium text-white mb-1",children:"Secure Communication"}),(0,i.jsx)("p",{className:"text-xs text-gray-400",children:"Your devices are now verified and can safely share encrypted messages."})]})]})]}),(0,i.jsxs)("div",{className:"bg-gray-700/30 rounded-lg p-3",children:[(0,i.jsxs)("div",{className:"flex items-center gap-2 mb-1",children:[(0,i.jsx)(j.A,{className:"w-4 h-4 text-gray-400"}),(0,i.jsx)("span",{className:"text-sm font-medium text-gray-300",children:"Matrix Protocol"})]}),(0,i.jsx)("p",{className:"text-xs text-gray-400",children:"This verification uses Matrix's end-to-end encryption standard, ensuring your messages are secure and private."})]}),(0,i.jsxs)("div",{className:"flex gap-3",children:[(0,i.jsx)(P,{onClick:()=>m("intro"),variant:"outline",className:"flex-1 text-gray-300 border-gray-600 hover:border-gray-500",children:"Back"}),(0,i.jsxs)(P,{onClick:T,className:"flex-1 bg-blue-600 hover:bg-blue-700",children:["See Tutorial",(0,i.jsx)(b.A,{className:"w-4 h-4 ml-2"})]})]})]});case"tutorial":return(0,i.jsxs)("div",{className:"space-y-6",children:[(0,i.jsxs)("div",{className:"text-center space-y-2",children:[(0,i.jsx)("div",{className:"w-12 h-12 mx-auto bg-green-500/20 rounded-full flex items-center justify-center",children:(0,i.jsx)(N.A,{className:"w-6 h-6 text-green-400"})}),(0,i.jsx)("h3",{className:"text-lg font-semibold text-white",children:"Ready to Verify?"})]}),(0,i.jsxs)("div",{className:"space-y-4",children:[(0,i.jsxs)("div",{className:"bg-gray-700/30 rounded-lg p-4",children:[(0,i.jsxs)("div",{className:"flex items-center gap-3 mb-2",children:[(0,i.jsx)("div",{className:"w-6 h-6 bg-yellow-500/20 rounded-full flex items-center justify-center",children:(0,i.jsx)("span",{className:"text-lg",children:"\uD83D\uDE00"})}),(0,i.jsx)("h4",{className:"text-sm font-medium text-white",children:"Emoji Method"})]}),(0,i.jsx)("p",{className:"text-xs text-gray-400 ml-9",children:"Compare emoji symbols shown on both devices. This is the easiest method."})]}),(0,i.jsxs)("div",{className:"bg-gray-700/30 rounded-lg p-4",children:[(0,i.jsxs)("div",{className:"flex items-center gap-3 mb-2",children:[(0,i.jsx)("div",{className:"w-6 h-6 bg-blue-500/20 rounded-full flex items-center justify-center",children:(0,i.jsx)("div",{className:"w-3 h-3 bg-blue-400 rounded-sm"})}),(0,i.jsx)("h4",{className:"text-sm font-medium text-white",children:"QR Code Method"})]}),(0,i.jsx)("p",{className:"text-xs text-gray-400 ml-9",children:"Scan a QR code with your other device's camera. Fast and secure."})]})]}),(0,i.jsx)("div",{className:"bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-3",children:(0,i.jsxs)("div",{className:"flex items-start gap-2",children:[(0,i.jsx)(S.A,{className:"w-4 h-4 text-yellow-500 flex-shrink-0 mt-0.5"}),(0,i.jsxs)("div",{children:[(0,i.jsx)("h4",{className:"text-sm font-medium text-yellow-400 mb-1",children:"Important Security Note"}),(0,i.jsx)("p",{className:"text-xs text-gray-300",children:"Only verify devices you control. If the codes don't match, someone may be trying to intercept your messages."})]})]})}),(0,i.jsxs)("div",{className:"flex gap-3",children:[(0,i.jsx)(P,{onClick:D,variant:"outline",className:"flex-1 text-gray-300 border-gray-600 hover:border-gray-500",children:"Skip for Now"}),(0,i.jsxs)(P,{onClick:E,className:"flex-1 bg-green-600 hover:bg-green-700",children:["Start Verification",(0,i.jsx)(N.A,{className:"w-4 h-4 ml-2"})]})]})]})}})()})]})}):null}function G(){let{shouldShowPrompt:e,promptReason:t}=function(){let{isFirstLogin:e,isNewDevice:t,hasShownDevicePrompt:r}=q(),i=!1,s=null;return!r&&(e?(i=!0,s="first-login"):t&&(i=!0,s="new-device")),{shouldShowPrompt:i,promptReason:s}}(),[r,a]=(0,s.useState)(!1);return((0,s.useEffect)(()=>{if(e&&t&&!r){let e=setTimeout(()=>{a(!0),z.info("Device verification prompt triggered:",t)},500);return()=>clearTimeout(e)}},[e,t,r]),t)?(0,i.jsx)(B,{isOpen:r,onClose:()=>{a(!1)},reason:t,onVerificationStarted:()=>{z.info("Device verification started from prompt")}}):null}let H={info:console.log,warn:console.warn,error:console.error},W=(0,s.createContext)(null);function Q(e){let{children:t}=e,[r,n]=(0,s.useState)(null),[o,d]=(0,s.useState)(!0),[f,m]=(0,s.useState)(!1),[x,y]=(0,s.useState)(!1),[p,b]=(0,s.useState)(null),[w,j]=(0,s.useState)(null);async function N(){try{d(!0),b(null);let e=function(){let e=localStorage.getItem("haos-matrix-session");if(!e)return null;try{return JSON.parse(e)}catch(e){return c.error("Failed to parse stored session:",e),localStorage.removeItem("haos-matrix-session"),null}}();if(e){H.info("Restoring Matrix session for:",e.userId);let t=await u(e.baseUrl,e.accessToken,e.userId);n(t),j(e.userId),m(!0),await t.startClient({initialSyncLimit:20}),H.info("Matrix client restored and started")}else H.info("No stored session found"),m(!1)}catch(e){H.error("Failed to initialize from storage:",e),b(e.message||"Failed to initialize Matrix client"),m(!1)}finally{d(!1)}}async function S(e,t,r){try{d(!0),b(null),H.info("Logging in to:",e,"as:",t);let i=await g(e,t,r);n(i),j(i.getUserId()),m(!0),H.info("Login successful")}catch(e){throw H.error("Login failed:",e),b(e.message||"Login failed"),e}finally{d(!1)}}async function I(){try{d(!0),b(null),await v(),n(null),j(null),m(!1),y(!1),H.info("Logout successful")}catch(e){H.error("Logout failed:",e),b(e.message||"Logout failed")}finally{d(!1)}}function C(){var e;let t=null!=(e=null==l?void 0:l.isCryptoEnabled())&&e;y(t),t?H.info("Crypto is ready and functional"):H.warn("Crypto is not ready")}return(0,s.useEffect)(()=>(N(),()=>{h()}),[]),(0,s.useEffect)(()=>{if(!r)return;let e=(e,t,r)=>{if(H.info("Matrix sync state:",e,t,r),"PREPARED"===e)C();else if("ERROR"===e){var i;b("Sync error: "+((null==r||null==(i=r.error)?void 0:i.message)||"Unknown error"))}},t=(e,t)=>{H.info("Crypto event:",e,t),C()};return r.on(a.AUM.Sync,e),r.on("crypto.deviceVerificationChanged",t),r.on("crypto.deviceList",t),r.on("crypto.roomKeyRequest",t),r.on("crypto.roomKeyRequestCancellation",t),()=>{r.off(a.AUM.Sync,e),r.off("crypto.deviceVerificationChanged",t),r.off("crypto.deviceList",t),r.off("crypto.roomKeyRequest",t),r.off("crypto.roomKeyRequestCancellation",t)}},[r]),(0,i.jsxs)(W.Provider,{value:{client:r,isLoading:o,isAuthenticated:f,isCryptoReady:x,error:p,userId:w,loginWithPassword:S,logout:I,refreshCryptoStatus:C},children:[t,(0,i.jsx)(G,{})]})}function K(){let e=(0,s.useContext)(W);if(!e)throw Error("useMatrix must be used within a MatrixProvider");return e}},90890:(e,t,r)=>{r.d(t,{FirstRunExperienceProvider:()=>o,j:()=>c});var i=r(14034),s=r(86042);let a={currentStep:0,totalSteps:4,userData:{},serverData:{}},n=(0,s.createContext)(null);function o(e){let{children:t}=e,[r,o]=(0,s.useState)(a);return(0,i.jsx)(n.Provider,{value:{state:r,nextStep:()=>{o(e=>({...e,currentStep:Math.min(e.currentStep+1,e.totalSteps-1)}))},prevStep:()=>{o(e=>({...e,currentStep:Math.max(e.currentStep-1,0)}))},setUserData:e=>{o(t=>({...t,userData:{...t.userData,...e}}))},setServerData:e=>{o(t=>({...t,serverData:{...t.serverData,...e}}))},resetFlow:()=>{o(a)}},children:t})}function c(){let e=(0,s.useContext)(n);if(!e)throw Error("useFirstRun must be used within FirstRunExperienceProvider");return e}}}]);