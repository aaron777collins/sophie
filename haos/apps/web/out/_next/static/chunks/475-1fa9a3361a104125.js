(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[475],{109:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PostmessageTransport=void 0;var n=r(91699),i=r(88767),o=["message"];function a(e){return(a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function s(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function l(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?s(Object(r),!0).forEach(function(t){h(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):s(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function c(e,t){return(c=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}function d(e){if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function u(e){return(u=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function h(e,t,r){return(t=v(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function v(e){var t=function(e,t){if("object"!==a(e)||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,t||"default");if("object"!==a(n))return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"===a(t)?t:String(t)}t.PostmessageTransport=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");s.prototype=Object.create(e&&e.prototype,{constructor:{value:s,writable:!0,configurable:!0}}),Object.defineProperty(s,"prototype",{writable:!1}),e&&c(s,e);var t,r,n=(t=function(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}(),function(){var e,r=u(s);return e=t?Reflect.construct(r,arguments,u(this).constructor):r.apply(this,arguments),function(e,t){if(t&&("object"===a(t)||"function"==typeof t))return t;if(void 0!==t)throw TypeError("Derived constructors may only return object or undefined");return d(e)}(this,e)});function s(e,t,r,o){var a;if(!(this instanceof s))throw TypeError("Cannot call a class as a function");return(a=n.call(this)).sendDirection=e,a.transportWindow=r,a.inboundWindow=o,h(d(a),"strictOriginCheck",!1),h(d(a),"targetOrigin","*"),h(d(a),"timeoutSeconds",10),h(d(a),"_ready",!1),h(d(a),"_widgetId",void 0),h(d(a),"outboundRequests",new Map),h(d(a),"stopController",new AbortController),h(d(a),"handleMessage",function(e){if(!a.stopController.signal.aborted&&e.data&&(!a.strictOriginCheck||e.origin===globalThis.origin)){var t=e.data;if(t.action&&t.requestId&&t.widgetId)if(t.response){if(t.api!==a.sendDirection)return;a.handleResponse(t)}else{if(t.api!==(0,i.invertedDirection)(a.sendDirection))return;a.handleRequest(t)}}}),a._widgetId=t,a}return r=[{key:"ready",get:function(){return this._ready}},{key:"widgetId",get:function(){return this._widgetId||null}},{key:"nextRequestId",get:function(){for(var e="widgetapi-".concat(Date.now()),t=0,r=e;this.outboundRequests.has(r);)r="".concat(e,"-").concat(t++);return this.outboundRequests.set(r,null),r}},{key:"sendInternal",value:function(e){console.log("[PostmessageTransport] Sending object to ".concat(this.targetOrigin,": "),e),this.transportWindow.postMessage(e,this.targetOrigin)}},{key:"reply",value:function(e,t){return this.sendInternal(l(l({},e),{},{response:t}))}},{key:"send",value:function(e,t){return this.sendComplete(e,t).then(function(e){return e.response})}},{key:"sendComplete",value:function(e,t){var r=this;if(!this.ready||!this.widgetId)return Promise.reject(Error("Not ready or unknown widget ID"));var n={api:this.sendDirection,widgetId:this.widgetId,requestId:this.nextRequestId,action:e,data:t};return e===i.WidgetApiToWidgetAction.UpdateVisibility&&(n.visible=t.visible),new Promise(function(e,t){var i=function(e){s(),t(e)},o=setTimeout(function(){return i(Error("Request timed out"))},1e3*(r.timeoutSeconds||1)),a=function(){return i(Error("Transport stopped"))};r.stopController.signal.addEventListener("abort",a);var s=function(){r.outboundRequests.delete(n.requestId),clearTimeout(o),r.stopController.signal.removeEventListener("abort",a)};r.outboundRequests.set(n.requestId,{request:n,resolve:function(t){s(),e(t)},reject:i}),r.sendInternal(n)})}},{key:"start",value:function(){this.inboundWindow.addEventListener("message",this.handleMessage),this._ready=!0}},{key:"stop",value:function(){this._ready=!1,this.stopController.abort(),this.inboundWindow.removeEventListener("message",this.handleMessage)}},{key:"handleRequest",value:function(e){if(this.widgetId){if(this.widgetId!==e.widgetId)return}else this._widgetId=e.widgetId;this.emit("message",new CustomEvent("message",{detail:e}))}},{key:"handleResponse",value:function(e){if(e.widgetId===this.widgetId){var t=this.outboundRequests.get(e.requestId);if(t)if((0,i.isErrorResponse)(e.response)){var r=e.response.error,n=r.message,a=function(e,t){if(null==e)return{};var r,n,i=function(e,t){if(null==e)return{};var r,n,i={},o=Object.keys(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||(i[r]=e[r]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)r=o[n],!(t.indexOf(r)>=0)&&Object.prototype.propertyIsEnumerable.call(e,r)&&(i[r]=e[r])}return i}(r,o);t.reject(new i.WidgetApiResponseError(n,a))}else t.resolve(e)}}}],function(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,v(n.key),n)}}(s.prototype,r),Object.defineProperty(s,"prototype",{writable:!1}),s}(n.EventEmitter)},389:(e,t,r)=>{"use strict";r.d(t,{b:()=>l});var n=r(84458),i=r(5408),o=r(9086),a=r(11749),s=r(36963);class l{static RETRY_BACKOFF_RATELIMIT(e,t,r){return(0,s.fZ)(r,t,!1)}static QUEUE_MESSAGES(e){return e.getType()===o.Bx.RoomMessage||e.hasAssociation()?"message":null}constructor(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:l.RETRY_BACKOFF_RATELIMIT,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:l.QUEUE_MESSAGES;this.retryAlgorithm=e,this.queueAlgorithm=t,(0,n.A)(this,"queues",{}),(0,n.A)(this,"activeQueues",[]),(0,n.A)(this,"procFn",null),(0,n.A)(this,"processQueue",e=>{var t=this.peekNextEvent(e);if(!t)return void this.disableQueue(e);this.queues[e].length,Promise.resolve().then(()=>this.procFn(t.event)).then(r=>{this.removeNextEvent(e),t.event.getId(),t.resolvers.resolve(r),this.processQueue(e)},r=>{t.attempts+=1;var n=this.retryAlgorithm(t.event,t.attempts,r);t.attempts,t.event.getId(),-1===n?(i.vF.info("Queue '%s' giving up on event %s",e,t.event.getId()),this.clearQueue(e,r)):setTimeout(this.processQueue,n,e)})})}getQueueForEvent(e){var t=this.queueAlgorithm(e);return t&&this.queues[t]?this.queues[t].map(function(e){return e.event}):null}removeEventFromQueue(e){var t=this.queueAlgorithm(e);if(!t||!this.queues[t])return!1;var r=!1;return(0,a.Nz)(this.queues[t],t=>t.event.getId()===e.getId()&&(r=!0,!0)),r}setProcessFunction(e){this.procFn=e,this.startProcessingQueues()}queueEvent(e){var t=this.queueAlgorithm(e);if(!t)return null;this.queues[t]||(this.queues[t]=[]);var r=Promise.withResolvers();return this.queues[t].push({event:e,resolvers:r,attempts:0}),c("Queue algorithm dumped event %s into queue '%s'",e.getId(),t),this.startProcessingQueues(),r.promise}startProcessingQueues(){this.procFn&&Object.keys(this.queues).filter(e=>-1===this.activeQueues.indexOf(e)&&this.queues[e].length>0).forEach(e=>{this.activeQueues.push(e),this.processQueue(e)})}disableQueue(e){var t=this.activeQueues.indexOf(e);t>=0&&this.activeQueues.splice(t,1),i.vF.info("Stopping queue '%s' as it is now empty",e)}clearQueue(e,t){var r;for(i.vF.info("clearing queue '%s'",e);r=this.removeNextEvent(e);)r.resolvers.reject(t);this.disableQueue(e)}peekNextEvent(e){var t=this.queues[e];if(Array.isArray(t))return t[0]}removeNextEvent(e){var t=this.queues[e];if(Array.isArray(t))return t.shift()}}function c(){}},666:(e,t,r)=>{"use strict";r.d(t,{y:()=>m});var n=r(29301),i=r(84458),o=r(5408),a=r(4854),s=r(63959),l=r(69549);class c{constructor(e){this.db=e,(0,i.A)(this,"nextTxnId",0),e.onversionchange=()=>{o.vF.log("versionchange for indexeddb ".concat(this.db.name,": closing")),e.close()}}containsData(){return(0,n.A)(function*(){throw Error("Not implemented for Backend")})()}startup(){var e=this;return(0,n.A)(function*(){return e})()}deleteAllData(){return(0,n.A)(function*(){throw Error("This is not implemented, call IDBFactory::deleteDatabase(dbName) instead.")})()}getMigrationState(){var e=this;return(0,n.A)(function*(){var t=l.Il.NOT_STARTED;return yield e.doTxn("readonly",[m.STORE_ACCOUNT],e=>{var r=e.objectStore(m.STORE_ACCOUNT).get(l.Nv);r.onsuccess=()=>{var e;t=null!=(e=r.result)?e:l.Il.NOT_STARTED}}),t})()}setMigrationState(e){var t=this;return(0,n.A)(function*(){yield t.doTxn("readwrite",[m.STORE_ACCOUNT],t=>{t.objectStore(m.STORE_ACCOUNT).put(e,l.Nv)})})()}getAccount(e,t){var r=e.objectStore("account").get("-");r.onsuccess=function(){try{t(r.result||null)}catch(t){h(e,t)}}}storeAccount(e,t){e.objectStore("account").put(t,"-")}getCrossSigningKeys(e,t){var r=e.objectStore("account").get("crossSigningKeys");r.onsuccess=function(){try{t(r.result||null)}catch(t){h(e,t)}}}getSecretStorePrivateKey(e,t,r){var n=e.objectStore("account").get("ssss_cache:".concat(r));n.onsuccess=function(){try{t(n.result||null)}catch(t){h(e,t)}}}storeSecretStorePrivateKey(e,t,r){e.objectStore("account").put(r,"ssss_cache:".concat(t))}countEndToEndSessions(e,t){var r=e.objectStore("sessions").count();r.onsuccess=function(){try{t(r.result)}catch(t){h(e,t)}}}getEndToEndSessions(e,t,r){var n=t.objectStore("sessions").index("deviceKey").openCursor(e),i={};n.onsuccess=function(){var e=n.result;if(e)i[e.value.sessionId]={session:e.value.session,lastReceivedMessageTs:e.value.lastReceivedMessageTs},e.continue();else try{r(i)}catch(e){h(t,e)}}}getEndToEndSession(e,t,r,n){var i=r.objectStore("sessions").get([e,t]);i.onsuccess=function(){try{i.result?n({session:i.result.session,lastReceivedMessageTs:i.result.lastReceivedMessageTs}):n(null)}catch(e){h(r,e)}}}storeEndToEndSession(e,t,r,n){n.objectStore("sessions").put({deviceKey:e,sessionId:t,session:r.session,lastReceivedMessageTs:r.lastReceivedMessageTs})}getEndToEndSessionsBatch(){var e=this;return(0,n.A)(function*(){var t=[];return(yield e.doTxn("readonly",[m.STORE_SESSIONS],e=>{var r=e.objectStore(m.STORE_SESSIONS).openCursor();r.onsuccess=function(){try{var n=r.result;n&&(t.push(n.value),t.length<l.oT&&n.continue())}catch(t){h(e,t)}}}),0===t.length)?null:t})()}deleteEndToEndSessionsBatch(e){var t=this;return(0,n.A)(function*(){var r;yield t.doTxn("readwrite",[m.STORE_SESSIONS],(r=(0,n.A)(function*(t){try{var r=t.objectStore(m.STORE_SESSIONS),n=function*(){var e=r.delete([i,o]);yield new Promise(t=>{e.onsuccess=t})};for(var{deviceKey:i,sessionId:o}of e)yield*n()}catch(e){h(t,e)}}),function(e){return r.apply(this,arguments)}))})()}getEndToEndInboundGroupSession(e,t,r,n){var i=!1,o=!1,a=r.objectStore("inbound_group_sessions").get([e,t]);a.onsuccess=function(){try{i=a.result?a.result.session:null,!1!==o&&n(i,o)}catch(e){h(r,e)}};var s=r.objectStore("inbound_group_sessions_withheld").get([e,t]);s.onsuccess=function(){try{o=s.result?s.result.session:null,!1!==i&&n(i,o)}catch(e){h(r,e)}}}storeEndToEndInboundGroupSession(e,t,r,n){n.objectStore("inbound_group_sessions").put({senderCurve25519Key:e,sessionId:t,session:r})}countEndToEndInboundGroupSessions(){var e=this;return(0,n.A)(function*(){var t=0;return yield e.doTxn("readonly",[m.STORE_INBOUND_GROUP_SESSIONS],e=>{var r=e.objectStore(m.STORE_INBOUND_GROUP_SESSIONS).count();r.onsuccess=()=>{t=r.result}}),t})()}getEndToEndInboundGroupSessionsBatch(){var e=this;return(0,n.A)(function*(){var t=[];return(yield e.doTxn("readonly",[m.STORE_INBOUND_GROUP_SESSIONS,m.STORE_BACKUP],e=>{var r=e.objectStore(m.STORE_INBOUND_GROUP_SESSIONS),n=e.objectStore(m.STORE_BACKUP),i=r.openCursor();i.onsuccess=function(){try{var r=i.result;if(r){var o=n.get(r.key);o.onsuccess=()=>{t.push({senderKey:r.value.senderCurve25519Key,sessionId:r.value.sessionId,sessionData:r.value.session,needsBackup:void 0!==o.result}),t.length<l.oT&&r.continue()}}}catch(t){h(e,t)}}}),0===t.length)?null:t})()}deleteEndToEndInboundGroupSessionsBatch(e){var t=this;return(0,n.A)(function*(){var r;yield t.doTxn("readwrite",[m.STORE_INBOUND_GROUP_SESSIONS],(r=(0,n.A)(function*(t){try{var r=t.objectStore(m.STORE_INBOUND_GROUP_SESSIONS),n=function*(){var e=r.delete([i,o]);yield new Promise(t=>{e.onsuccess=t})};for(var{senderKey:i,sessionId:o}of e)yield*n()}catch(e){h(t,e)}}),function(e){return r.apply(this,arguments)}))})()}getEndToEndDeviceData(e,t){var r=e.objectStore("device_data").get("-");r.onsuccess=function(){try{t(r.result||null)}catch(t){h(e,t)}}}getEndToEndRooms(e,t){var r={},n=e.objectStore("rooms").openCursor();n.onsuccess=function(){var i=n.result;if(i)r[i.key]=i.value,i.continue();else try{t(r)}catch(t){h(e,t)}}}markSessionsNeedingBackup(e,t){var r=this;return(0,n.A)(function*(){t||(t=r.db.transaction("sessions_needing_backup","readwrite"));var n=t.objectStore("sessions_needing_backup");yield Promise.all(e.map(e=>new Promise((t,r)=>{var i=n.put({senderCurve25519Key:e.senderKey,sessionId:e.sessionId});i.onsuccess=t,i.onerror=r})))})()}doTxn(e,t,r){arguments.length>3&&void 0!==arguments[3]?arguments[3]:o.vF;var n,i=this.db.transaction(t,e),a=(n=i,new Promise((e,t)=>{n.oncomplete=()=>{void 0!==n._mx_abortexception&&t(n._mx_abortexception),e(null)},n.onerror=e=>{void 0!==n._mx_abortexception?t(n._mx_abortexception):(o.vF.log("Error performing indexeddb txn",e),t(n.error))},n.onabort=e=>{void 0!==n._mx_abortexception?t(n._mx_abortexception):(o.vF.log("Error performing indexeddb txn",e),t(n.error))}})),s=r(i);return a.then(()=>s)}}var d=[e=>{!function(e){var t=e.createObjectStore("outgoingRoomKeyRequests",{keyPath:"requestId"});t.createIndex("session",["requestBody.room_id","requestBody.session_id"]),t.createIndex("state","state")}(e)},e=>{e.createObjectStore("account")},e=>{e.createObjectStore("sessions",{keyPath:["deviceKey","sessionId"]}).createIndex("deviceKey","deviceKey")},e=>{e.createObjectStore("inbound_group_sessions",{keyPath:["senderCurve25519Key","sessionId"]})},e=>{e.createObjectStore("device_data")},e=>{e.createObjectStore("rooms")},e=>{e.createObjectStore("sessions_needing_backup",{keyPath:["senderCurve25519Key","sessionId"]})},e=>{e.createObjectStore("inbound_group_sessions_withheld",{keyPath:["senderCurve25519Key","sessionId"]})},e=>{e.createObjectStore("session_problems",{keyPath:["deviceKey","time"]}).createIndex("deviceKey","deviceKey"),e.createObjectStore("notified_error_devices",{keyPath:["userId","deviceId"]})},e=>{e.createObjectStore("shared_history_inbound_group_sessions",{keyPath:["roomId"]})},e=>{e.createObjectStore("parked_shared_history",{keyPath:["roomId"]})}],u=d.length;function h(e,t){e._mx_abortexception=t;try{e.abort()}catch(e){}}var v=r(69103),p=r(6151);class m{static exists(e,t){return p.t(e,t)}static existsAndIsNotMigrated(e,t){return new Promise((r,n)=>{var i=!0,o=e.open(t);o.onupgradeneeded=()=>{i=!1},o.onblocked=()=>n(o.error),o.onsuccess=()=>{var a=o.result;if(i){var s=a.transaction([m.STORE_ACCOUNT],"readonly").objectStore(m.STORE_ACCOUNT).get(l.Nv);s.onsuccess=()=>{var e;r((null!=(e=s.result)?e:l.Il.NOT_STARTED)===l.Il.NOT_STARTED)},s.onerror=()=>{n(s.error)},a.close()}else a.close(),e.deleteDatabase(t),r(!1)},o.onerror=()=>n(o.error)})}constructor(e,t){this.indexedDB=e,this.dbName=t,(0,i.A)(this,"backendPromise",void 0),(0,i.A)(this,"backend",void 0)}containsData(){var e=this;return(0,n.A)(function*(){return m.exists(e.indexedDB,e.dbName)})()}startup(){return this.backendPromise||(this.backendPromise=new Promise((e,t)=>{if(!this.indexedDB)return void t(Error("no indexeddb support available"));o.vF.log("connecting to indexeddb ".concat(this.dbName));var r=this.indexedDB.open(this.dbName,u);r.onupgradeneeded=e=>{var t=r.result,n=e.oldVersion;o.vF.log("Upgrading IndexedDBCryptoStore from version ".concat(n)+" to ".concat(u)),d.forEach((e,r)=>{n<=r&&e(t)})},r.onblocked=()=>{o.vF.log("can't yet open IndexedDBCryptoStore because it is open elsewhere")},r.onerror=e=>{o.vF.log("Error connecting to indexeddb",e),t(r.error)},r.onsuccess=()=>{var t=r.result;o.vF.log("connected to indexeddb ".concat(this.dbName)),e(new c(t))}}).then(e=>e.doTxn("readonly",[m.STORE_INBOUND_GROUP_SESSIONS,m.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],t=>{e.getEndToEndInboundGroupSession("","",t,()=>{})}).then(()=>e)).catch(e=>{if("VersionError"===e.name)throw o.vF.warn("Crypto DB is too new for us to use!",e),new v.E5(v.hP.TooNew);o.vF.warn("unable to connect to indexeddb ".concat(this.dbName)+": falling back to localStorage store: ".concat(e));try{if(!(globalThis.localStorage instanceof Storage))throw Error("localStorage is not available");return new a.F(globalThis.localStorage)}catch(e){return o.vF.warn("Unable to open localStorage: falling back to in-memory store: ".concat(e)),new s._}}).then(e=>(this.backend=e,e))),this.backendPromise}deleteAllData(){return new Promise((e,t)=>{if(!this.indexedDB)return void t(Error("no indexeddb support available"));o.vF.log("Removing indexeddb instance: ".concat(this.dbName));var r=this.indexedDB.deleteDatabase(this.dbName);r.onblocked=()=>{o.vF.log("can't yet delete IndexedDBCryptoStore because it is open elsewhere")},r.onerror=e=>{o.vF.log("Error deleting data from indexeddb",e),t(r.error)},r.onsuccess=()=>{o.vF.log("Removed indexeddb instance: ".concat(this.dbName)),e()}}).catch(e=>{o.vF.warn("unable to delete IndexedDBCryptoStore: ".concat(e))})}getMigrationState(){return this.backend.getMigrationState()}setMigrationState(e){return this.backend.setMigrationState(e)}getAccount(e,t){this.backend.getAccount(e,t)}storeAccount(e,t){this.backend.storeAccount(e,t)}getCrossSigningKeys(e,t){this.backend.getCrossSigningKeys(e,t)}getSecretStorePrivateKey(e,t,r){this.backend.getSecretStorePrivateKey(e,t,r)}storeSecretStorePrivateKey(e,t,r){this.backend.storeSecretStorePrivateKey(e,t,r)}countEndToEndSessions(e,t){this.backend.countEndToEndSessions(e,t)}getEndToEndSession(e,t,r,n){this.backend.getEndToEndSession(e,t,r,n)}getEndToEndSessions(e,t,r){this.backend.getEndToEndSessions(e,t,r)}storeEndToEndSession(e,t,r,n){this.backend.storeEndToEndSession(e,t,r,n)}countEndToEndInboundGroupSessions(){return this.backend.countEndToEndInboundGroupSessions()}getEndToEndSessionsBatch(){return this.backend.getEndToEndSessionsBatch()}deleteEndToEndSessionsBatch(e){return this.backend.deleteEndToEndSessionsBatch(e)}getEndToEndInboundGroupSession(e,t,r,n){this.backend.getEndToEndInboundGroupSession(e,t,r,n)}storeEndToEndInboundGroupSession(e,t,r,n){this.backend.storeEndToEndInboundGroupSession(e,t,r,n)}getEndToEndInboundGroupSessionsBatch(){return this.backend.getEndToEndInboundGroupSessionsBatch()}deleteEndToEndInboundGroupSessionsBatch(e){return this.backend.deleteEndToEndInboundGroupSessionsBatch(e)}getEndToEndRooms(e,t){this.backend.getEndToEndRooms(e,t)}markSessionsNeedingBackup(e,t){return this.backend.markSessionsNeedingBackup(e,t)}doTxn(e,t,r,n){return this.backend.doTxn(e,t,r,n)}}(0,i.A)(m,"STORE_ACCOUNT","account"),(0,i.A)(m,"STORE_SESSIONS","sessions"),(0,i.A)(m,"STORE_INBOUND_GROUP_SESSIONS","inbound_group_sessions"),(0,i.A)(m,"STORE_INBOUND_GROUP_SESSIONS_WITHHELD","inbound_group_sessions_withheld"),(0,i.A)(m,"STORE_SHARED_HISTORY_INBOUND_GROUP_SESSIONS","shared_history_inbound_group_sessions"),(0,i.A)(m,"STORE_PARKED_SHARED_HISTORY","parked_shared_history"),(0,i.A)(m,"STORE_DEVICE_DATA","device_data"),(0,i.A)(m,"STORE_ROOMS","rooms"),(0,i.A)(m,"STORE_BACKUP","sessions_needing_backup")},3662:(e,t,r)=>{"use strict";r.r(t),r.d(t,{SECRET_STORAGE_ALGORITHM_V1_AES:()=>h,ServerSideSecretStorageImpl:()=>v,calculateKeyCheck:()=>m,trimTrailingEquals:()=>p});var n=r(29301),i=r(49699),o=r(5862),a=r(5408),s=r(35095),l=r(34019);function c(e,t,r,n){return d.apply(this,arguments)}function d(){return(d=(0,n.A)(function*(e,t,r,n){n?i=(0,s.y4)(n):(i=new Uint8Array(16),globalThis.crypto.getRandomValues(i),i[8]&=127);var i,[o,a]=yield(0,l.C)(t,r),c=new TextEncoder().encode(e),d=yield globalThis.crypto.subtle.encrypt({name:"AES-CTR",counter:i,length:64},o,c),u=yield globalThis.crypto.subtle.sign({name:"HMAC"},a,d);return{iv:(0,s.WG)(i),ciphertext:(0,s.WG)(new Uint8Array(d)),mac:(0,s.WG)(new Uint8Array(u))}})).apply(this,arguments)}var u=r(60332),h="m.secret_storage.v1.aes-hmac-sha2";class v{constructor(e,t){this.accountDataAdapter=e,this.callbacks=t}getDefaultKeyId(){var e=this;return(0,n.A)(function*(){var t,r=yield e.accountDataAdapter.getAccountDataFromServer("m.secret_storage.default_key");return r&&null!=(t=r.key)?t:null})()}setDefaultKeyId(e){return new Promise((t,r)=>{var n=r=>{if("m.secret_storage.default_key"===r.getType()){var o=r.getContent();(null===e?0===Object.keys(o).length:o.key===e)&&(this.accountDataAdapter.removeListener(i.AU.AccountData,n),t())}};this.accountDataAdapter.on(i.AU.AccountData,n),this.accountDataAdapter.setAccountData("m.secret_storage.default_key",null===e?{}:{key:e}).catch(e=>{this.accountDataAdapter.removeListener(i.AU.AccountData,n),r(e)})})}addKey(e,t,r){var i=this;return(0,n.A)(function*(){if(e!==h)throw Error("Unknown key algorithm ".concat(e));var n={algorithm:e};t.name&&(n.name=t.name),t.passphrase&&(n.passphrase=t.passphrase);var{iv:a,mac:s}=yield m(t.key);if(n.iv=a,n.mac=s,!r)do r=(0,o.US)(32);while(yield i.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key.".concat(r)));return yield i.accountDataAdapter.setAccountData("m.secret_storage.key.".concat(r),n),{keyId:r,keyInfo:n}})()}getKey(e){var t=this;return(0,n.A)(function*(){if(e||(e=yield t.getDefaultKeyId()),!e)return null;var r=yield t.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key.".concat(e));return r?[e,r]:null})()}hasKey(e){var t=this;return(0,n.A)(function*(){return!!(yield t.getKey(e))})()}checkKey(e,t){return(0,n.A)(function*(){if(t.algorithm===h)if(!t.mac)return!0;else{var{mac:r}=yield m(e,t.iv);return p(t.mac)===p(r)}throw Error("Unknown algorithm")})()}store(e,t,r){var i=this;return(0,n.A)(function*(){if(null===t)return void(yield i.accountDataAdapter.setAccountData(e,{}));var n={};if(!r){var o=yield i.getDefaultKeyId();if(!o)throw Error("No keys specified and no default key present");r=[o]}if(0===r.length)throw Error("Zero keys given to encrypt with!");for(var s of r){var l=yield i.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key.".concat(s));if(!l)throw Error("Unknown key: "+s);if(l.algorithm===h){var c={[s]:l},[,d]=yield i.getSecretStorageKey(c,e);n[s]=yield d.encrypt(t)}else a.vF.warn("unknown algorithm for secret storage key "+s+": "+l.algorithm)}yield i.accountDataAdapter.setAccountData(e,{encrypted:n})})()}get(e){var t=this;return(0,n.A)(function*(){var r=yield t.accountDataAdapter.getAccountDataFromServer(e);if(r){if(!r.encrypted)throw Error("Content is not encrypted!");var n={};for(var i of Object.keys(r.encrypted)){var o=yield t.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key.".concat(i)),a=r.encrypted[i];(null==o?void 0:o.algorithm)===h&&a.iv&&a.ciphertext&&a.mac&&(n[i]=o)}if(0===Object.keys(n).length)throw Error("Could not decrypt ".concat(e," because none of ")+"the keys it is encrypted with are for a supported algorithm");var[s,l]=yield t.getSecretStorageKey(n,e),c=r.encrypted[s];return l.decrypt(c)}})()}isStored(e){var t=this;return(0,n.A)(function*(){var r=yield t.accountDataAdapter.getAccountDataFromServer(e);if(!(null!=r&&r.encrypted))return null;var n={};for(var i of Object.keys(r.encrypted)){var o=yield t.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key.".concat(i));if(o){var a=r.encrypted[i];o.algorithm===h&&a.iv&&a.ciphertext&&a.mac&&(n[i]=o)}}return Object.keys(n).length?n:null})()}getSecretStorageKey(e,t){var r=this;return(0,n.A)(function*(){if(!r.callbacks.getSecretStorageKey)throw Error("No getSecretStorageKey callback supplied");var n=yield r.callbacks.getSecretStorageKey({keys:e},t);if(!n)throw Error("getSecretStorageKey callback returned falsey");if(n.length<2)throw Error("getSecretStorageKey callback returned invalid data");var[i,o]=n;if(!e[i])throw Error("App returned unknown key from getSecretStorageKey!");if(e[i].algorithm===h)return[i,{encrypt:function(e){return c(e,o,t)},decrypt:function(e){return(0,u.A)(e,o,t)}}];throw Error("Unknown key type: "+e[i].algorithm)})()}}function p(e){for(var t=e.length;t>=1&&61==e.charCodeAt(t-1);)t--;return t<e.length?e.substring(0,t):e}function m(e,t){return c("\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0",e,"",t)}},4002:(e,t,r)=>{"use strict";r.d(t,{Hh:()=>h,BL:()=>u,Tw:()=>d});var n=r(84458),i=r(69007),o=null,a=0,s=r(5408),l=r(15095),c=r(25097),d=-60,u=function(e){return e.NewStream="new_stream",e.MuteStateChanged="mute_state_changed",e.LocalVolumeChanged="local_volume_changed",e.VolumeChanged="volume_changed",e.ConnectedChanged="connected_changed",e.Speaking="speaking",e.Disposed="disposed",e}({});class h extends l.X{constructor(e){super(),(0,n.A)(this,"stream",void 0),(0,n.A)(this,"sdpMetadataStreamId",void 0),(0,n.A)(this,"userId",void 0),(0,n.A)(this,"deviceId",void 0),(0,n.A)(this,"purpose",void 0),(0,n.A)(this,"speakingVolumeSamples",void 0),(0,n.A)(this,"client",void 0),(0,n.A)(this,"call",void 0),(0,n.A)(this,"roomId",void 0),(0,n.A)(this,"audioMuted",void 0),(0,n.A)(this,"videoMuted",void 0),(0,n.A)(this,"localVolume",1),(0,n.A)(this,"measuringVolumeActivity",!1),(0,n.A)(this,"audioContext",void 0),(0,n.A)(this,"analyser",void 0),(0,n.A)(this,"frequencyBinCount",void 0),(0,n.A)(this,"speakingThreshold",d),(0,n.A)(this,"speaking",!1),(0,n.A)(this,"volumeLooperTimeout",void 0),(0,n.A)(this,"_disposed",!1),(0,n.A)(this,"_connected",!1),(0,n.A)(this,"onAddTrack",()=>{this.emit(u.NewStream,this.stream)}),(0,n.A)(this,"onCallState",e=>{e===c.iP.Connected?this.connected=!0:e===c.iP.Connecting&&(this.connected=!1)}),(0,n.A)(this,"volumeLooper",()=>{if(this.analyser&&this.measuringVolumeActivity){this.analyser.getFloatFrequencyData(this.frequencyBinCount);var e=-1/0;for(var t of this.frequencyBinCount)t>e&&(e=t);this.speakingVolumeSamples.shift(),this.speakingVolumeSamples.push(e),this.emit(u.VolumeChanged,e);var r=!1;for(var n of this.speakingVolumeSamples)if(n>this.speakingThreshold){r=!0;break}this.speaking!==r&&(this.speaking=r,this.emit(u.Speaking,this.speaking)),this.volumeLooperTimeout=setTimeout(this.volumeLooper,200)}}),this.client=e.client,this.call=e.call,this.roomId=e.roomId,this.userId=e.userId,this.deviceId=e.deviceId,this.purpose=e.purpose,this.audioMuted=e.audioMuted,this.videoMuted=e.videoMuted,this.speakingVolumeSamples=Array(8).fill(-1/0),this.sdpMetadataStreamId=e.stream.id,this.updateStream(null,e.stream),this.stream=e.stream,this.hasAudioTrack&&this.initVolumeMeasuring(),e.call&&(e.call.addListener(c.$E.State,this.onCallState),this.onCallState(e.call.state))}get connected(){return this.isLocal()||this._connected}set connected(e){this._connected=e,this.emit(u.ConnectedChanged,this.connected)}get hasAudioTrack(){return this.stream.getAudioTracks().length>0}updateStream(e,t){if(t!==e){var r=this.measuringVolumeActivity;e&&(e.removeEventListener("addtrack",this.onAddTrack),this.measureVolumeActivity(!1)),this.stream=t,t.addEventListener("addtrack",this.onAddTrack),this.hasAudioTrack?(this.initVolumeMeasuring(),r&&this.measureVolumeActivity(!0)):this.measureVolumeActivity(!1),this.emit(u.NewStream,this.stream)}}initVolumeMeasuring(){this.hasAudioTrack&&(this.audioContext||(this.audioContext=(null===o&&(o=new AudioContext),a++,o)),this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=512,this.analyser.smoothingTimeConstant=.1,this.audioContext.createMediaStreamSource(this.stream).connect(this.analyser),this.frequencyBinCount=new Float32Array(this.analyser.frequencyBinCount))}getMember(){var e,t=this.client.getRoom(this.roomId);return null!=(e=null==t?void 0:t.getMember(this.userId))?e:null}isLocal(){return this.userId===this.client.getUserId()&&(void 0===this.deviceId||this.deviceId===this.client.getDeviceId())}isAudioMuted(){return 0===this.stream.getAudioTracks().length||this.audioMuted}isVideoMuted(){return 0===this.stream.getVideoTracks().length||this.videoMuted}isSpeaking(){return this.speaking}setNewStream(e){this.updateStream(this.stream,e)}setAudioVideoMuted(e,t){null!==e&&(this.audioMuted!==e&&this.speakingVolumeSamples.fill(-1/0),this.audioMuted=e),null!==t&&(this.videoMuted=t),this.emit(u.MuteStateChanged,this.audioMuted,this.videoMuted)}measureVolumeActivity(e){e?this.analyser&&this.frequencyBinCount&&this.hasAudioTrack&&(this.measuringVolumeActivity=!0,this.volumeLooper()):(this.measuringVolumeActivity=!1,this.speakingVolumeSamples.fill(-1/0),this.emit(u.VolumeChanged,-1/0))}setSpeakingThreshold(e){this.speakingThreshold=e}clone(){var e=this.client.getMediaHandler(),t=this.stream.clone();return s.vF.log("CallFeed clone() cloning stream (originalStreamId=".concat(this.stream.id,", newStreamId").concat(t.id,")")),this.purpose===i.h.Usermedia?e.userMediaStreams.push(t):e.screensharingStreams.push(t),new h({client:this.client,roomId:this.roomId,userId:this.userId,deviceId:this.deviceId,stream:t,purpose:this.purpose,audioMuted:this.audioMuted,videoMuted:this.videoMuted})}dispose(){var e,t,r;clearTimeout(this.volumeLooperTimeout),null==(e=this.stream)||e.removeEventListener("addtrack",this.onAddTrack),null==(t=this.call)||t.removeListener(c.$E.State,this.onCallState),this.audioContext&&(this.audioContext=void 0,this.analyser=void 0,0==--a)&&(null==(r=o)||r.close(),o=null),this._disposed=!0,this.emit(u.Disposed)}get disposed(){return this._disposed}set disposed(e){this._disposed=e}getLocalVolume(){return this.localVolume}setLocalVolume(e){this.localVolume=e,this.emit(u.LocalVolumeChanged,e)}}},4854:(e,t,r)=>{"use strict";r.d(t,{F:()=>g});var n=r(29301),i=r(5408),o=r(63959),a=r(69549),s="crypto.",l=s+"migration",c=s+"account",d=s+"cross_signing_keys",u=s+"inboundgroupsessions/",h=s+"inboundgroupsessions.withheld/",v=s+"rooms/",p=s+"sessionsneedingbackup";function m(e){return s+"sessions/"+e}class g extends o._{static exists(e){for(var t,r=e.length,n=0;n<r;n++)if(null!=(t=e.key(n))&&t.startsWith(s))return!0;return!1}constructor(e){super(),this.store=e}containsData(){var e=this;return(0,n.A)(function*(){return g.exists(e.store)})()}getMigrationState(){var e=this;return(0,n.A)(function*(){var t;return null!=(t=f(e.store,l))?t:a.Il.NOT_STARTED})()}setMigrationState(e){var t=this;return(0,n.A)(function*(){y(t.store,l,e)})()}countEndToEndSessions(e,t){for(var r=0,n=0;n<this.store.length;++n){var i=this.store.key(n);if(null!=i&&i.startsWith(m(""))){var o=f(this.store,i);r+=Object.keys(null!=o?o:{}).length}}t(r)}_getEndToEndSessions(e){var t=f(this.store,m(e)),r={};for(var[n,i]of Object.entries(t||{}))"string"==typeof i?r[n]={session:i}:r[n]=i;return r}getEndToEndSession(e,t,r,n){var i;n(null!=(i=this._getEndToEndSessions(e)[t])?i:{})}getEndToEndSessions(e,t,r){var n;r(null!=(n=this._getEndToEndSessions(e))?n:{})}storeEndToEndSession(e,t,r,n){var i=this._getEndToEndSessions(e)||{};i[t]=r,y(this.store,m(e),i)}getEndToEndSessionsBatch(){var e=this;return(0,n.A)(function*(){for(var t,r=[],n=0;n<e.store.length;++n)if(null!=(t=e.store.key(n))&&t.startsWith(m(""))){var i=e.store.key(n).split("/")[1];for(var o of Object.values(e._getEndToEndSessions(i)))if(r.push(o),r.length>=a.oT)return r}return 0===r.length?null:r})()}deleteEndToEndSessionsBatch(e){var t=this;return(0,n.A)(function*(){for(var{deviceKey:r,sessionId:n}of e){var i=t._getEndToEndSessions(r)||{};delete i[n],0===Object.keys(i).length?t.store.removeItem(m(r)):y(t.store,m(r),i)}})()}getEndToEndInboundGroupSession(e,t,r,n){n(f(this.store,u+e+"/"+t),f(this.store,h+e+"/"+t))}storeEndToEndInboundGroupSession(e,t,r,n){y(this.store,u+e+"/"+t,r)}countEndToEndInboundGroupSessions(){var e=this;return(0,n.A)(function*(){for(var t=0,r=0;r<e.store.length;++r){var n=e.store.key(r);null!=n&&n.startsWith(u)&&(t+=1)}return t})()}getEndToEndInboundGroupSessionsBatch(){var e=this;return(0,n.A)(function*(){for(var t=f(e.store,p)||{},r=[],n=0;n<e.store.length;++n){var i=e.store.key(n);if(null!=i&&i.startsWith(u)){var o=i.slice(u.length);if(r.push({senderKey:o.slice(0,43),sessionId:o.slice(44),sessionData:f(e.store,i),needsBackup:o in t}),r.length>=a.oT)return r}}return 0===r.length?null:r})()}deleteEndToEndInboundGroupSessionsBatch(e){var t=this;return(0,n.A)(function*(){for(var{senderKey:r,sessionId:n}of e){var i=u+r+"/"+n;t.store.removeItem(i)}})()}getEndToEndRooms(e,t){for(var r={},n=v+"",i=0;i<this.store.length;++i){var o=this.store.key(i);null!=o&&o.startsWith(n)&&(r[o.slice(n.length)]=f(this.store,o))}t(r)}markSessionsNeedingBackup(e){var t=f(this.store,p)||{};for(var r of e)t[r.senderKey+"/"+r.sessionId]=!0;return y(this.store,p,t),Promise.resolve()}deleteAllData(){return this.store.removeItem(c),Promise.resolve()}getAccount(e,t){t(f(this.store,c))}storeAccount(e,t){y(this.store,c,t)}getCrossSigningKeys(e,t){t(f(this.store,d))}getSecretStorePrivateKey(e,t,r){t(f(this.store,s+"ssss_cache.".concat(r)))}storeSecretStorePrivateKey(e,t,r){y(this.store,s+"ssss_cache.".concat(t),r)}doTxn(e,t,r){return Promise.resolve(r(null))}}function f(e,t){try{return JSON.parse(e.getItem(t))}catch(e){i.vF.log("Error: Failed to get key %s: %s",t,e.message),i.vF.log(e.stack)}return null}function y(e,t,r){e.setItem(t,JSON.stringify(r))}},5294:(e,t,r)=>{"use strict";r.d(t,{O:()=>n});var n=function(e){return e.Ban="ban",e.Invite="invite",e.Join="join",e.Knock="knock",e.Leave="leave",e}({})},5408:(e,t,r)=>{"use strict";r.d(t,{Tl:()=>a,k$:()=>s,vF:()=>o});var n=r(84458),i=r(56360);i.methodFactory=function(e,t,r){return function(){for(var t=arguments.length,r=Array(t),n=0;n<t;n++)r[n]=arguments[n];return(this.prefix&&r.unshift(this.prefix),"error"===e||"warn"===e||"trace"===e||"info"===e||"debug"===e)?console[e](...r):console.log(...r)}};var o=function e(t){var r=i.getLogger("matrix"+(void 0===t?"":"-".concat(t)));return void 0===r.getChild&&(r.prefix=t,r.getChild=n=>{var i=e((null!=t?t:"")+n);return i.methodFactory=r.methodFactory,i.rebuild(),i},r.setLevel(i.levels.DEBUG,!1)),r}();class a{constructor(e,t){this.parent=e,(0,n.A)(this,"name",void 0),this.name=t+":"}trace(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];this.parent.trace(this.name,...t)}debug(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];this.parent.debug(this.name,...t)}info(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];this.parent.info(this.name,...t)}warn(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];this.parent.warn(this.name,...t)}error(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];this.parent.error(this.name,...t)}}class s{constructor(e){this.debugInstance=e}trace(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];this.debugWithPrefix("[TRACE]",...t)}debug(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];this.debugWithPrefix("[DEBUG]",...t)}info(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];this.debugWithPrefix("[INFO]",...t)}warn(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];this.debugWithPrefix("[WARN]",...t)}error(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];this.debugWithPrefix("[ERROR]",...t)}getChild(e){return new s(this.debugInstance.extend(e))}debugWithPrefix(e){for(var t,r=arguments.length,n=Array(r>1?r-1:0),i=1;i<r;i++)n[i-1]=arguments[i];if(0===n.length)t="";else if(n[0]instanceof Error){var o=n.shift();t=o.stack||o.message}else t="string"==typeof n[0]?n.shift():"%O";this.debugInstance(e+" "+t,...n)}}},5862:(e,t,r)=>{"use strict";r.d(t,{US:()=>o,rl:()=>i});var n=r(35095);function i(e){var t=new Uint8Array(e);return globalThis.crypto.getRandomValues(t),(0,n.A4)(t)}function o(e){return function(e,t){if(t.length<2||t.length>256)throw Error("Character set must be between 2 and 256 characters long");if(e<1||e>32768)throw Error("Requested random string length must be between 1 and 32768");for(var r=256-256%t.length,n=new Uint8Array(Math.floor(1.3*e)),i=n.length,o=[];o.length<e;){i===n.length&&(globalThis.crypto.getRandomValues(n),i=0);var a=n[i++];a<r&&o.push(t[a%t.length])}return o.join("")}(e,"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789")}},6151:(e,t,r)=>{"use strict";function n(e,t){return new Promise((r,n)=>{var i=!0,o=e.open(t);o.onupgradeneeded=()=>{i=!1},o.onblocked=()=>n(o.error),o.onsuccess=()=>{o.result.close(),i||e.deleteDatabase(t),r(i)},o.onerror=()=>n(o.error)})}r.d(t,{t:()=>n})},7347:(e,t,r)=>{"use strict";function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.PollEndEvent=void 0;var i=r(77990),o=r(66866),a=r(98973),s=r(62404),l=r(47406),c=r(52337);function d(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function u(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function h(e,t){return(h=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function v(e){if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function p(e){return(p=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function m(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}t.PollEndEvent=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");y.prototype=Object.create(e&&e.prototype,{constructor:{value:y,writable:!0,configurable:!0}}),Object.defineProperty(y,"prototype",{writable:!1}),e&&h(y,e);var t,r,g,f=(t=function(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}(),function(){var e,r=p(y);return e=t?Reflect.construct(r,arguments,p(this).constructor):r.apply(this,arguments),function(e,t){if(t&&("object"===n(t)||"function"==typeof t))return t;if(void 0!==t)throw TypeError("Derived constructors may only return object or undefined");return v(e)}(this,e)});function y(e){if(!(this instanceof y))throw TypeError("Cannot call a class as a function");m(v(t=f.call(this,e)),"pollEventId",void 0),m(v(t),"closingMessage",void 0);var t,r=t.wireContent["m.relates_to"];if(!a.REFERENCE_RELATION.matches(null==r?void 0:r.rel_type)||"string"!=typeof(null==r?void 0:r.event_id))throw new o.InvalidEventError("Relationship must be a reference to an event");return t.pollEventId=r.event_id,t.closingMessage=new s.MessageEvent(t.wireFormat),t}return r=[{key:"isEquivalentTo",value:function(e){return(0,c.isEventTypeSame)(e,i.M_POLL_END)}},{key:"serialize",value:function(){return{type:i.M_POLL_END.name,content:function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?d(Object(r),!0).forEach(function(t){m(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):d(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}(m({"m.relates_to":{rel_type:a.REFERENCE_RELATION.name,event_id:this.pollEventId}},i.M_POLL_END.name,{}),this.closingMessage.serialize().content)}}}],g=[{key:"from",value:function(e,t){var r;return new y({type:i.M_POLL_END.name,content:(m(r={"m.relates_to":{rel_type:a.REFERENCE_RELATION.name,event_id:e}},i.M_POLL_END.name,{}),m(r,l.M_TEXT.name,t),r)})}}],r&&u(y.prototype,r),g&&u(y,g),Object.defineProperty(y,"prototype",{writable:!1}),y}(r(78272).ExtensibleEvent)},8221:(e,t,r)=>{"use strict";r.d(t,{J1:()=>o,M6:()=>s,Yg:()=>i,vo:()=>a});var n=r(81626),i=function(e){return e.Self="m.self",e.Pin="m.pin",e}({}),o=new n.qr("m.asset","org.matrix.msc3488.asset"),a=new n.qr("m.ts","org.matrix.msc3488.ts"),s=new n.qr("m.location","org.matrix.msc3488.location")},8702:(e,t,r)=>{"use strict";r.d(t,{D:()=>v,h:()=>p});var n=r(84458),i=r(33234),o=r(15095),a=r(11749),s=r(82393),l=r(9086),c=r(61219),d=r(5408),u=r(49699);function h(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function v(e,t,r){var i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];return new s.kl({content:{[t.getId()]:{[r]:{[e]:function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?h(Object(r),!0).forEach(function(t){(0,n.A)(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):h(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}({ts:t.getTs()},!i&&{thread_id:(0,u.Xb)(t)})}}},type:l.Bx.Receipt,room_id:t.getRoomId()})}class p extends o.X{constructor(){super(...arguments),(0,n.A)(this,"receipts",new a.kG(()=>new Map)),(0,n.A)(this,"receiptCacheByEventId",new Map)}getReadReceiptForUserId(e){var t,r,n=arguments.length>1&&void 0!==arguments[1]&&arguments[1],o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:i.L.Read,[a,s]=null!=(t=null==(r=this.receipts.get(o))?void 0:r.get(e))?t:[null,null];return n?a:null!=s?s:a}compareReceipts(e,t){var r;return null!=(r=this.getUnfilteredTimelineSet().compareEventOrdering(e.eventId,t.eventId))?r:e.data.ts-t.data.ts}getEventReadUpTo(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=this.getLatestReceipt(e,t);return r&&this.receiptPointsAtConsistentEvent(r)?r.eventId:null}receiptPointsAtConsistentEvent(e){var t,r=this.findEventById(e.eventId);if(!r)return!1;if(!(null!=(t=e.data)&&t.thread_id))return!0;if(e.data.thread_id===i.S){if((0,u.fN)(r))return!0}else if(r.threadRootId===e.data.thread_id)return!0;return d.vF.warn("Ignoring receipt because its thread_id (".concat(e.data.thread_id,") disagrees ")+"with the thread root (".concat(r.threadRootId,") of the referenced event ")+"(event ID = ".concat(e.eventId,")")),!1}getLatestReceipt(e,t){var r,n,o,a=this.getReadReceiptForUserId(e,t,i.L.Read),s=this.getReadReceiptForUserId(e,t,i.L.ReadPrivate);return(null!=a&&a.eventId&&null!=s&&s.eventId&&(o=this.compareReceipts(a,s)),o)?null!=(n=o<0?s:a)?n:null:null!=(r=null!=s?s:a)?r:null}addReceiptToStructure(e,t,r,n,i){var o,a,s,l=this.receipts.getOrCreate(t),c=l.get(r);c||(c=[null,null],l.set(r,c));var d=c[0];i&&(d=null!=(s=c[1])?s:c[0]);var u={eventId:e,data:n};if(!(d&&this.compareReceipts(d,u)>=0)){var h=i?c[0]:u,v=i?u:c[1],p=null;h&&v&&(p=this.getUnfilteredTimelineSet().compareEventOrdering(h.eventId,v.eventId));var m=null===p||p<0,g=null!=(o=c[1])?o:c[0];if(i&&m?c[1]=u:!i&&(c[0]=u,m||(c[1]=null)),g!==(null!=(a=c[1])?a:c[0])){if(g&&this.receiptCacheByEventId.get(g.eventId)){var f=g.eventId;this.receiptCacheByEventId.set(f,this.receiptCacheByEventId.get(f).filter(e=>e.type!==t||e.userId!==r)),this.receiptCacheByEventId.get(f).length<1&&this.receiptCacheByEventId.delete(f)}this.receiptCacheByEventId.get(e)||this.receiptCacheByEventId.set(e,[]),this.receiptCacheByEventId.get(e).push({userId:r,type:t,data:n})}}}getReceiptsForEvent(e){return this.receiptCacheByEventId.get(e.getId())||[]}fixupNotifications(e){var t=this.getReadReceiptForUserId(e,!1),r=this.timeline[this.timeline.length-1];r&&(null==t?void 0:t.eventId)===r.getId()&&e===r.getSender()&&(this.setUnread(c.X5.Total,0),this.setUnread(c.X5.Highlight,0))}addLocalEchoReceipt(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];this.addReceipt(v(e,t,r,n),!0)}getUsersReadUpTo(e){return this.getReceiptsForEvent(e).filter(function(e){return(0,a.ll)(e.type)}).map(function(e){return e.userId})}}},9086:(e,t,r)=>{"use strict";r.d(t,{Bx:()=>i,CJ:()=>l,Ct:()=>s,D7:()=>d,ID:()=>v,Ng:()=>f,SY:()=>w,Sr:()=>_,VT:()=>S,Wr:()=>a,Xs:()=>E,Yg:()=>y,Z3:()=>g,cr:()=>b,ge:()=>m,iK:()=>p,nN:()=>h,ud:()=>u,wt:()=>c,zZ:()=>o});var n=r(81626),i=function(e){return e.RoomCanonicalAlias="m.room.canonical_alias",e.RoomCreate="m.room.create",e.RoomJoinRules="m.room.join_rules",e.RoomMember="m.room.member",e.RoomThirdPartyInvite="m.room.third_party_invite",e.RoomPowerLevels="m.room.power_levels",e.RoomName="m.room.name",e.RoomTopic="m.room.topic",e.RoomAvatar="m.room.avatar",e.RoomPinnedEvents="m.room.pinned_events",e.RoomEncryption="m.room.encryption",e.RoomHistoryVisibility="m.room.history_visibility",e.RoomGuestAccess="m.room.guest_access",e.RoomServerAcl="m.room.server_acl",e.RoomTombstone="m.room.tombstone",e.RoomPredecessor="org.matrix.msc3946.room_predecessor",e.PolicyRuleUser="m.policy.rule.user",e.PolicyRuleRoom="m.policy.rule.room",e.PolicyRuleServer="m.policy.rule.server",e.SpaceChild="m.space.child",e.SpaceParent="m.space.parent",e.RoomRedaction="m.room.redaction",e.RoomMessage="m.room.message",e.RoomMessageEncrypted="m.room.encrypted",e.Sticker="m.sticker",e.CallInvite="m.call.invite",e.CallCandidates="m.call.candidates",e.CallAnswer="m.call.answer",e.CallHangup="m.call.hangup",e.CallReject="m.call.reject",e.CallSelectAnswer="m.call.select_answer",e.CallNegotiate="m.call.negotiate",e.CallSDPStreamMetadataChanged="m.call.sdp_stream_metadata_changed",e.CallSDPStreamMetadataChangedPrefix="org.matrix.call.sdp_stream_metadata_changed",e.CallReplaces="m.call.replaces",e.CallAssertedIdentity="m.call.asserted_identity",e.CallAssertedIdentityPrefix="org.matrix.call.asserted_identity",e.CallEncryptionKeysPrefix="io.element.call.encryption_keys",e.KeyVerificationRequest="m.key.verification.request",e.KeyVerificationStart="m.key.verification.start",e.KeyVerificationCancel="m.key.verification.cancel",e.KeyVerificationMac="m.key.verification.mac",e.KeyVerificationDone="m.key.verification.done",e.KeyVerificationKey="m.key.verification.key",e.KeyVerificationAccept="m.key.verification.accept",e.KeyVerificationReady="m.key.verification.ready",e.RoomMessageFeedback="m.room.message.feedback",e.Reaction="m.reaction",e.PollStart="org.matrix.msc3381.poll.start",e.Typing="m.typing",e.Receipt="m.receipt",e.Presence="m.presence",e.FullyRead="m.fully_read",e.Tag="m.tag",e.SpaceOrder="org.matrix.msc3230.space_order",e.PushRules="m.push_rules",e.Direct="m.direct",e.IgnoredUserList="m.ignored_user_list",e.RoomKey="m.room_key",e.RoomKeyRequest="m.room_key_request",e.ForwardedRoomKey="m.forwarded_room_key",e.Dummy="m.dummy",e.SecretRequest="m.secret.request",e.SecretSend="m.secret.send",e.GroupCallPrefix="org.matrix.msc3401.call",e.GroupCallMemberPrefix="org.matrix.msc3401.call.member",e.RTCMembership="org.matrix.msc4143.rtc.member",e.CallNotify="org.matrix.msc4075.call.notify",e.RTCNotification="org.matrix.msc4075.rtc.notification",e.RTCDecline="org.matrix.msc4310.rtc.decline",e.RoomPolicy="org.matrix.msc4284.policy",e}({}),o=function(e){return e.Annotation="m.annotation",e.Replace="m.replace",e.Reference="m.reference",e.Thread="m.thread",e}({}),a=function(e){return e.Text="m.text",e.Emote="m.emote",e.Notice="m.notice",e.Image="m.image",e.File="m.file",e.Audio="m.audio",e.Location="m.location",e.Video="m.video",e.KeyVerificationRequest="m.key.verification.request",e}({}),s="type",l=function(e){return e.Space="m.space",e.UnstableCall="org.matrix.msc3417.call",e.ElementVideo="io.element.video",e}({}),c="org.matrix.msgid",d=new n.qr("m.room.purpose","org.matrix.msc3088.purpose"),u=new n.qr("m.enabled","org.matrix.msc3088.enabled"),h=new n.qr("m.data_tree","org.matrix.msc3089.data_tree"),v=new n.qr("m.leaf","org.matrix.msc3089.leaf"),p=new n.qr("m.branch","org.matrix.msc3089.branch"),m=new n.qr("m.room.marker","org.matrix.msc2716.marker"),g=new n.qr("with_rel_types","org.matrix.msc3912.with_relations"),f=new n.qr("io.element.functional_members","io.element.functional_members"),y=new n.qr("m.visibility","org.matrix.msc3531.visibility"),b=new n.qr("enabled","org.matrix.msc3881.enabled"),S=new n.qr("device_id","org.matrix.msc3881.device_id"),E=new n.qr("m.local_notification_settings","org.matrix.msc3890.local_notification_settings"),_=new n.qr("thread_id","org.matrix.msc4023.thread_id"),w=new n.xu("membership","io.element.msc4115.membership")},9678:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BuiltInModalButtonID=void 0,t.BuiltInModalButtonID=function(e){return e.Close="m.close",e}({})},10393:(e,t)=>{"use strict";function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function n(e,t){return(n=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function i(e){return(i=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function o(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}function a(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function s(e,t,r){return t&&a(e.prototype,t),r&&a(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}Object.defineProperty(t,"__esModule",{value:!0}),t.UnstableValue=t.NamespacedValue=void 0;var l=function(){function e(t,r){if(o(this,e),this.stable=t,this.unstable=r,!this.unstable&&!this.stable)throw Error("One of stable or unstable values must be supplied")}return s(e,[{key:"name",get:function(){return this.stable?this.stable:this.unstable}},{key:"altName",get:function(){return this.stable?this.unstable:null}},{key:"matches",value:function(e){return!!this.name&&this.name===e||!!this.altName&&this.altName===e}},{key:"findIn",value:function(e){var t;return this.name&&(t=null==e?void 0:e[this.name]),!t&&this.altName&&(t=null==e?void 0:e[this.altName]),t}},{key:"includedIn",value:function(e){var t=!1;return this.name&&(t=e.includes(this.name)),!t&&this.altName&&(t=e.includes(this.altName)),t}}]),e}();t.NamespacedValue=l,t.UnstableValue=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");l.prototype=Object.create(e&&e.prototype,{constructor:{value:l,writable:!0,configurable:!0}}),Object.defineProperty(l,"prototype",{writable:!1}),e&&n(l,e);var t,a=(t=function(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}(),function(){var e,n=i(l);return e=t?Reflect.construct(n,arguments,i(this).constructor):n.apply(this,arguments),function(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw TypeError("Derived constructors may only return object or undefined");var n=e;if(void 0===n)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return n}(this,e)});function l(e,t){var r;if(o(this,l),!(r=a.call(this,e,t)).unstable)throw Error("Unstable value must be supplied");return r}return s(l,[{key:"name",get:function(){return this.unstable}},{key:"altName",get:function(){return this.stable}}]),l}(l)},11007:(e,t,r)=>{"use strict";r.d(t,{S:()=>n});var n=function(e){return e.IS="SERVICE_TYPE_IS",e.IM="SERVICE_TYPE_IM",e}({})},11257:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OpenIDRequestState=void 0,t.OpenIDRequestState=function(e){return e.Allowed="allowed",e.Blocked="blocked",e.PendingUserConfirmation="request",e}({})},11749:(e,t,r)=>{"use strict";r.d(t,{$9:()=>W,A4:()=>y,Ab:()=>p,Bi:()=>function e(t,r){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];for(var[i,o]of Object.entries(r)){if(t[i]instanceof Object&&o){e(t[i],o);continue}if(null!=o||!n){Y(t,i,o);continue}}return t},C6:()=>Y,CC:()=>F,Et:()=>b,Fq:()=>H,G$:()=>O,Gp:()=>S,HF:()=>function e(t){var r=new Map;for(var[n,i]of t)r.set(n,function t(r){return r instanceof Map?e(r):Array.isArray(r)?r.map(e=>t(e)):r}(i));return Object.fromEntries(r.entries())},Mf:()=>L,NQ:()=>C,Nt:()=>T,Nz:()=>g,O5:()=>X,RR:()=>m,S8:()=>_,UB:()=>f,YY:()=>z,aw:()=>q,d7:()=>E,d8:()=>P,dn:()=>I,hX:()=>M,hc:()=>A,hl:()=>function e(t){if("object"!=typeof t||null==t||Array.isArray(t))return t;var r=[];for(var[n,i]of Object.entries(t))r.push([n,e(i)]);return r.sort((e,t)=>q(e[0],t[0])),r},hm:()=>v,j0:()=>x,kG:()=>$,kg:()=>J,ky:()=>function e(t,r){if(t===r)return!0;if(typeof t!=typeof r)return!1;if("number"==typeof t&&isNaN(t)&&isNaN(r))return!0;if(null===t||null===r)return t===r;if("Object"!==t.constructor.name&&"RegExp"!==t.constructor.name&&"Date"!==t.constructor.name&&"Array"!==t.constructor.name||t.prototype!==r.prototype)return!1;if(t instanceof RegExp||t instanceof Date)return t.toString()===r.toString();if(Array.isArray(t)){if(t.length!==r.length)return!1;for(var n=0;n<t.length;n++)if(!e(t[n],r[n]))return!1}else{for(var i in r)if(r.hasOwnProperty(i)!==t.hasOwnProperty(i))return!1;for(var o in t)if(r.hasOwnProperty(o)!==t.hasOwnProperty(o)||!e(t[o],r[o]))return!1}return!0},ll:()=>G,sy:()=>B,yD:()=>h,yy:()=>R,zR:()=>K});var n=r(29301),i=r(84458),o=r(65957),a=r(24673),s=r(8221),l=r(33234);function c(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function d(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?c(Object(r),!0).forEach(function(t){(0,i.A)(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):c(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}var u=new Map;function h(e){return e instanceof String&&(e=e.toString()),u.has(e)||u.set(e,e),u.get(e)}function v(e,t){var r=null!=t?t:new URLSearchParams,n=function(e){null!=o&&(Array.isArray(o)?o.forEach(t=>{r.append(e,String(t))}):r.append(e,String(o)))};for(var[i,o]of Object.entries(e))n(i);return r}function p(e,t,r){var n=d(d({},r),{},{[t]:r[e]});return delete n[e],n}function m(e,t){for(var r in t)if(t.hasOwnProperty(r)){var n=t[r];null!=n&&(e=e.replace(r,encodeURIComponent(n)))}return e}function g(e,t,r){var n;if(r){for(n=e.length-1;n>=0;n--)if(t(e[n],n,e))return e.splice(n,1),!0}else for(n=0;n<e.length;n++)if(t(e[n],n,e))return e.splice(n,1),!0;return!1}function f(e,t){for(var r of t)if(!e.hasOwnProperty(r))throw Error("Missing required key: "+r)}function y(e){return JSON.parse(JSON.stringify(e))}function b(e){return"number"==typeof e&&isFinite(e)}function S(e){return"string"==typeof e?o(e.normalize("NFD").replace(w,"")):""}function E(e){return"string"==typeof e?e.replace(/[\u202d-\u202e]/g,""):""}function _(e){return S(e.toLowerCase()).replace(/[\\'!"#$%&()*+,\-./:;<=>?@[\]^_`{|}~\u2000-\u206f\u2e00-\u2e7f]/g,"").toLowerCase()}var w=/[\u2000-\u200F\u202A-\u202F\u0300-\u036F\uFEFF\u061C\u2800\u2062-\u2063\s]/g;function T(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function I(e){return T(e).replace(/\\\*/g,".*").replace(/\?/g,".")}function A(e){return null!=e&&e.endsWith("/")?e.slice(0,-1):e}function R(e,t){return new Promise(r=>{setTimeout(r,e,t)})}function C(e,t,r){return k.apply(this,arguments)}function k(){return(k=(0,n.A)(function*(e,t,r){var n=Date.now();try{return yield r()}finally{var i=Date.now();e.debug("[Perf]: ".concat(t," took ").concat(i-n,"ms"))}})).apply(this,arguments)}function O(e,t,r){var n=Date.now();try{return r()}finally{var i=Date.now();e.debug("[Perf]: ".concat(t," took ").concat(i-n,"ms"))}}function M(e){return null==e}function P(e,t){return D.apply(this,arguments)}function D(){return(D=(0,n.A)(function*(e,t){for(var r of e)yield t((yield r))})).apply(this,arguments)}function x(e){return Promise.resolve(e())}function F(e,t){return(0,a.Ay)(t=>e(t),{retries:1/0,shouldRetry:t?e=>{var{error:r}=e;return t(r)}:void 0,factor:2,minTimeout:3e3,maxTimeout:15e3})}var L=(()=>{for(var e="",t=32;t<=126;t++)e+=String.fromCharCode(t);return e})();function U(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:L;return e.padEnd(t,r[0])}function N(e){var t,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:L,n=BigInt(r.length);if(e<=n)return null!=(t=r[Number(e)-1])?t:"";var i=e/n,o=Number(e%n)-1;return o<0&&(i-=BigInt(Math.abs(o)),o=Number(n)-1),N(i,r)+r[o]}function j(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:L,r=BigInt(t.length),n=BigInt(0),i=e.length-1,o=BigInt(0);i>=0;i--,o++)n+=BigInt(1+(e.charCodeAt(i)-t.charCodeAt(0)))*r**o;return n}function B(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:L,n=Math.max(e.length,t.length),i=j(U(e,n,r),r),o=j(U(t,n,r),r),a=(i+o)/BigInt(2);return a===i||a==o?N(a,r)+r[0]:N(a,r)}function W(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:L;return N(j(e,t)+BigInt(1),t)}function K(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:L;return N(j(e,t)-BigInt(1),t)}function q(e,t){return e<t?-1:+(e>t)}function V(e){var t;return null!=(t=s.vo.findIn(e.getContent()))?t:-1}function H(e,t){return V(t)-V(e)}function G(e){return[l.L.Read,l.L.ReadPrivate].includes(e)}function J(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:(e,t)=>e===t;if(e.size!==t.size)return!1;for(var[n,i]of e){var o=t.get(n);if(void 0===o||!r(i,o))return!1}return!0}function z(e){return"__proto__"===e||"prototype"===e||"constructor"===e}function Y(e,t,r){if(z(t))throw Error("Trying to modify prototype or constructor");e[t]=r}function X(e){return!(z(e.room_id)||z(e.sender)||z(e.event_id))}class $ extends Map{constructor(e){super(),this.createDefault=e}getOrCreate(e){return this.has(e)||this.set(e,this.createDefault()),this.get(e)}}},12411:(e,t,r)=>{"use strict";r.d(t,{O:()=>a,q:()=>s});var n=r(84458),i=r(29927),o=r(9086),a=function(e){return e.Backward="b",e.Forward="f",e}({});class s{static setEventMetadata(e,t,r){e.setMetadata(t,r)}constructor(e){var t,r;this.eventTimelineSet=e,(0,n.A)(this,"roomId",void 0),(0,n.A)(this,"name",void 0),(0,n.A)(this,"events",[]),(0,n.A)(this,"baseIndex",0),(0,n.A)(this,"startState",void 0),(0,n.A)(this,"endState",void 0),(0,n.A)(this,"startToken",null),(0,n.A)(this,"endToken",null),(0,n.A)(this,"prevTimeline",null),(0,n.A)(this,"nextTimeline",null),(0,n.A)(this,"paginationRequests",{[a.Backward]:null,[a.Forward]:null}),this.roomId=null!=(t=null==(r=e.room)?void 0:r.roomId)?t:null,this.roomId&&(this.startState=new i.H(this.roomId),this.endState=new i.H(this.roomId)),this.paginationRequests={b:null,f:null},this.name=this.roomId+":"+new Date().toISOString()}initialiseState(e){var t,r,{timelineWasEmpty:n}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(this.events.length>0)throw Error("Cannot initialise state after events are added");null==(t=this.startState)||t.setStateEvents(e,{timelineWasEmpty:n}),null==(r=this.endState)||r.setStateEvents(e,{timelineWasEmpty:n})}forkLive(e){var t=this.getState(e),r=new s(this.eventTimelineSet);return r.startState=null==t?void 0:t.clone(),r.endState=t,this.endState=null==t?void 0:t.clone(),r}fork(e){var t=this.getState(e),r=new s(this.eventTimelineSet);return r.startState=null==t?void 0:t.clone(),r.endState=null==t?void 0:t.clone(),r}getRoomId(){return this.roomId}getFilter(){return this.eventTimelineSet.getFilter()}getTimelineSet(){return this.eventTimelineSet}getBaseIndex(){return this.baseIndex}getEvents(){return this.events}getState(e){if(e==s.BACKWARDS)return this.startState;if(e==s.FORWARDS)return this.endState;throw Error("Invalid direction '"+e+"'")}getPaginationToken(e){return this.roomId?this.getState(e).paginationToken:e===a.Backward?this.startToken:this.endToken}setPaginationToken(e,t){this.roomId?this.getState(t).paginationToken=e:t===a.Backward?this.startToken=e:this.endToken=e}getNeighbouringTimeline(e){if(e==s.BACKWARDS)return this.prevTimeline;if(e==s.FORWARDS)return this.nextTimeline;throw Error("Invalid direction '"+e+"'")}setNeighbouringTimeline(e,t){if(this.getNeighbouringTimeline(t))throw Error("timeline already has a neighbouring timeline - cannot reset neighbour (direction: "+t+")");if(t==s.BACKWARDS)this.prevTimeline=e;else if(t==s.FORWARDS)this.nextTimeline=e;else throw Error("Invalid direction '"+t+"'");this.setPaginationToken(null,t)}addEvent(e,t){var r,n,{toStartOfTimeline:i,roomState:a,timelineWasEmpty:l,addToState:c}=t;a||(a=i?this.startState:this.endState);var d=this.getTimelineSet();d.room&&(s.setEventMetadata(e,a,i),c&&e.isState()&&d.room.getUnfilteredTimelineSet()===d&&(null==(r=a)||r.setStateEvents([e],{timelineWasEmpty:l}),e.sender&&(e.getType()!==o.Bx.RoomMember||i)||s.setEventMetadata(e,a,i))),n=i?0:this.events.length,this.events.splice(n,0,e),i&&this.baseIndex++}insertEvent(e,t,r,n){var i=this.getTimelineSet();i.room&&(s.setEventMetadata(e,r,!1),n&&e.isState()&&i.room.getUnfilteredTimelineSet()===i&&(r.setStateEvents([e],{}),e.sender&&e.getType()!==o.Bx.RoomMember||s.setEventMetadata(e,r,!1))),this.events.splice(t,0,e)}removeEvent(e){for(var t=this.events.length-1;t>=0;t--){var r=this.events[t];if(r.getId()==e)return this.events.splice(t,1),t<this.baseIndex&&this.baseIndex--,r}return null}toString(){return this.name}}(0,n.A)(s,"BACKWARDS",a.Backward),(0,n.A)(s,"FORWARDS",a.Forward)},12826:(e,t)=>{"use strict";function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function n(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,function(e){var t=function(e,t){if("object"!==r(e)||null===e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var i=n.call(e,t||"default");if("object"!==r(i))return i;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"===r(t)?t:String(t)}(i.key),i)}}Object.defineProperty(t,"__esModule",{value:!0}),t.WidgetEventCapability=t.EventKind=t.EventDirection=void 0;var o=function(e){return e.Event="event",e.State="state_event",e.ToDevice="to_device",e.RoomAccount="room_account",e}({});t.EventKind=o;var a=function(e){return e.Send="send",e.Receive="receive",e}({});t.EventDirection=a,t.WidgetEventCapability=function(){var e,t;function r(e,t,n,i,o){if(!(this instanceof r))throw TypeError("Cannot call a class as a function");this.direction=e,this.eventType=t,this.kind=n,this.keyStr=i,this.raw=o}return e=[{key:"matchesAsStateEvent",value:function(e,t,r){return this.kind===o.State&&this.direction===e&&this.eventType===t&&(null===this.keyStr||this.keyStr===r)}},{key:"matchesAsToDeviceEvent",value:function(e,t){return this.kind===o.ToDevice&&this.direction===e&&this.eventType===t}},{key:"matchesAsRoomEvent",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return this.kind===o.Event&&this.direction===e&&this.eventType===t&&("m.room.message"!==this.eventType||null===this.keyStr||this.keyStr===r)}},{key:"matchesAsRoomAccountData",value:function(e,t){return this.kind===o.RoomAccount&&this.direction===e&&this.eventType===t}}],t=[{key:"forStateEvent",value:function(e,t,n){t=t.replace(/#/g,"\\#"),n=null!=n?"#".concat(n):"";var i="org.matrix.msc2762.".concat(e,".state_event:").concat(t).concat(n);return r.findEventCapabilities([i])[0]}},{key:"forToDeviceEvent",value:function(e,t){var n="org.matrix.msc3819.".concat(e,".to_device:").concat(t);return r.findEventCapabilities([n])[0]}},{key:"forRoomEvent",value:function(e,t){var n="org.matrix.msc2762.".concat(e,".event:").concat(t);return r.findEventCapabilities([n])[0]}},{key:"forRoomMessageEvent",value:function(e,t){t=null==t?"":t;var n="org.matrix.msc2762.".concat(e,".event:m.room.message#").concat(t);return r.findEventCapabilities([n])[0]}},{key:"forRoomAccountData",value:function(e,t){var n="com.beeper.capabilities.".concat(e,".room_account_data:").concat(t);return r.findEventCapabilities([n])[0]}},{key:"findEventCapabilities",value:function(e){var t,i=[],s=function(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return n(e,void 0);var r=Object.prototype.toString.call(e).slice(8,-1);if("Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return n(e,t)}}(e))){r&&(e=r);var i=0,o=function(){};return{s:o,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:o}}throw TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,s=!0,l=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return s=e.done,e},e:function(e){l=!0,a=e},f:function(){try{s||null==r.return||r.return()}finally{if(l)throw a}}}}(e);try{for(s.s();!(t=s.n()).done;){var l=t.value,c=null,d=void 0,u=null;if(l.startsWith("org.matrix.msc2762.send.event:")?(c=a.Send,u=o.Event,d=l.substring(30)):l.startsWith("org.matrix.msc2762.send.state_event:")?(c=a.Send,u=o.State,d=l.substring(36)):l.startsWith("org.matrix.msc3819.send.to_device:")?(c=a.Send,u=o.ToDevice,d=l.substring(34)):l.startsWith("org.matrix.msc2762.receive.event:")?(c=a.Receive,u=o.Event,d=l.substring(33)):l.startsWith("org.matrix.msc2762.receive.state_event:")?(c=a.Receive,u=o.State,d=l.substring(39)):l.startsWith("org.matrix.msc3819.receive.to_device:")?(c=a.Receive,u=o.ToDevice,d=l.substring(37)):l.startsWith("com.beeper.capabilities.receive.room_account_data:")&&(c=a.Receive,u=o.RoomAccount,d=l.substring(50)),null!==c&&null!==u&&void 0!==d){var h=d.startsWith("m.room.message#")||u===o.State,v=null;if(d.includes("#")&&h){var p=d.split("#"),m=p.findIndex(function(e){return!e.endsWith("\\")});d=p.slice(0,m+1).map(function(e){return e.endsWith("\\")?e.substring(0,e.length-1):e}).join("#"),v=p.slice(m+1).join("#")}i.push(new r(c,d,u,v,l))}}}catch(e){s.e(e)}finally{s.f()}return i}}],e&&i(r.prototype,e),t&&i(r,t),Object.defineProperty(r,"prototype",{writable:!1}),r}()},12922:(e,t,r)=>{"use strict";r.d(t,{E:()=>i,z:()=>o});var n=r(81626),i=new n.qr("m.beacon_info","org.matrix.msc3672.beacon_info"),o=new n.qr("m.beacon","org.matrix.msc3672.beacon")},12965:(e,t,r)=>{"use strict";r.d(t,{p:()=>o,u:()=>i});var n=r(84458),i=function(e){return e[e.Blocked=-1]="Blocked",e[e.Unverified=0]="Unverified",e[e.Verified=1]="Verified",e}({});class o{constructor(e){(0,n.A)(this,"deviceId",void 0),(0,n.A)(this,"userId",void 0),(0,n.A)(this,"algorithms",void 0),(0,n.A)(this,"keys",void 0),(0,n.A)(this,"verified",void 0),(0,n.A)(this,"signatures",void 0),(0,n.A)(this,"displayName",void 0),(0,n.A)(this,"dehydrated",!1),this.deviceId=e.deviceId,this.userId=e.userId,this.algorithms=e.algorithms,this.keys=e.keys,this.verified=e.verified||i.Unverified,this.signatures=e.signatures||new Map,this.displayName=e.displayName,this.dehydrated=!!e.dehydrated}getFingerprint(){return this.keys.get("ed25519:".concat(this.deviceId))}getIdentityKey(){return this.keys.get("curve25519:".concat(this.deviceId))}}},14308:(e,t,r)=>{"use strict";r.d(t,{$S:()=>a,cI:()=>l,li:()=>o,ms:()=>i,qN:()=>s});var n=r(19599),i=new n.UnstableValue("m.poll.disclosed","org.matrix.msc3381.poll.disclosed"),o=new n.UnstableValue("m.poll.undisclosed","org.matrix.msc3381.poll.undisclosed"),a=new n.UnstableValue("m.poll.start","org.matrix.msc3381.poll.start"),s=new n.UnstableValue("m.poll.response","org.matrix.msc3381.poll.response"),l=new n.UnstableValue("m.poll.end","org.matrix.msc3381.poll.end")},14699:(e,t,r)=>{"use strict";r.d(t,{m:()=>_});var n=r(84458),i=r(29301),o=r(61219),a=r(5408),s=r(11749),l=r(12411),c=r(49699),d=r(64763),u=r(36963),h=r(85590),v=r(9086),p=r(29927),m=r(59741),g=r(5294);class f{constructor(e){this.crypto=e}name(){return"e2ee"}when(){return h.HY.PreProcess}onRequest(e){var t=this;return(0,i.A)(function*(){return e&&(a.vF.log("ExtensionE2EE: invalidating all device lists due to missing 'pos'"),yield t.crypto.markAllTrackedUsersAsDirty()),{enabled:!0}})()}onResponse(e){var t=this;return(0,i.A)(function*(){e.device_lists&&(yield t.crypto.processDeviceLists(e.device_lists)),yield t.crypto.processKeyCounts(e.device_one_time_keys_count,e.device_unused_fallback_key_types||e["org.matrix.msc2732.device_unused_fallback_key_types"]),t.crypto.onSyncCompleted({})})()}}class y{constructor(e,t){this.client=e,this.cryptoCallbacks=t,(0,n.A)(this,"nextBatch",null)}name(){return"to_device"}when(){return h.HY.PreProcess}onRequest(e){var t=this;return(0,i.A)(function*(){return{since:null!==t.nextBatch?t.nextBatch:void 0,limit:100,enabled:!0}})()}onResponse(e){var t=this;return(0,i.A)(function*(){var r,n=e.events||[];r=t.cryptoCallbacks?yield t.cryptoCallbacks.preprocessToDeviceMessages(n):n.map(e=>({message:e,encryptionInfo:null})),(0,d.pq)(r,t.client),t.nextBatch=e.next_batch})()}}class b{constructor(e){this.client=e}name(){return"account_data"}when(){return h.HY.PostProcess}onRequest(e){return(0,i.A)(function*(){return{enabled:!0}})()}onResponse(e){var t=this;return(0,i.A)(function*(){for(var r in e.global&&e.global.length>0&&t.processGlobalAccountData(e.global),e.rooms){var n=w(t.client,r,e.rooms[r]),i=t.client.getRoom(r);if(!i){a.vF.warn("got account data for room but room doesn't exist on client:",r);continue}i.addAccountData(n),n.forEach(e=>{t.client.emit(c.AU.Event,e)})}})()}processGlobalAccountData(e){var t=w(this.client,void 0,e),r=t.reduce((e,t)=>(e[t.getType()]=this.client.store.getAccountData(t.getType()),e),{});this.client.store.storeAccountDataEvents(t),t.forEach(e=>{if(e.getType()===v.Bx.PushRules){var t=e.getContent();this.client.setPushRules(t)}var n=r[e.getType()];return this.client.emit(c.AU.AccountData,e,n),e})}}class S{constructor(e){this.client=e}name(){return"typing"}when(){return h.HY.PostProcess}onRequest(e){return(0,i.A)(function*(){return{enabled:!0}})()}onResponse(e){var t=this;return(0,i.A)(function*(){if(null!=e&&e.rooms)for(var r in e.rooms)T(t.client,r,[e.rooms[r]])})()}}class E{constructor(e){this.client=e}name(){return"receipts"}when(){return h.HY.PostProcess}onRequest(e){return(0,i.A)(function*(){return{enabled:!0}})()}onResponse(e){var t=this;return(0,i.A)(function*(){if(null!=e&&e.rooms)for(var r in e.rooms)T(t.client,r,[e.rooms[r]])})()}}class _{constructor(e,t,r,i){this.slidingSync=e,this.client=t,(0,n.A)(this,"opts",void 0),(0,n.A)(this,"syncOpts",void 0),(0,n.A)(this,"syncState",null),(0,n.A)(this,"syncStateData",void 0),(0,n.A)(this,"lastPos",null),(0,n.A)(this,"failCount",0),(0,n.A)(this,"notifEvents",[]),this.opts=(0,d.Bn)(r),this.syncOpts=(0,d.Fe)(i),t.getNotifTimelineSet()&&t.reEmitter.reEmit(t.getNotifTimelineSet(),[o.u9.Timeline,o.u9.TimelineReset]),this.slidingSync.on(h.cQ.Lifecycle,this.onLifecycle.bind(this)),this.slidingSync.on(h.cQ.RoomData,this.onRoomData.bind(this));var a=[new y(this.client,this.syncOpts.cryptoCallbacks),new b(this.client),new S(this.client),new E(this.client)];this.syncOpts.cryptoCallbacks&&a.push(new f(this.syncOpts.cryptoCallbacks)),a.forEach(e=>{this.slidingSync.registerExtension(e)})}onRoomData(e,t){var r=this;return(0,i.A)(function*(){var n=r.client.store.getRoom(e);if(!n){if(!t.initial)return void r.syncOpts.logger.debug("initial flag not set but no stored room exists for room ",e,t);n=(0,d.M)(r.client,e,r.opts)}yield r.processRoomData(r.client,n,t)})()}onLifecycle(e,t,r){switch(r&&this.syncOpts.logger.debug("onLifecycle",e,r),e){case h.ns.Complete:if(this.purgeNotifications(),!t)break;this.lastPos||this.updateSyncState(d.Lm.Prepared,{oldSyncToken:void 0,nextSyncToken:t.pos,catchingUp:!1,fromCache:!1}),this.updateSyncState(d.Lm.Syncing,{oldSyncToken:this.lastPos,nextSyncToken:t.pos,catchingUp:!1,fromCache:!1}),this.lastPos=t.pos;break;case h.ns.RequestFinished:if(r){if(this.failCount+=1,this.updateSyncState(this.failCount>3?d.Lm.Error:d.Lm.Reconnecting,{error:new u.up(r)}),this.shouldAbortSync(new u.up(r)))return}else this.failCount=0,this.syncOpts.logger.debug("SlidingSyncState.RequestFinished with ".concat(Object.keys((null==t?void 0:t.rooms)||[]).length," rooms"))}}syncLeftRooms(){return(0,i.A)(function*(){return[]})()}peek(e){return(0,i.A)(function*(){return null})()}stopPeeking(){}setPresence(e){}getSyncState(){return this.syncState}getSyncStateData(){var e;return null!=(e=this.syncStateData)?e:null}createRoom(e){var{timelineSupport:t}=this.client,r=new o.Wv(e,this.client,this.client.getUserId(),{lazyLoadMembers:this.opts.lazyLoadMembers,pendingEventOrdering:this.opts.pendingEventOrdering,timelineSupport:t});return this.client.reEmitter.reEmit(r,[o.u9.Name,o.u9.Redaction,o.u9.RedactionCancelled,o.u9.Receipt,o.u9.Tags,o.u9.LocalEchoUpdated,o.u9.AccountData,o.u9.MyMembership,o.u9.Timeline,o.u9.TimelineReset]),this.registerStateListeners(r),r}registerStateListeners(e){this.client.reEmitter.reEmit(e.currentState,[p.f.Events,p.f.Members,p.f.NewMember,p.f.Update]),e.currentState.on(p.f.NewMember,(e,t,r)=>{var n;r.user=null!=(n=this.client.getUser(r.userId))?n:void 0,this.client.reEmitter.reEmit(r,[m.o5.Name,m.o5.Typing,m.o5.PowerLevel,m.o5.Membership])})}shouldAbortSync(e){return"M_UNKNOWN_TOKEN"===e.errcode&&(this.syncOpts.logger.warn("Token no longer valid - assuming logout"),this.stop(),this.updateSyncState(d.Lm.Error,{error:e}),!0)}processRoomData(e,t,r){var n=this;return(0,i.A)(function*(){r=function(e,t,r){if(!r.name)return r;for(var n of r.required_state)if(n.type===v.Bx.RoomName&&""===n.state_key)return n.content={name:r.name},r;return r.required_state.push({event_id:"$fake-sliding-sync-name-event-"+t,state_key:"",type:v.Bx.RoomName,content:{name:r.name},sender:e.getUserId(),origin_server_ts:new Date().getTime()}),r}(e,t.roomId,r);var a,d,u=w(n.client,t.roomId,r.required_state),h=w(n.client,t.roomId,r.timeline,!1),p=[];if(r.limited||r.initial){var m=new Set;t.getLiveTimeline().getEvents().forEach(e=>{m.add(e.getId())});for(var f=[],y=[],b=!1,S=h.length-1;S>=0;S--){var E=h[S];if(m.has(E.getId())){b=!0;continue}b?f.push(E):y.unshift(E)}h=y,f.length>0&&t.addEventsToTimeline(f,!0,!1,t.getLiveTimeline(),r.prev_batch)}var _=t.hasEncryptionStateEvent();if(null!=r.notification_count&&t.setUnreadNotificationCount(o.X5.Total,r.notification_count),null!=r.highlight_count&&(!_||_&&0>=t.getUnreadNotificationCount(o.X5.Highlight))&&t.setUnreadNotificationCount(o.X5.Highlight,r.highlight_count),r.bump_stamp&&t.setBumpStamp(r.bump_stamp),Number.isInteger(r.invited_count)&&t.currentState.setInvitedMemberCount(r.invited_count),Number.isInteger(r.joined_count)&&t.currentState.setJoinedMemberCount(r.joined_count),r.invite_state){var T=w(n.client,t.roomId,r.invite_state);yield n.injectRoomEvents(t,T),r.initial&&(t.recalculate(),n.client.store.storeRoom(t),n.client.emit(c.AU.Room,t)),T.forEach(e=>{n.client.emit(c.AU.Event,e)});return}r.limited&&t.getLiveTimeline().setPaginationToken(null!=(d=r.prev_batch)?d:null,l.q.BACKWARDS),yield n.injectRoomEvents(t,u,h,r.num_live),t.addEphemeralEvents(p),t.updateMyMembership(g.O.Join),t.setMSC4186SummaryData(r.heroes,r.joined_count,r.invited_count),t.recalculate(),r.initial&&(e.store.storeRoom(t),e.emit(c.AU.Room,t)),n.addNotifications(h);var I=(a=(0,i.A)(function*(r){e.emit(c.AU.Event,r),r.isState()&&r.getType()==v.Bx.RoomEncryption&&n.syncOpts.cryptoCallbacks&&(yield n.syncOpts.cryptoCallbacks.onCryptoEvent(t,r))}),function(e){return a.apply(this,arguments)});yield(0,s.d8)(u,I),yield(0,s.d8)(h,I),p.forEach(function(t){e.emit(c.AU.Event,t)}),t.decryptCriticalEvents()})()}injectRoomEvents(e,t){var r=arguments,n=this;return(0,i.A)(function*(){var i=r.length>2&&void 0!==r[2]?r[2]:[],o=r.length>3&&void 0!==r[3]?r[3]:0,a=e.getLiveTimeline(),s=0==a.getEvents().length;if(s){for(var l of t)n.client.getPushActionsForEvent(l);a.initialiseState(t)}s||(e.oldState.setStateEvents(t),e.currentState.setStateEvents(t));var c=[];o>0&&(c=i.slice(-1*o),i=i.slice(0,-1*c.length)),yield e.addLiveEvents(i,{fromCache:!0,addToState:!1}),c.length>0&&(yield e.addLiveEvents(c,{fromCache:!1,addToState:!1})),e.recalculate(),n.resolveInvites(e)})()}resolveInvites(e){if(e&&this.opts.resolveInvitesToProfiles){var t=this.client;e.getMembersWithMembership(g.O.Invite).forEach(function(r){if(!r.requestedProfileInfo){r.requestedProfileInfo=!0;var n=t.getUser(r.userId);(n?Promise.resolve({avatar_url:n.avatarUrl,displayname:n.displayName}):t.getProfileInfo(r.userId)).then(function(t){var n=r.events.member;n.getContent().membership===g.O.Invite&&(n.getContent().avatar_url=t.avatar_url,n.getContent().displayname=t.displayname,r.setMembershipEvent(n,e.currentState))},function(e){})}})}}retryImmediately(){return!0}sync(){var e=this;return(0,i.A)(function*(){for(e.syncOpts.logger.debug("Sliding sync init loop");!e.client.isGuest();)try{e.syncOpts.logger.debug("Getting push rules...");var t=yield e.client.getPushRules();e.syncOpts.logger.debug("Got push rules"),e.client.pushRules=t;break}catch(t){if(e.syncOpts.logger.error("Getting push rules failed",t),e.shouldAbortSync(t))return}yield e.slidingSync.start()})()}stop(){this.syncOpts.logger.debug("SyncApi.stop"),this.slidingSync.stop()}updateSyncState(e,t){var r=this.syncState;this.syncState=e,this.syncStateData=t,this.client.emit(c.AU.Sync,this.syncState,r,t)}addNotifications(e){if(this.client.getNotifTimelineSet())for(var t of e){var r=this.client.getPushActionsForEvent(t);r&&r.notify&&r.tweaks&&r.tweaks.highlight&&this.notifEvents.push(t)}}purgeNotifications(){this.notifEvents.sort(function(e,t){return e.getTs()-t.getTs()}),this.notifEvents.forEach(e=>{var t;null==(t=this.client.getNotifTimelineSet())||t.addLiveEvent(e,{addToState:!1})}),this.notifEvents=[]}}function w(e,t,r){var n=!(arguments.length>3)||void 0===arguments[3]||arguments[3],i=e.getEventMapper({decrypt:n});return r.map(function(e){return e.room_id=t,i(e)})}function T(e,t,r){var n=w(e,t,r),i=e.getRoom(t);if(!i)return void a.vF.warn("got ephemeral events for room but room doesn't exist on client:",t);i.addEphemeralEvents(n),n.forEach(t=>{e.emit(c.AU.Event,t)})}},15095:(e,t,r)=>{"use strict";r.d(t,{X:()=>a,u:()=>o});var n=r(29301),i=r(91699),o=function(e){return e.NewListener="newListener",e.RemoveListener="removeListener",e.Error="error",e}({});class a extends i.EventEmitter{addListener(e,t){return super.addListener(e,t)}emit(e){for(var t=arguments.length,r=Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];return super.emit(e,...r)}emitPromised(e){var t=arguments,r=this;return(0,n.A)(function*(){for(var n=t.length,i=Array(n>1?n-1:0),o=1;o<n;o++)i[o-1]=t[o];var a=r.listeners(e);return Promise.allSettled(a.map(e=>e(...i))).then(()=>a.length>0)})()}listenerCount(e){return super.listenerCount(e)}listeners(e){return super.listeners(e)}off(e,t){return super.off(e,t)}on(e,t){return super.on(e,t)}once(e,t){return super.once(e,t)}prependListener(e,t){return super.prependListener(e,t)}prependOnceListener(e,t){return super.prependOnceListener(e,t)}removeAllListeners(e){return void 0===e?super.removeAllListeners():super.removeAllListeners(e)}removeListener(e,t){return super.removeListener(e,t)}rawListeners(e){return super.rawListeners(e)}}},17242:(e,t)=>{"use strict";function r(e){return null!=e}Object.defineProperty(t,"__esModule",{value:!0}),t.isOptionalAString=function(e){return r(e)&&"string"==typeof e},t.isProvided=r},17351:(e,t,r)=>{"use strict";r.d(t,{I:()=>n});var n=function(e){return e.CONNECTION_STATS="StatsReport.connection_stats",e.CALL_FEED_REPORT="StatsReport.call_feed_report",e.BYTE_SENT_STATS="StatsReport.byte_sent_stats",e.SUMMARY_STATS="StatsReport.summary_stats",e}({})},17495:(e,t,r)=>{"use strict";function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.WidgetApiResponseError=t.WidgetApi=void 0;var i=r(91699),o=r(96039),a=r(55090),s=r(109),l=r(61904),c=r(11257),d=r(39706),u=r(9678),h=r(12826),v=r(79178),p=r(59879);function m(){m=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,i=Object.defineProperty||function(e,t,r){e[t]=r.value},o="function"==typeof Symbol?Symbol:{},a=o.iterator||"@@iterator",s=o.asyncIterator||"@@asyncIterator",l=o.toStringTag||"@@toStringTag";function c(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{c({},"")}catch(e){c=function(e,t,r){return e[t]=r}}function d(e,t,r,n){var o,a,s,l,c=Object.create((t&&t.prototype instanceof v?t:v).prototype);return i(c,"_invoke",{value:(o=e,a=r,s=new I(n||[]),l="suspendedStart",function(e,t){if("executing"===l)throw Error("Generator is already running");if("completed"===l){if("throw"===e)throw t;return R()}for(s.method=e,s.arg=t;;){var r=s.delegate;if(r){var n=function e(t,r){var n=r.method,i=t.iterator[n];if(void 0===i)return r.delegate=null,"throw"===n&&t.iterator.return&&(r.method="return",r.arg=void 0,e(t,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=TypeError("The iterator does not provide a '"+n+"' method")),h;var o=u(i,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,h;var a=o.arg;return a?a.done?(r[t.resultName]=a.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,h):a:(r.method="throw",r.arg=TypeError("iterator result is not an object"),r.delegate=null,h)}(r,s);if(n){if(n===h)continue;return n}}if("next"===s.method)s.sent=s._sent=s.arg;else if("throw"===s.method){if("suspendedStart"===l)throw l="completed",s.arg;s.dispatchException(s.arg)}else"return"===s.method&&s.abrupt("return",s.arg);l="executing";var i=u(o,a,s);if("normal"===i.type){if(l=s.done?"completed":"suspendedYield",i.arg===h)continue;return{value:i.arg,done:s.done}}"throw"===i.type&&(l="completed",s.method="throw",s.arg=i.arg)}})}),c}function u(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=d;var h={};function v(){}function p(){}function g(){}var f={};c(f,a,function(){return this});var y=Object.getPrototypeOf,b=y&&y(y(A([])));b&&b!==t&&r.call(b,a)&&(f=b);var S=g.prototype=v.prototype=Object.create(f);function E(e){["next","throw","return"].forEach(function(t){c(e,t,function(e){return this._invoke(t,e)})})}function _(e,t){var o;i(this,"_invoke",{value:function(i,a){function s(){return new t(function(o,s){!function i(o,a,s,l){var c=u(e[o],e,a);if("throw"!==c.type){var d=c.arg,h=d.value;return h&&"object"==n(h)&&r.call(h,"__await")?t.resolve(h.__await).then(function(e){i("next",e,s,l)},function(e){i("throw",e,s,l)}):t.resolve(h).then(function(e){d.value=e,s(d)},function(e){return i("throw",e,s,l)})}l(c.arg)}(i,a,o,s)})}return o=o?o.then(s,s):s()}})}function w(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function T(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function I(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(w,this),this.reset(!0)}function A(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,i=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return i.next=i}}return{next:R}}function R(){return{value:void 0,done:!0}}return p.prototype=g,i(S,"constructor",{value:g,configurable:!0}),i(g,"constructor",{value:p,configurable:!0}),p.displayName=c(g,l,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,g):(e.__proto__=g,c(e,l,"GeneratorFunction")),e.prototype=Object.create(S),e},e.awrap=function(e){return{__await:e}},E(_.prototype),c(_.prototype,s,function(){return this}),e.AsyncIterator=_,e.async=function(t,r,n,i,o){void 0===o&&(o=Promise);var a=new _(d(t,r,n,i),o);return e.isGeneratorFunction(r)?a:a.next().then(function(e){return e.done?e.value:a.next()})},E(S),c(S,l,"Generator"),c(S,a,function(){return this}),c(S,"toString",function(){return"[object Generator]"}),e.keys=function(e){var t=Object(e),r=[];for(var n in t)r.push(n);return r.reverse(),function e(){for(;r.length;){var n=r.pop();if(n in t)return e.value=n,e.done=!1,e}return e.done=!0,e}},e.values=A,I.prototype={constructor:I,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(T),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return a.type="throw",a.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var i=this.tryEntries.length-1;i>=0;--i){var o=this.tryEntries[i],a=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),l=r.call(o,"finallyLoc");if(s&&l){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!l)throw Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var i=this.tryEntries[n];if(i.tryLoc<=this.prev&&r.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var o=i;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var a=o?o.completion:{};return a.type=e,a.arg=t,o?(this.method="next",this.next=o.finallyLoc,h):this.complete(a)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),h},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),T(r),h}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var i=n.arg;T(r)}return i}}throw Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:A(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),h}},e}function g(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(e){r(e);return}s.done?t(l):Promise.resolve(l).then(n,i)}function f(e){return function(){var t=this,r=arguments;return new Promise(function(n,i){var o=e.apply(t,r);function a(e){g(o,n,i,a,s,"next",e)}function s(e){g(o,n,i,a,s,"throw",e)}a(void 0)})}}function y(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function b(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?y(Object(r),!0).forEach(function(t){E(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):y(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function S(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}function E(e,t,r){return(t=T(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,T(n.key),n)}}function w(e,t,r){return t&&_(e.prototype,t),r&&_(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function T(e){var t=function(e,t){if("object"!==n(e)||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var i=r.call(e,t||"default");if("object"!==n(i))return i;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"===n(t)?t:String(t)}function I(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}function A(e,t){if("function"!=typeof t&&null!==t)throw TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&P(e,t)}function R(e){var t=M();return function(){var r,i=D(e);return r=t?Reflect.construct(i,arguments,D(this).constructor):i.apply(this,arguments),function(e,t){if(t&&("object"===n(t)||"function"==typeof t))return t;if(void 0!==t)throw TypeError("Derived constructors may only return object or undefined");return C(e)}(this,r)}}function C(e){if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function k(e){var t="function"==typeof Map?new Map:void 0;return(k=function(e){var r;if(null===e||(r=e,-1===Function.toString.call(r).indexOf("[native code]")))return e;if("function"!=typeof e)throw TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,n)}function n(){return O(e,arguments,D(this).constructor)}return n.prototype=Object.create(e.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),P(n,e)})(e)}function O(e,t,r){return(O=M()?Reflect.construct.bind():function(e,t,r){var n=[null];n.push.apply(n,t);var i=new(Function.bind.apply(e,n));return r&&P(i,r.prototype),i}).apply(null,arguments)}function M(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}function P(e,t){return(P=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}function D(e){return(D=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function x(e){return new L(e,0)}function F(e){var t,r;function n(t,r){try{var o=e[t](r),a=o.value,s=a instanceof L;Promise.resolve(s?a.v:a).then(function(r){if(s){var l="return"===t?"return":"next";if(!a.k||r.done)return n(l,r);r=e[l](r).value}i(o.done?"return":"normal",r)},function(e){n("throw",e)})}catch(e){i("throw",e)}}function i(e,i){switch(e){case"return":t.resolve({value:i,done:!0});break;case"throw":t.reject(i);break;default:t.resolve({value:i,done:!1})}(t=t.next)?n(t.key,t.arg):r=null}this._invoke=function(e,i){return new Promise(function(o,a){var s={key:e,arg:i,resolve:o,reject:a,next:null};r?r=r.next=s:(t=r=s,n(e,i))})},"function"!=typeof e.return&&(this.return=void 0)}function L(e,t){this.v=e,this.k=t}F.prototype["function"==typeof Symbol&&Symbol.asyncIterator||"@@asyncIterator"]=function(){return this},F.prototype.next=function(e){return this._invoke("next",e)},F.prototype.throw=function(e){return this._invoke("throw",e)},F.prototype.return=function(e){return this._invoke("return",e)};var U=function(e){A(r,e);var t=R(r);function r(e,n){var i;return I(this,r),(i=t.call(this,e)).data=n,i}return w(r)}(k(Error));t.WidgetApiResponseError=U,U.prototype.name=U.name,t.WidgetApi=function(e){A(_,e);var t,r,n,i,g,y=R(_);function _(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(I(this,_),E(C(e=y.call(this)),"transport",void 0),E(C(e),"capabilitiesFinished",!1),E(C(e),"supportsMSC2974Renegotiate",!1),E(C(e),"requestedCapabilities",[]),E(C(e),"approvedCapabilities",void 0),E(C(e),"cachedClientVersions",void 0),E(C(e),"turnServerWatchers",0),!globalThis.parent)throw Error("No parent window. This widget doesn't appear to be embedded properly.");return e.transport=new s.PostmessageTransport(o.WidgetApiDirection.FromWidget,t,globalThis.parent,globalThis),e.transport.targetOrigin=r,e.transport.on("message",e.handleMessage.bind(C(e))),e}return w(_,[{key:"hasCapability",value:function(e){return Array.isArray(this.approvedCapabilities)?this.approvedCapabilities.includes(e):this.requestedCapabilities.includes(e)}},{key:"requestCapability",value:function(e){if(this.capabilitiesFinished&&!this.supportsMSC2974Renegotiate)throw Error("Capabilities have already been negotiated");this.requestedCapabilities.push(e)}},{key:"requestCapabilities",value:function(e){var t,r=function(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return S(e,void 0);var r=Object.prototype.toString.call(e).slice(8,-1);if("Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return S(e,t)}}(e))){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return a=e.done,e},e:function(e){s=!0,o=e},f:function(){try{a||null==r.return||r.return()}finally{if(s)throw o}}}}(e);try{for(r.s();!(t=r.n()).done;){var n=t.value;this.requestCapability(n)}}catch(e){r.e(e)}finally{r.f()}}},{key:"requestCapabilityForRoomTimeline",value:function(e){this.requestCapability("org.matrix.msc2762.timeline:".concat(e))}},{key:"requestCapabilityToSendState",value:function(e,t){this.requestCapability(h.WidgetEventCapability.forStateEvent(h.EventDirection.Send,e,t).raw)}},{key:"requestCapabilityToReceiveState",value:function(e,t){this.requestCapability(h.WidgetEventCapability.forStateEvent(h.EventDirection.Receive,e,t).raw)}},{key:"requestCapabilityToSendToDevice",value:function(e){this.requestCapability(h.WidgetEventCapability.forToDeviceEvent(h.EventDirection.Send,e).raw)}},{key:"requestCapabilityToReceiveToDevice",value:function(e){this.requestCapability(h.WidgetEventCapability.forToDeviceEvent(h.EventDirection.Receive,e).raw)}},{key:"requestCapabilityToSendEvent",value:function(e){this.requestCapability(h.WidgetEventCapability.forRoomEvent(h.EventDirection.Send,e).raw)}},{key:"requestCapabilityToReceiveEvent",value:function(e){this.requestCapability(h.WidgetEventCapability.forRoomEvent(h.EventDirection.Receive,e).raw)}},{key:"requestCapabilityToSendMessage",value:function(e){this.requestCapability(h.WidgetEventCapability.forRoomMessageEvent(h.EventDirection.Send,e).raw)}},{key:"requestCapabilityToReceiveMessage",value:function(e){this.requestCapability(h.WidgetEventCapability.forRoomMessageEvent(h.EventDirection.Receive,e).raw)}},{key:"requestCapabilityToReceiveRoomAccountData",value:function(e){this.requestCapability(h.WidgetEventCapability.forRoomAccountData(h.EventDirection.Receive,e).raw)}},{key:"requestOpenIDConnectToken",value:function(){var e=this;return new Promise(function(t,r){e.transport.sendComplete(l.WidgetApiFromWidgetAction.GetOpenIDCredentials,{}).then(function(n){var i=n.response;i.state===c.OpenIDRequestState.Allowed?t(i):i.state===c.OpenIDRequestState.Blocked?r(Error("User declined to verify their identity")):i.state===c.OpenIDRequestState.PendingUserConfirmation?e.on("action:".concat(l.WidgetApiToWidgetAction.OpenIDCredentials),function o(a){a.preventDefault();var s=a.detail;s.data.original_request_id===n.requestId&&(s.data.state===c.OpenIDRequestState.Allowed?(t(s.data),e.transport.reply(s,{})):s.data.state===c.OpenIDRequestState.Blocked?(r(Error("User declined to verify their identity")),e.transport.reply(s,{})):(r(Error("Invalid state on reply: "+i.state)),e.transport.reply(s,{error:{message:"Invalid state"}})),e.off("action:".concat(l.WidgetApiToWidgetAction.OpenIDCredentials),o))}):r(Error("Invalid state: "+i.state))}).catch(r)})}},{key:"updateRequestedCapabilities",value:function(){return this.transport.send(l.WidgetApiFromWidgetAction.MSC2974RenegotiateCapabilities,{capabilities:this.requestedCapabilities}).then()}},{key:"sendContentLoaded",value:function(){return this.transport.send(l.WidgetApiFromWidgetAction.ContentLoaded,{}).then()}},{key:"sendSticker",value:function(e){return this.transport.send(l.WidgetApiFromWidgetAction.SendSticker,e).then()}},{key:"setAlwaysOnScreen",value:function(e){return this.transport.send(l.WidgetApiFromWidgetAction.UpdateAlwaysOnScreen,{value:e}).then(function(e){return e.success})}},{key:"openModalWidget",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:d.MatrixWidgetType.Custom;return this.transport.send(l.WidgetApiFromWidgetAction.OpenModalWidget,{type:i,url:e,name:t,buttons:r,data:n}).then()}},{key:"closeModalWidget",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.transport.send(l.WidgetApiFromWidgetAction.CloseModalWidget,e).then()}},{key:"sendRoomEvent",value:function(e,t,r,n,i,o){return this.sendEvent(e,void 0,t,r,n,i,o)}},{key:"sendStateEvent",value:function(e,t,r,n,i,o){return this.sendEvent(e,t,r,n,i,o)}},{key:"sendEvent",value:function(e,t,r,n,i,o,a){return this.transport.send(l.WidgetApiFromWidgetAction.SendEvent,b(b(b(b(b({type:e,content:r},void 0!==t&&{state_key:t}),void 0!==n&&{room_id:n}),void 0!==i&&{delay:i}),void 0!==o&&{parent_delay_id:o}),void 0!==a&&{sticky_duration_ms:a}))}},{key:"cancelScheduledDelayedEvent",value:function(e){return this.transport.send(l.WidgetApiFromWidgetAction.MSC4157UpdateDelayedEvent,{delay_id:e,action:p.UpdateDelayedEventAction.Cancel})}},{key:"restartScheduledDelayedEvent",value:function(e){return this.transport.send(l.WidgetApiFromWidgetAction.MSC4157UpdateDelayedEvent,{delay_id:e,action:p.UpdateDelayedEventAction.Restart})}},{key:"sendScheduledDelayedEvent",value:function(e){return this.transport.send(l.WidgetApiFromWidgetAction.MSC4157UpdateDelayedEvent,{delay_id:e,action:p.UpdateDelayedEventAction.Send})}},{key:"sendToDevice",value:function(e,t,r){return this.transport.send(l.WidgetApiFromWidgetAction.SendToDevice,{type:e,encrypted:t,messages:r})}},{key:"readRoomAccountData",value:function(e,t){var r={type:e};return t&&(t.includes(v.Symbols.AnyRoom)?r.room_ids=v.Symbols.AnyRoom:r.room_ids=t),this.transport.send(l.WidgetApiFromWidgetAction.BeeperReadRoomAccountData,r).then(function(e){return e.events})}},{key:"readRoomEvents",value:function(e,t,r,n,i){var o={type:e,msgtype:r};return void 0!==t&&(o.limit=t),n&&(n.includes(v.Symbols.AnyRoom)?o.room_ids=v.Symbols.AnyRoom:o.room_ids=n),i&&(o.since=i),this.transport.send(l.WidgetApiFromWidgetAction.MSC2876ReadEvents,o).then(function(e){return e.events})}},{key:"readEventRelations",value:(t=f(m().mark(function e(t,r,n,i,o,s,c,d){var u;return m().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getClientVersions();case 2:if(e.sent.includes(a.UnstableApiVersion.MSC3869)){e.next=5;break}throw Error("The read_relations action is not supported by the client.");case 5:return u={event_id:t,rel_type:n,event_type:i,room_id:r,to:c,from:s,limit:o,direction:d},e.abrupt("return",this.transport.send(l.WidgetApiFromWidgetAction.MSC3869ReadRelations,u));case 7:case"end":return e.stop()}},e,this)})),function(e,r,n,i,o,a,s,l){return t.apply(this,arguments)})},{key:"readStateEvents",value:function(e,t,r,n){var i={type:e,state_key:void 0===r||r};return void 0!==t&&(i.limit=t),n&&(n.includes(v.Symbols.AnyRoom)?i.room_ids=v.Symbols.AnyRoom:i.room_ids=n),this.transport.send(l.WidgetApiFromWidgetAction.MSC2876ReadEvents,i).then(function(e){return e.events})}},{key:"setModalButtonEnabled",value:function(e,t){if(e===u.BuiltInModalButtonID.Close)throw Error("The close button cannot be disabled");return this.transport.send(l.WidgetApiFromWidgetAction.SetModalButtonEnabled,{button:e,enabled:t}).then()}},{key:"navigateTo",value:function(e){if(!e||!e.startsWith("https://matrix.to/#"))throw Error("Invalid matrix.to URI");return this.transport.send(l.WidgetApiFromWidgetAction.MSC2931Navigate,{uri:e}).then()}},{key:"getTurnServers",value:function(){var e,t=this;return(e=m().mark(function e(){var r,n;return m().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=function(){var e=f(m().mark(function e(n){return m().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n.preventDefault(),r(n.detail.data),t.transport.reply(n.detail,{});case 3:case"end":return e.stop()}},e)}));return function(t){return e.apply(this,arguments)}}(),t.on("action:".concat(l.WidgetApiToWidgetAction.UpdateTurnServers),n),0!==t.turnServerWatchers){e.next=12;break}return e.prev=3,e.next=6,x(t.transport.send(l.WidgetApiFromWidgetAction.WatchTurnServers,{}));case 6:e.next=12;break;case 8:throw e.prev=8,e.t0=e.catch(3),t.off("action:".concat(l.WidgetApiToWidgetAction.UpdateTurnServers),n),e.t0;case 12:t.turnServerWatchers++,e.prev=13;case 14:return e.next=17,x(new Promise(function(e){return r=e}));case 17:return e.next=19,e.sent;case 19:e.next=14;break;case 21:if(e.prev=21,t.off("action:".concat(l.WidgetApiToWidgetAction.UpdateTurnServers),n),t.turnServerWatchers--,0!==t.turnServerWatchers){e.next=27;break}return e.next=27,x(t.transport.send(l.WidgetApiFromWidgetAction.UnwatchTurnServers,{}));case 27:return e.finish(21);case 28:case"end":return e.stop()}},e,null,[[3,8],[13,,21,28]])}),function(){return new F(e.apply(this,arguments))})()}},{key:"searchUserDirectory",value:(r=f(m().mark(function e(t,r){var n;return m().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getClientVersions();case 2:if(e.sent.includes(a.UnstableApiVersion.MSC3973)){e.next=5;break}throw Error("The user_directory_search action is not supported by the client.");case 5:return n={search_term:t,limit:r},e.abrupt("return",this.transport.send(l.WidgetApiFromWidgetAction.MSC3973UserDirectorySearch,n));case 7:case"end":return e.stop()}},e,this)})),function(e,t){return r.apply(this,arguments)})},{key:"getMediaConfig",value:(n=f(m().mark(function e(){var t;return m().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getClientVersions();case 2:if(e.sent.includes(a.UnstableApiVersion.MSC4039)){e.next=5;break}throw Error("The get_media_config action is not supported by the client.");case 5:return t={},e.abrupt("return",this.transport.send(l.WidgetApiFromWidgetAction.MSC4039GetMediaConfigAction,t));case 7:case"end":return e.stop()}},e,this)})),function(){return n.apply(this,arguments)})},{key:"uploadFile",value:(i=f(m().mark(function e(t){var r;return m().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getClientVersions();case 2:if(e.sent.includes(a.UnstableApiVersion.MSC4039)){e.next=5;break}throw Error("The upload_file action is not supported by the client.");case 5:return r={file:t},e.abrupt("return",this.transport.send(l.WidgetApiFromWidgetAction.MSC4039UploadFileAction,r));case 7:case"end":return e.stop()}},e,this)})),function(e){return i.apply(this,arguments)})},{key:"downloadFile",value:(g=f(m().mark(function e(t){var r;return m().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getClientVersions();case 2:if(e.sent.includes(a.UnstableApiVersion.MSC4039)){e.next=5;break}throw Error("The download_file action is not supported by the client.");case 5:return r={content_uri:t},e.abrupt("return",this.transport.send(l.WidgetApiFromWidgetAction.MSC4039DownloadFileAction,r));case 7:case"end":return e.stop()}},e,this)})),function(e){return g.apply(this,arguments)})},{key:"start",value:function(){var e=this;this.transport.start(),this.getClientVersions().then(function(t){t.includes(a.UnstableApiVersion.MSC2974)&&(e.supportsMSC2974Renegotiate=!0)})}},{key:"handleMessage",value:function(e){var t=new CustomEvent("action:".concat(e.detail.action),{detail:e.detail,cancelable:!0});if(this.emit("action:".concat(e.detail.action),t),!t.defaultPrevented)switch(e.detail.action){case l.WidgetApiToWidgetAction.SupportedApiVersions:return this.replyVersions(e.detail);case l.WidgetApiToWidgetAction.Capabilities:return this.handleCapabilities(e.detail);case l.WidgetApiToWidgetAction.UpdateVisibility:case l.WidgetApiToWidgetAction.NotifyCapabilities:return this.transport.reply(e.detail,{});default:return this.transport.reply(e.detail,{error:{message:"Unknown or unsupported to-widget action: "+e.detail.action}})}}},{key:"replyVersions",value:function(e){this.transport.reply(e,{supported_versions:a.CurrentApiVersions})}},{key:"getClientVersions",value:function(){var e=this;return Array.isArray(this.cachedClientVersions)?Promise.resolve(this.cachedClientVersions):this.transport.send(l.WidgetApiFromWidgetAction.SupportedApiVersions,{}).then(function(t){return e.cachedClientVersions=t.supported_versions,t.supported_versions}).catch(function(e){return console.warn("non-fatal error getting supported client versions: ",e),[]})}},{key:"handleCapabilities",value:function(e){var t=this;return this.capabilitiesFinished?this.transport.reply(e,{error:{message:"Capability negotiation already completed"}}):this.getClientVersions().then(function(r){return r.includes(a.UnstableApiVersion.MSC2871)?t.once("action:".concat(l.WidgetApiToWidgetAction.NotifyCapabilities),function(e){t.approvedCapabilities=e.detail.data.approved,t.emit("ready")}):t.emit("ready"),t.capabilitiesFinished=!0,t.transport.reply(e,{capabilities:t.requestedCapabilities})})}}]),_}(i.EventEmitter)},17502:(e,t)=>{"use strict";var r=/; *([!#$%&'*+.^_`|~0-9A-Za-z-]+) *= *("(?:[\u000b\u0020\u0021\u0023-\u005b\u005d-\u007e\u0080-\u00ff]|\\[\u000b\u0020-\u00ff])*"|[!#$%&'*+.^_`|~0-9A-Za-z-]+) */g,n=/\\([\u000b\u0020-\u00ff])/g,i=/^[!#$%&'*+.^_`|~0-9A-Za-z-]+\/[!#$%&'*+.^_`|~0-9A-Za-z-]+$/;function o(e){this.parameters=Object.create(null),this.type=e}t.q=function(e){if(!e)throw TypeError("argument string is required");var t,a,s,l="object"==typeof e?function(e){var t;if("function"==typeof e.getHeader?t=e.getHeader("content-type"):"object"==typeof e.headers&&(t=e.headers&&e.headers["content-type"]),"string"!=typeof t)throw TypeError("content-type header is missing from object");return t}(e):e;if("string"!=typeof l)throw TypeError("argument string is required to be a string");var c=l.indexOf(";"),d=-1!==c?l.slice(0,c).trim():l.trim();if(!i.test(d))throw TypeError("invalid media type");var u=new o(d.toLowerCase());if(-1!==c){for(r.lastIndex=c;a=r.exec(l);){if(a.index!==c)throw TypeError("invalid parameter format");c+=a[0].length,t=a[1].toLowerCase(),34===(s=a[2]).charCodeAt(0)&&-1!==(s=s.slice(1,-1)).indexOf("\\")&&(s=s.replace(n,"$1")),u.parameters[t]=s}if(c!==l.length)throw TypeError("invalid parameter format")}return u}},17719:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WidgetParser=void 0;var n=r(60484),i=r(50533);function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function a(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}t.WidgetParser=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"parseAccountData",value:function(e){if(!e)return[];for(var r=[],n=0,i=Object.keys(e);n<i.length;n++){var o=i[n],a=e[o];if(a&&("m.widget"===a.type||"im.vector.modular.widgets"===a.type)&&a.sender&&(a.state_key||a.id)===o){var s={content:a.content,sender:a.sender,type:"m.widget",state_key:o,event_id:"$example",room_id:"!example",origin_server_ts:1},l=t.parseRoomWidget(s);l&&r.push(l)}}return r}},{key:"parseWidgetsFromRoomState",value:function(e){if(!e)return[];var r,n=[],i=function(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return a(e,void 0);var r=Object.prototype.toString.call(e).slice(8,-1);if("Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return a(e,t)}}(e))){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,l=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return s=e.done,e},e:function(e){l=!0,o=e},f:function(){try{s||null==r.return||r.return()}finally{if(l)throw o}}}}(e);try{for(i.s();!(r=i.n()).done;){var o=r.value,s=t.parseRoomWidget(o);s&&n.push(s)}}catch(e){i.e(e)}finally{i.f()}return n}},{key:"parseRoomWidget",value:function(e){if(!e||"m.widget"!==e.type&&"im.vector.modular.widgets"!==e.type)return null;var r=e.content||{},n={id:e.state_key,creatorUserId:r.creatorUserId||e.sender,name:r.name,type:r.type,url:r.url,waitForIframeLoad:r.waitForIframeLoad,data:r.data};return t.processEstimatedWidget(n)}},{key:"processEstimatedWidget",value:function(e){return e.id&&e.creatorUserId&&e.type&&(0,i.isValidUrl)(e.url)?new n.Widget(e):null}}],function(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,function(e){var t=function(e,t){if("object"!==o(e)||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,t||"default");if("object"!==o(n))return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"===o(t)?t:String(t)}(n.key),n)}}(t,e),Object.defineProperty(t,"prototype",{writable:!1}),t}()},17797:(e,t,r)=>{"use strict";r.d(t,{s:()=>n});var n=new(r(81626)).xu("m.topic")},17852:(e,t,r)=>{var n=function(e){return String(Number(e))===e?Number(e):e},i=function(e,t,r,i){if(i&&!r)t[i]=n(e[1]);else for(var o=0;o<r.length;o+=1)null!=e[o+1]&&(t[r[o]]=n(e[o+1]))},o=function(e,t,r){var n=e.name&&e.names;e.push&&!t[e.push]?t[e.push]=[]:n&&!t[e.name]&&(t[e.name]={});var o=e.push?{}:n?t[e.name]:t;i(r.match(e.reg),o,e.names,e.name),e.push&&t[e.push].push(o)},a=r(26600),s=RegExp.prototype.test.bind(/^([a-z])=(.*)/);t.parse=function(e){var t={},r=[],n=t;return e.split(/(\r\n|\r|\n)/).filter(s).forEach(function(e){var t=e[0],i=e.slice(2);"m"===t&&(r.push({rtp:[],fmtp:[]}),n=r[r.length-1]);for(var s=0;s<(a[t]||[]).length;s+=1){var l=a[t][s];if(l.reg.test(i))return o(l,n,i)}}),t.media=r,t};var l=function(e,t){var r=t.split(/=(.+)/,2);return 2===r.length?e[r[0]]=n(r[1]):1===r.length&&t.length>1&&(e[r[0]]=void 0),e};t.parseParams=function(e){return e.split(/;\s?/).reduce(l,{})},t.parseFmtpConfig=t.parseParams,t.parsePayloads=function(e){return e.toString().split(" ").map(Number)},t.parseRemoteCandidates=function(e){for(var t=[],r=e.split(" ").map(n),i=0;i<r.length;i+=3)t.push({component:r[i],ip:r[i+1],port:r[i+2]});return t},t.parseImageAttributes=function(e){return e.split(" ").map(function(e){return e.substring(1,e.length-1).split(",").reduce(l,{})})},t.parseSimulcastStreamList=function(e){return e.split(";").map(function(e){return e.split(",").map(function(e){var t,r=!1;return"~"!==e[0]?t=n(e):(t=n(e.substring(1,e.length)),r=!0),{scid:t,paused:r}})})}},19187:(e,t,r)=>{"use strict";r.d(t,{bp:()=>p});var n=r(29301),i=r(12411),o=r(84656),a=r(11749),s=r(9086),l=r(19599),c=new l.UnstableValue("m.policies","org.matrix.msc3847.policies"),d=new l.UnstableValue("m.ignore.invites","org.matrix.msc3847.ignore.invites"),u=function(e){return e.Ban="m.ban",e}({}),h=function(e){return e.User="m.policy.user",e.Room="m.policy.room",e.Server="m.policy.server",e}({}),v={[h.User]:s.Bx.PolicyRuleUser,[h.Room]:s.Bx.PolicyRuleRoom,[h.Server]:s.Bx.PolicyRuleServer};class p{constructor(e){this.client=e}addRule(e,t,r){var i=this;return(0,n.A)(function*(){var n=yield i.getOrCreateTargetRoom();return(yield i.client.sendStateEvent(n.roomId,v[e],{entity:t,reason:r,recommendation:u.Ban})).event_id})()}removeRule(e){var t=this;return(0,n.A)(function*(){yield t.client.redactEvent(e.getRoomId(),e.getId())})()}addSource(e){var t=this;return(0,n.A)(function*(){yield t.client.joinRoom(e);var r=(yield t.getOrCreateSourceRooms()).map(e=>e.roomId);return!r.includes(e)&&(r.push(e),yield t.withIgnoreInvitesPolicies(e=>{e.sources=r}),!0)})()}getRuleForInvite(e){var t=this;return(0,n.A)(function*(){var{sender:r,roomId:n}=e,o=yield t.getOrCreateSourceRooms(),s=r.split(":")[1],l=n.split(":")[1];for(var c of o){var d=c.getUnfilteredTimelineSet().getLiveTimeline().getState(i.q.FORWARDS);for(var{scope:p,entities:m}of[{scope:h.Room,entities:[n]},{scope:h.User,entities:[r]},{scope:h.Server,entities:[s,l]}])for(var g of d.getStateEvents(v[p])){var f=g.getContent();if((null==f?void 0:f.recommendation)==u.Ban){var y=null==f?void 0:f.entity;if(y){var b=void 0;try{b=new RegExp((0,a.dn)(y))}catch(e){continue}for(var S of m)if(S&&b.test(S))return g}}}}return null})()}getOrCreateTargetRoom(){var e=this;return(0,n.A)(function*(){var t=e.getIgnoreInvitesPolicies().target;if("string"!=typeof t&&(t=null),t){var r=e.client.getRoom(t);if(r)return r;t=null}return t=(yield e.client.createRoom({name:"Individual Policy Room",preset:o.k.PrivateChat})).room_id,yield e.withIgnoreInvitesPolicies(e=>{e.target=t}),e.client.getRoom(t)})()}getOrCreateSourceRooms(){var e=this;return(0,n.A)(function*(){var t=e.getIgnoreInvitesPolicies().sources,r=!1;Array.isArray(t)||(r=!0,t=[]);var n=t.filter(e=>"string"==typeof e).map(t=>e.client.getRoom(t)).filter(e=>!!e);return n.length!=t.length&&(r=!0),0==n.length&&(r=!0,n=[(yield e.getOrCreateTargetRoom())]),r&&(yield e.withIgnoreInvitesPolicies(e=>{e.sources=t})),n})()}getIgnoreInvitesPolicies(){return this.getPoliciesAndIgnoreInvitesPolicies().ignoreInvitesPolicies}withIgnoreInvitesPolicies(e){var t=this;return(0,n.A)(function*(){var{policies:r,ignoreInvitesPolicies:n}=t.getPoliciesAndIgnoreInvitesPolicies();e(n),r[d.name]=n,yield t.client.setAccountData(c.name,r)})()}getPoliciesAndIgnoreInvitesPolicies(){var e={};for(var t of[c.name,c.altName])if(t){var r,n=null==(r=this.client.getAccountData(t))?void 0:r.getContent();if(n){e=n;break}}var i={},o=!1;for(var a of[d.name,d.altName])if(a){var s=e[a];if(s&&"object"==typeof s){i=s,o=!0;break}}return o||(e[d.name]=i),{policies:e,ignoreInvitesPolicies:i}}}},19599:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(97709);Object.keys(n).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===n[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return n[e]}}))});var i=r(75539);Object.keys(i).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===i[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return i[e]}}))});var o=r(66866);Object.keys(o).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===o[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return o[e]}}))});var a=r(10393);Object.keys(a).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===a[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return a[e]}}))});var s=r(31642);Object.keys(s).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===s[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return s[e]}}))});var l=r(17242);Object.keys(l).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===l[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return l[e]}}))});var c=r(60632);Object.keys(c).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===c[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return c[e]}}))});var d=r(52337);Object.keys(d).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===d[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return d[e]}}))});var u=r(80646);Object.keys(u).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===u[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return u[e]}}))});var h=r(50703);Object.keys(h).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===h[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return h[e]}}))});var v=r(52621);Object.keys(v).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===v[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return v[e]}}))});var p=r(98973);Object.keys(p).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===p[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return p[e]}}))});var m=r(78272);Object.keys(m).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===m[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return m[e]}}))});var g=r(47406);Object.keys(g).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===g[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return g[e]}}))});var f=r(62404);Object.keys(f).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===f[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return f[e]}}))});var y=r(98597);Object.keys(y).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===y[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return y[e]}}))});var b=r(57023);Object.keys(b).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===b[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return b[e]}}))});var S=r(77990);Object.keys(S).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===S[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return S[e]}}))});var E=r(79404);Object.keys(E).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===E[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return E[e]}}))});var _=r(55489);Object.keys(_).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===_[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return _[e]}}))});var w=r(7347);Object.keys(w).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===w[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return w[e]}}))})},19833:(e,t,r)=>{"use strict";r.d(t,{a:()=>n});var n=new(r(81626)).M6("unread_thread_notifications","org.matrix.msc3773.unread_thread_notifications")},20213:(e,t,r)=>{"use strict";r.r(t),r.d(t,{getTextForLocationEvent:()=>g,makeBeaconContent:()=>w,makeBeaconInfoContent:()=>E,makeEmoteMessage:()=>m,makeHtmlEmote:()=>h,makeHtmlMessage:()=>d,makeHtmlNotice:()=>u,makeLocationContent:()=>f,makeNotice:()=>p,makeTextMessage:()=>v,makeTopicContent:()=>b,parseBeaconContent:()=>T,parseBeaconInfoContent:()=>_,parseLocationEvent:()=>y,parseTopicContent:()=>S});var n=r(84458),i=r(9086),o=r(68401),a=r(22993),s=r(8221),l=r(17797);function c(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function d(e,t){return{msgtype:i.Wr.Text,format:"org.matrix.custom.html",body:e,formatted_body:t}}function u(e,t){return{msgtype:i.Wr.Notice,format:"org.matrix.custom.html",body:e,formatted_body:t}}function h(e,t){return{msgtype:i.Wr.Emote,format:"org.matrix.custom.html",body:e,formatted_body:t}}function v(e){return{msgtype:i.Wr.Text,body:e}}function p(e){return{msgtype:i.Wr.Notice,body:e}}function m(e){return{msgtype:i.Wr.Emote,body:e}}var g=(e,t,r,n)=>{var i="at ".concat(new Date(r).toISOString());return[t===s.Yg.Self?"User":void 0,"Location",n?'"'.concat(n,'"'):void 0,e,i].filter(Boolean).join(" ")},f=(e,t,r,a,l)=>{var d=null!=e?e:g(t,l||s.Yg.Self,r,a),u=r?{[s.vo.name]:r}:{};return function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?c(Object(r),!0).forEach(function(t){(0,n.A)(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):c(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}({msgtype:i.Wr.Location,body:d,geo_uri:t,[s.M6.name]:{description:a,uri:t},[s.J1.name]:{type:l||s.Yg.Self},[o.yB.name]:d},u)},y=e=>{var t,r,n=s.M6.findIn(e),i=s.J1.findIn(e),a=s.vo.findIn(e),l=o.yB.findIn(e),c=null!=(t=null==n?void 0:n.uri)?t:null==e?void 0:e.geo_uri,d=null==n?void 0:n.description,u=null!=(r=null==i?void 0:i.type)?r:s.Yg.Self;return f(null!=l?l:e.body,c,null!=a?a:void 0,d,u)},b=(e,t)=>{var r=[];return(0,a.c)(t)&&r.push({body:t,mimetype:"text/html"}),(0,a.c)(e)&&r.push({body:e,mimetype:"text/plain"}),{topic:e,[l.s.name]:{"m.text":r}}},S=e=>{var t,r,n,i,o,s=l.s.findIn(e),c=Array.isArray(s)?s:null==s?void 0:s["m.text"];return Array.isArray(c)?{text:null!=(t=null!=(r=null==c||null==(n=c.find(e=>!(0,a.c)(e.mimetype)||"text/plain"===e.mimetype))?void 0:n.body)?r:e.topic)?t:void 0,html:null==c||null==(i=c.find(e=>"text/html"===e.mimetype))?void 0:i.body}:{text:null!=(o=e.topic)?o:void 0}},E=(e,t,r,n,i)=>({description:r,timeout:e,live:t,[s.vo.name]:i||Date.now(),[s.J1.name]:{type:null!=n?n:s.Yg.Self}}),_=e=>{var t,{description:r,timeout:n,live:i}=e,o=null!=(t=s.vo.findIn(e))?t:void 0,a=s.J1.findIn(e);return{description:r,timeout:n,live:i,assetType:null==a?void 0:a.type,timestamp:o}},w=(e,t,r,n)=>({[s.M6.name]:{description:n,uri:e},[s.vo.name]:t,"m.relates_to":{rel_type:o.BJ.name,event_id:r}}),T=e=>{var t,r=s.M6.findIn(e),n=null!=(t=s.vo.findIn(e))?t:void 0;return{description:null==r?void 0:r.description,uri:null==r?void 0:r.uri,timestamp:n}}},20748:(e,t,r)=>{"use strict";r.d(t,{s:()=>i});var n=r(29301);function i(e){return o.apply(this,arguments)}function o(){return(o=(0,n.A)(function*(e){if(!globalThis.crypto.subtle)throw Error("Crypto.subtle is not available: insecure context?");var t=new TextEncoder().encode(e);return new Uint8Array((yield globalThis.crypto.subtle.digest("SHA-256",t)))})).apply(this,arguments)}},21401:(e,t,r)=>{"use strict";r.d(t,{q:()=>a});var n=r(84458),i=r(12411);class o{constructor(e){this.ourEvent=e,(0,n.A)(this,"timeline",void 0),(0,n.A)(this,"ourEventIndex",0),(0,n.A)(this,"paginateTokens",{[i.O.Backward]:null,[i.O.Forward]:null}),this.timeline=[e]}getEvent(){return this.timeline[this.ourEventIndex]}getTimeline(){return this.timeline}getOurEventIndex(){return this.ourEventIndex}getPaginateToken(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return this.paginateTokens[e?i.O.Backward:i.O.Forward]}setPaginateToken(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.paginateTokens[t?i.O.Backward:i.O.Forward]=null!=e?e:null}addEvents(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];t?(this.timeline=e.concat(this.timeline),this.ourEventIndex+=e.length):this.timeline=this.timeline.concat(e)}}class a{static fromJson(e,t){var r=e.context||{},n=(r.events_before||[]).map(t),i=(r.events_after||[]).map(t),s=new o(t(e.result)),l=s.ourEvent.threadRootId;return n=n.filter(e=>e.threadRootId===l),i=i.filter(e=>e.threadRootId===l),s.setPaginateToken(r.start,!0),s.addEvents(n,!0),s.addEvents(i,!1),s.setPaginateToken(r.end,!1),new a(e.rank,s)}constructor(e,t){this.rank=e,this.context=t}}},22993:(e,t,r)=>{"use strict";function n(e){return null!=e}r.d(t,{c:()=>n})},24302:(e,t,r)=>{"use strict";function n(e,t){if(null==e)return{};var r,n,i=function(e,t){if(null==e)return{};var r={};for(var n in e)if(({}).hasOwnProperty.call(e,n)){if(-1!==t.indexOf(n))continue;r[n]=e[n]}return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)r=o[n],-1===t.indexOf(r)&&({}).propertyIsEnumerable.call(e,r)&&(i[r]=e[r])}return i}r.d(t,{A:()=>n})},24673:(e,t,r)=>{"use strict";r.d(t,{lc:()=>a,Ay:()=>c});let n=Object.prototype.toString,i=new Set(["network error","Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed","fetch failed","terminated"," A network error occurred.","Network connection lost"]);function o(e,t,{min:r=0,allowInfinity:n=!1}={}){if(void 0!==t){if("number"!=typeof t||Number.isNaN(t))throw TypeError(`Expected \`${e}\` to be a number${n?" or Infinity":""}.`);if(!n&&!Number.isFinite(t))throw TypeError(`Expected \`${e}\` to be a finite number.`);if(t<r)throw TypeError(`Expected \`${e}\` to be \u2265 ${r}.`)}}class a extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,{message:e}=e):(this.originalError=Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}function s(e,t){return Number.isFinite(t)?t-(performance.now()-e):t}async function l({error:e,attemptNumber:t,retriesConsumed:r,startTime:o,options:l}){let c=e instanceof Error?e:TypeError(`Non-error was thrown: "${e}". You should only throw errors.`);if(c instanceof a)throw c.originalError;let d=Number.isFinite(l.retries)?Math.max(0,l.retries-r):l.retries,u=l.maxRetryTime??1/0,h=Object.freeze({error:c,attemptNumber:t,retriesLeft:d,retriesConsumed:r});if(await l.onFailedAttempt(h),0>=s(o,u))throw c;let v=await l.shouldConsumeRetry(h),p=s(o,u);if(p<=0||d<=0)throw c;if(c instanceof TypeError&&!function(e){if(!(e&&"[object Error]"===n.call(e)&&"TypeError"===e.name&&"string"==typeof e.message))return!1;let{message:t,stack:r}=e;return"Load failed"===t?void 0===r||"__sentry_captured__"in e:!!t.startsWith("error sending request for url")||i.has(t)}(c)){if(v)throw c;return l.signal?.throwIfAborted(),!1}if(!await l.shouldRetry(h))throw c;if(!v)return l.signal?.throwIfAborted(),!1;let m=Math.min(function(e,t){let r=Math.max(1,e+1),n=Math.round((t.randomize?Math.random()+1:1)*t.minTimeout*t.factor**(r-1));return Math.min(n,t.maxTimeout)}(r,l),p);return l.signal?.throwIfAborted(),m>0&&await new Promise((e,t)=>{let r=()=>{clearTimeout(n),l.signal?.removeEventListener("abort",r),t(l.signal.reason)},n=setTimeout(()=>{l.signal?.removeEventListener("abort",r),e()},m);l.unref&&n.unref?.(),l.signal?.addEventListener("abort",r,{once:!0})}),l.signal?.throwIfAborted(),!0}async function c(e,t={}){var r=(t={...t}).retries;if("number"==typeof r){if(r<0)throw TypeError("Expected `retries` to be a non-negative number.");if(Number.isNaN(r))throw TypeError("Expected `retries` to be a valid number or Infinity, got NaN.")}else if(void 0!==r)throw TypeError("Expected `retries` to be a number or Infinity.");if(Object.hasOwn(t,"forever"))throw Error("The `forever` option is no longer supported. For many use-cases, you can set `retries: Infinity` instead.");t.retries??=10,t.factor??=2,t.minTimeout??=1e3,t.maxTimeout??=1/0,t.maxRetryTime??=1/0,t.randomize??=!1,t.onFailedAttempt??=()=>{},t.shouldRetry??=()=>!0,t.shouldConsumeRetry??=()=>!0,o("factor",t.factor,{min:0,allowInfinity:!1}),o("minTimeout",t.minTimeout,{min:0,allowInfinity:!1}),o("maxTimeout",t.maxTimeout,{min:0,allowInfinity:!0}),o("maxRetryTime",t.maxRetryTime,{min:0,allowInfinity:!0}),t.factor>0||(t.factor=1),t.signal?.throwIfAborted();let n=0,i=0,a=performance.now();for(;!Number.isFinite(t.retries)||i<=t.retries;){n++;try{t.signal?.throwIfAborted();let r=await e(n);return t.signal?.throwIfAborted(),r}catch(e){await l({error:e,attemptNumber:n,retriesConsumed:i,startTime:a,options:t})&&i++}}throw Error("Retry attempts exhausted without throwing an error.")}},25097:(e,t,r)=>{"use strict";let n;r.d(t,{QO:()=>A,RA:()=>O,Il:()=>k,$E:()=>C,iP:()=>T,sv:()=>L,WE:()=>M,ms:()=>x,sj:()=>F});var i=r(29301),o=r(84458);let a={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)},s=new Uint8Array(16),l=[];for(let e=0;e<256;++e)l.push((e+256).toString(16).slice(1));let c=function(e,t,r){if(a.randomUUID&&!t&&!e)return a.randomUUID();var i=e,o=r;let c=(i=i||{}).random??i.rng?.()??function(){if(!n){if("undefined"==typeof crypto||!crypto.getRandomValues)throw Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");n=crypto.getRandomValues.bind(crypto)}return n(s)}();if(c.length<16)throw Error("Random bytes length must be >= 16");if(c[6]=15&c[6]|64,c[8]=63&c[8]|128,t){if((o=o||0)<0||o+16>t.length)throw RangeError(`UUID byte range ${o}:${o+15} is out of buffer bounds`);for(let e=0;e<16;++e)t[o+e]=c[e];return t}return function(e,t=0){return(l[e[t+0]]+l[e[t+1]]+l[e[t+2]]+l[e[t+3]]+"-"+l[e[t+4]]+l[e[t+5]]+"-"+l[e[t+6]]+l[e[t+7]]+"-"+l[e[t+8]]+l[e[t+9]]+"-"+l[e[t+10]]+l[e[t+11]]+l[e[t+12]]+l[e[t+13]]+l[e[t+14]]+l[e[t+15]]).toLowerCase()}(c)};var d=r(47105),u=r(5408),h=r(11749),v=r(9086),p=r(5862),m=r(69007),g=r(4002),f=r(15095),y=r(90426),b=r(36963);function S(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function E(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?S(Object(r),!0).forEach(function(t){(0,o.A)(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):S(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}var _=function(e){return e.AUDIO="audio",e.VIDEO="video",e}(_||{}),w=function(e){return e.OPUS="opus",e}(w||{}),T=function(e){return e.Fledgling="fledgling",e.InviteSent="invite_sent",e.WaitLocalMedia="wait_local_media",e.CreateOffer="create_offer",e.CreateAnswer="create_answer",e.Connecting="connecting",e.Connected="connected",e.Ringing="ringing",e.Ended="ended",e}({}),I=function(e){return e.Voice="voice",e.Video="video",e}({}),A=function(e){return e.Inbound="inbound",e.Outbound="outbound",e}({}),R=function(e){return e.Local="local",e.Remote="remote",e}({}),C=function(e){return e.Hangup="hangup",e.State="state",e.Error="error",e.Replaced="replaced",e.LocalHoldUnhold="local_hold_unhold",e.RemoteHoldUnhold="remote_hold_unhold",e.HoldUnhold="hold_unhold",e.FeedsChanged="feeds_changed",e.AssertedIdentityChanged="asserted_identity_changed",e.LengthChanged="length_changed",e.DataChannel="datachannel",e.SendVoipEvent="send_voip_event",e.PeerConnectionCreated="peer_connection_created",e}({}),k=function(e){return e.UserHangup="user_hangup",e.LocalOfferFailed="local_offer_failed",e.NoUserMedia="no_user_media",e.UnknownDevices="unknown_devices",e.SendInvite="send_invite",e.CreateAnswer="create_answer",e.CreateOffer="create_offer",e.SendAnswer="send_answer",e.SetRemoteDescription="set_remote_description",e.SetLocalDescription="set_local_description",e.AnsweredElsewhere="answered_elsewhere",e.IceFailed="ice_failed",e.InviteTimeout="invite_timeout",e.Replaced="replaced",e.SignallingFailed="signalling_timeout",e.UserBusy="user_busy",e.Transferred="transferred",e.NewSession="new_session",e}({});class O extends Error{constructor(e,t,r){super(t+": "+r),(0,o.A)(this,"code",void 0),this.code=e}}function M(){return Date.now().toString()+(0,p.US)(16)}function P(e){return[{mediaType:"audio",codec:"opus",enableDtx:!0,maxAverageBitrate:e?12e3:void 0}]}class D extends f.X{constructor(e){var t,r;if(super(),t=this,(0,o.A)(this,"roomId",void 0),(0,o.A)(this,"callId",void 0),(0,o.A)(this,"invitee",void 0),(0,o.A)(this,"hangupParty",void 0),(0,o.A)(this,"hangupReason",void 0),(0,o.A)(this,"direction",void 0),(0,o.A)(this,"ourPartyId",void 0),(0,o.A)(this,"peerConn",void 0),(0,o.A)(this,"toDeviceSeq",0),(0,o.A)(this,"isPtt",!1),(0,o.A)(this,"_state",T.Fledgling),(0,o.A)(this,"client",void 0),(0,o.A)(this,"forceTURN",void 0),(0,o.A)(this,"turnServers",void 0),(0,o.A)(this,"candidateSendQueue",[]),(0,o.A)(this,"candidateSendTries",0),(0,o.A)(this,"candidatesEnded",!1),(0,o.A)(this,"feeds",[]),(0,o.A)(this,"transceivers",new Map),(0,o.A)(this,"inviteOrAnswerSent",!1),(0,o.A)(this,"waitForLocalAVStream",!1),(0,o.A)(this,"successor",void 0),(0,o.A)(this,"opponentMember",void 0),(0,o.A)(this,"opponentVersion",void 0),(0,o.A)(this,"opponentPartyId",void 0),(0,o.A)(this,"opponentCaps",void 0),(0,o.A)(this,"iceDisconnectedTimeout",void 0),(0,o.A)(this,"iceReconnectionTimeOut",void 0),(0,o.A)(this,"inviteTimeout",void 0),(0,o.A)(this,"removeTrackListeners",new Map),(0,o.A)(this,"remoteOnHold",!1),(0,o.A)(this,"callStatsAtEnd",void 0),(0,o.A)(this,"makingOffer",!1),(0,o.A)(this,"ignoreOffer",!1),(0,o.A)(this,"isSettingRemoteAnswerPending",!1),(0,o.A)(this,"responsePromiseChain",void 0),(0,o.A)(this,"remoteCandidateBuffer",new Map),(0,o.A)(this,"remoteAssertedIdentity",void 0),(0,o.A)(this,"remoteSDPStreamMetadata",void 0),(0,o.A)(this,"callLengthInterval",void 0),(0,o.A)(this,"callStartTime",void 0),(0,o.A)(this,"opponentDeviceId",void 0),(0,o.A)(this,"hasOpponentDeviceInfo",void 0),(0,o.A)(this,"opponentSessionId",void 0),(0,o.A)(this,"groupCallId",void 0),(0,o.A)(this,"stopVideoTrackTimer",void 0),(0,o.A)(this,"isOnlyDataChannelAllowed",void 0),(0,o.A)(this,"stats",void 0),(0,o.A)(this,"gotLocalIceCandidate",e=>{e.candidate&&(this.candidatesEnded&&u.vF.warn("Call ".concat(this.callId," gotLocalIceCandidate() got candidate after candidates have ended!")),u.vF.debug("Call ".concat(this.callId," got local ICE ").concat(e.candidate.sdpMid," ").concat(e.candidate.candidate)),this.callHasEnded()||(""===e.candidate.candidate?this.queueCandidate(null):this.queueCandidate(e.candidate)))}),(0,o.A)(this,"onIceGatheringStateChange",e=>{var t;u.vF.debug("Call ".concat(this.callId," onIceGatheringStateChange() ice gathering state changed to ").concat(this.peerConn.iceGatheringState)),(null==(t=this.peerConn)?void 0:t.iceGatheringState)==="complete"&&(this.queueCandidate(null),u.vF.debug("Call ".concat(this.callId," onIceGatheringStateChange() ice gathering state complete, set candidates have ended")))}),(0,o.A)(this,"getLocalOfferFailed",e=>{u.vF.error("Call ".concat(this.callId," getLocalOfferFailed() running"),e),this.emit(C.Error,new O(k.LocalOfferFailed,"Failed to get local offer!",e),this),this.terminate(R.Local,k.LocalOfferFailed,!1)}),(0,o.A)(this,"getUserMediaFailed",e=>{if(this.successor)return void this.successor.getUserMediaFailed(e);u.vF.warn("Call ".concat(this.callId," getUserMediaFailed() failed to get user media - ending call"),e),this.emit(C.Error,new O(k.NoUserMedia,"Couldn't start capturing media! Is your microphone set up and does this app have permission?",e),this),this.terminate(R.Local,k.NoUserMedia,!1)}),(0,o.A)(this,"placeCallFailed",e=>{if(this.successor)return void this.successor.placeCallFailed(e);u.vF.warn("Call ".concat(this.callId," placeCallWithCallFeeds() failed - ending call"),e),this.emit(C.Error,new O(k.IceFailed,"Couldn't start call! Invalid ICE server configuration.",e),this),this.terminate(R.Local,k.IceFailed,!1)}),(0,o.A)(this,"onIceConnectionStateChanged",()=>{var e,t,r,n,i,o,a,s;if(!this.callHasEnded()&&(u.vF.debug("Call ".concat(this.callId," onIceConnectionStateChanged() running (state=").concat(null==(e=this.peerConn)?void 0:e.iceConnectionState,", conn=").concat(null==(t=this.peerConn)?void 0:t.connectionState,")")),["connected","completed"].includes(null!=(r=null==(n=this.peerConn)?void 0:n.iceConnectionState)?r:"")?(clearTimeout(this.iceDisconnectedTimeout),this.iceDisconnectedTimeout=void 0,this.iceReconnectionTimeOut&&clearTimeout(this.iceReconnectionTimeOut),this.state=T.Connected,this.callLengthInterval||this.callStartTime||(this.callStartTime=Date.now(),this.callLengthInterval=setInterval(()=>{this.emit(C.LengthChanged,Math.round((Date.now()-this.callStartTime)/1e3),this)},1e3))):(null==(i=this.peerConn)?void 0:i.iceConnectionState)=="failed"?(this.candidatesEnded=!1,null!=(a=this.peerConn)&&a.restartIce?(this.candidatesEnded=!1,u.vF.debug("Call ".concat(this.callId," onIceConnectionStateChanged() ice restart (state=").concat(null==(s=this.peerConn)?void 0:s.iceConnectionState,")")),this.peerConn.restartIce()):(u.vF.info("Call ".concat(this.callId," onIceConnectionStateChanged() hanging up call (ICE failed and no ICE restart method)")),this.hangup(k.IceFailed,!1))):(null==(o=this.peerConn)?void 0:o.iceConnectionState)=="disconnected"&&(this.candidatesEnded=!1,this.iceReconnectionTimeOut=setTimeout(()=>{var e,t,r;u.vF.info("Call ".concat(this.callId," onIceConnectionStateChanged() ICE restarting because of ICE disconnected, (state=").concat(null==(e=this.peerConn)?void 0:e.iceConnectionState,", conn=").concat(null==(t=this.peerConn)?void 0:t.connectionState,")")),null!=(r=this.peerConn)&&r.restartIce&&(this.candidatesEnded=!1,this.peerConn.restartIce()),this.iceReconnectionTimeOut=void 0},2e3),this.iceDisconnectedTimeout=setTimeout(()=>{u.vF.info("Call ".concat(this.callId," onIceConnectionStateChanged() hanging up call (ICE disconnected for too long)")),this.hangup(k.IceFailed,!1)},3e4),this.state=T.Connecting),this.isPtt&&["failed","disconnected"].includes(this.peerConn.iceConnectionState)))for(var l of this.getRemoteFeeds())l.setAudioVideoMuted(!0,!0)}),(0,o.A)(this,"onSignallingStateChanged",()=>{var e;u.vF.debug("Call ".concat(this.callId," onSignallingStateChanged() running (state=").concat(null==(e=this.peerConn)?void 0:e.signalingState,")"))}),(0,o.A)(this,"onTrack",e=>{if(0===e.streams.length)return void u.vF.warn("Call ".concat(this.callId," onTrack() called with streamless track streamless (kind=").concat(e.track.kind,")"));var t=e.streams[0];if(this.pushRemoteFeed(t),!this.removeTrackListeners.has(t)){var r=()=>{0===t.getTracks().length&&(u.vF.info("Call ".concat(this.callId," onTrack() removing track (streamId=").concat(t.id,")")),this.deleteFeedByStream(t),t.removeEventListener("removetrack",r),this.removeTrackListeners.delete(t))};t.addEventListener("removetrack",r),this.removeTrackListeners.set(t,r)}}),(0,o.A)(this,"onDataChannel",e=>{this.emit(C.DataChannel,e.channel,this)}),(0,o.A)(this,"onNegotiationNeeded",(0,i.A)(function*(){if(u.vF.info("Call ".concat(t.callId," onNegotiationNeeded() negotiation is needed!")),t.state!==T.CreateOffer&&0===t.opponentVersion)return void u.vF.info("Call ".concat(t.callId," onNegotiationNeeded() opponent does not support renegotiation: ignoring negotiationneeded event"));t.queueGotLocalOffer()})),(0,o.A)(this,"onHangupReceived",e=>{u.vF.debug("Call ".concat(this.callId," onHangupReceived() running")),this.partyIdMatches(e)||this.state===T.Ringing?this.terminate(R.Remote,e.reason||k.UserHangup,!0):u.vF.info("Call ".concat(this.callId," onHangupReceived() ignoring message from party ID ").concat(e.party_id,": our partner is ").concat(this.opponentPartyId))}),(0,o.A)(this,"onRejectReceived",e=>{u.vF.debug("Call ".concat(this.callId," onRejectReceived() running")),[T.InviteSent,T.Ringing].includes(this.state)||this.state===T.Fledgling&&this.direction===A.Inbound?this.terminate(R.Remote,e.reason||k.UserHangup,!0):u.vF.debug("Call ".concat(this.callId," onRejectReceived() called in wrong state (state=").concat(this.state,")"))}),(0,o.A)(this,"onAnsweredElsewhere",e=>{u.vF.debug("Call ".concat(this.callId," onAnsweredElsewhere() running")),this.terminate(R.Remote,k.AnsweredElsewhere,!0)}),this.roomId=e.roomId,this.invitee=e.invitee,this.client=e.client,!this.client.deviceId)throw Error("Client must have a device ID to start calls");for(var n of(this.forceTURN=null!=(r=e.forceTURN)&&r,this.ourPartyId=this.client.deviceId,this.opponentDeviceId=e.opponentDeviceId,this.opponentSessionId=e.opponentSessionId,this.groupCallId=e.groupCallId,this.turnServers=e.turnServers||[],0===this.turnServers.length&&this.client.isFallbackICEServerAllowed()&&this.turnServers.push({urls:["stun:turn.matrix.org"]}),this.turnServers))(0,h.UB)(n,["urls"]);this.callId=M(),this.isOnlyDataChannelAllowed=this.client.isVoipWithNoMediaAllowed}placeVoiceCall(){var e=this;return(0,i.A)(function*(){yield e.placeCall(!0,!1)})()}placeVideoCall(){var e=this;return(0,i.A)(function*(){yield e.placeCall(!0,!0)})()}createDataChannel(e,t){var r=this.peerConn.createDataChannel(e,t);return this.emit(C.DataChannel,r,this),r}getOpponentMember(){return this.opponentMember}getOpponentDeviceId(){return this.opponentDeviceId}getOpponentSessionId(){return this.opponentSessionId}opponentCanBeTransferred(){return!!(this.opponentCaps&&this.opponentCaps["m.call.transferee"])}opponentSupportsDTMF(){return!!(this.opponentCaps&&this.opponentCaps["m.call.dtmf"])}getRemoteAssertedIdentity(){return this.remoteAssertedIdentity}get state(){return this._state}set state(e){var t=this._state;this._state=e,this.emit(C.State,e,t,this)}get type(){return this.hasUserMediaVideoSender||this.hasRemoteUserMediaVideoTrack?I.Video:I.Voice}get hasLocalUserMediaVideoTrack(){var e;return!!(null!=(e=this.localUsermediaStream)&&e.getVideoTracks().length)}get hasRemoteUserMediaVideoTrack(){return this.getRemoteFeeds().some(e=>{var t;return e.purpose===m.h.Usermedia&&(null==(t=e.stream)?void 0:t.getVideoTracks().length)})}get hasLocalUserMediaAudioTrack(){var e;return!!(null!=(e=this.localUsermediaStream)&&e.getAudioTracks().length)}get hasRemoteUserMediaAudioTrack(){return this.getRemoteFeeds().some(e=>{var t;return e.purpose===m.h.Usermedia&&!!(null!=(t=e.stream)&&t.getAudioTracks().length)})}get hasUserMediaAudioSender(){var e;return!!(null==(e=this.transceivers.get(m.h.Usermedia+":audio"))?void 0:e.sender)}get hasUserMediaVideoSender(){var e;return!!(null==(e=this.transceivers.get(m.h.Usermedia+":video"))?void 0:e.sender)}get localUsermediaFeed(){return this.getLocalFeeds().find(e=>e.purpose===m.h.Usermedia)}get localScreensharingFeed(){return this.getLocalFeeds().find(e=>e.purpose===m.h.Screenshare)}get localUsermediaStream(){var e;return null==(e=this.localUsermediaFeed)?void 0:e.stream}get localScreensharingStream(){var e;return null==(e=this.localScreensharingFeed)?void 0:e.stream}get remoteUsermediaFeed(){return this.getRemoteFeeds().find(e=>e.purpose===m.h.Usermedia)}get remoteScreensharingFeed(){return this.getRemoteFeeds().find(e=>e.purpose===m.h.Screenshare)}get remoteUsermediaStream(){var e;return null==(e=this.remoteUsermediaFeed)?void 0:e.stream}get remoteScreensharingStream(){var e;return null==(e=this.remoteScreensharingFeed)?void 0:e.stream}getFeedByStreamId(e){return this.getFeeds().find(t=>t.stream.id===e)}getFeeds(){return this.feeds}getLocalFeeds(){return this.feeds.filter(e=>e.isLocal())}getRemoteFeeds(){return this.feeds.filter(e=>!e.isLocal())}initOpponentCrypto(){var e=this;return(0,i.A)(function*(){if(e.opponentDeviceId&&e.client.getUseE2eForGroupCall()){if(!e.client.getCrypto()){e.hasOpponentDeviceInfo=!0;return}var t,r=e.invitee||(null==(t=e.getOpponentMember())?void 0:t.userId);if(!r)throw Error("Couldn't find opponent user ID to init crypto");throw e.hasOpponentDeviceInfo=!1,new y.Iy(r)}})()}getLocalSDPStreamMetadata(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t={};for(var r of this.getLocalFeeds())e&&(r.sdpMetadataStreamId=r.stream.id),t[r.sdpMetadataStreamId]={purpose:r.purpose,audio_muted:r.isAudioMuted(),video_muted:r.isVideoMuted()};return t}noIncomingFeeds(){return!this.feeds.some(e=>!e.isLocal())}pushRemoteFeed(e){if(!this.opponentSupportsSDPStreamMetadata())return void this.pushRemoteFeedWithoutMetadata(e);var t=this.getOpponentMember().userId,r=this.remoteSDPStreamMetadata[e.id].purpose,n=this.remoteSDPStreamMetadata[e.id].audio_muted,i=this.remoteSDPStreamMetadata[e.id].video_muted;return r?this.getFeedByStreamId(e.id)?void u.vF.warn("Call ".concat(this.callId," pushRemoteFeed() ignoring stream because we already have a feed for it (streamId=").concat(e.id,")")):void(this.feeds.push(new g.Hh({client:this.client,call:this,roomId:this.roomId,userId:t,deviceId:this.getOpponentDeviceId(),stream:e,purpose:r,audioMuted:n,videoMuted:i})),this.emit(C.FeedsChanged,this.feeds,this),u.vF.info("Call ".concat(this.callId," pushRemoteFeed() pushed stream (streamId=").concat(e.id,", active=").concat(e.active,", purpose=").concat(r,")"))):void u.vF.warn("Call ".concat(this.callId," pushRemoteFeed() ignoring stream because we didn't get any metadata about it (streamId=").concat(e.id,")"))}pushRemoteFeedWithoutMetadata(e){var t,r=this.getOpponentMember().userId,n=m.h.Usermedia,i=null==(t=this.feeds.find(e=>!e.isLocal()))?void 0:t.stream;return i&&e.id!==i.id?void u.vF.warn("Call ".concat(this.callId," pushRemoteFeedWithoutMetadata() ignoring new stream because we already have stream (streamId=").concat(e.id,")")):this.getFeedByStreamId(e.id)?void u.vF.warn("Call ".concat(this.callId," pushRemoteFeedWithoutMetadata() ignoring stream because we already have a feed for it (streamId=").concat(e.id,")")):void(this.feeds.push(new g.Hh({client:this.client,call:this,roomId:this.roomId,audioMuted:!1,videoMuted:!1,userId:r,deviceId:this.getOpponentDeviceId(),stream:e,purpose:n})),this.emit(C.FeedsChanged,this.feeds,this),u.vF.info("Call ".concat(this.callId," pushRemoteFeedWithoutMetadata() pushed stream (streamId=").concat(e.id,", active=").concat(e.active,")")))}pushNewLocalFeed(e,t){var r=!(arguments.length>2)||void 0===arguments[2]||arguments[2],n=this.client.getUserId();if(x(e.getAudioTracks(),!0),x(e.getVideoTracks(),!0),this.getFeedByStreamId(e.id))return void u.vF.warn("Call ".concat(this.callId," pushNewLocalFeed() ignoring stream because we already have a feed for it (streamId=").concat(e.id,")"));this.pushLocalFeed(new g.Hh({client:this.client,roomId:this.roomId,audioMuted:!1,videoMuted:!1,userId:n,deviceId:this.getOpponentDeviceId(),stream:e,purpose:t}),r)}pushLocalFeed(e){var t=this,r=!(arguments.length>1)||void 0===arguments[1]||arguments[1];if(this.feeds.some(t=>e.stream.id===t.stream.id))return void u.vF.info("Call ".concat(this.callId," pushLocalFeed() ignoring duplicate local stream (streamId=").concat(e.stream.id,")"));if(this.feeds.push(e),r)for(var n of e.stream.getTracks())!function(){u.vF.info("Call ".concat(t.callId," pushLocalFeed() adding track to peer connection (id=").concat(n.id,", kind=").concat(n.kind,", streamId=").concat(e.stream.id,", streamPurpose=").concat(e.purpose,", enabled=").concat(n.enabled,")"));var r=e.purpose+":"+n.kind;if(t.transceivers.has(r)){var i=t.transceivers.get(r);i.sender.replaceTrack(n),i.direction="inactive"===i.direction?"sendonly":"sendrecv"}else{var o=t.peerConn.addTrack(n,e.stream),a=t.peerConn.getTransceivers().find(e=>e.sender===o);a?t.transceivers.set(r,a):u.vF.warn("Call ".concat(t.callId," pushLocalFeed() didn't find a matching transceiver after adding track!"))}}();u.vF.info("Call ".concat(this.callId," pushLocalFeed() pushed stream (id=").concat(e.stream.id,", active=").concat(e.stream.active,", purpose=").concat(e.purpose,")")),this.emit(C.FeedsChanged,this.feeds,this)}removeLocalFeed(e){for(var t of[e.purpose+":audio",e.purpose+":video"])if(this.transceivers.has(t)){var r=this.transceivers.get(t);r.sender&&this.peerConn.removeTrack(r.sender)}e.purpose===m.h.Screenshare&&this.client.getMediaHandler().stopScreensharingStream(e.stream),this.deleteFeed(e)}deleteAllFeeds(){for(var e of this.feeds)e.isLocal()&&this.groupCallId||e.dispose();this.feeds=[],this.emit(C.FeedsChanged,this.feeds,this)}deleteFeedByStream(e){var t=this.getFeedByStreamId(e.id);if(!t)return void u.vF.warn("Call ".concat(this.callId," deleteFeedByStream() didn't find the feed to delete (streamId=").concat(e.id,")"));this.deleteFeed(t)}deleteFeed(e){e.dispose(),this.feeds.splice(this.feeds.indexOf(e),1),this.emit(C.FeedsChanged,this.feeds,this)}getCurrentCallStats(){var e=this;return(0,i.A)(function*(){return e.callHasEnded()?e.callStatsAtEnd:e.collectCallStats()})()}collectCallStats(){var e=this;return(0,i.A)(function*(){if(e.peerConn){var t=yield e.peerConn.getStats(),r=[];return t.forEach(e=>{r.push(e)}),r}})()}initWithInvite(e){var t=this;return(0,i.A)(function*(){var r,n=e.getContent();t.direction=A.Inbound,(yield t.client.checkTurnServers())||u.vF.warn("Call ".concat(t.callId," initWithInvite() failed to get TURN credentials! Proceeding with call anyway..."));var i=n[m.A];i?t.updateRemoteSDPStreamMetadata(i):u.vF.debug("Call ".concat(t.callId," initWithInvite() did not get any SDPStreamMetadata! Can not send/receive multiple streams")),t.peerConn=t.createPeerConnection(),t.emit(C.PeerConnectionCreated,t.peerConn,t),t.chooseOpponent(e),yield t.initOpponentCrypto();try{yield t.peerConn.setRemoteDescription(n.offer),u.vF.debug("Call ".concat(t.callId," initWithInvite() set remote description: ").concat(n.offer.type)),yield t.addBufferedIceCandidates()}catch(e){u.vF.debug("Call ".concat(t.callId," initWithInvite() failed to set remote description"),e),t.terminate(R.Local,k.SetRemoteDescription,!1);return}var o=null==(r=t.feeds.find(e=>!e.isLocal()))?void 0:r.stream;if(!t.isOnlyDataChannelAllowed&&(!o||0===o.getTracks().length)){u.vF.error("Call ".concat(t.callId," initWithInvite() no remote stream or no tracks after setting remote description!")),t.terminate(R.Local,k.SetRemoteDescription,!1);return}if(t.state=T.Ringing,e.getLocalAge()){var a=setTimeout(()=>{if(t.state==T.Ringing){var e;u.vF.debug("Call ".concat(t.callId," initWithInvite() invite has expired. Hanging up.")),t.hangupParty=R.Remote,t.state=T.Ended,t.stopAllMedia(),"closed"!=t.peerConn.signalingState&&t.peerConn.close(),null==(e=t.stats)||e.removeStatsReportGatherer(t.callId),t.emit(C.Hangup,t)}},n.lifetime-e.getLocalAge()),s=e=>{e!==T.Ringing&&(clearTimeout(a),t.off(C.State,s))};t.on(C.State,s)}})()}initWithHangup(e){this.state=T.Ended}shouldAnswerWithMediaType(e,t,r){return e&&!t?(u.vF.warn("Call ".concat(this.callId," shouldAnswerWithMediaType() unable to answer with ").concat(r," because the other side isn't sending it either.")),!1):(0,h.hX)(e)||e===t||this.opponentSupportsSDPStreamMetadata()?null!=e?e:t:(u.vF.warn("Call ".concat(this.callId," shouldAnswerWithMediaType() unable to answer with ").concat(r,"=").concat(e," because the other side doesn't support it. Answering with ").concat(r,"=").concat(t,".")),t)}answer(e,t){var r=this;return(0,i.A)(function*(){if(!r.inviteOrAnswerSent){if(!1===e&&!1===t)throw Error("You CANNOT answer a call without media");if(r.localUsermediaStream||r.waitForLocalAVStream)r.waitForLocalAVStream&&(r.state=T.WaitLocalMedia);else{var n=r.state,i=r.shouldAnswerWithMediaType(e,r.hasRemoteUserMediaAudioTrack,"audio"),o=r.shouldAnswerWithMediaType(t,r.hasRemoteUserMediaVideoTrack,"video");r.state=T.WaitLocalMedia,r.waitForLocalAVStream=!0;try{var a,s=yield r.client.getMediaHandler().getUserMediaStream(i,o);r.waitForLocalAVStream=!1;var l=[new g.Hh({client:r.client,roomId:r.roomId,userId:r.client.getUserId(),deviceId:null!=(a=r.client.getDeviceId())?a:void 0,stream:s,purpose:m.h.Usermedia,audioMuted:!1,videoMuted:!1})];r.localScreensharingFeed&&l.push(r.localScreensharingFeed),r.answerWithCallFeeds(l)}catch(e){if(!o)return void r.getUserMediaFailed(e);u.vF.warn("Call ".concat(r.callId," answer() failed to getUserMedia(), trying to getUserMedia() without video")),r.state=n,r.waitForLocalAVStream=!1,yield r.answer(i,!1)}}}})()}answerWithCallFeeds(e){this.inviteOrAnswerSent||this.queueGotCallFeedsForAnswer(e)}replacedBy(e){u.vF.debug("Call ".concat(this.callId," replacedBy() running (newCallId=").concat(e.callId,")")),this.state===T.WaitLocalMedia?(u.vF.debug("Call ".concat(this.callId," replacedBy() telling new call to wait for local media (newCallId=").concat(e.callId,")")),e.waitForLocalAVStream=!0):[T.CreateOffer,T.InviteSent].includes(this.state)&&(e.direction===A.Outbound?e.queueGotCallFeedsForAnswer([]):(u.vF.debug("Call ".concat(this.callId," replacedBy() handing local stream to new call(newCallId=").concat(e.callId,")")),e.queueGotCallFeedsForAnswer(this.getLocalFeeds().map(e=>e.clone())))),this.successor=e,this.emit(C.Replaced,e,this),this.hangup(k.Replaced,!0)}hangup(e,t){if(!this.callHasEnded()&&(u.vF.debug("Call ".concat(this.callId," hangup() ending call (reason=").concat(e,")")),this.terminate(R.Local,e,!t),![T.Fledgling,T.WaitLocalMedia].includes(this.state))){var r={};(this.opponentVersion&&0!==this.opponentVersion||e!==k.UserHangup)&&(r.reason=e),this.sendVoipEvent(v.Bx.CallHangup,r)}}reject(){if(this.state!==T.Ringing)throw Error("Call must be in 'ringing' state to reject!");if(0===this.opponentVersion){u.vF.info("Call ".concat(this.callId," reject() opponent version is less than 1: sending hangup instead of reject (opponentVersion=").concat(this.opponentVersion,")")),this.hangup(k.UserHangup,!0);return}u.vF.debug("Rejecting call: "+this.callId),this.terminate(R.Local,k.UserHangup,!0),this.sendVoipEvent(v.Bx.CallReject,{})}upgradeCall(e,t){var r=this;return(0,i.A)(function*(){if((e||t)&&r.opponentSupportsSDPStreamMetadata())try{u.vF.debug("Call ".concat(r.callId," upgradeCall() upgrading call (audio=").concat(e,", video=").concat(t,")"));var n=e||r.hasLocalUserMediaAudioTrack,i=t||r.hasLocalUserMediaVideoTrack,o=yield r.client.getMediaHandler().getUserMediaStream(n,i,!1);yield r.updateLocalUsermediaStream(o,e,t)}catch(e){u.vF.error("Call ".concat(r.callId," upgradeCall() failed to upgrade the call"),e),r.emit(C.Error,new O(k.NoUserMedia,"Failed to get camera access: ",e),r)}})()}opponentSupportsSDPStreamMetadata(){return!!this.remoteSDPStreamMetadata}isScreensharing(){return!!this.localScreensharingStream}setScreensharingEnabled(e,t){var r=this;return(0,i.A)(function*(){if(e&&r.isScreensharing())return u.vF.warn("Call ".concat(r.callId," setScreensharingEnabled() there is already a screensharing stream - there is nothing to do!")),!0;if(!e&&!r.isScreensharing())return u.vF.warn("Call ".concat(r.callId," setScreensharingEnabled() there already isn't a screensharing stream - there is nothing to do!")),!1;if(!r.opponentSupportsSDPStreamMetadata())return r.setScreensharingEnabledWithoutMetadataSupport(e,t);if(u.vF.debug("Call ".concat(r.callId," setScreensharingEnabled() running (enabled=").concat(e,")")),e)try{var n=yield r.client.getMediaHandler().getScreensharingStream(t);if(!n)return!1;return r.pushNewLocalFeed(n,m.h.Screenshare),!0}catch(e){return u.vF.error("Call ".concat(r.callId," setScreensharingEnabled() failed to get screen-sharing stream:"),e),!1}for(var i of[r.transceivers.get(m.h.Screenshare+":audio"),r.transceivers.get(m.h.Screenshare+":video")])i&&i.sender&&r.peerConn.removeTrack(i.sender);return r.client.getMediaHandler().stopScreensharingStream(r.localScreensharingStream),r.deleteFeedByStream(r.localScreensharingStream),!1})()}setScreensharingEnabledWithoutMetadataSupport(e,t){var r=this;return(0,i.A)(function*(){if(u.vF.debug("Call ".concat(r.callId," setScreensharingEnabledWithoutMetadataSupport() running (enabled=").concat(e,")")),e)try{var n,i=yield r.client.getMediaHandler().getScreensharingStream(t);if(!i)return!1;var o=i.getTracks().find(e=>"video"===e.kind),a=null==(n=r.transceivers.get(m.h.Usermedia+":video"))?void 0:n.sender;return null==a||a.replaceTrack(null!=o?o:null),r.pushNewLocalFeed(i,m.h.Screenshare,!1),!0}catch(e){return u.vF.error("Call ".concat(r.callId," setScreensharingEnabledWithoutMetadataSupport() failed to get screen-sharing stream:"),e),!1}var s,l,c=null==(s=r.localUsermediaStream)?void 0:s.getTracks().find(e=>"video"===e.kind),d=null==(l=r.transceivers.get(m.h.Usermedia+":video"))?void 0:l.sender;return null==d||d.replaceTrack(null!=c?c:null),r.client.getMediaHandler().stopScreensharingStream(r.localScreensharingStream),r.deleteFeedByStream(r.localScreensharingStream),!1})()}updateLocalUsermediaStream(e){var t=arguments,r=this;return(0,i.A)(function*(){var n=t.length>1&&void 0!==t[1]&&t[1],i=t.length>2&&void 0!==t[2]&&t[2],o=r.localUsermediaFeed,a=n||!o.isAudioMuted()&&!r.remoteOnHold,s=i||!o.isVideoMuted()&&!r.remoteOnHold;for(var l of(u.vF.log("Call ".concat(r.callId," updateLocalUsermediaStream() running (streamId=").concat(e.id,", audio=").concat(a,", video=").concat(s,")")),x(e.getAudioTracks(),a),x(e.getVideoTracks(),s),r.localUsermediaStream.getTracks()))r.localUsermediaStream.removeTrack(l),l.stop();for(var c of e.getTracks())r.localUsermediaStream.addTrack(c);var d=function*(){var t=m.h.Usermedia+":"+h.kind,n=r.transceivers.get(t),i=null==n?void 0:n.sender,a=!1;if(i)try{u.vF.info("Call ".concat(r.callId," updateLocalUsermediaStream() replacing track (id=").concat(h.id,", kind=").concat(h.kind,", streamId=").concat(e.id,", streamPurpose=").concat(o.purpose,")")),yield i.replaceTrack(h),n.direction="inactive"===n.direction?"sendonly":"sendrecv",a=!0}catch(e){u.vF.warn("Call ".concat(r.callId," updateLocalUsermediaStream() replaceTrack failed: adding new transceiver instead"),e)}if(!a){u.vF.info("Call ".concat(r.callId," updateLocalUsermediaStream() adding track to peer connection (id=").concat(h.id,", kind=").concat(h.kind,", streamId=").concat(e.id,", streamPurpose=").concat(o.purpose,")"));var s=r.peerConn.addTrack(h,r.localUsermediaStream),l=r.peerConn.getTransceivers().find(e=>e.sender===s);l?r.transceivers.set(t,l):u.vF.warn("Call ".concat(r.callId," updateLocalUsermediaStream() couldn't find matching transceiver for newly added track!"))}};for(var h of e.getTracks())yield*d()})()}setLocalVideoMuted(e){var t=this;return(0,i.A)(function*(){if(u.vF.log("Call ".concat(t.callId," setLocalVideoMuted() running ").concat(e)),e||void 0===t.stopVideoTrackTimer||(clearTimeout(t.stopVideoTrackTimer),t.stopVideoTrackTimer=void 0),!(yield t.client.getMediaHandler().hasVideoDevice()))return t.isLocalVideoMuted();if(!t.hasUserMediaVideoSender&&!e)return null==(n=t.localUsermediaFeed)||n.setAudioVideoMuted(null,e),yield t.upgradeCall(!1,!0),t.isLocalVideoMuted();if(!e&&0===t.localUsermediaStream.getVideoTracks().length){var r,n,i=yield t.client.getMediaHandler().getUserMediaStream(!0,!0);yield t.updateLocalUsermediaStream(i)}return null==(r=t.localUsermediaFeed)||r.setAudioVideoMuted(null,e),t.updateMuteStatus(),yield t.sendMetadataUpdate(),e&&(t.stopVideoTrackTimer=setTimeout(()=>{for(var e of t.localUsermediaStream.getVideoTracks())e.stop(),t.localUsermediaStream.removeTrack(e)},120)),t.isLocalVideoMuted()})()}isLocalVideoMuted(){var e,t;return null!=(e=null==(t=this.localUsermediaFeed)?void 0:t.isVideoMuted())&&e}setMicrophoneMuted(e){var t=this;return(0,i.A)(function*(){var r;return u.vF.log("Call ".concat(t.callId," setMicrophoneMuted() running ").concat(e)),(yield t.client.getMediaHandler().hasAudioDevice())&&(e||t.hasUserMediaAudioSender&&t.hasLocalUserMediaAudioTrack?(null==(r=t.localUsermediaFeed)||r.setAudioVideoMuted(e,null),t.updateMuteStatus(),yield t.sendMetadataUpdate()):yield t.upgradeCall(!0,!1)),t.isMicrophoneMuted()})()}isMicrophoneMuted(){var e,t;return null!=(e=null==(t=this.localUsermediaFeed)?void 0:t.isAudioMuted())&&e}isRemoteOnHold(){return this.remoteOnHold}setRemoteOnHold(e){if(this.isRemoteOnHold()!==e){for(var t of(this.remoteOnHold=e,this.peerConn.getTransceivers()))t.direction=e?"sendonly":"sendrecv";this.updateMuteStatus(),this.sendMetadataUpdate(),this.emit(C.RemoteHoldUnhold,this.remoteOnHold,this)}}isLocalOnHold(){if(this.state!==T.Connected)return!1;var e=!0;for(var t of this.peerConn.getTransceivers())["inactive","recvonly"].includes(t.currentDirection)||(e=!1);return e}sendDtmfDigit(e){for(var t of this.peerConn.getSenders()){var r;if((null==(r=t.track)?void 0:r.kind)==="audio"&&t.dtmf)return void t.dtmf.insertDTMF(e)}throw Error("Unable to find a track to send DTMF on")}updateMuteStatus(){var e=this.isMicrophoneMuted()||this.remoteOnHold,t=this.isLocalVideoMuted()||this.remoteOnHold;u.vF.log("Call ".concat(this.callId," updateMuteStatus stream ").concat(this.localUsermediaStream.id," micShouldBeMuted ").concat(e," vidShouldBeMuted ").concat(t)),x(this.localUsermediaStream.getAudioTracks(),!e),x(this.localUsermediaStream.getVideoTracks(),!t)}sendMetadataUpdate(){var e=this;return(0,i.A)(function*(){yield e.sendVoipEvent(v.Bx.CallSDPStreamMetadataChangedPrefix,{[m.A]:e.getLocalSDPStreamMetadata()})})()}gotCallFeedsForInvite(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this.successor)return void this.successor.queueGotCallFeedsForAnswer(e);if(this.callHasEnded())return void this.stopAllMedia();for(var r of e)this.pushLocalFeed(r);t&&this.peerConn.addTransceiver("video",{direction:"recvonly"}),this.state=T.CreateOffer,u.vF.debug("Call ".concat(this.callId," gotUserMediaForInvite() run"))}sendAnswer(){var e=this;return(0,i.A)(function*(){var t={answer:{sdp:e.peerConn.localDescription.sdp,type:e.peerConn.localDescription.type},[m.A]:e.getLocalSDPStreamMetadata(!0)};t.capabilities={"m.call.transferee":e.client.supportsCallTransfer,"m.call.dtmf":!1};var r=e.discardDuplicateCandidates();u.vF.info("Call ".concat(e.callId," sendAnswer() discarding ").concat(r," candidates that will be sent in answer"));try{yield e.sendVoipEvent(v.Bx.CallAnswer,t),e.inviteOrAnswerSent=!0}catch(t){e.state=T.Ringing,t instanceof b.up&&t.event&&e.client.cancelPendingEvent(t.event);var n=k.SendAnswer,i="Failed to send answer";throw"UnknownDeviceError"==t.name&&(n=k.UnknownDevices,i="Unknown devices present in the room"),e.emit(C.Error,new O(n,i,t),e),t}e.sendCandidateQueue()})()}queueGotCallFeedsForAnswer(e){this.responsePromiseChain?this.responsePromiseChain=this.responsePromiseChain.then(()=>this.gotCallFeedsForAnswer(e)):this.responsePromiseChain=this.gotCallFeedsForAnswer(e)}mungeSdp(e,t){var r=(0,d.qg)(e.sdp);r.media.forEach(e=>{var r=new Map,n=new Map;for(var i of e.rtp)r.set(i.payload,i.codec),n.set(i.codec,i.payload);for(var o of t)if(o.mediaType===e.type){if(!n.has(o.codec)){u.vF.info("Call ".concat(this.callId," mungeSdp() ignoring SDP modifications for ").concat(o.codec," as it's not present."));continue}var a=[];void 0!==o.enableDtx&&a.push("usedtx=".concat(o.enableDtx?"1":"0")),void 0!==o.maxAverageBitrate&&a.push("maxaveragebitrate=".concat(o.maxAverageBitrate));var s=!1;for(var l of e.fmtp)r.get(l.payload)===o.codec&&(s=!0,l.config+=";"+a.join(";"));s||e.fmtp.push({payload:n.get(o.codec),config:a.join(";")})}}),e.sdp=(0,d.M9)(r)}createOffer(){var e=this;return(0,i.A)(function*(){var t=yield e.peerConn.createOffer();return e.mungeSdp(t,P(e.isPtt)),t})()}createAnswer(){var e=this;return(0,i.A)(function*(){var t=yield e.peerConn.createAnswer();return e.mungeSdp(t,P(e.isPtt)),t})()}gotCallFeedsForAnswer(e){var t=this;return(0,i.A)(function*(){var r;if(!t.callHasEnded()){for(var n of(t.waitForLocalAVStream=!1,e))t.pushLocalFeed(n);t.state=T.CreateAnswer;try{t.getRidOfRTXCodecs(),r=yield t.createAnswer()}catch(e){u.vF.debug("Call ".concat(t.callId," gotCallFeedsForAnswer() failed to create answer: "),e),t.terminate(R.Local,k.CreateAnswer,!0);return}try{if(yield t.peerConn.setLocalDescription(r),t.callHasEnded()||(t.state=T.Connecting,yield new Promise(e=>{setTimeout(e,200)}),t.callHasEnded()))return;t.sendAnswer()}catch(e){u.vF.debug("Call ".concat(t.callId," gotCallFeedsForAnswer() error setting local description!"),e),t.terminate(R.Local,k.SetLocalDescription,!0);return}}})()}onRemoteIceCandidatesReceived(e){var t=this;return(0,i.A)(function*(){if(!t.callHasEnded()){var r=e.getContent(),n=r.candidates;if(!n)return void u.vF.info("Call ".concat(t.callId," onRemoteIceCandidatesReceived() ignoring candidates event with no candidates!"));var i=0===r.version?null:r.party_id||null;if(void 0===t.opponentPartyId){if(i){u.vF.info("Call ".concat(t.callId," onRemoteIceCandidatesReceived() buffering ").concat(n.length," candidates until we pick an opponent"));var o=t.remoteCandidateBuffer.get(i)||[];o.push(...n),t.remoteCandidateBuffer.set(i,o)}return}if(!t.partyIdMatches(r))return void u.vF.info("Call ".concat(t.callId," onRemoteIceCandidatesReceived() ignoring candidates from party ID ").concat(r.party_id,": we have chosen party ID ").concat(t.opponentPartyId));yield t.addIceCandidates(n)}})()}onAnswerReceived(e){var t=this;return(0,i.A)(function*(){var r=e.getContent();if(u.vF.debug("Call ".concat(t.callId," onAnswerReceived() running (hangupParty=").concat(r.party_id,")")),t.callHasEnded())return void u.vF.debug("Call ".concat(t.callId," onAnswerReceived() ignoring answer because call has ended"));if(void 0!==t.opponentPartyId)return void u.vF.info("Call ".concat(t.callId," onAnswerReceived() ignoring answer from party ID ").concat(r.party_id,": we already have an answer/reject from ").concat(t.opponentPartyId));t.chooseOpponent(e),yield t.addBufferedIceCandidates(),t.state=T.Connecting;var n=r[m.A];n?t.updateRemoteSDPStreamMetadata(n):u.vF.warn("Call ".concat(t.callId," onAnswerReceived() did not get any SDPStreamMetadata! Can not send/receive multiple streams"));try{t.isSettingRemoteAnswerPending=!0,yield t.peerConn.setRemoteDescription(r.answer),t.isSettingRemoteAnswerPending=!1,u.vF.debug("Call ".concat(t.callId," onAnswerReceived() set remote description: ").concat(r.answer.type))}catch(e){t.isSettingRemoteAnswerPending=!1,u.vF.debug("Call ".concat(t.callId," onAnswerReceived() failed to set remote description"),e),t.terminate(R.Local,k.SetRemoteDescription,!1);return}if(null!==t.opponentPartyId)try{yield t.sendVoipEvent(v.Bx.CallSelectAnswer,{selected_party_id:t.opponentPartyId})}catch(e){u.vF.warn("Call ".concat(t.callId," onAnswerReceived() failed to send select_answer event"),e)}})()}onSelectAnswerReceived(e){var t=this;return(0,i.A)(function*(){if(t.direction!==A.Inbound)return void u.vF.warn("Call ".concat(t.callId," onSelectAnswerReceived() got select_answer for an outbound call: ignoring"));var r=e.getContent().selected_party_id;if(null==r)return void u.vF.warn("Call ".concat(t.callId," onSelectAnswerReceived() got nonsensical select_answer with null/undefined selected_party_id: ignoring"));r!==t.ourPartyId&&(u.vF.info("Call ".concat(t.callId," onSelectAnswerReceived() got select_answer for party ID ").concat(r,": we are party ID ").concat(t.ourPartyId,".")),yield t.terminate(R.Remote,k.AnsweredElsewhere,!0))})()}onNegotiateReceived(e){var t=this;return(0,i.A)(function*(){var r,n,i=e.getContent(),o=i.description;if(!o||!o.sdp||!o.type)return void u.vF.info("Call ".concat(t.callId," onNegotiateReceived() ignoring invalid m.call.negotiate event"));var a=t.direction===A.Inbound,s=!t.makingOffer&&("stable"===t.peerConn.signalingState||t.isSettingRemoteAnswerPending),l="offer"===o.type&&!s;if(t.ignoreOffer=!a&&l,t.ignoreOffer)return void u.vF.info("Call ".concat(t.callId," onNegotiateReceived() ignoring colliding negotiate event because we're impolite"));var c=t.isLocalOnHold(),d=i[m.A];d?t.updateRemoteSDPStreamMetadata(d):u.vF.warn("Call ".concat(t.callId," onNegotiateReceived() received negotiation event without SDPStreamMetadata!"));try{if(t.isSettingRemoteAnswerPending="answer"==o.type,yield t.peerConn.setRemoteDescription(o),t.isSettingRemoteAnswerPending=!1,u.vF.debug("Call ".concat(t.callId," onNegotiateReceived() set remote description: ").concat(o.type)),"offer"===o.type){try{t.getRidOfRTXCodecs(),n=yield t.createAnswer()}catch(e){u.vF.debug("Call ".concat(t.callId," onNegotiateReceived() failed to create answer: "),e),t.terminate(R.Local,k.CreateAnswer,!0);return}yield t.peerConn.setLocalDescription(n),u.vF.debug("Call ".concat(t.callId," onNegotiateReceived() create an answer")),t.sendVoipEvent(v.Bx.CallNegotiate,{lifetime:6e4,description:null==(r=t.peerConn.localDescription)?void 0:r.toJSON(),[m.A]:t.getLocalSDPStreamMetadata(!0)})}}catch(e){t.isSettingRemoteAnswerPending=!1,u.vF.warn("Call ".concat(t.callId," onNegotiateReceived() failed to complete negotiation"),e)}var h=t.isLocalOnHold();c!==h&&(t.emit(C.LocalHoldUnhold,h,t),t.emit(C.HoldUnhold,h))})()}updateRemoteSDPStreamMetadata(e){for(var t of(this.remoteSDPStreamMetadata=(0,h.Bi)(this.remoteSDPStreamMetadata||{},e,!0),this.getRemoteFeeds())){var r,n=t.stream.id,i=this.remoteSDPStreamMetadata[n];t.setAudioVideoMuted(null==i?void 0:i.audio_muted,null==i?void 0:i.video_muted),t.purpose=null==(r=this.remoteSDPStreamMetadata[n])?void 0:r.purpose}}onSDPStreamMetadataChangedReceived(e){var t=e.getContent()[m.A];this.updateRemoteSDPStreamMetadata(t)}onAssertedIdentityReceived(e){var t=this;return(0,i.A)(function*(){var r=e.getContent();r.asserted_identity&&(t.remoteAssertedIdentity={id:r.asserted_identity.id,displayName:r.asserted_identity.display_name},t.emit(C.AssertedIdentityChanged,t))})()}callHasEnded(){return this.state===T.Ended}queueGotLocalOffer(){this.responsePromiseChain?this.responsePromiseChain=this.responsePromiseChain.then(()=>this.wrappedGotLocalOffer()):this.responsePromiseChain=this.wrappedGotLocalOffer()}wrappedGotLocalOffer(){var e=this;return(0,i.A)(function*(){e.makingOffer=!0;try{yield e.gotLocalOffer()}catch(t){e.getLocalOfferFailed(t);return}finally{e.makingOffer=!1}})()}gotLocalOffer(){var e=this;return(0,i.A)(function*(){if(u.vF.debug("Call ".concat(e.callId," gotLocalOffer() running")),e.callHasEnded())return void u.vF.debug("Call ".concat(e.callId,' gotLocalOffer() ignoring newly created offer because the call has ended"'));try{e.getRidOfRTXCodecs(),t=yield e.createOffer()}catch(t){u.vF.debug("Call ".concat(e.callId," gotLocalOffer() failed to create offer: "),t),e.terminate(R.Local,k.CreateOffer,!0);return}try{yield e.peerConn.setLocalDescription(t)}catch(t){u.vF.debug("Call ".concat(e.callId," gotLocalOffer() error setting local description!"),t),e.terminate(R.Local,k.SetLocalDescription,!0);return}if("gathering"===e.peerConn.iceGatheringState&&(yield new Promise(e=>{setTimeout(e,200)})),!e.callHasEnded()){var t,r,n,i=e.state===T.CreateOffer?v.Bx.CallInvite:v.Bx.CallNegotiate,o={lifetime:6e4};i===v.Bx.CallInvite&&e.invitee&&(o.invitee=e.invitee),e.state===T.CreateOffer?o.offer=null==(r=e.peerConn.localDescription)?void 0:r.toJSON():o.description=null==(n=e.peerConn.localDescription)?void 0:n.toJSON(),o.capabilities={"m.call.transferee":e.client.supportsCallTransfer,"m.call.dtmf":!1},o[m.A]=e.getLocalSDPStreamMetadata(!0);var a=e.discardDuplicateCandidates();u.vF.info("Call ".concat(e.callId," gotLocalOffer() discarding ").concat(a," candidates that will be sent in offer"));try{yield e.sendVoipEvent(i,o)}catch(t){u.vF.error("Call ".concat(e.callId," gotLocalOffer() failed to send invite"),t),t instanceof b.up&&t.event&&e.client.cancelPendingEvent(t.event);var s=k.SignallingFailed,l="Signalling failed";e.state===T.CreateOffer&&(s=k.SendInvite,l="Failed to send invite"),"UnknownDeviceError"==t.name&&(s=k.UnknownDevices,l="Unknown devices present in the room"),e.emit(C.Error,new O(s,l,t),e),e.terminate(R.Local,s,!1);return}e.sendCandidateQueue(),e.state===T.CreateOffer&&(e.inviteOrAnswerSent=!0,e.state=T.InviteSent,e.inviteTimeout=setTimeout(()=>{e.inviteTimeout=void 0,e.state===T.InviteSent&&e.hangup(k.InviteTimeout,!1)},6e4))}})()}getRidOfRTXCodecs(){if(RTCRtpReceiver.getCapabilities&&RTCRtpSender.getCapabilities){var e=this.transceivers.get(m.h.Screenshare+":video");if(e&&e.setCodecPreferences){var t=RTCRtpReceiver.getCapabilities("video").codecs,r=RTCRtpSender.getCapabilities("video").codecs,n=[];for(var i of[...t,...r])if("video/rtx"!==i.mimeType){n.push(i);try{e.setCodecPreferences(n)}catch(e){u.vF.info("Working around buggy WebRTC impl: claimed to support codec but threw when setting codec preferences",i,e),n.pop()}}}}}sendVoipEvent(e,t){var r=this;return(0,i.A)(function*(){var n,i=E(E({},t),{},{version:"1",call_id:r.callId,party_id:r.ourPartyId,conf_id:r.groupCallId});if(r.opponentDeviceId){var o,a=r.toDeviceSeq++,s=E(E({},i),{},{device_id:r.client.deviceId,sender_session_id:r.client.getSessionId(),dest_session_id:r.opponentSessionId,seq:a,[v.wt]:c()});r.emit(C.SendVoipEvent,{type:"toDevice",eventType:e,userId:r.invitee||(null==(o=r.getOpponentMember())?void 0:o.userId),opponentDeviceId:r.opponentDeviceId,content:s},r);var l=r.invitee||r.getOpponentMember().userId;if(r.client.getUseE2eForGroupCall()){if(!r.hasOpponentDeviceInfo)return void u.vF.warn("Call ".concat(r.callId," sendVoipEvent() failed: we do not have opponentDeviceInfo"));throw Error("Unimplemented")}yield r.client.sendToDevice(e,new Map([[l,new Map([[r.opponentDeviceId,s]])]]))}else r.emit(C.SendVoipEvent,{type:"sendEvent",eventType:e,roomId:r.roomId,content:i,userId:r.invitee||(null==(n=r.getOpponentMember())?void 0:n.userId)},r),yield r.client.sendEvent(r.roomId,e,i)})()}queueCandidate(e){if(e?this.candidateSendQueue.push(e):this.candidatesEnded=!0,this.state!==T.Ringing&&this.inviteOrAnswerSent){var t=this.direction===A.Inbound?500:2e3;0===this.candidateSendTries&&setTimeout(()=>{this.sendCandidateQueue()},t)}}discardDuplicateCandidates(){for(var e=0,t=[],r=0;r<this.candidateSendQueue.length;r++){var n=this.candidateSendQueue[r];""===n.candidate?t.push(n):e++}return this.candidateSendQueue=t,e}transfer(e){var t=this;return(0,i.A)(function*(){var r=yield t.client.getProfileInfo(e),n=M(),i={replacement_id:M(),target_user:{id:e,display_name:r.displayname,avatar_url:r.avatar_url},create_call:n};yield t.sendVoipEvent(v.Bx.CallReplaces,i),yield t.terminate(R.Local,k.Transferred,!0)})()}transferToCall(e){var t=this;return(0,i.A)(function*(){var r,n,i=null==(r=e.getOpponentMember())?void 0:r.userId,o=i?yield t.client.getProfileInfo(i):void 0,a=null==(n=t.getOpponentMember())?void 0:n.userId,s=a?yield t.client.getProfileInfo(a):void 0,l=M(),c={replacement_id:M(),target_user:{id:a,display_name:null==s?void 0:s.displayname,avatar_url:null==s?void 0:s.avatar_url},await_call:l};yield e.sendVoipEvent(v.Bx.CallReplaces,c);var d={replacement_id:M(),target_user:{id:i,display_name:null==o?void 0:o.displayname,avatar_url:null==o?void 0:o.avatar_url},create_call:l};yield t.sendVoipEvent(v.Bx.CallReplaces,d),yield t.terminate(R.Local,k.Transferred,!0),yield e.terminate(R.Local,k.Transferred,!0)})()}terminate(e,t,r){var n=this;return(0,i.A)(function*(){var i;if(!n.callHasEnded()){for(var[o,a]of(n.hangupParty=e,n.hangupReason=t,n.state=T.Ended,n.inviteTimeout&&(clearTimeout(n.inviteTimeout),n.inviteTimeout=void 0),void 0!==n.iceDisconnectedTimeout&&(clearTimeout(n.iceDisconnectedTimeout),n.iceDisconnectedTimeout=void 0),n.callLengthInterval&&(clearInterval(n.callLengthInterval),n.callLengthInterval=void 0),void 0!==n.stopVideoTrackTimer&&(clearTimeout(n.stopVideoTrackTimer),n.stopVideoTrackTimer=void 0),n.removeTrackListeners))o.removeEventListener("removetrack",a);n.removeTrackListeners.clear(),n.callStatsAtEnd=yield n.collectCallStats(),n.stopAllMedia(),n.deleteAllFeeds(),n.peerConn&&"closed"!==n.peerConn.signalingState&&n.peerConn.close(),null==(i=n.stats)||i.removeStatsReportGatherer(n.callId),r&&n.emit(C.Hangup,n),n.client.callEventHandler.calls.delete(n.callId)}})()}stopAllMedia(){for(var e of(u.vF.debug("Call ".concat(this.callId," stopAllMedia() running")),this.feeds))if(e.isLocal()&&e.purpose===m.h.Usermedia)this.client.getMediaHandler().stopUserMediaStream(e.stream);else if(e.isLocal()&&e.purpose===m.h.Screenshare)this.client.getMediaHandler().stopScreensharingStream(e.stream);else if(!e.isLocal())for(var t of(u.vF.debug("Call ".concat(this.callId," stopAllMedia() stopping stream (streamId=").concat(e.stream.id,")")),e.stream.getTracks()))t.stop()}checkForErrorListener(){if(0===this.listeners(f.u.Error).length)throw Error("You MUST attach an error listener using call.on('error', function() {})")}sendCandidateQueue(){var e=this;return(0,i.A)(function*(){if(!(0===e.candidateSendQueue.length||e.callHasEnded())){var t=e.candidateSendQueue;e.candidateSendQueue=[],++e.candidateSendTries;var r={candidates:t.map(e=>e.toJSON())};e.candidatesEnded&&r.candidates.push({candidate:""}),u.vF.debug("Call ".concat(e.callId," sendCandidateQueue() attempting to send ").concat(t.length," candidates"));try{yield e.sendVoipEvent(v.Bx.CallCandidates,r),e.candidateSendTries=0,e.sendCandidateQueue()}catch(r){if(r instanceof b.up&&r.event&&e.client.cancelPendingEvent(r.event),e.candidateSendQueue.push(...t),e.candidateSendTries>5){u.vF.debug("Call ".concat(e.callId," sendCandidateQueue() failed to send candidates on attempt ").concat(e.candidateSendTries,". Giving up on this call."),r);var n=k.SignallingFailed;e.emit(C.Error,new O(n,"Signalling failed",r),e),e.hangup(n,!1);return}var i=500*Math.pow(2,e.candidateSendTries);++e.candidateSendTries,u.vF.debug("Call ".concat(e.callId," sendCandidateQueue() failed to send candidates. Retrying in ").concat(i,"ms"),r),setTimeout(()=>{e.sendCandidateQueue()},i)}}})()}placeCall(e,t){var r=this;return(0,i.A)(function*(){if(!e)throw Error("You CANNOT start a call without audio");r.state=T.WaitLocalMedia;try{var n,i,o=yield r.client.getMediaHandler().getUserMediaStream(e,t);x(o.getAudioTracks(),!0),x(o.getVideoTracks(),!0),n=new g.Hh({client:r.client,roomId:r.roomId,userId:r.client.getUserId(),deviceId:null!=(i=r.client.getDeviceId())?i:void 0,stream:o,purpose:m.h.Usermedia,audioMuted:!1,videoMuted:!1})}catch(e){r.getUserMediaFailed(e);return}try{yield r.placeCallWithCallFeeds([n])}catch(e){r.placeCallFailed(e);return}})()}placeCallWithCallFeeds(e){var t=arguments,r=this;return(0,i.A)(function*(){var n=t.length>1&&void 0!==t[1]&&t[1];r.checkForErrorListener(),r.direction=A.Outbound,yield r.initOpponentCrypto(),r.client.callEventHandler.calls.set(r.callId,r),(yield r.client.checkTurnServers())||u.vF.warn("Call ".concat(r.callId," placeCallWithCallFeeds() failed to get TURN credentials! Proceeding with call anyway...")),r.peerConn=r.createPeerConnection(),r.emit(C.PeerConnectionCreated,r.peerConn,r),r.gotCallFeedsForInvite(e,n)})()}createPeerConnection(){var e,t=new window.RTCPeerConnection({iceTransportPolicy:this.forceTURN?"relay":void 0,iceServers:this.turnServers.length?this.turnServers:void 0,iceCandidatePoolSize:this.client.iceCandidatePoolSize,bundlePolicy:"max-bundle"});t.addEventListener("iceconnectionstatechange",this.onIceConnectionStateChanged),t.addEventListener("signalingstatechange",this.onSignallingStateChanged),t.addEventListener("icecandidate",this.gotLocalIceCandidate),t.addEventListener("icegatheringstatechange",this.onIceGatheringStateChange),t.addEventListener("track",this.onTrack),t.addEventListener("negotiationneeded",this.onNegotiationNeeded),t.addEventListener("datachannel",this.onDataChannel);var r=this.getOpponentMember(),n=r?r.userId:"unknown";return null==(e=this.stats)||e.addStatsReportGatherer(this.callId,n,t),t}partyIdMatches(e){return(0===e.version?null:e.party_id||null)===this.opponentPartyId}chooseOpponent(e){var t,r,n=e.getContent();u.vF.debug("Call ".concat(this.callId," chooseOpponent() running (partyId=").concat(n.party_id,")")),this.opponentVersion=n.version,0===this.opponentVersion?this.opponentPartyId=null:this.opponentPartyId=n.party_id||null,this.opponentCaps=n.capabilities||{},this.opponentMember=null!=(t=this.client.getRoom(this.roomId).getMember(e.getSender()))?t:void 0,this.opponentMember&&(null==(r=this.stats)||r.updateOpponentMember(this.callId,this.opponentMember.userId))}addBufferedIceCandidates(){var e=this;return(0,i.A)(function*(){var t=e.remoteCandidateBuffer.get(e.opponentPartyId);t&&(u.vF.info("Call ".concat(e.callId," addBufferedIceCandidates() adding ").concat(t.length," buffered candidates for opponent ").concat(e.opponentPartyId)),yield e.addIceCandidates(t)),e.remoteCandidateBuffer.clear()})()}addIceCandidates(e){var t=this;return(0,i.A)(function*(){for(var r of e){(null===r.sdpMid||void 0===r.sdpMid)&&(null===r.sdpMLineIndex||void 0===r.sdpMLineIndex)?u.vF.debug("Call ".concat(t.callId," addIceCandidates() got remote ICE end-of-candidates")):u.vF.debug("Call ".concat(t.callId," addIceCandidates() got remote ICE candidate (sdpMid=").concat(r.sdpMid,", candidate=").concat(r.candidate,")"));try{yield t.peerConn.addIceCandidate(r)}catch(e){t.ignoreOffer?u.vF.debug("Call ".concat(t.callId," addIceCandidates() failed to add remote ICE candidate because ignoring offer"),e):u.vF.info("Call ".concat(t.callId," addIceCandidates() failed to add remote ICE candidate"),e)}}})()}get hasPeerConnection(){return!!this.peerConn}initStats(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1],this.stats=e,this.stats.start()}}function x(e,t){for(var r of e)r.enabled=t}function F(){if("undefined"==typeof window||"undefined"==typeof document)return!1;try{var e,t,r;if(!(null!=(e=null!=(t=null!=(r=window.RTCPeerConnection)?r:window.RTCSessionDescription)?t:window.RTCIceCandidate)?e:navigator.mediaDevices))return u.vF.error("WebRTC is not supported in this browser / environment"),!1}catch(e){return u.vF.error("Exception thrown when trying to access WebRTC",e),!1}return!0}function L(e,t,r){if(!F())return null;var n=!!r&&r.forceTURN,i=new D({client:e,roomId:t,invitee:null==r?void 0:r.invitee,turnServers:e.getTurnServers(),forceTURN:e.forceTURN||n,opponentDeviceId:null==r?void 0:r.opponentDeviceId,opponentSessionId:null==r?void 0:r.opponentSessionId,groupCallId:null==r?void 0:r.groupCallId});return e.reEmitter.reEmit(i,Object.values(C)),i}},26268:(e,t,r)=>{"use strict";r.d(t,{AO:()=>eg,gu:()=>em,uv:()=>q,db:()=>eb,SU:()=>ec,Rh:()=>X,k8:()=>ev,P3:()=>ea,cJ:()=>es,R2:()=>el,oE:()=>ei,aT:()=>ey,EZ:()=>Y,Pl:()=>ep,eC:()=>Z,rm:()=>$,K8:()=>Q});var n,i,o=r(84458),a=r(29301);class s extends Error{}function l(e,t){let r;if("string"!=typeof e)throw new s("Invalid token specified: must be a string");t||(t={});let n=+(!0!==t.header),i=e.split(".")[n];if("string"!=typeof i)throw new s(`Invalid token specified: missing part #${n+1}`);try{r=function(e){let t=e.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw Error("base64 string is not of the correct length")}try{var r;return r=t,decodeURIComponent(atob(r).replace(/(.)/g,(e,t)=>{let r=t.charCodeAt(0).toString(16).toUpperCase();return r.length<2&&(r="0"+r),"%"+r}))}catch(e){return atob(t)}}(i)}catch(e){throw new s(`Invalid token specified: invalid base64 for part #${n+1} (${e.message})`)}try{return JSON.parse(r)}catch(e){throw new s(`Invalid token specified: invalid json for part #${n+1} (${e.message})`)}}s.prototype.name="InvalidTokenError";var c={debug:()=>void 0,info:()=>void 0,warn:()=>void 0,error:()=>void 0},d=(e=>(e[e.NONE=0]="NONE",e[e.ERROR=1]="ERROR",e[e.WARN=2]="WARN",e[e.INFO=3]="INFO",e[e.DEBUG=4]="DEBUG",e))(d||{});(e=>{e.reset=function(){n=3,i=c},e.setLevel=function(e){if(!(0<=e&&e<=4))throw Error("Invalid log level");n=e},e.setLogger=function(e){i=e}})(d||(d={}));var u=class e{constructor(e){this._name=e}debug(...t){n>=4&&i.debug(e._format(this._name,this._method),...t)}info(...t){n>=3&&i.info(e._format(this._name,this._method),...t)}warn(...t){n>=2&&i.warn(e._format(this._name,this._method),...t)}error(...t){n>=1&&i.error(e._format(this._name,this._method),...t)}throw(e){throw this.error(e),e}create(e){let t=Object.create(this);return t._method=e,t.debug("begin"),t}static createStatic(t,r){let n=new e(`${t}.${r}`);return n.debug("begin"),n}static _format(e,t){let r=`[${e}]`;return t?`${r} ${t}:`:r}static debug(t,...r){n>=4&&i.debug(e._format(t),...r)}static info(t,...r){n>=3&&i.info(e._format(t),...r)}static warn(t,...r){n>=2&&i.warn(e._format(t),...r)}static error(t,...r){n>=1&&i.error(e._format(t),...r)}};d.reset();var h=class{static decode(e){try{return l(e)}catch(e){throw u.error("JwtUtils.decode",e),e}}static async generateSignedJwt(e,t,r){let n=m.encodeBase64Url(new TextEncoder().encode(JSON.stringify(e))),i=m.encodeBase64Url(new TextEncoder().encode(JSON.stringify(t))),o=`${n}.${i}`,a=await window.crypto.subtle.sign({name:"ECDSA",hash:{name:"SHA-256"}},r,new TextEncoder().encode(o)),s=m.encodeBase64Url(new Uint8Array(a));return`${o}.${s}`}static async generateSignedJwtWithHmac(e,t,r){let n=m.encodeBase64Url(new TextEncoder().encode(JSON.stringify(e))),i=m.encodeBase64Url(new TextEncoder().encode(JSON.stringify(t))),o=`${n}.${i}`,a=await window.crypto.subtle.sign("HMAC",r,new TextEncoder().encode(o)),s=m.encodeBase64Url(new Uint8Array(a));return`${o}.${s}`}},v=e=>btoa([...new Uint8Array(e)].map(e=>String.fromCharCode(e)).join("")),p=class e{static _randomWord(){let e=new Uint32Array(1);return crypto.getRandomValues(e),e[0]}static generateUUIDv4(){return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,t=>(t^e._randomWord()&15>>t/4).toString(16)).replace(/-/g,"")}static generateCodeVerifier(){return e.generateUUIDv4()+e.generateUUIDv4()+e.generateUUIDv4()}static async generateCodeChallenge(e){if(!crypto.subtle)throw Error("Crypto.subtle is available only in secure contexts (HTTPS).");try{let t=new TextEncoder().encode(e),r=await crypto.subtle.digest("SHA-256",t);return v(r).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}catch(e){throw u.error("CryptoUtils.generateCodeChallenge",e),e}}static generateBasicAuth(e,t){return v(new TextEncoder().encode([e,t].join(":")))}static async hash(e,t){let r=new TextEncoder().encode(t);return new Uint8Array(await crypto.subtle.digest(e,r))}static async customCalculateJwkThumbprint(t){let r;switch(t.kty){case"RSA":r={e:t.e,kty:t.kty,n:t.n};break;case"EC":r={crv:t.crv,kty:t.kty,x:t.x,y:t.y};break;case"OKP":r={crv:t.crv,kty:t.kty,x:t.x};break;case"oct":r={crv:t.k,kty:t.kty};break;default:throw Error("Unknown jwk type")}let n=await e.hash("SHA-256",JSON.stringify(r));return e.encodeBase64Url(n)}static async generateDPoPProof({url:t,accessToken:r,httpMethod:n,keyPair:i,nonce:o}){let a,s={jti:window.crypto.randomUUID(),htm:null!=n?n:"GET",htu:t,iat:Math.floor(Date.now()/1e3)};r&&(a=await e.hash("SHA-256",r),s.ath=e.encodeBase64Url(a)),o&&(s.nonce=o);try{let e=await crypto.subtle.exportKey("jwk",i.publicKey),t={alg:"ES256",typ:"dpop+jwt",jwk:{crv:e.crv,kty:e.kty,x:e.x,y:e.y}};return await h.generateSignedJwt(t,s,i.privateKey)}catch(e){if(e instanceof TypeError)throw Error(`Error exporting dpop public key: ${e.message}`);throw e}}static async generateDPoPJkt(t){try{let r=await crypto.subtle.exportKey("jwk",t.publicKey);return await e.customCalculateJwkThumbprint(r)}catch(e){if(e instanceof TypeError)throw Error(`Could not retrieve dpop keys from storage: ${e.message}`);throw e}}static async generateDPoPKeys(){return await window.crypto.subtle.generateKey({name:"ECDSA",namedCurve:"P-256"},!1,["sign","verify"])}static async generateClientAssertionJwt(t,r,n,i="HS256"){let o=Math.floor(Date.now()/1e3),a={iss:t,sub:t,aud:n,jti:e.generateUUIDv4(),exp:o+300,iat:o},s={HS256:"SHA-256",HS384:"SHA-384",HS512:"SHA-512"}[i];if(!s)throw Error(`Unsupported algorithm: ${i}. Supported algorithms are: HS256, HS384, HS512`);let l=new TextEncoder,c=await crypto.subtle.importKey("raw",l.encode(r),{name:"HMAC",hash:s},!1,["sign"]);return await h.generateSignedJwtWithHmac({alg:i,typ:"JWT"},a,c)}};p.encodeBase64Url=e=>v(e).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_");var m=p,g=class{constructor(e){this._name=e,this._callbacks=[],this._logger=new u(`Event('${this._name}')`)}addHandler(e){return this._callbacks.push(e),()=>this.removeHandler(e)}removeHandler(e){let t=this._callbacks.lastIndexOf(e);t>=0&&this._callbacks.splice(t,1)}async raise(...e){for(let t of(this._logger.debug("raise:",...e),this._callbacks))await t(...e)}},f=class e extends g{constructor(){super(...arguments),this._logger=new u(`Timer('${this._name}')`),this._timerHandle=null,this._expiration=0,this._callback=()=>{let t=this._expiration-e.getEpochTime();this._logger.debug("timer completes in",t),this._expiration<=e.getEpochTime()&&(this.cancel(),super.raise())}}static getEpochTime(){return Math.floor(Date.now()/1e3)}init(t){let r=this._logger.create("init");t=Math.max(Math.floor(t),1);let n=e.getEpochTime()+t;if(this.expiration===n&&this._timerHandle)return void r.debug("skipping since already initialized for expiration at",this.expiration);this.cancel(),r.debug("using duration",t),this._expiration=n;let i=Math.min(t,5);this._timerHandle=setInterval(this._callback,1e3*i)}get expiration(){return this._expiration}cancel(){this._logger.create("cancel"),this._timerHandle&&(clearInterval(this._timerHandle),this._timerHandle=null)}},y=class{static readParams(e,t="query"){if(!e)throw TypeError("Invalid URL");return new URLSearchParams(new URL(e,"http://127.0.0.1")["fragment"===t?"hash":"search"].slice(1))}},b=class extends Error{constructor(e,t){var r,n,i;if(super(e.error_description||e.error||""),this.form=t,this.name="ErrorResponse",!e.error)throw u.error("ErrorResponse","No error passed"),Error("No error passed");this.error=e.error,this.error_description=null!=(r=e.error_description)?r:null,this.error_uri=null!=(n=e.error_uri)?n:null,this.state=e.userState,this.session_state=null!=(i=e.session_state)?i:null,this.url_state=e.url_state}},S=class extends Error{constructor(e){super(e),this.name="ErrorTimeout"}},E=class{constructor(){this._logger=new u("InMemoryWebStorage"),this._data={}}clear(){this._logger.create("clear"),this._data={}}getItem(e){return this._logger.create(`getItem('${e}')`),this._data[e]}setItem(e,t){this._logger.create(`setItem('${e}')`),this._data[e]=t}removeItem(e){this._logger.create(`removeItem('${e}')`),delete this._data[e]}get length(){return Object.getOwnPropertyNames(this._data).length}key(e){return Object.getOwnPropertyNames(this._data)[e]}},_=class extends Error{constructor(e,t){super(t),this.name="ErrorDPoPNonce",this.nonce=e}},w=class{constructor(e=[],t=null,r={}){this._jwtHandler=t,this._extraHeaders=r,this._logger=new u("JsonService"),this._contentTypes=[],this._contentTypes.push(...e,"application/json"),t&&this._contentTypes.push("application/jwt")}async fetchWithTimeout(e,t={}){let{timeoutInSeconds:r,...n}=t;if(!r)return await fetch(e,n);let i=new AbortController,o=setTimeout(()=>i.abort(),1e3*r);try{return await fetch(e,{...t,signal:i.signal})}catch(e){if(e instanceof DOMException&&"AbortError"===e.name)throw new S("Network timed out");throw e}finally{clearTimeout(o)}}async getJson(e,{token:t,credentials:r,timeoutInSeconds:n}={}){let i,o,a=this._logger.create("getJson"),s={Accept:this._contentTypes.join(", ")};t&&(a.debug("token passed, setting Authorization header"),s.Authorization="Bearer "+t),this._appendExtraHeaders(s);try{a.debug("url:",e),i=await this.fetchWithTimeout(e,{method:"GET",headers:s,timeoutInSeconds:n,credentials:r})}catch(e){throw a.error("Network Error"),e}a.debug("HTTP response received, status",i.status);let l=i.headers.get("Content-Type");if(l&&!this._contentTypes.find(e=>l.startsWith(e))&&a.throw(Error(`Invalid response Content-Type: ${null!=l?l:"undefined"}, from URL: ${e}`)),i.ok&&this._jwtHandler&&(null==l?void 0:l.startsWith("application/jwt")))return await this._jwtHandler(await i.text());try{o=await i.json()}catch(e){if(a.error("Error parsing JSON response",e),i.ok)throw e;throw Error(`${i.statusText} (${i.status})`)}if(!i.ok){if(a.error("Error from server:",o),o.error)throw new b(o);throw Error(`${i.statusText} (${i.status}): ${JSON.stringify(o)}`)}return o}async postForm(e,{body:t,basicAuth:r,timeoutInSeconds:n,initCredentials:i,extraHeaders:o}){let a,s=this._logger.create("postForm"),l={Accept:this._contentTypes.join(", "),"Content-Type":"application/x-www-form-urlencoded",...o};void 0!==r&&(l.Authorization="Basic "+r),this._appendExtraHeaders(l);try{s.debug("url:",e),a=await this.fetchWithTimeout(e,{method:"POST",headers:l,body:t,timeoutInSeconds:n,credentials:i})}catch(e){throw s.error("Network error"),e}s.debug("HTTP response received, status",a.status);let c=a.headers.get("Content-Type");if(c&&!this._contentTypes.find(e=>c.startsWith(e)))throw Error(`Invalid response Content-Type: ${null!=c?c:"undefined"}, from URL: ${e}`);let d=await a.text(),u={};if(d)try{u=JSON.parse(d)}catch(e){if(s.error("Error parsing JSON response",e),a.ok)throw e;throw Error(`${a.statusText} (${a.status})`)}if(!a.ok){if(s.error("Error from server:",u),a.headers.has("dpop-nonce"))throw new _(a.headers.get("dpop-nonce"),`${JSON.stringify(u)}`);if(u.error)throw new b(u,t);throw Error(`${a.statusText} (${a.status}): ${JSON.stringify(u)}`)}return u}_appendExtraHeaders(e){let t=this._logger.create("appendExtraHeaders"),r=Object.keys(this._extraHeaders),n=["accept","content-type"],i=["authorization"];0!==r.length&&r.forEach(r=>{if(n.includes(r.toLocaleLowerCase()))return void t.warn("Protected header could not be set",r,n);if(i.includes(r.toLocaleLowerCase())&&Object.keys(e).includes(r))return void t.warn("Header could not be overridden",r,i);let o="function"==typeof this._extraHeaders[r]?this._extraHeaders[r]():this._extraHeaders[r];o&&""!==o&&(e[r]=o)})}},T=class{constructor(e){this._settings=e,this._logger=new u("MetadataService"),this._signingKeys=null,this._metadata=null,this._metadataUrl=this._settings.metadataUrl,this._jsonService=new w(["application/jwk-set+json"],null,this._settings.extraHeaders),this._settings.signingKeys&&(this._logger.debug("using signingKeys from settings"),this._signingKeys=this._settings.signingKeys),this._settings.metadata&&(this._logger.debug("using metadata from settings"),this._metadata=this._settings.metadata),this._settings.fetchRequestCredentials&&(this._logger.debug("using fetchRequestCredentials from settings"),this._fetchRequestCredentials=this._settings.fetchRequestCredentials)}resetSigningKeys(){this._signingKeys=null}async getMetadata(){let e=this._logger.create("getMetadata");if(this._metadata)return e.debug("using cached values"),this._metadata;if(!this._metadataUrl)throw e.throw(Error("No authority or metadataUrl configured on settings")),null;e.debug("getting metadata from",this._metadataUrl);let t=await this._jsonService.getJson(this._metadataUrl,{credentials:this._fetchRequestCredentials,timeoutInSeconds:this._settings.requestTimeoutInSeconds});return e.debug("merging remote JSON with seed metadata"),this._metadata=Object.assign({},t,this._settings.metadataSeed),this._metadata}getIssuer(){return this._getMetadataProperty("issuer")}getAuthorizationEndpoint(){return this._getMetadataProperty("authorization_endpoint")}getUserInfoEndpoint(){return this._getMetadataProperty("userinfo_endpoint")}getTokenEndpoint(e=!0){return this._getMetadataProperty("token_endpoint",e)}getCheckSessionIframe(){return this._getMetadataProperty("check_session_iframe",!0)}getEndSessionEndpoint(){return this._getMetadataProperty("end_session_endpoint",!0)}getRevocationEndpoint(e=!0){return this._getMetadataProperty("revocation_endpoint",e)}getKeysEndpoint(e=!0){return this._getMetadataProperty("jwks_uri",e)}async _getMetadataProperty(e,t=!1){let r=this._logger.create(`_getMetadataProperty('${e}')`),n=await this.getMetadata();if(r.debug("resolved"),void 0===n[e]){if(!0===t)return void r.warn("Metadata does not contain optional property");r.throw(Error("Metadata does not contain property "+e))}return n[e]}async getSigningKeys(){let e=this._logger.create("getSigningKeys");if(this._signingKeys)return e.debug("returning signingKeys from cache"),this._signingKeys;let t=await this.getKeysEndpoint(!1);e.debug("got jwks_uri",t);let r=await this._jsonService.getJson(t,{timeoutInSeconds:this._settings.requestTimeoutInSeconds});if(e.debug("got key set",r),!Array.isArray(r.keys))throw e.throw(Error("Missing keys on keyset")),null;return this._signingKeys=r.keys,this._signingKeys}},I=class{constructor({prefix:e="oidc.",store:t=localStorage}={}){this._logger=new u("WebStorageStateStore"),this._store=t,this._prefix=e}async set(e,t){this._logger.create(`set('${e}')`),e=this._prefix+e,await this._store.setItem(e,t)}async get(e){return this._logger.create(`get('${e}')`),e=this._prefix+e,await this._store.getItem(e)}async remove(e){this._logger.create(`remove('${e}')`),e=this._prefix+e;let t=await this._store.getItem(e);return await this._store.removeItem(e),t}async getAllKeys(){this._logger.create("getAllKeys");let e=await this._store.length,t=[];for(let r=0;r<e;r++){let e=await this._store.key(r);e&&0===e.indexOf(this._prefix)&&t.push(e.substr(this._prefix.length))}return t}},A=class{constructor({authority:e,metadataUrl:t,metadata:r,signingKeys:n,metadataSeed:i,client_id:o,client_secret:a,response_type:s="code",scope:l="openid",redirect_uri:c,post_logout_redirect_uri:d,client_authentication:u="client_secret_post",token_endpoint_auth_signing_alg:h="HS256",prompt:v,display:p,max_age:m,ui_locales:g,acr_values:f,resource:y,response_mode:b,filterProtocolClaims:S=!0,loadUserInfo:_=!1,requestTimeoutInSeconds:w,staleStateAgeInSeconds:T=900,mergeClaimsStrategy:A={array:"replace"},disablePKCE:R=!1,stateStore:C,revokeTokenAdditionalContentTypes:k,fetchRequestCredentials:O,refreshTokenAllowedScope:M,extraQueryParams:P={},extraTokenParams:D={},extraHeaders:x={},dpop:F,omitScopeWhenRequesting:L=!1}){var U;if(this.authority=e,t?this.metadataUrl=t:(this.metadataUrl=e,e&&(this.metadataUrl.endsWith("/")||(this.metadataUrl+="/"),this.metadataUrl+=".well-known/openid-configuration")),this.metadata=r,this.metadataSeed=i,this.signingKeys=n,this.client_id=o,this.client_secret=a,this.response_type=s,this.scope=l,this.redirect_uri=c,this.post_logout_redirect_uri=d,this.client_authentication=u,this.token_endpoint_auth_signing_alg=h,this.prompt=v,this.display=p,this.max_age=m,this.ui_locales=g,this.acr_values=f,this.resource=y,this.response_mode=b,this.filterProtocolClaims=null==S||S,this.loadUserInfo=!!_,this.staleStateAgeInSeconds=T,this.mergeClaimsStrategy=A,this.omitScopeWhenRequesting=L,this.disablePKCE=!!R,this.revokeTokenAdditionalContentTypes=k,this.fetchRequestCredentials=O||"same-origin",this.requestTimeoutInSeconds=w,C)this.stateStore=C;else{let e="undefined"!=typeof window?window.localStorage:new E;this.stateStore=new I({store:e})}if(this.refreshTokenAllowedScope=M,this.extraQueryParams=P,this.extraTokenParams=D,this.extraHeaders=x,this.dpop=F,this.dpop&&!(null==(U=this.dpop)?void 0:U.store))throw Error("A DPoPStore is required when dpop is enabled")}},R=class{constructor(e,t){this._settings=e,this._metadataService=t,this._logger=new u("UserInfoService"),this._getClaimsFromJwt=async e=>{let t=this._logger.create("_getClaimsFromJwt");try{let r=h.decode(e);return t.debug("JWT decoding successful"),r}catch(e){throw t.error("Error parsing JWT response"),e}},this._jsonService=new w(void 0,this._getClaimsFromJwt,this._settings.extraHeaders)}async getClaims(e){let t=this._logger.create("getClaims");e||this._logger.throw(Error("No token passed"));let r=await this._metadataService.getUserInfoEndpoint();t.debug("got userinfo url",r);let n=await this._jsonService.getJson(r,{token:e,credentials:this._settings.fetchRequestCredentials,timeoutInSeconds:this._settings.requestTimeoutInSeconds});return t.debug("got claims",n),n}},C=class{constructor(e,t){this._settings=e,this._metadataService=t,this._logger=new u("TokenClient"),this._jsonService=new w(this._settings.revokeTokenAdditionalContentTypes,null,this._settings.extraHeaders)}async exchangeCode({grant_type:e="authorization_code",redirect_uri:t=this._settings.redirect_uri,client_id:r=this._settings.client_id,client_secret:n=this._settings.client_secret,extraHeaders:i,...o}){let a,s=this._logger.create("exchangeCode");r||s.throw(Error("A client_id is required")),t||s.throw(Error("A redirect_uri is required")),o.code||s.throw(Error("A code is required"));let l=new URLSearchParams({grant_type:e,redirect_uri:t});for(let[e,t]of Object.entries(o))null!=t&&l.set(e,t);if(("client_secret_basic"===this._settings.client_authentication||"client_secret_jwt"===this._settings.client_authentication)&&null==n)throw s.throw(Error("A client_secret is required")),null;let c=await this._metadataService.getTokenEndpoint(!1);switch(this._settings.client_authentication){case"client_secret_basic":a=m.generateBasicAuth(r,n);break;case"client_secret_post":l.append("client_id",r),n&&l.append("client_secret",n);break;case"client_secret_jwt":{let e=await m.generateClientAssertionJwt(r,n,c,this._settings.token_endpoint_auth_signing_alg);l.append("client_id",r),l.append("client_assertion_type","urn:ietf:params:oauth:client-assertion-type:jwt-bearer"),l.append("client_assertion",e)}}s.debug("got token endpoint");let d=await this._jsonService.postForm(c,{body:l,basicAuth:a,timeoutInSeconds:this._settings.requestTimeoutInSeconds,initCredentials:this._settings.fetchRequestCredentials,extraHeaders:i});return s.debug("got response"),d}async exchangeCredentials({grant_type:e="password",client_id:t=this._settings.client_id,client_secret:r=this._settings.client_secret,scope:n=this._settings.scope,...i}){let o,a=this._logger.create("exchangeCredentials");t||a.throw(Error("A client_id is required"));let s=new URLSearchParams({grant_type:e});for(let[e,t]of(this._settings.omitScopeWhenRequesting||s.set("scope",n),Object.entries(i)))null!=t&&s.set(e,t);if(("client_secret_basic"===this._settings.client_authentication||"client_secret_jwt"===this._settings.client_authentication)&&null==r)throw a.throw(Error("A client_secret is required")),null;let l=await this._metadataService.getTokenEndpoint(!1);switch(this._settings.client_authentication){case"client_secret_basic":o=m.generateBasicAuth(t,r);break;case"client_secret_post":s.append("client_id",t),r&&s.append("client_secret",r);break;case"client_secret_jwt":{let e=await m.generateClientAssertionJwt(t,r,l,this._settings.token_endpoint_auth_signing_alg);s.append("client_id",t),s.append("client_assertion_type","urn:ietf:params:oauth:client-assertion-type:jwt-bearer"),s.append("client_assertion",e)}}a.debug("got token endpoint");let c=await this._jsonService.postForm(l,{body:s,basicAuth:o,timeoutInSeconds:this._settings.requestTimeoutInSeconds,initCredentials:this._settings.fetchRequestCredentials});return a.debug("got response"),c}async exchangeRefreshToken({grant_type:e="refresh_token",client_id:t=this._settings.client_id,client_secret:r=this._settings.client_secret,timeoutInSeconds:n,extraHeaders:i,...o}){let a,s=this._logger.create("exchangeRefreshToken");t||s.throw(Error("A client_id is required")),o.refresh_token||s.throw(Error("A refresh_token is required"));let l=new URLSearchParams({grant_type:e});for(let[e,t]of Object.entries(o))Array.isArray(t)?t.forEach(t=>l.append(e,t)):null!=t&&l.set(e,t);if(("client_secret_basic"===this._settings.client_authentication||"client_secret_jwt"===this._settings.client_authentication)&&null==r)throw s.throw(Error("A client_secret is required")),null;let c=await this._metadataService.getTokenEndpoint(!1);switch(this._settings.client_authentication){case"client_secret_basic":a=m.generateBasicAuth(t,r);break;case"client_secret_post":l.append("client_id",t),r&&l.append("client_secret",r);break;case"client_secret_jwt":{let e=await m.generateClientAssertionJwt(t,r,c,this._settings.token_endpoint_auth_signing_alg);l.append("client_id",t),l.append("client_assertion_type","urn:ietf:params:oauth:client-assertion-type:jwt-bearer"),l.append("client_assertion",e)}}s.debug("got token endpoint");let d=await this._jsonService.postForm(c,{body:l,basicAuth:a,timeoutInSeconds:n,initCredentials:this._settings.fetchRequestCredentials,extraHeaders:i});return s.debug("got response"),d}async revoke(e){var t;let r=this._logger.create("revoke");e.token||r.throw(Error("A token is required"));let n=await this._metadataService.getRevocationEndpoint(!1);r.debug(`got revocation endpoint, revoking ${null!=(t=e.token_type_hint)?t:"default token type"}`);let i=new URLSearchParams;for(let[t,r]of Object.entries(e))null!=r&&i.set(t,r);i.set("client_id",this._settings.client_id),this._settings.client_secret&&i.set("client_secret",this._settings.client_secret),await this._jsonService.postForm(n,{body:i,timeoutInSeconds:this._settings.requestTimeoutInSeconds}),r.debug("got response")}},k=class{constructor(e,t,r){this._settings=e,this._metadataService=t,this._claimsService=r,this._logger=new u("ResponseValidator"),this._userInfoService=new R(this._settings,this._metadataService),this._tokenClient=new C(this._settings,this._metadataService)}async validateSigninResponse(e,t,r){let n=this._logger.create("validateSigninResponse");this._processSigninState(e,t),n.debug("state processed"),await this._processCode(e,t,r),n.debug("code processed"),e.isOpenId&&this._validateIdTokenAttributes(e),n.debug("tokens validated"),await this._processClaims(e,null==t?void 0:t.skipUserInfo,e.isOpenId),n.debug("claims processed")}async validateCredentialsResponse(e,t){let r=this._logger.create("validateCredentialsResponse"),n=e.isOpenId&&!!e.id_token;n&&this._validateIdTokenAttributes(e),r.debug("tokens validated"),await this._processClaims(e,t,n),r.debug("claims processed")}async validateRefreshResponse(e,t){let r=this._logger.create("validateRefreshResponse");e.userState=t.data,null!=e.session_state||(e.session_state=t.session_state),null!=e.scope||(e.scope=t.scope),e.isOpenId&&e.id_token&&(this._validateIdTokenAttributes(e,t.id_token),r.debug("ID Token validated")),e.id_token||(e.id_token=t.id_token,e.profile=t.profile);let n=e.isOpenId&&!!e.id_token;await this._processClaims(e,!1,n),r.debug("claims processed")}validateSignoutResponse(e,t){let r=this._logger.create("validateSignoutResponse");if(t.id!==e.state&&r.throw(Error("State does not match")),r.debug("state validated"),e.userState=t.data,e.error)throw r.warn("Response was error",e.error),new b(e)}_processSigninState(e,t){let r=this._logger.create("_processSigninState");if(t.id!==e.state&&r.throw(Error("State does not match")),t.client_id||r.throw(Error("No client_id on state")),t.authority||r.throw(Error("No authority on state")),this._settings.authority!==t.authority&&r.throw(Error("authority mismatch on settings vs. signin state")),this._settings.client_id&&this._settings.client_id!==t.client_id&&r.throw(Error("client_id mismatch on settings vs. signin state")),r.debug("state validated"),e.userState=t.data,e.url_state=t.url_state,null!=e.scope||(e.scope=t.scope),e.error)throw r.warn("Response was error",e.error),new b(e);t.code_verifier&&!e.code&&r.throw(Error("Expected code in response"))}async _processClaims(e,t=!1,r=!0){let n=this._logger.create("_processClaims");if(e.profile=this._claimsService.filterProtocolClaims(e.profile),t||!this._settings.loadUserInfo||!e.access_token)return void n.debug("not loading user info");n.debug("loading user info");let i=await this._userInfoService.getClaims(e.access_token);n.debug("user info claims received from user info endpoint"),r&&i.sub!==e.profile.sub&&n.throw(Error("subject from UserInfo response does not match subject in ID Token")),e.profile=this._claimsService.mergeClaims(e.profile,this._claimsService.filterProtocolClaims(i)),n.debug("user info claims received, updated profile:",e.profile)}async _processCode(e,t,r){let n=this._logger.create("_processCode");if(e.code){n.debug("Validating code");let i=await this._tokenClient.exchangeCode({client_id:t.client_id,client_secret:t.client_secret,code:e.code,redirect_uri:t.redirect_uri,code_verifier:t.code_verifier,extraHeaders:r,...t.extraTokenParams});Object.assign(e,i)}else n.debug("No code to process")}_validateIdTokenAttributes(e,t){var r;let n=this._logger.create("_validateIdTokenAttributes");n.debug("decoding ID Token JWT");let i=h.decode(null!=(r=e.id_token)?r:"");if(i.sub||n.throw(Error("ID Token is missing a subject claim")),t){let e=h.decode(t);i.sub!==e.sub&&n.throw(Error("sub in id_token does not match current sub")),i.auth_time&&i.auth_time!==e.auth_time&&n.throw(Error("auth_time in id_token does not match original auth_time")),i.azp&&i.azp!==e.azp&&n.throw(Error("azp in id_token does not match original azp")),!i.azp&&e.azp&&n.throw(Error("azp not in id_token, but present in original id_token"))}e.profile=i}},O=class e{constructor(e){this.id=e.id||m.generateUUIDv4(),this.data=e.data,e.created&&e.created>0?this.created=e.created:this.created=f.getEpochTime(),this.request_type=e.request_type,this.url_state=e.url_state}toStorageString(){return new u("State").create("toStorageString"),JSON.stringify({id:this.id,data:this.data,created:this.created,request_type:this.request_type,url_state:this.url_state})}static fromStorageString(t){return u.createStatic("State","fromStorageString"),Promise.resolve(new e(JSON.parse(t)))}static async clearStaleState(t,r){let n=u.createStatic("State","clearStaleState"),i=f.getEpochTime()-r,o=await t.getAllKeys();n.debug("got keys",o);for(let r=0;r<o.length;r++){let a=o[r],s=await t.get(a),l=!1;if(s)try{let t=await e.fromStorageString(s);n.debug("got item from key:",a,t.created),t.created<=i&&(l=!0)}catch(e){n.error("Error parsing state for key:",a,e),l=!0}else n.debug("no item in storage for key:",a),l=!0;l&&(n.debug("removed item for key:",a),t.remove(a))}}},M=class e extends O{constructor(e){super(e),this.code_verifier=e.code_verifier,this.code_challenge=e.code_challenge,this.authority=e.authority,this.client_id=e.client_id,this.redirect_uri=e.redirect_uri,this.scope=e.scope,this.client_secret=e.client_secret,this.extraTokenParams=e.extraTokenParams,this.response_mode=e.response_mode,this.skipUserInfo=e.skipUserInfo}static async create(t){let r=!0===t.code_verifier?m.generateCodeVerifier():t.code_verifier||void 0,n=r?await m.generateCodeChallenge(r):void 0;return new e({...t,code_verifier:r,code_challenge:n})}toStorageString(){return new u("SigninState").create("toStorageString"),JSON.stringify({id:this.id,data:this.data,created:this.created,request_type:this.request_type,url_state:this.url_state,code_verifier:this.code_verifier,authority:this.authority,client_id:this.client_id,redirect_uri:this.redirect_uri,scope:this.scope,client_secret:this.client_secret,extraTokenParams:this.extraTokenParams,response_mode:this.response_mode,skipUserInfo:this.skipUserInfo})}static fromStorageString(t){u.createStatic("SigninState","fromStorageString");let r=JSON.parse(t);return e.create(r)}},P=class e{constructor(e){this.url=e.url,this.state=e.state}static async create({url:t,authority:r,client_id:n,redirect_uri:i,response_type:o,scope:a,state_data:s,response_mode:l,request_type:c,client_secret:d,nonce:u,url_state:h,resource:v,skipUserInfo:p,extraQueryParams:m,extraTokenParams:g,disablePKCE:f,dpopJkt:y,omitScopeWhenRequesting:b,...S}){if(!t)throw this._logger.error("create: No url passed"),Error("url");if(!n)throw this._logger.error("create: No client_id passed"),Error("client_id");if(!i)throw this._logger.error("create: No redirect_uri passed"),Error("redirect_uri");if(!o)throw this._logger.error("create: No response_type passed"),Error("response_type");if(!a)throw this._logger.error("create: No scope passed"),Error("scope");if(!r)throw this._logger.error("create: No authority passed"),Error("authority");let E=await M.create({data:s,request_type:c,url_state:h,code_verifier:!f,client_id:n,authority:r,redirect_uri:i,response_mode:l,client_secret:d,scope:a,extraTokenParams:g,skipUserInfo:p}),_=new URL(t);_.searchParams.append("client_id",n),_.searchParams.append("redirect_uri",i),_.searchParams.append("response_type",o),b||_.searchParams.append("scope",a),u&&_.searchParams.append("nonce",u),y&&_.searchParams.append("dpop_jkt",y);let w=E.id;for(let[e,t]of(h&&(w=`${w};${h}`),_.searchParams.append("state",w),E.code_challenge&&(_.searchParams.append("code_challenge",E.code_challenge),_.searchParams.append("code_challenge_method","S256")),v&&(Array.isArray(v)?v:[v]).forEach(e=>_.searchParams.append("resource",e)),Object.entries({response_mode:l,...S,...m})))null!=t&&_.searchParams.append(e,t.toString());return new e({url:_.href,state:E})}};P._logger=new u("SigninRequest");var D=class{constructor(e){if(this.access_token="",this.token_type="",this.profile={},this.state=e.get("state"),this.session_state=e.get("session_state"),this.state){let e=decodeURIComponent(this.state).split(";");this.state=e[0],e.length>1&&(this.url_state=e.slice(1).join(";"))}this.error=e.get("error"),this.error_description=e.get("error_description"),this.error_uri=e.get("error_uri"),this.code=e.get("code")}get expires_in(){if(void 0!==this.expires_at)return this.expires_at-f.getEpochTime()}set expires_in(e){"string"==typeof e&&(e=Number(e)),void 0!==e&&e>=0&&(this.expires_at=Math.floor(e)+f.getEpochTime())}get isOpenId(){var e;return(null==(e=this.scope)?void 0:e.split(" ").includes("openid"))||!!this.id_token}},x=class{constructor({url:e,state_data:t,id_token_hint:r,post_logout_redirect_uri:n,extraQueryParams:i,request_type:o,client_id:a,url_state:s}){if(this._logger=new u("SignoutRequest"),!e)throw this._logger.error("ctor: No url passed"),Error("url");let l=new URL(e);if(r&&l.searchParams.append("id_token_hint",r),a&&l.searchParams.append("client_id",a),n&&(l.searchParams.append("post_logout_redirect_uri",n),t||s)){this.state=new O({data:t,request_type:o,url_state:s});let e=this.state.id;s&&(e=`${e};${s}`),l.searchParams.append("state",e)}for(let[e,t]of Object.entries({...i}))null!=t&&l.searchParams.append(e,t.toString());this.url=l.href}},F=class{constructor(e){if(this.state=e.get("state"),this.state){let e=decodeURIComponent(this.state).split(";");this.state=e[0],e.length>1&&(this.url_state=e.slice(1).join(";"))}this.error=e.get("error"),this.error_description=e.get("error_description"),this.error_uri=e.get("error_uri")}},L=["nbf","jti","auth_time","nonce","acr","amr","azp","at_hash"],U=["sub","iss","aud","exp","iat"],N=class{constructor(e){this._settings=e,this._logger=new u("ClaimsService")}filterProtocolClaims(e){let t={...e};if(this._settings.filterProtocolClaims){for(let e of Array.isArray(this._settings.filterProtocolClaims)?this._settings.filterProtocolClaims:L)U.includes(e)||delete t[e]}return t}mergeClaims(e,t){let r={...e};for(let[e,n]of Object.entries(t))if(r[e]!==n)if(Array.isArray(r[e])||Array.isArray(n))if("replace"==this._settings.mergeClaimsStrategy.array)r[e]=n;else{let t=Array.isArray(r[e])?r[e]:[r[e]];for(let e of Array.isArray(n)?n:[n])t.includes(e)||t.push(e);r[e]=t}else"object"==typeof r[e]&&"object"==typeof n?r[e]=this.mergeClaims(r[e],n):r[e]=n;return r}},j=class{constructor(e,t){this.keys=e,this.nonce=t}},B=class{constructor(e,t){this._logger=new u("OidcClient"),this.settings=e instanceof A?e:new A(e),this.metadataService=null!=t?t:new T(this.settings),this._claimsService=new N(this.settings),this._validator=new k(this.settings,this.metadataService,this._claimsService),this._tokenClient=new C(this.settings,this.metadataService)}async createSigninRequest({state:e,request:t,request_uri:r,request_type:n,id_token_hint:i,login_hint:o,skipUserInfo:a,nonce:s,url_state:l,response_type:c=this.settings.response_type,scope:d=this.settings.scope,redirect_uri:u=this.settings.redirect_uri,prompt:h=this.settings.prompt,display:v=this.settings.display,max_age:p=this.settings.max_age,ui_locales:m=this.settings.ui_locales,acr_values:g=this.settings.acr_values,resource:f=this.settings.resource,response_mode:y=this.settings.response_mode,extraQueryParams:b=this.settings.extraQueryParams,extraTokenParams:S=this.settings.extraTokenParams,dpopJkt:E,omitScopeWhenRequesting:_=this.settings.omitScopeWhenRequesting}){let w=this._logger.create("createSigninRequest");if("code"!==c)throw Error("Only the Authorization Code flow (with PKCE) is supported");let T=await this.metadataService.getAuthorizationEndpoint();w.debug("Received authorization endpoint",T);let I=await P.create({url:T,authority:this.settings.authority,client_id:this.settings.client_id,redirect_uri:u,response_type:c,scope:d,state_data:e,url_state:l,prompt:h,display:v,max_age:p,ui_locales:m,id_token_hint:i,login_hint:o,acr_values:g,dpopJkt:E,resource:f,request:t,request_uri:r,extraQueryParams:b,extraTokenParams:S,request_type:n,response_mode:y,client_secret:this.settings.client_secret,skipUserInfo:a,nonce:s,disablePKCE:this.settings.disablePKCE,omitScopeWhenRequesting:_});await this.clearStaleState();let A=I.state;return await this.settings.stateStore.set(A.id,A.toStorageString()),I}async readSigninResponseState(e,t=!1){let r=this._logger.create("readSigninResponseState"),n=new D(y.readParams(e,this.settings.response_mode));if(!n.state)throw r.throw(Error("No state in response")),null;let i=await this.settings.stateStore[t?"remove":"get"](n.state);if(!i)throw r.throw(Error("No matching state found in storage")),null;return{state:await M.fromStorageString(i),response:n}}async processSigninResponse(e,t,r=!0){let n=this._logger.create("processSigninResponse"),{state:i,response:o}=await this.readSigninResponseState(e,r);if(n.debug("received state from storage; validating response"),this.settings.dpop&&this.settings.dpop.store){let e=await this.getDpopProof(this.settings.dpop.store);t={...t,DPoP:e}}try{await this._validator.validateSigninResponse(o,i,t)}catch(e){if(e instanceof _&&this.settings.dpop){let r=await this.getDpopProof(this.settings.dpop.store,e.nonce);t.DPoP=r,await this._validator.validateSigninResponse(o,i,t)}else throw e}return o}async getDpopProof(e,t){let r;return(await e.getAllKeys()).includes(this.settings.client_id)?(r=await e.get(this.settings.client_id)).nonce!==t&&t&&(r.nonce=t,await e.set(this.settings.client_id,r)):(r=new j(await m.generateDPoPKeys(),t),await e.set(this.settings.client_id,r)),await m.generateDPoPProof({url:await this.metadataService.getTokenEndpoint(!1),httpMethod:"POST",keyPair:r.keys,nonce:r.nonce})}async processResourceOwnerPasswordCredentials({username:e,password:t,skipUserInfo:r=!1,extraTokenParams:n={}}){let i=await this._tokenClient.exchangeCredentials({username:e,password:t,...n}),o=new D(new URLSearchParams);return Object.assign(o,i),await this._validator.validateCredentialsResponse(o,r),o}async useRefreshToken({state:e,redirect_uri:t,resource:r,timeoutInSeconds:n,extraHeaders:i,extraTokenParams:o}){var a;let s,l,c=this._logger.create("useRefreshToken");if(void 0===this.settings.refreshTokenAllowedScope)s=e.scope;else{let t=this.settings.refreshTokenAllowedScope.split(" ");s=((null==(a=e.scope)?void 0:a.split(" "))||[]).filter(e=>t.includes(e)).join(" ")}if(this.settings.dpop&&this.settings.dpop.store){let e=await this.getDpopProof(this.settings.dpop.store);i={...i,DPoP:e}}try{l=await this._tokenClient.exchangeRefreshToken({refresh_token:e.refresh_token,scope:s,redirect_uri:t,resource:r,timeoutInSeconds:n,extraHeaders:i,...o})}catch(a){if(a instanceof _&&this.settings.dpop)i.DPoP=await this.getDpopProof(this.settings.dpop.store,a.nonce),l=await this._tokenClient.exchangeRefreshToken({refresh_token:e.refresh_token,scope:s,redirect_uri:t,resource:r,timeoutInSeconds:n,extraHeaders:i,...o});else throw a}let d=new D(new URLSearchParams);return Object.assign(d,l),c.debug("validating response",d),await this._validator.validateRefreshResponse(d,{...e,scope:s}),d}async createSignoutRequest({state:e,id_token_hint:t,client_id:r,request_type:n,url_state:i,post_logout_redirect_uri:o=this.settings.post_logout_redirect_uri,extraQueryParams:a=this.settings.extraQueryParams}={}){let s=this._logger.create("createSignoutRequest"),l=await this.metadataService.getEndSessionEndpoint();if(!l)throw s.throw(Error("No end session endpoint")),null;s.debug("Received end session endpoint",l),r||!o||t||(r=this.settings.client_id);let c=new x({url:l,id_token_hint:t,client_id:r,post_logout_redirect_uri:o,state_data:e,extraQueryParams:a,request_type:n,url_state:i});await this.clearStaleState();let d=c.state;return d&&(s.debug("Signout request has state to persist"),await this.settings.stateStore.set(d.id,d.toStorageString())),c}async readSignoutResponseState(e,t=!1){let r=this._logger.create("readSignoutResponseState"),n=new F(y.readParams(e,this.settings.response_mode));if(!n.state){if(r.debug("No state in response"),n.error)throw r.warn("Response was error:",n.error),new b(n);return{state:void 0,response:n}}let i=await this.settings.stateStore[t?"remove":"get"](n.state);if(!i)throw r.throw(Error("No matching state found in storage")),null;return{state:await O.fromStorageString(i),response:n}}async processSignoutResponse(e){let t=this._logger.create("processSignoutResponse"),{state:r,response:n}=await this.readSignoutResponseState(e,!0);return r?(t.debug("Received state from storage; validating response"),this._validator.validateSignoutResponse(n,r)):t.debug("No state from storage; skipping response validation"),n}clearStaleState(){return this._logger.create("clearStaleState"),O.clearStaleState(this.settings.stateStore,this.settings.staleStateAgeInSeconds)}async revokeToken(e,t){return this._logger.create("revokeToken"),await this._tokenClient.revoke({token:e,token_type_hint:t})}},W=r(5408),K=r(5862),q=function(e){return e.NotSupported="OIDC authentication not supported",e.Misconfigured="OIDC is misconfigured",e.General="Something went wrong with OIDC discovery",e.OpSupport="Configured OIDC OP does not support required functions",e.DynamicRegistrationNotSupported="Dynamic registration not supported",e.DynamicRegistrationFailed="Dynamic registration failed",e.DynamicRegistrationInvalid="Dynamic registration invalid response",e.CodeExchangeFailed="Failed to exchange code for token",e.InvalidBearerTokenResponse="Invalid bearer token response",e.InvalidIdToken="Invalid ID token",e.MissingOrInvalidStoredState="State required to finish logging in is not found in storage.",e}({}),V=e=>!!e&&"object"==typeof e&&!Array.isArray(e),H=(e,t)=>!!e[t]&&!!G(e,t)||(W.vF.error("Missing or invalid property: ".concat(t)),!1),G=(e,t)=>!e[t]||"string"==typeof e[t]||(W.vF.error("Invalid property: ".concat(t)),!1),J=(e,t)=>!e[t]||!!Array.isArray(e[t])&&!!e[t].every(e=>"string"==typeof e)||(W.vF.error("Invalid property: ".concat(t)),!1),z=(e,t,r)=>{var n=e[t];return!!n&&!!Array.isArray(n)&&!!n.includes(r)||(W.vF.error("Invalid property: ".concat(t,". ").concat(r," is required.")),!1)},Y=e=>{if(!V(e))throw W.vF.error("Issuer configuration not found or malformed"),Error(q.OpSupport);if(![H(e,"issuer"),H(e,"authorization_endpoint"),H(e,"token_endpoint"),H(e,"revocation_endpoint"),G(e,"registration_endpoint"),G(e,"account_management_uri"),G(e,"device_authorization_endpoint"),J(e,"account_management_actions_supported"),z(e,"response_types_supported","code"),z(e,"grant_types_supported",em.AuthorizationCode),z(e,"code_challenge_methods_supported","S256"),J(e,"prompt_values_supported")].some(e=>!e))return e;throw W.vF.error("Issuer configuration not valid"),Error(q.OpSupport)},X=e=>{try{return l(e)}catch(e){throw W.vF.error("Could not decode id_token",e),e}},$=(e,t,r,n)=>{try{if(!e)throw Error("No ID token");var i=X(e);if(i.iss!==t)throw Error("Invalid issuer");if(!("string"==typeof i.aud?[i.aud]:i.aud).includes(r))throw Error("Invalid audience");if(void 0!==n&&i.nonce!==n)throw Error("Invalid nonce");if(!i.exp||Date.now()>1e3*i.exp)throw Error("Invalid expiry")}catch(e){throw W.vF.error("Invalid ID token",e),Error(q.InvalidIdToken)}};function Q(e){if(!V(e))throw W.vF.error("Stored user state not found"),Error(q.MissingOrInvalidStoredState);if([H(e,"homeserverUrl"),H(e,"nonce"),G(e,"identityServerUrl")].some(e=>!e))throw Error(q.MissingOrInvalidStoredState)}function Z(e){if(!(V(e)&&H(e,"token_type")&&"bearer"===e.token_type.toLowerCase()&&H(e,"access_token")&&H(e,"refresh_token")&&(!("expires_in"in e)||"number"==typeof e.expires_in)))throw Error(q.InvalidBearerTokenResponse)}var ee=r(20748),et=r(35095);function er(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function en(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?er(Object(r),!0).forEach(function(t){(0,o.A)(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):er(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}var ei=e=>{var t=null!=e?e:(0,K.US)(10);return"openid urn:matrix:org.matrix.msc2967.client:api:* urn:matrix:org.matrix.msc2967.client:device:".concat(t)},eo=function(){var e=(0,a.A)(function*(e){if(!globalThis.crypto.subtle)return W.vF.warn("A secure context is required to generate code challenge. Using plain text code challenge"),e;var t=yield(0,ee.s)(e);return(0,et.A4)(t)});return function(t){return e.apply(this,arguments)}}(),ea=e=>{var{redirectUri:t}=e;return{scope:ei(),redirectUri:t,state:(0,K.US)(8),nonce:(0,K.US)(8),codeVerifier:(0,K.US)(64)}},es=function(){var e=(0,a.A)(function*(e,t,r){var{scope:n,redirectUri:i,state:o,nonce:a,codeVerifier:s}=r,l=new URL(e);return l.searchParams.append("response_mode","query"),l.searchParams.append("response_type","code"),l.searchParams.append("redirect_uri",i),l.searchParams.append("client_id",t),l.searchParams.append("state",o),l.searchParams.append("scope",n),l.searchParams.append("nonce",a),l.searchParams.append("code_challenge_method","S256"),l.searchParams.append("code_challenge",(yield eo(s))),l.toString()});return function(t,r,n){return e.apply(this,arguments)}}(),el=function(){var e=(0,a.A)(function*(e){var{metadata:t,redirectUri:r,clientId:n,homeserverUrl:i,identityServerUrl:o,nonce:a,prompt:s,urlState:l,loginHint:c}=e,d=ei(),u=new B(en(en({},t),{},{client_id:n,redirect_uri:r,authority:t.issuer,response_mode:"query",response_type:"code",scope:d,stateStore:new I({prefix:"mx_oidc_",store:window.sessionStorage})}));return(yield u.createSigninRequest({state:{homeserverUrl:i,nonce:a,identityServerUrl:o},nonce:a,prompt:s,url_state:l,login_hint:c})).url});return function(t){return e.apply(this,arguments)}}(),ec=function(){var e=(0,a.A)(function*(e,t){var r=new URL(window.location.origin);r.searchParams.append("code",e),r.searchParams.append("state",t),d.setLogger(W.vF);try{var n=new D(r.searchParams),i=new I({prefix:"mx_oidc_",store:window.sessionStorage}),o=yield i.get(n.state);if(!o)throw Error(q.MissingOrInvalidStoredState);var a=yield M.fromStorageString(o),s=new B(en(en({},a),{},{stateStore:i})),l=yield s.processSigninResponse(r.href),c=l.userState;Q(c),Z(l),$(l.id_token,s.settings.authority,s.settings.client_id,c.nonce);var u={id_token:l.id_token,scope:l.scope,expires_at:l.expires_at,refresh_token:l.refresh_token,access_token:l.access_token,token_type:"Bearer"};return{oidcClientSettings:{clientId:s.settings.client_id,issuer:s.settings.authority},tokenResponse:u,homeserverUrl:c.homeserverUrl,identityServerUrl:c.identityServerUrl,idTokenClaims:l.profile}}catch(e){W.vF.error("Oidc login failed",e);var h=e.message;if(Object.values(q).includes(h))throw e;throw Error(q.CodeExchangeFailed)}});return function(t,r){return e.apply(this,arguments)}}(),ed=r(36963);function eu(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function eh(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?eu(Object(r),!0).forEach(function(t){(0,o.A)(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):eu(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}var ev=function(){var e=(0,a.A)(function*(e){var t=new URL(".well-known/openid-configuration",e),r=yield fetch(t,{method:ed.IT.Get,signal:(0,ed._)(5e3)});return ep((yield r.json()))});return function(t){return e.apply(this,arguments)}}(),ep=function(){var e=(0,a.A)(function*(e){var t=Y(e),r=new T(new A({authority:t.issuer,metadata:t,redirect_uri:"",client_id:""}));return eh(eh({},t),{},{signingKeys:yield r.getSigningKeys()})});return function(t){return e.apply(this,arguments)}}(),em=function(e){return e.AuthorizationCode="authorization_code",e.RefreshToken="refresh_token",e.DeviceAuthorization="urn:ietf:params:oauth:grant-type:device_code",e}({}),eg=em.DeviceAuthorization,ef=(e,t)=>{if(!t)return!1;var r=new URL(t);return r.protocol===e.protocol&&(r.hostname===e.hostname||!!r.hostname.endsWith(".".concat(e.hostname)))},ey=function(){var e=(0,a.A)(function*(e,t){if(!e.registration_endpoint)throw Error(q.DynamicRegistrationNotSupported);var r=[em.AuthorizationCode,em.RefreshToken];if(r.some(t=>!e.grant_types_supported.includes(t)))throw Error(q.DynamicRegistrationNotSupported);var n=new URL(t.clientUri),i={client_name:t.clientName,client_uri:t.clientUri,response_types:["code"],grant_types:r,redirect_uris:t.redirectUris,id_token_signed_response_alg:"RS256",token_endpoint_auth_method:"none",application_type:t.applicationType,contacts:t.contacts,logo_uri:ef(n,t.logoUri)?t.logoUri:void 0,policy_uri:ef(n,t.policyUri)?t.policyUri:void 0,tos_uri:ef(n,t.tosUri)?t.tosUri:void 0};try{var o=yield fetch(e.registration_endpoint,{method:ed.IT.Post,headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(i)});if(o.status>=400)throw Error(q.DynamicRegistrationFailed);var a=(yield o.json()).client_id;if(!a||"string"!=typeof a)throw Error(q.DynamicRegistrationInvalid);return a}catch(e){if(Object.values(q).includes(e.message))throw e;throw W.vF.error("Dynamic registration request failed",e),Error(q.DynamicRegistrationFailed)}});return function(t,r){return e.apply(this,arguments)}}();class eb{constructor(e,t,r,n,i){this.issuer=e,this.clientId=t,this.redirectUri=r,this.deviceId=n,this.idTokenClaims=i,(0,o.A)(this,"oidcClientReady",void 0),(0,o.A)(this,"initPromise",void 0),(0,o.A)(this,"oidcClient",void 0),(0,o.A)(this,"inflightRefreshRequest",void 0),this.oidcClientReady=Promise.resolve()}ensureInit(){var e=this;return(0,a.A)(function*(){if(!e.oidcClient){if(e.initPromise)return e.initPromise;e.initPromise=e.initialiseOidcClient(e.issuer,e.clientId,e.deviceId,e.redirectUri);try{yield e.initPromise}finally{e.initPromise=void 0}}})()}initialiseOidcClient(e,t,r,n){var i=this;return(0,a.A)(function*(){try{var o,a=yield ev(e),s=ei(r);i.oidcClient=new B({metadata:a,signingKeys:null!=(o=a.signingKeys)?o:void 0,client_id:t,scope:s,redirect_uri:n,authority:a.issuer,stateStore:new I({prefix:"mx_oidc_",store:window.sessionStorage})})}catch(e){throw W.vF.error("Failed to initialise OIDC client.",e),Error("Failed to initialise OIDC client.")}})()}doRefreshAccessToken(e){var t=this;return(0,a.A)(function*(){yield t.ensureInit(),t.inflightRefreshRequest||(t.inflightRefreshRequest=t.getNewTokens(e));try{return yield t.inflightRefreshRequest}catch(e){if(e instanceof b)throw new ed.DW(e);throw e}finally{t.inflightRefreshRequest=void 0}})()}persistTokens(e){return(0,a.A)(function*(){})()}getNewTokens(e){var t=this;return(0,a.A)(function*(){if(!t.oidcClient)throw Error("Cannot get new token before OIDC client is initialised.");var r={refresh_token:e,session_state:"test",data:void 0,profile:t.idTokenClaims},n=Date.now(),i=yield t.oidcClient.useRefreshToken({state:r,timeoutInSeconds:300}),o={accessToken:i.access_token,refreshToken:i.refresh_token,expiry:i.expires_in?new Date(n+1e3*i.expires_in):void 0};return yield t.persistTokens(o),o})()}}},26600:e=>{var t=e.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(e){return e.encoding?"rtpmap:%d %s/%s/%s":e.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(e){return null!=e.address?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(e){return null!=e.subtype?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(e){return"extmap:%d"+(e.direction?"/%s":"%v")+(e["encrypt-uri"]?" %s":"%v")+" %s"+(e.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(e){return null!=e.sessionConfig?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{push:"msid",reg:/^msid:([\w-]+)(?: ([\w-]+))?/,names:["id","appdata"],format:"msid:%s %s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(e){var t="candidate:%s %d %s %d %s %d typ %s";return t+=(null!=e.raddr?" raddr %s rport %d":"%v%v")+(null!=e.tcptype?" tcptype %s":"%v"),null!=e.generation&&(t+=" generation %d"),t+=(null!=e["network-id"]?" network-id %d":"%v")+(null!=e["network-cost"]?" network-cost %d":"%v")}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(e){var t="ssrc:%d";return null!=e.attribute&&(t+=" %s",null!=e.value&&(t+=":%s")),t}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(e){return null!=e.maxMessageSize?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(e){return e.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(e){return"imageattr:%s %s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast",reg:RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(e){return"simulcast:%s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(e){return"ts-refclk:%s"+(null!=e.clksrcExt?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(e){var t="mediaclk:";return t+((null!=e.id?"id=%s %s":"%v%s")+(null!=e.mediaClockValue?"=%s":"")+(null!=e.rateNumerator?" rate=%s":"")+(null!=e.rateDenominator?"/%s":""))}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};Object.keys(t).forEach(function(e){t[e].forEach(function(e){e.reg||(e.reg=/(.*)/),e.format||(e.format="%s")})})},26912:(e,t,r)=>{"use strict";r.d(t,{A:()=>n});let n=(0,r(81551).A)("Shield",[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}]])},26954:(e,t,r)=>{"use strict";r.d(t,{g:()=>i});var n=function(e){return e.RoomId="room_id",e.Sender="sender",e}(n||{}),i=function(e){return e.Recent="recent",e.Rank="rank",e}({})},29301:(e,t,r)=>{"use strict";function n(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(e){return void r(e)}s.done?t(l):Promise.resolve(l).then(n,i)}function i(e){return function(){var t=this,r=arguments;return new Promise(function(i,o){var a=e.apply(t,r);function s(e){n(a,i,o,s,l,"next",e)}function l(e){n(a,i,o,s,l,"throw",e)}s(void 0)})}}r.d(t,{A:()=>i})},29927:(e,t,r)=>{"use strict";r.d(t,{H:()=>b,f:()=>y});var n=r(29301),i=r(84458),o=r(59741),a=r(5408),s=r(11749),l=r(9086),c=r(82393),d=r(84656),u=r(15095),h=r(47511),v=r(75525),p=r(12922),m=r(5294),g=["1","2","3","4","5","6","7","8","9","10","11"],f=function(e){return e[e.NotStarted=0]="NotStarted",e[e.InProgress=1]="InProgress",e[e.Finished=2]="Finished",e}(f||{}),y=function(e){return e.Events="RoomState.events",e.Members="RoomState.members",e.NewMember="RoomState.newMember",e.Update="RoomState.update",e.BeaconLiveness="RoomState.BeaconLiveness",e.Marker="RoomState.Marker",e}({});class b extends u.X{constructor(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{status:f.NotStarted};super(),this.roomId=e,this.oobMemberFlags=t,(0,i.A)(this,"reEmitter",new v.Q(this)),(0,i.A)(this,"sentinels",{}),(0,i.A)(this,"displayNameToUserIds",new Map),(0,i.A)(this,"userIdsToDisplayNames",{}),(0,i.A)(this,"tokenToInvite",{}),(0,i.A)(this,"joinedMemberCount",null),(0,i.A)(this,"summaryJoinedMemberCount",null),(0,i.A)(this,"invitedMemberCount",null),(0,i.A)(this,"summaryInvitedMemberCount",null),(0,i.A)(this,"modified",-1),(0,i.A)(this,"members",{}),(0,i.A)(this,"events",new Map),(0,i.A)(this,"paginationToken",null),(0,i.A)(this,"beacons",new Map),(0,i.A)(this,"_liveBeaconIds",[]),(0,i.A)(this,"getVersionWarning",!1),this.updateModifiedTime()}getRoomVersion(){var e,t=this.getStateEvents(l.Bx.RoomCreate,"");return t?null!=(e=t.getContent().room_version)?e:"1":(this.getVersionWarning||(a.vF.warn("[getVersion] Room "+this.roomId+" does not have an m.room.create event"),this.getVersionWarning=!0),"1")}getJoinedMemberCount(){return null!==this.summaryJoinedMemberCount?this.summaryJoinedMemberCount:(null===this.joinedMemberCount&&(this.joinedMemberCount=this.getMembers().reduce((e,t)=>t.membership===m.O.Join?e+1:e,0)),this.joinedMemberCount)}setJoinedMemberCount(e){this.summaryJoinedMemberCount=e}getInvitedMemberCount(){return null!==this.summaryInvitedMemberCount?this.summaryInvitedMemberCount:(null===this.invitedMemberCount&&(this.invitedMemberCount=this.getMembers().reduce((e,t)=>t.membership===m.O.Invite?e+1:e,0)),this.invitedMemberCount)}setInvitedMemberCount(e){this.summaryInvitedMemberCount=e}getMembers(){return Object.values(this.members)}getMembersExcept(e){return this.getMembers().filter(t=>!e.includes(t.userId))}getMember(e){return this.members[e]||null}getSentinelMember(e){if(!e)return null;var t=this.sentinels[e];if(void 0===t){t=new o.Yx(this.roomId,e);var r=this.members[e];null!=r&&r.events.member&&t.setMembershipEvent(r.events.member,this),this.sentinels[e]=t}return t}getStateEvents(e,t){return this.events.has(e)?void 0===t?Array.from(this.events.get(e).values()):this.events.get(e).get(t)||null:void 0===t?[]:null}get hasLiveBeacons(){var e;return!!(null!=(e=this.liveBeaconIds)&&e.length)}get liveBeaconIds(){return this._liveBeaconIds}clone(){var e=new b(this.roomId,this.oobMemberFlags),t=this.oobMemberFlags.status;return this.oobMemberFlags.status=f.NotStarted,Array.from(this.events.values()).forEach(t=>{e.setStateEvents(Array.from(t.values()))}),this.oobMemberFlags.status=t,null!==this.summaryInvitedMemberCount&&e.setInvitedMemberCount(this.getInvitedMemberCount()),null!==this.summaryJoinedMemberCount&&e.setJoinedMemberCount(this.getJoinedMemberCount()),this.oobMemberFlags.status==f.Finished&&this.getMembers().forEach(t=>{if(t.isOutOfBand()){var r;null==(r=e.getMember(t.userId))||r.markOutOfBand()}}),e}setUnknownStateEvents(e){var t=e.filter(e=>!this.events.has(e.getType())||!this.events.get(e.getType()).has(e.getStateKey()));this.setStateEvents(t)}setStateEvents(e,t){this.updateModifiedTime(),e.forEach(e=>{if(e.getRoomId()===this.roomId&&e.isState()){p.E.matches(e.getType())&&this.setBeacon(e);var t,r=this.getStateEventMatching(e);this.setStateEvent(e),e.getType()===l.Bx.RoomMember&&(this.updateDisplayNameCache(e.getStateKey(),null!=(t=e.getContent().displayname)?t:""),this.updateThirdPartyTokenCache(e)),this.emit(y.Events,e,this,r)}}),this.onBeaconLivenessChange(),e.forEach(e=>{if(e.getRoomId()===this.roomId&&e.isState())if(e.getType()===l.Bx.RoomMember){var r=e.getStateKey();(e.getContent().membership===m.O.Leave||e.getContent().membership===m.O.Ban)&&(e.getContent().avatar_url=e.getContent().avatar_url||e.getPrevContent().avatar_url,e.getContent().displayname=e.getContent().displayname||e.getPrevContent().displayname);var n=this.getOrCreateMember(r,e);n.setMembershipEvent(e,this),this.updateMember(n),this.emit(y.Members,e,this,n)}else if(e.getType()===l.Bx.RoomPowerLevels){if(""!==e.getStateKey())return;var i=Object.values(this.members),o=this.getStateEvents(l.Bx.RoomCreate,""),a=S(this.getRoomVersion(),o);i.forEach(t=>{var r=t.getLastModifiedTime();if(o){var n=E(t.userId,e,a);t.setPowerLevel(n,e)}r!==t.getLastModifiedTime()&&this.emit(y.Members,e,this,t)}),this.sentinels={}}else l.ge.matches(e.getType())&&this.emit(y.Marker,e,t)}),this.emit(y.Update,this)}processBeaconEvents(e,t){var r=this;return(0,n.A)(function*(){if(e.length&&r.beacons.size){var i,o=[...r.beacons.values()].reduce((e,t)=>(e[t.beaconInfoId]=t,e),{}),a=(e,t)=>{if(p.z.matches(t.getType())){var r=o[e];r&&r.addLocations([t])}},s=function*(e){var r,i=null==(r=e.getRelation())?void 0:r.event_id;if(!i||!o[i]||!p.z.matches(e.getType())&&!e.isEncrypted())return{v:void 0};try{yield t.decryptEventIfNeeded(e),a(i,e)}catch(t){e.isDecryptionFailure()&&e.once(c.OQ.Decrypted,(0,n.A)(function*(){a(i,e)}))}};for(var l of e)if(i=yield*s(l))return i.v}})()}getOrCreateMember(e,t){var r=this.members[e];return r||(r=new o.Yx(this.roomId,e),this.members[e]=r,this.emit(y.NewMember,t,this,r)),r}setStateEvent(e){this.events.has(e.getType())||this.events.set(e.getType(),new Map),this.events.get(e.getType()).set(e.getStateKey(),e)}setBeacon(e){var t=(0,h.M9)(e);if(this.beacons.has(t)){var r,n=this.beacons.get(t);if(e.isRedacted()){n.beaconInfoId===(null==(r=e.getRedactionEvent())?void 0:r.redacts)&&(n.destroy(),this.beacons.delete(t));return}return n.update(e)}if(!e.isRedacted()){var i=new h.HF(e);this.reEmitter.reEmit(i,[h.JH.New,h.JH.Update,h.JH.Destroy,h.JH.LivenessChange]),this.emit(h.JH.New,e,i),i.on(h.JH.LivenessChange,this.onBeaconLivenessChange.bind(this)),i.on(h.JH.Destroy,this.onBeaconLivenessChange.bind(this)),this.beacons.set(i.identifier,i)}}onBeaconLivenessChange(){this._liveBeaconIds=Array.from(this.beacons.values()).filter(e=>e.isLive).map(e=>e.identifier),this.emit(y.BeaconLiveness,this,this.hasLiveBeacons)}getStateEventMatching(e){var t,r;return null!=(t=null==(r=this.events.get(e.getType()))?void 0:r.get(e.getStateKey()))?t:null}updateMember(e){var t=this.getStateEvents(l.Bx.RoomCreate,""),r=this.getStateEvents(l.Bx.RoomPowerLevels,"");if(r&&t){var n=E(e.userId,r,S(this.getRoomVersion(),t));e.setPowerLevel(n,r)}delete this.sentinels[e.userId],this.members[e.userId]=e,this.joinedMemberCount=null,this.invitedMemberCount=null}needsOutOfBandMembers(){return this.oobMemberFlags.status===f.NotStarted}outOfBandMembersReady(){return this.oobMemberFlags.status===f.Finished}markOutOfBandMembersStarted(){this.oobMemberFlags.status===f.NotStarted&&(this.oobMemberFlags.status=f.InProgress)}markOutOfBandMembersFailed(){this.oobMemberFlags.status===f.InProgress&&(this.oobMemberFlags.status=f.NotStarted)}clearOutOfBandMembers(){var e=0;Object.keys(this.members).forEach(t=>{this.members[t].isOutOfBand()&&(++e,delete this.members[t])}),a.vF.log("LL: RoomState removed ".concat(e," members...")),this.oobMemberFlags.status=f.NotStarted}setOutOfBandMembers(e){a.vF.log("LL: RoomState about to set ".concat(e.length," OOB members ...")),this.oobMemberFlags.status===f.InProgress&&(a.vF.log("LL: RoomState put in finished state ..."),this.oobMemberFlags.status=f.Finished,e.forEach(e=>this.setOutOfBandMember(e)),this.emit(y.Update,this))}setOutOfBandMember(e){if(e.getType()===l.Bx.RoomMember){var t=e.getStateKey(),r=this.getMember(t);if(!r||r.isOutOfBand()){var n=this.getOrCreateMember(t,e);n.setMembershipEvent(e,this),n.markOutOfBand(),this.updateDisplayNameCache(n.userId,n.name),this.setStateEvent(e),this.updateMember(n),this.emit(y.Members,e,this,n)}}}setTypingEvent(e){Object.values(this.members).forEach(function(t){t.setTypingEvent(e)})}getInviteForThreePidToken(e){return this.tokenToInvite[e]||null}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}getUserIdsWithDisplayName(e){var t;return null!=(t=this.displayNameToUserIds.get((0,s.Gp)(e)))?t:[]}maySendRedactionForEvent(e,t){var r=this.getMember(t);return!(!r||r.membership===m.O.Leave||e.status||e.isRedacted())&&!!this.maySendEvent(l.Bx.RoomRedaction,t)&&(e.getSender()===t||this.hasSufficientPowerLevelFor("redact",r.powerLevel))}hasSufficientPowerLevelFor(e,t){var r=this.getStateEvents(l.Bx.RoomPowerLevels,""),n={};r&&(n=r.getContent());var i=50;return(0,s.Et)(n[e])&&(i=n[e]),t>=i}maySendMessage(e){return this.maySendEventOfType(l.Bx.RoomMessage,e,!1)}maySendEvent(e,t){return this.maySendEventOfType(e,t,!1)}mayClientSendStateEvent(e,t){return!t.isGuest()&&!!t.credentials.userId&&this.maySendStateEvent(e,t.credentials.userId)}maySendStateEvent(e,t){return this.maySendEventOfType(e,t,!0)}maySendEventOfType(e,t,r){var n,i,o=this.getStateEvents(l.Bx.RoomPowerLevels,""),a={},s=0,c=0;o&&(a=(i=o.getContent()).events||{},s=Number.isSafeInteger(i.state_default)?i.state_default:50,Number.isSafeInteger(i.events_default)&&(c=i.events_default));var d=r?s:c;Number.isSafeInteger(a[e])&&(d=a[e]);var u=this.getMember(t);return(null!=(n=null==u?void 0:u.powerLevel)?n:0)>=d}mayTriggerNotifOfType(e,t){var r=this.getMember(t);if(!r)return!1;var n=this.getStateEvents(l.Bx.RoomPowerLevels,""),i=50;return n&&n.getContent()&&n.getContent().notifications&&(0,s.Et)(n.getContent().notifications[e])&&(i=n.getContent().notifications[e]),r.powerLevel>=i}getJoinRule(){var e,t=this.getStateEvents(l.Bx.RoomJoinRules,"");return(null!=(e=null==t?void 0:t.getContent())?e:{}).join_rule||d.dx.Invite}getHistoryVisibility(){var e,t=this.getStateEvents(l.Bx.RoomHistoryVisibility,"");return(null!=(e=null==t?void 0:t.getContent())?e:{}).history_visibility||d.Jv.Shared}getGuestAccess(){var e,t=this.getStateEvents(l.Bx.RoomGuestAccess,"");return(null!=(e=null==t?void 0:t.getContent())?e:{}).guest_access||d.rF.Forbidden}findPredecessor(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(e){var t=this.getStateEvents(l.Bx.RoomPredecessor,"");if(t){var r=t.getContent(),n=r.predecessor_room_id,i=r.last_known_event_id;"string"!=typeof i&&(i=void 0);var o=r.via_servers;if(Array.isArray(o)||(o=void 0),"string"==typeof n)return{roomId:n,eventId:i,viaServers:o}}}var a=this.getStateEvents(l.Bx.RoomCreate,"");if(a){var s=a.getContent().predecessor;if(s){var c=s.room_id;if("string"==typeof c){var d=s.event_id;return("string"!=typeof d||""===d)&&(d=void 0),{roomId:c,eventId:d}}}}return null}updateThirdPartyTokenCache(e){if(e.getContent().third_party_invite){var t=(e.getContent().third_party_invite.signed||{}).token;t&&this.getStateEvents(l.Bx.RoomThirdPartyInvite,t)&&(this.tokenToInvite[t]=e)}}updateDisplayNameCache(e,t){var r=this.userIdsToDisplayNames[e];if(delete this.userIdsToDisplayNames[e],r){var n=(0,s.Gp)(r),i=this.displayNameToUserIds.get(n);if(i){var o=i.filter(t=>t!==e);this.displayNameToUserIds.set(n,o)}}this.userIdsToDisplayNames[e]=t;var a=t&&(0,s.Gp)(t);if(a){var l,c=null!=(l=this.displayNameToUserIds.get(a))?l:[];c.push(e),this.displayNameToUserIds.set(a,c)}}}function S(e,t){var r=new Set;if(!g.includes(e)&&t){var n=t.getSender();n&&r.add(n);var i=t.getDirectionalContent().additional_creators;Array.isArray(i)&&i.forEach(e=>r.add(e))}return r}function E(e,t,r){if(r.has(e))return 1/0;var n=t.getDirectionalContent(),i=n.users||{};return void 0!==i[e]&&Number.isInteger(i[e])?i[e]:void 0!==n.users_default?n.users_default:0}},31642:(e,t)=>{"use strict";function r(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}Object.defineProperty(t,"__esModule",{value:!0}),t.NamespacedMap=void 0;t.NamespacedMap=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");if(n="internalMap",i=new Map,n in this?Object.defineProperty(this,n,{value:i,enumerable:!0,configurable:!0,writable:!0}):this[n]=i,e){var n,i,o,a=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return r(e,void 0);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return r(e,t)}}(e))){n&&(e=n);var i=0,o=function(){};return{s:o,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:o}}throw TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,s=!0,l=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return s=e.done,e},e:function(e){l=!0,a=e},f:function(){try{s||null==n.return||n.return()}finally{if(l)throw a}}}}(e);try{for(a.s();!(o=a.n()).done;){var s=o.value;this.set(s[0],s[1])}}catch(e){a.e(e)}finally{a.f()}}}return e=[{key:"get",value:function(e){return e.name&&this.internalMap.has(e.name)?this.internalMap.get(e.name):e.altName&&this.internalMap.has(e.altName)?this.internalMap.get(e.altName):null}},{key:"set",value:function(e,t){e.name&&this.internalMap.set(e.name,t),e.altName&&this.internalMap.set(e.altName,t)}},{key:"has",value:function(e){return!!this.get(e)}},{key:"delete",value:function(e){e.name&&this.internalMap.delete(e.name),e.altName&&this.internalMap.delete(e.altName)}},{key:"hasNamespaced",value:function(e){return this.internalMap.has(e)}},{key:"getNamespaced",value:function(e){return this.internalMap.get(e)}}],function(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t}()},33234:(e,t,r)=>{"use strict";r.d(t,{L:()=>n,S:()=>i});var n=function(e){return e.Read="m.read",e.FullyRead="m.fully_read",e.ReadPrivate="m.read.private",e}({}),i="main"},33418:(e,t,r)=>{"use strict";r.d(t,{Wi:()=>h,sP:()=>u,sn:()=>c});var n=r(29301),i=r(84458),o=r(19599),a=r(14308),s=r(41948),l=r(15095),c=function(e){return e.New="Poll.new",e.End="Poll.end",e.Update="Poll.update",e.Responses="Poll.Responses",e.Destroy="Poll.Destroy",e.UndecryptableRelations="Poll.UndecryptableRelations",e}({}),d=(e,t)=>({responseEvents:e.filter(e=>{if(!e.isDecryptionFailure())return a.qN.matches(e.getType())&&e.getTs()<=t})});class u extends l.X{constructor(e,t,r){if(super(),this.rootEvent=e,this.matrixClient=t,this.room=r,(0,i.A)(this,"roomId",void 0),(0,i.A)(this,"pollEvent",void 0),(0,i.A)(this,"_isFetchingResponses",!1),(0,i.A)(this,"relationsNextBatch",void 0),(0,i.A)(this,"responses",null),(0,i.A)(this,"endEvent",void 0),(0,i.A)(this,"undecryptableRelationEventIds",new Set),(0,i.A)(this,"countUndecryptableEvents",e=>{var t=e.filter(e=>e.isDecryptionFailure()).map(e=>e.getId()),r=this.undecryptableRelationsCount;this.undecryptableRelationEventIds=new Set([...this.undecryptableRelationEventIds,...t]),this.undecryptableRelationsCount!==r&&this.emit(c.UndecryptableRelations,this.undecryptableRelationsCount)}),!this.rootEvent.getRoomId()||!this.rootEvent.getId())throw Error("Invalid poll start event.");this.roomId=this.rootEvent.getRoomId(),this.pollEvent=this.rootEvent.unstableExtensibleEvent}get pollId(){return this.rootEvent.getId()}get endEventId(){var e;return null==(e=this.endEvent)?void 0:e.getId()}get isEnded(){return!!this.endEvent}get isFetchingResponses(){return this._isFetchingResponses}get undecryptableRelationsCount(){return this.undecryptableRelationEventIds.size}getResponses(){var e=this;return(0,n.A)(function*(){return e.responses||e.isFetchingResponses||(yield e.fetchResponses()),e.responses})()}onNewRelation(e){if(a.cI.matches(e.getType())&&this.validateEndEvent(e)&&(this.endEvent=e,this.refilterResponsesOnEnd(),this.emit(c.End)),this.responses){var t,{responseEvents:r}=d([e],(null==(t=this.endEvent)?void 0:t.getTs())||Number.MAX_SAFE_INTEGER);this.countUndecryptableEvents([e]),r.length&&(r.forEach(e=>{this.responses.addEvent(e)}),this.emit(c.Responses,this.responses))}}fetchResponses(){var e=this;return(0,n.A)(function*(){e._isFetchingResponses=!0;var t,r,n=yield e.matrixClient.relations(e.roomId,e.rootEvent.getId(),"m.reference",void 0,{from:e.relationsNextBatch||void 0});yield Promise.all(n.events.map(t=>e.matrixClient.decryptEventIfNeeded(t)));var i=e.responses||new s.s("m.reference",a.qN.name,e.matrixClient,[a.qN.altName]),o=n.events.find(e=>a.cI.matches(e.getType()));e.validateEndEvent(o)&&(e.endEvent=o,e.refilterResponsesOnEnd(),e.emit(c.End));var l=(null==(t=e.endEvent)?void 0:t.getTs())||Number.MAX_SAFE_INTEGER,{responseEvents:u}=d(n.events,l);u.forEach(e=>{i.addEvent(e)}),e.relationsNextBatch=null!=(r=n.nextBatch)?r:void 0,e.responses=i,e.countUndecryptableEvents(n.events),e.relationsNextBatch?e.fetchResponses():e._isFetchingResponses=!1,e.emit(c.Responses,e.responses)})()}refilterResponsesOnEnd(){if(this.responses){var e,t=(null==(e=this.endEvent)?void 0:e.getTs())||Number.MAX_SAFE_INTEGER;this.responses.getRelations().forEach(e=>{if(e.getTs()>t){var r;null==(r=this.responses)||r.removeEvent(e)}}),this.emit(c.Responses,this.responses)}}validateEndEvent(e){if(!e||this.endEvent&&this.endEvent.getTs()<e.getTs())return!1;var t=this.room.currentState,r=e.getSender();return!!r&&(r===this.rootEvent.getSender()||t.maySendRedactionForEvent(this.rootEvent,r))}}var h=e=>{var t=e.getType();return o.M_POLL_START.matches(t)||a.qN.matches(t)||a.cI.matches(t)}},34019:(e,t,r)=>{"use strict";r.d(t,{C:()=>o});var n=r(29301),i=new Uint8Array(8);function o(e,t){return a.apply(this,arguments)}function a(){return(a=(0,n.A)(function*(e,t){var r=yield globalThis.crypto.subtle.importKey("raw",e,{name:"HKDF"},!1,["deriveBits"]),n=yield globalThis.crypto.subtle.deriveBits({name:"HKDF",salt:i,info:new TextEncoder().encode(t),hash:"SHA-256"},r,512),o=n.slice(0,32),a=n.slice(32);return Promise.all([globalThis.crypto.subtle.importKey("raw",o,{name:"AES-CTR"},!1,["encrypt","decrypt"]),globalThis.crypto.subtle.importKey("raw",a,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign","verify"])])})).apply(this,arguments)}},35095:(e,t,r)=>{"use strict";function n(e,t){if("function"==typeof e.toBase64)return e.toBase64(t);var r=btoa(e.reduce((e,t)=>e+String.fromCharCode(t),""));return t.omitPadding&&(r=r.replace(/={1,2}$/,"")),"base64url"===t.alphabet&&(r=r.replace(/\+/g,"-").replace(/\//g,"_")),r}function i(e){return n(e,{alphabet:"base64",omitPadding:!1})}function o(e){return n(e,{alphabet:"base64",omitPadding:!0})}function a(e){return n(e,{alphabet:"base64url",omitPadding:!0})}function s(e){var t,r;return t=e.replace(/-/g,"+").replace(/_/g,"/"),r={alphabet:"base64",lastChunkHandling:"loose"},"function"==typeof Uint8Array.fromBase64?Uint8Array.fromBase64(t,r):Uint8Array.from(atob(t),e=>e.charCodeAt(0))}r.d(t,{A4:()=>a,PP:()=>o,WG:()=>i,y4:()=>s})},36963:(e,t,r)=>{"use strict";r.d(t,{iD:()=>T,Rc:()=>l.Rc,Hl:()=>l.Hl,XD:()=>c,Pw:()=>I,up:()=>l.up,ED:()=>x,a_:()=>l.a_,Vc:()=>l.Vc,zs:()=>A,IT:()=>s,FS:()=>l.FS,DW:()=>l.DW,JG:()=>v,fZ:()=>y,xy:()=>p,Y6:()=>g,eM:()=>l.eM,_:()=>h});var n,i=r(84458),o=r(29301),a=r(11749),s=function(e){return e.Get="GET",e.Put="PUT",e.Post="POST",e.Delete="DELETE",e.Options="OPTIONS",e.Head="HEAD",e.Patch="PATCH",e}({}),l=r(71453),c=function(e){return e.SessionLoggedOut="Session.logged_out",e.NoConsent="no_consent",e}({}),d=r(17502),u=r(5408);function h(e){var t=new AbortController;return setTimeout(()=>{t.abort()},e),t.signal}function v(e){var t=new AbortController;function r(){for(var t of e)t.removeEventListener("abort",n)}function n(){t.abort(),r()}for(var i of e){if(i.aborted){n();break}i.addEventListener("abort",n)}return{signal:t.signal,cleanup:r}}function p(e,t){var r,n,i,o=m(e)?new Headers(e.getAllResponseHeaders().trim().split(/[\r\n]+/).map(e=>{var t=e.indexOf(":");return[e.substring(0,t),e.substring(t+1)]})):e.headers;try{i=function(e){var t=e.get("Content-Type");if(null===t)return null;try{return(0,d.q)(t)}catch(e){throw Error("Error parsing Content-Type '".concat(t,"': ").concat(e))}}(o)}catch(e){return e}if((null==(r=i)?void 0:r.type)==="application/json"&&t){var a=JSON.parse(t);return a.errcode&&l.Vc.matches(a.errcode)?new l.a_(a,e.status,m(e)?e.responseURL:e.url,void 0,o):new l.up(a,e.status,m(e)?e.responseURL:e.url,void 0,o)}return(null==(n=i)?void 0:n.type)==="text/plain"?new l.Hl("Server returned ".concat(e.status," error: ").concat(t),e.status,o):new l.Hl("Server returned ".concat(e.status," error"),e.status,o)}function m(e){return"getResponseHeader"in e}function g(e,t){return f.apply(this,arguments)}function f(){return(f=(0,o.A)(function*(e,t){for(var r=0,n=null;r<e;)try{if(r>0){var i=1e3*Math.pow(2,r);u.vF.log("network operation failed ".concat(r," times, retrying in ").concat(i,"ms...")),yield(0,a.yy)(i)}return yield t()}catch(e){if(e instanceof l.Rc)r+=1,n=e;else throw e}throw n})).apply(this,arguments)}function y(e,t,r){return t>4||e instanceof l.Rc&&!r||e.httpStatus&&4===Math.floor(e.httpStatus/100)&&429!==e.httpStatus||"AbortError"===e.name||"M_TOO_LARGE"===e.name?-1:(0,l.eM)(e,1e3*Math.pow(2,t))}var b=function(e){return e.Success="success",e.Failure="failure",e.Logout="logout",e}({});class S{constructor(e){this.opts=e,(0,i.A)(this,"tokenRefreshPromise",void 0),(0,i.A)(this,"latestTokenRefreshExpiry",void 0)}prepareForRequest(){var e=this;return(0,o.A)(function*(){return yield e.refreshIfNeeded(),{accessToken:e.opts.accessToken,refreshToken:e.opts.refreshToken,expiry:e.latestTokenRefreshExpiry}})()}refreshIfNeeded(){var e=this;return(0,o.A)(function*(){if(e.tokenRefreshPromise)return e.tokenRefreshPromise;e.latestTokenRefreshExpiry&&e.latestTokenRefreshExpiry.getTime()-Date.now()<=500&&(yield e._handleUnknownToken())})()}handleUnknownToken(e,t){var r=this;return(0,o.A)(function*(){return r._handleUnknownToken(e,t)})()}_handleUnknownToken(e,t){var r=this;return(0,o.A)(function*(){if(null!=e&&e.expiry&&e.expiry.getTime()-Date.now()>=6e4)return b.Logout;if(!e||(null==e?void 0:e.accessToken)===r.opts.accessToken){null!=r.tokenRefreshPromise||(r.tokenRefreshPromise=r.doTokenRefresh(t));try{return yield r.tokenRefreshPromise}finally{r.tokenRefreshPromise=void 0}}return b.Success})()}doTokenRefresh(e){var t=this;return(0,o.A)(function*(){if(!t.opts.refreshToken||!t.opts.tokenRefreshFunction)return null==(i=t.opts.logger)||i.error("Unable to refresh token - no refresh token or refresh function"),b.Logout;e&&e>1&&(yield(0,a.yy)(1e3*Math.min(32,2**e)));try{null==(o=t.opts.logger)||o.debug("Attempting to refresh token");var r,n,i,o,s,{accessToken:c,refreshToken:d,expiry:u}=yield t.opts.tokenRefreshFunction(t.opts.refreshToken);return t.opts.accessToken=c,t.opts.refreshToken=d,t.latestTokenRefreshExpiry=u,null==(s=t.opts.logger)||s.debug("... token refresh complete, new token expiry:",u),b.Success}catch(e){if(e instanceof l.DW||e instanceof l.up)return null==(n=t.opts.logger)||n.error("Failed to refresh token",e),b.Logout;return null==(r=t.opts.logger)||r.warn("Failed to refresh token",e),b.Failure}})()}}function E(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function _(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?E(Object(r),!0).forEach(function(t){(0,i.A)(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):E(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}class w{constructor(e,t){var r;if(this.eventEmitter=e,this.opts=t,(0,i.A)(this,"abortController",new AbortController),(0,i.A)(this,"tokenRefresher",void 0),(0,a.UB)(t,["baseUrl","prefix"]),!t.onlyData)throw Error("Constructing FetchHttpApi without `onlyData=true` is no longer supported.");t.useAuthorizationHeader=null==(r=t.useAuthorizationHeader)||r,this.tokenRefresher=new S(t)}abort(){this.abortController.abort(),this.abortController=new AbortController}fetch(e,t){return this.opts.fetchFn?this.opts.fetchFn(e,t):globalThis.fetch(e,t)}setIdBaseUrl(e){this.opts.idBaseUrl=e}idServerRequest(e,t,r,n,i){if(!this.opts.idBaseUrl)throw Error("No identity server base URL set");var o=void 0,a=void 0;e===s.Get?o=r:a=r;var l=this.getUrl(t,o,n,this.opts.idBaseUrl),c={json:!0,headers:{}};return i&&(c.headers.Authorization="Bearer ".concat(i)),this.requestOtherUrl(e,l,a,c)}authedRequest(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=arguments.length>3?arguments[3]:void 0,i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};return this.doAuthedRequest(1,e,t,r,n,i)}doAuthedRequest(e,t,r,n,i){var s=arguments,d=this;return(0,o.A)(function*(){var o=s.length>5&&void 0!==s[5]?s[5]:{},u=(0,a.A4)(o);u.abortSignal=o.abortSignal;var h=yield d.tokenRefresher.prepareForRequest();h.accessToken&&(d.opts.useAuthorizationHeader?(u.headers||(u.headers={}),u.headers.Authorization||(u.headers.Authorization="Bearer ".concat(h.accessToken)),n.access_token&&delete n.access_token):n.access_token||(n.access_token=h.accessToken));try{return yield d.request(t,r,n,i,u)}catch(a){if(!(a instanceof l.up))throw a;if("M_UNKNOWN_TOKEN"===a.errcode){var v=yield d.tokenRefresher.handleUnknownToken(h,e);if(v===b.Success)return d.doAuthedRequest(e+1,t,r,n,i,o);if(v===b.Failure)throw new l.FS(a);null!=u&&u.inhibitLogoutEmit||d.eventEmitter.emit(c.SessionLoggedOut,a)}else"M_CONSENT_NOT_GIVEN"==a.errcode&&d.eventEmitter.emit(c.NoConsent,a.message,a.data.consent_uri);throw a}})()}request(e,t,r,n,i){var o=this.getUrl(t,r,null==i?void 0:i.prefix,null==i?void 0:i.baseUrl);return this.requestOtherUrl(e,o,n,i)}requestOtherUrl(e,t,r){var n=arguments,i=this;return(0,o.A)(function*(){var o,a,s,c,d,u,m,g,f=n.length>3&&void 0!==n[3]?n[3]:{};if(void 0!==f.json&&void 0!==f.rawResponseBody)throw Error("Invalid call to `FetchHttpApi` sets both `opts.json` and `opts.rawResponseBody`");var y=i.sanitizeUrlForLogs(t);null==(o=i.opts.logger)||o.debug("FetchHttpApi: --\x3e ".concat(e," ").concat(y));var b=Object.assign({},f.headers||{}),S=!f.rawResponseBody&&!1!==f.json;S&&!b.Accept&&(b.Accept="application/json");var E=null!=(a=f.localTimeoutMs)?a:i.opts.localTimeoutMs,_=null!=(s=f.keepAlive)&&s,w=[i.abortController.signal];void 0!==E&&w.push(h(E)),f.abortSignal&&w.push(f.abortSignal),!1!==f.json&&(null==r||null==(c=r.constructor)?void 0:c.name)===Object.name?(d=JSON.stringify(r),b["Content-Type"]||(b["Content-Type"]="application/json")):d=r;var{signal:T,cleanup:I}=v(w),A="Authorization"in b?void 0:"no-cache",R=Date.now();try{u=yield i.fetch(t,{signal:T,method:e,body:d,headers:b,mode:"cors",redirect:"follow",referrer:"",referrerPolicy:"no-referrer",cache:A,credentials:"omit",keepalive:_,priority:f.priority}),null==(m=i.opts.logger)||m.debug("FetchHttpApi: <-- ".concat(e," ").concat(y," [").concat(Date.now()-R,"ms ").concat(u.status,"]"))}catch(t){if(null==(g=i.opts.logger)||g.debug("FetchHttpApi: <-- ".concat(e," ").concat(y," [").concat(Date.now()-R,"ms ").concat(t,"]")),"AbortError"===t.name)throw t;throw new l.Rc("fetch failed",t)}finally{I()}if(!u.ok)throw p(u,(yield u.text()));return f.rawResponseBody?yield u.blob():S?yield u.json():yield u.text()})()}sanitizeUrlForLogs(e){try{var t="string"==typeof e?new URL(e):e,r=new URLSearchParams;for(var n of t.searchParams.keys())r.append(n,"xxx");var i=r.toString();return t.origin+t.pathname+(i?"?".concat(i):"")}catch(e){return"??"}}getUrl(e,t,r,n){var i=null!=n?n:this.opts.baseUrl,o=new URL((i.endsWith("/")?i.slice(0,-1):i)+(null!=r?r:this.opts.prefix)+e);if(this.opts.extraParams||t){var s=_(_({},this.opts.extraParams),t);(0,a.hm)(s,o.searchParams)}return o}}var T=function(e){return e.V1="/_matrix/client/v1",e.V3="/_matrix/client/v3",e.Unstable="/_matrix/client/unstable",e}({}),I=function(e){return e.V2="/_matrix/identity/v2",e}({}),A=function(e){return e.V1="/_matrix/media/v1",e.V3="/_matrix/media/v3",e}({}),R=0,C=[],k=function(){};function O(e,t){for(var r=arguments.length,n=Array(r>2?r-2:0),i=2;i<r;i++)n[i-2]=arguments[i];(t=t||0)<0&&(t=0);var o=Date.now()+t,a=R++;k("setTimeout: scheduling cb",a,"at",o,"(delay",t,")");var s=function(e,t){for(var r=0,n=e.length;r<n;){var i=r+n>>1;t(e[i])>0?n=i:r=i+1}return r}(C,function(e){return e.runAt-o});return C.splice(s,0,{runAt:o,func:e,params:n,key:a}),P(),a}function M(e){if(0!==C.length){for(t=0;t<C.length;t++){var t;if(C[t].key==e){C.splice(t,1);break}}0===t&&P()}}function P(){n&&globalThis.clearTimeout(n);var e=C[0];if(!e)return void k("scheduleRealCallback: no more callbacks, not rescheduling");var t=Date.now(),r=Math.min(e.runAt-t,1e3);k("scheduleRealCallback: now:",t,"delay:",r),n=globalThis.setTimeout(D,r)}function D(){var e=Date.now();k("runCallbacks: now:",e);for(var t=[];;){var r=C[0];if(!r||r.runAt>e)break;var n=C.shift();k("runCallbacks: popping",n.key),t.push(n)}for(var i of(P(),t))try{i.func.apply(globalThis,i.params)}catch(e){u.vF.error("Uncaught exception in callback function",e)}}class x extends w{constructor(){super(...arguments),(0,i.A)(this,"uploads",[])}uploadContent(e){var t,r,n,i,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},c=null==(t=o.includeFilename)||t,d=null!=(r=o.abortController)?r:new AbortController,u=(null!=(n=o.type)?n:e.type)||"application/octet-stream",h=null!=(i=o.name)?i:e.name,v={loaded:0,total:0,abortController:d},m=Promise.withResolvers();if(globalThis.XMLHttpRequest){var g=new globalThis.XMLHttpRequest,f=function(){g.abort(),m.reject(Error("Timeout"))},y=O(f,3e4);g.onreadystatechange=function(){if(g.readyState===globalThis.XMLHttpRequest.DONE){M(y);try{if(0===g.status)throw new DOMException(g.statusText,"AbortError");if(!g.responseText)throw Error("No response body.");g.status>=400?m.reject(p(g,g.responseText)):m.resolve(JSON.parse(g.responseText))}catch(e){if("AbortError"===e.name)return void m.reject(e);m.reject(new l.Rc("request failed",e))}}},g.upload.onprogress=e=>{var t;M(y),v.loaded=e.loaded,v.total=e.total,y=O(f,3e4),null==(t=o.progressHandler)||t.call(o,{loaded:e.loaded,total:e.total})};var b=this.getUrl("/upload",void 0,A.V3);c&&h&&b.searchParams.set("filename",encodeURIComponent(h)),!this.opts.useAuthorizationHeader&&this.opts.accessToken&&b.searchParams.set("access_token",encodeURIComponent(this.opts.accessToken)),g.open(s.Post,b.href),this.opts.useAuthorizationHeader&&this.opts.accessToken&&g.setRequestHeader("Authorization","Bearer "+this.opts.accessToken),g.setRequestHeader("Content-Type",u),g.send(e),d.signal.addEventListener("abort",()=>{g.abort()})}else{var S={};c&&h&&(S.filename=h),this.authedRequest(s.Post,"/upload",S,e,{prefix:A.V3,headers:{"Content-Type":u},abortSignal:d.signal}).then(m.resolve,m.reject)}return v.promise=m.promise.finally(()=>{(0,a.Nz)(this.uploads,e=>e===v)}),d.signal.addEventListener("abort",()=>{(0,a.Nz)(this.uploads,e=>e===v),m.reject(new DOMException("Aborted","AbortError"))}),this.uploads.push(v),v.promise}cancelUpload(e){var t=this.uploads.find(t=>t.promise===e);return!!t&&(t.abortController.abort(),!0)}getCurrentUploads(){return this.uploads}getContentUri(){return{base:this.opts.baseUrl,path:A.V3+"/upload",params:{access_token:this.opts.accessToken}}}}},37151:(e,t,r)=>{"use strict";r.d(t,{FD:()=>E,H:()=>I,RN:()=>A,UR:()=>C,c1:()=>S,jV:()=>_,ju:()=>b,o1:()=>T,x3:()=>R});var n=r(29301),i=r(84458),o=r(49699),a=r(75525),s=r(9086),l=r(82393),c=r(12411),d=r(80578),u=r(61219),h=r(81626),v=r(5408),p=r(8702),m=r(33234),g=r(38178);function f(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function y(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?f(Object(r),!0).forEach(function(t){(0,i.A)(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):f(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}var b=function(e){return e.New="Thread.new",e.Update="Thread.update",e.NewReply="Thread.newReply",e.ViewThread="Thread.viewThread",e.Delete="Thread.delete",e}({}),S=function(e){return e[e.None=0]="None",e[e.Experimental=1]="Experimental",e[e.Stable=2]="Stable",e}({});function E(e,t){return e?S.Stable:t?S.Experimental:S.None}class _ extends p.h{constructor(e,t,r){var s,c;if(super(),s=this,this.id=e,this.rootEvent=t,(0,i.A)(this,"timelineSet",void 0),(0,i.A)(this,"_currentUserParticipated",!1),(0,i.A)(this,"reEmitter",void 0),(0,i.A)(this,"lastEvent",void 0),(0,i.A)(this,"replyCount",0),(0,i.A)(this,"lastPendingEvent",void 0),(0,i.A)(this,"pendingReplyCount",0),(0,i.A)(this,"room",void 0),(0,i.A)(this,"client",void 0),(0,i.A)(this,"pendingEventOrdering",void 0),(0,i.A)(this,"processRootEventPromise",void 0),(0,i.A)(this,"initialEventsFetched",!_.hasServerSideSupport),(0,i.A)(this,"initalEventFetchProm",void 0),(0,i.A)(this,"replayEvents",[]),(0,i.A)(this,"onTimelineReset",(0,n.A)(function*(){yield s.processRootEventPromise,s.processRootEventPromise=void 0})),(0,i.A)(this,"onBeforeRedaction",(e,t)=>{null!=e&&e.isRelation(A.name)&&this.room.eventShouldLiveIn(e).threadId===this.id&&e.getId()!==this.id&&!t.status&&(this.replyCount--,this.updatePendingReplyCount(),this.emit(b.Update,this))}),(0,i.A)(this,"onRedaction",function(){var e=(0,n.A)(function*(e,t,r){if(r===s.id)if(s.replyCount<=0){for(var n of s.timeline)s.clearEventMetadata(n);s.lastEvent=s.rootEvent,s._currentUserParticipated=!1,s.emit(b.Delete,s)}else{var i;(null==(i=s.lastEvent)?void 0:i.getId())===e.getAssociatedId()&&(yield s.processRootEventPromise,s.processRootEventPromise=void 0),yield s.updateThreadMetadata()}});return function(t,r,n){return e.apply(this,arguments)}}()),(0,i.A)(this,"onTimelineEvent",(e,t,r)=>{if(!r){var n=e.getSender();n&&t&&this.shouldSendLocalEchoReceipt(n,e)&&t.addLocalEchoReceipt(n,e,m.L.Read),e.getId()!==this.id&&e.isRelation(A.name)&&this.replyCount++}this.onEcho(e,null!=r&&r)}),(0,i.A)(this,"onLocalEcho",e=>{this.onEcho(e,!1)}),(0,i.A)(this,"onEcho",function(){var e=(0,n.A)(function*(e,t){if(e.threadRootId===s.id&&s.lastEvent!==e)yield s.updateThreadMetadata(),e.isRelation(A.name)&&(t||(s.lastEvent=void 0,s.emit(b.NewReply,s,e)))});return function(t,r){return e.apply(this,arguments)}}()),this.setMaxListeners(1e3),!(null!=r&&r.room))throw Error("element-web#22141: A thread requires a room in order to function");this.room=r.room,this.client=r.client,this.pendingEventOrdering=null!=(c=r.pendingEventOrdering)?c:o.eO.Chronological,this.timelineSet=new d.m(this.room,{timelineSupport:!0,pendingEvents:!0},this.client,this),this.reEmitter=new a.Q(this),this.reEmitter.reEmit(this.timelineSet,[u.u9.Timeline,u.u9.TimelineReset]),this.room.on(l.OQ.BeforeRedaction,this.onBeforeRedaction),this.room.on(u.u9.Redaction,this.onRedaction),this.room.on(u.u9.LocalEchoUpdated,this.onLocalEcho),this.room.on(u.u9.TimelineReset,this.onTimelineReset),this.timelineSet.on(u.u9.Timeline,this.onTimelineEvent),this.processReceipts(r.receipts),this.updateThreadMetadata(),this.setEventMetadata(this.rootEvent)}fetchRootEvent(){var e=this;return(0,n.A)(function*(){try{var t=yield e.client.fetchRoomEvent(e.roomId,e.id),r=e.client.getEventMapper();e.rootEvent=r(t)}catch(e){v.vF.error("Failed to fetch thread root to construct thread with",e)}yield e.processEvent(e.rootEvent)})()}static setServerSideSupport(e){_.hasServerSideSupport=e,e!==S.Stable&&(T.setPreferUnstable(!0),I.setPreferUnstable(!0),A.setPreferUnstable(!0))}static setServerSideListSupport(e){_.hasServerSideListSupport=e}static setServerSideFwdPaginationSupport(e){_.hasServerSideFwdPaginationSupport=e}shouldSendLocalEchoReceipt(e,t){if((null!=(r=this.client.canSupport.get(g.Xj.RelationsRecursion))?r:g.Tj.Unsupported)===g.Tj.Unsupported){var r,n,i=null==(n=this.getReadReceiptForUserId(e))?void 0:n.eventId;if(i){var o=this.findEventById(i);if(o&&o.getTs()>t.getTs())return!1}}return!0}get roomState(){return this.room.getLiveTimeline().getState(c.q.FORWARDS)}addEventToTimeline(e,t){this.findEventById(e.getId())||this.timelineSet.addEventToTimeline(e,this.liveTimeline,{toStartOfTimeline:t,fromCache:!1,roomState:this.roomState,addToState:!1})}insertEventIntoTimeline(e){var t=e.getId();t&&(this.findEventById(t)||this.timelineSet.insertEventIntoTimeline(e,this.liveTimeline,this.roomState,!1))}addEvents(e,t){e.forEach(e=>this.addEvent(e,t,!1)),this.updateThreadMetadata()}addEvent(e,t){var r=!(arguments.length>2)||void 0===arguments[2]||arguments[2];this.setEventMetadata(e);var n=this.lastReply(),i=!n||e.localTimestamp>=n.localTimestamp;if(_.hasServerSideSupport)if(e.isRelation(s.zZ.Annotation)||e.isRelation(s.zZ.Replace))return void this.addRelatedThreadEvent(e,t);else!t&&i?(this.addEventToTimeline(e,!1),this.fetchEditsWhereNeeded(e)):t?this.addEventToTimeline(e,t):this.insertEventIntoTimeline(e);else this.addEventToTimeline(e,t),this.client.decryptEventIfNeeded(e);e.getId()!==this.id&&e.isRelation(A.name)&&!t&&i&&(this.lastEvent=void 0),r&&(this.emit(b.NewReply,this,e),this.updateThreadMetadata())}addRelatedThreadEvent(e,t){var r,n,i;this.initialEventsFetched?(null!=(r=this.client.canSupport.get(g.Xj.RelationsRecursion))?r:g.Tj.Unsupported)===g.Tj.Unsupported?this.insertEventIntoTimeline(e):this.addEventToTimeline(e,t):(null==(n=this.replayEvents)||n.push(e),e.isRelation(s.zZ.Annotation)&&(null==(i=this.timelineSet.relations)||i.aggregateChildEvent(e,this.timelineSet)))}processEvent(e){var t=this;return(0,n.A)(function*(){e&&(t.setEventMetadata(e),yield t.fetchEditsWhereNeeded(e))})()}processReceipts(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];for(var{eventId:t,receiptType:r,userId:n,receipt:i,synthetic:o}of e)this.addReceiptToStructure(t,r,n,i,o)}getRootEventBundledRelationship(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.rootEvent;return null==e?void 0:e.getServerAggregatedRelation(A.name)}processRootEvent(){var e=this;return(0,n.A)(function*(){var t=e.getRootEventBundledRelationship();if(_.hasServerSideSupport&&t){e.replyCount=t.count,e._currentUserParticipated=!!t.current_user_participated;var r=e.client.getEventMapper();e.lastEvent=r(y(y({},t.latest_event),{},{room_id:e.roomId})),e.updatePendingReplyCount(),yield e.processEvent(e.lastEvent)}})()}updatePendingReplyCount(){var e=(this.pendingEventOrdering===o.eO.Detached?this.room.getPendingEvents():this.events).filter(e=>{var t;return e.threadRootId===this.id&&e.isRelation(A.name)&&null!==e.status&&e.getId()!==(null==(t=this.lastEvent)?void 0:t.getId())});this.lastPendingEvent=e.length?e[e.length-1]:void 0,this.pendingReplyCount=e.length}resetLiveTimeline(e,t){var r=this;return(0,n.A)(function*(){var n,i,o=r.liveTimeline;r.timelineSet.resetLiveTimeline(null!=e?e:void 0,null!=t?t:void 0);var a=r.liveTimeline;e&&(n=(yield r.client.createMessagesRequest(r.roomId,e,1,c.O.Forward)).end),t&&(i=(yield r.client.createMessagesRequest(r.roomId,t,1,c.O.Backward)).start),t&&o.getPaginationToken(c.O.Forward)===t&&o.setPaginationToken(null!=i?i:null,c.O.Forward),e&&a.getPaginationToken(c.O.Backward)===e&&a.setPaginationToken(null!=n?n:null,c.O.Backward)})()}updateThreadFromRootEvent(){var e=this;return(0,n.A)(function*(){_.hasServerSideSupport&&(e.initialEventsFetched||e.lastEvent||(yield e.processRootEvent()),yield e.fetchRootEvent()),yield e.processRootEvent()})()}updateThreadMetadata(){var e=this;return(0,n.A)(function*(){if(e.updatePendingReplyCount(),e.processRootEventPromise||(e.processRootEventPromise=e.updateThreadFromRootEvent()),yield e.processRootEventPromise,!e.initialEventsFetched)if(e.initalEventFetchProm)yield e.initalEventFetchProm;else try{for(var t of(e.timelineSet.resetLiveTimeline(),0===e.replyCount&&e.rootEvent?(e.timelineSet.addEventsToTimeline([e.rootEvent],!0,!1,e.liveTimeline,null),e.liveTimeline.setPaginationToken(null,c.O.Backward)):(e.initalEventFetchProm=e.client.paginateEventTimeline(e.liveTimeline,{backwards:!0}),yield e.initalEventFetchProm),e.initialEventsFetched=!0,e.replayEvents))e.addEvent(t,!1);e.replayEvents=null,e.emit(u.u9.TimelineReset,e.room,e.timelineSet,!0)}catch(t){v.vF.error("Failed to load start of newly created thread: ",t),e.initialEventsFetched=!1}e.emit(b.Update,e)})()}fetchEditsWhereNeeded(){var e=arguments,t=this;return(0,n.A)(function*(){var r;if((null!=(r=t.client.canSupport.get(g.Xj.RelationsRecursion))?r:g.Tj.Unsupported)===g.Tj.Unsupported){for(var i,o=e.length,a=Array(o),l=0;l<o;l++)a[l]=e[l];return Promise.all(a.filter(w).map((i=(0,n.A)(function*(e){try{var r=yield t.client.relations(t.roomId,e.getId(),s.zZ.Replace,e.getType(),{limit:1});if(r.events.length){var n=r.events[0];e.makeReplaced(n),t.insertEventIntoTimeline(n)}}catch(e){v.vF.error("Failed to load edits for encrypted thread event",e)}}),function(e){return i.apply(this,arguments)})))}})()}setEventMetadata(e){e&&(c.q.setEventMetadata(e,this.roomState,!1),e.setThread(this))}clearEventMetadata(e){if(e){var t;e.setThread(void 0),null==(t=e.event)||null==(t=t.unsigned)||null==(t=t["m.relations"])||delete t[A.name]}}findEventById(e){return this.timelineSet.findEventById(e)}lastReply(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e=>e.isRelation(A.name),t=this.timeline.length-1;t>=0;t--){var r=this.timeline[t];if(e(r))return r}return null}get roomId(){return this.room.roomId}get length(){return this.replyCount+this.pendingReplyCount}get replyToEvent(){var e,t;return null!=(e=null!=(t=this.lastPendingEvent)?t:this.lastEvent)?e:this.lastReply()}get timeline(){return this.events}get events(){return this.liveTimeline.getEvents()}has(e){return this.timelineSet.findEventById(e)instanceof l.kl}get hasCurrentUserParticipated(){return this._currentUserParticipated}get liveTimeline(){return this.timelineSet.getLiveTimeline()}getUnfilteredTimelineSet(){return this.timelineSet}addReceipt(e,t){throw Error("Unsupported function on the thread model")}getEventReadUpTo(e,t){var r=e===this.client.getUserId(),n=this.timeline[this.timeline.length-1];if(r&&n){var i=n.getTs()<this.room.getOldestThreadedReceiptTs(),o=n.getId();if(i&&o)return o}var a=super.getEventReadUpTo(e,t);if(n){var s=this.room.getLastUnthreadedReceiptFor(e);if(!s)return a;for(var l=(null==(c=this.timeline)?void 0:c.length)-1;l>=0;--l){var c,d,u=this.timeline[l];if(u.getId()===a)break;if(u.getTs()<s.ts)return null!=(d=u.getId())?d:a}}return a}hasUserReadEvent(e,t){if(e===this.client.getUserId()){var r,n,i,o,a,s,l=(null!=(r=null==(n=this.lastReply())?void 0:n.getTs())?r:0)<this.room.getOldestThreadedReceiptTs(),c=null!=(i=null==(o=this.room.getLastUnthreadedReceiptFor(e))?void 0:o.ts)?i:0,d=(null!=(a=this===null||void 0===this||null==(s=this.lastReply())?void 0:s.getTs())?a:0)<c;if(l||d)return!0}return this.room.hasUserReadEvent(e,t)}setUnread(e,t){return this.room.setThreadUnreadNotificationCount(this.id,e,t)}getLastUnthreadedReceiptFor(e){return this.room.getLastUnthreadedReceiptFor(e)}}function w(e){return e.isEncrypted()&&(e.isRelation(A.name)||e.isThreadRoot)}(0,i.A)(_,"hasServerSideSupport",S.None),(0,i.A)(_,"hasServerSideListSupport",S.None),(0,i.A)(_,"hasServerSideFwdPaginationSupport",S.None);var T=new h.M6("related_by_senders","io.element.relation_senders"),I=new h.M6("related_by_rel_types","io.element.relation_types"),A=new h.M6("m.thread","io.element.thread"),R=function(e){return e[e.My=0]="My",e[e.All=1]="All",e}({});function C(e){return e===R.My?"participated":"all"}},37858:(e,t,r)=>{"use strict";r.d(t,{ux:()=>v,nX:()=>f,cr:()=>d,RT:()=>u,YH:()=>h,wc:()=>m,so:()=>y,uV:()=>b,wF:()=>g,L0:()=>p,wn:()=>l,jS:()=>a});var n=r(84458);r(56662);let i=function(e){if(e.length>=255)throw TypeError("Alphabet too long");let t=new Uint8Array(256);for(let e=0;e<t.length;e++)t[e]=255;for(let r=0;r<e.length;r++){let n=e.charAt(r),i=n.charCodeAt(0);if(255!==t[i])throw TypeError(n+" is ambiguous");t[i]=r}let r=e.length,n=e.charAt(0),i=Math.log(r)/Math.log(256),o=Math.log(256)/Math.log(r);function a(e){if("string"!=typeof e)throw TypeError("Expected String");if(0===e.length)return new Uint8Array;let o=0,a=0,s=0;for(;e[o]===n;)a++,o++;let l=(e.length-o)*i+1>>>0,c=new Uint8Array(l);for(;o<e.length;){let n=e.charCodeAt(o);if(n>255)return;let i=t[n];if(255===i)return;let a=0;for(let e=l-1;(0!==i||a<s)&&-1!==e;e--,a++)i+=r*c[e]>>>0,c[e]=i%256>>>0,i=i/256>>>0;if(0!==i)throw Error("Non-zero carry");s=a,o++}let d=l-s;for(;d!==l&&0===c[d];)d++;let u=new Uint8Array(a+(l-d)),h=a;for(;d!==l;)u[h++]=c[d++];return u}return{encode:function(t){if(t instanceof Uint8Array||(ArrayBuffer.isView(t)?t=new Uint8Array(t.buffer,t.byteOffset,t.byteLength):Array.isArray(t)&&(t=Uint8Array.from(t))),!(t instanceof Uint8Array))throw TypeError("Expected Uint8Array");if(0===t.length)return"";let i=0,a=0,s=0,l=t.length;for(;s!==l&&0===t[s];)s++,i++;let c=(l-s)*o+1>>>0,d=new Uint8Array(c);for(;s!==l;){let e=t[s],n=0;for(let t=c-1;(0!==e||n<a)&&-1!==t;t--,n++)e+=256*d[t]>>>0,d[t]=e%r>>>0,e=e/r>>>0;if(0!==e)throw Error("Non-zero carry");a=n,s++}let u=c-a;for(;u!==c&&0===d[u];)u++;let h=n.repeat(i);for(;u<c;++u)h+=e.charAt(d[u]);return h},decodeUnsafe:a,decode:function(e){let t=a(e);if(t)return t;throw Error("Non-base"+r+" character")}}}("123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz");var o=[139,1];function a(e){var t,r=new Uint8Array(o.length+e.length+1);r.set(o,0),r.set(e,o.length);for(var n=0,a=0;a<r.length-1;++a)n^=r[a];return r[r.length-1]=n,null==(t=i.encode(r).match(/.{1,4}/g))?void 0:t.join(" ")}var s=r(29301);function l(e,t,r){return c.apply(this,arguments)}function c(){return(c=(0,s.A)(function*(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:256;if(!globalThis.crypto.subtle||!TextEncoder)throw Error("Password-based backup is not available on this platform");var i=yield globalThis.crypto.subtle.importKey("raw",new TextEncoder().encode(e),{name:"PBKDF2"},!1,["deriveBits"]);return new Uint8Array((yield globalThis.crypto.subtle.deriveBits({name:"PBKDF2",salt:new TextEncoder().encode(t),iterations:r,hash:"SHA-512"},i,n)))})).apply(this,arguments)}var d=function(e){return e.UserTrustStatusChanged="userTrustStatusChanged",e.KeyBackupStatus="crypto.keyBackupStatus",e.KeyBackupFailed="crypto.keyBackupFailed",e.KeyBackupSessionsRemaining="crypto.keyBackupSessionsRemaining",e.KeyBackupDecryptionKeyCached="crypto.keyBackupDecryptionKeyCached",e.VerificationRequestReceived="crypto.verificationRequestReceived",e.WillUpdateDevices="crypto.willUpdateDevices",e.DevicesUpdated="crypto.devicesUpdated",e.KeysChanged="crossSigning.keysChanged",e.LegacyCryptoStoreMigrationProgress="crypto.legacyCryptoStoreMigrationProgress",e.DehydratedDeviceCreated="dehydration.DehydratedDeviceCreated",e.DehydratedDeviceUploaded="dehydration.DehydratedDeviceUploaded",e.RehydrationStarted="dehydration.RehydrationStarted",e.RehydrationProgress="dehydration.RehydrationProgress",e.RehydrationCompleted="dehydration.RehydrationCompleted",e.RehydrationError="dehydration.RehydrationError",e.DehydrationKeyCached="dehydration.DehydrationKeyCached",e.DehydratedDeviceRotationError="dehydration.DehydratedDeviceRotationError",e}({}),u=function(e){return e.MEGOLM_UNKNOWN_INBOUND_SESSION_ID="MEGOLM_UNKNOWN_INBOUND_SESSION_ID",e.MEGOLM_KEY_WITHHELD="MEGOLM_KEY_WITHHELD",e.MEGOLM_KEY_WITHHELD_FOR_UNVERIFIED_DEVICE="MEGOLM_KEY_WITHHELD_FOR_UNVERIFIED_DEVICE",e.OLM_UNKNOWN_MESSAGE_INDEX="OLM_UNKNOWN_MESSAGE_INDEX",e.HISTORICAL_MESSAGE_NO_KEY_BACKUP="HISTORICAL_MESSAGE_NO_KEY_BACKUP",e.HISTORICAL_MESSAGE_BACKUP_UNCONFIGURED="HISTORICAL_MESSAGE_BACKUP_UNCONFIGURED",e.HISTORICAL_MESSAGE_WORKING_BACKUP="HISTORICAL_MESSAGE_WORKING_BACKUP",e.HISTORICAL_MESSAGE_USER_NOT_JOINED="HISTORICAL_MESSAGE_USER_NOT_JOINED",e.SENDER_IDENTITY_PREVIOUSLY_VERIFIED="SENDER_IDENTITY_PREVIOUSLY_VERIFIED",e.UNSIGNED_SENDER_DEVICE="UNSIGNED_SENDER_DEVICE",e.UNKNOWN_SENDER_DEVICE="UNKNOWN_SENDER_DEVICE",e.UNKNOWN_ERROR="UNKNOWN_ERROR",e}({}),h=function(e){return e[e.AllDevicesIsolationMode=0]="AllDevicesIsolationMode",e[e.OnlySignedDevicesIsolationMode=1]="OnlySignedDevicesIsolationMode",e}({});class v{constructor(e){this.errorOnVerifiedUserProblems=e,(0,n.A)(this,"kind",h.AllDevicesIsolationMode)}}class p{constructor(e,t,r){var i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];this.crossSigningVerified=e,this.crossSigningVerifiedBefore=t,this.tofu=r,(0,n.A)(this,"needsUserApproval",void 0),this.needsUserApproval=i}isVerified(){return this.isCrossSigningVerified()}isCrossSigningVerified(){return this.crossSigningVerified}wasCrossSigningVerified(){return this.crossSigningVerifiedBefore}isTofu(){return this.tofu}}class m{constructor(e){var t,r,i,o,a;(0,n.A)(this,"signedByOwner",void 0),(0,n.A)(this,"crossSigningVerified",void 0),(0,n.A)(this,"tofu",void 0),(0,n.A)(this,"localVerified",void 0),(0,n.A)(this,"trustCrossSignedDevices",void 0),this.signedByOwner=null!=(t=e.signedByOwner)&&t,this.crossSigningVerified=null!=(r=e.crossSigningVerified)&&r,this.tofu=null!=(i=e.tofu)&&i,this.localVerified=null!=(o=e.localVerified)&&o,this.trustCrossSignedDevices=null!=(a=e.trustCrossSignedDevices)&&a}isVerified(){return this.localVerified||this.trustCrossSignedDevices&&this.crossSigningVerified}}var g=function(e){return e.Fetch="fetch",e.LoadKeys="load_keys",e}({}),f=function(e){return e.Master="master",e.SelfSigning="self_signing",e.UserSigning="user_signing",e}({}),y=function(e){return e[e.NONE=0]="NONE",e[e.GREY=1]="GREY",e[e.RED=2]="RED",e}({}),b=function(e){return e[e.UNKNOWN=0]="UNKNOWN",e[e.UNVERIFIED_IDENTITY=1]="UNVERIFIED_IDENTITY",e[e.UNSIGNED_DEVICE=2]="UNSIGNED_DEVICE",e[e.UNKNOWN_DEVICE=3]="UNKNOWN_DEVICE",e[e.AUTHENTICITY_NOT_GUARANTEED=4]="AUTHENTICITY_NOT_GUARANTEED",e[e.MISMATCHED_SENDER_KEY=5]="MISMATCHED_SENDER_KEY",e[e.SENT_IN_CLEAR=6]="SENT_IN_CLEAR",e[e.VERIFICATION_VIOLATION=7]="VERIFICATION_VIOLATION",e[e.MISMATCHED_SENDER=8]="MISMATCHED_SENDER",e}({})},38178:(e,t,r)=>{"use strict";r.d(t,{Tj:()=>i,Xj:()=>o,yk:()=>s});var n=r(29301),i=function(e){return e[e.Stable=0]="Stable",e[e.Unstable=1]="Unstable",e[e.Unsupported=2]="Unsupported",e}({}),o=function(e){return e.Thread="Thread",e.ThreadUnreadNotifications="ThreadUnreadNotifications",e.LoginTokenRequest="LoginTokenRequest",e.RelationBasedRedactions="RelationBasedRedactions",e.AccountDataDeletion="AccountDataDeletion",e.RelationsRecursion="RelationsRecursion",e.IntentionalMentions="IntentionalMentions",e}({}),a={[o.Thread]:{unstablePrefixes:["org.matrix.msc3440"],matrixVersion:"v1.3"},[o.ThreadUnreadNotifications]:{unstablePrefixes:["org.matrix.msc3771","org.matrix.msc3773"],matrixVersion:"v1.4"},[o.LoginTokenRequest]:{unstablePrefixes:["org.matrix.msc3882"]},[o.RelationBasedRedactions]:{unstablePrefixes:["org.matrix.msc3912"]},[o.AccountDataDeletion]:{unstablePrefixes:["org.matrix.msc3391"]},[o.RelationsRecursion]:{unstablePrefixes:["org.matrix.msc3981"],matrixVersion:"v1.10"},[o.IntentionalMentions]:{unstablePrefixes:["org.matrix.msc3952_intentional_mentions"],matrixVersion:"v1.7"}};function s(e){return l.apply(this,arguments)}function l(){return(l=(0,n.A)(function*(e){var t=new Map;for(var[r,n]of Object.entries(a)){var o,s,l,c,d=null!=(o=null==(s=e.versions)?void 0:s.includes(n.matrixVersion||""))&&o,u=null!=(l=null==(c=n.unstablePrefixes)?void 0:c.every(t=>{var r;return(null==(r=e.unstable_features)?void 0:r[t])===!0}))&&l;d?t.set(r,i.Stable):u?t.set(r,i.Unstable):t.set(r,i.Unsupported)}return t})).apply(this,arguments)}},39706:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MatrixWidgetType=void 0,t.MatrixWidgetType=function(e){return e.Custom="m.custom",e.JitsiMeet="m.jitsi",e.Stickerpicker="m.stickerpicker",e}({})},40055:(e,t,r)=>{"use strict";r.d(t,{MN:()=>d,gc:()=>c,iz:()=>l});var n=r(29301),i=r(84458),o=r(5408),a=r(36963),s=r(45514),l=function(e){return e.SUCCESS="SUCCESS",e.IGNORE="IGNORE",e.PROMPT="PROMPT",e.FAIL_PROMPT="FAIL_PROMPT",e.FAIL_ERROR="FAIL_ERROR",e}({}),c=function(e){return e.Invalid="Invalid homeserver discovery response",e.GenericFailure="Failed to get autodiscovery configuration from server",e.InvalidHsBaseUrl="Invalid base_url for m.homeserver",e.InvalidHomeserver="Homeserver URL does not appear to be a valid Matrix homeserver",e.InvalidIsBaseUrl="Invalid base_url for m.identity_server",e.InvalidIdentityServer="Identity server URL does not appear to be a valid identity server",e.InvalidIs="Invalid identity server discovery response",e.MissingWellknown="No .well-known JSON file found",e.InvalidJson="Invalid JSON",e.UnsupportedHomeserverSpecVersion="The homeserver does not meet the version requirements",e}({});class d{static fromDiscoveryConfig(e){var t=this;return(0,n.A)(function*(){var r,n={"m.homeserver":{state:d.FAIL_ERROR,error:d.ERROR_INVALID,base_url:null},"m.identity_server":{state:d.PROMPT,error:null,base_url:null}};if(!(null!=e&&e["m.homeserver"]))return o.vF.error("No m.homeserver key in config"),n["m.homeserver"].state=d.FAIL_PROMPT,n["m.homeserver"].error=d.ERROR_INVALID,Promise.resolve(n);if(!e["m.homeserver"].base_url)return o.vF.error("No m.homeserver base_url in config"),n["m.homeserver"].state=d.FAIL_PROMPT,n["m.homeserver"].error=d.ERROR_INVALID_HS_BASE_URL,Promise.resolve(n);var i=t.sanitizeWellKnownUrl(e["m.homeserver"].base_url);if(!i)return o.vF.error("Invalid base_url for m.homeserver"),n["m.homeserver"].error=d.ERROR_INVALID_HS_BASE_URL,Promise.resolve(n);var a=yield t.fetchWellKnownObject("".concat(i,"/_matrix/client/versions"));if(!a||!Array.isArray(null==(r=a.raw)?void 0:r.versions))return o.vF.error("Invalid /versions response"),n["m.homeserver"].error=d.ERROR_INVALID_HOMESERVER,n["m.homeserver"].base_url=i,Promise.resolve(n);var c=new Set(a.raw.versions),u=!1;for(var h of s.Hr)if(c.has(h)){u=!0;break}if(!u)return o.vF.error("Homeserver does not meet version requirements"),n["m.homeserver"].error=d.ERROR_UNSUPPORTED_HOMESERVER_SPEC_VERSION,n["m.homeserver"].base_url=i,Promise.resolve(n);n["m.homeserver"]={state:d.SUCCESS,error:null,base_url:i};var v="";if(e["m.identity_server"]){var p={"m.homeserver":n["m.homeserver"],"m.identity_server":{state:d.FAIL_PROMPT,error:d.ERROR_INVALID_IS,base_url:null}};if(!(v=t.sanitizeWellKnownUrl(e["m.identity_server"].base_url)))return o.vF.error("Invalid base_url for m.identity_server"),p["m.identity_server"].error=d.ERROR_INVALID_IS_BASE_URL,Promise.resolve(p);var m=yield t.fetchWellKnownObject("".concat(v,"/_matrix/identity/v2"));if(!(null!=m&&m.raw)||m.action!==l.SUCCESS)return o.vF.error("Invalid /v2 response"),p["m.identity_server"].error=d.ERROR_INVALID_IDENTITY_SERVER,p["m.identity_server"].base_url=v,Promise.resolve(p)}return v&&v.toString().length>0&&(n["m.identity_server"]={state:d.SUCCESS,error:null,base_url:v}),Object.keys(e).forEach(t=>{if("m.homeserver"===t||"m.identity_server"===t){var r=["error","state","base_url"];for(var i of Object.keys(e[t]))r.includes(i)||(n[t][i]=e[t][i])}else n[t]=e[t]}),Promise.resolve(n)})()}static findClientConfig(e){var t=this;return(0,n.A)(function*(){if(!e||"string"!=typeof e||0===e.length)throw Error("'domain' must be a string of non-zero length");var r={"m.homeserver":{state:d.FAIL_ERROR,error:d.ERROR_INVALID,base_url:null},"m.identity_server":{state:d.PROMPT,error:null,base_url:null}},n=e.includes("://")?e:"https://".concat(e),i=yield t.fetchWellKnownObject("".concat(n,"/.well-known/matrix/client"));return i&&i.action===l.SUCCESS?d.fromDiscoveryConfig(i.raw):(o.vF.error("No response or error when parsing .well-known"),i.reason&&o.vF.error(i.reason),i.action===l.IGNORE?r["m.homeserver"]={state:d.PROMPT,error:null,base_url:null}:(r["m.homeserver"].state=d.FAIL_PROMPT,r["m.homeserver"].error=d.ERROR_INVALID),Promise.resolve(r))})()}static getRawClientConfig(e){var t=this;return(0,n.A)(function*(){if(!e||"string"!=typeof e||0===e.length)throw Error("'domain' must be a string of non-zero length");var r,n=yield t.fetchWellKnownObject("https://".concat(e,"/.well-known/matrix/client"));return n&&null!=(r=n.raw)?r:{}})()}static sanitizeWellKnownUrl(e){if(!e)return!1;try{try{r=new URL(e)}catch(e){o.vF.error("Could not parse url",e)}if(!(null!=(t=r)&&t.hostname)||"http:"!==r.protocol&&"https:"!==r.protocol)return!1;var t,r,n=r.port?":".concat(r.port):"",i=r.pathname?r.pathname:"",a="".concat(r.protocol,"//").concat(r.hostname).concat(n).concat(i);return a.endsWith("/")&&(a=a.substring(0,a.length-1)),a}catch(e){return o.vF.error(e),!1}}static fetch(e,t){return this.fetchFn?this.fetchFn(e,t):globalThis.fetch(e,t)}static setFetchFn(e){d.fetchFn=e}static fetchWellKnownObject(e){return(0,n.A)(function*(){var t;try{if(t=yield d.fetch(e,{method:a.IT.Get,signal:(0,a._)(5e3)}),404===t.status)return{raw:{},action:l.IGNORE,reason:d.ERROR_MISSING_WELLKNOWN};if(200!==t.status)return{raw:{},action:l.FAIL_PROMPT,reason:"General failure"}}catch(e){var r="";return"object"==typeof e&&(r=null==e?void 0:e.message),{error:e,raw:{},action:l.FAIL_PROMPT,reason:r||"General failure"}}try{return{raw:yield t.json(),action:l.SUCCESS}}catch(e){return{error:e,raw:{},action:l.FAIL_PROMPT,reason:(null==e?void 0:e.name)==="SyntaxError"?d.ERROR_INVALID_JSON:d.ERROR_INVALID}}})()}}(0,i.A)(d,"ERROR_INVALID",c.Invalid),(0,i.A)(d,"ERROR_GENERIC_FAILURE",c.GenericFailure),(0,i.A)(d,"ERROR_INVALID_HS_BASE_URL",c.InvalidHsBaseUrl),(0,i.A)(d,"ERROR_INVALID_HOMESERVER",c.InvalidHomeserver),(0,i.A)(d,"ERROR_INVALID_IS_BASE_URL",c.InvalidIsBaseUrl),(0,i.A)(d,"ERROR_INVALID_IDENTITY_SERVER",c.InvalidIdentityServer),(0,i.A)(d,"ERROR_INVALID_IS",c.InvalidIs),(0,i.A)(d,"ERROR_MISSING_WELLKNOWN",c.MissingWellknown),(0,i.A)(d,"ERROR_INVALID_JSON",c.InvalidJson),(0,i.A)(d,"ERROR_UNSUPPORTED_HOMESERVER_SPEC_VERSION",c.UnsupportedHomeserverSpecVersion),(0,i.A)(d,"ALL_ERRORS",Object.keys(c)),(0,i.A)(d,"FAIL_ERROR",l.FAIL_ERROR),(0,i.A)(d,"FAIL_PROMPT",l.FAIL_PROMPT),(0,i.A)(d,"PROMPT",l.PROMPT),(0,i.A)(d,"SUCCESS",l.SUCCESS),(0,i.A)(d,"fetchFn",void 0)},40893:(e,t,r)=>{"use strict";r.d(t,{c:()=>n});class n{constructor(e,t){this.roomId=e}}},40898:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ClientWidgetApi=void 0;var n=r(91699),i=r(109),o=r(96039),a=r(61904),s=r(72368),l=r(55090),c=r(12826),d=r(11257),u=r(45093),h=r(79178),v=r(59879);function p(e){return(p="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function m(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function g(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?m(Object(r),!0).forEach(function(t){R(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):m(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function f(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=b(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return a=e.done,e},e:function(e){s=!0,o=e},f:function(){try{a||null==r.return||r.return()}finally{if(s)throw o}}}}function y(e){return function(e){if(Array.isArray(e))return S(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||b(e)||function(){throw TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function b(e,t){if(e){if("string"==typeof e)return S(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);if("Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return S(e,t)}}function S(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}function E(){E=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n=Object.defineProperty||function(e,t,r){e[t]=r.value},i="function"==typeof Symbol?Symbol:{},o=i.iterator||"@@iterator",a=i.asyncIterator||"@@asyncIterator",s=i.toStringTag||"@@toStringTag";function l(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(e){l=function(e,t,r){return e[t]=r}}function c(e,t,r,i){var o,a,s,l,c=Object.create((t&&t.prototype instanceof h?t:h).prototype);return n(c,"_invoke",{value:(o=e,a=r,s=new I(i||[]),l="suspendedStart",function(e,t){if("executing"===l)throw Error("Generator is already running");if("completed"===l){if("throw"===e)throw t;return R()}for(s.method=e,s.arg=t;;){var r=s.delegate;if(r){var n=function e(t,r){var n=r.method,i=t.iterator[n];if(void 0===i)return r.delegate=null,"throw"===n&&t.iterator.return&&(r.method="return",r.arg=void 0,e(t,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=TypeError("The iterator does not provide a '"+n+"' method")),u;var o=d(i,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,u;var a=o.arg;return a?a.done?(r[t.resultName]=a.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,u):a:(r.method="throw",r.arg=TypeError("iterator result is not an object"),r.delegate=null,u)}(r,s);if(n){if(n===u)continue;return n}}if("next"===s.method)s.sent=s._sent=s.arg;else if("throw"===s.method){if("suspendedStart"===l)throw l="completed",s.arg;s.dispatchException(s.arg)}else"return"===s.method&&s.abrupt("return",s.arg);l="executing";var i=d(o,a,s);if("normal"===i.type){if(l=s.done?"completed":"suspendedYield",i.arg===u)continue;return{value:i.arg,done:s.done}}"throw"===i.type&&(l="completed",s.method="throw",s.arg=i.arg)}})}),c}function d(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var u={};function h(){}function v(){}function m(){}var g={};l(g,o,function(){return this});var f=Object.getPrototypeOf,y=f&&f(f(A([])));y&&y!==t&&r.call(y,o)&&(g=y);var b=m.prototype=h.prototype=Object.create(g);function S(e){["next","throw","return"].forEach(function(t){l(e,t,function(e){return this._invoke(t,e)})})}function _(e,t){var i;n(this,"_invoke",{value:function(n,o){function a(){return new t(function(i,a){!function n(i,o,a,s){var l=d(e[i],e,o);if("throw"!==l.type){var c=l.arg,u=c.value;return u&&"object"==p(u)&&r.call(u,"__await")?t.resolve(u.__await).then(function(e){n("next",e,a,s)},function(e){n("throw",e,a,s)}):t.resolve(u).then(function(e){c.value=e,a(c)},function(e){return n("throw",e,a,s)})}s(l.arg)}(n,o,i,a)})}return i=i?i.then(a,a):a()}})}function w(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function T(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function I(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(w,this),this.reset(!0)}function A(e){if(e){var t=e[o];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,i=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return i.next=i}}return{next:R}}function R(){return{value:void 0,done:!0}}return v.prototype=m,n(b,"constructor",{value:m,configurable:!0}),n(m,"constructor",{value:v,configurable:!0}),v.displayName=l(m,s,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===v||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,m):(e.__proto__=m,l(e,s,"GeneratorFunction")),e.prototype=Object.create(b),e},e.awrap=function(e){return{__await:e}},S(_.prototype),l(_.prototype,a,function(){return this}),e.AsyncIterator=_,e.async=function(t,r,n,i,o){void 0===o&&(o=Promise);var a=new _(c(t,r,n,i),o);return e.isGeneratorFunction(r)?a:a.next().then(function(e){return e.done?e.value:a.next()})},S(b),l(b,s,"Generator"),l(b,o,function(){return this}),l(b,"toString",function(){return"[object Generator]"}),e.keys=function(e){var t=Object(e),r=[];for(var n in t)r.push(n);return r.reverse(),function e(){for(;r.length;){var n=r.pop();if(n in t)return e.value=n,e.done=!1,e}return e.done=!0,e}},e.values=A,I.prototype={constructor:I,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(T),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return a.type="throw",a.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var i=this.tryEntries.length-1;i>=0;--i){var o=this.tryEntries[i],a=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),l=r.call(o,"finallyLoc");if(s&&l){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!l)throw Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var i=this.tryEntries[n];if(i.tryLoc<=this.prev&&r.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var o=i;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var a=o?o.completion:{};return a.type=e,a.arg=t,o?(this.method="next",this.next=o.finallyLoc,u):this.complete(a)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),u},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),T(r),u}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var i=n.arg;T(r)}return i}}throw Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:A(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),u}},e}function _(e,t,r,n,i,o,a){try{var s=e[o](a),l=s.value}catch(e){r(e);return}s.done?t(l):Promise.resolve(l).then(n,i)}function w(e){return function(){var t=this,r=arguments;return new Promise(function(n,i){var o=e.apply(t,r);function a(e){_(o,n,i,a,s,"next",e)}function s(e){_(o,n,i,a,s,"throw",e)}a(void 0)})}}function T(e,t){return(T=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}function I(e){if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function A(e){return(A=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function R(e,t,r){return(t=C(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function C(e){var t=function(e,t){if("object"!==p(e)||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,t||"default");if("object"!==p(n))return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"===p(t)?t:String(t)}function k(e){function t(e){if(Object(e)!==e)return Promise.reject(TypeError(e+" is not an object."));var t=e.done;return Promise.resolve(e.value).then(function(e){return{value:e,done:t}})}return(k=function(e){this.s=e,this.n=e.next}).prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(e){var r=this.s.return;return void 0===r?Promise.resolve({value:e,done:!0}):t(r.apply(this.s,arguments))},throw:function(e){var r=this.s.return;return void 0===r?Promise.reject(e):t(r.apply(this.s,arguments))}},new k(e)}t.ClientWidgetApi=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");q.prototype=Object.create(e&&e.prototype,{constructor:{value:q,writable:!0,configurable:!0}}),Object.defineProperty(q,"prototype",{writable:!1}),e&&T(q,e);var t,r,n,m,b,S,_,O,M,P,D,x,F,L,U,N,j,B,W,K=(t=function(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}(),function(){var e,r=A(q);return e=t?Reflect.construct(r,arguments,A(this).constructor):r.apply(this,arguments),function(e,t){if(t&&("object"===p(t)||"function"==typeof t))return t;if(void 0!==t)throw TypeError("Derived constructors may only return object or undefined");return I(e)}(this,e)});function q(e,t,r){var n;if(!(this instanceof q))throw TypeError("Cannot call a class as a function");if((n=K.call(this)).widget=e,n.driver=r,R(I(n),"transport",void 0),R(I(n),"cachedWidgetVersions",null),R(I(n),"contentLoadedActionSent",!1),R(I(n),"allowedCapabilities",new Set),R(I(n),"allowedEvents",[]),R(I(n),"isStopped",!1),R(I(n),"turnServers",null),R(I(n),"contentLoadedWaitTimer",void 0),R(I(n),"pushRoomStateTasks",new Set),R(I(n),"pushRoomStateResult",new Map),R(I(n),"flushRoomStateTask",null),R(I(n),"viewedRoomId",null),!(null!=t&&t.contentWindow))throw Error("No iframe supplied");if(!e)throw Error("Invalid widget");if(!r)throw Error("Invalid driver");return n.transport=new i.PostmessageTransport(o.WidgetApiDirection.ToWidget,e.id,t.contentWindow,globalThis),n.transport.targetOrigin=e.origin,n.transport.on("message",n.handleMessage.bind(I(n))),t.addEventListener("load",n.onIframeLoad.bind(I(n))),n.transport.start(),n}return W=[{key:"hasCapability",value:function(e){return this.allowedCapabilities.has(e)}},{key:"canUseRoomTimeline",value:function(e){return this.hasCapability("org.matrix.msc2762.timeline:".concat(h.Symbols.AnyRoom))||this.hasCapability("org.matrix.msc2762.timeline:".concat(e))}},{key:"canSendRoomEvent",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return this.allowedEvents.some(function(r){return r.matchesAsRoomEvent(c.EventDirection.Send,e,t)})}},{key:"canSendStateEvent",value:function(e,t){return this.allowedEvents.some(function(r){return r.matchesAsStateEvent(c.EventDirection.Send,e,t)})}},{key:"canSendToDeviceEvent",value:function(e){return this.allowedEvents.some(function(t){return t.matchesAsToDeviceEvent(c.EventDirection.Send,e)})}},{key:"canReceiveRoomEvent",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return this.allowedEvents.some(function(r){return r.matchesAsRoomEvent(c.EventDirection.Receive,e,t)})}},{key:"canReceiveStateEvent",value:function(e,t){return this.allowedEvents.some(function(r){return r.matchesAsStateEvent(c.EventDirection.Receive,e,t)})}},{key:"canReceiveToDeviceEvent",value:function(e){return this.allowedEvents.some(function(t){return t.matchesAsToDeviceEvent(c.EventDirection.Receive,e)})}},{key:"canReceiveRoomAccountData",value:function(e){return this.allowedEvents.some(function(t){return t.matchesAsRoomAccountData(c.EventDirection.Receive,e)})}},{key:"stop",value:function(){this.isStopped=!0,this.transport.stop()}},{key:"getWidgetVersions",value:(r=w(E().mark(function e(){var t;return E().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!Array.isArray(this.cachedWidgetVersions)){e.next=2;break}return e.abrupt("return",this.cachedWidgetVersions);case 2:return e.prev=2,e.next=5,this.transport.send(a.WidgetApiToWidgetAction.SupportedApiVersions,{});case 5:return t=e.sent,this.cachedWidgetVersions=t.supported_versions,e.abrupt("return",t.supported_versions);case 10:return e.prev=10,e.t0=e.catch(2),console.warn("non-fatal error getting supported widget versions: ",e.t0),e.abrupt("return",[]);case 14:case"end":return e.stop()}},e,this,[[2,10]])})),function(){return r.apply(this,arguments)})},{key:"beginCapabilities",value:function(){var e,t=this;this.emit("preparing"),this.transport.send(a.WidgetApiToWidgetAction.Capabilities,{}).then(function(r){return e=r.capabilities,t.driver.validateCapabilities(new Set(r.capabilities))}).then(function(r){t.allowCapabilities(y(r),e),t.emit("ready")}).catch(function(e){t.emit("error:preparing",e)})}},{key:"allowCapabilities",value:function(e,t){var r,n=this;console.log("Widget ".concat(this.widget.id," is allowed capabilities:"),e);var i,o=f(e);try{for(o.s();!(i=o.n()).done;){var l=i.value;this.allowedCapabilities.add(l)}}catch(e){o.e(e)}finally{o.f()}var d=c.WidgetEventCapability.findEventCapabilities(e);(r=this.allowedEvents).push.apply(r,y(d)),this.transport.send(a.WidgetApiToWidgetAction.NotifyCapabilities,{requested:t,approved:Array.from(this.allowedCapabilities)}).catch(function(e){console.warn("non-fatal error notifying widget of approved capabilities:",e)}).then(function(){n.emit("capabilitiesNotified")});var u,v=f(e);try{for(v.s();!(u=v.n()).done;){var p=u.value;if((0,s.isTimelineCapability)(p)){var m=(0,s.getTimelineRoomIDFromCapability)(p);if(m===h.Symbols.AnyRoom){var g,b=f(this.driver.getKnownRooms());try{for(b.s();!(g=b.n()).done;){var S=g.value;this.pushRoomState(S)}}catch(e){b.e(e)}finally{b.f()}}else this.pushRoomState(m)}}}catch(e){v.e(e)}finally{v.f()}if(e.includes(s.MatrixCapabilities.MSC4407ReceiveStickyEvent)){console.debug("Widget ".concat(this.widget.id," is allowed to receive sticky events, check current sticky state."));var E=e.filter(function(e){return(0,s.isTimelineCapability)(e)}).map(function(e){return(0,s.getTimelineRoomIDFromCapability)(e)}).flatMap(function(e){return e===h.Symbols.AnyRoom?n.driver.getKnownRooms():e});console.debug("Widget ".concat(this.widget.id," is allowed to receive sticky events in rooms:"),E);var _,w=f(E);try{for(w.s();!(_=w.n()).done;)!function(){var e=_.value;n.pushStickyState(e).catch(function(t){console.error("Failed to push sticky events to widget ".concat(n.widget.id," for room ").concat(e,":"),t)})}()}catch(e){w.e(e)}finally{w.f()}}d.length>0&&null!==this.viewedRoomId&&!this.canUseRoomTimeline(this.viewedRoomId)&&this.pushRoomState(this.viewedRoomId)}},{key:"onIframeLoad",value:function(e){this.widget.waitForIframeLoad?this.beginCapabilities():(console.log("waitForIframeLoad is false: waiting for widget to send contentLoaded"),this.contentLoadedWaitTimer=setTimeout(function(){console.error("Widget specified waitForIframeLoad=false but timed out waiting for contentLoaded event!")},1e4),this.contentLoadedActionSent=!1)}},{key:"handleContentLoadedAction",value:function(e){if(void 0!==this.contentLoadedWaitTimer&&(clearTimeout(this.contentLoadedWaitTimer),this.contentLoadedWaitTimer=void 0),this.contentLoadedActionSent)throw Error("Improper sequence: ContentLoaded Action can only be sent once after the widget loaded and should only be used if waitForIframeLoad is false (default=true)");this.widget.waitForIframeLoad?this.transport.reply(e,{error:{message:"Improper sequence: not expecting ContentLoaded event if waitForIframeLoad is true (default=true)"}}):(this.transport.reply(e,{}),this.beginCapabilities()),this.contentLoadedActionSent=!0}},{key:"replyVersions",value:function(e){this.transport.reply(e,{supported_versions:l.CurrentApiVersions})}},{key:"supportsUpdateState",value:(n=w(E().mark(function e(){return E().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getWidgetVersions();case 2:return e.abrupt("return",e.sent.includes(l.UnstableApiVersion.MSC2762_UPDATE_STATE));case 3:case"end":return e.stop()}},e,this)})),function(){return n.apply(this,arguments)})},{key:"handleCapabilitiesRenegotiate",value:function(e){var t,r=this;this.transport.reply(e,{});var n=new Set(((null==(t=e.data)?void 0:t.capabilities)||[]).filter(function(e){return!r.hasCapability(e)}));0===n.size&&this.allowCapabilities([],[]),this.driver.validateCapabilities(n).then(function(e){return r.allowCapabilities(y(e),y(n))})}},{key:"handleNavigate",value:function(e){var t,r=this;if(!this.hasCapability(s.MatrixCapabilities.MSC2931Navigate))return this.transport.reply(e,{error:{message:"Missing capability"}});if(!(null!=(t=e.data)&&t.uri.startsWith("https://matrix.to/#")))return this.transport.reply(e,{error:{message:"Invalid matrix.to URI"}});var n=function(t){console.error("[ClientWidgetApi] Failed to handle navigation: ",t),r.handleDriverError(t,e,"Error handling navigation")};try{this.driver.navigate(e.data.uri.toString()).catch(function(e){return n(e)}).then(function(){return r.transport.reply(e,{})})}catch(e){return n(e)}}},{key:"handleOIDC",value:function(e){var t=this,r=1,n=function(n,i){return(i=i||{},r>1)?t.transport.send(a.WidgetApiToWidgetAction.OpenIDCredentials,g({state:n,original_request_id:e.requestId},i)):t.transport.reply(e,g({state:n},i))},i=function(i){return(console.error("[ClientWidgetApi] Failed to handle OIDC: ",i),r>1)?n(d.OpenIDRequestState.Blocked):t.transport.reply(e,{error:{message:i}})},o=new u.SimpleObservable(function(e){if(e.state===d.OpenIDRequestState.PendingUserConfirmation&&r>1)return o.close(),i("client provided out-of-phase response to OIDC flow");if(e.state===d.OpenIDRequestState.PendingUserConfirmation){n(e.state),r++;return}return e.state!==d.OpenIDRequestState.Allowed||e.token?(e.state===d.OpenIDRequestState.Blocked&&(e.token=void 0),o.close(),n(e.state,e.token)):i("client provided invalid OIDC token for an allowed request")});this.driver.askOpenID(o)}},{key:"handleReadRoomAccountData",value:function(e){var t=this,r=this.driver.readRoomAccountData(e.data.type);return this.canReceiveRoomAccountData(e.data.type)?r.then(function(r){t.transport.reply(e,{events:r})}):this.transport.reply(e,{error:{message:"Cannot read room account data of this type"}})}},{key:"handleReadEvents",value:(m=w(E().mark(function e(t){var r,n,i,o,a,s,l,c,d,u,v=this;return E().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t.data.type){e.next=2;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Invalid request - missing event type"}}));case 2:if(!(void 0!==t.data.limit&&(!t.data.limit||t.data.limit<0))){e.next=4;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Invalid request - limit out of range"}}));case 4:if(void 0!==t.data.room_ids){e.next=8;break}r=null===this.viewedRoomId?[]:[this.viewedRoomId],e.next=30;break;case 8:if(t.data.room_ids!==h.Symbols.AnyRoom){e.next=12;break}r=this.driver.getKnownRooms().filter(function(e){return v.canUseRoomTimeline(e)}),e.next=30;break;case 12:n=f(r=t.data.room_ids),e.prev=14,n.s();case 16:if((i=n.n()).done){e.next=22;break}if(o=i.value,this.canUseRoomTimeline(o)){e.next=20;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Unable to access room timeline: ".concat(o)}}));case 20:e.next=16;break;case 22:e.next=27;break;case 24:e.prev=24,e.t0=e.catch(14),n.e(e.t0);case 27:return e.prev=27,n.f(),e.finish(27);case 30:if(a=t.data.limit||0,s=t.data.since,l=void 0,c=void 0,void 0===t.data.state_key){e.next=40;break}if(l=!0===t.data.state_key?void 0:t.data.state_key.toString(),this.canReceiveStateEvent(t.data.type,null!=(d=l)?d:null)){e.next=38;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Cannot read state events of this type"}}));case 38:e.next=43;break;case 40:if(c=t.data.msgtype,this.canReceiveRoomEvent(t.data.type,c)){e.next=43;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Cannot read room events of this type"}}));case 43:if(void 0!==t.data.room_ids||0!==r.length){e.next=50;break}return console.warn("The widgetDriver uses deprecated behaviour:\n It does not set the viewedRoomId using `setViewedRoomId`"),e.next=47,void 0===t.data.state_key?this.driver.readRoomEvents(t.data.type,c,a,null,s):this.driver.readStateEvents(t.data.type,l,a,null);case 47:u=e.sent,e.next=68;break;case 50:return e.next=52,this.supportsUpdateState();case 52:if(!e.sent){e.next=58;break}return e.next=55,Promise.all(r.map(function(e){return v.driver.readRoomTimeline(e,t.data.type,c,l,a,s)}));case 55:u=e.sent.flat(1),e.next=68;break;case 58:if(void 0!==t.data.state_key){e.next=64;break}return e.next=61,Promise.all(r.map(function(e){return v.driver.readRoomTimeline(e,t.data.type,c,l,a,s)}));case 61:e.t1=e.sent,e.next=67;break;case 64:return e.next=66,Promise.all(r.map(function(e){return v.driver.readRoomState(e,t.data.type,l)}));case 66:e.t1=e.sent;case 67:u=e.t1.flat(1);case 68:this.transport.reply(t,{events:u});case 69:case"end":return e.stop()}},e,this,[[14,24,27,30]])})),function(e){return m.apply(this,arguments)})},{key:"handleSendEvent",value:function(e){var t=this;if(!e.data.type)return this.transport.reply(e,{error:{message:"Invalid request - missing event type"}});if(e.data.room_id&&!this.canUseRoomTimeline(e.data.room_id))return this.transport.reply(e,{error:{message:"Unable to access room timeline: ".concat(e.data.room_id)}});var r=void 0!==e.data.delay||void 0!==e.data.parent_delay_id;if(r&&!this.hasCapability(s.MatrixCapabilities.MSC4157SendDelayedEvent))return this.transport.reply(e,{error:{message:"Missing capability for ".concat(s.MatrixCapabilities.MSC4157SendDelayedEvent)}});var n=void 0!==e.data.sticky_duration_ms;if(n&&!this.hasCapability(s.MatrixCapabilities.MSC4407SendStickyEvent))return this.transport.reply(e,{error:{message:"Missing capability for ".concat(s.MatrixCapabilities.MSC4407SendStickyEvent)}});if(void 0!==e.data.state_key){if(!this.canSendStateEvent(e.data.type,e.data.state_key))return this.transport.reply(e,{error:{message:"Cannot send state events of this type"}});if(n)return this.transport.reply(e,{error:{message:"Cannot send a state event with a sticky duration"}});i=r?this.driver.sendDelayedEvent(null!=(o=e.data.delay)?o:null,null!=(a=e.data.parent_delay_id)?a:null,e.data.type,e.data.content||{},e.data.state_key,e.data.room_id):this.driver.sendEvent(e.data.type,e.data.content||{},e.data.state_key,e.data.room_id)}else{var i,o,a,l,c,d,u,h,v,p=e.data.content||{},m=p.msgtype;if(!this.canSendRoomEvent(e.data.type,m))return this.transport.reply(e,{error:{message:"Cannot send room events of this type"}});var f=[e.data.type,p,null,e.data.room_id];i=r&&e.data.sticky_duration_ms?this.driver.sendDelayedStickyEvent(null!=(l=e.data.delay)?l:null,null!=(c=e.data.parent_delay_id)?c:null,e.data.sticky_duration_ms,e.data.type,p,e.data.room_id):r?(d=this.driver).sendDelayedEvent.apply(d,[null!=(u=e.data.delay)?u:null,null!=(h=e.data.parent_delay_id)?h:null].concat(f)):e.data.sticky_duration_ms?this.driver.sendStickyEvent(e.data.sticky_duration_ms,e.data.type,p,e.data.room_id):(v=this.driver).sendEvent.apply(v,f)}i.then(function(r){return t.transport.reply(e,g({room_id:r.roomId},"eventId"in r?{event_id:r.eventId}:{delay_id:r.delayId}))}).catch(function(r){console.error("error sending event: ",r),t.handleDriverError(r,e,"Error sending event")})}},{key:"handleUpdateDelayedEvent",value:function(e){var t,r=this;if(!e.data.delay_id)return this.transport.reply(e,{error:{message:"Invalid request - missing delay_id"}});if(!this.hasCapability(s.MatrixCapabilities.MSC4157UpdateDelayedEvent))return this.transport.reply(e,{error:{message:"Missing capability"}});switch(e.data.action){case v.UpdateDelayedEventAction.Cancel:t=this.driver.cancelScheduledDelayedEvent;break;case v.UpdateDelayedEventAction.Restart:t=this.driver.restartScheduledDelayedEvent;break;case v.UpdateDelayedEventAction.Send:t=this.driver.sendScheduledDelayedEvent;break;default:return this.transport.reply(e,{error:{message:"Invalid request - unsupported action"}})}t.call(this.driver,e.data.delay_id).then(function(){return r.transport.reply(e,{})}).catch(function(t){console.error("error updating delayed event: ",t),r.handleDriverError(t,e,"Error updating delayed event")})}},{key:"handleSendToDevice",value:(b=w(E().mark(function e(t){return E().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t.data.type){e.next=4;break}this.transport.reply(t,{error:{message:"Invalid request - missing event type"}}),e.next=26;break;case 4:if(t.data.messages){e.next=8;break}this.transport.reply(t,{error:{message:"Invalid request - missing event contents"}}),e.next=26;break;case 8:if("boolean"==typeof t.data.encrypted){e.next=12;break}this.transport.reply(t,{error:{message:"Invalid request - missing encryption flag"}}),e.next=26;break;case 12:if(this.canSendToDeviceEvent(t.data.type)){e.next=16;break}this.transport.reply(t,{error:{message:"Cannot send to-device events of this type"}}),e.next=26;break;case 16:return e.prev=16,e.next=19,this.driver.sendToDevice(t.data.type,t.data.encrypted,t.data.messages);case 19:this.transport.reply(t,{}),e.next=26;break;case 22:e.prev=22,e.t0=e.catch(16),console.error("error sending to-device event",e.t0),this.handleDriverError(e.t0,t,"Error sending event");case 26:case"end":return e.stop()}},e,this,[[16,22]])})),function(e){return b.apply(this,arguments)})},{key:"pollTurnServers",value:(S=w(E().mark(function e(t,r){var n,i,o,s,l,c;return E().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.transport.send(a.WidgetApiToWidgetAction.UpdateTurnServers,r);case 3:n=!1,i=!1,e.prev=5,s=function(e){var t,r,n,i=2;for("undefined"!=typeof Symbol&&(r=Symbol.asyncIterator,n=Symbol.iterator);i--;){if(r&&null!=(t=e[r]))return t.call(e);if(n&&null!=(t=e[n]))return new k(t.call(e));r="@@asyncIterator",n="@@iterator"}throw TypeError("Object is not async iterable")}(t);case 7:return e.next=9,s.next();case 9:if(!(n=!(l=e.sent).done)){e.next=16;break}return c=l.value,e.next=13,this.transport.send(a.WidgetApiToWidgetAction.UpdateTurnServers,c);case 13:n=!1,e.next=7;break;case 16:e.next=22;break;case 18:e.prev=18,e.t0=e.catch(5),i=!0,o=e.t0;case 22:if(e.prev=22,e.prev=23,!(n&&null!=s.return)){e.next=27;break}return e.next=27,s.return();case 27:if(e.prev=27,!i){e.next=30;break}throw o;case 30:return e.finish(27);case 31:return e.finish(22);case 32:e.next=37;break;case 34:e.prev=34,e.t1=e.catch(0),console.error("error polling for TURN servers",e.t1);case 37:case"end":return e.stop()}},e,this,[[0,34],[5,18,22,32],[23,,27,31]])})),function(e,t){return S.apply(this,arguments)})},{key:"handleWatchTurnServers",value:(_=w(E().mark(function e(t){var r,n,i,o;return E().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.hasCapability(s.MatrixCapabilities.MSC3846TurnServers)){e.next=4;break}this.transport.reply(t,{error:{message:"Missing capability"}}),e.next=26;break;case 4:if(!this.turnServers){e.next=8;break}this.transport.reply(t,{}),e.next=26;break;case 8:return e.prev=8,r=this.driver.getTurnServers(),e.next=12,r.next();case 12:if(i=(n=e.sent).done,o=n.value,!i){e.next=17;break}throw Error("Client refuses to provide any TURN servers");case 17:this.transport.reply(t,{}),this.pollTurnServers(r,o),this.turnServers=r,e.next=26;break;case 22:e.prev=22,e.t0=e.catch(8),console.error("error getting first TURN server results",e.t0),this.transport.reply(t,{error:{message:"TURN servers not available"}});case 26:case"end":return e.stop()}},e,this,[[8,22]])})),function(e){return _.apply(this,arguments)})},{key:"handleUnwatchTurnServers",value:(O=w(E().mark(function e(t){return E().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.hasCapability(s.MatrixCapabilities.MSC3846TurnServers)){e.next=4;break}this.transport.reply(t,{error:{message:"Missing capability"}}),e.next=12;break;case 4:if(this.turnServers){e.next=8;break}this.transport.reply(t,{}),e.next=12;break;case 8:return e.next=10,this.turnServers.return(void 0);case 10:this.turnServers=null,this.transport.reply(t,{});case 12:case"end":return e.stop()}},e,this)})),function(e){return O.apply(this,arguments)})},{key:"handleReadRelations",value:(M=w(E().mark(function e(t){var r,n,i=this;return E().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t.data.event_id){e.next=2;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Invalid request - missing event ID"}}));case 2:if(!(void 0!==t.data.limit&&t.data.limit<0)){e.next=4;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Invalid request - limit out of range"}}));case 4:if(!(void 0!==t.data.room_id&&!this.canUseRoomTimeline(t.data.room_id))){e.next=6;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Unable to access room timeline: ".concat(t.data.room_id)}}));case 6:return e.prev=6,e.next=9,this.driver.readEventRelations(t.data.event_id,t.data.room_id,t.data.rel_type,t.data.event_type,t.data.from,t.data.to,t.data.limit,t.data.direction);case 9:return n=(r=e.sent).chunk.filter(function(e){return void 0!==e.state_key?i.canReceiveStateEvent(e.type,e.state_key):i.canReceiveRoomEvent(e.type,e.content.msgtype)}),e.abrupt("return",this.transport.reply(t,{chunk:n,prev_batch:r.prevBatch,next_batch:r.nextBatch}));case 14:e.prev=14,e.t0=e.catch(6),console.error("error getting the relations",e.t0),this.handleDriverError(e.t0,t,"Unexpected error while reading relations");case 18:case"end":return e.stop()}},e,this,[[6,14]])})),function(e){return M.apply(this,arguments)})},{key:"handleUserDirectorySearch",value:(P=w(E().mark(function e(t){var r;return E().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.hasCapability(s.MatrixCapabilities.MSC3973UserDirectorySearch)){e.next=2;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Missing capability"}}));case 2:if("string"==typeof t.data.search_term){e.next=4;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Invalid request - missing search term"}}));case 4:if(!(void 0!==t.data.limit&&t.data.limit<0)){e.next=6;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Invalid request - limit out of range"}}));case 6:return e.prev=6,e.next=9,this.driver.searchUserDirectory(t.data.search_term,t.data.limit);case 9:return r=e.sent,e.abrupt("return",this.transport.reply(t,{limited:r.limited,results:r.results.map(function(e){return{user_id:e.userId,display_name:e.displayName,avatar_url:e.avatarUrl}})}));case 13:e.prev=13,e.t0=e.catch(6),console.error("error searching in the user directory",e.t0),this.handleDriverError(e.t0,t,"Unexpected error while searching in the user directory");case 17:case"end":return e.stop()}},e,this,[[6,13]])})),function(e){return P.apply(this,arguments)})},{key:"handleGetMediaConfig",value:(D=w(E().mark(function e(t){var r;return E().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.hasCapability(s.MatrixCapabilities.MSC4039UploadFile)){e.next=2;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Missing capability"}}));case 2:return e.prev=2,e.next=5,this.driver.getMediaConfig();case 5:return r=e.sent,e.abrupt("return",this.transport.reply(t,r));case 9:e.prev=9,e.t0=e.catch(2),console.error("error while getting the media configuration",e.t0),this.handleDriverError(e.t0,t,"Unexpected error while getting the media configuration");case 13:case"end":return e.stop()}},e,this,[[2,9]])})),function(e){return D.apply(this,arguments)})},{key:"handleUploadFile",value:(x=w(E().mark(function e(t){var r;return E().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.hasCapability(s.MatrixCapabilities.MSC4039UploadFile)){e.next=2;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Missing capability"}}));case 2:return e.prev=2,e.next=5,this.driver.uploadFile(t.data.file);case 5:return r=e.sent,e.abrupt("return",this.transport.reply(t,{content_uri:r.contentUri}));case 9:e.prev=9,e.t0=e.catch(2),console.error("error while uploading a file",e.t0),this.handleDriverError(e.t0,t,"Unexpected error while uploading a file");case 13:case"end":return e.stop()}},e,this,[[2,9]])})),function(e){return x.apply(this,arguments)})},{key:"handleDownloadFile",value:(F=w(E().mark(function e(t){var r;return E().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.hasCapability(s.MatrixCapabilities.MSC4039DownloadFile)){e.next=2;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Missing capability"}}));case 2:return e.prev=2,e.next=5,this.driver.downloadFile(t.data.content_uri);case 5:return r=e.sent,e.abrupt("return",this.transport.reply(t,{file:r.file}));case 9:e.prev=9,e.t0=e.catch(2),console.error("error while downloading a file",e.t0),this.handleDriverError(e.t0,t,"Unexpected error while downloading a file");case 13:case"end":return e.stop()}},e,this,[[2,9]])})),function(e){return F.apply(this,arguments)})},{key:"handleDriverError",value:function(e,t,r){var n=this.driver.processError(e);this.transport.reply(t,{error:g({message:r},n)})}},{key:"handleMessage",value:function(e){if(!this.isStopped){var t=new CustomEvent("action:".concat(e.detail.action),{detail:e.detail,cancelable:!0});if(this.emit("action:".concat(e.detail.action),t),!t.defaultPrevented)switch(e.detail.action){case a.WidgetApiFromWidgetAction.ContentLoaded:return this.handleContentLoadedAction(e.detail);case a.WidgetApiFromWidgetAction.SupportedApiVersions:return this.replyVersions(e.detail);case a.WidgetApiFromWidgetAction.SendEvent:return this.handleSendEvent(e.detail);case a.WidgetApiFromWidgetAction.SendToDevice:return this.handleSendToDevice(e.detail);case a.WidgetApiFromWidgetAction.GetOpenIDCredentials:return this.handleOIDC(e.detail);case a.WidgetApiFromWidgetAction.MSC2931Navigate:return this.handleNavigate(e.detail);case a.WidgetApiFromWidgetAction.MSC2974RenegotiateCapabilities:return this.handleCapabilitiesRenegotiate(e.detail);case a.WidgetApiFromWidgetAction.MSC2876ReadEvents:return this.handleReadEvents(e.detail);case a.WidgetApiFromWidgetAction.WatchTurnServers:return this.handleWatchTurnServers(e.detail);case a.WidgetApiFromWidgetAction.UnwatchTurnServers:return this.handleUnwatchTurnServers(e.detail);case a.WidgetApiFromWidgetAction.MSC3869ReadRelations:return this.handleReadRelations(e.detail);case a.WidgetApiFromWidgetAction.MSC3973UserDirectorySearch:return this.handleUserDirectorySearch(e.detail);case a.WidgetApiFromWidgetAction.BeeperReadRoomAccountData:return this.handleReadRoomAccountData(e.detail);case a.WidgetApiFromWidgetAction.MSC4039GetMediaConfigAction:return this.handleGetMediaConfig(e.detail);case a.WidgetApiFromWidgetAction.MSC4039UploadFileAction:return this.handleUploadFile(e.detail);case a.WidgetApiFromWidgetAction.MSC4039DownloadFileAction:return this.handleDownloadFile(e.detail);case a.WidgetApiFromWidgetAction.MSC4157UpdateDelayedEvent:return this.handleUpdateDelayedEvent(e.detail);default:return this.transport.reply(e.detail,{error:{message:"Unknown or unsupported from-widget action: "+e.detail.action}})}}}},{key:"updateTheme",value:function(e){return this.transport.send(a.WidgetApiToWidgetAction.ThemeChange,e)}},{key:"updateLanguage",value:function(e){return this.transport.send(a.WidgetApiToWidgetAction.LanguageChange,{lang:e})}},{key:"takeScreenshot",value:function(){return this.transport.send(a.WidgetApiToWidgetAction.TakeScreenshot,{})}},{key:"updateVisibility",value:function(e){return this.transport.send(a.WidgetApiToWidgetAction.UpdateVisibility,{visible:e})}},{key:"sendWidgetConfig",value:function(e){return this.transport.send(a.WidgetApiToWidgetAction.WidgetConfig,e).then()}},{key:"notifyModalWidgetButtonClicked",value:function(e){return this.transport.send(a.WidgetApiToWidgetAction.ButtonClicked,{id:e}).then()}},{key:"notifyModalWidgetClose",value:function(e){return this.transport.send(a.WidgetApiToWidgetAction.CloseModalWidget,e).then()}},{key:"feedEvent",value:(L=w(E().mark(function e(t,r){var n;return E().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0!==r&&this.setViewedRoomId(r),!(t.room_id!==this.viewedRoomId&&!this.canUseRoomTimeline(t.room_id))){e.next=3;break}return e.abrupt("return");case 3:if(void 0===t.state_key||null===t.state_key){e.next=8;break}if(this.canReceiveStateEvent(t.type,t.state_key)){e.next=6;break}return e.abrupt("return");case 6:e.next=10;break;case 8:if(this.canReceiveRoomEvent(t.type,null==(n=t.content)?void 0:n.msgtype)){e.next=10;break}return e.abrupt("return");case 10:return e.next=12,this.transport.send(a.WidgetApiToWidgetAction.SendEvent,t);case 12:case"end":return e.stop()}},e,this)})),function(e,t){return L.apply(this,arguments)})},{key:"feedToDevice",value:(U=w(E().mark(function e(t,r){return E().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.canReceiveToDeviceEvent(t.type)){e.next=3;break}return e.next=3,this.transport.send(a.WidgetApiToWidgetAction.SendToDevice,g(g({},t),{},{encrypted:r}));case 3:case"end":return e.stop()}},e,this)})),function(e,t){return U.apply(this,arguments)})},{key:"setViewedRoomId",value:function(e){this.viewedRoomId=e,null===e||this.canUseRoomTimeline(e)||this.pushRoomState(e)}},{key:"flushRoomState",value:(N=w(E().mark(function e(){var t,r,n,i,o,s,c;return E().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:e.prev=0;case 1:return e.next=3,Promise.all(this.pushRoomStateTasks);case 3:if(this.pushRoomStateTasks.size>0){e.next=1;break}case 4:t=[],r=f(this.pushRoomStateResult.values());try{for(r.s();!(n=r.n()).done;){i=n.value,o=f(i.values());try{for(o.s();!(s=o.n()).done;)c=s.value,t.push.apply(t,y(c.values()))}catch(e){o.e(e)}finally{o.f()}}}catch(e){r.e(e)}finally{r.f()}return e.next=9,this.getWidgetVersions();case 9:if(!e.sent.includes(l.UnstableApiVersion.MSC2762_UPDATE_STATE)){e.next=12;break}return e.next=12,this.transport.send(a.WidgetApiToWidgetAction.UpdateState,{state:t});case 12:return e.prev=12,this.flushRoomStateTask=null,e.finish(12);case 15:case"end":return e.stop()}},e,this,[[0,,12,15]])})),function(){return N.apply(this,arguments)})},{key:"pushStickyState",value:(j=w(E().mark(function e(t){var r=this;return E().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return console.debug("Pushing sticky state to widget for room",t),e.abrupt("return",this.driver.readStickyEvents(t).then(function(e){return{roomId:t,stickyEvents:e.filter(function(e){var t;return r.canReceiveRoomEvent(e.type,"string"==typeof(null==(t=e.content)?void 0:t.msgtype)?e.content.msgtype:null)})}}).then(function(){var e=w(E().mark(function e(t){var n,i,o;return E().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.roomId,console.debug("Pushing",(i=t.stickyEvents).length,"sticky events to widget for room",n),o=i.map(function(e){return r.transport.send(a.WidgetApiToWidgetAction.SendEvent,e)}),e.next=5,Promise.all(o);case 5:case"end":return e.stop()}},e)}));return function(t){return e.apply(this,arguments)}}()));case 2:case"end":return e.stop()}},e,this)})),function(e){return j.apply(this,arguments)})},{key:"pushRoomState",value:function(e){var t,r=this,n=f(this.allowedEvents);try{for(n.s();!(t=n.n()).done;)!function(){var n=t.value;if(n.kind===c.EventKind.State&&n.direction===c.EventDirection.Receive){var i,o=r.driver.readRoomState(e,n.eventType,null!=(i=n.keyStr)?i:void 0).then(function(t){var i,o=f(t);try{for(o.s();!(i=o.n()).done;){var a=i.value,s=r.pushRoomStateResult.get(e);void 0===s&&(s=new Map,r.pushRoomStateResult.set(e,s));var l=s.get(n.eventType);void 0===l&&(l=new Map,s.set(n.eventType,l)),l.has(a.state_key)||l.set(a.state_key,a)}}catch(e){o.e(e)}finally{o.f()}},function(t){return console.error("Failed to read room state for ".concat(e," (").concat(n.eventType,", ").concat(n.keyStr,")"),t)}).then(function(){r.pushRoomStateTasks.delete(o)});r.pushRoomStateTasks.add(o),null!=r.flushRoomStateTask||(r.flushRoomStateTask=r.flushRoomState()),r.flushRoomStateTask.catch(function(e){return console.error("Failed to push room state",e)})}}()}catch(e){n.e(e)}finally{n.f()}}},{key:"feedStateUpdate",value:(B=w(E().mark(function e(t){var r,n;return E().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0!==t.state_key){e.next=2;break}throw Error("Not a state event");case 2:if(!((t.room_id===this.viewedRoomId||this.canUseRoomTimeline(t.room_id))&&this.canReceiveStateEvent(t.type,t.state_key))){e.next=21;break}if(0!==this.pushRoomStateTasks.size){e.next=11;break}return e.next=6,this.getWidgetVersions();case 6:if(!e.sent.includes(l.UnstableApiVersion.MSC2762_UPDATE_STATE)){e.next=9;break}return e.next=9,this.transport.send(a.WidgetApiToWidgetAction.UpdateState,{state:[t]});case 9:e.next=21;break;case 11:void 0===(r=this.pushRoomStateResult.get(t.room_id))&&(r=new Map,this.pushRoomStateResult.set(t.room_id,r)),void 0===(n=r.get(t.type))&&(n=new Map,r.set(t.type,n)),n.has(t.type)||n.set(t.state_key,t);case 16:return e.next=18,Promise.all(this.pushRoomStateTasks);case 18:if(this.pushRoomStateTasks.size>0){e.next=16;break}case 19:return e.next=21,this.flushRoomStateTask;case 21:case"end":return e.stop()}},e,this)})),function(e){return B.apply(this,arguments)})}],function(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,C(n.key),n)}}(q.prototype,W),Object.defineProperty(q,"prototype",{writable:!1}),q}(n.EventEmitter)},40977:(e,t,r)=>{"use strict";r.d(t,{e:()=>h,o:()=>u});var n=r(29301),i=r(84458),o=r(49699),a=r(90426),s=r(29927),l=r(5408),c=r(9086),d=r(64763),u=function(e){return e.Incoming="GroupCall.incoming",e.Outgoing="GroupCall.outgoing",e.Ended="GroupCall.ended",e.Participants="GroupCall.participants",e}({});class h{constructor(e){this.client=e,(0,i.A)(this,"groupCalls",new Map),(0,i.A)(this,"roomDeferreds",new Map),(0,i.A)(this,"onRoomsChanged",e=>{this.createGroupCallForRoom(e)}),(0,i.A)(this,"onRoomStateChanged",(e,t)=>{if(e.getType()===c.Bx.GroupCallPrefix){var r=e.getStateKey(),n=e.getContent(),i=this.groupCalls.get(t.roomId);i||n["m.terminated"]||e.isRedacted()?i&&i.groupCallId===r?n["m.terminated"]||e.isRedacted()?i.terminate(!1):n["m.type"]!==i.type&&l.vF.warn("GroupCallEventHandler onRoomStateChanged() currently does not support changing type (roomId=".concat(t.roomId,")")):i&&i.groupCallId!==r&&l.vF.warn("GroupCallEventHandler onRoomStateChanged() currently does not support multiple calls (roomId=".concat(t.roomId,")")):this.createGroupCallFromRoomStateEvent(e)}})}start(){var e=this;return(0,n.A)(function*(){for(var t of(e.client.getSyncState()!==d.Lm.Syncing&&(l.vF.debug("GroupCallEventHandler start() waiting for client to start syncing"),yield new Promise(t=>{var r=()=>{if(e.client.getSyncState()===d.Lm.Syncing)return e.client.off(o.AU.Sync,r),t()};e.client.on(o.AU.Sync,r)})),e.client.getRooms()))e.createGroupCallForRoom(t);e.client.on(o.AU.Room,e.onRoomsChanged),e.client.on(s.f.Events,e.onRoomStateChanged)})()}stop(){this.client.removeListener(o.AU.Room,this.onRoomsChanged),this.client.removeListener(s.f.Events,this.onRoomStateChanged)}getRoomDeferred(e){var t,r=this.roomDeferreds.get(e);return void 0===r&&((r={prom:new Promise(e=>{t=e})}).resolve=t,this.roomDeferreds.set(e,r)),r}waitUntilRoomReadyForGroupCalls(e){return this.getRoomDeferred(e).prom}getGroupCallById(e){return[...this.groupCalls.values()].find(t=>t.groupCallId===e)}createGroupCallForRoom(e){var t=e.currentState.getStateEvents(c.Bx.GroupCallPrefix);for(var r of t.sort((e,t)=>t.getTs()-e.getTs()))if(!(r.getContent()["m.terminated"]||r.isRedacted())){l.vF.debug("GroupCallEventHandler createGroupCallForRoom() choosing group call from possible calls (stateKey=".concat(r.getStateKey(),", ts=").concat(r.getTs(),", roomId=").concat(e.roomId,", numOfPossibleCalls=").concat(t.length,")")),this.createGroupCallFromRoomStateEvent(r);break}this.getRoomDeferred(e.roomId).resolve()}createGroupCallFromRoomStateEvent(e){var t,r=e.getRoomId(),n=e.getContent(),i=this.client.getRoom(r);if(!i)return void l.vF.warn("GroupCallEventHandler createGroupCallFromRoomStateEvent() couldn't find room for call (roomId=".concat(r,")"));var o=e.getStateKey(),s=n["m.type"];if(!Object.values(a.Ad).includes(s))return void l.vF.warn("GroupCallEventHandler createGroupCallFromRoomStateEvent() received invalid call type (type=".concat(s,", roomId=").concat(r,")"));var c=n["m.intent"];if(!Object.values(a.MC).includes(c))return void l.vF.warn("Received invalid group call intent (type=".concat(s,", roomId=").concat(r,")"));var d=!!n["io.element.ptt"];if(null!=n&&n.dataChannelsEnabled&&null!=n&&n.dataChannelOptions){var{ordered:h,maxPacketLifeTime:v,maxRetransmits:p,protocol:m}=n.dataChannelOptions;t={ordered:h,maxPacketLifeTime:v,maxRetransmits:p,protocol:m}}var g=new a.eO(this.client,i,s,d,c,o,(null==n?void 0:n.dataChannelsEnabled)||this.client.isVoipWithNoMediaAllowed,t,this.client.isVoipWithNoMediaAllowed,this.client.useLivekitForGroupCalls,n["io.element.livekit_service_url"]);return this.groupCalls.set(i.roomId,g),this.client.emit(u.Incoming,g),g}}},41948:(e,t,r)=>{"use strict";r.d(t,{S:()=>d,s:()=>h});var n=r(29301),i=r(84458),o=r(82393),a=r(5408),s=r(9086),l=r(15095),c=r(61219),d=function(e){return e.Add="Relations.add",e.Remove="Relations.remove",e.Redaction="Relations.redaction",e}({}),u=function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];return[t,...r].includes(e)};class h extends l.X{constructor(e,t,r,a){var l;super(),l=this,this.relationType=e,this.eventType=t,this.altEventTypes=a,(0,i.A)(this,"relationEventIds",new Set),(0,i.A)(this,"relations",new Set),(0,i.A)(this,"annotationsByKey",{}),(0,i.A)(this,"annotationsBySender",{}),(0,i.A)(this,"sortedAnnotationsByKey",[]),(0,i.A)(this,"targetEvent",null),(0,i.A)(this,"creationEmitted",!1),(0,i.A)(this,"client",void 0),(0,i.A)(this,"onEventStatus",(e,t)=>{if(!e.isSending())return void e.removeListener(o.OQ.Status,this.onEventStatus);t===o.fb.CANCELLED&&(e.removeListener(o.OQ.Status,this.onEventStatus),this.removeEvent(e))}),(0,i.A)(this,"onBeforeRedaction",function(){var e=(0,n.A)(function*(e){if(l.relations.has(e)){if(l.relations.delete(e),l.relationType===s.zZ.Annotation)l.removeAnnotationFromAggregation(e);else if(l.relationType===s.zZ.Replace&&l.targetEvent&&!l.targetEvent.isState()){var t=yield l.getLastReplacement();l.targetEvent.makeReplaced(t)}e.removeListener(o.OQ.BeforeRedaction,l.onBeforeRedaction),l.emit(d.Redaction,e)}});return function(t){return e.apply(this,arguments)}}()),this.client=r instanceof c.Wv?r.client:r}addEvent(e){var t=this;return(0,n.A)(function*(){if(!t.relationEventIds.has(e.getId())){var r=e.getRelation();if(!r)return void a.vF.error("Event must have relation info");var n=r.rel_type,i=e.getType();if(t.relationType!==n||!u(i,t.eventType,t.altEventTypes))return void a.vF.error("Event relation info doesn't match this container");if(e.isSending()&&e.on(o.OQ.Status,t.onEventStatus),t.relations.add(e),t.relationEventIds.add(e.getId()),t.relationType===s.zZ.Annotation)t.addAnnotationToAggregation(e);else if(t.relationType===s.zZ.Replace&&t.targetEvent&&!t.targetEvent.isState()){var l=yield t.getLastReplacement();t.targetEvent.makeReplaced(l)}e.on(o.OQ.BeforeRedaction,t.onBeforeRedaction),t.emit(d.Add,e),t.maybeEmitCreated()}})()}removeEvent(e){var t=this;return(0,n.A)(function*(){if(t.relations.has(e)){if(t.relations.delete(e),t.relationType===s.zZ.Annotation)t.removeAnnotationFromAggregation(e);else if(t.relationType===s.zZ.Replace&&t.targetEvent&&!t.targetEvent.isState()){var r=yield t.getLastReplacement();t.targetEvent.makeReplaced(r)}t.emit(d.Remove,e)}})()}getRelations(){return[...this.relations]}addAnnotationToAggregation(e){var t,{key:r}=null!=(t=e.getRelation())?t:{};if(r){var n=this.annotationsByKey[r];n||(n=this.annotationsByKey[r]=new Set,this.sortedAnnotationsByKey.push([r,n])),n.add(e),this.sortedAnnotationsByKey.sort((e,t)=>{var r=e[1];return t[1].size-r.size});var i=e.getSender(),o=this.annotationsBySender[i];o||(o=this.annotationsBySender[i]=new Set),o.add(e)}}removeAnnotationFromAggregation(e){var t,{key:r}=null!=(t=e.getRelation())?t:{};if(r){var n=this.annotationsByKey[r];n&&(n.delete(e),this.sortedAnnotationsByKey.sort((e,t)=>{var r=e[1];return t[1].size-r.size}));var i=e.getSender(),o=this.annotationsBySender[i];o&&o.delete(e)}}getSortedAnnotationsByKey(){return this.relationType!==s.zZ.Annotation?null:this.sortedAnnotationsByKey}getAnnotationsBySender(){return this.relationType!==s.zZ.Annotation?null:this.annotationsBySender}getLastReplacement(){var e=this;return(0,n.A)(function*(){if(e.relationType!==s.zZ.Replace||!e.targetEvent)return null;var t=e.targetEvent.getServerAggregatedRelation(s.zZ.Replace),r=null==t?void 0:t.origin_server_ts,n=e.getRelations().reduce((t,n)=>n.getSender()!==e.targetEvent.getSender()||r&&r>n.getTs()||t&&t.getTs()>n.getTs()?t:n,null);return null!=n&&n.shouldAttemptDecryption()&&e.client.getCrypto()?yield n.attemptDecryption(e.client.getCrypto()):null!=n&&n.isBeingDecrypted()&&(yield n.getDecryptionPromise()),n})()}setTargetEvent(e){var t=this;return(0,n.A)(function*(){if(!t.targetEvent){if(t.targetEvent=e,t.relationType===s.zZ.Replace&&!t.targetEvent.isState()){var r=yield t.getLastReplacement();r&&t.targetEvent.makeReplaced(r)}t.maybeEmitCreated()}})()}maybeEmitCreated(){!this.creationEmitted&&this.targetEvent&&this.relations.size&&(this.creationEmitted=!0,this.targetEvent.emit(o.OQ.RelationsCreated,this.relationType,this.eventType))}}},43957:(e,t,r)=>{"use strict";r.d(t,{K:()=>s,L:()=>a});var n=r(29301),i=r(84458),o=r(36963),a=function(e){return e.Stable="stable",e.Unstable="unstable",e}({});class s{constructor(e,t){var r=this;this.logger=e,this.http=t,(0,i.A)(this,"capabilities",void 0),(0,i.A)(this,"retryTimeout",void 0),(0,i.A)(this,"refreshTimeout",void 0),(0,i.A)(this,"fetchCapabilities",(0,n.A)(function*(){var e=yield r.http.authedRequest(o.IT.Get,"/capabilities");return r.capabilities=e.capabilities,r.capabilities})),(0,i.A)(this,"poll",(0,n.A)(function*(){try{yield r.fetchCapabilities(),r.clearTimeouts(),r.refreshTimeout=setTimeout(r.poll,216e5),r.logger.debug("Fetched new server capabilities")}catch(t){r.clearTimeouts();var e=Math.floor(3e4+5e3*Math.random());r.retryTimeout=setTimeout(r.poll,e),r.logger.warn("Failed to refresh capabilities: retrying in ".concat(e,"ms"),t)}}))}start(){this.poll().then()}stop(){this.clearTimeouts()}getCachedCapabilities(){return this.capabilities}clearTimeouts(){this.refreshTimeout&&(clearInterval(this.refreshTimeout),this.refreshTimeout=void 0),this.retryTimeout&&(clearTimeout(this.retryTimeout),this.retryTimeout=void 0)}}},45093:(e,t)=>{"use strict";function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function n(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}Object.defineProperty(t,"__esModule",{value:!0}),t.SimpleObservable=void 0;function i(e){var t=function(e,t){if("object"!==r(e)||null===e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var i=n.call(e,t||"default");if("object"!==r(i))return i;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"===r(t)?t:String(t)}t.SimpleObservable=function(){var e;function t(e){var r,n;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");n=[],(r=i(r="listeners"))in this?Object.defineProperty(this,r,{value:n,enumerable:!0,configurable:!0,writable:!0}):this[r]=n,e&&this.listeners.push(e)}return e=[{key:"onUpdate",value:function(e){this.listeners.push(e)}},{key:"update",value:function(e){var t,r=function(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return n(e,void 0);var r=Object.prototype.toString.call(e).slice(8,-1);if("Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return n(e,t)}}(e))){r&&(e=r);var i=0,o=function(){};return{s:o,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:o}}throw TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,s=!0,l=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return s=e.done,e},e:function(e){l=!0,a=e},f:function(){try{s||null==r.return||r.return()}finally{if(l)throw a}}}}(this.listeners);try{for(r.s();!(t=r.n()).done;)(0,t.value)(e)}catch(e){r.e(e)}finally{r.f()}}},{key:"close",value:function(){this.listeners=[]}}],function(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,i(n.key),n)}}(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t}()},45374:(e,t,r)=>{"use strict";r.d(t,{A:()=>n});let n=(0,r(81551).A)("Lock",[["rect",{width:"18",height:"11",x:"3",y:"11",rx:"2",ry:"2",key:"1w4ew1"}],["path",{d:"M7 11V7a5 5 0 0 1 10 0v4",key:"fwvmzm"}]])},45514:(e,t,r)=>{"use strict";r.d(t,{Hr:()=>n,Uv:()=>o,eD:()=>i});var n=["v1.1","v1.2","v1.3","v1.4","v1.5","v1.6","v1.7","v1.8","v1.9"],i=n[0],o=n[n.length-1]},46546:(e,t,r)=>{"use strict";r.d(t,{t:()=>l});var n=r(84458),i=r(82393),o=r(9086);function a(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function s(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?a(Object(r),!0).forEach(function(t){(0,n.A)(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):a(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function l(e,t){var r=!!t.preventReEmit,n=!1!==t.decrypt;return function t(a){var l,c=e.getRoom(a.room_id);c&&void 0===a.state_key&&(l=c.findEventById(a.event_id)),!l||l.status?l=new i.kl(a):(l.setUnsigned(s(s({},l.getUnsigned()),a.unsigned)),r=!0);var d=l.getServerAggregatedRelation(o.zZ.Replace);if(null!=d&&d.content){var u=t(d);l.makeReplaced(u)}var h=null==c?void 0:c.findThreadForEvent(l);return h&&l.setThread(h),l.isEncrypted()&&(r||e.reEmitter.reEmit(l,[i.OQ.Decrypted]),n&&e.decryptEventIfNeeded(l)),r||(e.reEmitter.reEmit(l,[i.OQ.Replaced,i.OQ.VisibilityChange]),null==c||c.reEmitter.reEmit(l,[i.OQ.BeforeRedaction])),l}}},47105:(e,t,r)=>{var n=r(17852),i=r(76780);r(26600),t.M9=i,t.qg=n.parse,n.parseParams,n.parseFmtpConfig,n.parsePayloads,n.parseRemoteCandidates,n.parseImageAttributes,n.parseSimulcastStreamList},47208:(e,t,r)=>{"use strict";r.d(t,{j:()=>g});var n=r(84458),i=r(11749),o=r(85305),a=r(9086);function s(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function l(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?s(Object(r),!0).forEach(function(t){(0,n.A)(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):s(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}var c=[o.Ji.Override,o.Ji.ContentSpecific,o.Ji.RoomSpecific,o.Ji.SenderSpecific,o.Ji.Underride],d={".m.rule.is_room_mention":{rule_id:".m.rule.is_room_mention",default:!0,enabled:!0,conditions:[{kind:o.wp.EventPropertyIs,key:"content.m\\.mentions.room",value:!0},{kind:o.wp.SenderNotificationPermission,key:"room"}],actions:[o.YU.Notify,{set_tweak:o.QN.Highlight}]},".m.rule.reaction":{rule_id:".m.rule.reaction",default:!0,enabled:!0,conditions:[{kind:o.wp.EventMatch,key:"type",pattern:"m.reaction"}],actions:[o.YU.DontNotify]},".org.matrix.msc3786.rule.room.server_acl":{rule_id:".org.matrix.msc3786.rule.room.server_acl",default:!0,enabled:!0,conditions:[{kind:o.wp.EventMatch,key:"type",pattern:a.Bx.RoomServerAcl},{kind:o.wp.EventMatch,key:"state_key",pattern:""}],actions:[]}},u=Symbol("UserDefinedRules"),h=[o.kq.Master,u,o.kq.SuppressNotices,o.kq.InviteToSelf,o.kq.MemberEvent,o.kq.IsUserMention,o.kq.ContainsDisplayName,o.kq.IsRoomMention,o.kq.AtRoomNotification,o.kq.Tombstone,".m.rule.reaction",".m.rule.room.server_acl",".org.matrix.msc3786.rule.room.server_acl",".m.rule.suppress_edits"],v={".org.matrix.msc3914.rule.room.call":{rule_id:".org.matrix.msc3914.rule.room.call",default:!0,enabled:!0,conditions:[{kind:o.wp.EventMatch,key:"type",pattern:"org.matrix.msc3401.call"},{kind:o.wp.CallStarted}],actions:[o.YU.Notify,{set_tweak:o.QN.Sound,value:"default"}]}},p=[u,o.kq.IncomingCall,".org.matrix.msc3914.rule.room.call",o.kq.EncryptedDM,o.kq.DM,o.kq.Message,o.kq.EncryptedMessage];function m(e,t,r,n,i){var o=r.filter(e=>e.default),a=r.filter(e=>!e.default);function s(r){r===u?c.push(...a):r in n?(e.warn("Adding default global ".concat(t," push rule ").concat(r)),c.push(n[r])):e.warn("Missing default global ".concat(t," push rule ").concat(r))}var l=0,c=[];for(var d of o){var h=i.indexOf(d.rule_id);if(-1===h){c.push(d);continue}for(;h>l;)s(i[l]),l+=1;c.push(d),l+=1}for(var v of i.slice(l))s(v);return c}class g{constructor(e){this.client=e,(0,n.A)(this,"parsedKeys",new Map)}static actionListToActionsObject(e){var t={notify:!1,tweaks:{}};for(var r of e)r===o.YU.Notify?t.notify=!0:"object"==typeof r&&(void 0===r.value&&(r.value=!0),t.tweaks[r.set_tweak]=r.value);return t}static rewriteDefaultRules(e,t){arguments.length>2&&void 0!==arguments[2]&&arguments[2];var r=JSON.parse(JSON.stringify(t));return r||(r={}),r.global||(r.global={}),r.global.override||(r.global.override=[]),r.global.underride||(r.global.underride=[]),r.global.override=m(e,o.Ji.Override,r.global.override,d,h),r.global.underride=m(e,o.Ji.Underride,r.global.underride,v,p),r}static getPushRuleGlobRegex(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"i",[n,o]=t?["(?<=^|\\W)","(?=\\W|$)"]:["^","$"],a="".concat(t,"-").concat(r,"-").concat(e);return g.cachedGlobToRegex[a]||(g.cachedGlobToRegex[a]=RegExp(n+"("+(0,i.dn)(e)+")"+o,r)),g.cachedGlobToRegex[a]}updateCachedPushRuleKeys(e){e||(e={}),e.global||(e.global={}),e.global.override||(e.global.override=[]),e.global.room||(e.global.room=[]),e.global.sender||(e.global.sender=[]),e.global.underride||(e.global.underride=[]);var t=new Set(this.parsedKeys.keys());for(var r of[e.global.override,e.global.room,e.global.sender,e.global.underride])for(var n of r)if(n.conditions)for(var i of n.conditions)i.kind===o.wp.EventMatch&&(t.delete(i.key),this.parsedKeys.set(i.key,g.partsForDottedKey(i.key)));t.forEach(e=>this.parsedKeys.delete(e))}matchingRuleFromKindSet(e,t){for(var r of c){var n=t[r];if(n){for(var i of n)if(i.enabled){var o=this.templateRuleToRaw(r,i);if(o&&this.ruleMatchesEvent(o,e))return l(l({},i),{},{kind:r})}}}return null}templateRuleToRaw(e,t){var r={rule_id:t.rule_id,actions:t.actions,conditions:[]};switch(e){case o.Ji.Underride:case o.Ji.Override:r.conditions=t.conditions;break;case o.Ji.RoomSpecific:if(!t.rule_id)return null;r.conditions.push({kind:o.wp.EventMatch,key:"room_id",value:t.rule_id});break;case o.Ji.SenderSpecific:if(!t.rule_id)return null;r.conditions.push({kind:o.wp.EventMatch,key:"user_id",value:t.rule_id});break;case o.Ji.ContentSpecific:if(!t.pattern)return null;r.conditions.push({kind:o.wp.EventMatch,key:"content.body",pattern:t.pattern})}return r}eventFulfillsCondition(e,t){switch(e.kind){case o.wp.EventMatch:return this.eventFulfillsEventMatchCondition(e,t);case o.wp.EventPropertyIs:return this.eventFulfillsEventPropertyIsCondition(e,t);case o.wp.EventPropertyContains:return this.eventFulfillsEventPropertyContains(e,t);case o.wp.ContainsDisplayName:return this.eventFulfillsDisplayNameCondition(e,t);case o.wp.RoomMemberCount:return this.eventFulfillsRoomMemberCountCondition(e,t);case o.wp.SenderNotificationPermission:return this.eventFulfillsSenderNotifPermCondition(e,t);case o.wp.CallStarted:case o.wp.CallStartedPrefix:return this.eventFulfillsCallStartedCondition(e,t)}return!1}eventFulfillsSenderNotifPermCondition(e,t){var r=e.key;if(!r)return!1;var n=this.client.getRoom(t.getRoomId());return!!(null!=n&&n.currentState)&&n.currentState.mayTriggerNotifOfType(r,t.getSender())}eventFulfillsRoomMemberCountCondition(e,t){if(!e.is)return!1;var r=this.client.getRoom(t.getRoomId());if(!r||!r.currentState||!r.currentState.members)return!1;var n=r.currentState.getJoinedMemberCount(),i=e.is.match(/^([=<>]*)(\d*)$/);if(!i)return!1;var o=i[1],a=parseInt(i[2]);if(isNaN(a))return!1;switch(o){case"":case"==":return n==a;case"<":return n<a;case">":return n>a;case"<=":return n<=a;case">=":return n>=a;default:return!1}}eventFulfillsDisplayNameCondition(e,t){var r,n=t.getContent();if(t.isEncrypted()&&t.getClearContent()&&(n=t.getClearContent()),!n||!n.body||"string"!=typeof n.body)return!1;var o=this.client.getRoom(t.getRoomId()),a=null==o||null==(r=o.currentState)?void 0:r.getMember(this.client.credentials.userId);if(!a)return!1;var s=a.name,l=RegExp("(^|\\W)"+(0,i.Nt)(s)+"(\\W|$)","i");return n.body.search(l)>-1}eventFulfillsEventMatchCondition(e,t){if(!e.key)return!1;var r=this.valueForDottedKey(e.key,t);if("string"!=typeof r)return!1;if(e.value)return e.value===r;if("string"!=typeof e.pattern)return!1;var n=g.getPushRuleGlobRegex(e.pattern,"content.body"===e.key);return!!r.match(n)}eventFulfillsEventPropertyIsCondition(e,t){return!!e.key&&void 0!==e.value&&e.value===this.valueForDottedKey(e.key,t)}eventFulfillsEventPropertyContains(e,t){if(!e.key||void 0===e.value)return!1;var r=this.valueForDottedKey(e.key,t);return!!Array.isArray(r)&&r.includes(e.value)}eventFulfillsCallStartedCondition(e,t){return["m.ring","m.prompt"].includes(t.getContent()["m.intent"])&&!("m.terminated"in t.getContent())&&(t.getPrevContent()["m.terminated"]!==t.getContent()["m.terminated"]||(0,i.ky)(t.getPrevContent(),{}))}static partsForDottedKey(e){var t=[],r="",n=!1;for(var i of e){if(n){"\\"===i||"."===i?r+=i:r+="\\"+i,n=!1;continue}"."==i?(t.push(r),r=""):"\\"==i?n=!0:r+=i}return n&&(r+="\\"),t.push(r),t}valueForDottedKey(e,t){var r,n=this.parsedKeys.get(e);void 0===n&&(n=g.partsForDottedKey(e),this.parsedKeys.set(e,n));var o=n[0],a=0;for("content"===o?(r=t.getContent(),++a):"type"===o?(r=t.getType(),++a):r=t.event;a<n.length;++a){if((0,i.hX)(r))return;r=r[n[a]]}return r}matchingRuleForEventWithRulesets(e,t){return t&&e.getSender()!==this.client.getSafeUserId()?this.matchingRuleFromKindSet(e,t.global):null}pushActionsForEventAndRulesets(e,t){var r=this.matchingRuleForEventWithRulesets(e,t);if(!r)return{};var n=g.actionListToActionsObject(r.actions);return void 0===n.tweaks.highlight&&(n.tweaks.highlight=r.kind==o.Ji.ContentSpecific),{actions:n,rule:r}}ruleMatchesEvent(e,t){var r;return(!this.client.supportsIntentionalMentions()||void 0===t.getContent()["m.mentions"]||e.rule_id!==o.kq.ContainsUserName&&e.rule_id!==o.kq.ContainsDisplayName&&e.rule_id!==o.kq.AtRoomNotification)&&!(null!=(r=e.conditions)&&r.some(e=>!this.eventFulfillsCondition(e,t)))}actionsForEvent(e){var{actions:t}=this.pushActionsForEventAndRulesets(e,this.client.pushRules);return t||{}}actionsAndRuleForEvent(e){return this.pushActionsForEventAndRulesets(e,this.client.pushRules)}getPushRuleById(e){var t,r=this.getPushRuleAndKindById(e);return null!=(t=null==r?void 0:r.rule)?t:null}getPushRuleAndKindById(e){for(var t of["global"]){var r;if((null==(r=this.client.pushRules)?void 0:r[t])!==void 0){for(var n of c)if(void 0!==this.client.pushRules[t][n]){for(var i of this.client.pushRules[t][n])if(i.rule_id===e)return{rule:i,kind:n}}}}return null}}(0,n.A)(g,"cachedGlobToRegex",{})},47406:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.M_TEXT=t.M_NOTICE=t.M_MESSAGE=t.M_HTML=t.M_EMOTE=void 0;var n=r(10393);t.M_MESSAGE=new n.UnstableValue("m.message","org.matrix.msc1767.message"),t.M_TEXT=new n.UnstableValue("m.text","org.matrix.msc1767.text"),t.M_HTML=new n.UnstableValue("m.html","org.matrix.msc1767.html"),t.M_EMOTE=new n.UnstableValue("m.emote","org.matrix.msc1767.emote"),t.M_NOTICE=new n.UnstableValue("m.notice","org.matrix.msc1767.notice")},47511:(e,t,r)=>{"use strict";r.d(t,{HF:()=>d,JH:()=>s,M9:()=>c,ai:()=>l});var n=r(84458),i=r(20213),o=r(11749),a=r(15095),s=function(e){return e.New="Beacon.new",e.Update="Beacon.update",e.LivenessChange="Beacon.LivenessChange",e.Destroy="Beacon.Destroy",e.LocationUpdate="Beacon.LocationUpdate",e}({}),l=(e,t,r)=>r>=e&&e+t>=r,c=e=>"".concat(e.getRoomId(),"_").concat(e.getStateKey());class d extends a.X{constructor(e){super(),this.rootEvent=e,(0,n.A)(this,"roomId",void 0),(0,n.A)(this,"_beaconInfo",void 0),(0,n.A)(this,"_isLive",void 0),(0,n.A)(this,"livenessWatchTimeout",void 0),(0,n.A)(this,"_latestLocationEvent",void 0),(0,n.A)(this,"clearLatestLocation",()=>{this._latestLocationEvent=void 0,this.emit(s.LocationUpdate,this.latestLocationState)}),this.roomId=this.rootEvent.getRoomId(),this.setBeaconInfo(this.rootEvent)}get isLive(){return!!this._isLive}get identifier(){return c(this.rootEvent)}get beaconInfoId(){return this.rootEvent.getId()}get beaconInfoOwner(){return this.rootEvent.getStateKey()}get beaconInfoEventType(){return this.rootEvent.getType()}get beaconInfo(){return this._beaconInfo}get latestLocationState(){return this._latestLocationEvent&&(0,i.parseBeaconContent)(this._latestLocationEvent.getContent())}get latestLocationEvent(){return this._latestLocationEvent}update(e){if(c(e)!==this.identifier)throw Error("Invalid updating event");e.getTs()<this.rootEvent.getTs()||(this.rootEvent=e,this.setBeaconInfo(this.rootEvent),this.emit(s.Update,e,this),this.clearLatestLocation())}destroy(){this.livenessWatchTimeout&&clearTimeout(this.livenessWatchTimeout),this._isLive=!1,this.emit(s.Destroy,this.identifier)}monitorLiveness(){if(this.livenessWatchTimeout&&clearTimeout(this.livenessWatchTimeout),this.checkLiveness(),this.beaconInfo)if(this.isLive){var e=this.beaconInfo.timestamp+this.beaconInfo.timeout-Date.now();e>1&&(this.livenessWatchTimeout=setTimeout(()=>{this.monitorLiveness()},e))}else this.beaconInfo.timestamp>Date.now()&&(this.livenessWatchTimeout=setTimeout(()=>{this.monitorLiveness()},this.beaconInfo.timestamp-Date.now()))}addLocations(e){if(this.isLive){var t,r=null==(t=e.filter(e=>{var t=e.getContent(),r=(0,i.parseBeaconContent)(t);if(!r.uri||!r.timestamp)return!1;var{timestamp:n}=r;return this._beaconInfo.timestamp&&l(this._beaconInfo.timestamp,this._beaconInfo.timeout,n)&&(!this.latestLocationState||n>this.latestLocationState.timestamp)}).sort(o.Fq))?void 0:t[0];r&&(this._latestLocationEvent=r,this.emit(s.LocationUpdate,this.latestLocationState))}}setBeaconInfo(e){this._beaconInfo=(0,i.parseBeaconInfoContent)(e.getContent()),this.checkLiveness()}checkLiveness(){var e=this.isLive;if(this.beaconInfo){var t=this.beaconInfo.timestamp>Date.now()?this.beaconInfo.timestamp-36e4:this.beaconInfo.timestamp;this._isLive=!!this._beaconInfo.live&&!!t&&l(t,this._beaconInfo.timeout,Date.now()),e!==this.isLive&&this.emit(s.LivenessChange,this.isLive,this)}}}},50533:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isValidUrl=function(e){if(!e)return!1;try{var t=new URL(e);if("http"!==t.protocol&&"https"!==t.protocol)return!1;return!0}catch(e){if(e instanceof TypeError)return!1;throw e}}},50703:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.parseMMessage=function(e){return i.M_EMOTE.matches(e.type)?new o.EmoteEvent(e):i.M_NOTICE.matches(e.type)?new a.NoticeEvent(e):new n.MessageEvent(e)};var n=r(62404),i=r(47406),o=r(98597),a=r(57023)},52066:(e,t,r)=>{"use strict";r.d(t,{J:()=>n});var n="matrix-js-sdk"},52337:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isEventTypeSame=function(e,t){if("string"==typeof e)if("string"==typeof t)return t===e;else return t.matches(e);return"string"==typeof t?e.matches(t):t.matches(e.name)||t.matches(e.altName)}},52621:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.parseMPoll=function(e){return n.M_POLL_START.matches(e.type)?new i.PollStartEvent(e):n.M_POLL_RESPONSE.matches(e.type)?new o.PollResponseEvent(e):n.M_POLL_END.matches(e.type)?new a.PollEndEvent(e):null};var n=r(77990),i=r(79404),o=r(55489),a=r(7347)},54120:(e,t,r)=>{"use strict";function n(e){return(!("parent_delay_id"in e)||"string"==typeof e.parent_delay_id)&&("delay"in e&&"number"!=typeof e.delay||"delay"in e||"parent_delay_id"in e)}r.d(t,{U:()=>n,e:()=>i});var i=function(e){return e.Cancel="cancel",e.Restart="restart",e.Send="send",e}({})},55090:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UnstableApiVersion=t.MatrixApiVersion=t.CurrentApiVersions=void 0;var r=function(e){return e.Prerelease1="0.0.1",e.Prerelease2="0.0.2",e}({});t.MatrixApiVersion=r;var n=function(e){return e.MSC2762="org.matrix.msc2762",e.MSC2762_UPDATE_STATE="org.matrix.msc2762_update_state",e.MSC2871="org.matrix.msc2871",e.MSC2873="org.matrix.msc2873",e.MSC2931="org.matrix.msc2931",e.MSC2974="org.matrix.msc2974",e.MSC2876="org.matrix.msc2876",e.MSC3819="org.matrix.msc3819",e.MSC3846="town.robin.msc3846",e.MSC3869="org.matrix.msc3869",e.MSC3973="org.matrix.msc3973",e.MSC4039="org.matrix.msc4039",e}({});t.UnstableApiVersion=n,t.CurrentApiVersions=[r.Prerelease1,r.Prerelease2,n.MSC2762,n.MSC2762_UPDATE_STATE,n.MSC2871,n.MSC2873,n.MSC2931,n.MSC2974,n.MSC2876,n.MSC3819,n.MSC3846,n.MSC3869,n.MSC3973,n.MSC4039]},55489:(e,t,r)=>{"use strict";function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.PollResponseEvent=void 0;var i=r(78272),o=r(77990),a=r(66866),s=r(98973),l=r(52337);function c(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function d(e,t){return(d=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function u(e){if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function h(e){return(h=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function v(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}t.PollResponseEvent=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");m.prototype=Object.create(e&&e.prototype,{constructor:{value:m,writable:!0,configurable:!0}}),Object.defineProperty(m,"prototype",{writable:!1}),e&&d(m,e);var t,r,i,p=(t=function(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}(),function(){var e,r=h(m);return e=t?Reflect.construct(r,arguments,h(this).constructor):r.apply(this,arguments),function(e,t){if(t&&("object"===n(t)||"function"==typeof t))return t;if(void 0!==t)throw TypeError("Derived constructors may only return object or undefined");return u(e)}(this,e)});function m(e){if(!(this instanceof m))throw TypeError("Cannot call a class as a function");v(u(t=p.call(this,e)),"internalAnswerIds",void 0),v(u(t),"internalSpoiled",void 0),v(u(t),"pollEventId",void 0);var t,r=t.wireContent["m.relates_to"];if(!s.REFERENCE_RELATION.matches(null==r?void 0:r.rel_type)||"string"!=typeof(null==r?void 0:r.event_id))throw new a.InvalidEventError("Relationship must be a reference to an event");return t.pollEventId=r.event_id,t.validateAgainst(null),t}return r=[{key:"answerIds",get:function(){return this.internalAnswerIds}},{key:"spoiled",get:function(){return this.internalSpoiled}},{key:"validateAgainst",value:function(e){var t=o.M_POLL_RESPONSE.findIn(this.wireContent);if(!Array.isArray(null==t?void 0:t.answers)){this.internalSpoiled=!0,this.internalAnswerIds=[];return}var r=t.answers;if(r.some(function(e){return"string"!=typeof e})||0===r.length){this.internalSpoiled=!0,this.internalAnswerIds=[];return}if(e){if(r.some(function(t){return!e.answers.some(function(e){return e.id===t})})){this.internalSpoiled=!0,this.internalAnswerIds=[];return}r=r.slice(0,e.maxSelections)}this.internalAnswerIds=r,this.internalSpoiled=!1}},{key:"isEquivalentTo",value:function(e){return(0,l.isEventTypeSame)(e,o.M_POLL_RESPONSE)}},{key:"serialize",value:function(){return{type:o.M_POLL_RESPONSE.name,content:v({"m.relates_to":{rel_type:s.REFERENCE_RELATION.name,event_id:this.pollEventId}},o.M_POLL_RESPONSE.name,{answers:this.spoiled?void 0:this.answerIds})}}}],i=[{key:"from",value:function(e,t){return new m({type:o.M_POLL_RESPONSE.name,content:v({"m.relates_to":{rel_type:s.REFERENCE_RELATION.name,event_id:t}},o.M_POLL_RESPONSE.name,{answers:e})})}}],r&&c(m.prototype,r),i&&c(m,i),Object.defineProperty(m,"prototype",{writable:!1}),m}(i.ExtensibleEvent)},56118:(e,t,r)=>{"use strict";r.d(t,{t:()=>a});var n=r(84458),i=r(41948),o=r(82393);class a{constructor(e,t){this.client=e,this.room=t,(0,n.A)(this,"relations",new Map)}getChildEventsForEvent(e,t,r){var n;return null==(n=this.relations.get(e))||null==(n=n.get(t))?void 0:n.get(r)}getAllChildEventsForEvent(e){var t,r=null!=(t=this.relations.get(e))?t:new Map,n=[];for(var i of r.values())for(var o of i.values())n.push(...o.getRelations());return n}aggregateParentEvent(e){var t=this.relations.get(e.getId());if(t)for(var r of t.values())for(var n of r.values())n.setTargetEvent(e)}aggregateChildEvent(e,t){if(!e.isRedacted()&&e.status!==o.fb.CANCELLED){var r=e.getRelation();if(r){var n=()=>{if(e.isDecryptionFailure())return void e.once(o.OQ.Decrypted,n);this.aggregateChildEvent(e,t)};if(e.isBeingDecrypted()||e.shouldAttemptDecryption())return void e.once(o.OQ.Decrypted,n);var{event_id:a,rel_type:s}=r,l=e.getType(),c=this.relations.get(a);c||(c=new Map,this.relations.set(a,c));var d=c.get(s);d||(d=new Map,c.set(s,d));var u=d.get(l);if(!u){u=new i.s(s,l,this.client),d.set(l,u);var h,v,p,m=null!=(h=this.room)?h:null==t?void 0:t.room,g=null!=(v=null!=(p=null==t?void 0:t.findEventById(a))?p:null==m?void 0:m.findEventById(a))?v:null==m?void 0:m.getPendingEvent(a);g&&u.setTargetEvent(g)}u.addEvent(e)}}}}},56360:function(e,t,r){var n,i;!function(o,a){"use strict";void 0===(i="function"==typeof(n=a)?n.call(t,r,t,e):n)||(e.exports=i)}(0,function(){"use strict";var e=function(){},t="undefined",r=typeof window!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),n=["trace","debug","info","warn","error"],i={},o=null;function a(e,t){var r=e[t];if("function"==typeof r.bind)return r.bind(e);try{return Function.prototype.bind.call(r,e)}catch(t){return function(){return Function.prototype.apply.apply(r,[e,arguments])}}}function s(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function l(){for(var r=this.getLevel(),i=0;i<n.length;i++){var o=n[i];this[o]=i<r?e:this.methodFactory(o,r,this.name)}if(this.log=this.debug,typeof console===t&&r<this.levels.SILENT)return"No console available for logging"}function c(e){return function(){typeof console!==t&&(l.call(this),this[e].apply(this,arguments))}}function d(n,i,o){var l;return"debug"===(l=n)&&(l="log"),typeof console!==t&&("trace"===l&&r?s:void 0!==console[l]?a(console,l):void 0!==console.log?a(console,"log"):e)||c.apply(this,arguments)}function u(e,r){var a,s,c,u=this,h="loglevel";function v(){var e;if(typeof window!==t&&h){try{e=window.localStorage[h]}catch(e){}if(typeof e===t)try{var r=window.document.cookie,n=encodeURIComponent(h),i=r.indexOf(n+"=");-1!==i&&(e=/^([^;]+)/.exec(r.slice(i+n.length+1))[1])}catch(e){}return void 0===u.levels[e]&&(e=void 0),e}}function p(e){var t=e;if("string"==typeof t&&void 0!==u.levels[t.toUpperCase()]&&(t=u.levels[t.toUpperCase()]),"number"==typeof t&&t>=0&&t<=u.levels.SILENT)return t;throw TypeError("log.setLevel() called with invalid level: "+e)}"string"==typeof e?h+=":"+e:"symbol"==typeof e&&(h=void 0),u.name=e,u.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},u.methodFactory=r||d,u.getLevel=function(){return null!=c?c:null!=s?s:a},u.setLevel=function(e,r){return c=p(e),!1!==r&&function(e){var r=(n[e]||"silent").toUpperCase();if(typeof window!==t&&h){try{window.localStorage[h]=r;return}catch(e){}try{window.document.cookie=encodeURIComponent(h)+"="+r+";"}catch(e){}}}(c),l.call(u)},u.setDefaultLevel=function(e){s=p(e),v()||u.setLevel(e,!1)},u.resetLevel=function(){if(c=null,typeof window!==t&&h){try{window.localStorage.removeItem(h)}catch(e){}try{window.document.cookie=encodeURIComponent(h)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch(e){}}l.call(u)},u.enableAll=function(e){u.setLevel(u.levels.TRACE,e)},u.disableAll=function(e){u.setLevel(u.levels.SILENT,e)},u.rebuild=function(){if(o!==u&&(a=p(o.getLevel())),l.call(u),o===u)for(var e in i)i[e].rebuild()},a=p(o?o.getLevel():"WARN");var m=v();null!=m&&(c=p(m)),l.call(u)}(o=new u).getLogger=function(e){if("symbol"!=typeof e&&"string"!=typeof e||""===e)throw TypeError("You must supply a name when creating a logger.");var t=i[e];return t||(t=i[e]=new u(e,o.methodFactory)),t};var h=typeof window!==t?window.log:void 0;return o.noConflict=function(){return typeof window!==t&&window.log===o&&(window.log=h),o},o.getLoggers=function(){return i},o.default=o,o})},56662:(e,t,r)=>{"use strict";r.d(t,{FM:()=>n,Ji:()=>o,X9:()=>i});var n=function(e){return e.Change="change",e}({}),i=function(e){return e[e.Unsent=1]="Unsent",e[e.Requested=2]="Requested",e[e.Ready=3]="Ready",e[e.Started=4]="Started",e[e.Cancelled=5]="Cancelled",e[e.Done=6]="Done",e}({}),o=function(e){return e.Cancel="cancel",e.ShowSas="show_sas",e.ShowReciprocateQr="show_reciprocate_qr",e}({})},57023:(e,t,r)=>{"use strict";function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.NoticeEvent=void 0;var i=r(62404),o=r(47406),a=r(52337);function s(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function l(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function c(){return(c="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,r){var n=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=u(e)););return e}(e,t);if(n){var i=Object.getOwnPropertyDescriptor(n,t);return i.get?i.get.call(arguments.length<3?e:r):i.value}}).apply(this,arguments)}function d(e,t){return(d=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function u(e){return(u=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}t.NoticeEvent=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");v.prototype=Object.create(e&&e.prototype,{constructor:{value:v,writable:!0,configurable:!0}}),Object.defineProperty(v,"prototype",{writable:!1}),e&&d(v,e);var t,r,i,h=(t=function(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}(),function(){var e,r=u(v);return e=t?Reflect.construct(r,arguments,u(this).constructor):r.apply(this,arguments),function(e,t){if(t&&("object"===n(t)||"function"==typeof t))return t;if(void 0!==t)throw TypeError("Derived constructors may only return object or undefined");var r=e;if(void 0===r)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return r}(this,e)});function v(e){if(!(this instanceof v))throw TypeError("Cannot call a class as a function");return h.call(this,e)}return r=[{key:"isNotice",get:function(){return!0}},{key:"isEquivalentTo",value:function(e){return(0,a.isEventTypeSame)(e,o.M_NOTICE)||c(u(v.prototype),"isEquivalentTo",this).call(this,e)}},{key:"serialize",value:function(){var e=c(u(v.prototype),"serialize",this).call(this);return e.content.msgtype="m.notice",e}}],i=[{key:"from",value:function(e,t){var r;return new v({type:o.M_NOTICE.name,content:(s(r={},o.M_TEXT.name,e),s(r,o.M_HTML.name,t),r)})}}],r&&l(v.prototype,r),i&&l(v,i),Object.defineProperty(v,"prototype",{writable:!1}),v}(i.MessageEvent)},59741:(e,t,r)=>{"use strict";r.d(t,{Yx:()=>u,o5:()=>d,sh:()=>h});var n=r(84458),i=r(83656),o=r(11749),a=r(5408),s=r(15095),l=r(9086),c=r(5294),d=function(e){return e.Membership="RoomMember.membership",e.Name="RoomMember.name",e.PowerLevel="RoomMember.powerLevel",e.Typing="RoomMember.typing",e}({});class u extends s.X{constructor(e,t){super(),this.roomId=e,this.userId=t,(0,n.A)(this,"_isOutOfBand",!1),(0,n.A)(this,"modified",-1),(0,n.A)(this,"requestedProfileInfo",!1),(0,n.A)(this,"typing",!1),(0,n.A)(this,"name",void 0),(0,n.A)(this,"rawDisplayName",void 0),(0,n.A)(this,"powerLevel",0),(0,n.A)(this,"user",void 0),(0,n.A)(this,"membership",void 0),(0,n.A)(this,"disambiguate",!1),(0,n.A)(this,"events",{}),this.name=t,this.rawDisplayName=t,this.updateModifiedTime()}markOutOfBand(){this._isOutOfBand=!0}isOutOfBand(){return this._isOutOfBand}setMembershipEvent(e,t){var r,n,i=null!=(r=e.getDirectionalContent().displayname)?r:"";if(e.getType()===l.Bx.RoomMember){this._isOutOfBand=!1,this.events.member=e;var s,c,u,p=this.membership;this.membership=e.getDirectionalContent().membership,void 0===this.membership&&a.vF.trace("membership event with membership undefined (forwardLooking: ".concat(e.forwardLooking,")!"),e.getContent(),"prevcontent is ",e.getPrevContent()),this.disambiguate=function(e,t,r){if(!t||t===e||!r)return!1;var n=(0,o.Gp)(t);return!!n&&!!(h.test(n)||v.test(t)||r.getUserIdsWithDisplayName(t).some(t=>t!==e))}(this.userId,i,t);var m=this.name;this.name=(s=this.userId,c=i,u=this.disambiguate,c&&c!==s?u?(0,o.d7)(c)+" ("+s+")":(0,o.Gp)(c)?(0,o.d7)(c):s:s),this.rawDisplayName=(0,o.d7)(null!=(n=e.getDirectionalContent().displayname)?n:""),this.rawDisplayName&&(0,o.Gp)(this.rawDisplayName)||(this.rawDisplayName=this.userId),p!==this.membership&&(this.updateModifiedTime(),this.emit(d.Membership,e,this,p)),m!==this.name&&(this.updateModifiedTime(),this.emit(d.Name,e,this,m))}}setPowerLevel(e,t){var r=this.powerLevel;this.powerLevel=e,r!==this.powerLevel&&(this.updateModifiedTime(),this.emit(d.PowerLevel,t,this))}setTypingEvent(e){if("m.typing"===e.getType()){var t=this.typing;this.typing=!1;var r=e.getContent().user_ids;Array.isArray(r)&&(-1!==r.indexOf(this.userId)&&(this.typing=!0),t!==this.typing&&(this.updateModifiedTime(),this.emit(d.Typing,e,this)))}}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}isKicked(){return this.membership===c.O.Leave&&void 0!==this.events.member&&this.events.member.getSender()!==this.events.member.getStateKey()}getDMInviter(){if(this.events.member){var e=this.events.member,t=e.getContent(),r=e.getSender();if(t.membership===c.O.Join&&(t=e.getPrevContent(),r=e.getUnsigned().prev_sender),t.membership===c.O.Invite&&t.is_direct)return r}}getAvatarUrl(e,t,r,n){var o=!(arguments.length>4)||void 0===arguments[4]||arguments[4],a=arguments.length>5?arguments[5]:void 0,s=arguments.length>6&&void 0!==arguments[6]&&arguments[6],l=this.getMxcAvatarUrl();if(!l&&!o)return null;var c=(0,i.y)(e,l,t,r,n,a,void 0,s);return c||null}getMxcAvatarUrl(){return this.events.member?this.events.member.getDirectionalContent().avatar_url:this.user?this.user.avatarUrl:void 0}}var h=/@.+:.+/,v=/[\u200E\u200F\u202A-\u202F]/},59879:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UpdateDelayedEventAction=void 0,t.UpdateDelayedEventAction=function(e){return e.Cancel="cancel",e.Restart="restart",e.Send="send",e}({})},60332:(e,t,r)=>{"use strict";r.d(t,{A:()=>a});var n=r(29301),i=r(35095),o=r(34019);function a(e,t,r){return s.apply(this,arguments)}function s(){return(s=(0,n.A)(function*(e,t,r){var[n,a]=yield(0,o.C)(t,r),s=(0,i.y4)(e.ciphertext);if(!(yield globalThis.crypto.subtle.verify({name:"HMAC"},a,(0,i.y4)(e.mac),s)))throw Error("Error decrypting secret ".concat(r,": bad MAC"));var l=yield globalThis.crypto.subtle.decrypt({name:"AES-CTR",counter:(0,i.y4)(e.iv),length:64},n,s);return new TextDecoder().decode(new Uint8Array(l))})).apply(this,arguments)}},60484:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Widget=void 0;var n=r(88767),i=r(94457);function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}t.Widget=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");if(this.definition=e,!this.definition)throw Error("Definition is required");(0,i.assertPresent)(e,"id"),(0,i.assertPresent)(e,"creatorUserId"),(0,i.assertPresent)(e,"type"),(0,i.assertPresent)(e,"url")}return e=[{key:"creatorUserId",get:function(){return this.definition.creatorUserId}},{key:"type",get:function(){return this.definition.type}},{key:"id",get:function(){return this.definition.id}},{key:"name",get:function(){return this.definition.name||null}},{key:"title",get:function(){return this.rawData.title||null}},{key:"templateUrl",get:function(){return this.definition.url}},{key:"origin",get:function(){return new URL(this.templateUrl).origin}},{key:"waitForIframeLoad",get:function(){return!1!==this.definition.waitForIframeLoad&&(this.definition.waitForIframeLoad,!0)}},{key:"rawData",get:function(){return this.definition.data||{}}},{key:"getCompleteUrl",value:function(e){return(0,n.runTemplate)(this.templateUrl,this.definition,e)}}],function(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,function(e){var t=function(e,t){if("object"!==o(e)||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,t||"default");if("object"!==o(n))return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"===o(t)?t:String(t)}(n.key),n)}}(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t}()},60632:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LegacyMsgType=void 0,t.isEventLike=function(e,t){var r=e.content;return t===n.Text?i.M_MESSAGE.matches(e.type)||"m.room.message"===e.type&&(null==r?void 0:r.msgtype)==="m.text":t===n.Emote?i.M_EMOTE.matches(e.type)||"m.room.message"===e.type&&(null==r?void 0:r.msgtype)==="m.emote":t===n.Notice&&(i.M_NOTICE.matches(e.type)||"m.room.message"===e.type&&(null==r?void 0:r.msgtype)==="m.notice")};var n,i=r(47406);t.LegacyMsgType=n,function(e){e.Text="m.text",e.Notice="m.notice",e.Emote="m.emote"}(n||(t.LegacyMsgType=n={}))},61219:(e,t,r)=>{"use strict";r.d(t,{vx:()=>W,X5:()=>q,Wv:()=>H,u9:()=>V,bx:()=>J});var n=r(29301),i=r(84458),o=r(19599),a=r(80578),s=r(12411),l=r(83656),c=r(11749),d=r(82393),u=r(96170),h=r(59741),v=r(40893),p=r(5408),m=r(75525),g=r(9086),f=r(49699),y=r(74411),b=r(29927),S=r(47511),E=r(37151),_=r(33234),w=r(56118),T=r(8702),I=r(33418);class A{constructor(e){(0,i.A)(this,"room",void 0),(0,i.A)(this,"threadedReceipts",void 0),(0,i.A)(this,"unthreadedReceipts",void 0),(0,i.A)(this,"danglingReceipts",void 0),(0,i.A)(this,"onTimelineEvent",e=>{var t=e.getId();if(t){var r=this.danglingReceipts.remove(t);null==r||r.forEach(e=>{e.receipt.thread_id?this.threadedReceipts.set(e.receipt.thread_id,e.eventId,e.receiptType,e.userId,e.receipt.ts,e.synthetic):this.unthreadedReceipts.set(t,e.receiptType,e.userId,e.receipt.ts,e.synthetic)})}}),this.room=e,this.threadedReceipts=new M(e),this.unthreadedReceipts=new O(e),this.danglingReceipts=new P,e.on(V.Timeline,this.onTimelineEvent)}add(e,t){for(var[r,n]of Object.entries(e))for(var[i,o]of Object.entries(n))for(var[a,s]of Object.entries(o))this.room.findEventById(r)?s.thread_id?this.threadedReceipts.set(s.thread_id,r,i,a,s.ts,t):this.unthreadedReceipts.set(r,i,a,s.ts,t):this.danglingReceipts.add(new C(r,i,a,s,t))}hasUserReadEvent(e,t){var r=this.unthreadedReceipts.get(e);if(r&&x(r.eventId,t,this.room))return!0;var n=this.room.findEventById(t);if(!n)return p.vF.warn("hasUserReadEvent event ID ".concat(t," not found in room ").concat(this.room.roomId,": this shouldn't happen!")),!1;var i=(0,f.Xb)(n),o=this.threadedReceipts.get(i,e);return!!(o&&x(o.eventId,t,this.room)||this.userSentLatestEventInThread(i,e))}userSentLatestEventInThread(e,t){var r,n=e===_.S?this.room.getLiveTimeline().getEvents():null==(r=this.room.getThread(e))?void 0:r.timeline;return!!(n&&n.length>0&&n[n.length-1].getSender()===t)}}class R{constructor(e,t,r){this.eventId=e,this.receiptType=t,this.ts=r}}class C{constructor(e,t,r,n,i){this.eventId=e,this.receiptType=t,this.userId=r,this.receipt=n,this.synthetic=i}}class k{constructor(e){(0,i.A)(this,"room",void 0),(0,i.A)(this,"real",void 0),(0,i.A)(this,"synthetic",void 0),this.room=e,this.real=void 0,this.synthetic=void 0}set(e,t){e?this.synthetic=t:this.real=t,this.synthetic&&this.real&&x(this.real.eventId,this.synthetic.eventId,this.room)&&(this.synthetic=void 0)}get(){var e;return null!=(e=this.synthetic)?e:this.real}getByType(e){return e?this.synthetic:this.real}}class O{constructor(e){(0,i.A)(this,"room",void 0),(0,i.A)(this,"data",void 0),this.room=e,this.data=new Map}set(e,t,r,n,i){var o,a,s,l=D(this.data,r,()=>new k(this.room)),c=l.getByType(i);c&&(o=c.eventId,a=e,null!==(s=this.room.compareEventOrdering(o,a))&&s>0)||l.set(i,new R(e,t,n))}get(e){var t;return null==(t=this.data.get(e))?void 0:t.get()}}class M{constructor(e){(0,i.A)(this,"room",void 0),(0,i.A)(this,"data",void 0),this.room=e,this.data=new Map}set(e,t,r,n,i,o){D(this.data,e,()=>new O(this.room)).set(t,r,n,i,o)}get(e,t){var r;return null==(r=this.data.get(e))?void 0:r.get(t)}}class P{constructor(){(0,i.A)(this,"data",new Map)}add(e){D(this.data,e.eventId,()=>[]).push(e)}remove(e){var t=this.data.get(e);return this.data.delete(e),t}}function D(e,t,r){var n=e.get(t);if(n)return n;var i=r();return e.set(t,i),i}function x(e,t,r){var n=r.compareEventOrdering(e,t);return null!==n&&n>=0}function F(e,t){var r=e.getTs(),n=t.getTs();return r<n?-1:+(r>n)}var L=r(5294),U=r(43957),N=r(94606);function j(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function B(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?j(Object(r),!0).forEach(function(t){(0,i.A)(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):j(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}var W="10",K=["1","2","3","4","5","6","7","8","9","10"],q=function(e){return e.Highlight="highlight",e.Total="total",e}({}),V=function(e){return e.MyMembership="Room.myMembership",e.Tags="Room.tags",e.AccountData="Room.accountData",e.Receipt="Room.receipt",e.Name="Room.name",e.Redaction="Room.redaction",e.RedactionCancelled="Room.redactionCancelled",e.LocalEchoUpdated="Room.localEchoUpdated",e.Timeline="Room.timeline",e.TimelineReset="Room.timelineReset",e.TimelineRefresh="Room.TimelineRefresh",e.OldStateUpdated="Room.OldStateUpdated",e.CurrentStateUpdated="Room.CurrentStateUpdated",e.HistoryImportedWithinTimeline="Room.historyImportedWithinTimeline",e.UnreadNotifications="Room.UnreadNotifications",e.Summary="Room.Summary",e}({});class H extends T.h{constructor(e,t,r){var o,l=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};super(),o=this,this.roomId=e,this.client=t,this.myUserId=r,this.opts=l,(0,i.A)(this,"reEmitter",void 0),(0,i.A)(this,"txnToEvent",new Map),(0,i.A)(this,"notificationCounts",{}),(0,i.A)(this,"bumpStamp",void 0),(0,i.A)(this,"threadNotifications",new Map),(0,i.A)(this,"cachedThreadReadReceipts",new Map),(0,i.A)(this,"oldestThreadedReceiptTs",1/0),(0,i.A)(this,"unthreadedReceipts",new Map),(0,i.A)(this,"timelineSets",void 0),(0,i.A)(this,"polls",new Map),(0,i.A)(this,"threadsTimelineSets",[]),(0,i.A)(this,"filteredTimelineSets",{}),(0,i.A)(this,"timelineNeedsRefresh",!1),(0,i.A)(this,"pendingEventList",void 0),(0,i.A)(this,"blacklistUnverifiedDevices",void 0),(0,i.A)(this,"selfMembership",void 0),(0,i.A)(this,"heroes",null),(0,i.A)(this,"getTypeWarning",!1),(0,i.A)(this,"membersPromise",void 0),(0,i.A)(this,"name",void 0),(0,i.A)(this,"normalizedName",void 0),(0,i.A)(this,"tags",{}),(0,i.A)(this,"accountData",new Map),(0,i.A)(this,"summary",null),(0,i.A)(this,"oldState",void 0),(0,i.A)(this,"currentState",void 0),(0,i.A)(this,"relations",void 0),(0,i.A)(this,"threads",new Map),(0,i.A)(this,"visibilityEvents",new Map),(0,i.A)(this,"roomReceipts",new A(this)),(0,i.A)(this,"stickyEvents",new N.x),(0,i.A)(this,"threadTimelineSetsPromise",null),(0,i.A)(this,"threadsReady",!1),(0,i.A)(this,"updateThreadRootEvents",(e,t,r)=>{if(e.length){var n,i;this.updateThreadRootEvent(null==(n=this.threadsTimelineSets)?void 0:n[0],e,t,r),e.hasCurrentUserParticipated&&this.updateThreadRootEvent(null==(i=this.threadsTimelineSets)?void 0:i[1],e,t,r)}}),(0,i.A)(this,"updateThreadRootEvent",(e,t,r,n)=>{e&&t.rootEvent&&(n&&e.removeEvent(t.id),E.jV.hasServerSideSupport?e.addLiveEvent(t.rootEvent,{duplicateStrategy:a.x.Replace,fromCache:!1,roomState:this.currentState,addToState:!1}):e.addEventToTimeline(t.rootEvent,e.getLiveTimeline(),{toStartOfTimeline:r,addToState:!1}))}),(0,i.A)(this,"tryApplyRedaction",e=>{if(e.isRedaction()){var t=e.event.redacts,r=t?this.findEventById(t):void 0;if(t)try{this.stickyEvents.handleRedaction(r||t)}catch(e){p.vF.error("Failed to handle redaction for sticky event",e)}r&&this.applyEventAsRedaction(e,r)}else if(e.getType()===g.Bx.RoomMember){var n=e.getContent().membership;if(n!==L.O.Ban&&(n!==L.O.Leave||e.getStateKey()===e.getSender())||!0!==e.getContent()["org.matrix.msc4293.redact_events"]||!this.getLiveTimeline().getState(s.O.Forward).maySendRedactionForEvent(e,e.getSender()))return;for(var i of this.getTimelineSets().map(e=>e.getTimelines()).reduce((e,t)=>(e.push(...t),e),[]).map(t=>t.getEvents().filter(t=>t.getSender()===e.getStateKey())).reduce((e,t)=>(e.push(...t),t),[]))this.applyEventAsRedaction(e,i)}}),this.setMaxListeners(100),this.reEmitter=new m.Q(this),l.pendingEventOrdering=l.pendingEventOrdering||f.eO.Chronological,this.name=e,this.normalizedName=e,this.relations=new w.t(this.client,this),this.on(V.Receipt,this.onReceipt),this.reEmitter.reEmit(this.stickyEvents,[N.m.Update]),this.timelineSets=[new a.m(this,l)],this.reEmitter.reEmit(this.getUnfilteredTimelineSet(),[V.Timeline,V.TimelineReset]),this.fixUpLegacyTimelineFields(),this.opts.pendingEventOrdering===f.eO.Detached&&(this.pendingEventList=[],this.client.store.getPendingEvents(this.roomId).then(e=>{var r=this.client.getEventMapper({decrypt:!1});e.forEach(function(){var e=(0,n.A)(function*(e){var n=r(e);yield t.decryptEventIfNeeded(n),n.setStatus(u.f.NOT_SENT),o.addPendingEvent(n,n.getTxnId())});return function(t){return e.apply(this,arguments)}}())})),this.opts.lazyLoadMembers?this.membersPromise=void 0:this.membersPromise=Promise.resolve(!1)}createThreadsTimelineSets(){var e=this;return(0,n.A)(function*(){var t;if(e.threadTimelineSetsPromise)return e.threadTimelineSetsPromise;if(null!=(t=e.client)&&t.supportsThreads())try{e.threadTimelineSetsPromise=Promise.all([e.createThreadTimelineSet(),e.createThreadTimelineSet(E.x3.My)]);var r=yield e.threadTimelineSetsPromise;return e.threadsTimelineSets[0]=r[0],e.threadsTimelineSets[1]=r[1],r}catch(t){e.threadTimelineSetsPromise=null}return null})()}decryptCriticalEvents(){var e=this;return(0,n.A)(function*(){if(e.client.getCrypto()){var t=e.getEventReadUpTo(e.client.getUserId(),!0),r=e.getLiveTimeline().getEvents(),n=r.findIndex(e=>e.event.event_id===t),i=r.slice(n).reverse().map(t=>e.client.decryptEventIfNeeded(t));yield Promise.allSettled(i)}})()}decryptAllEvents(){var e=this;return(0,n.A)(function*(){if(e.client.getCrypto()){var t=e.getUnfilteredTimelineSet().getLiveTimeline().getEvents().slice(0).reverse().map(t=>e.client.decryptEventIfNeeded(t));yield Promise.allSettled(t)}})()}getCreator(){var e,t=this.currentState.getStateEvents(g.Bx.RoomCreate,"");return null!=(e=null==t?void 0:t.getSender())?e:null}getVersion(){return this.currentState.getRoomVersion()}getRecommendedVersion(){var e=this;return(0,n.A)(function*(){var t={};try{t=yield e.client.getCapabilities()}catch(e){}var r=t["m.room_versions"];if(!r)for(var n of(r={default:W,available:{}},K))r.available[n]=U.L.Stable;var i=e.checkVersionAgainstCapability(r);if(i.urgent&&i.needsUpgrade){p.vF.warn("Refreshing room version capability because the server looks to be supporting a newer room version we don't know about.");try{t=yield e.client.fetchCapabilities()}catch(e){p.vF.warn("Failed to refresh room version capabilities",e)}(r=t["m.room_versions"])?i=e.checkVersionAgainstCapability(r):p.vF.warn("No room version capability - assuming upgrade required.")}return i})()}checkVersionAgainstCapability(e){var t=this.getVersion();p.vF.log("[".concat(this.roomId,"] Current version: ").concat(t)),p.vF.log("[".concat(this.roomId,"] Version capability: "),e);var r={version:t,needsUpgrade:!1,urgent:!1};return t===e.default||Object.keys(e.available).filter(t=>"stable"===e.available[t]).includes(t)||(r.version=e.default,r.needsUpgrade=!0,r.urgent=!!this.getVersion().match(/^[0-9]+[0-9.]*$/g),r.urgent?p.vF.warn("URGENT upgrade required on ".concat(this.roomId)):p.vF.warn("Non-urgent upgrade required on ".concat(this.roomId))),r}userMayUpgradeRoom(e){return this.currentState.maySendStateEvent(g.Bx.RoomTombstone,e)}getPendingEvents(){if(!this.pendingEventList)throw Error("Cannot call getPendingEvents with pendingEventOrdering == "+this.opts.pendingEventOrdering);return this.pendingEventList}removePendingEvent(e){if(!this.pendingEventList)throw Error("Cannot call removePendingEvent with pendingEventOrdering == "+this.opts.pendingEventOrdering);var t=(0,c.Nz)(this.pendingEventList,function(t){return t.getId()==e},!1);return this.savePendingEvents(),t}hasPendingEvent(e){var t,r;return null!=(t=null==(r=this.pendingEventList)?void 0:r.some(t=>t.getId()===e))&&t}getPendingEvent(e){var t,r;return null!=(t=null==(r=this.pendingEventList)?void 0:r.find(t=>t.getId()===e))?t:null}getLiveTimeline(){return this.getUnfilteredTimelineSet().getLiveTimeline()}get timeline(){return this.getLiveTimeline().getEvents()}getLastActiveTimestamp(){var e=this.getLiveTimeline().getEvents();return e.length?e[e.length-1].getTs():Number.MIN_SAFE_INTEGER}getLastLiveEvent(){var e,t,r=this.getLiveTimeline().getEvents(),n=r[r.length-1],i=this.getLastThread();if(!i)return n;var o=i.events[i.events.length-1];return(null!=(e=null==n?void 0:n.getTs())?e:0)>(null!=(t=null==o?void 0:o.getTs())?t:0)?n:o}getLastThread(){return this.getThreads().reduce((e,t)=>{if(!e)return t;var r,n,i=t.events[t.events.length-1],o=e.events[e.events.length-1];return(null!=(r=null==i?void 0:i.getTs())?r:0)>=(null!=(n=null==o?void 0:o.getTs())?n:0)?t:e},void 0)}getMyMembership(){var e;return null!=(e=this.selfMembership)?e:L.O.Leave}getDMInviter(){var e,t=this.getMember(this.myUserId);if(t)return t.getDMInviter();if(this.selfMembership===L.O.Invite&&2===this.getInvitedAndJoinedMemberCount())return null==(e=this.heroes)||null==(e=e[0])?void 0:e.userId}guessDMUserId(){var e=this.getMember(this.myUserId);if(e){var t=e.getDMInviter();if(t)return t}if(Array.isArray(this.heroes)&&this.heroes.length)return this.heroes[0].userId;var r=this.currentState.getMembers().find(e=>e.userId!==this.myUserId);return r?r.userId:this.myUserId}getFunctionalMembers(){var e=this.currentState.getStateEvents(g.Ng.name,"");return Array.isArray(null==e?void 0:e.getContent().service_members)?e.getContent().service_members:[]}getAvatarFallbackMember(){var e,t=this.getFunctionalMembers(),r=0;if(this.getMembers().forEach(e=>{("join"===e.membership||"invite"===e.membership)&&!t.includes(e.userId)&&r++}),!(r>2)){var n=null==(e=this.heroes)?void 0:e.filter(e=>!t.includes(e.userId)),i=Array.isArray(n)&&n.length;if(i){for(var o of n)if(o.fromMSC4186){var a=new h.Yx(this.roomId,o.userId);return a.setMembershipEvent(new d.kl({event_id:"$"+this.roomId+o.userId+new Date().getTime(),type:g.Bx.RoomMember,state_key:o.userId,content:{displayname:o.displayName,avatar_url:o.avatarUrl}})),a}else{var s=this.getMember(o.userId);if(s)return s}var l=n.map(e=>this.getMember(e.userId)).find(e=>!!e);if(l)return l}var c=this.getMembers(),u=null==c?void 0:c.filter(e=>!t.includes(e.userId));if(u.length<=2){var v=u.find(e=>e.userId!==this.myUserId);if(v)return v}if(i){var p=n.map(e=>this.client.getUser(e.userId)).find(e=>!!e);if(p){var m=new h.Yx(this.roomId,p.userId);return m.user=p,m}}}}updateMyMembership(e){var t=this.selfMembership;this.selfMembership=e,t!==e&&(e===L.O.Leave&&this.cleanupAfterLeaving(),this.emit(V.MyMembership,this,e,t))}loadMembersFromServer(){var e=this;return(0,n.A)(function*(){var t=e.client.store.getSyncToken();return(yield e.client.members(e.roomId,void 0,L.O.Leave,null!=t?t:void 0)).chunk})()}loadMembers(){var e=this;return(0,n.A)(function*(){var t=!1,r=yield e.client.store.getOutOfBandMembers(e.roomId);return(null===r||e.hasEncryptionStateEvent())&&(t=!0,r=yield e.loadMembersFromServer(),p.vF.log("LL: got ".concat(r.length," ")+"members from server for room ".concat(e.roomId))),{memberEvents:r.filter(c.O5).map(e.client.getEventMapper()),fromServer:t}})()}membersLoaded(){return!this.opts.lazyLoadMembers||this.currentState.outOfBandMembersReady()}loadMembersIfNeeded(){if(this.membersPromise)return this.membersPromise;this.currentState.markOutOfBandMembersStarted();var e=this.loadMembers().then(e=>(this.currentState.setOutOfBandMembers(e.memberEvents),this.recalculate(),e.fromServer)).catch(e=>{throw this.membersPromise=void 0,this.currentState.markOutOfBandMembersFailed(),e});return e.then(e=>{if(e){var t=this.currentState.getMembers().filter(e=>e.isOutOfBand()).map(e=>{var t;return null==(t=e.events.member)?void 0:t.event});return p.vF.log("LL: telling store to write ".concat(t.length)+" members for room ".concat(this.roomId)),this.client.store.setOutOfBandMembers(this.roomId,t).catch(e=>{p.vF.log("LL: storing OOB room members failed, oh well",e)})}}).catch(e=>{p.vF.error(e)}),this.membersPromise=e,this.membersPromise}clearLoadedMembersIfNeeded(){var e=this;return(0,n.A)(function*(){e.opts.lazyLoadMembers&&e.membersPromise&&(yield e.loadMembersIfNeeded(),yield e.client.store.clearOutOfBandMembers(e.roomId),e.currentState.clearOutOfBandMembers(),e.membersPromise=void 0)})()}cleanupAfterLeaving(){this.clearLoadedMembersIfNeeded().catch(e=>{p.vF.error("error after clearing loaded members from "+"room ".concat(this.roomId," after leaving")),p.vF.log(e)})}refreshLiveTimeline(){var e=this;return(0,n.A)(function*(){var t=e.getLiveTimeline(),r=t.getPaginationToken(s.q.FORWARDS),n=t.getPaginationToken(s.q.BACKWARDS),i=t.getEvents(),o=i[i.length-1];p.vF.log("[refreshLiveTimeline for ".concat(e.roomId,"] at ")+"mostRecentEventInTimeline=".concat(o&&o.getId()," ")+"liveTimelineBefore=".concat(t.toString()," ")+"forwardPaginationToken=".concat(r," ")+"backwardPaginationToken=".concat(n));var a=e.getUnfilteredTimelineSet(),l=null;o?(e.resetLiveTimeline(null,null),e.emit(V.TimelineRefresh,e,a),l=yield e.client.getEventTimeline(a,o.getId())):l=yield e.client.getLatestTimeline(a);var c=a.getLiveTimeline();c&&(null!==c.getPaginationToken(s.O.Forward)||null!==c.getPaginationToken(s.O.Backward)||0!==c.getEvents().length)?p.vF.log("[refreshLiveTimeline for ".concat(e.roomId,"] `/sync` or some other request beat us to creating a new ")+"live timeline after we reset it. We'll use that instead since any events in the scrollback from this timeline will include the history."):(p.vF.log("[refreshLiveTimeline for ".concat(e.roomId,"] using our new live timeline")),l.setPaginationToken(r,s.q.FORWARDS),a.setLiveTimeline(l),e.fixUpLegacyTimelineFields()),e.setTimelineNeedsRefresh(!1),e.emit(V.TimelineRefresh,e,a)})()}resetLiveTimeline(e,t){for(var r of this.timelineSets)r.resetLiveTimeline(null!=e?e:void 0,null!=t?t:void 0);for(var n of this.threads.values())n.resetLiveTimeline(e,t);this.fixUpLegacyTimelineFields()}fixUpLegacyTimelineFields(){var e=this.oldState,t=this.currentState;this.oldState=this.getLiveTimeline().getState(s.q.BACKWARDS),this.currentState=this.getLiveTimeline().getState(s.q.FORWARDS),e!==this.oldState&&this.emit(V.OldStateUpdated,this,e,this.oldState),t!==this.currentState&&(this.emit(V.CurrentStateUpdated,this,t,this.currentState),this.reEmitter.stopReEmitting(t,[b.f.Events,b.f.Members,b.f.NewMember,b.f.Update,b.f.Marker,S.JH.New,S.JH.Update,S.JH.Destroy,S.JH.LivenessChange]),this.reEmitter.reEmit(this.currentState,[b.f.Events,b.f.Members,b.f.NewMember,b.f.Update,b.f.Marker,S.JH.New,S.JH.Update,S.JH.Destroy,S.JH.LivenessChange]))}onReceipt(e){this.hasEncryptionStateEvent()&&this.clearNotificationsOnReceipt(e)}clearNotificationsOnReceipt(e){var t=[],r=!1;for(var n of Object.values(e.getContent()))for(var[i,o]of Object.entries(n))if(c.ll(i)&&o)for(var[a,s]of Object.entries(o))s&&"object"==typeof s&&a===this.client.getUserId()&&(void 0===s.thread_id?r=!0:"string"==typeof s.thread_id&&t.push(s.thread_id));for(var l of(r&&(t=this.getThreads().filter(e=>this.getThreadUnreadNotificationCount(e.id,q.Total)>0||this.getThreadUnreadNotificationCount(e.id,q.Highlight)>0).map(e=>e.id)).push("main"),t)){var d="main"===l?this.getLiveTimeline():null==(m=this.getThread(l))?void 0:m.liveTimeline;if(!d){p.vF.warn("Couldn't find timeline for thread ID ".concat(l," in room ").concat(this.roomId));continue}for(var u=d.getEvents(),h=0,v=u.length-1;v>=0;v--){if(v===u.length-20)return;var m,g,f=u[v];if(this.hasUserReadEvent(this.client.getUserId(),f.getId()))break;var y=this.client.getPushActionsForEvent(f);h+=null!=y&&null!=(g=y.tweaks)&&g.highlight?1:0}"main"===l?this.setUnreadNotificationCount(q.Highlight,h):this.setThreadUnreadNotificationCount(l,q.Highlight,h)}}getTimelineSets(){return this.timelineSets}getUnfilteredTimelineSet(){return this.timelineSets[0]}getTimelineForEvent(e){var t=this.findEventById(e),r=this.findThreadForEvent(t);return r?r.timelineSet.getTimelineForEvent(e):this.getUnfilteredTimelineSet().getTimelineForEvent(e)}addTimeline(){return this.getUnfilteredTimelineSet().addTimeline()}setTimelineNeedsRefresh(e){this.timelineNeedsRefresh=e}getTimelineNeedsRefresh(){return this.timelineNeedsRefresh}findEventById(e){var t=this.getUnfilteredTimelineSet().findEventById(e);if(!t)for(var r=this.getThreads(),n=0;n<r.length&&!(t=r[n].findEventById(e));n++);return t}getUnreadNotificationCount(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:q.Total,r=this.getRoomUnreadNotificationCount(t);for(var n of this.threadNotifications.values())r+=null!=(e=n[t])?e:0;return r}getUnreadCountForEventContext(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:q.Total,r=arguments.length>1?arguments[1]:void 0;return null!=(e=r.threadRootId&&!r.isThreadRoot?this.getThreadUnreadNotificationCount(r.threadRootId,t):this.getRoomUnreadNotificationCount(t))?e:0}getRoomUnreadNotificationCount(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:q.Total;return null!=(e=this.notificationCounts[t])?e:0}getThreadUnreadNotificationCount(e){var t,r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:q.Total;return null!=(t=null==(r=this.threadNotifications.get(e))?void 0:r[n])?t:0}hasThreadUnreadNotification(){for(var e of this.threadNotifications.values()){var t,r;if((null!=(t=e.highlight)?t:0)>0||(null!=(r=e.total)?r:0)>0)return!0}return!1}setThreadUnreadNotificationCount(e,t,r){var n,i,o=B({highlight:null==(n=this.threadNotifications.get(e))?void 0:n.highlight,total:null==(i=this.threadNotifications.get(e))?void 0:i.total},{[t]:r});this.threadNotifications.set(e,o),this.emit(V.UnreadNotifications,o,e)}get threadsAggregateNotificationType(){var e,t,r=null;for(var n of this.threadNotifications.values()){if((null!=(e=n.highlight)?e:0)>0)return q.Highlight;(null!=(t=n.total)?t:0)>0&&!r&&(r=q.Total)}return r}resetThreadUnreadNotificationCountFromSync(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=this.hasEncryptionStateEvent();for(var[r,n]of this.threadNotifications)!e.includes(r)&&(n.total=0,t||(n.highlight=0));this.emit(V.UnreadNotifications)}setBumpStamp(e){this.bumpStamp=e}getBumpStamp(){return this.bumpStamp}setUnreadNotificationCount(e,t){this.notificationCounts[e]=t,this.emit(V.UnreadNotifications,this.notificationCounts)}setUnread(e,t){return this.setUnreadNotificationCount(e,t)}setSummary(e){var t,r=null==(t=e["m.heroes"])?void 0:t.map(e=>({userId:e,fromMSC4186:!1})),n=e["m.joined_member_count"],i=e["m.invited_member_count"];Number.isInteger(n)&&this.currentState.setJoinedMemberCount(n),Number.isInteger(i)&&this.currentState.setInvitedMemberCount(i),Array.isArray(r)&&(this.heroes=r.filter(e=>e.userId!=this.myUserId)),this.emit(V.Summary,e)}setMSC4186SummaryData(e,t,r){e&&(this.heroes=e.filter(e=>e.user_id!==this.myUserId).map(e=>({userId:e.user_id,displayName:e.displayname,avatarUrl:e.avatar_url,fromMSC4186:!0}))),void 0!==t&&Number.isInteger(t)&&this.currentState.setJoinedMemberCount(t),void 0!==r&&Number.isInteger(r)&&this.currentState.setInvitedMemberCount(r),this.emit(V.Summary,{"m.heroes":this.heroes?this.heroes.map(e=>e.userId):[],"m.joined_member_count":t,"m.invited_member_count":r})}setBlacklistUnverifiedDevices(e){this.blacklistUnverifiedDevices=e}getBlacklistUnverifiedDevices(){return void 0===this.blacklistUnverifiedDevices?null:this.blacklistUnverifiedDevices}getAvatarUrl(e,t,r,n){var i=!(arguments.length>4)||void 0===arguments[4]||arguments[4],o=arguments.length>5&&void 0!==arguments[5]&&arguments[5],a=this.getMxcAvatarUrl();return(a||i)&&a?(0,l.y)(e,a,t,r,n,void 0,void 0,o):null}getMxcAvatarUrl(){var e,t=null==(e=this.currentState.getStateEvents(g.Bx.RoomAvatar,""))?void 0:e.getContent().url;return t&&"string"==typeof t?t:null}getCanonicalAlias(){var e,t=null==(e=this.currentState.getStateEvents(g.Bx.RoomCanonicalAlias,""))?void 0:e.getContent().alias;return t&&"string"==typeof t?t:null}getAltAliases(){var e,t=null==(e=this.currentState.getStateEvents(g.Bx.RoomCanonicalAlias,""))?void 0:e.getContent().alt_aliases;return Array.isArray(t)?t.filter(e=>"string"==typeof e):[]}addEventsToTimeline(e,t,r,n,i){n.getTimelineSet().addEventsToTimeline(e,t,r,n,i)}getThread(e){var t;return null!=(t=this.threads.get(e))?t:null}getThreads(){return Array.from(this.threads.values())}getMember(e){return this.currentState.getMember(e)}getMembers(){return this.currentState.getMembers()}getJoinedMembers(){return this.getMembersWithMembership(L.O.Join)}getJoinedMemberCount(){return this.currentState.getJoinedMemberCount()}getInvitedMemberCount(){return this.currentState.getInvitedMemberCount()}getInvitedAndJoinedMemberCount(){return this.getInvitedMemberCount()+this.getJoinedMemberCount()}getMembersWithMembership(e){return this.currentState.getMembers().filter(function(t){return t.membership===e})}getEncryptionTargetMembers(){var e=this;return(0,n.A)(function*(){yield e.loadMembersIfNeeded();var t=e.getMembersWithMembership(L.O.Join);return e.shouldEncryptForInvitedMembers()&&(t=t.concat(e.getMembersWithMembership(L.O.Invite))),t})()}shouldEncryptForInvitedMembers(){var e,t=this.currentState.getStateEvents(g.Bx.RoomHistoryVisibility,"");return(null==t||null==(e=t.getContent())?void 0:e.history_visibility)!=="joined"}getDefaultRoomName(e){return this.calculateRoomName(e,!0)}hasMembershipState(e,t){var r=this.getMember(e);return!!r&&r.membership===t}getOrCreateFilteredTimelineSet(e){var{prepopulateTimeline:t=!0,useSyncEvents:r=!0,pendingEvents:n=!0}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(this.filteredTimelineSets[e.filterId])return this.filteredTimelineSets[e.filterId];var i=Object.assign({filter:e,pendingEvents:n},this.opts),o=new a.m(this,i);this.reEmitter.reEmit(o,[V.Timeline,V.TimelineReset]),r&&(this.filteredTimelineSets[e.filterId]=o,this.timelineSets.push(o));var l=this.getLiveTimeline();if(t){l.getEvents().forEach(function(e){o.addLiveEvent(e,{addToState:!1})});for(var c=l;c.getNeighbouringTimeline(s.q.BACKWARDS);)c=c.getNeighbouringTimeline(s.q.BACKWARDS);o.getLiveTimeline().setPaginationToken(c.getPaginationToken(s.q.BACKWARDS),s.q.BACKWARDS)}else if(r){var d=l.getPaginationToken(s.O.Forward);o.getLiveTimeline().setPaginationToken(d,s.O.Backward)}return o}getThreadListFilter(){var e=arguments,t=this;return(0,n.A)(function*(){var r=e.length>0&&void 0!==e[0]?e[0]:E.x3.All,n=t.client.getUserId(),i=new y.d(n),o={room:{timeline:{[E.H.name]:[E.RN.name]}}};r===E.x3.My&&(o.room.timeline[E.o1.name]=[n]),i.setDefinition(o);var a=yield t.client.getOrCreateFilter("THREAD_PANEL_".concat(t.roomId,"_").concat(r),i);return i.filterId=a,i})()}createThreadTimelineSet(e){var t=this;return(0,n.A)(function*(){var r;if(E.jV.hasServerSideListSupport)r=new a.m(t,B(B({},t.opts),{},{pendingEvents:!1}),void 0,void 0,null!=e?e:E.x3.All),t.reEmitter.reEmit(r,[V.Timeline,V.TimelineReset]);else if(E.jV.hasServerSideSupport){var n=yield t.getThreadListFilter(e);r=t.getOrCreateFilteredTimelineSet(n,{prepopulateTimeline:!1,useSyncEvents:!1,pendingEvents:!1})}else r=new a.m(t,{pendingEvents:!1}),Array.from(t.threads).forEach(n=>{var[,i]=n;if(0!==i.length){var o=i.timeline.some(e=>e.getSender()===t.client.getUserId());(e!==E.x3.My||o)&&r.getLiveTimeline().addEvent(i.rootEvent,{toStartOfTimeline:!1,addToState:!1})}});return r})()}processThreadRoots(e,t){if(this.client.supportsThreads())for(var r of e)s.q.setEventMetadata(r,this.currentState,t),this.getThread(r.getId())||this.createThread(r.getId(),r,[],t)}fetchRoomThreads(){var e=this;return(0,n.A)(function*(){if(!e.threadsReady&&e.client.supportsThreads()){if(E.jV.hasServerSideListSupport)yield Promise.all([e.fetchRoomThreadList(E.x3.All),e.fetchRoomThreadList(E.x3.My)]);else{var t=yield e.getThreadListFilter(),{chunk:r}=yield e.client.createMessagesRequest(e.roomId,"",Number.MAX_SAFE_INTEGER,s.O.Backward,t);if(!r.length)return;var n=r.map(e.client.getEventMapper()).sort((e,t)=>{var r=e.getServerAggregatedRelation(E.RN.name),n=t.getServerAggregatedRelation(E.RN.name);return r.latest_event.origin_server_ts-n.latest_event.origin_server_ts}),i=e.getLiveTimeline().getState(s.q.FORWARDS);for(var o of n){var l,c,d,u={duplicateStrategy:a.x.Ignore,fromCache:!1,addToState:!1,roomState:i};null==(c=e.threadsTimelineSets[0])||c.addLiveEvent(o,u);var h=o.getServerAggregatedRelation(E.RN.name);null!=h&&h.current_user_participated&&(null==(d=e.threadsTimelineSets[1])||d.addLiveEvent(o,u),l=o)}e.processThreadRoots(n,!0),e.client.decryptEventIfNeeded(n[n.length-1]),l&&e.client.decryptEventIfNeeded(l)}e.on(E.ju.NewReply,e.onThreadReply),e.on(E.ju.Update,e.onThreadUpdate),e.on(E.ju.Delete,e.onThreadDelete),e.threadsReady=!0}})()}processPollEvents(e){var t=this;return(0,n.A)(function*(){for(var r of e)try{if(!r.isEncrypted()&&!(0,I.Wi)(r))continue;yield t.client.decryptEventIfNeeded(r),t.processPollEvent(r)}catch(e){p.vF.warn("Error processing poll event",r.getId(),e)}})()}processPollEvent(e){var t=this;return(0,n.A)(function*(){if(e.isDecryptionFailure())return void e.once(d.OQ.Decrypted,e=>{t.processPollEvent(e)});if(o.M_POLL_START.matches(e.getType())){try{var r=new I.sP(e,t.client,t);t.polls.set(e.getId(),r),t.emit(I.sn.New,r),e.once(d.OQ.BeforeRedaction,e=>{t.polls.delete(e.getId())})}catch(e){}return}var n=e.relationEventId;if(n&&t.polls.has(n)){var i=t.polls.get(n);null==i||i.onNewRelation(e)}})()}fetchRoomThreadList(e){var t=this;return(0,n.A)(function*(){if(t.client.supportsThreads()&&0!==t.threadsTimelineSets.length){var r=e===E.x3.My?t.threadsTimelineSets[1]:t.threadsTimelineSets[0],{chunk:n,end:i}=yield t.client.createThreadListMessagesRequest(t.roomId,null,void 0,s.O.Backward,r.threadListType,r.getFilter());if(r.getLiveTimeline().setPaginationToken(null!=i?i:null,s.O.Backward),n.length){var o=n.map(t.client.getEventMapper());t.processThreadRoots(o,!0);var l=t.getLiveTimeline().getState(s.q.FORWARDS);for(var c of o)r.addLiveEvent(c,{duplicateStrategy:a.x.Replace,fromCache:!1,roomState:l,addToState:!1})}}})()}onThreadUpdate(e){this.updateThreadRootEvents(e,!1,!1)}onThreadReply(e){this.updateThreadRootEvents(e,!1,!0)}onThreadDelete(e){this.threads.delete(e.id);var t,r=this.getTimelineForEvent(e.id),n=null==r||null==(t=r.getEvents())?void 0:t.find(t=>t.getId()===e.id);for(var i of(n?e.clearEventMetadata(n):p.vF.debug("onThreadDelete: Could not find root event in room timeline"),this.threadsTimelineSets))i.removeEvent(e.id)}removeFilteredTimelineSet(e){var t=this.filteredTimelineSets[e.filterId];delete this.filteredTimelineSets[e.filterId];var r=this.timelineSets.indexOf(t);r>-1&&this.timelineSets.splice(r,1)}eventShouldLiveIn(e,t,r){if(!(null!=(n=this.client)&&n.supportsThreads()))return{shouldLiveInRoom:!0,shouldLiveInThread:!1};if(e.isThreadRoot||null!=r&&r.has(e.getId()))return{shouldLiveInRoom:!0,shouldLiveInThread:!0,threadId:e.getId()};var n,i,o,a=e.isRelation(E.RN.name),s=e.getAssociatedId(),l=e.threadRootId;return s&&!a&&(l===s||null!=r&&r.has(s))?{shouldLiveInRoom:!0,shouldLiveInThread:!1}:(s&&(i=null!=(o=this.findEventById(s))?o:null==t?void 0:t.find(e=>e.getId()===s)),i&&!a)?this.eventShouldLiveIn(i,t,r):void 0!=l?{shouldLiveInRoom:!1,shouldLiveInThread:!0,threadId:l}:!s||e.replyEventId?{shouldLiveInRoom:!0,shouldLiveInThread:!1}:{shouldLiveInRoom:!1,shouldLiveInThread:!1}}findThreadForEvent(e){if(!e)return null;var{threadId:t}=this.eventShouldLiveIn(e);return t?this.getThread(t):null}addThreadedEvents(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=this.getThread(e);if(n)n.addEvents(t,r);else{var i,o=null!=(i=this.findEventById(e))?i:t.find(t=>t.getId()===e);this.createThread(e,o,t,r)}}processThreadedEvents(e,t){e.forEach(this.tryApplyRedaction);var r={};for(var n of e){var i,{threadId:o,shouldLiveInThread:a}=this.eventShouldLiveIn(n);a&&!r[o]&&(r[o]=[]),null==(i=r[o])||i.push(n)}Object.entries(r).map(e=>{var[r,n]=e;return this.addThreadedEvents(r,n,t)})}createThread(e,t){var r,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],i=arguments.length>3?arguments[3]:void 0;if(this.threads.has(e))return this.threads.get(e);if(t){var o=this.relations.getAllChildEventsForEvent(t.getId());null!=o&&o.length&&(n=n.concat(o.filter(e=>!e.isRelation(g.zZ.Replace))))}var a=new E.jV(e,t,{room:this,client:this.client,pendingEventOrdering:this.opts.pendingEventOrdering,receipts:null!=(r=this.cachedThreadReadReceipts.get(e))?r:[]});return this.reEmitter.reEmit(a,[E.ju.Delete,E.ju.Update,E.ju.NewReply,V.Timeline,V.TimelineReset]),this.cachedThreadReadReceipts.delete(e),this.threads.set(a.id,a),a.addEvents(n,!1),this.threadsReady&&a.initialEventsFetched&&this.updateThreadRootEvents(a,i,!1),this.emit(E.ju.New,a,i),a}applyEventAsRedaction(e,t){var r=t.threadRootId;if(t.makeRedacted(e,this),t.isState()){var n=this.currentState.getStateEvents(t.getType(),t.getStateKey());(null==n?void 0:n.getId())===t.getId()&&this.currentState.setStateEvents([t])}this.emit(V.Redaction,e,this,r),this.visibilityEvents.delete(t.getId()),t.isVisibilityEvent()&&this.redactVisibilityChangeEvent(e)}processLiveEvent(e){if(this.tryApplyRedaction(e),e.isVisibilityEvent()&&this.applyNewVisibilityEvent(e),this.applyPendingVisibilityEvents(e),!e.getUnsigned().transaction_id&&e.getSender()===this.myUserId){for(var[t,r]of this.txnToEvent)if(r.getId()===e.getId()){p.vF.debug("processLiveEvent: found sent event without txn ID: ",t,e.getId());var n=e.getUnsigned();n.transaction_id=t,e.setUnsigned(n);break}}}addLiveEvent(e,t){var{duplicateStrategy:r,timelineWasEmpty:n,fromCache:i,addToState:o}=t;for(var a of this.timelineSets)a.addLiveEvent(e,{duplicateStrategy:r,fromCache:i,timelineWasEmpty:n,addToState:o});e.sender&&e.getType()!==g.Bx.RoomRedaction&&this.addReceipt((0,T.D)(e.sender.userId,e,_.L.Read),!0)}addPendingEvent(e,t){if(e.status!==u.f.SENDING&&e.status!==u.f.NOT_SENT)throw Error("addPendingEvent called on an event with status "+e.status);if(this.txnToEvent.get(t))throw Error("addPendingEvent called on an event with known txnId "+t);if(s.q.setEventMetadata(e,this.getLiveTimeline().getState(s.q.FORWARDS),!1),this.txnToEvent.set(t,e),this.pendingEventList){if(this.pendingEventList.some(e=>e.status===u.f.NOT_SENT)&&(p.vF.warn("Setting event as NOT_SENT due to messages in the same state"),e.setStatus(u.f.NOT_SENT)),this.pendingEventList.push(e),this.savePendingEvents(),e.isRelation()&&this.aggregateNonLiveRelation(e),e.isRedaction()){var r=e.event.redacts,n=this.pendingEventList.find(e=>e.getId()===r);!n&&r&&(n=this.findEventById(r)),n&&(n.markLocallyRedacted(e),this.emit(V.Redaction,e,this,n.threadRootId))}}else for(var i of this.timelineSets)i.getFilter()?i.getFilter().filterRoomTimeline([e]).length&&i.addEventToTimeline(e,i.getLiveTimeline(),{toStartOfTimeline:!1,addToState:!1}):i.addEventToTimeline(e,i.getLiveTimeline(),{toStartOfTimeline:!1,addToState:!1});this.emit(V.LocalEchoUpdated,e,this)}savePendingEvents(){if(this.pendingEventList){var e=this.pendingEventList.map(e=>B(B({},e.event),{},{txn_id:e.getTxnId()})).filter(e=>{var t=e.type===g.Bx.RoomMessageEncrypted,r=this.hasEncryptionStateEvent();return t||!r});this.client.store.setPendingEvents(this.roomId,e)}}aggregateNonLiveRelation(e){this.relations.aggregateChildEvent(e)}getEventForTxnId(e){return this.txnToEvent.get(e)}handleRemoteEcho(e,t){var r=t.getId(),n=e.getId(),i=t.status;p.vF.debug("Got remote echo for event ".concat(r," -> ").concat(n," old status ").concat(i)),this.txnToEvent.delete(e.getUnsigned().transaction_id),this.pendingEventList&&this.removePendingEvent(r),t.handleRemoteEcho(e.event);var{shouldLiveInRoom:o,threadId:a}=this.eventShouldLiveIn(e),s=a?this.getThread(a):null;if(null==s||s.setEventMetadata(t),null==s||s.timelineSet.handleRemoteEcho(t,r,n),o)for(var l of this.timelineSets)l.handleRemoteEcho(t,r,n);this.emit(V.LocalEchoUpdated,t,this,r,i)}updatePendingEvent(e,t,r){if(p.vF.log("setting pendingEvent status to ".concat(t," in ").concat(e.getRoomId()," ")+"event ID ".concat(e.getId()," -> ").concat(r)),t==u.f.SENT&&!r)throw Error("updatePendingEvent called with status=SENT, but no new event id");if(t==u.f.SENT&&this.getTimelineForEvent(r)){var n=this.findEventById(r);if(!(null==n?void 0:n.getUnsigned().transaction_id)&&n){var i=n.getUnsigned();i.transaction_id=e.getTxnId(),n.setUnsigned(i),this.removeEvent(n.getId()),this.handleRemoteEcho(n,e)}return}var o=e.status,a=e.getId();if(!o)throw Error("updatePendingEventStatus called on an event which is not a local echo.");var s=G[o];if(!(null!=s&&s.includes(t)))throw Error("Invalid EventStatus transition ".concat(o,"->").concat(t));if(e.setStatus(t),t==u.f.SENT){e.replaceLocalEventId(r);var{shouldLiveInRoom:l,threadId:c}=this.eventShouldLiveIn(e),d=c?this.getThread(c):void 0;if(null==d||d.setEventMetadata(e),null==d||d.timelineSet.replaceEventId(a,r),l)for(var h of this.timelineSets)h.replaceEventId(a,r)}else if(t==u.f.CANCELLED){if(this.pendingEventList){var v=this.getPendingEvent(a);this.removePendingEvent(a),null!=v&&v.isRedaction()&&this.revertRedactionLocalEcho(v)}this.removeEvent(a)}this.savePendingEvents(),this.emit(V.LocalEchoUpdated,e,this,a,o)}revertRedactionLocalEcho(e){var t=e.event.redacts;if(t){var r=this.getUnfilteredTimelineSet().findEventById(t);r&&(r.unmarkLocallyRedacted(),this.emit(V.RedactionCancelled,e,this),r.isRelation()&&this.aggregateNonLiveRelation(r))}}assertTimelineSetsAreLive(){for(var e=0;e<this.timelineSets.length;e++){var t=this.timelineSets[e].getLiveTimeline();if(t.getPaginationToken(s.q.FORWARDS))throw Error("live timeline "+e+" is no longer live - it has a pagination token ("+t.getPaginationToken(s.q.FORWARDS)+")");if(t.getNeighbouringTimeline(s.q.FORWARDS))throw Error("live timeline ".concat(e," is no longer live - it has a neighbouring timeline"))}}addLiveEvents(e,t){var r=this;return(0,n.A)(function*(){var{duplicateStrategy:n,fromCache:i,timelineWasEmpty:o=!1,addToState:a}=t;if(n&&-1===["replace","ignore"].indexOf(n))throw Error("duplicateStrategy MUST be either 'replace' or 'ignore'");r.assertTimelineSetsAreLive();var s=r.findThreadRoots(e),l={},c={duplicateStrategy:n,fromCache:i,timelineWasEmpty:o,addToState:a},u=[...e];for(var h of e){if(r.processLiveEvent(h),h.getUnsigned().transaction_id){var v,m=r.txnToEvent.get(h.getUnsigned().transaction_id);if(m){r.handleRemoteEcho(h,m);continue}}var{shouldLiveInRoom:f,shouldLiveInThread:y,threadId:b=""}=r.eventShouldLiveIn(h,u,s);if(!y&&!f&&h.isRelation())try{var S=new d.kl((yield r.client.fetchRoomEvent(r.roomId,h.relationEventId)));if(u.push(S),S.threadRootId){s.add(S.threadRootId);var E=h.getUnsigned();E[g.Sr.name]=S.threadRootId,h.setUnsigned(E)}({shouldLiveInRoom:f,shouldLiveInThread:y,threadId:b=""}=r.eventShouldLiveIn(h,u,s))}catch(e){p.vF.error("Failed to load parent event of unhandled relation",e)}y&&!l[b]&&(l[b]=[]),null==(v=l[b])||v.push(h),f?r.addLiveEvent(h,c):!y&&h.isRelation()&&r.relations.aggregateChildEvent(h)}Object.entries(l).forEach(e=>{var[t,n]=e;r.addThreadedEvents(t,n,!1)})})()}partitionThreadedEvents(e){if(!this.client.supportsThreads())return[e,[],[]];var t=this.findThreadRoots(e);return e.reduce((r,n)=>{var{shouldLiveInRoom:i,shouldLiveInThread:o,threadId:a}=this.eventShouldLiveIn(n,e,t);return i&&r[0].push(n),o&&(n.setThreadId(null!=a?a:""),r[1].push(n)),o||i||r[2].push(n),r},[[],[],[]])}findThreadRoots(e){var t=new Set;for(var r of e){var n=r.threadRootId;void 0!=n&&t.add(n)}return t}addReceipt(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=e.getContent();this.roomReceipts.add(r,t),Object.keys(r).forEach(e=>{Object.keys(r[e]).forEach(n=>{Object.keys(r[e][n]).forEach(i=>{var o,a,s,l,c=r[e][n][i],d=!c.thread_id||c.thread_id===_.S,u=d?this:this.threads.get(null!=(o=c.thread_id)?o:"");if(u){if(u.addReceiptToStructure(e,n,i,c,t),!t&&this.client.isInitialSyncComplete()&&i===this.client.getUserId()){var h=u.timeline[u.timeline.length-1];h&&e===h.getId()&&i===h.getSender()&&(u.setUnread(q.Total,0),u.setUnread(q.Highlight,0))}}else this.cachedThreadReadReceipts.set(c.thread_id,[...null!=(l=this.cachedThreadReadReceipts.get(c.thread_id))?l:[],{eventId:e,receiptType:n,userId:i,receipt:c,synthetic:t}]);i===this.client.getUserId()&&!d&&c.ts<this.oldestThreadedReceiptTs&&(this.oldestThreadedReceiptTs=c.ts),!c.thread_id&&c.ts>(null!=(a=null==(s=this.unthreadedReceipts.get(i))?void 0:s.ts)?a:0)&&this.unthreadedReceipts.set(i,c)})})}),this.emit(V.Receipt,e,this)}addEphemeralEvents(e){for(var t of e)t.getType()===g.Bx.Typing?this.currentState.setTypingEvent(t):t.getType()===g.Bx.Receipt&&this.addReceipt(t)}removeEvents(e){for(var t of e)this.removeEvent(t)}removeEvent(e){var t=!1;for(var r of this.timelineSets){var n=r.removeEvent(e);n&&(n.isRedaction()&&this.revertRedactionLocalEcho(n),t=!0)}return t}recalculate(){var e=this.currentState.getStateEvents(g.Bx.RoomMember,this.myUserId);if(e){var t=e.getContent().membership;this.updateMyMembership(t),t===L.O.Invite&&(e.getUnsigned().invite_room_state||[]).forEach(e=>{this.currentState.getStateEvents(e.type,e.state_key)||this.currentState.setStateEvents([new d.kl({type:e.type,state_key:e.state_key,content:e.content,event_id:"$fake"+Date.now(),room_id:this.roomId,sender:this.myUserId})])})}var r=this.name;this.name=this.calculateRoomName(this.myUserId),this.normalizedName=(0,c.S8)(this.name),this.summary=new v.c(this.roomId,{title:this.name}),r!==this.name&&this.emit(V.Name,this)}addTags(e){this.tags=e.getContent().tags||{},this.emit(V.Tags,e,this)}addAccountData(e){for(var t of e){"m.tag"===t.getType()&&this.addTags(t);var r=t.getType(),n=this.accountData.get(r);this.accountData.set(r,t),this.emit(V.AccountData,t,this,n)}}getAccountData(e){return this.accountData.get(e)}_unstable_getStickyEvents(){return this.stickyEvents.getStickyEvents()}_unstable_getKeyedStickyEvent(e,t,r){return this.stickyEvents.getKeyedStickyEvent(e,t,r)}_unstable_getUnkeyedStickyEvent(e,t){return this.stickyEvents.getUnkeyedStickyEvent(e,t)}_unstable_addStickyEvents(e){return this.stickyEvents.addStickyEvents(e)}maySendMessage(){return this.getMyMembership()===L.O.Join&&(this.hasEncryptionStateEvent()?this.currentState.maySendEvent(g.Bx.RoomMessageEncrypted,this.myUserId):this.currentState.maySendEvent(g.Bx.RoomMessage,this.myUserId))}canInvite(e){var t=this.getMyMembership()===L.O.Join,r=this.currentState.getStateEvents(g.Bx.RoomPowerLevels,""),n=r&&r.getContent(),i=this.getMember(e);return n&&i&&n.invite>i.powerLevel&&(t=!1),t}getJoinRule(){return this.currentState.getJoinRule()}getHistoryVisibility(){return this.currentState.getHistoryVisibility()}getGuestAccess(){return this.currentState.getGuestAccess()}getType(){var e=this.currentState.getStateEvents(g.Bx.RoomCreate,"");if(!e){this.getTypeWarning||(p.vF.warn("[getType] Room "+this.roomId+" does not have an m.room.create event"),this.getTypeWarning=!0);return}return e.getContent()[g.Ct]}isSpaceRoom(){return this.getType()===g.CJ.Space}isCallRoom(){return this.getType()===g.CJ.UnstableCall}isElementVideoRoom(){return this.getType()===g.CJ.ElementVideo}findPredecessor(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=this.getLiveTimeline().getState(s.q.FORWARDS);return t?t.findPredecessor(e):null}roomNameGenerator(e){if(this.client.roomNameGenerator){var t=this.client.roomNameGenerator(this.roomId,e);if(null!==t)return t}switch(e.type){case J.Actual:return e.name;case J.Generated:if("Inviting"===e.subtype)return"Inviting ".concat(z(e.names,e.count));return z(e.names,e.count);case J.EmptyRoom:if(e.oldName)return"Empty room (was ".concat(e.oldName,")");return"Empty room"}}calculateRoomName(e){var t,r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!r){var n,i=null==(n=this.currentState.getStateEvents(g.Bx.RoomName,""))?void 0:n.getContent().name;if(i&&"string"==typeof i)return this.roomNameGenerator({type:J.Actual,name:i})}var o=this.getCanonicalAlias();if(o)return this.roomNameGenerator({type:J.Actual,name:o});var a=this.currentState.getJoinedMemberCount()+this.currentState.getInvitedMemberCount()-1,s=this.getFunctionalMembers(),l=[];if(this.heroes)this.heroes.forEach(e=>{if(s.includes(e.userId))return void a--;if(e.displayName)l.push(e.displayName);else{var t=this.getMember(e.userId);l.push(t?t.name:e.userId)}});else{var c=this.currentState.getMembers().filter(t=>t.userId!==e&&(t.membership===L.O.Invite||t.membership===L.O.Join));c=c.filter(e=>{var{userId:t}=e;return!s.includes(t)||(a--,!1)});var d=new Intl.Collator;c.sort((e,t)=>d.compare(e.userId,t.userId)),l=(c=c.slice(0,5)).map(e=>e.name)}if(a)return this.roomNameGenerator({type:J.Generated,names:l,count:a});if(this.getMyMembership()==L.O.Join){var u=this.currentState.getStateEvents(g.Bx.RoomThirdPartyInvite);if(null!=u&&u.length){var h=u.map(e=>e.getContent().display_name);return this.roomNameGenerator({type:J.Generated,subtype:"Inviting",names:h,count:h.length+1})}}var v=l;return v.length||(v=this.currentState.getMembers().filter(t=>t.userId!==e&&t.membership!==L.O.Invite&&t.membership!==L.O.Join).map(e=>e.name)),v.length&&(t=this.roomNameGenerator({type:J.Generated,names:v,count:v.length+1})),this.roomNameGenerator({type:J.EmptyRoom,oldName:t})}applyNewVisibilityEvent(e){var t=e.asVisibilityChange();if(t){var r=e.getSender();if(r&&(g.Yg.name&&this.currentState.maySendStateEvent(g.Yg.name,r)||g.Yg.altName&&this.currentState.maySendStateEvent(g.Yg.altName,r))){var n=this.visibilityEvents.get(t.eventId);if(n){for(var i=n.length-1,o=Math.max(0,n.length-30);i>=o&&!(n[i].getTs()<e.getTs());--i);-1===i?n.unshift(e):n.splice(i+1,0,e)}else this.visibilityEvents.set(t.eventId,[e]);var a=this.findEventById(t.eventId);a&&a.applyVisibilityEvent(t)}}}redactVisibilityChangeEvent(e){if(!e.isVisibilityEvent)throw Error("expected a visibility change event");var t=e.getRelation(),r=null==t?void 0:t.event_id,n=this.visibilityEvents.get(r);if(n){var i=n.findIndex(t=>t.getId()===e.getId());if(-1!==i&&(n.splice(i,1),i===n.length)){var o=this.findEventById(r);if(!o)return;if(0===i)this.visibilityEvents.delete(r),o.applyVisibilityEvent();else{var a=n[n.length-1].asVisibilityChange();if(!a)throw Error("at this stage, visibility changes should be well-formed");o.applyVisibilityEvent(a)}}}}applyPendingVisibilityEvents(e){var t=this.visibilityEvents.get(e.getId());if(t&&0!=t.length){var r=t[t.length-1],n=r.asVisibilityChange();n&&(n.visible,r.getTs()<e.getTs()||e.applyVisibilityEvent(n))}}getOldestThreadedReceiptTs(){return this.oldestThreadedReceiptTs}hasUserReadEvent(e,t){return this.roomReceipts.hasUserReadEvent(e,t)}getLastUnthreadedReceiptFor(e){return this.unthreadedReceipts.get(e)}fixupNotifications(e){for(var t of(super.fixupNotifications(e),this.getThreads().filter(e=>this.getThreadUnreadNotificationCount(e.id,q.Total)>0)))t.fixupNotifications(e)}compareEventOrdering(e,t){return function(e,t,r){var n,i,o,a,s,l,c,d,u,h,v,p,m,g,y=e.findEventById(t),b=e.findEventById(r);if(!y||!b)return null;var S=(0,f.fN)(y),E=(0,f.fN)(b);return S&&E?(n=e,i=t,o=r,a=y,s=b,null!==(c=(l=n.getUnfilteredTimelineSet()).compareEventOrdering(i,o))?c:l.getTimelineForEvent(i)===l.getLiveTimeline()?1:l.getTimelineForEvent(o)===l.getLiveTimeline()?-1:F(a,s)):(d=t,u=r,h=y,v=b,p=(0,f.Xb)(h),m=(0,f.Xb)(v),(g=h.getThread())&&p===m?g.timelineSet.compareEventOrdering(d,u):F(h,v))}(this,e,t)}hasEncryptionStateEvent(){var e;return!!(null==(e=this.getLiveTimeline().getState(s.q.FORWARDS))?void 0:e.getStateEvents(g.Bx.RoomEncryption,""))}}var G={[u.f.ENCRYPTING]:[u.f.SENDING,u.f.NOT_SENT,u.f.CANCELLED],[u.f.SENDING]:[u.f.ENCRYPTING,u.f.QUEUED,u.f.NOT_SENT,u.f.SENT],[u.f.QUEUED]:[u.f.SENDING,u.f.NOT_SENT,u.f.CANCELLED],[u.f.SENT]:[],[u.f.NOT_SENT]:[u.f.SENDING,u.f.QUEUED,u.f.CANCELLED],[u.f.CANCELLED]:[]},J=function(e){return e[e.EmptyRoom=0]="EmptyRoom",e[e.Generated=1]="Generated",e[e.Actual=2]="Actual",e}({});function z(e,t){var r=t-1;return e.length?1===e.length&&r<=1?e[0]:2===e.length&&r<=2?"".concat(e[0]," and ").concat(e[1]):r>1?"".concat(e[0]," and ").concat(r," others"):"".concat(e[0]," and 1 other"):"Empty room"}},61554:(e,t,r)=>{"use strict";r.d(t,{L:()=>c,d:()=>l});var n=r(29301),i=r(84458),o=r(15095),a=r(90426),s=r(5408),l=function(e){return e.LocalStreamsChanged="local_streams_changed",e}({});class c extends o.X{constructor(e){super(),this.client=e,(0,i.A)(this,"audioInput",void 0),(0,i.A)(this,"audioSettings",void 0),(0,i.A)(this,"videoInput",void 0),(0,i.A)(this,"localUserMediaStream",void 0),(0,i.A)(this,"userMediaStreams",[]),(0,i.A)(this,"screensharingStreams",[]),(0,i.A)(this,"getMediaStreamPromise",void 0)}restoreMediaSettings(e,t){this.audioInput=e,this.videoInput=t}setAudioInput(e){var t=this;return(0,n.A)(function*(){s.vF.info("MediaHandler setAudioInput() running (deviceId=".concat(e,")")),t.audioInput!==e&&(t.audioInput=e,yield t.updateLocalUsermediaStreams())})()}setAudioSettings(e){var t=this;return(0,n.A)(function*(){s.vF.info("MediaHandler setAudioSettings() running (opts=".concat(JSON.stringify(e),")")),t.audioSettings=Object.assign({},e),yield t.updateLocalUsermediaStreams()})()}setVideoInput(e){var t=this;return(0,n.A)(function*(){s.vF.info("MediaHandler setVideoInput() running (deviceId=".concat(e,")")),t.videoInput!==e&&(t.videoInput=e,yield t.updateLocalUsermediaStreams())})()}setMediaInputs(e,t){var r=this;return(0,n.A)(function*(){s.vF.log("MediaHandler setMediaInputs() running (audioInput: ".concat(e," videoInput: ").concat(t,")")),r.audioInput=e,r.videoInput=t,yield r.updateLocalUsermediaStreams()})()}updateLocalUsermediaStreams(){var e=this;return(0,n.A)(function*(){if(0!==e.userMediaStreams.length){var t=new Map;for(var r of e.client.callEventHandler.calls.values())t.set(r.callId,{audio:r.hasLocalUserMediaAudioTrack,video:r.hasLocalUserMediaVideoTrack});for(var n of e.userMediaStreams)for(var i of(s.vF.log("MediaHandler updateLocalUsermediaStreams() stopping all tracks (streamId=".concat(n.id,")")),n.getTracks()))i.stop();for(var o of(e.userMediaStreams=[],e.localUserMediaStream=void 0,e.client.callEventHandler.calls.values()))if(!o.callHasEnded()&&t.has(o.callId)){var{audio:c,video:d}=t.get(o.callId);s.vF.log("MediaHandler updateLocalUsermediaStreams() calling getUserMediaStream() (callId=".concat(o.callId,")"));var u=yield e.getUserMediaStream(c,d);o.callHasEnded()||(yield o.updateLocalUsermediaStream(u))}for(var h of e.client.groupCallEventHandler.groupCalls.values())if(h.localCallFeed){s.vF.log("MediaHandler updateLocalUsermediaStreams() calling getUserMediaStream() (groupCallId=".concat(h.groupCallId,")"));var v=yield e.getUserMediaStream(!0,h.type===a.Ad.Video);h.state!==a.F_.Ended&&(yield h.updateLocalUsermediaStream(v))}e.emit(l.LocalStreamsChanged)}})()}hasAudioDevice(){return(0,n.A)(function*(){try{return(yield navigator.mediaDevices.enumerateDevices()).filter(e=>"audioinput"===e.kind).length>0}catch(e){return s.vF.log("MediaHandler hasAudioDevice() calling navigator.mediaDevices.enumerateDevices with error",e),!1}})()}hasVideoDevice(){return(0,n.A)(function*(){try{return(yield navigator.mediaDevices.enumerateDevices()).filter(e=>"videoinput"===e.kind).length>0}catch(e){return s.vF.log("MediaHandler hasVideoDevice() calling navigator.mediaDevices.enumerateDevices with error",e),!1}})()}getUserMediaStream(e,t){var r=arguments,i=this;return(0,n.A)(function*(){var n=!(r.length>2)||void 0===r[2]||r[2];return i.getMediaStreamPromise?i.getMediaStreamPromise=i.getMediaStreamPromise.then(()=>i.getUserMediaStreamInternal(e,t,n)):i.getMediaStreamPromise=i.getUserMediaStreamInternal(e,t,n),i.getMediaStreamPromise})()}getUserMediaStreamInternal(e,t,r){var i=this;return(0,n.A)(function*(){var n,o,a,c,d,u=e&&(yield i.hasAudioDevice()),h=t&&(yield i.hasVideoDevice()),v=!0;if(i.localUserMediaStream?(u!==i.localUserMediaStream.getAudioTracks().length>0&&(v=!1),h!==i.localUserMediaStream.getVideoTracks().length>0&&(v=!1),u&&(null==(o=i.localUserMediaStream.getAudioTracks()[0])||null==(o=o.getSettings())?void 0:o.deviceId)!==i.audioInput&&(v=!1),h&&(null==(a=i.localUserMediaStream.getVideoTracks()[0])||null==(a=a.getSettings())?void 0:a.deviceId)!==i.videoInput&&(v=!1)):v=!1,v){if(n=i.localUserMediaStream.clone(),s.vF.log("MediaHandler getUserMediaStreamInternal() cloning (oldStreamId=".concat(null==(d=i.localUserMediaStream)?void 0:d.id," newStreamId=").concat(n.id," shouldRequestAudio=").concat(u," shouldRequestVideo=").concat(h,")")),!u)for(var p of n.getAudioTracks())n.removeTrack(p);if(!h)for(var m of n.getVideoTracks())n.removeTrack(m)}else{try{c=i.getUserMediaContraints(u,h,!0),n=yield navigator.mediaDevices.getUserMedia(c)}catch(e){s.vF.warn("MediaHandler getUserMediaStreamInternal() error (e=".concat(e,"), retrying without exact deviceId")),c=i.getUserMediaContraints(u,h,!1),n=yield navigator.mediaDevices.getUserMedia(c)}for(var g of(s.vF.log("MediaHandler getUserMediaStreamInternal() calling getUserMediaStream (streamId=".concat(n.id,", shouldRequestAudio=").concat(u,", shouldRequestVideo=").concat(h,", constraints=").concat(JSON.stringify(c),")")),n.getTracks())){var f=g.getSettings();"audio"===g.kind?i.audioInput=f.deviceId:"video"===g.kind&&(i.videoInput=f.deviceId)}r&&(i.localUserMediaStream=n)}return r&&i.userMediaStreams.push(n),i.emit(l.LocalStreamsChanged),n})()}stopUserMediaStream(e){for(var t of(s.vF.log("MediaHandler stopUserMediaStream() stopping (streamId=".concat(e.id,")")),e.getTracks()))t.stop();var r,n=this.userMediaStreams.indexOf(e);if(-1!==n&&(s.vF.debug("MediaHandler stopUserMediaStream() splicing usermedia stream out stream array (streamId=".concat(e.id,")"),e.id),this.userMediaStreams.splice(n,1)),this.emit(l.LocalStreamsChanged),this.localUserMediaStream===e)this.localUserMediaStream=void 0;else for(var i of e.getTracks())if(null!=(r=this.localUserMediaStream)&&r.getTrackById(i.id)){this.stopUserMediaStream(this.localUserMediaStream);break}}getScreensharingStream(){var e=arguments,t=this;return(0,n.A)(function*(){var r,n=e.length>0&&void 0!==e[0]?e[0]:{},i=!(e.length>1)||void 0===e[1]||e[1];if(0===t.screensharingStreams.length){var o=t.getScreenshareContraints(n);n.desktopCapturerSourceId?(s.vF.debug("MediaHandler getScreensharingStream() calling getUserMedia() (opts=".concat(JSON.stringify(n),")")),r=yield navigator.mediaDevices.getUserMedia(o)):(s.vF.debug("MediaHandler getScreensharingStream() calling getDisplayMedia() (opts=".concat(JSON.stringify(n),")")),r=yield navigator.mediaDevices.getDisplayMedia(o))}else{var a=t.screensharingStreams[t.screensharingStreams.length-1];s.vF.log("MediaHandler getScreensharingStream() cloning (streamId=".concat(a.id,")")),r=a.clone()}return i&&t.screensharingStreams.push(r),t.emit(l.LocalStreamsChanged),r})()}stopScreensharingStream(e){for(var t of(s.vF.debug("MediaHandler stopScreensharingStream() stopping stream (streamId=".concat(e.id,")")),e.getTracks()))t.stop();var r=this.screensharingStreams.indexOf(e);-1!==r&&(s.vF.debug("MediaHandler stopScreensharingStream() splicing stream out (streamId=".concat(e.id,")")),this.screensharingStreams.splice(r,1)),this.emit(l.LocalStreamsChanged)}stopAllStreams(){for(var e of this.userMediaStreams)for(var t of(s.vF.log("MediaHandler stopAllStreams() stopping (streamId=".concat(e.id,")")),e.getTracks()))t.stop();for(var r of this.screensharingStreams)for(var n of r.getTracks())n.stop();this.userMediaStreams=[],this.screensharingStreams=[],this.localUserMediaStream=void 0,this.emit(l.LocalStreamsChanged)}getUserMediaContraints(e,t,r){var n=!!navigator.webkitGetUserMedia,i=r?"exact":"ideal",o={};this.audioInput&&(o.deviceId={[i]:this.audioInput}),this.audioSettings&&(o.autoGainControl={ideal:this.audioSettings.autoGainControl},o.echoCancellation={ideal:this.audioSettings.echoCancellation},o.noiseSuppression={ideal:this.audioSettings.noiseSuppression});var a={width:n?{exact:640}:{ideal:640},height:n?{exact:360}:{ideal:360}};return this.videoInput&&(a.deviceId={[i]:this.videoInput}),{audio:!!e&&o,video:!!t&&a}}getScreenshareContraints(e){var{desktopCapturerSourceId:t,audio:r}=e;return t?{audio:null!=r&&r,video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t}}}:{audio:null!=r&&r,video:!0}}}},61904:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WidgetApiToWidgetAction=t.WidgetApiFromWidgetAction=void 0,t.WidgetApiToWidgetAction=function(e){return e.SupportedApiVersions="supported_api_versions",e.Capabilities="capabilities",e.NotifyCapabilities="notify_capabilities",e.ThemeChange="theme_change",e.LanguageChange="language_change",e.TakeScreenshot="screenshot",e.UpdateVisibility="visibility",e.OpenIDCredentials="openid_credentials",e.WidgetConfig="widget_config",e.CloseModalWidget="close_modal",e.ButtonClicked="button_clicked",e.SendEvent="send_event",e.SendToDevice="send_to_device",e.UpdateState="update_state",e.UpdateTurnServers="update_turn_servers",e}({}),t.WidgetApiFromWidgetAction=function(e){return e.SupportedApiVersions="supported_api_versions",e.ContentLoaded="content_loaded",e.SendSticker="m.sticker",e.UpdateAlwaysOnScreen="set_always_on_screen",e.GetOpenIDCredentials="get_openid",e.CloseModalWidget="close_modal",e.OpenModalWidget="open_modal",e.SetModalButtonEnabled="set_button_enabled",e.SendEvent="send_event",e.SendToDevice="send_to_device",e.WatchTurnServers="watch_turn_servers",e.UnwatchTurnServers="unwatch_turn_servers",e.BeeperReadRoomAccountData="com.beeper.read_room_account_data",e.MSC2876ReadEvents="org.matrix.msc2876.read_events",e.MSC2931Navigate="org.matrix.msc2931.navigate",e.MSC2974RenegotiateCapabilities="org.matrix.msc2974.request_capabilities",e.MSC3869ReadRelations="org.matrix.msc3869.read_relations",e.MSC3973UserDirectorySearch="org.matrix.msc3973.user_directory_search",e.MSC4039GetMediaConfigAction="org.matrix.msc4039.get_media_config",e.MSC4039UploadFileAction="org.matrix.msc4039.upload_file",e.MSC4039DownloadFileAction="org.matrix.msc4039.download_file",e.MSC4157UpdateDelayedEvent="org.matrix.msc4157.update_delayed_event",e}({})},62404:(e,t,r)=>{"use strict";function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.MessageEvent=void 0;var i=r(78272),o=r(17242),a=r(66866),s=r(47406),l=r(52337);function c(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function d(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?c(Object(r),!0).forEach(function(t){m(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):c(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function u(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function h(e,t){return(h=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function v(e){if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function p(e){return(p=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function m(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}t.MessageEvent=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");g.prototype=Object.create(e&&e.prototype,{constructor:{value:g,writable:!0,configurable:!0}}),Object.defineProperty(g,"prototype",{writable:!1}),e&&h(g,e);var t,r,i,c=(t=function(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}(),function(){var e,r=p(g);return e=t?Reflect.construct(r,arguments,p(this).constructor):r.apply(this,arguments),function(e,t){if(t&&("object"===n(t)||"function"==typeof t))return t;if(void 0!==t)throw TypeError("Derived constructors may only return object or undefined");return v(e)}(this,e)});function g(e){if(!(this instanceof g))throw TypeError("Cannot call a class as a function");m(v(t=c.call(this,e)),"text",void 0),m(v(t),"html",void 0),m(v(t),"renderings",void 0);var t,r=s.M_MESSAGE.findIn(t.wireContent),n=s.M_TEXT.findIn(t.wireContent),i=s.M_HTML.findIn(t.wireContent);if((0,o.isProvided)(r)){if(!Array.isArray(r))throw new a.InvalidEventError("m.message contents must be an array");var l=r.find(function(e){return!(0,o.isProvided)(e.mimetype)||"text/plain"===e.mimetype}),d=r.find(function(e){return"text/html"===e.mimetype});if(!l)throw new a.InvalidEventError("m.message is missing a plain text representation");t.text=l.body,t.html=null==d?void 0:d.body,t.renderings=r}else if((0,o.isOptionalAString)(n))t.text=n,t.html=i,t.renderings=[{body:n,mimetype:"text/plain"}],t.html&&t.renderings.push({body:t.html,mimetype:"text/html"});else throw new a.InvalidEventError("Missing textual representation for event");return t}return r=[{key:"isEmote",get:function(){return s.M_EMOTE.matches(this.wireFormat.type)||(0,o.isProvided)(s.M_EMOTE.findIn(this.wireFormat.content))}},{key:"isNotice",get:function(){return s.M_NOTICE.matches(this.wireFormat.type)||(0,o.isProvided)(s.M_NOTICE.findIn(this.wireFormat.content))}},{key:"isEquivalentTo",value:function(e){return(0,l.isEventTypeSame)(e,s.M_MESSAGE)}},{key:"serializeMMessageOnly",value:function(){var e=m({},s.M_MESSAGE.name,this.renderings);if(1===this.renderings.length){var t=this.renderings[0].mimetype;(void 0===t||"text/plain"===t)&&(e=m({},s.M_TEXT.name,this.renderings[0].body))}return e}},{key:"serialize",value:function(){var e;return{type:"m.room.message",content:d(d({},this.serializeMMessageOnly()),{},{body:this.text,msgtype:"m.text",format:this.html?"org.matrix.custom.html":void 0,formatted_body:null!=(e=this.html)?e:void 0})}}}],i=[{key:"from",value:function(e,t){var r;return new g({type:s.M_MESSAGE.name,content:(m(r={},s.M_TEXT.name,e),m(r,s.M_HTML.name,t),r)})}}],r&&u(g.prototype,r),i&&u(g,i),Object.defineProperty(g,"prototype",{writable:!1}),g}(i.ExtensibleEvent)},63959:(e,t,r)=>{"use strict";r.d(t,{_:()=>d});var n=r(29301),i=r(84458),o=r(11749),a=r(69549);function s(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function l(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?s(Object(r),!0).forEach(function(t){(0,i.A)(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):s(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function c(e,t){return encodeURIComponent(e)+"/"+encodeURIComponent(t)}class d{constructor(){(0,i.A)(this,"migrationState",a.Il.NOT_STARTED),(0,i.A)(this,"account",null),(0,i.A)(this,"crossSigningKeys",null),(0,i.A)(this,"privateKeys",{}),(0,i.A)(this,"sessions",{}),(0,i.A)(this,"inboundGroupSessions",{}),(0,i.A)(this,"inboundGroupSessionsWithheld",{}),(0,i.A)(this,"rooms",{}),(0,i.A)(this,"sessionsNeedingBackup",{})}containsData(){var e=this;return(0,n.A)(function*(){return null!==e.account})()}startup(){var e=this;return(0,n.A)(function*(){return e})()}deleteAllData(){return Promise.resolve()}getMigrationState(){var e=this;return(0,n.A)(function*(){return e.migrationState})()}setMigrationState(e){var t=this;return(0,n.A)(function*(){t.migrationState=e})()}getAccount(e,t){t(this.account)}storeAccount(e,t){this.account=t}getCrossSigningKeys(e,t){t(this.crossSigningKeys)}getSecretStorePrivateKey(e,t,r){t(this.privateKeys[r]||null)}storeSecretStorePrivateKey(e,t,r){this.privateKeys[t]=r}countEndToEndSessions(e,t){var r=0;for(var n of Object.values(this.sessions))r+=Object.keys(n).length;t(r)}getEndToEndSession(e,t,r,n){n((this.sessions[e]||{})[t]||null)}getEndToEndSessions(e,t,r){r(this.sessions[e]||{})}storeEndToEndSession(e,t,r,n){var i=this.sessions[e];void 0===i&&(i={},this.sessions[e]=i),(0,o.C6)(i,t,r)}getEndToEndSessionsBatch(){var e=this;return(0,n.A)(function*(){var t=[];for(var r of Object.values(e.sessions))for(var n of Object.values(r))if(t.push(n),t.length>=a.oT)return t;return 0===t.length?null:t})()}deleteEndToEndSessionsBatch(e){var t=this;return(0,n.A)(function*(){for(var{deviceKey:r,sessionId:n}of e){var i=t.sessions[r]||{};delete i[n],0===Object.keys(i).length&&delete t.sessions[r]}})()}getEndToEndInboundGroupSession(e,t,r,n){var i=c(e,t);n(this.inboundGroupSessions[i]||null,this.inboundGroupSessionsWithheld[i]||null)}storeEndToEndInboundGroupSession(e,t,r,n){var i=c(e,t);this.inboundGroupSessions[i]=r}countEndToEndInboundGroupSessions(){var e=this;return(0,n.A)(function*(){return Object.keys(e.inboundGroupSessions).length})()}getEndToEndInboundGroupSessionsBatch(){var e=this;return(0,n.A)(function*(){var t=[];for(var[r,n]of Object.entries(e.inboundGroupSessions))if(t.push(l(l({},function(e){var t=e.split("/");return{senderKey:decodeURIComponent(t[0]),sessionId:decodeURIComponent(t[1])}}(r)),{},{sessionData:n,needsBackup:r in e.sessionsNeedingBackup})),t.length>=a.oT)return t;return 0===t.length?null:t})()}deleteEndToEndInboundGroupSessionsBatch(e){var t=this;return(0,n.A)(function*(){for(var{senderKey:r,sessionId:n}of e){var i=c(r,n);delete t.inboundGroupSessions[i]}})()}getEndToEndRooms(e,t){t(this.rooms)}markSessionsNeedingBackup(e){for(var t of e){var r=c(t.senderKey,t.sessionId);this.sessionsNeedingBackup[r]=!0}return Promise.resolve()}doTxn(e,t,r){return Promise.resolve(r(null))}}},64240:(e,t,r)=>{"use strict";r.d(t,{AUM:()=>p.AU,UU6:()=>e2});var n,i={};r.r(i),r.d(i,{AuthType:()=>ei,AutoDiscovery:()=>D.MN,AutoDiscoveryAction:()=>D.iz,AutoDiscoveryError:()=>D.gc,Beacon:()=>W.HF,BeaconEvent:()=>W.JH,CallEvent:()=>eq.$E,CallFeedEvent:()=>eJ.BL,Category:()=>L,ClientEvent:()=>p.AU,ClientPrefix:()=>P.iD,ClientStoppedError:()=>j.LA,ConditionKind:()=>ew.wp,ConditionOperator:()=>ew.CD,ConnectionError:()=>P.Rc,ContentHelpers:()=>eW,DELEGATED_OIDC_COMPATIBILITY:()=>eM,DEVICE_CODE_SCOPE:()=>$.AO,DMMemberCountCondition:()=>ew.IJ,DebugLogger:()=>b.k$,Device:()=>Y.p,DeviceVerification:()=>Y.u,Direction:()=>q.O,DuplicateStrategy:()=>V.x,EVENT_VISIBILITY_CHANGE_TYPE:()=>y.Yg,EventEmitterEvents:()=>z.u,EventStatus:()=>g.fb,EventTimeline:()=>q.q,EventTimelineSet:()=>V.m,EventType:()=>y.Bx,FILTER_RELATED_BY_REL_TYPES:()=>J.H,FILTER_RELATED_BY_SENDERS:()=>J.o1,FeatureSupport:()=>J.c1,Filter:()=>Q.d,GET_LOGIN_TOKEN_CAPABILITY:()=>p.hx,GroupCall:()=>eV.eO,GroupCallEvent:()=>eV.AZ,GroupCallIntent:()=>eV.MC,GroupCallState:()=>eV.F_,GroupCallStatsReportEvent:()=>eV.xt,GroupCallType:()=>eV.Ad,GuestAccess:()=>eT.rF,HTTPError:()=>P.Hl,HistoryVisibility:()=>eT.Jv,HttpApiEvent:()=>P.XD,IdentityPrefix:()=>P.Pw,IdentityProviderBrand:()=>eP,IndexedDBCryptoStore:()=>eE.y,IndexedDBStore:()=>ey,InteractiveAuth:()=>ea,InvalidCryptoStoreError:()=>j.E5,InvalidCryptoStoreState:()=>j.hP,JoinRule:()=>eT.dx,KNOWN_SAFE_ROOM_VERSION:()=>K.vx,KeySignatureUploadError:()=>j.b0,KnownMembership:()=>d.O,LOCAL_NOTIFICATION_SETTINGS_PREFIX:()=>y.Xs,LocalStorageCryptoStore:()=>eS.F,LocalStorageErrors:()=>eX,LocationAssetType:()=>eC.Yg,MAIN_ROOM_TIMELINE:()=>eF.S,MAXIMUM_MATRIX_VERSION:()=>es.Uv,MAX_STICKY_DURATION_MS:()=>g.P0,MINIMUM_MATRIX_VERSION:()=>es.eD,MSC3912_RELATION_BASED_REDACTIONS_PROP:()=>y.Z3,MXID_PATTERN:()=>G.sh,M_ASSET:()=>eC.J1,M_BEACON:()=>eA.z,M_BEACON_INFO:()=>eA.E,M_HTML:()=>eL.Et,M_LOCATION:()=>eC.M6,M_MESSAGE:()=>eL.K0,M_POLL_END:()=>ex.cI,M_POLL_KIND_DISCLOSED:()=>ex.ms,M_POLL_KIND_UNDISCLOSED:()=>ex.li,M_POLL_RESPONSE:()=>ex.qN,M_POLL_START:()=>ex.$S,M_TEXT:()=>eL.yB,M_TIMESTAMP:()=>eC.vo,M_TOPIC:()=>eR.s,MatrixClient:()=>p.pB,MatrixError:()=>P.up,MatrixEvent:()=>g.kl,MatrixEventEvent:()=>g.OQ,MatrixHttpApi:()=>P.ED,MatrixSafetyError:()=>P.a_,MatrixSafetyErrorCode:()=>P.Vc,MatrixScheduler:()=>v.b,MediaHandlerEvent:()=>eG.d,MediaPrefix:()=>P.zs,MemoryCryptoStore:()=>o._,MemoryStore:()=>h,Method:()=>P.IT,MsgType:()=>y.Wr,NoAuthFlowFoundError:()=>eo,NotificationCountType:()=>K.X5,OAUTH_AWARE_PREFERRED_FLOW_FIELD:()=>eO,OAuthGrantType:()=>$.gu,OidcError:()=>$.uv,OidcTokenRefresher:()=>$.db,PUSHER_DEVICE_ID:()=>y.VT,PUSHER_ENABLED:()=>y.cr,PendingEventOrdering:()=>p.eO,Poll:()=>H.sP,PollEvent:()=>H.sn,Preset:()=>eT.k,ProfileKeyMSC4175Timezone:()=>ej,ProfileKeyTimezone:()=>eN,PushRuleActionName:()=>ew.YU,PushRuleKind:()=>ew.Ji,REFERENCE_RELATION:()=>eL.BJ,ReceiptType:()=>eF.L,RelatedRelations:()=>eB,RelationType:()=>y.zZ,Relations:()=>eY.s,RelationsEvent:()=>eY.S,RestrictedAllowType:()=>eT.D7,Room:()=>K.Wv,RoomCreateTypeField:()=>y.Ct,RoomEvent:()=>K.u9,RoomMember:()=>G.Yx,RoomMemberEvent:()=>G.o5,RoomNameType:()=>K.bx,RoomState:()=>l.H,RoomStateEvent:()=>l.f,RoomSummary:()=>eU.c,RoomType:()=>y.CJ,RoomVersionStability:()=>M.L,RoomWidgetClient:()=>C,RoomWidgetClientEvent:()=>R,RuleId:()=>ew.kq,SERVICE_TYPES:()=>el.S,SSOAction:()=>eD,STABLE_MSC4133_EXTENDED_PROFILES:()=>p.it,SUPPORTED_MATRIX_VERSIONS:()=>es.Hr,SearchOrderBy:()=>eI.g,SearchResult:()=>X.q,SecretStorage:()=>eK,ServerCapabilities:()=>M.K,SetPresence:()=>S.IU,SlidingSyncEvent:()=>eH.cQ,StatsReport:()=>ez.I,SyncAccumulator:()=>U,SyncState:()=>S.Lm,THREAD_RELATION_TYPE:()=>J.RN,Thread:()=>J.jV,ThreadEvent:()=>J.ju,ThreadFilterType:()=>J.x3,ThreepidMedium:()=>ek,TimelineIndex:()=>et,TimelineWindow:()=>ee,ToDeviceMessageId:()=>y.wt,TokenRefreshError:()=>P.FS,TokenRefreshLogoutError:()=>P.DW,TweakName:()=>ew.QN,TypedEventEmitter:()=>z.X,UNSIGNED_MEMBERSHIP_FIELD:()=>y.SY,UNSIGNED_THREAD_ID_FIELD:()=>y.Sr,UNSTABLE_ELEMENT_FUNCTIONAL_USERS:()=>y.Ng,UNSTABLE_MSC2666_MUTUAL_ROOMS:()=>p.NB,UNSTABLE_MSC2666_QUERY_MUTUAL_ROOMS:()=>p.A0,UNSTABLE_MSC2666_SHARED_ROOMS:()=>p.uD,UNSTABLE_MSC2716_MARKER:()=>y.ge,UNSTABLE_MSC3088_ENABLED:()=>y.ud,UNSTABLE_MSC3088_PURPOSE:()=>y.D7,UNSTABLE_MSC3089_BRANCH:()=>y.iK,UNSTABLE_MSC3089_LEAF:()=>y.ID,UNSTABLE_MSC3089_TREE_SUBTYPE:()=>y.nN,UNSTABLE_MSC3852_LAST_SEEN_UA:()=>p.HF,UNSTABLE_MSC4133_EXTENDED_PROFILES:()=>p.jB,UNSTABLE_MSC4140_DELAYED_EVENTS:()=>p.rG,UNSTABLE_MSC4354_STICKY_EVENTS:()=>p.JM,UnsupportedDelayedEventsEndpointError:()=>j.qK,UnsupportedStickyEventsEndpointError:()=>j.xp,UpdateDelayedEventAction:()=>f.e,User:()=>w.K,UserEvent:()=>w.U,Visibility:()=>eT.bv,anySignal:()=>P.JG,calculateRetryBackoff:()=>P.fZ,completeAuthorizationCodeGrant:()=>$.SU,createClient:()=>e2,createNewMatrixCall:()=>eq.sv,createRoomWidgetClient:()=>e4,decodeBase64:()=>B.y4,decodeIdToken:()=>$.Rh,determineFeatureSupport:()=>J.FD,discoverAndValidateOIDCIssuerWellKnown:()=>$.k8,encodeBase64:()=>B.WG,encodeUnpaddedBase64:()=>B.PP,encodeUnpaddedBase64Url:()=>B.A4,fixNotificationCountOnDecryption:()=>p.mD,generateAuthorizationParams:()=>$.P3,generateAuthorizationUrl:()=>$.cJ,generateOidcAuthorizationUrl:()=>$.R2,generateScope:()=>$.oE,getBeaconInfoIdentifier:()=>W.M9,getHttpUriForMxc:()=>e_.y,inMainTimelineForReceipt:()=>p.fN,isDmMemberCountCondition:()=>ew.WM,isEventTypeSame:()=>eL.NY,isPollEvent:()=>H.Wi,isSendDelayedEventRequestOpts:()=>f.U,isTimestampInDuration:()=>W.ai,localStorageErrorsEventsEmitter:()=>eQ,parseErrorResponse:()=>P.xy,registerOidcClient:()=>$.aT,retryNetworkOperation:()=>P.Y6,safeGetRetryAfterMs:()=>P.eM,setCryptoStoreFactory:()=>e0,threadFilterTypeToFilter:()=>J.UR,threadIdForReceipt:()=>p.Xb,timeoutSignal:()=>P._,validateAuthMetadata:()=>$.EZ,validateAuthMetadataAndKeys:()=>$.Pl,validateBearerTokenResponse:()=>$.eC,validateIdToken:()=>$.rm,validateStoredUserState:()=>$.K8});var o=r(63959),a=r(29301),s=r(84458),l=r(29927),c=r(11749),d=r(5294);function u(e){return"string"==typeof e&&!!e&&"undefined"!==e&&"null"!==e||"number"==typeof e}class h{constructor(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};(0,s.A)(this,"rooms",{}),(0,s.A)(this,"users",{}),(0,s.A)(this,"syncToken",null),(0,s.A)(this,"filters",new c.kG(()=>new Map)),(0,s.A)(this,"accountData",new Map),(0,s.A)(this,"localStorage",void 0),(0,s.A)(this,"oobMembers",new Map),(0,s.A)(this,"pendingEvents",{}),(0,s.A)(this,"clientOptions",void 0),(0,s.A)(this,"pendingToDeviceBatches",[]),(0,s.A)(this,"nextToDeviceBatchId",0),(0,s.A)(this,"createUser",void 0),(0,s.A)(this,"onRoomMember",(e,t,r)=>{if(r.membership!==d.O.Invite){var n,i=this.users[r.userId]||(null==(n=this.createUser)?void 0:n.call(this,r.userId));r.name&&(i.setDisplayName(r.name),r.events.member&&i.setRawDisplayName(r.events.member.getDirectionalContent().displayname)),r.events.member&&r.events.member.getContent().avatar_url&&i.setAvatarUrl(r.events.member.getContent().avatar_url),this.users[i.userId]=i}}),this.localStorage=e.localStorage}getSyncToken(){return this.syncToken}isNewlyCreated(){return Promise.resolve(!0)}setSyncToken(e){this.syncToken=e}storeRoom(e){this.rooms[e.roomId]=e,e.currentState.on(l.f.Members,this.onRoomMember),e.currentState.getMembers().forEach(t=>{this.onRoomMember(null,e.currentState,t)})}setUserCreator(e){this.createUser=e}getRoom(e){return this.rooms[e]||null}getRooms(){return Object.values(this.rooms)}removeRoom(e){this.rooms[e]&&this.rooms[e].currentState.removeListener(l.f.Members,this.onRoomMember),delete this.rooms[e]}getRoomSummaries(){return Object.values(this.rooms).map(function(e){return e.summary})}storeUser(e){this.users[e.userId]=e}getUser(e){return this.users[e]||null}getUsers(){return Object.values(this.users)}scrollback(e,t){return[]}storeEvents(e,t,r,n){}storeFilter(e){null!=e&&e.userId&&null!=e&&e.filterId&&this.filters.getOrCreate(e.userId).set(e.filterId,e)}getFilter(e,t){var r;return(null==(r=this.filters.get(e))?void 0:r.get(t))||null}getFilterIdByName(e){if(!this.localStorage)return null;try{var t=this.localStorage.getItem("mxjssdk_memory_filter_"+e);if(u(t))return t}catch(e){}return null}setFilterIdByName(e,t){if(this.localStorage){var r="mxjssdk_memory_filter_"+e;try{u(t)?this.localStorage.setItem(r,t):this.localStorage.removeItem(r)}catch(e){}}}storeAccountDataEvents(e){e.forEach(e=>{Object.keys(e.getContent()).length?this.accountData.set(e.getType(),e):this.accountData.delete(e.getType())})}getAccountData(e){return this.accountData.get(e)}setSyncData(e){return Promise.resolve()}wantsSave(){return!1}save(e){return Promise.resolve()}startup(){return Promise.resolve()}getSavedSync(){return Promise.resolve(null)}getSavedSyncToken(){return Promise.resolve(null)}deleteAllData(){return this.rooms={},this.users={},this.syncToken=null,this.filters=new c.kG(()=>new Map),this.accountData=new Map,Promise.resolve()}getOutOfBandMembers(e){return Promise.resolve(this.oobMembers.get(e)||null)}setOutOfBandMembers(e,t){return this.oobMembers.set(e,t),Promise.resolve()}clearOutOfBandMembers(e){return this.oobMembers.delete(e),Promise.resolve()}getClientOptions(){return Promise.resolve(this.clientOptions)}storeClientOptions(e){return this.clientOptions=Object.assign({},e),Promise.resolve()}getPendingEvents(e){var t=this;return(0,a.A)(function*(){var r;return null!=(r=t.pendingEvents[e])?r:[]})()}setPendingEvents(e,t){var r=this;return(0,a.A)(function*(){r.pendingEvents[e]=t})()}saveToDeviceBatches(e){for(var t of e)this.pendingToDeviceBatches.push({id:this.nextToDeviceBatchId++,eventType:t.eventType,txnId:t.txnId,batch:t.batch});return Promise.resolve()}getOldestToDeviceBatch(){var e=this;return(0,a.A)(function*(){return 0===e.pendingToDeviceBatches.length?null:e.pendingToDeviceBatches[0]})()}removeToDeviceBatch(e){return this.pendingToDeviceBatches=this.pendingToDeviceBatches.filter(t=>t.id!==e),Promise.resolve()}destroy(){return(0,a.A)(function*(){})()}}var v=r(389),p=r(49699),m=r(88767),g=r(82393),f=r(54120),y=r(9086),b=r(5408),S=r(64763),E=r(14699),_=r(71453),w=r(65920);function T(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function I(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?T(Object(r),!0).forEach(function(t){(0,s.A)(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):T(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function A(e){function t(e){if(Object(e)!==e)return Promise.reject(TypeError(e+" is not an object."));var t=e.done;return Promise.resolve(e.value).then(function(e){return{value:e,done:t}})}return(A=function(e){this.s=e,this.n=e.next}).prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(e){var r=this.s.return;return void 0===r?Promise.resolve({value:e,done:!0}):t(r.apply(this.s,arguments))},throw:function(e){var r=this.s.return;return void 0===r?Promise.reject(e):t(r.apply(this.s,arguments))}},new A(e)}var R=function(e){return e.PendingEventsChanged="PendingEvent.pendingEventsChanged",e}({});class C extends p.pB{constructor(e,t,r,n,i){super(n),o=this,this.widgetApi=e,this.capabilities=t,this.roomId=r,(0,s.A)(this,"room",void 0),(0,s.A)(this,"widgetApiReady",void 0),(0,s.A)(this,"roomStateSynced",void 0),(0,s.A)(this,"lifecycle",void 0),(0,s.A)(this,"syncState",null),(0,s.A)(this,"pendingSendingEventsTxId",[]),(0,s.A)(this,"eventEmitter",new z.X),(0,s.A)(this,"syncApiResolver",Promise.withResolvers()),(0,s.A)(this,"updateTxId",function(){var e=(0,a.A)(function*(e){if(e.getSender()===o.getUserId()&&o.pendingSendingEventsTxId.some(t=>e.getType()===t.type)){for(var t,r,n=null==(t=o.pendingSendingEventsTxId.find(t=>t.id===e.getId()))?void 0:t.txId;!n&&o.pendingSendingEventsTxId.length>0;)yield new Promise(e=>o.eventEmitter.once(R.PendingEventsChanged,()=>e())),n=null==(r=o.pendingSendingEventsTxId.find(t=>t.id===e.getId()))?void 0:r.txId;n&&(e.setTxnId(n),e.setUnsigned(I(I({},e.getUnsigned()),{},{transaction_id:n}))),o.pendingSendingEventsTxId=o.pendingSendingEventsTxId.filter(t=>t.id!==e.getId()),0===o.pendingSendingEventsTxId.length&&o.eventEmitter.emit(R.PendingEventsChanged)}});return function(t){return e.apply(this,arguments)}}()),(0,s.A)(this,"onEvent",function(){var e=(0,a.A)(function*(e){if(e.preventDefault(),e.detail.data.room_id===o.roomId){var t=new g.kl(e.detail.data);yield o.updateTxId(t),yield o.syncApiResolver.promise,o.syncApi instanceof S.w_?(yield o.supportUpdateState())?yield o.syncApi.injectRoomEvents(o.room,void 0,[],[t]):yield o.syncApi.injectRoomEvents(o.room,[],void 0,[t]):(yield o.supportUpdateState())?yield o.syncApi.injectRoomEvents(o.room,[],[t]):b.vF.error("slididng sync cannot be used in widget mode if the client widget driver does not support the version: 'org.matrix.msc2762_update_state'"),o.emit(p.AU.Event,t),void 0!==t.unstableStickyInfo&&o.room._unstable_addStickyEvents([t]),o.setSyncState(S.Lm.Syncing),b.vF.info("Received event ".concat(t.getId()," ").concat(t.getType()))}else{var{event_id:r,room_id:n}=e.detail.data;b.vF.info("Received event ".concat(r," for a different room ").concat(n,"; discarding"))}yield o.ack(e)});return function(t){return e.apply(this,arguments)}}()),(0,s.A)(this,"onToDevice",function(){var e=(0,a.A)(function*(e){e.preventDefault();var t=new g.kl({type:e.detail.data.type,sender:e.detail.data.sender,content:e.detail.data.content});e.detail.data.encrypted&&t.makeEncrypted(y.Bx.RoomMessageEncrypted,{},"",""),o.emit(p.AU.ToDeviceEvent,t),o.setSyncState(S.Lm.Syncing),yield o.ack(e)});return function(t){return e.apply(this,arguments)}}()),(0,s.A)(this,"onStateUpdate",function(){var e=(0,a.A)(function*(e){for(var t of(e.preventDefault(),(yield o.supportUpdateState())||b.vF.warn("received update_state widget action but the widget driver did not claim to support 'org.matrix.msc2762_update_state'"),yield o.syncApiResolver.promise,e.detail.data.state))if(t.room_id===o.roomId){var r=new g.kl(t);o.syncApi instanceof S.w_?yield o.syncApi.injectRoomEvents(o.room,void 0,[r]):yield o.syncApi.injectRoomEvents(o.room,[r]),b.vF.info("Updated state entry ".concat(r.getType()," ").concat(r.getStateKey()," to ").concat(r.getId()))}else{var{event_id:n,room_id:i}=e.detail.data;b.vF.info("Received state entry ".concat(n," for a different room ").concat(i,"; discarding"))}yield o.ack(e)});return function(t){return e.apply(this,arguments)}}());var o,l,c=this.widgetApi.transport.send.bind(this.widgetApi.transport);this.widgetApi.transport.send=function(){var e=(0,a.A)(function*(e,t){try{return yield c(e,t)}catch(e){k(e)}});return function(t,r){return e.apply(this,arguments)}}();var d=this.widgetApi.transport.sendComplete.bind(this.widgetApi.transport);this.widgetApi.transport.sendComplete=function(){var e=(0,a.A)(function*(e,t){try{return yield d(e,t)}catch(e){k(e)}});return function(t,r){return e.apply(this,arguments)}}(),this.widgetApiReady=new Promise(e=>this.widgetApi.once("ready",e)),this.roomStateSynced=null!=(l=t.receiveState)&&l.length?new Promise(e=>this.widgetApi.once("action:".concat(m.WidgetApiToWidgetAction.UpdateState),e)):Promise.resolve(),this.requestInitialCapabilities(t,r),e.on("action:".concat(m.WidgetApiToWidgetAction.SendEvent),this.onEvent),e.on("action:".concat(m.WidgetApiToWidgetAction.SendToDevice),this.onToDevice),e.on("action:".concat(m.WidgetApiToWidgetAction.UpdateState),this.onStateUpdate),e.start(),i&&e.sendContentLoaded()}requestInitialCapabilities(e,t){var r,n,i,o,a,s,l,c,d,u,h,v;(null!=(r=e.sendEvent)&&r.length||null!=(n=e.receiveEvent)&&n.length||!0===e.sendMessage||Array.isArray(e.sendMessage)&&e.sendMessage.length||!0===e.receiveMessage||Array.isArray(e.receiveMessage)&&e.receiveMessage.length||null!=(i=e.sendState)&&i.length||null!=(o=e.receiveState)&&o.length)&&this.widgetApi.requestCapabilityForRoomTimeline(t),null==(a=e.sendEvent)||a.forEach(e=>this.widgetApi.requestCapabilityToSendEvent(e)),null==(s=e.receiveEvent)||s.forEach(e=>this.widgetApi.requestCapabilityToReceiveEvent(e)),!0===e.sendMessage?this.widgetApi.requestCapabilityToSendMessage():Array.isArray(e.sendMessage)&&e.sendMessage.forEach(e=>this.widgetApi.requestCapabilityToSendMessage(e)),!0===e.receiveMessage?this.widgetApi.requestCapabilityToReceiveMessage():Array.isArray(e.receiveMessage)&&e.receiveMessage.forEach(e=>this.widgetApi.requestCapabilityToReceiveMessage(e)),null==(l=e.sendState)||l.forEach(e=>{var{eventType:t,stateKey:r}=e;return this.widgetApi.requestCapabilityToSendState(t,r)}),null==(c=e.receiveState)||c.forEach(e=>{var{eventType:t,stateKey:r}=e;return this.widgetApi.requestCapabilityToReceiveState(t,r)}),null==(d=e.sendToDevice)||d.forEach(e=>this.widgetApi.requestCapabilityToSendToDevice(e)),null==(u=e.receiveToDevice)||u.forEach(e=>this.widgetApi.requestCapabilityToReceiveToDevice(e)),e.sendDelayedEvents&&(null!=(h=e.sendEvent)&&h.length||!0===e.sendMessage||Array.isArray(e.sendMessage)&&e.sendMessage.length||null!=(v=e.sendState)&&v.length)&&this.widgetApi.requestCapability(m.MatrixCapabilities.MSC4157SendDelayedEvent),e.updateDelayedEvents&&this.widgetApi.requestCapability(m.MatrixCapabilities.MSC4157UpdateDelayedEvent),e.sendSticky&&this.widgetApi.requestCapability(m.MatrixCapabilities.MSC4407SendStickyEvent),e.receiveSticky&&this.widgetApi.requestCapability(m.MatrixCapabilities.MSC4407ReceiveStickyEvent),e.turnServers&&this.widgetApi.requestCapability(m.MatrixCapabilities.MSC3846TurnServers)}supportUpdateState(){var e=this;return(0,a.A)(function*(){return(yield e.widgetApi.getClientVersions()).includes(m.UnstableApiVersion.MSC2762_UPDATE_STATE)})()}startClient(){var e=arguments,t=this;return(0,a.A)(function*(){var r,n,i,o=e.length>0&&void 0!==e[0]?e[0]:{};t.lifecycle=new AbortController;var s=t.getUserId();(s&&t.store.storeUser(new w.K(s)),o.slidingSync?t.syncApi=new E.m(o.slidingSync,t,o,t.buildSyncApiOptions()):t.syncApi=new S.w_(t,o,t.buildSyncApiOptions()),t.syncApiResolver.resolve(),t.room=t.syncApi.createRoom(t.roomId),t.store.storeRoom(t.room),yield t.widgetApiReady,yield t.supportUpdateState())?yield t.roomStateSynced:yield Promise.all(null!=(n=null==(i=t.capabilities.receiveState)?void 0:i.map((r=(0,a.A)(function*(e){var{eventType:r,stateKey:n}=e,i=(yield t.widgetApi.readStateEvents(r,void 0,n,[t.roomId])).map(e=>new g.kl(e));t.syncApi instanceof S.w_?yield t.syncApi.injectRoomEvents(t.room,void 0,i):yield t.syncApi.injectRoomEvents(t.room,i),i.forEach(e=>{t.emit(p.AU.Event,e),b.vF.info("Backfilled event ".concat(e.getId()," ").concat(e.getType()," ").concat(e.getStateKey()))})}),function(e){return r.apply(this,arguments)})))?n:[]),void 0!==o.clientWellKnownPollPeriod&&(t.clientWellKnownIntervalID=setInterval(()=>{t.fetchClientWellKnown()},1e3*o.clientWellKnownPollPeriod),t.fetchClientWellKnown()),t.setSyncState(S.Lm.Syncing),b.vF.info("Finished initial sync"),t.matrixRTC.start(),t.capabilities.turnServers&&t.watchTurnServers()})()}stopClient(){this.widgetApi.off("action:".concat(m.WidgetApiToWidgetAction.SendEvent),this.onEvent),this.widgetApi.off("action:".concat(m.WidgetApiToWidgetAction.SendToDevice),this.onToDevice),this.widgetApi.off("action:".concat(m.WidgetApiToWidgetAction.UpdateState),this.onStateUpdate),super.stopClient(),this.lifecycle.abort()}joinRoom(e){var t=this;return(0,a.A)(function*(){if(e===t.roomId)return t.room;throw Error("Unknown room: ".concat(e))})()}encryptAndSendEvent(e,t,r,n){var i=this;return(0,a.A)(function*(){var o,a,s,l=n;r&&(0,f.U)(r)?a=r:l||(l=r);var c=null==(o=l)?void 0:o["org.matrix.msc4354.sticky_duration_ms"];if(void 0!==c&&"number"!=typeof c)throw Error("Sticky duration must be a number when defined");var d=t.event.redacts?I(I({},t.getContent()),{},{redacts:t.event.redacts}):t.getContent();if(a){var u=yield i.widgetApi.sendRoomEvent(t.getType(),d,e.roomId,"delay"in a?a.delay:void 0,"parent_delay_id"in a?a.parent_delay_id:void 0,c).catch(O);return i.validateSendDelayedEventResponse(u)}var h=t.getTxnId();h&&i.pendingSendingEventsTxId.push({type:t.getType(),id:void 0,txId:h});try{s=yield i.widgetApi.sendRoomEvent(t.getType(),d,e.roomId,void 0,void 0,c).catch(O)}catch(r){throw i.updatePendingEventStatus(e,t,g.fb.NOT_SENT),r}return e.updatePendingEvent(t,g.fb.SENT,s.event_id),i.pendingSendingEventsTxId.forEach(e=>{e.txId===h&&(e.id=s.event_id)}),i.eventEmitter.emit(R.PendingEventsChanged),{event_id:s.event_id}})()}sendStateEvent(e,t,r){var n=arguments,i=this;return(0,a.A)(function*(){var o=n.length>3&&void 0!==n[3]?n[3]:"",a=yield i.widgetApi.sendStateEvent(t,o,r,e).catch(O);if(void 0===a.event_id)throw Error("'event_id' absent from response to an event request");return{event_id:a.event_id}})()}_unstable_sendDelayedStateEvent(e,t,r,n){var i=arguments,o=this;return(0,a.A)(function*(){var a=i.length>4&&void 0!==i[4]?i[4]:"";if(!(yield o.doesServerSupportUnstableFeature(p.rG)))throw new j.qK("Server does not support the delayed events API","sendDelayedStateEvent");var s=yield o.widgetApi.sendStateEvent(r,a,n,e,"delay"in t?t.delay:void 0,"parent_delay_id"in t?t.parent_delay_id:void 0).catch(O);return o.validateSendDelayedEventResponse(s)})()}validateSendDelayedEventResponse(e){if(void 0===e.delay_id)throw Error("'delay_id' absent from response to a delayed event request");return{delay_id:e.delay_id}}_unstable_updateDelayedEvent(e,t){var r=this;return(0,a.A)(function*(){var n;if(!(yield r.doesServerSupportUnstableFeature(p.rG)))throw new j.qK("Server does not support the delayed events API","updateDelayedEvent");switch(t){case f.e.Cancel:case f.e.Restart:n=r.widgetApi.cancelScheduledDelayedEvent;break;case f.e.Send:n=r.widgetApi.sendScheduledDelayedEvent}return yield n.call(r.widgetApi,e).catch(O),{}})()}_unstable_cancelScheduledDelayedEvent(e){var t=this;return(0,a.A)(function*(){if(!(yield t.doesServerSupportUnstableFeature(p.rG)))throw new j.qK("Server does not support the delayed events API","cancelScheduledDelayedEvent");return yield t.widgetApi.cancelScheduledDelayedEvent(e).catch(O),{}})()}_unstable_restartScheduledDelayedEvent(e){var t=this;return(0,a.A)(function*(){if(!(yield t.doesServerSupportUnstableFeature(p.rG)))throw new j.qK("Server does not support the delayed events API","restartScheduledDelayedEvent");return yield t.widgetApi.restartScheduledDelayedEvent(e).catch(O),{}})()}_unstable_sendScheduledDelayedEvent(e){var t=this;return(0,a.A)(function*(){if(!(yield t.doesServerSupportUnstableFeature(p.rG)))throw new j.qK("Server does not support the delayed events API","sendScheduledDelayedEvent");return yield t.widgetApi.sendScheduledDelayedEvent(e).catch(O),{}})()}encryptAndSendToDevice(e,t,r){var n=this;return(0,a.A)(function*(){var i=new c.kG(()=>new Map);for(var{userId:o,deviceId:a}of t)i.getOrCreate(o).set(a,r);yield n.widgetApi.sendToDevice(e,!0,(0,c.HF)(i)).catch(O)})()}sendToDevice(e,t){var r=this;return(0,a.A)(function*(){return yield r.widgetApi.sendToDevice(e,!1,(0,c.HF)(t)).catch(O),{}})()}getOpenIdToken(){var e=this;return(0,a.A)(function*(){var t=yield e.widgetApi.requestOpenIDConnectToken().catch(O);return{access_token:t.access_token,expires_in:t.expires_in,matrix_server_name:t.matrix_server_name,token_type:t.token_type}})()}queueToDevice(e){var t=this;return(0,a.A)(function*(){var{eventType:r,batch:n}=e,i=new c.kG(()=>new Map);for(var{userId:o,deviceId:a,payload:s}of n)i.getOrCreate(o).set(a,s);yield t.widgetApi.sendToDevice(r,!1,(0,c.HF)(i)).catch(O)})()}sendToDeviceViaWidgetApi(e,t,r){var n=this;return(0,a.A)(function*(){yield n.widgetApi.sendToDevice(e,t,(0,c.HF)(r)).catch(O)})()}checkTurnServers(){var e=this;return(0,a.A)(function*(){return e.turnServers.length>0})()}getSyncState(){return this.syncState}setSyncState(e){var t=this.syncState;this.syncState=e,this.emit(p.AU.Sync,e,t)}ack(e){var t=this;return(0,a.A)(function*(){yield t.widgetApi.transport.reply(e.detail,{})})()}watchTurnServers(){var e=this;return(0,a.A)(function*(){var t=e.widgetApi.getTurnServers(),r=()=>{t.return(void 0)};e.lifecycle.signal.addEventListener("abort",r);try{var n=!1,i=!1;try{for(var o,a,s=function(e){var t,r,n,i=2;for("undefined"!=typeof Symbol&&(r=Symbol.asyncIterator,n=Symbol.iterator);i--;){if(r&&null!=(t=e[r]))return t.call(e);if(n&&null!=(t=e[n]))return new A(t.call(e));r="@@asyncIterator",n="@@iterator"}throw TypeError("Object is not async iterable")}(t);n=!(a=yield s.next()).done;n=!1){var l=a.value;e.turnServers=[{urls:l.uris,username:l.username,credential:l.password}],e.emit(p.AU.TurnServers,e.turnServers),b.vF.log("Received TURN server: ".concat(l.uris))}}catch(e){i=!0,o=e}finally{try{n&&null!=s.return&&(yield s.return())}finally{if(i)throw o}}}catch(e){b.vF.warn("Error watching TURN servers",e)}finally{e.lifecycle.signal.removeEventListener("abort",r)}})()}}function k(e){if(e instanceof m.WidgetApiResponseError&&e.data.matrix_api_error)throw _.up.fromWidgetApiErrorData(e.data.matrix_api_error);throw e}function O(e){if(e instanceof Error&&"Request timed out"===e.message)throw new _.Rc("widget api timeout");throw e}var M=r(43957),P=r(36963),D=r(40055),x=r(19833);class F{constructor(){(0,s.A)(this,"unthreadedReadReceipts",new Map),(0,s.A)(this,"threadedReadReceipts",new c.kG(()=>new Map))}setUnthreaded(e,t){this.unthreadedReadReceipts.set(e,t)}setThreaded(e,t,r){this.threadedReadReceipts.getOrCreate(e).set(t,r)}allUnthreaded(){return this.unthreadedReadReceipts.entries()}*allThreaded(){for(var e of this.threadedReadReceipts.values())for(var t of e.entries())yield t}consumeEphemeralEvents(e){null==e||e.forEach(e=>{e.type===y.Bx.Receipt&&e.content&&Object.keys(e.content).forEach(t=>{Object.entries(e.content[t]).forEach(r=>{var[n,i]=r;if((0,c.ll)(n))for(var o of Object.keys(i)){var a=e.content[t][n][o],s={data:e.content[t][n][o],type:n,eventId:t};a.thread_id?this.setThreaded(a.thread_id,o,s):this.setUnthreaded(o,s)}})})})}buildAccumulatedReceiptEvent(e){var t={type:y.Bx.Receipt,room_id:e,content:{}},r=new c.kG(()=>new c.kG(()=>new Map));for(var[n,i]of this.allUnthreaded())r.getOrCreate(i.eventId).getOrCreate(i.type).set(n,i.data);for(var[o,a]of this.allThreaded())r.getOrCreate(a.eventId).getOrCreate(a.type).set(o,a.data);return t.content=(0,c.HF)(r),r.size>0?t:null}}var L=function(e){return e.Invite="invite",e.Leave="leave",e.Join="join",e.Knock="knock",e}({});class U{constructor(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.opts=e,(0,s.A)(this,"accountData",{}),(0,s.A)(this,"inviteRooms",{}),(0,s.A)(this,"knockRooms",{}),(0,s.A)(this,"joinRooms",{}),(0,s.A)(this,"nextBatch",null),this.opts.maxTimelineEntries=this.opts.maxTimelineEntries||50}accumulate(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.accumulateRooms(e,t),this.accumulateAccountData(e),this.nextBatch=e.next_batch}accumulateAccountData(e){e.account_data&&e.account_data.events&&e.account_data.events.forEach(e=>{this.accountData[e.type]=e})}accumulateRooms(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];e.rooms&&(e.rooms.invite&&Object.keys(e.rooms.invite).forEach(r=>{this.accumulateRoom(r,L.Invite,e.rooms.invite[r],t)}),e.rooms.join&&Object.keys(e.rooms.join).forEach(r=>{this.accumulateRoom(r,L.Join,e.rooms.join[r],t)}),e.rooms.leave&&Object.keys(e.rooms.leave).forEach(r=>{this.accumulateRoom(r,L.Leave,e.rooms.leave[r],t)}),e.rooms.knock&&Object.keys(e.rooms.knock).forEach(r=>{this.accumulateRoom(r,L.Knock,e.rooms.knock[r],t)}))}accumulateRoom(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];switch(t){case L.Invite:this.knockRooms[e]&&delete this.knockRooms[e],this.accumulateInviteState(e,r);break;case L.Knock:this.accumulateKnockState(e,r);break;case L.Join:this.knockRooms[e]?delete this.knockRooms[e]:this.inviteRooms[e]&&delete this.inviteRooms[e],this.accumulateJoinState(e,r,n);break;case L.Leave:this.knockRooms[e]?delete this.knockRooms[e]:this.inviteRooms[e]?delete this.inviteRooms[e]:delete this.joinRooms[e];break;default:b.vF.error("Unknown cateogory: ",t)}}accumulateInviteState(e,t){if(t.invite_state&&t.invite_state.events){if(!this.inviteRooms[e]){this.inviteRooms[e]={invite_state:t.invite_state};return}var r=this.inviteRooms[e];t.invite_state.events.forEach(e=>{for(var t=!1,n=0;n<r.invite_state.events.length;n++){var i=r.invite_state.events[n];i.type===e.type&&i.state_key==e.state_key&&(r.invite_state.events[n]=e,t=!0)}t||r.invite_state.events.push(e)})}}accumulateKnockState(e,t){if(t.knock_state&&t.knock_state.events){if(!this.knockRooms[e]){this.knockRooms[e]={knock_state:t.knock_state};return}var r=this.knockRooms[e];t.knock_state.events.forEach(e=>{for(var t=!1,n=0;n<r.knock_state.events.length;n++){var i=r.knock_state.events[n];i.type===e.type&&i.state_key==e.state_key&&(r.knock_state.events[n]=e,t=!0)}t||r.knock_state.events.push(e)})}}accumulateJoinState(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=Date.now();this.joinRooms[e]||(this.joinRooms[e]={_currentState:Object.create(null),_timeline:[],_accountData:Object.create(null),_unreadNotifications:{},_unreadThreadNotifications:{},_summary:{},_receipts:new F,_stickyEvents:[]});var i=this.joinRooms[e];if(t.account_data&&t.account_data.events&&t.account_data.events.forEach(e=>{i._accountData[e.type]=e}),t.unread_notifications&&(i._unreadNotifications=t.unread_notifications),i._unreadThreadNotifications=null!=(o=null!=(a=t[x.a.stable])?a:t[x.a.unstable])?o:void 0,t.summary){var o,a,s,l,c,d,u,h,v,p,m="m.heroes",f="m.invited_member_count",y="m.joined_member_count",b=i._summary,S=t.summary;b[m]=null!=(h=S[m])?h:b[m],b[y]=null!=(v=S[y])?v:b[y],b[f]=null!=(p=S[f])?p:b[f]}if(i._receipts.consumeEphemeralEvents(null==(s=t.ephemeral)?void 0:s.events),t.timeline&&t.timeline.limited&&(i._timeline=[]),null==(l=t.state)||null==(l=l.events)||l.forEach(e=>{N(i._currentState,e)}),null==(c=t["org.matrix.msc4222.state_after"])||null==(c=c.events)||c.forEach(e=>{N(i._currentState,e)}),null==(d=t.timeline)||null==(d=d.events)||d.forEach((e,n)=>{if(t["org.matrix.msc4222.state_after"]||N(i._currentState,e),r)a=e;else{void 0!==(a=Object.assign({},e)).unsigned&&(a.unsigned=Object.assign({},a.unsigned));var o,a,s,l=null==(s=e.unsigned)?void 0:s.age;void 0!==l&&(a._localTs=Date.now()-l)}i._timeline.push({event:a,token:0===n&&null!=(o=t.timeline.prev_batch)?o:null})}),i._stickyEvents=i._stickyEvents.filter(e=>{var{expiresTs:t}=e;return t>n}),null!=(u=t.msc4354_sticky)&&u.events&&(i._stickyEvents=i._stickyEvents.concat(t.msc4354_sticky.events.map(e=>{var t=Math.min(e.msc4354_sticky.duration_ms,g.P0),r=Math.min(e.origin_server_ts,n);return{event:e,expiresTs:t+r}}))),i._timeline.length>this.opts.maxTimelineEntries){for(var E=i._timeline.length-this.opts.maxTimelineEntries,_=E;_<i._timeline.length;_++)if(i._timeline[_].token){i._timeline=i._timeline.slice(_,i._timeline.length);break}}}getJSON(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t={join:{},invite:{},knock:{},leave:{}};Object.keys(this.inviteRooms).forEach(e=>{t.invite[e]=this.inviteRooms[e]}),Object.keys(this.knockRooms).forEach(e=>{t.knock[e]=this.knockRooms[e]}),Object.keys(this.joinRooms).forEach(r=>{var n,i=this.joinRooms[r],o={ephemeral:{events:[]},account_data:{events:[]},state:{events:[]},"org.matrix.msc4222.state_after":{events:[]},timeline:{events:[],prev_batch:null},unread_notifications:i._unreadNotifications,unread_thread_notifications:i._unreadThreadNotifications,summary:i._summary,msc4354_sticky:null!=(n=i._stickyEvents)&&n.length?{events:i._stickyEvents.map(e=>e.event)}:void 0};Object.keys(i._accountData).forEach(e=>{o.account_data.events.push(i._accountData[e])});var a=i._receipts.buildAccumulatedReceiptEvent(r);a&&o.ephemeral.events.push(a),i._timeline.forEach(t=>{var r,n;if(!o.timeline.prev_batch){if(!t.token)return;o.timeline.prev_batch=t.token}!e&&"_localTs"in(n=t.event)&&void 0!==n._localTs?(void 0!==(r=Object.assign({},t.event)).unsigned&&(r.unsigned=Object.assign({},r.unsigned)),delete r._localTs,r.unsigned=r.unsigned||{},r.unsigned.age=Date.now()-t.event._localTs):r=t.event,o.timeline.events.push(r)});for(var s=Object.create(null),l=o.timeline.events.length-1;l>=0;l--){var d=o.timeline.events[l];if(null!==d.state_key&&void 0!==d.state_key){var u=(0,c.A4)(d);u.unsigned&&(u.unsigned.prev_content&&(u.content=u.unsigned.prev_content),u.unsigned.prev_sender&&(u.sender=u.unsigned.prev_sender)),N(s,u)}}Object.keys(i._currentState).forEach(e=>{Object.keys(i._currentState[e]).forEach(t=>{var r=i._currentState[e][t];o["org.matrix.msc4222.state_after"].events.push(r),s[e]&&s[e][t]&&(r=s[e][t]),o.state.events.push(r)})}),t.join[r]=o});var r=[];return Object.keys(this.accountData).forEach(e=>{r.push(this.accountData[e])}),{nextBatch:this.nextBatch,roomsData:t,accountData:r}}getNextBatchToken(){return this.nextBatch}}function N(e,t){null!==t.state_key&&void 0!==t.state_key&&t.type&&(e[t.type]||(e[t.type]=Object.create(null)),e[t.type][t.state_key]=t)}var j=r(69103),B=r(35095),W=r(47511),K=r(61219),q=r(12411),V=r(80578),H=r(33418),G=r(59741),J=r(37151),z=r(15095),Y=r(12965),X=r(21401),$=r(26268),Q=r(74411),Z=function(){};class ee{constructor(e,t){var r,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};this.client=e,this.timelineSet=t,(0,s.A)(this,"windowLimit",void 0),(0,s.A)(this,"start",void 0),(0,s.A)(this,"end",void 0),(0,s.A)(this,"eventCount",0),this.windowLimit=n.windowLimit||1e3,null==(r=t.room)||r.on(K.u9.Timeline,this.onTimelineEvent.bind(this))}load(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:20,r=r=>{if(!r)throw Error("No timeline given to initFields");var n,i=r.getEvents();if(e){if((n=i.findIndex(t=>t.getId()===e))<0)throw Error("getEventTimeline result didn't include requested event")}else n=i.length;var o=Math.min(i.length,n+Math.ceil(t/2)),a=Math.max(0,o-t);this.start=new et(r,a-r.getBaseIndex()),this.end=new et(r,o-r.getBaseIndex()),this.eventCount=o-a};return this.timelineSet.getTimelineForEvent(e)?(r(this.timelineSet.getTimelineForEvent(e)),Promise.resolve()):e?this.client.getEventTimeline(this.timelineSet,e).then(r):(r(this.timelineSet.getLiveTimeline()),Promise.resolve())}getTimelineIndex(e){var t,r;if(e==q.q.BACKWARDS)return null!=(t=this.start)?t:null;if(e==q.q.FORWARDS)return null!=(r=this.end)?r:null;throw Error("Invalid direction '"+e+"'")}extend(e,t){var r=this.getTimelineIndex(e);if(!r)return Z("TimelineWindow: no timeline yet"),!1;var n=e==q.q.BACKWARDS?r.retreat(t):r.advance(t);if(n){this.eventCount+=n,Z("TimelineWindow: increased cap by "+n+" (now "+this.eventCount+")");var i=this.eventCount-this.windowLimit;return i>0&&this.unpaginate(i,e!=q.q.BACKWARDS),!0}return!1}onTimelineEvent(e,t,r,n){n&&this.onEventRemoved()}onEventRemoved(){var e=this.getEvents();e.length>0&&void 0===e[e.length-1]&&this.end&&this.end.index--}canPaginate(e){var t=this.getTimelineIndex(e);if(!t)return Z("TimelineWindow: no timeline yet"),!1;if(e==q.q.BACKWARDS){if(t.index>t.minIndex())return!0}else if(t.index<t.maxIndex())return!0;var r=t.timeline.getNeighbouringTimeline(e),n=t.timeline.getPaginationToken(e);return!!r||!!n}paginate(e,t){var r=arguments,n=this;return(0,a.A)(function*(){var i=!(r.length>2)||void 0===r[2]||r[2],o=r.length>3&&void 0!==r[3]?r[3]:10,a=n.getTimelineIndex(e);if(!a)return Z("TimelineWindow: no timeline yet"),!1;if(a.pendingPaginate)return a.pendingPaginate;if(n.extend(e,t))return!0;if(!i||0===o)return!1;if(!a.timeline.getPaginationToken(e))return Z("TimelineWindow: no token"),!1;Z("TimelineWindow: starting request");var s=n.client.paginateEventTimeline(a.timeline,{backwards:e==q.q.BACKWARDS,limit:t}).finally(function(){a.pendingPaginate=void 0}).then(r=>(Z("TimelineWindow: request completed with result "+r),r)?n.paginate(e,t,!0,o-1):n.paginate(e,t,!1,0));return a.pendingPaginate=s,s})()}unpaginate(e,t){var r=t?this.start:this.end;if(!r)throw Error("Attempting to unpaginate startOfTimeline=".concat(t," but don't have this direction"));if(e>this.eventCount||e<0)throw Error("Attemting to unpaginate ".concat(e," events, but only have ").concat(this.eventCount," in the timeline"));for(;e>0;){var n=t?r.advance(e):r.retreat(e);if(n<=0)throw Error("Unable to unpaginate any further, but still have "+this.eventCount+" events");e-=n,this.eventCount-=n,Z("TimelineWindow.unpaginate: dropped "+n+" (now "+this.eventCount+")")}}getEvents(){if(!this.start)return[];for(var e=[],t=this.start.timeline;t;){var r,n,i=t.getEvents(),o=0,a=i.length;t===this.start.timeline&&(o=this.start.index+t.getBaseIndex()),t===(null==(r=this.end)?void 0:r.timeline)&&(a=this.end.index+t.getBaseIndex());for(var s=o;s<a;s++)e.push(i[s]);if(t===(null==(n=this.end)?void 0:n.timeline))break;t=t.getNeighbouringTimeline(q.q.FORWARDS)}return e}}class et{constructor(e,t){this.timeline=e,this.index=t,(0,s.A)(this,"pendingPaginate",void 0)}minIndex(){return -1*this.timeline.getBaseIndex()}maxIndex(){return this.timeline.getEvents().length-this.timeline.getBaseIndex()}advance(e){if(!e)return 0;if(e<0){if((t=Math.max(e,this.minIndex()-this.index))<0)return this.index+=t,t}else if((t=Math.min(e,this.maxIndex()-this.index))>0)return this.index+=t,t;var t,r=this.timeline.getNeighbouringTimeline(e<0?q.q.BACKWARDS:q.q.FORWARDS);return r?(this.timeline=r,e<0?this.index=this.maxIndex():this.index=this.minIndex(),Z("paginate: switched to new neighbour"),this.advance(e)):0}retreat(e){return -1*this.advance(-1*e)}}var er="m.login.email.identity",en="m.login.msisdn",ei=function(e){return e.Password="m.login.password",e.Recaptcha="m.login.recaptcha",e.Terms="m.login.terms",e.Email="m.login.email.identity",e.Msisdn="m.login.msisdn",e.Sso="m.login.sso",e.SsoUnstable="org.matrix.login.sso",e.Dummy="m.login.dummy",e.RegistrationToken="m.login.registration_token",e.UnstableRegistrationToken="org.matrix.msc3231.login.registration_token",e.OAuth="m.oauth",e}({});class eo extends Error{constructor(e,t,r){super(e),this.required_stages=t,this.flows=r,(0,s.A)(this,"name","NoAuthFlowFoundError")}}class ea{constructor(e){var t=this;(0,s.A)(this,"matrixClient",void 0),(0,s.A)(this,"inputs",void 0),(0,s.A)(this,"clientSecret",void 0),(0,s.A)(this,"requestCallback",void 0),(0,s.A)(this,"busyChangedCallback",void 0),(0,s.A)(this,"stateUpdatedCallback",void 0),(0,s.A)(this,"requestEmailTokenCallback",void 0),(0,s.A)(this,"supportedStages",void 0),(0,s.A)(this,"data",void 0),(0,s.A)(this,"emailSid",void 0),(0,s.A)(this,"requestingEmailToken",!1),(0,s.A)(this,"attemptAuthDeferred",null),(0,s.A)(this,"chosenFlow",null),(0,s.A)(this,"currentStage",null),(0,s.A)(this,"emailAttempt",1),(0,s.A)(this,"submitPromise",null),(0,s.A)(this,"requestEmailToken",(0,a.A)(function*(){if(t.requestingEmailToken)b.vF.warn("Could not request email token: Already requesting");else{b.vF.trace("Requesting email token. Attempt: "+t.emailAttempt),t.requestingEmailToken=!0;try{var e=yield t.requestEmailTokenCallback(t.inputs.emailAddress,t.clientSecret,t.emailAttempt++,t.data.session);t.emailSid=e.sid,b.vF.trace("Email token request succeeded")}finally{t.requestingEmailToken=!1}}})),this.matrixClient=e.matrixClient,this.data=e.authData||{flows:[]},this.requestCallback=e.doRequest,this.busyChangedCallback=e.busyChanged,this.stateUpdatedCallback=e.stateUpdated||e.startAuthStage,this.requestEmailTokenCallback=e.requestEmailToken,this.inputs=e.inputs||{},e.sessionId&&(this.data.session=e.sessionId),this.clientSecret=e.clientSecret||this.matrixClient.generateClientSecret(),this.emailSid=e.emailSid,void 0!==e.supportedStages&&(this.supportedStages=new Set(e.supportedStages))}attemptAuth(){var e=this;return(0,a.A)(function*(){e.attemptAuthDeferred=Promise.withResolvers();var t=e.attemptAuthDeferred.promise;if(null!=(r=e.data)&&null!=(r=r.flows)&&r.length)e.startNextAuthStage();else{null==(n=e.busyChangedCallback)||n.call(e,!0);var r,n,i=e.data.session?{session:e.data.session}:null;e.doRequest(i).finally(()=>{var t;null==(t=e.busyChangedCallback)||t.call(e,!1)})}return t})()}poll(){var e=this;return(0,a.A)(function*(){if(e.data.session&&e.attemptAuthDeferred&&!e.submitPromise){var t={};if(e.currentStage==er&&e.emailSid){var r={sid:e.emailSid,client_secret:e.clientSecret},n=e.matrixClient.getIdentityServerUrl();n&&(r.id_server=new URL(n).host),t={type:er,threepid_creds:r}}e.submitAuthDict(t,!0)}})()}getSessionId(){var e;return null==(e=this.data)?void 0:e.session}getClientSecret(){return this.clientSecret}getStageParams(e){var t;return null==(t=this.data)||null==(t=t.params)?void 0:t[e]}getChosenFlow(){return this.chosenFlow}submitAuthDict(e){var t=arguments,r=this;return(0,a.A)(function*(){var n,i,o,a,s=t.length>1&&void 0!==t[1]&&t[1];if(!r.attemptAuthDeferred)throw Error("submitAuthDict() called before attemptAuth()");for(s||null==(i=r.busyChangedCallback)||i.call(r,!0);r.submitPromise;)try{yield r.submitPromise}catch(e){}o=null!=(n=r.data)&&n.session?Object.assign({session:r.data.session},e):e;try{r.submitPromise=r.doRequest(o,s),yield r.submitPromise}finally{r.submitPromise=null,s||null==(a=r.busyChangedCallback)||a.call(r,!1)}})()}getEmailSid(){return this.emailSid}setEmailSid(e){this.emailSid=e}doRequest(e){var t=arguments,r=this;return(0,a.A)(function*(){var n=t.length>1&&void 0!==t[1]&&t[1];try{var i=yield r.requestCallback(e,n);r.attemptAuthDeferred.resolve(i),r.attemptAuthDeferred=null}catch(e){var o,a,s,l,c,d=e instanceof P.up?e:null,u=null!=(o=null==d||null==(a=d.data)?void 0:a.flows)?o:null,h=(null==(s=r.data)?void 0:s.flows)||!!u;d&&401===d.httpStatus&&d.data&&h||(n?b.vF.log("Background poll request failed doing UI auth: ignoring",e):null==(c=r.attemptAuthDeferred)||c.reject(e)),d&&!d.data&&(d.data={}),!d||d.data.flows||d.data.completed||d.data.session||(d.data.flows=r.data.flows,d.data.completed=r.data.completed,d.data.session=r.data.session),d&&(r.data=d.data);try{r.startNextAuthStage()}catch(e){r.attemptAuthDeferred.reject(e),r.attemptAuthDeferred=null;return}if(!r.emailSid&&null!=(l=r.chosenFlow)&&l.stages.includes(ei.Email))try{yield r.requestEmailToken()}catch(e){r.attemptAuthDeferred.reject(e),r.attemptAuthDeferred=null}}})()}startNextAuthStage(){var e,t,r,n,i=this.chooseStage();if(!i)throw Error("No incomplete flows from the server");return(this.currentStage=i,i===ei.Dummy)?void this.submitAuthDict({type:"m.login.dummy"}):null!=(e=this.data)&&e.errcode||null!=(t=this.data)&&t.error?void this.stateUpdatedCallback(i,{errcode:(null==(r=this.data)?void 0:r.errcode)||"",error:(null==(n=this.data)?void 0:n.error)||""}):void this.stateUpdatedCallback(i,i===er?{emailSid:this.emailSid}:{})}chooseStage(){null===this.chosenFlow&&(this.chosenFlow=this.chooseFlow()),b.vF.log("Active flow => %s",JSON.stringify(this.chosenFlow));var e=this.firstUncompletedStage(this.chosenFlow);return b.vF.log("Next stage: %s",e),e}scoreFlow(e){var t=e.stages.length;return void 0!==this.supportedStages&&(t+=10*e.stages.filter(e=>!this.supportedStages.has(e)).length),t}chooseFlow(){var e,t=(null==(e=this.data)?void 0:e.flows)||[],r=!!this.inputs.emailAddress||!!this.emailSid,n=!!this.inputs.phoneCountry&&!!this.inputs.phoneNumber;for(var i of(t.sort((e,t)=>this.scoreFlow(e)-this.scoreFlow(t)),t)){var o=!1,a=!1;for(var s of i.stages)s===er?o=!0:s==en&&(a=!0);if(o==r&&a==n)return i}var l=[];throw r&&l.push(er),n&&l.push(en),new eo("No appropriate authentication flow found",l,t)}firstUncompletedStage(e){var t,r=(null==(t=this.data)?void 0:t.completed)||[];return e.stages.find(e=>!r.includes(e))}}var es=r(45514),el=r(11007),ec=r(6151),ed=[e=>{e.createObjectStore("users",{keyPath:["userId"]}),e.createObjectStore("accountData",{keyPath:["type"]}),e.createObjectStore("sync",{keyPath:["clobber"]})},e=>{e.createObjectStore("oob_membership_events",{keyPath:["room_id","state_key"]}).createIndex("room","room_id")},e=>{e.createObjectStore("client_options",{keyPath:["clobber"]})},e=>{e.createObjectStore("to_device_queue",{autoIncrement:!0})}],eu=ed.length;function eh(e,t,r){var n=e.openCursor(t);return new Promise((e,t)=>{var i=[];n.onerror=()=>{var e;t(Error("Query failed: "+(null==(e=n.error)?void 0:e.name)))},n.onsuccess=()=>{var t=n.result;if(!t)return void e(i);i.push(r(t)),t.continue()}})}function ev(e){return new Promise((t,r)=>{e.oncomplete=function(e){t(e)},e.onerror=function(){r(e.error)}})}function ep(e){return new Promise((t,r)=>{e.onsuccess=function(e){t(e)},e.onerror=function(){r(e.error)}})}function em(e){return ep(e).then(t=>e.result)}class eg{static exists(e,t){return t="matrix-js-sdk:"+(t||"default"),(0,ec.t)(e,t)}constructor(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"default";this.indexedDB=e,(0,s.A)(this,"dbName",void 0),(0,s.A)(this,"syncAccumulator",void 0),(0,s.A)(this,"db",void 0),(0,s.A)(this,"disconnected",!0),(0,s.A)(this,"_isNewlyCreated",!1),(0,s.A)(this,"syncToDatabasePromise",void 0),(0,s.A)(this,"pendingUserPresenceData",[]),this.dbName="matrix-js-sdk:"+t,this.syncAccumulator=new U}connect(e){var t=this;if(!this.disconnected)return b.vF.log("LocalIndexedDBStoreBackend.connect: already connected or connecting"),Promise.resolve();this.disconnected=!1,b.vF.log("LocalIndexedDBStoreBackend.connect: connecting...");var r=this.indexedDB.open(this.dbName,eu);return r.onupgradeneeded=e=>{var t=r.result,n=e.oldVersion;b.vF.log("LocalIndexedDBStoreBackend.connect: upgrading from ".concat(n)),n<1&&(this._isNewlyCreated=!0),ed.forEach((e,r)=>{n<=r&&e(t)})},r.onblocked=()=>{b.vF.log("can't yet open LocalIndexedDBStoreBackend because it is open elsewhere")},b.vF.log("LocalIndexedDBStoreBackend.connect: awaiting connection..."),ep(r).then((0,a.A)(function*(){b.vF.log("LocalIndexedDBStoreBackend.connect: connected"),t.db=r.result,t.db.onversionchange=()=>{var e;null==(e=t.db)||e.close(),t.disconnected=!0,t.db=void 0},t.db.onclose=()=>{t.disconnected=!0,t.db=void 0,null==e||e()},yield t.init()}))}isNewlyCreated(){return Promise.resolve(this._isNewlyCreated)}init(){return Promise.all([this.loadAccountData(),this.loadSyncData()]).then(e=>{var[t,r]=e;b.vF.log("LocalIndexedDBStoreBackend: loaded initial data"),this.syncAccumulator.accumulate({next_batch:r.nextBatch,rooms:r.roomsData,account_data:{events:t}},!0)})}getOutOfBandMembers(e){return new Promise((t,r)=>{var n=this.db.transaction(["oob_membership_events"],"readonly").objectStore("oob_membership_events").index("room"),i=IDBKeyRange.only(e),o=n.openCursor(i),a=[],s=!1;o.onsuccess=()=>{var e=o.result;if(!e)return a.length||s?t(a):t(null);var r=e.value;r.oob_written?s=!0:a.push(r),e.continue()},o.onerror=e=>{r(e)}}).then(t=>(b.vF.log("LL: got ".concat(null==t?void 0:t.length," membershipEvents from storage for room ").concat(e," ...")),t))}setOutOfBandMembers(e,t){var r=this;return(0,a.A)(function*(){b.vF.log("LL: backend about to store ".concat(t.length)+" members for ".concat(e));var n=r.db.transaction(["oob_membership_events"],"readwrite"),i=n.objectStore("oob_membership_events");t.forEach(e=>{i.put(e)}),i.put({room_id:e,oob_written:!0,state_key:0}),yield ev(n),b.vF.log("LL: backend done storing for ".concat(e,"!"))})()}clearOutOfBandMembers(e){var t=this;return(0,a.A)(function*(){var r,n=t.db.transaction(["oob_membership_events"],"readonly").objectStore("oob_membership_events").index("room"),i=IDBKeyRange.only(e),o=em(n.openKeyCursor(i,"next")).then(e=>(null==e?void 0:e.primaryKey)[1]),a=em(n.openKeyCursor(i,"prev")).then(e=>(null==e?void 0:e.primaryKey)[1]),[s,l]=yield Promise.all([o,a]),c=t.db.transaction(["oob_membership_events"],"readwrite").objectStore("oob_membership_events"),d=IDBKeyRange.bound([e,s],[e,l]);b.vF.log("LL: Deleting all users + marker in storage for room ".concat(e,", with key range:"),[e,s],[e,l]),yield(r=c.delete(d),new Promise((e,t)=>{r.onsuccess=()=>e(r),r.onerror=e=>t(e)}))})()}clearDatabase(){return new Promise(e=>{b.vF.log("Removing indexeddb instance: ".concat(this.dbName)),null==(t=this.db)||t.close();var t,r=this.indexedDB.deleteDatabase(this.dbName);r.onblocked=()=>{b.vF.log("can't yet delete indexeddb ".concat(this.dbName," because it is open elsewhere"))},r.onerror=()=>{var t;b.vF.warn("unable to delete js-sdk store indexeddb: ".concat(null==(t=r.error)?void 0:t.name)),e()},r.onsuccess=()=>{b.vF.log("Removed indexeddb instance: ".concat(this.dbName)),e()}})}getSavedSync(){var e=!(arguments.length>0)||void 0===arguments[0]||arguments[0],t=this.syncAccumulator.getJSON();return t.nextBatch?e?Promise.resolve((0,c.A4)(t)):Promise.resolve(t):Promise.resolve(null)}getNextBatchToken(){return Promise.resolve(this.syncAccumulator.getNextBatchToken())}setSyncData(e){return Promise.resolve().then(()=>{this.syncAccumulator.accumulate(e)})}syncToDatabase(e){var t=this;return(0,a.A)(function*(){return t.syncToDatabasePromise?(b.vF.warn("Skipping syncToDatabase() as persist already in flight"),t.pendingUserPresenceData.push(...e)):(e.unshift(...t.pendingUserPresenceData),t.syncToDatabasePromise=t.doSyncToDatabase(e)),t.syncToDatabasePromise})()}doSyncToDatabase(e){var t=this;return(0,a.A)(function*(){try{var r=t.syncAccumulator.getJSON(!0);yield Promise.all([t.persistUserPresenceEvents(e),t.persistAccountData(r.accountData),t.persistSyncData(r.nextBatch,r.roomsData)])}finally{t.syncToDatabasePromise=void 0}})()}persistSyncData(e,t){return b.vF.log("Persisting sync data up to",e),(0,c.j0)(()=>{var r=this.db.transaction(["sync"],"readwrite");return r.objectStore("sync").put({clobber:"-",nextBatch:e,roomsData:t}),ev(r).then(()=>{b.vF.log("Persisted sync data up to",e)})})}persistAccountData(e){return(0,c.j0)(()=>{var t=this.db.transaction(["accountData"],"readwrite"),r=t.objectStore("accountData");for(var n of e)r.put(n);return ev(t).then()})}persistUserPresenceEvents(e){return(0,c.j0)(()=>{var t=this.db.transaction(["users"],"readwrite"),r=t.objectStore("users");for(var n of e)r.put({userId:n[0],event:n[1]});return ev(t).then()})}getUserPresenceEvents(){return(0,c.j0)(()=>eh(this.db.transaction(["users"],"readonly").objectStore("users"),void 0,e=>[e.value.userId,e.value.event]))}loadAccountData(){return b.vF.log("LocalIndexedDBStoreBackend: loading account data..."),(0,c.j0)(()=>eh(this.db.transaction(["accountData"],"readonly").objectStore("accountData"),void 0,e=>e.value).then(e=>(b.vF.log("LocalIndexedDBStoreBackend: loaded account data"),e)))}loadSyncData(){return b.vF.log("LocalIndexedDBStoreBackend: loading sync data..."),(0,c.j0)(()=>eh(this.db.transaction(["sync"],"readonly").objectStore("sync"),void 0,e=>e.value).then(e=>(b.vF.log("LocalIndexedDBStoreBackend: loaded sync data"),e.length>1&&b.vF.warn("loadSyncData: More than 1 sync row found."),e.length>0?e[0]:{})))}getClientOptions(){return Promise.resolve().then(()=>eh(this.db.transaction(["client_options"],"readonly").objectStore("client_options"),void 0,e=>{var t;return null==(t=e.value)?void 0:t.options}).then(e=>e[0]))}storeClientOptions(e){var t=this;return(0,a.A)(function*(){var r=t.db.transaction(["client_options"],"readwrite");r.objectStore("client_options").put({clobber:"-",options:e}),yield ev(r)})()}saveToDeviceBatches(e){var t=this;return(0,a.A)(function*(){var r=t.db.transaction(["to_device_queue"],"readwrite"),n=r.objectStore("to_device_queue");for(var i of e)n.add(i);yield ev(r)})()}getOldestToDeviceBatch(){var e=this;return(0,a.A)(function*(){var t=e.db.transaction(["to_device_queue"],"readonly").objectStore("to_device_queue"),r=yield em(t.openCursor());if(!r)return null;var n=r.value;return{id:r.key,txnId:n.txnId,eventType:n.eventType,batch:n.batch}})()}removeToDeviceBatch(e){var t=this;return(0,a.A)(function*(){var r=t.db.transaction(["to_device_queue"],"readwrite");r.objectStore("to_device_queue").delete(e),yield ev(r)})()}destroy(){var e=this;return(0,a.A)(function*(){var t;null==(t=e.db)||t.close()})()}}class ef{constructor(e,t){this.workerFactory=e,this.dbName=t,(0,s.A)(this,"worker",void 0),(0,s.A)(this,"nextSeq",0),(0,s.A)(this,"inFlight",{}),(0,s.A)(this,"startPromise",void 0),(0,s.A)(this,"onWorkerMessage",e=>{var t,r=e.data;if("closed"==r.command)null==(t=this.onClose)||t.call(this);else if("cmd_success"==r.command||"cmd_fail"==r.command){if(void 0===r.seq)return void b.vF.error("Got reply from worker with no seq");var n=this.inFlight[r.seq];if(void 0===n)return void b.vF.error("Got reply for unknown seq "+r.seq);if(delete this.inFlight[r.seq],"cmd_success"==r.command)n.resolve(r.result);else{var i=Error(r.error.message);i.name=r.error.name,n.reject(i)}}else b.vF.warn("Unrecognised message from worker: ",r)})}connect(e){return this.onClose=e,this.ensureStarted().then(()=>this.doCmd("connect"))}clearDatabase(){return this.ensureStarted().then(()=>this.doCmd("clearDatabase"))}isNewlyCreated(){return this.doCmd("isNewlyCreated")}getSavedSync(){return this.doCmd("getSavedSync")}getNextBatchToken(){return this.doCmd("getNextBatchToken")}setSyncData(e){return this.doCmd("setSyncData",[e])}syncToDatabase(e){return this.doCmd("syncToDatabase",[e])}getOutOfBandMembers(e){return this.doCmd("getOutOfBandMembers",[e])}setOutOfBandMembers(e,t){return this.doCmd("setOutOfBandMembers",[e,t])}clearOutOfBandMembers(e){return this.doCmd("clearOutOfBandMembers",[e])}getClientOptions(){return this.doCmd("getClientOptions")}storeClientOptions(e){return this.doCmd("storeClientOptions",[e])}getUserPresenceEvents(){return this.doCmd("getUserPresenceEvents")}saveToDeviceBatches(e){var t=this;return(0,a.A)(function*(){return t.doCmd("saveToDeviceBatches",[e])})()}getOldestToDeviceBatch(){var e=this;return(0,a.A)(function*(){return e.doCmd("getOldestToDeviceBatch")})()}removeToDeviceBatch(e){var t=this;return(0,a.A)(function*(){return t.doCmd("removeToDeviceBatch",[e])})()}ensureStarted(){return this.startPromise||(this.worker=this.workerFactory(),this.worker.onmessage=this.onWorkerMessage,this.startPromise=this.doCmd("setupWorker",[this.dbName]).then(()=>{b.vF.log("IndexedDB worker is ready")})),this.startPromise}doCmd(e,t){return Promise.resolve().then(()=>{var r,n=this.nextSeq++,i=Promise.withResolvers();return this.inFlight[n]=i,null==(r=this.worker)||r.postMessage({command:e,seq:n,args:t}),i.promise})}destroy(){var e=this;return(0,a.A)(function*(){var t;null==(t=e.worker)||t.terminate()})()}}class ey extends h{static exists(e,t){return eg.exists(e,t)}constructor(e){if(super(e),(0,s.A)(this,"backend",void 0),(0,s.A)(this,"startedUp",!1),(0,s.A)(this,"syncTs",0),(0,s.A)(this,"userModifiedMap",{}),(0,s.A)(this,"emitter",new z.X),(0,s.A)(this,"onClose",()=>{this.emitter.emit("closed")}),(0,s.A)(this,"getSavedSync",this.degradable(()=>this.backend.getSavedSync(),"getSavedSync")),(0,s.A)(this,"isNewlyCreated",this.degradable(()=>this.backend.isNewlyCreated(),"isNewlyCreated")),(0,s.A)(this,"getSavedSyncToken",this.degradable(()=>this.backend.getNextBatchToken(),"getSavedSyncToken")),(0,s.A)(this,"deleteAllData",this.degradable(()=>(super.deleteAllData(),this.backend.clearDatabase().then(()=>{b.vF.log("Deleted indexeddb data.")},e=>{throw b.vF.error("Failed to delete indexeddb data: ".concat(e)),e})),null)),(0,s.A)(this,"reallySave",this.degradable(()=>{this.syncTs=Date.now();var e=[];for(var t of this.getUsers())this.userModifiedMap[t.userId]!==t.getLastModifiedTime()&&t.events.presence&&(e.push([t.userId,t.events.presence.event]),this.userModifiedMap[t.userId]=t.getLastModifiedTime());return this.backend.syncToDatabase(e)},null)),(0,s.A)(this,"setSyncData",this.degradable(e=>this.backend.setSyncData(e),"setSyncData")),(0,s.A)(this,"getOutOfBandMembers",this.degradable(e=>this.backend.getOutOfBandMembers(e),"getOutOfBandMembers")),(0,s.A)(this,"setOutOfBandMembers",this.degradable((e,t)=>(super.setOutOfBandMembers(e,t),this.backend.setOutOfBandMembers(e,t)),"setOutOfBandMembers")),(0,s.A)(this,"clearOutOfBandMembers",this.degradable(e=>(super.clearOutOfBandMembers(e),this.backend.clearOutOfBandMembers(e)),"clearOutOfBandMembers")),(0,s.A)(this,"getClientOptions",this.degradable(()=>this.backend.getClientOptions(),"getClientOptions")),(0,s.A)(this,"storeClientOptions",this.degradable(e=>(super.storeClientOptions(e),this.backend.storeClientOptions(e)),"storeClientOptions")),!e.indexedDB)throw Error("Missing required option: indexedDB");e.workerFactory?this.backend=new ef(e.workerFactory,e.dbName):this.backend=new eg(e.indexedDB,e.dbName)}on(e,t){this.emitter.on(e,t)}startup(){return this.startedUp?(b.vF.log("IndexedDBStore.startup: already started"),Promise.resolve()):(b.vF.log("IndexedDBStore.startup: connecting to backend"),this.backend.connect(this.onClose).then(()=>(b.vF.log("IndexedDBStore.startup: loading presence events"),this.backend.getUserPresenceEvents())).then(e=>{b.vF.log("IndexedDBStore.startup: processing presence events"),e.forEach(e=>{var[t,r]=e;if(!this.createUser)throw Error("`IndexedDBStore.startup` must be called after assigning it to the client, not before!");var n=this.createUser(t);r&&n.setPresenceEvent(new g.kl(r)),this.userModifiedMap[n.userId]=n.getLastModifiedTime(),this.storeUser(n)}),this.startedUp=!0}))}destroy(){return this.backend.destroy()}wantsSave(){return Date.now()-this.syncTs>3e5}save(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return e||this.wantsSave()?this.reallySave():Promise.resolve()}degradable(e,t){var r=this,n=t?super[t]:null;return(0,a.A)(function*(){for(var t=arguments.length,i=Array(t),o=0;o<t;o++)i[o]=arguments[o];try{return yield e.call(r,...i)}catch(e){b.vF.error("IndexedDBStore failure, degrading to MemoryStore",e),r.emitter.emit("degraded",e);try{b.vF.log("IndexedDBStore trying to delete degraded data"),yield r.backend.clearDatabase(),b.vF.log("IndexedDBStore delete after degrading succeeded")}catch(e){b.vF.warn("IndexedDBStore delete after degrading failed",e)}if(n)return n.call(r,...i)}})}getPendingEvents(e){var t=()=>super.getPendingEvents,r=this;return(0,a.A)(function*(){if(!r.localStorage)return t().call(r,e);var n=r.localStorage.getItem(eb(e));if(n)try{return JSON.parse(n)}catch(e){b.vF.error("Could not parse persisted pending events",e)}return[]})()}setPendingEvents(e,t){var r=()=>super.setPendingEvents,n=this;return(0,a.A)(function*(){if(!n.localStorage)return r().call(n,e,t);t.length>0?n.localStorage.setItem(eb(e),JSON.stringify(t)):n.localStorage.removeItem(eb(e))})()}saveToDeviceBatches(e){return this.backend.saveToDeviceBatches(e)}getOldestToDeviceBatch(){return this.backend.getOldestToDeviceBatch()}removeToDeviceBatch(e){return this.backend.removeToDeviceBatch(e)}}function eb(e){return"mx_pending_events_".concat(e)}var eS=r(4854),eE=r(666),e_=r(83656),ew=r(85305),eT=r(84656),eI=r(26954),eA=r(12922),eR=r(17797),eC=r(8221),ek=function(e){return e.Email="email",e.Phone="msisdn",e}({}),eO=new(r(81626)).qr("oauth_aware_preferred","org.matrix.msc3824.delegated_oidc_compatibility"),eM=eO,eP=function(e){return e.Gitlab="gitlab",e.Github="github",e.Apple="apple",e.Google="google",e.Facebook="facebook",e.Twitter="twitter",e}({}),eD=function(e){return e.LOGIN="login",e.REGISTER="register",e}({}),ex=r(14308),eF=r(33234),eL=r(68401),eU=r(40893);r(96170);var eN="m.tz",ej="us.cloke.msc4175.tz";class eB{constructor(e){(0,s.A)(this,"relations",void 0),this.relations=e.filter(e=>!!e)}getRelations(){return this.relations.reduce((e,t)=>[...e,...t.getRelations()],[])}on(e,t){this.relations.forEach(r=>r.on(e,t))}off(e,t){this.relations.forEach(r=>r.off(e,t))}}var eW=r(20213),eK=r(3662),eq=r(25097),eV=r(90426),eH=r(85590),eG=r(61554),eJ=r(4002),ez=r(17351),eY=r(41948),eX=function(e){return e.Global="Global",e.SetItemError="setItem",e.GetItemError="getItem",e.RemoveItemError="removeItem",e.ClearError="clear",e.QuotaExceededError="QuotaExceededError",e}({});class e$ extends z.X{}var eQ=new e$,eZ=()=>new o._;function e0(e){eZ=e}function e1(e){var t,r,n;return e.store=null!=(t=e.store)?t:new h({localStorage:globalThis.localStorage}),e.scheduler=null!=(r=e.scheduler)?r:new v.b,e.cryptoStore=null!=(n=e.cryptoStore)?n:eZ(),e}function e2(e){return new p.pB(e1(e))}function e4(e,t,r,n){var i=!(arguments.length>4)||void 0===arguments[4]||arguments[4];return new C(e,t,r,e1(n),i)}if(globalThis.__js_sdk_entrypoint)throw Error("Multiple matrix-js-sdk entrypoints detected!");globalThis.__js_sdk_entrypoint=!0;try{n=globalThis.indexedDB}catch(e){}n&&(eZ=()=>new eE.y(n,"matrix-js-sdk:crypto")),globalThis.matrixcs=i},64763:(e,t,r)=>{"use strict";r.d(t,{Bn:()=>A,Fe:()=>R,IU:()=>I,Lm:()=>_,M:()=>k,pq:()=>O,w_:()=>C});var n=r(29301),i=r(84458),o=r(65920),a=r(61219),s=r(11749),l=r(74411),c=r(12411),d=r(49699),u=r(82393),h=r(36963),v=r(9086),p=r(29927),m=r(59741),g=r(47511),f=r(19833),y=r(38178),b=r(5294);function S(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function E(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?S(Object(r),!0).forEach(function(t){(0,i.A)(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):S(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}var _=function(e){return e.Error="ERROR",e.Prepared="PREPARED",e.Stopped="STOPPED",e.Syncing="SYNCING",e.Catchup="CATCHUP",e.Reconnecting="RECONNECTING",e}({}),w=["org.matrix.msc2716v3"];function T(e,t){return"FILTER_SYNC_".concat(e)+(t?"_"+t:"")}var I=function(e){return e.Offline="offline",e.Online="online",e.Unavailable="unavailable",e}({});function A(e){return E({initialSyncLimit:8,resolveInvitesToProfiles:!1,pollTimeout:3e4,pendingEventOrdering:d.eO.Chronological,threadSupport:!1},e)}function R(e){return E({canResetEntireTimeline:e=>!1},e)}class C{constructor(e,t,r){var o=this;this.client=e,(0,i.A)(this,"opts",void 0),(0,i.A)(this,"syncOpts",void 0),(0,i.A)(this,"_peekRoom",null),(0,i.A)(this,"currentSyncRequest",void 0),(0,i.A)(this,"abortController",void 0),(0,i.A)(this,"syncState",null),(0,i.A)(this,"syncStateData",void 0),(0,i.A)(this,"catchingUp",!1),(0,i.A)(this,"running",!1),(0,i.A)(this,"keepAliveTimer",void 0),(0,i.A)(this,"connectionReturnedResolvers",void 0),(0,i.A)(this,"notifEvents",[]),(0,i.A)(this,"failedSyncCount",0),(0,i.A)(this,"storeIsInvalid",!1),(0,i.A)(this,"presence",void 0),(0,i.A)(this,"getPushRules",(0,n.A)(function*(){try{o.syncOpts.logger.debug("Getting push rules...");var e=yield o.client.getPushRules();o.syncOpts.logger.debug("Got push rules"),o.client.pushRules=e}catch(e){if(o.syncOpts.logger.error("Getting push rules failed",e),o.shouldAbortSync(e))return;return o.syncOpts.logger.debug("Waiting for saved sync before retrying push rules..."),yield o.recoverFromSyncStartupError(o.savedSyncPromise,e),o.getPushRules()}})),(0,i.A)(this,"buildDefaultFilter",()=>{var e=new l.d(this.client.credentials.userId);return this.client.canSupport.get(y.Xj.ThreadUnreadNotifications)!==y.Tj.Unsupported&&e.setUnreadThreadNotifications(!0),e}),(0,i.A)(this,"prepareLazyLoadingForSync",(0,n.A)(function*(){o.syncOpts.logger.debug("Prepare lazy loading for sync..."),o.client.isGuest()&&(o.opts.lazyLoadMembers=!1),o.opts.lazyLoadMembers&&(o.syncOpts.logger.debug("Enabling lazy load on sync filter..."),o.opts.filter||(o.opts.filter=o.buildDefaultFilter()),o.opts.filter.setLazyLoadMembers(!0))})),(0,i.A)(this,"storeClientOptions",(0,n.A)(function*(){try{o.syncOpts.logger.debug("Storing client options..."),yield o.client.storeClientOptions(),o.syncOpts.logger.debug("Stored client options")}catch(e){throw o.syncOpts.logger.error("Storing client options failed",e),e}})),(0,i.A)(this,"getFilter",(0,n.A)(function*(){var e,t;o.syncOpts.logger.debug("Getting filter..."),e=o.opts.filter?o.opts.filter:o.buildDefaultFilter();try{t=yield o.client.getOrCreateFilter(T(o.client.credentials.userId),e)}catch(e){if(o.syncOpts.logger.error("Getting filter failed",e),o.shouldAbortSync(e))return{};return o.syncOpts.logger.debug("Waiting for saved sync before retrying filter..."),yield o.recoverFromSyncStartupError(o.savedSyncPromise,e),o.getFilter()}return{filter:e,filterId:t}})),(0,i.A)(this,"savedSyncPromise",void 0),(0,i.A)(this,"onOnline",()=>{this.syncOpts.logger.debug("Browser thinks we are back online"),this.startKeepAlives(0)}),this.opts=A(t),this.syncOpts=R(r),e.getNotifTimelineSet()&&e.reEmitter.reEmit(e.getNotifTimelineSet(),[a.u9.Timeline,a.u9.TimelineReset])}createRoom(e){var t=k(this.client,e,this.opts);return t.on(p.f.Marker,(e,r)=>{this.onMarkerStateEvent(t,e,r)}),t}onMarkerStateEvent(e,t){var{timelineWasEmpty:r}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(r)return void this.syncOpts.logger.debug("MarkerState: Ignoring markerEventId=".concat(t.getId()," in roomId=").concat(e.roomId," ")+"because the timeline was empty before the marker arrived which means there is nothing to refresh.");w.includes(e.getVersion())||t.getSender()===e.getCreator()?(this.syncOpts.logger.debug("MarkerState: Timeline needs to be refreshed because "+"a new markerEventId=".concat(t.getId()," was sent in roomId=").concat(e.roomId)),e.setTimelineNeedsRefresh(!0),e.emit(a.u9.HistoryImportedWithinTimeline,t,e)):this.syncOpts.logger.debug("MarkerState: Ignoring markerEventId=".concat(t.getId()," in roomId=").concat(e.roomId," because ")+"MSC2716 is not supported in the room version or for any room version, the marker wasn't sent by the room creator.")}syncLeftRooms(){var e=this;return(0,n.A)(function*(){var t,r,i=e.client,o=new l.d(e.client.credentials.userId);o.setTimelineLimit(1),o.setIncludeLeaveRooms(!0);var a=e.opts.pollTimeout+8e4,s=yield i.getOrCreateFilter(T(i.credentials.userId,"LEFT_ROOMS"),o),u=yield i.http.authedRequest(h.IT.Get,"/sync",{timeout:0,filter:s,"org.matrix.msc4222.use_state_after":!0},void 0,{localTimeoutMs:a}),v=[];return null!=(r=u.rooms)&&r.leave&&(v=e.mapSyncResponseToRoomArray(u.rooms.leave)),(yield Promise.all(v.map((t=(0,n.A)(function*(t){var r=t.room;if(t.isBrandNewRoom){t.timeline=t.timeline||{prev_batch:null,events:[]},r.getLiveTimeline().setPaginationToken(t.timeline.prev_batch,c.q.BACKWARDS);var{timelineEvents:n}=yield e.mapAndInjectRoomEvents(t);return r.recalculate(),i.store.storeRoom(r),i.emit(d.AU.Room,r),e.processEventsForNotifs(r,n),r}}),function(e){return t.apply(this,arguments)})))).filter(Boolean)})()}peek(e){var t,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:20;if((null==(t=this._peekRoom)?void 0:t.roomId)===e)return Promise.resolve(this._peekRoom);var n=this.client;return this._peekRoom=this.createRoom(e),this.client.roomInitialSync(e,r).then(t=>{if((null==(r=this._peekRoom)?void 0:r.roomId)!==e)throw Error("Peeking aborted");t.messages=t.messages||{chunk:[]},t.messages.chunk=t.messages.chunk||[],t.state=t.state||[];var r,i=(0,s.A4)(t.state).map(n.getEventMapper()),a=t.state.map(n.getEventMapper()),l=t.messages.chunk.map(n.getEventMapper());return Array.isArray(t.presence)&&t.presence.map(n.getEventMapper()).forEach(function(e){var t=n.store.getUser(e.getContent().user_id);t?t.setPresenceEvent(e):((t=o.K.createUser(e.getContent().user_id,n)).setPresenceEvent(e),n.store.storeUser(t)),n.emit(d.AU.Event,e)}),t.messages.start&&(this._peekRoom.oldState.paginationToken=t.messages.start),this._peekRoom.oldState.setStateEvents(i),this._peekRoom.currentState.setStateEvents(a),this.resolveInvites(this._peekRoom),this._peekRoom.recalculate(),this._peekRoom.addEventsToTimeline(l.reverse(),!0,!0,this._peekRoom.getLiveTimeline(),t.messages.start),n.store.storeRoom(this._peekRoom),n.emit(d.AU.Room,this._peekRoom),this.peekPoll(this._peekRoom),this._peekRoom})}stopPeeking(){this._peekRoom=null}peekPoll(e,t){var r,i,a=this;if(this._peekRoom!==e)return void this.syncOpts.logger.debug("Stopped peeking in room %s",e.roomId);this.client.http.authedRequest(h.IT.Get,"/events",{room_id:e.roomId,timeout:String(3e4),from:t},void 0,{localTimeoutMs:5e4,abortSignal:null==(i=this.abortController)?void 0:i.signal}).then((r=(0,n.A)(function*(t){if(a._peekRoom!==e)return void a.syncOpts.logger.debug("Stopped peeking in room %s",e.roomId);t.chunk.filter(function(e){return"m.presence"===e.type}).map(a.client.getEventMapper()).forEach(e=>{var t=a.client.store.getUser(e.getContent().user_id);t?t.setPresenceEvent(e):((t=o.K.createUser(e.getContent().user_id,a.client)).setPresenceEvent(e),a.client.store.storeUser(t)),a.client.emit(d.AU.Event,e)});var r=t.chunk.filter(function(t){return t.room_id===e.roomId&&t.event_id}).map(a.client.getEventMapper());yield e.addLiveEvents(r,{addToState:!0}),a.peekPoll(e,t.end)}),function(e){return r.apply(this,arguments)}),r=>{this.syncOpts.logger.error("[%s] Peek poll failed: %s",e.roomId,r),setTimeout(()=>{this.peekPoll(e,t)},3e4)})}getSyncState(){return this.syncState}getSyncStateData(){var e;return null!=(e=this.syncStateData)?e:null}recoverFromSyncStartupError(e,t){var r=this;return(0,n.A)(function*(){yield e;var n=r.startKeepAlives();r.updateSyncState(_.Error,{error:t}),yield n})()}shouldAbortSync(e){return"M_UNKNOWN_TOKEN"===e.errcode&&(this.syncOpts.logger.warn("Token no longer valid - assuming logout"),this.stop(),this.updateSyncState(_.Error,{error:e}),!0)}sync(){var e=this;return(0,n.A)(function*(){if(e.running=!0,e.abortController=new AbortController,null==(t=globalThis.window)||null==(r=t.addEventListener)||r.call(t,"online",e.onOnline,!1),e.client.isGuest())return e.doSync({});e.syncOpts.logger.debug("Getting saved sync token...");var t,r,n=e.client.store.getSavedSyncToken().then(t=>(e.syncOpts.logger.debug("Got saved sync token"),t));e.savedSyncPromise=e.client.store.getSavedSync().then(t=>{if(e.syncOpts.logger.debug("Got reply from saved sync, exists? ".concat(!!t)),t)return e.syncFromCache(t)}).catch(t=>{e.syncOpts.logger.error("Getting saved sync failed",t)}),yield e.getPushRules(),yield e.prepareLazyLoadingForSync(),yield e.storeClientOptions();var{filterId:i,filter:o}=yield e.getFilter();if(o){if(e.client.resetNotifTimelineSet(),!e.currentSyncRequest){var a=i,s=yield n;if(s)e.syncOpts.logger.debug("Sending first sync request...");else{e.syncOpts.logger.debug("Sending initial sync request...");var l=e.buildDefaultFilter();l.setDefinition(o.getDefinition()),l.setTimelineLimit(e.opts.initialSyncLimit),a=JSON.stringify(l.getDefinition())}e.currentSyncRequest=e.doSyncRequest({filter:a},s)}return e.syncOpts.logger.debug("Waiting for saved sync before starting sync processing..."),yield e.savedSyncPromise,e.doSync({filter:i})}})()}stop(){var e,t,r;this.syncOpts.logger.debug("SyncApi.stop"),null==(e=globalThis.window)||null==(t=e.removeEventListener)||t.call(e,"online",this.onOnline,!1),this.running=!1,null==(r=this.abortController)||r.abort(),this.keepAliveTimer&&(clearTimeout(this.keepAliveTimer),this.keepAliveTimer=void 0)}retryImmediately(){return!!this.connectionReturnedResolvers&&(this.startKeepAlives(0),!0)}syncFromCache(e){var t=this;return(0,n.A)(function*(){t.syncOpts.logger.debug("sync(): not doing HTTP hit, instead returning stored /sync data");var r=e.nextBatch;t.client.store.setSyncToken(r);var n={nextSyncToken:r,catchingUp:!1,fromCache:!0},i={next_batch:r,rooms:e.roomsData,account_data:{events:e.accountData}};try{yield t.processSyncResponse(n,i)}catch(e){t.syncOpts.logger.error("Error processing cached sync",e)}t.storeIsInvalid||t.updateSyncState(_.Prepared,n)})()}doSync(e){var t=this;return(0,n.A)(function*(){for(;t.running;){var r=t.client.store.getSyncToken(),n=void 0;try{t.currentSyncRequest||(t.currentSyncRequest=t.doSyncRequest(e,r)),n=yield t.currentSyncRequest}catch(e){if(yield t.onSyncError(e))return;continue}finally{t.currentSyncRequest=void 0}t.client.store.setSyncToken(n.next_batch),t.failedSyncCount=0;var i={oldSyncToken:null!=r?r:void 0,nextSyncToken:n.next_batch,catchingUp:t.catchingUp};try{yield t.processSyncResponse(i,n)}catch(e){t.syncOpts.logger.error("Caught /sync error",e),t.client.emit(d.AU.SyncUnexpectedError,e)}yield t.client.store.setSyncData(n),i.catchingUp=t.catchingUp,e.hasSyncedBefore||(t.updateSyncState(_.Prepared,i),e.hasSyncedBefore=!0),t.syncOpts.cryptoCallbacks&&(yield t.syncOpts.cryptoCallbacks.onSyncCompleted(i)),t.updateSyncState(_.Syncing,i),t.client.store.wantsSave()&&(yield t.client.store.save())}t.running||(t.syncOpts.logger.debug("Sync no longer running: exiting."),t.connectionReturnedResolvers&&(t.connectionReturnedResolvers.reject(),t.connectionReturnedResolvers=void 0),t.updateSyncState(_.Stopped))})()}doSyncRequest(e,t){var r,n=this.getSyncParams(e,t);return this.client.http.authedRequest(h.IT.Get,"/sync",n,void 0,{localTimeoutMs:n.timeout+8e4,abortSignal:null==(r=this.abortController)?void 0:r.signal})}getSyncParams(e,t){var r=this.opts.pollTimeout;(this.getSyncState()!==_.Syncing||this.catchingUp)&&(this.catchingUp=!0,r=0);var n=e.filter;this.client.isGuest()&&!n&&(n=this.getGuestFilter());var i={filter:n,timeout:r,"org.matrix.msc4222.use_state_after":!0};return this.opts.disablePresence?i.set_presence=I.Offline:void 0!==this.presence&&(i.set_presence=this.presence),t?i.since=t:i._cacheBuster=Date.now(),[_.Reconnecting,_.Error].includes(this.getSyncState())&&(i.timeout=0),i}setPresence(e){this.presence=e}onSyncError(e){var t=this;return(0,n.A)(function*(){if(!t.running)return t.syncOpts.logger.debug("Sync no longer running: exiting"),t.connectionReturnedResolvers&&(t.connectionReturnedResolvers.reject(),t.connectionReturnedResolvers=void 0),t.updateSyncState(_.Stopped),!0;if(t.syncOpts.logger.error("/sync error %s",e),t.shouldAbortSync(e))return!0;t.failedSyncCount++,t.syncOpts.logger.debug("Number of consecutive failed sync requests:",t.failedSyncCount),t.syncOpts.logger.debug("Starting keep-alive");var r=t.startKeepAlives();return t.currentSyncRequest=void 0,t.updateSyncState(t.failedSyncCount>=3?_.Error:_.Reconnecting,{error:e}),(yield r)&&t.getSyncState()===_.Error&&t.updateSyncState(_.Catchup,{catchingUp:!0}),!1})()}processSyncResponse(e,t){var r=this;return(0,n.A)(function*(){var i,l,u,h,p=r.client;if(Array.isArray(null==(y=t.presence)?void 0:y.events)&&t.presence.events.filter(s.O5).map(p.getEventMapper()).forEach(function(e){var t=p.store.getUser(e.getSender());t?t.setPresenceEvent(e):((t=o.K.createUser(e.getSender(),p)).setPresenceEvent(e),p.store.storeUser(t)),p.emit(d.AU.Event,e)}),Array.isArray(null==(b=t.account_data)?void 0:b.events)){var m=t.account_data.events.filter(s.O5).map(p.getEventMapper()),g=m.reduce((e,t)=>(e[t.getType()]=p.store.getAccountData(t.getType()),e),{});p.store.storeAccountDataEvents(m),m.forEach(function(e){if(e.getType()===v.Bx.PushRules){var t=e.getContent();p.setPushRules(t)}var r=g[e.getType()];return p.emit(d.AU.AccountData,e,r),e})}if(t.to_device&&Array.isArray(t.to_device.events)&&t.to_device.events.length>0){var y,b,S,E,_=t.to_device.events.filter(s.O5);O(r.syncOpts.cryptoCallbacks?yield r.syncOpts.cryptoCallbacks.preprocessToDeviceMessages(_):_.map(e=>({message:e,encryptionInfo:null})),p)}else r.catchingUp=!1;var w=[],T=[],I=[],A=[];t.rooms&&(t.rooms.invite&&(w=r.mapSyncResponseToRoomArray(t.rooms.invite)),t.rooms.join&&(T=r.mapSyncResponseToRoomArray(t.rooms.join)),t.rooms.leave&&(I=r.mapSyncResponseToRoomArray(t.rooms.leave)),t.rooms.knock&&(A=r.mapSyncResponseToRoomArray(t.rooms.knock))),r.notifEvents=[],yield Promise.all(w.map((i=(0,n.A)(function*(e){var t=e.room,n=r.mapSyncEventsFormat(e.invite_state,t);yield r.injectRoomEvents(t,n,void 0),e.isBrandNewRoom?(t.recalculate(),p.store.storeRoom(t),p.emit(d.AU.Room,t)):t.recalculate(),n.forEach(function(e){p.emit(d.AU.Event,e)})}),function(e){return i.apply(this,arguments)}))),yield Promise.all(T.map((l=(0,n.A)(function*(t){var n=t.room,i=r.mapSyncEventsFormat(t.state,n),o=r.mapSyncEventsFormat(t["org.matrix.msc4222.state_after"],n),s=r.mapSyncEventsFormat(t.timeline,n,!1),l=r.mapSyncEventsFormat(t.ephemeral),u=r.mapSyncEventsFormat(t.account_data),h=r.mapSyncEventsFormat(t.msc4354_sticky),m=t["org.matrix.msc4222.state_after"]?o:i.concat(s),g=r.isRoomEncrypted(n,m);t.unread_notifications&&(g&&0!==t.unread_notifications.notification_count||n.setUnreadNotificationCount(a.X5.Total,null!=(_=t.unread_notifications.notification_count)?_:0),(!g||0>=n.getUnreadNotificationCount(a.X5.Highlight))&&n.setUnreadNotificationCount(a.X5.Highlight,null!=(w=t.unread_notifications.highlight_count)?w:0));var y=null!=(E=t[f.a.name])?E:t[f.a.altName];if(y)for(var[b,S]of(n.resetThreadUnreadNotificationCountFromSync(Object.keys(y)),Object.entries(y))){g&&0!==S.notification_count||n.setThreadUnreadNotificationCount(b,a.X5.Total,null!=(T=S.notification_count)?T:0);var E,_,w,T,I,A=0>=n.getThreadUnreadNotificationCount(b,a.X5.Highlight);(!g||g&&A)&&n.setThreadUnreadNotificationCount(b,a.X5.Highlight,null!=(I=S.highlight_count)?I:0)}else n.resetThreadUnreadNotificationCountFromSync();if(t.timeline=t.timeline||{},t.isBrandNewRoom)null!==t.timeline.prev_batch&&n.getLiveTimeline().setPaginationToken(t.timeline.prev_batch,c.q.BACKWARDS);else if(t.timeline.limited){for(var R,C=!0,k=s.length-1;k>=0;k--){var O=s[k].getId();if(n.getTimelineForEvent(O)){r.syncOpts.logger.debug("Already have event ".concat(O," in limited sync - not resetting")),C=!1,s.splice(0,k);break}}C&&(n.resetLiveTimeline(t.timeline.prev_batch,r.syncOpts.canResetEntireTimeline(n.roomId)?null:null!=(R=e.oldSyncToken)?R:null),p.resetNotifTimelineSet())}if(r.syncOpts.cryptoCallbacks)for(var M of m)M.isState()&&M.getType()===v.Bx.RoomEncryption&&""===M.getStateKey()&&(yield r.syncOpts.cryptoCallbacks.onCryptoEvent(n,M));for(var P of s.filter(e=>e.isState()))yield r.client.decryptEventIfNeeded(P);try{"org.matrix.msc4222.state_after"in t?yield r.injectRoomEvents(n,void 0,o,s,e.fromCache):yield r.injectRoomEvents(n,i,void 0,s,e.fromCache)}catch(e){r.syncOpts.logger.error("Failed to process events on room ".concat(n.roomId,":"),e)}t.summary&&n.setSummary(t.summary),n.addEphemeralEvents(l),n.addAccountData(u);var D=h.concat(s.filter(e=>void 0!==e.unstableStickyInfo));n._unstable_addStickyEvents(D),n.recalculate(),t.isBrandNewRoom&&(p.store.storeRoom(n),p.emit(d.AU.Room,n)),r.processEventsForNotifs(n,s);var x=e=>p.emit(d.AU.Event,e);i.forEach(x),s.forEach(x),l.forEach(x),u.forEach(x),h.filter(e=>!s.some(t=>t.getId()===e.getId())).forEach(x),n.decryptCriticalEvents()}),function(e){return l.apply(this,arguments)}))),yield Promise.all(I.map((u=(0,n.A)(function*(e){var t=e.room,{timelineEvents:n,stateEvents:i,stateAfterEvents:o}=yield r.mapAndInjectRoomEvents(e),a=r.mapSyncEventsFormat(e.account_data);t.addAccountData(a),t.recalculate(),e.isBrandNewRoom&&(p.store.storeRoom(t),p.emit(d.AU.Room,t)),r.processEventsForNotifs(t,n),null==i||i.forEach(function(e){p.emit(d.AU.Event,e)}),null==o||o.forEach(function(e){p.emit(d.AU.Event,e)}),n.forEach(function(e){p.emit(d.AU.Event,e)}),a.forEach(function(e){p.emit(d.AU.Event,e)})}),function(e){return u.apply(this,arguments)}))),yield Promise.all(A.map((h=(0,n.A)(function*(e){var t=e.room,n=r.mapSyncEventsFormat(e.knock_state,t);yield r.injectRoomEvents(t,n,void 0),e.isBrandNewRoom?(t.recalculate(),p.store.storeRoom(t),p.emit(d.AU.Room,t)):t.recalculate(),n.forEach(function(e){p.emit(d.AU.Event,e)})}),function(e){return h.apply(this,arguments)}))),e.oldSyncToken&&r.notifEvents.length&&(r.notifEvents.sort(function(e,t){return e.getTs()-t.getTs()}),r.notifEvents.forEach(function(e){var t;null==(t=p.getNotifTimelineSet())||t.addLiveEvent(e,{addToState:!0})})),t.device_lists&&r.syncOpts.cryptoCallbacks&&(yield r.syncOpts.cryptoCallbacks.processDeviceLists(t.device_lists)),yield null==(S=r.syncOpts.cryptoCallbacks)?void 0:S.processKeyCounts(t.device_one_time_keys_count,null!=(E=t.device_unused_fallback_key_types)?E:t["org.matrix.msc2732.device_unused_fallback_key_types"])})()}startKeepAlives(e){return void 0===e&&(e=2e3+Math.floor(5e3*Math.random())),null!==this.keepAliveTimer&&clearTimeout(this.keepAliveTimer),e>0?this.keepAliveTimer=setTimeout(this.pokeKeepAlive.bind(this),e):this.pokeKeepAlive(),this.connectionReturnedResolvers||(this.connectionReturnedResolvers=Promise.withResolvers()),this.connectionReturnedResolvers.promise}pokeKeepAlive(){var e,t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(!this.running){clearTimeout(this.keepAliveTimer),this.connectionReturnedResolvers&&(this.connectionReturnedResolvers.reject("SyncApi.stop() was called"),this.connectionReturnedResolvers=void 0);return}var r=()=>{clearTimeout(this.keepAliveTimer),this.connectionReturnedResolvers&&(this.connectionReturnedResolvers.resolve(t),this.connectionReturnedResolvers=void 0)};this.client.http.request(h.IT.Get,"/_matrix/client/versions",void 0,void 0,{prefix:"",localTimeoutMs:15e3,abortSignal:null==(e=this.abortController)?void 0:e.signal}).then(()=>{r()},e=>{400==e.httpStatus||404==e.httpStatus?this.keepAliveTimer=setTimeout(r,2e3):(t=!0,this.keepAliveTimer=setTimeout(this.pokeKeepAlive.bind(this,t),5e3+Math.floor(5e3*Math.random())),this.updateSyncState(_.Error,{error:e}))})}mapSyncResponseToRoomArray(e){var t=this.client;return Object.keys(e).filter(e=>!(0,s.YY)(e)).map(r=>{var n=t.store.getRoom(r),i=!1;return n||(n=this.createRoom(r),i=!0),E(E({},e[r]),{},{room:n,isBrandNewRoom:i})})}mapSyncEventsFormat(e,t){var r=!(arguments.length>2)||void 0===arguments[2]||arguments[2];if(!e||!Array.isArray(e.events))return[];var n=this.client.getEventMapper({decrypt:r});return e.events.filter(s.O5).map(function(e){return t&&(e.room_id=t.roomId),n(e)})}resolveInvites(e){if(e&&this.opts.resolveInvitesToProfiles){var t=this.client;e.getMembersWithMembership(b.O.Invite).forEach(function(r){if(!r.requestedProfileInfo){r.requestedProfileInfo=!0;var n=t.getUser(r.userId);(n?Promise.resolve({avatar_url:n.avatarUrl,displayname:n.displayName}):t.getProfileInfo(r.userId)).then(function(t){var n=r.events.member;(null==n?void 0:n.getContent().membership)===b.O.Invite&&(n.getContent().avatar_url=t.avatar_url,n.getContent().displayname=t.displayname,r.setMembershipEvent(n,e.currentState))},function(e){})}})}}findEncryptionEvent(e){return null==e?void 0:e.find(e=>e.getType()===v.Bx.RoomEncryption&&""===e.getStateKey())}isRoomEncrypted(e,t){return e.hasEncryptionStateEvent()||!!this.findEncryptionEvent(t)}mapAndInjectRoomEvents(e){var t=this;return(0,n.A)(function*(){var r=t.mapSyncEventsFormat(e.state,e.room),n=t.mapSyncEventsFormat(e["org.matrix.msc4222.state_after"],e.room),i=t.mapSyncEventsFormat(e.timeline,e.room);return"org.matrix.msc4222.state_after"in e?yield t.injectRoomEvents(e.room,void 0,n,i):yield t.injectRoomEvents(e.room,r,void 0,i),{timelineEvents:i,stateEvents:r,stateAfterEvents:n}})()}injectRoomEvents(e,t,r,i){var o=arguments,a=this;return(0,n.A)(function*(){var n=o.length>4&&void 0!==o[4]&&o[4],s=null!=r?r:t,l=e.getLiveTimeline(),c=0==l.getEvents().length;if(c){for(var d of s)a.client.getPushActionsForEvent(d);l.initialiseState(s,{timelineWasEmpty:c})}a.resolveInvites(e),e.recalculate(),c||(e.oldState.setStateEvents(s),e.currentState.setStateEvents(s)),yield e.addLiveEvents(i||[],{fromCache:n,timelineWasEmpty:c,addToState:void 0===r}),a.client.processBeaconEvents(e,i)})()}processEventsForNotifs(e,t){if(this.client.getNotifTimelineSet())for(var r of t){var n,i=this.client.getPushActionsForEvent(r);null!=i&&i.notify&&null!=(n=i.tweaks)&&n.highlight&&this.notifEvents.push(r)}}getGuestFilter(){return"{}"}updateSyncState(e,t){var r=this.syncState;this.syncState=e,this.syncStateData=t,this.client.emit(d.AU.Sync,this.syncState,r,t)}}function k(e,t,r){var{timelineSupport:n}=e,i=new a.Wv(t,e,e.getUserId(),{lazyLoadMembers:r.lazyLoadMembers,pendingEventOrdering:r.pendingEventOrdering,timelineSupport:n});return e.reEmitter.reEmit(i,[a.u9.Name,a.u9.Redaction,a.u9.RedactionCancelled,a.u9.Receipt,a.u9.Tags,a.u9.LocalEchoUpdated,a.u9.AccountData,a.u9.MyMembership,a.u9.Timeline,a.u9.TimelineReset,p.f.Events,p.f.Members,p.f.NewMember,p.f.Update,g.JH.New,g.JH.Update,g.JH.Destroy,g.JH.LivenessChange]),i.on(p.f.NewMember,(t,r,n)=>{var i;n.user=null!=(i=e.getUser(n.userId))?i:void 0,e.reEmitter.reEmit(n,[m.o5.Name,m.o5.Typing,m.o5.PowerLevel,m.o5.Membership])}),i}function O(e,t){var r=[];e.map(e=>{if("m.key.verification.cancel"===e.message.type){var t=e.message.content.transaction_id;t&&r.push(t)}return e}).forEach(function(e){var n=e.message,i=n.content,o=new u.kl(Object.assign({},n));if("m.key.verification.start"===n.type||"m.key.verification.request"===n.type){var a=i.transaction_id;r.includes(a)&&o.flagCancelled()}e.encryptionInfo&&o.makeEncrypted(v.Bx.RoomMessageEncrypted,{ciphertext:""},e.encryptionInfo.senderCurve25519KeyBase64,""),t.emit(d.AU.ToDeviceEvent,o),t.emit(d.AU.ReceivedToDeviceMessage,e)})}},65920:(e,t,r)=>{"use strict";r.d(t,{K:()=>a,U:()=>o});var n=r(84458),i=r(15095),o=function(e){return e.DisplayName="User.displayName",e.AvatarUrl="User.avatarUrl",e.Presence="User.presence",e.CurrentlyActive="User.currentlyActive",e.LastPresenceTs="User.lastPresenceTs",e}({});class a extends i.X{constructor(e){super(),this.userId=e,(0,n.A)(this,"modified",-1),(0,n.A)(this,"displayName",void 0),(0,n.A)(this,"rawDisplayName",void 0),(0,n.A)(this,"avatarUrl",void 0),(0,n.A)(this,"presenceStatusMsg",void 0),(0,n.A)(this,"presence","offline"),(0,n.A)(this,"lastActiveAgo",0),(0,n.A)(this,"lastPresenceTs",0),(0,n.A)(this,"currentlyActive",!1),(0,n.A)(this,"events",{}),this.displayName=e,this.rawDisplayName=e,this.updateModifiedTime()}static createUser(e,t){var r=new a(e);return t.reEmitter.reEmit(r,[o.AvatarUrl,o.DisplayName,o.Presence,o.CurrentlyActive,o.LastPresenceTs]),r}setPresenceEvent(e){if("m.presence"===e.getType()){var t=null===this.events.presence;this.events.presence=e;var r=[];for(var n of((e.getContent().presence!==this.presence||t)&&r.push(o.Presence),e.getContent().avatar_url&&e.getContent().avatar_url!==this.avatarUrl&&r.push(o.AvatarUrl),e.getContent().displayname&&e.getContent().displayname!==this.displayName&&r.push(o.DisplayName),void 0!==e.getContent().currently_active&&e.getContent().currently_active!==this.currentlyActive&&r.push(o.CurrentlyActive),this.presence=e.getContent().presence,r.push(o.LastPresenceTs),e.getContent().status_msg&&(this.presenceStatusMsg=e.getContent().status_msg),e.getContent().displayname&&(this.displayName=e.getContent().displayname),e.getContent().avatar_url&&(this.avatarUrl=e.getContent().avatar_url),this.lastActiveAgo=e.getContent().last_active_ago,this.lastPresenceTs=Date.now(),this.currentlyActive=e.getContent().currently_active,this.updateModifiedTime(),r))this.emit(n,e,this)}}setDisplayName(e){var t=this.displayName;this.displayName=e,e!==t&&this.updateModifiedTime()}setRawDisplayName(e){this.rawDisplayName=e}setAvatarUrl(e){var t=this.avatarUrl;this.avatarUrl=e,e!==t&&this.updateModifiedTime()}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}getLastActiveTs(){return this.lastPresenceTs-this.lastActiveAgo}}},65957:(e,t,r)=>{"use strict";var n=r(81327),i=RegExp(Object.keys(n).map(function(e){return e.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")}).join("|"),"g");function o(e){return n[e]}e.exports=function(e){return e.replace(i,o)}},66866:(e,t)=>{"use strict";function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function n(e){var t="function"==typeof Map?new Map:void 0;return(n=function(e){var r;if(null===e||(r=e,-1===Function.toString.call(r).indexOf("[native code]")))return e;if("function"!=typeof e)throw TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,n)}function n(){return i(e,arguments,s(this).constructor)}return n.prototype=Object.create(e.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),a(n,e)})(e)}function i(e,t,r){return(i=o()?Reflect.construct:function(e,t,r){var n=[null];n.push.apply(n,t);var i=new(Function.bind.apply(e,n));return r&&a(i,r.prototype),i}).apply(null,arguments)}function o(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}function a(e,t){return(a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function s(e){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.InvalidEventError=void 0,t.InvalidEventError=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");i.prototype=Object.create(e&&e.prototype,{constructor:{value:i,writable:!0,configurable:!0}}),Object.defineProperty(i,"prototype",{writable:!1}),e&&a(i,e);var t,n=(t=o(),function(){var e,n=s(i);return e=t?Reflect.construct(n,arguments,s(this).constructor):n.apply(this,arguments),function(e,t){if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw TypeError("Derived constructors may only return object or undefined");var n=e;if(void 0===n)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return n}(this,e)});function i(e){if(!(this instanceof i))throw TypeError("Cannot call a class as a function");return n.call(this,e)}return Object.defineProperty(i,"prototype",{writable:!1}),i}(n(Error))},68401:(e,t,r)=>{"use strict";r.d(t,{BJ:()=>l,Et:()=>s,K0:()=>o,NY:()=>c,yB:()=>a});var n=r(19599),i=r(22993),o=new n.UnstableValue("m.message","org.matrix.msc1767.message"),a=new n.UnstableValue("m.text","org.matrix.msc1767.text"),s=new n.UnstableValue("m.html","org.matrix.msc1767.html"),l=new n.NamespacedValue("m.reference");function c(e,t){if("string"==typeof e)if("string"==typeof t)return t===e;else return t.matches(e);return"string"==typeof t?e.matches(t):t.matches(e.name)||(0,i.c)(e.altName)&&t.matches(e.altName)}},69007:(e,t,r)=>{"use strict";r.d(t,{A:()=>n,h:()=>i});var n="org.matrix.msc3077.sdp_stream_metadata",i=function(e){return e.Usermedia="m.usermedia",e.Screenshare="m.screenshare",e}({})},69103:(e,t,r)=>{"use strict";r.d(t,{E5:()=>o,LA:()=>s,b0:()=>a,hP:()=>i,qK:()=>l,xp:()=>c});var n=r(84458),i=function(e){return e.TooNew="TOO_NEW",e}({});class o extends Error{constructor(e){super("Crypto store is invalid because ".concat(e,", ")+"please stop the client, delete all data and start the client again"),this.reason=e,this.name="InvalidCryptoStoreError"}}(0,n.A)(o,"TOO_NEW",i.TooNew);class a extends Error{constructor(e,t){super(e),this.value=t}}class s extends Error{constructor(){super("MatrixClient has been stopped")}}class l extends Error{constructor(e,t){super(e),this.clientEndpoint=t,this.name="UnsupportedDelayedEventsEndpointError"}}class c extends Error{constructor(e,t){super(e),this.clientEndpoint=t,this.name="UnsupportedStickyEventsEndpointError"}}},69549:(e,t,r)=>{"use strict";r.d(t,{Il:()=>i,Nv:()=>n,oT:()=>o});var n="migrationState",i=function(e){return e[e.NOT_STARTED=0]="NOT_STARTED",e[e.INITIAL_DATA_MIGRATED=1]="INITIAL_DATA_MIGRATED",e[e.OLM_SESSIONS_MIGRATED=2]="OLM_SESSIONS_MIGRATED",e[e.MEGOLM_SESSIONS_MIGRATED=3]="MEGOLM_SESSIONS_MIGRATED",e[e.ROOM_SETTINGS_MIGRATED=4]="ROOM_SETTINGS_MIGRATED",e[e.INITIAL_OWN_KEY_QUERY_DONE=5]="INITIAL_OWN_KEY_QUERY_DONE",e}({}),o=50},70489:(e,t,r)=>{"use strict";r.d(t,{O:()=>i});var n=r(84458);class i extends Error{constructor(e,t,r){super(t),this.code=e,(0,n.A)(this,"detailedString",void 0),this.name="DecryptionError",this.detailedString=function(e,t){var r=e.name+"[msg: "+e.message;return t&&(r+=", "+Object.keys(t).map(e=>e+": "+t[e]).join(", ")),r+="]"}(this,r)}}},70593:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ModalButtonKind=void 0,t.ModalButtonKind=function(e){return e.Primary="m.primary",e.Secondary="m.secondary",e.Warning="m.warning",e.Danger="m.danger",e.Link="m.link",e}({})},71453:(e,t,r)=>{"use strict";r.d(t,{DW:()=>u,FS:()=>d,Hl:()=>a,Rc:()=>c,Vc:()=>h,a_:()=>v,eM:()=>l,up:()=>s});var n=r(84458),i=r(81626);function o(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}class a extends Error{constructor(e,t,r){super(e),this.httpStatus=t,this.httpHeaders=r}isRateLimitError(){return 429===this.httpStatus}getRetryAfterMs(){var e,t=null==(e=this.httpHeaders)?void 0:e.get("Retry-After");if(null!=t){if(/^\d+$/.test(t)){var r=1e3*Number.parseInt(t);if(!Number.isFinite(r))throw Error("Retry-After header integer value is too large");return r}var n=new Date(t);if(n.toUTCString()!==t)throw Error("Retry-After header value is not a valid HTTP-date or non-negative decimal integer");return n.getTime()-Date.now()}return null}}class s extends a{constructor(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1?arguments[1]:void 0,r=arguments.length>2?arguments[2]:void 0,i=arguments.length>3?arguments[3]:void 0,o=arguments.length>4?arguments[4]:void 0,a=e.error||"Unknown message";t&&(a="[".concat(t,"] ").concat(a)),r&&(a="".concat(a," (").concat(r,")")),super("MatrixError: ".concat(a),t,o),this.url=r,this.event=i,(0,n.A)(this,"errcode",void 0),(0,n.A)(this,"error",void 0),(0,n.A)(this,"data",void 0),this.errcode=e.errcode,this.error=e.error,this.name=e.errcode||"Unknown error code",this.data=e}isRateLimitError(){return"M_LIMIT_EXCEEDED"===this.errcode||("M_UNKNOWN"===this.errcode||void 0===this.errcode)&&super.isRateLimitError()}getRetryAfterMs(){var e=super.getRetryAfterMs();if(null!==e)return e;if("M_LIMIT_EXCEEDED"===this.errcode&&"retry_after_ms"in this.data){if(!Number.isInteger(this.data.retry_after_ms))throw Error("retry_after_ms is not an integer");return this.data.retry_after_ms}return null}asWidgetApiErrorData(){var e,t,r,i,a={};if(this.httpHeaders)for(var[s,l]of this.httpHeaders)a[s]=l;return{http_status:null!=(e=this.httpStatus)?e:400,http_headers:a,url:null!=(t=this.url)?t:"",response:function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?o(Object(r),!0).forEach(function(t){(0,n.A)(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):o(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}({errcode:null!=(r=this.errcode)?r:"M_UNKNOWN",error:null!=(i=this.data.error)?i:"Unknown message"},this.data)}}static fromWidgetApiErrorData(e){return new s(e.response,e.http_status,e.url,void 0,new Headers(e.http_headers))}}function l(e,t){if(!(e instanceof a)||!e.isRateLimitError())return t;try{var r;return null!=(r=e.getRetryAfterMs())?r:t}catch(e){return t}}class c extends Error{constructor(e,t){super(e+(t?": ".concat(t.message):""))}get name(){return"ConnectionError"}}class d extends Error{constructor(e){var t;super(null!=(t=null==e?void 0:e.message)?t:"")}get name(){return"TokenRefreshError"}}class u extends Error{constructor(e){var t;super(null!=(t=null==e?void 0:e.message)?t:"")}get name(){return"TokenRefreshLogoutError"}}var h=new i.xu(null,"ORG.MATRIX.MSC4387_SAFETY");class v extends s{constructor(){super(...arguments),(0,n.A)(this,"harms",void 0),(0,n.A)(this,"expiry",void 0);var e=arguments.length<=0?void 0:arguments[0];this.harms=new Set(e&&"harms"in e&&Array.isArray(e.harms)?e.harms:[]),this.message="".concat(super.message," (").concat([...this.harms].join(", "),")"),e&&"expiry"in e&&"number"==typeof e.expiry&&(this.expiry=new Date(e.expiry))}}},71700:(e,t,r)=>{"use strict";r.d(t,{q:()=>i});var n=r(37151);function i(e){return t=>{var r,i;return(null==(r=t.content)||null==(r=r["m.relates_to"])?void 0:r.event_id)!==e||(null==(i=t.content)||null==(i=i["m.relates_to"])?void 0:i.rel_type)===n.RN.name}}},72368:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.VideoConferenceCapabilities=t.StickerpickerCapabilities=t.MatrixCapabilities=void 0,t.getTimelineRoomIDFromCapability=function(e){return e.substring(e.indexOf(":")+1)},t.isTimelineCapability=function(e){return null==e?void 0:e.startsWith("org.matrix.msc2762.timeline:")},t.isTimelineCapabilityFor=function(e,t){return e==="org.matrix.msc2762.timeline:".concat(t)};var r=function(e){return e.Screenshots="m.capability.screenshot",e.StickerSending="m.sticker",e.AlwaysOnScreen="m.always_on_screen",e.RequiresClient="io.element.requires_client",e.MSC2931Navigate="org.matrix.msc2931.navigate",e.MSC3846TurnServers="town.robin.msc3846.turn_servers",e.MSC3973UserDirectorySearch="org.matrix.msc3973.user_directory_search",e.MSC4039UploadFile="org.matrix.msc4039.upload_file",e.MSC4039DownloadFile="org.matrix.msc4039.download_file",e.MSC4157SendDelayedEvent="org.matrix.msc4157.send.delayed_event",e.MSC4157UpdateDelayedEvent="org.matrix.msc4157.update_delayed_event",e.MSC4407SendStickyEvent="org.matrix.msc4407.send.sticky_event",e.MSC4407ReceiveStickyEvent="org.matrix.msc4407.receive.sticky_event",e}({});t.MatrixCapabilities=r,t.StickerpickerCapabilities=[r.StickerSending],t.VideoConferenceCapabilities=[r.AlwaysOnScreen]},72678:(e,t,r)=>{"use strict";r.d(t,{E:()=>o});var n=r(29301),i=r(84458);class o{constructor(){(0,i.A)(this,"accountData",new Map),(0,i.A)(this,"fromToken",null)}isNewlyCreated(){return Promise.resolve(!0)}getSyncToken(){return this.fromToken}setSyncToken(e){this.fromToken=e}storeRoom(e){}getRoom(e){return null}getRooms(){return[]}removeRoom(e){}getRoomSummaries(){return[]}storeUser(e){}getUser(e){return null}getUsers(){return[]}scrollback(e,t){return[]}setUserCreator(e){}storeEvents(e,t,r,n){}storeFilter(e){}getFilter(e,t){return null}getFilterIdByName(e){return null}setFilterIdByName(e,t){}storeAccountDataEvents(e){}getAccountData(e){}setSyncData(e){return Promise.resolve()}wantsSave(){return!1}save(){return Promise.resolve()}startup(){return Promise.resolve()}getSavedSync(){return Promise.resolve(null)}getSavedSyncToken(){return Promise.resolve(null)}deleteAllData(){return Promise.resolve()}getOutOfBandMembers(){return Promise.resolve(null)}setOutOfBandMembers(e,t){return Promise.resolve()}clearOutOfBandMembers(){return Promise.resolve()}getClientOptions(){return Promise.resolve(void 0)}storeClientOptions(e){return Promise.resolve()}getPendingEvents(e){return(0,n.A)(function*(){return[]})()}setPendingEvents(e,t){return Promise.resolve()}saveToDeviceBatches(e){return(0,n.A)(function*(){return Promise.resolve()})()}getOldestToDeviceBatch(){return Promise.resolve(null)}removeToDeviceBatch(e){return(0,n.A)(function*(){return Promise.resolve()})()}destroy(){return(0,n.A)(function*(){})()}}},74280:(e,t,r)=>{"use strict";r.d(t,{mG:()=>g,wZ:()=>y});var n=r(29301),i=r(84458),o=r(9086),a=r(5408),s=r(11749),l=r(12411);function c(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function d(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?c(Object(r),!0).forEach(function(t){(0,i.A)(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):c(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}class u{constructor(e,t,r){this.client=e,this.indexEvent=t,this.directory=r}get id(){var e=this.indexEvent.getStateKey();if(!e)throw Error("State key not found for branch");return e}get isActive(){return!0===this.indexEvent.getContent().active}get version(){var e;return null!=(e=this.indexEvent.getContent().version)?e:1}get roomId(){return this.indexEvent.getRoomId()}delete(){var e=this;return(0,n.A)(function*(){yield e.client.sendStateEvent(e.roomId,o.iK.name,{},e.id),yield e.client.redactEvent(e.roomId,e.id);var t=(yield e.getVersionHistory())[1];t&&(yield t.delete())})()}getName(){return this.indexEvent.getContent().name||"Unnamed File"}setName(e){var t=this;return(0,n.A)(function*(){yield t.client.sendStateEvent(t.roomId,o.iK.name,d(d({},t.indexEvent.getContent()),{},{name:e}),t.id)})()}isLocked(){return this.indexEvent.getContent().locked||!1}setLocked(e){var t=this;return(0,n.A)(function*(){yield t.client.sendStateEvent(t.roomId,o.iK.name,d(d({},t.indexEvent.getContent()),{},{locked:e}),t.id)})()}getFileInfo(){var e=this;return(0,n.A)(function*(){var t=(yield e.getFileEvent()).getOriginalContent().file,r=e.client.mxcUrlToHttp(t.url);if(!r)throw Error("No HTTP URL available for ".concat(t.url));return{info:t,httpUrl:r}})()}getFileEvent(){var e=this;return(0,n.A)(function*(){var t=e.client.getRoom(e.roomId);if(!t)throw Error("Unknown room");for(var r=t.getUnfilteredTimelineSet().findEventById(e.id);!r&&t.getLiveTimeline().getState(l.q.BACKWARDS).paginationToken;)yield e.client.scrollback(t,100),r=t.getUnfilteredTimelineSet().findEventById(e.id);if(!r)throw Error("Failed to find event");return yield e.client.decryptEventIfNeeded(r),r})()}createNewVersion(e,t,r,i){var a=this;return(0,n.A)(function*(){var n=yield a.directory.createFile(e,t,r,d(d({},null!=i?i:{}),{},{"m.new_content":!0,"m.relates_to":{rel_type:o.zZ.Replace,event_id:a.id}}));return yield a.client.sendStateEvent(a.roomId,o.iK.name,{active:!0,name:e,version:a.version+1},n.event_id),yield a.client.sendStateEvent(a.roomId,o.iK.name,d(d({},a.indexEvent.getContent()),{},{active:!1}),a.id),n})()}getVersionHistory(){var e=this;return(0,n.A)(function*(){var t,r=[];r.push(e);var n=e.client.getRoom(e.roomId);if(!n)throw Error("Invalid or unknown room");var i=[...n.getLiveTimeline().getEvents()].reverse(),o=yield e.getFileEvent();do if(t=i.find(e=>e.replacingEventId()===o.getId())){var a=e.directory.getFile(t.getId());if(a)r.push(a),o=t;else break}while(t);return r})()}}var h=r(36963),v=r(5294);function p(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function m(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?p(Object(r),!0).forEach(function(t){(0,i.A)(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):p(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}var g={invite:100,kick:100,ban:100,redact:50,state_default:50,events_default:50,users_default:0,events:{[o.Bx.RoomPowerLevels]:100,[o.Bx.RoomHistoryVisibility]:100,[o.Bx.RoomTombstone]:100,[o.Bx.RoomEncryption]:100,[o.Bx.RoomName]:50,[o.Bx.RoomMessage]:50,[o.Bx.RoomMessageEncrypted]:50,[o.Bx.Sticker]:50},users:{}},f=function(e){return e.Viewer="viewer",e.Editor="editor",e.Owner="owner",e}({});class y{constructor(e,t){if(this.client=e,this.roomId=t,(0,i.A)(this,"room",void 0),this.room=this.client.getRoom(this.roomId),!this.room)throw Error("Unknown room")}get id(){return this.roomId}get isTopLevel(){var e=this.room.currentState.getStateEvents(o.Bx.SpaceParent);return null==e||!e.length||e.every(e=>{var t;return!(null!=(t=e.getContent())&&t.via)})}setName(e){var t=this;return(0,n.A)(function*(){yield t.client.sendStateEvent(t.roomId,o.Bx.RoomName,{name:e},"")})()}invite(e){var t=arguments,r=this;return(0,n.A)(function*(){var n=!(t.length>1)||void 0===t[1]||t[1],i=[r.retryInvite(e)];n&&i.push(...r.getDirectories().map(t=>t.invite(e,n))),yield Promise.all(i)})()}retryInvite(e){var t=this;return(0,n.A)(function*(){yield(0,s.CC)(()=>t.client.invite(t.roomId,e),e=>!(e instanceof h.up)||"M_FORBIDDEN"!==e.errcode)})()}setPermissions(e,t){var r=this;return(0,n.A)(function*(){var n,i=r.room.currentState.getStateEvents(o.Bx.RoomPowerLevels,"");if(Array.isArray(i))throw Error("Unexpected return type for power levels");var a=(null==i?void 0:i.getContent())||{},s=a.users_default||0,l=a.events_default||50,c=(null==(n=a.events)?void 0:n[o.Bx.RoomPowerLevels])||100,d=a.users||{};switch(t){case f.Viewer:d[e]=s;break;case f.Editor:d[e]=l;break;case f.Owner:d[e]=c;break;default:throw Error("Invalid role: "+t)}a.users=d,yield r.client.sendStateEvent(r.roomId,o.Bx.RoomPowerLevels,a,"")})()}getPermissions(e){var t,r,n=this.room.currentState.getStateEvents(o.Bx.RoomPowerLevels,"");if(Array.isArray(n))throw Error("Unexpected return type for power levels");var i=(null==n?void 0:n.getContent())||{},a=i.users_default||0,s=i.events_default||50,l=(null==(t=i.events)?void 0:t[o.Bx.RoomPowerLevels])||100,c=(null==(r=i.users)?void 0:r[e])||a;return c>=l?f.Owner:c>=s?f.Editor:f.Viewer}createDirectory(e){var t=this;return(0,n.A)(function*(){var r=yield t.client.unstableCreateFileTree(e);return yield t.client.sendStateEvent(t.roomId,o.Bx.SpaceChild,{via:[t.client.getDomain()]},r.roomId),yield t.client.sendStateEvent(r.roomId,o.Bx.SpaceParent,{via:[t.client.getDomain()]},t.roomId),r})()}getDirectories(){var e=[];for(var t of this.room.currentState.getStateEvents(o.Bx.SpaceChild))try{var r=t.getStateKey();if(r){var n=this.client.unstableGetFileTreeSpace(r);n&&e.push(n)}}catch(e){a.vF.warn("Unable to create tree space instance for listing. Are we joined?",e)}return e}getDirectory(e){return this.getDirectories().find(t=>t.roomId===e)}delete(){var e=this;return(0,n.A)(function*(){for(var t of e.getDirectories())yield t.delete();var r=[v.O.Invite,v.O.Knock,v.O.Join];for(var n of e.room.currentState.getStateEvents(o.Bx.RoomMember))if(n.getStateKey()!==e.client.getUserId()&&r.includes(n.getContent().membership)){var i=n.getStateKey();if(!i)throw Error("State key not found for branch");yield e.client.kick(e.roomId,i,"Room deleted")}yield e.client.leave(e.roomId)})()}getOrderedChildren(e){var t=e.map(e=>({roomId:e.getStateKey(),order:e.getContent().order})).filter(e=>e.roomId);return t.sort((e,t)=>{if(e.order&&!t.order)return -1;if(!e.order&&t.order)return 1;if(e.order||t.order)return(0,s.aw)(e.order,t.order);var r,n,i,a,l=this.client.getRoom(e.roomId),c=this.client.getRoom(t.roomId);if(!l||!c)return(0,s.aw)(e.roomId,t.roomId);var d=null!=(r=null==(n=l.currentState.getStateEvents(o.Bx.RoomCreate,""))?void 0:n.getTs())?r:0,u=null!=(i=null==(a=c.currentState.getStateEvents(o.Bx.RoomCreate,""))?void 0:a.getTs())?i:0;return d===u?(0,s.aw)(e.roomId,t.roomId):d-u}),t}getParentRoom(){var e=this.room.currentState.getStateEvents(o.Bx.SpaceParent)[0];if(!e)throw Error("Expected to have a parent in a non-top level space");var t=e.getStateKey();if(!t)throw Error("No state key found for parent");var r=this.client.getRoom(t);if(!r)throw Error("Unable to locate room for parent");return r}getOrder(){if(this.isTopLevel)return -1;var e=this.getParentRoom().currentState.getStateEvents(o.Bx.SpaceChild);return this.getOrderedChildren(e).findIndex(e=>e.roomId===this.roomId)}setOrder(e){var t=this;return(0,n.A)(function*(){if(t.isTopLevel)throw Error("Cannot set order of top level spaces currently");var r=t.getParentRoom(),n=r.currentState.getStateEvents(o.Bx.SpaceChild),i=t.getOrderedChildren(n);e=Math.max(Math.min(e,i.length-1),0);var a=t.getOrder()<e;a&&e===i.length-1?e--:!a&&0===e&&e++;var l=i[a?e:e-1],c=i[a?e+1:e],d=s.Mf[0],u=!1;if(l)if(e===i.length-1)null!=c&&c.order&&(d=(0,s.$9)(c.order));else{var h=null==l?void 0:l.order,v=null==c?void 0:c.order;h&&v?d=h===v?(0,s.$9)(h):(0,s.sy)(h,v):h?d=(0,s.$9)(h):v?d=(0,s.zR)(v):u=!0}else null!=c&&c.order&&(d=(0,s.zR)(c.order));if(u){for(var p=0;p<=e;p++){var g=i[p];if(0===p&&(b=g.order),g.order)b=g.order;else{var f,y,b=b?(0,s.$9)(b):s.Mf[0],S=r.currentState.getStateEvents(o.Bx.SpaceChild,g.roomId),E=null!=(y=null==S?void 0:S.getContent())?y:{via:[t.client.getDomain()]};yield t.client.sendStateEvent(r.roomId,o.Bx.SpaceChild,m(m({},E),{},{order:b}),g.roomId)}}b&&(d=(0,s.$9)(b))}var _=r.currentState.getStateEvents(o.Bx.SpaceChild,t.roomId),w=null!=(f=null==_?void 0:_.getContent())?f:{via:[t.client.getDomain()]};yield t.client.sendStateEvent(r.roomId,o.Bx.SpaceChild,m(m({},w),{},{order:d}),t.roomId)})()}createFile(e,t,r,i){var a=this;return(0,n.A)(function*(){var{content_uri:n}=yield a.client.uploadContent(t,{includeFilename:!1});r.url=n;var s={msgtype:o.Wr.File,body:e,url:n,file:r};(i=null!=i?i:{})["m.new_content"]&&(i["m.new_content"]=s);var l=yield a.client.sendMessage(a.roomId,m(m(m({},i),s),{},{[o.ID.name]:{}}));return yield a.client.sendStateEvent(a.roomId,o.iK.name,{active:!0,name:e},l.event_id),l})()}getFile(e){var t=this.room.currentState.getStateEvents(o.iK.name,e);return t?new u(this.client,t,this):null}listFiles(){return this.listAllFiles().filter(e=>e.isActive)}listAllFiles(){var e;return(null!=(e=this.room.currentState.getStateEvents(o.iK.name))?e:[]).map(e=>new u(this.client,e,this))}}},74411:(e,t,r)=>{"use strict";r.d(t,{d:()=>d});var n=r(84458),i=r(19833),o=r(37151);class a{constructor(e,t){this.filterJson=e,this.userId=t}check(e){var t,r,n=(null==(t=e.getUnsigned())?void 0:t["m.relations"])||{},i=Object.keys(n),a=[];return this.userId&&null!=n&&null!=(r=n[o.RN.name])&&r.current_user_participated&&a.push(this.userId),this.checkFields(e.getRoomId(),e.getSender(),e.getType(),!!e.getContent()&&void 0!==e.getContent().url,i,a)}toJSON(){return Object.fromEntries(Object.entries({types:this.filterJson.types,not_types:this.filterJson.not_types,rooms:this.filterJson.rooms,not_rooms:this.filterJson.not_rooms,senders:this.filterJson.senders,not_senders:this.filterJson.not_senders,contains_url:this.filterJson.contains_url,[o.o1.name]:this.filterJson[o.o1.name],[o.H.name]:this.filterJson[o.H.name]}).filter(e=>{var[t,r]=e;return r}))}checkFields(e,t,r,n,i,a){var s={rooms:function(t){return e===t},senders:function(e){return t===e},types:function(e){if(!e.endsWith("*"))return r===e;var t=e.slice(0,-1);return r.slice(0,t.length)===t}};for(var l in s){var c=s[l],d="not_"+l,u=this.filterJson[d];if(null!=u&&u.some(c))return!1;var h=this.filterJson[l];if(h&&!h.some(c))return!1}var v=this.filterJson.contains_url;if(void 0!==v&&v!==n)return!1;var p=this.filterJson[o.H.name];if(void 0!==p&&!this.arrayMatchesFilter(p,i))return!1;var m=this.filterJson[o.o1.name];return void 0===m||!!this.arrayMatchesFilter(m,a)}arrayMatchesFilter(e,t){return t.length>0&&e.every(e=>t.includes(e))}filter(e){return e.filter(this.check,this)}limit(){return void 0!==this.filterJson.limit?this.filterJson.limit:10}}function s(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function l(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?s(Object(r),!0).forEach(function(t){(0,n.A)(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):s(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function c(e,t,r){for(var n=t.split("."),i=e,o=0;o<n.length-1;o++)i[n[o]]||(i[n[o]]={}),i=i[n[o]];i[n[n.length-1]]=r}class d{static fromJson(e,t,r){var n=new d(e,t);return n.setDefinition(r),n}constructor(e,t){this.userId=e,this.filterId=t,(0,n.A)(this,"definition",{}),(0,n.A)(this,"roomFilter",void 0),(0,n.A)(this,"roomTimelineFilter",void 0)}getFilterId(){return this.filterId}getDefinition(){return this.definition}setDefinition(e){this.definition=e;var t=e.room,r={};t&&(t.rooms&&(r.rooms=t.rooms),t.rooms&&(r.not_rooms=t.not_rooms)),this.roomFilter=new a(r,this.userId),this.roomTimelineFilter=new a((null==t?void 0:t.timeline)||{},this.userId)}getRoomTimelineFilterComponent(){return this.roomTimelineFilter}filterRoomTimeline(e){return this.roomFilter&&(e=this.roomFilter.filter(e)),this.roomTimelineFilter&&(e=this.roomTimelineFilter.filter(e)),e}setTimelineLimit(e){c(this.definition,"room.timeline.limit",e)}setUnreadThreadNotifications(e){var t,r;this.definition=l(l({},this.definition),{},{room:l(l({},null==(t=this.definition)?void 0:t.room),{},{timeline:l(l({},null==(r=this.definition)||null==(r=r.room)?void 0:r.timeline),{},{[i.a.name]:e})})})}setLazyLoadMembers(e){c(this.definition,"room.state.lazy_load_members",e)}setIncludeLeaveRooms(e){c(this.definition,"room.include_leave",e)}}(0,n.A)(d,"LAZY_LOADING_MESSAGES_FILTER",{lazy_load_members:!0})},75525:(e,t,r)=>{"use strict";r.d(t,{K:()=>i,Q:()=>o});var n=r(84458);class i{constructor(e){this.target=e,(0,n.A)(this,"reEmitters",new WeakMap)}reEmit(e,t){var r=this,n=this.reEmitters.get(e);n||(n=new Map,this.reEmitters.set(e,n));var i=function(t){if(n.has(t))return 1;var i=function(){if("error"!==t||0!==r.target.listenerCount("error")){for(var n=arguments.length,i=Array(n),o=0;o<n;o++)i[o]=arguments[o];r.target.emit(t,...i,e)}};e.on(t,i),n.set(t,i)};for(var o of t)if(i(o))continue}stopReEmitting(e,t){var r=this.reEmitters.get(e);if(r){for(var n of t)e.off(n,r.get(n)),r.delete(n);0===r.size&&this.reEmitters.delete(e)}}}class o extends i{constructor(e){super(e)}reEmit(e,t){super.reEmit(e,t)}stopReEmitting(e,t){super.stopReEmitting(e,t)}}},75539:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0})},76150:(e,t,r)=>{"use strict";r.d(t,{B:()=>u,N:()=>h});var n=r(29301),i=r(84458),o=r(5408),a=r(25097),s=r(9086),l=r(49699),c=r(90426),d=r(61219),u=function(e){return e.Incoming="Call.incoming",e}({});class h{constructor(e){(0,i.A)(this,"calls",void 0),(0,i.A)(this,"callEventBuffer",void 0),(0,i.A)(this,"nextSeqByCall",new Map),(0,i.A)(this,"toDeviceEventBuffers",new Map),(0,i.A)(this,"client",void 0),(0,i.A)(this,"candidateEventsByCall",void 0),(0,i.A)(this,"eventBufferPromiseChain",void 0),(0,i.A)(this,"onSync",()=>{var e=this.callEventBuffer;this.callEventBuffer=[],this.eventBufferPromiseChain?this.eventBufferPromiseChain=this.eventBufferPromiseChain.then(()=>this.evaluateEventBuffer(e)):this.eventBufferPromiseChain=this.evaluateEventBuffer(e)}),(0,i.A)(this,"onRoomTimeline",e=>{this.callEventBuffer.push(e)}),(0,i.A)(this,"onToDeviceEvent",e=>{var t=e.getContent();if(!t.call_id||(this.nextSeqByCall.has(t.call_id)||this.nextSeqByCall.set(t.call_id,0),void 0===t.seq))return void this.callEventBuffer.push(e);var r=this.nextSeqByCall.get(t.call_id)||0;if(t.seq!==r){this.toDeviceEventBuffers.has(t.call_id)||this.toDeviceEventBuffers.set(t.call_id,[]);var n=this.toDeviceEventBuffers.get(t.call_id),i=n.findIndex(e=>e.getContent().seq>t.seq);-1===i?n.push(e):n.splice(i,0,e)}else{var o=t.call_id;this.callEventBuffer.push(e),this.nextSeqByCall.set(o,t.seq+1);for(var a=this.toDeviceEventBuffers.get(o),s=a&&a.shift();s&&s.getContent().seq===this.nextSeqByCall.get(o);)this.callEventBuffer.push(s),this.nextSeqByCall.set(o,s.getContent().seq+1),s=a.shift()}}),this.client=e,this.calls=new Map,this.callEventBuffer=[],this.candidateEventsByCall=new Map}start(){this.client.on(l.AU.Sync,this.onSync),this.client.on(d.u9.Timeline,this.onRoomTimeline),this.client.on(l.AU.ToDeviceEvent,this.onToDeviceEvent)}stop(){this.client.removeListener(l.AU.Sync,this.onSync),this.client.removeListener(d.u9.Timeline,this.onRoomTimeline),this.client.removeListener(l.AU.ToDeviceEvent,this.onToDeviceEvent)}evaluateEventBuffer(e){var t=this;return(0,n.A)(function*(){yield Promise.all(e.map(e=>t.client.decryptEventIfNeeded(e)));var r=e.filter(e=>{var t=e.getType();return t.startsWith("m.call.")||t.startsWith("org.matrix.call.")}),n=new Set;for(var i of r){var a=i.getType();(a===s.Bx.CallAnswer||a===s.Bx.CallHangup)&&n.add(i.getContent().call_id)}for(var l of r){var c=l.getType(),d=l.getContent().call_id;if(!(c===s.Bx.CallInvite&&n.has(d)))try{yield t.handleCallEvent(l)}catch(e){o.vF.error("CallEventHandler evaluateEventBuffer() caught exception handling call event",e)}}})()}handleCallEvent(e){var t=this;return(0,n.A)(function*(){t.client.emit(l.AU.ReceivedVoipEvent,e);var r,n=e.getContent(),i=e.getRoomId()||(null==(S=t.client.groupCallEventHandler.getGroupCallById(n.conf_id))||null==(S=S.room)?void 0:S.roomId),d=n.conf_id,h=e.getType(),v=e.getSender(),p=n.call_id?t.calls.get(n.call_id):void 0;if(d){if(!(_=t.client.groupCallEventHandler.getGroupCallById(d)))return void o.vF.warn("CallEventHandler handleCallEvent() could not find a group call - ignoring event (groupCallId=".concat(d,", type=").concat(h,")"));if(!(E=n.device_id)){o.vF.warn("CallEventHandler handleCallEvent() could not find a device id - ignoring event (senderId=".concat(v,")")),_.emit(c.AZ.Error,new c.Iy(v));return}if(n.dest_session_id!==t.client.getSessionId())return void o.vF.warn("CallEventHandler handleCallEvent() call event does not match current session id - ignoring")}var m=v===t.client.credentials.userId&&(void 0===E||E===t.client.getDeviceId());if(i){if(h===s.Bx.CallInvite){if(m||e.getLocalAge()>n.lifetime-3e3||p&&p.state===a.iP.Ended||(p&&o.vF.warn("CallEventHandler handleCallEvent() already has a call but got an invite - clobbering (callId=".concat(n.call_id,")")),n.invitee&&n.invitee!==t.client.getUserId()))return;var g=(null!=(w=t.client.getTurnServersExpiry())?w:0)-Date.now();if(o.vF.info("CallEventHandler handleCallEvent() current turn creds expire in "+g+" ms"),!(p=null!=(T=(0,a.sv)(t.client,i,{forceTURN:t.client.forceTURN,opponentDeviceId:E,groupCallId:d,opponentSessionId:n.sender_session_id}))?T:void 0))return void o.vF.log("CallEventHandler handleCallEvent() this client does not support WebRTC (callId=".concat(n.call_id,")"));p.callId=n.call_id;var f=null==(I=_)?void 0:I.getGroupCallStats();f&&p.initStats(f);try{yield p.initWithInvite(e)}catch(e){e instanceof a.RA&&(e.code===c.BF.UnknownDevice?null==(A=_)||A.emit(c.AZ.Error,e):o.vF.error(e))}if(t.calls.set(p.callId,p),t.candidateEventsByCall.get(p.callId))for(var y of t.candidateEventsByCall.get(p.callId))p.onRemoteIceCandidatesReceived(y);for(var b of t.calls.values()){var S,E,_,w,T,I,A,R,C,k=[a.iP.WaitLocalMedia,a.iP.CreateOffer,a.iP.InviteSent].includes(b.state);if(p.roomId===b.roomId&&b.direction===a.QO.Outbound&&(null==(C=p.getOpponentMember())?void 0:C.userId)===b.invitee&&k){R=b;break}}return void(R?R.callId>p.callId?(o.vF.log("CallEventHandler handleCallEvent() detected glare - answering incoming call and canceling outgoing call (incomingId=".concat(p.callId,", outgoingId=").concat(R.callId,")")),R.replacedBy(p)):(o.vF.log("CallEventHandler handleCallEvent() detected glare - hanging up incoming call (incomingId=".concat(p.callId,", outgoingId=").concat(R.callId,")")),p.hangup(a.Il.Replaced,!0)):t.client.emit(u.Incoming,p))}if(h===s.Bx.CallCandidates){if(m)return;p?p.onRemoteIceCandidatesReceived(e):(t.candidateEventsByCall.has(n.call_id)||t.candidateEventsByCall.set(n.call_id,[]),t.candidateEventsByCall.get(n.call_id).push(e));return}if([s.Bx.CallHangup,s.Bx.CallReject].includes(h))return void(p?p.state!==a.iP.Ended&&(h===s.Bx.CallHangup?p.onHangupReceived(n):p.onRejectReceived(n),p.state===a.iP.Ended&&t.calls.delete(n.call_id)):(p=null!=(r=(0,a.sv)(t.client,i,{opponentDeviceId:E,opponentSessionId:n.sender_session_id}))?r:void 0)&&(p.callId=n.call_id,p.initWithHangup(e),t.calls.set(n.call_id,p)));if(!p||!p.hasPeerConnection)return void o.vF.info("CallEventHandler handleCallEvent() discarding possible call event as we don't have a call (type=".concat(h,")"));if(e.getContent().party_id!==p.ourPartyId)switch(h){case s.Bx.CallAnswer:m?p.state===a.iP.Ringing&&p.onAnsweredElsewhere(n):p.onAnswerReceived(e);break;case s.Bx.CallSelectAnswer:p.onSelectAnswerReceived(e);break;case s.Bx.CallNegotiate:p.onNegotiateReceived(e);break;case s.Bx.CallAssertedIdentity:case s.Bx.CallAssertedIdentityPrefix:p.onAssertedIdentityReceived(e);break;case s.Bx.CallSDPStreamMetadataChanged:case s.Bx.CallSDPStreamMetadataChangedPrefix:p.onSDPStreamMetadataChangedReceived(e)}}})()}}},76780:(e,t,r)=>{var n=r(26600),i=/%[sdv%]/g,o=function(e){var t=1,r=arguments,n=r.length;return e.replace(i,function(e){if(t>=n)return e;var i=r[t];switch(t+=1,e){case"%%":return"%";case"%s":return String(i);case"%d":return Number(i);case"%v":return""}})},a=function(e,t,r){var n=[e+"="+(t.format instanceof Function?t.format(t.push?r:r[t.name]):t.format)];if(t.names)for(var i=0;i<t.names.length;i+=1){var a=t.names[i];t.name?n.push(r[t.name][a]):n.push(r[t.names[i]])}else n.push(r[t.name]);return o.apply(null,n)},s=["v","o","s","i","u","e","p","c","b","t","r","z","a"],l=["i","c","b","a"];e.exports=function(e,t){t=t||{},null==e.version&&(e.version=0),null==e.name&&(e.name=" "),e.media.forEach(function(e){null==e.payloads&&(e.payloads="")});var r=t.outerOrder||s,i=t.innerOrder||l,o=[];return r.forEach(function(t){n[t].forEach(function(r){r.name in e&&null!=e[r.name]?o.push(a(t,r,e)):r.push in e&&null!=e[r.push]&&e[r.push].forEach(function(e){o.push(a(t,r,e))})})}),e.media.forEach(function(e){o.push(a("m",n.m[0],e)),i.forEach(function(t){n[t].forEach(function(r){r.name in e&&null!=e[r.name]?o.push(a(t,r,e)):r.push in e&&null!=e[r.push]&&e[r.push].forEach(function(e){o.push(a(t,r,e))})})})}),o.join("\r\n")+"\r\n"}},77990:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.M_POLL_START=t.M_POLL_RESPONSE=t.M_POLL_KIND_UNDISCLOSED=t.M_POLL_KIND_DISCLOSED=t.M_POLL_END=void 0;var n=r(10393);t.M_POLL_KIND_DISCLOSED=new n.UnstableValue("m.poll.disclosed","org.matrix.msc3381.poll.disclosed"),t.M_POLL_KIND_UNDISCLOSED=new n.UnstableValue("m.poll.undisclosed","org.matrix.msc3381.poll.undisclosed"),t.M_POLL_START=new n.UnstableValue("m.poll.start","org.matrix.msc3381.poll.start"),t.M_POLL_RESPONSE=new n.UnstableValue("m.poll.response","org.matrix.msc3381.poll.response"),t.M_POLL_END=new n.UnstableValue("m.poll.end","org.matrix.msc3381.poll.end")},78272:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ExtensibleEvent=void 0;t.ExtensibleEvent=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");this.wireFormat=e}return e=[{key:"wireContent",get:function(){return this.wireFormat.content}}],function(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t}()},78858:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WidgetDriver=void 0;var n=r(88767);function i(e){return(i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}t.WidgetDriver=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"validateCapabilities",value:function(e){return Promise.resolve(new Set)}},{key:"sendEvent",value:function(e,t){return arguments.length>2&&void 0!==arguments[2]&&arguments[2],arguments.length>3&&void 0!==arguments[3]&&arguments[3],Promise.reject(Error("Failed to override function"))}},{key:"sendStickyEvent",value:function(e,t,r){throw arguments.length>3&&void 0!==arguments[3]&&arguments[3],Error("Method not implemented.")}},{key:"sendDelayedEvent",value:function(e,t,r,n){return arguments.length>4&&void 0!==arguments[4]&&arguments[4],arguments.length>5&&void 0!==arguments[5]&&arguments[5],Promise.reject(Error("Failed to override function"))}},{key:"sendDelayedStickyEvent",value:function(e,t,r,n,i){throw arguments.length>5&&void 0!==arguments[5]&&arguments[5],Error("Method not implemented.")}},{key:"cancelScheduledDelayedEvent",value:function(e){return Promise.reject(Error("Failed to override function"))}},{key:"restartScheduledDelayedEvent",value:function(e){return Promise.reject(Error("Failed to override function"))}},{key:"sendScheduledDelayedEvent",value:function(e){return Promise.reject(Error("Failed to override function"))}},{key:"sendToDevice",value:function(e,t,r){return Promise.reject(Error("Failed to override function"))}},{key:"readRoomAccountData",value:function(e){return arguments.length>1&&void 0!==arguments[1]&&arguments[1],Promise.resolve([])}},{key:"readRoomEvents",value:function(e,t,r){return arguments.length>3&&void 0!==arguments[3]&&arguments[3],arguments.length>4&&arguments[4],Promise.resolve([])}},{key:"readStateEvents",value:function(e,t,r){return arguments.length>3&&void 0!==arguments[3]&&arguments[3],Promise.resolve([])}},{key:"readStickyEvents",value:function(e){throw Error("readStickyEvents is not implemented")}},{key:"readRoomTimeline",value:function(e,t,r,n,i,o){return void 0===n?this.readRoomEvents(t,r,i,[e],o):this.readStateEvents(t,n,i,[e])}},{key:"readRoomState",value:function(e,t,r){return this.readStateEvents(t,r,Number.MAX_SAFE_INTEGER,[e])}},{key:"readEventRelations",value:function(e,t,r,n,i,o,a,s){return Promise.resolve({chunk:[]})}},{key:"askOpenID",value:function(e){e.update({state:n.OpenIDRequestState.Blocked})}},{key:"navigate",value:function(e){throw Error("Navigation is not implemented")}},{key:"getTurnServers",value:function(){throw Error("TURN server support is not implemented")}},{key:"searchUserDirectory",value:function(e,t){return Promise.resolve({limited:!1,results:[]})}},{key:"getMediaConfig",value:function(){throw Error("Get media config is not implemented")}},{key:"uploadFile",value:function(e){throw Error("Upload file is not implemented")}},{key:"downloadFile",value:function(e){throw Error("Download file is not implemented")}},{key:"getKnownRooms",value:function(){throw Error("Querying known rooms is not implemented")}},{key:"processError",value:function(e){}}],function(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,function(e){var t=function(e,t){if("object"!==i(e)||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,t||"default");if("object"!==i(n))return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"===i(t)?t:String(t)}(n.key),n)}}(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t}()},79178:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Symbols=void 0,t.Symbols=function(e){return e.AnyRoom="*",e}({})},79404:(e,t,r)=>{"use strict";function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.PollStartEvent=t.PollAnswerSubevent=void 0;var i=r(77990),o=r(62404),a=r(47406),s=r(66866),l=r(10393),c=r(52337),d=r(78272);function u(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}function h(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function v(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}function p(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function m(e,t,r){return t&&p(e.prototype,t),r&&p(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function g(e,t){if("function"!=typeof t&&null!==t)throw TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&f(e,t)}function f(e,t){return(f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function y(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();return function(){var r,i=S(e);return r=t?Reflect.construct(i,arguments,S(this).constructor):i.apply(this,arguments),function(e,t){if(t&&("object"===n(t)||"function"==typeof t))return t;if(void 0!==t)throw TypeError("Derived constructors may only return object or undefined");return b(e)}(this,r)}}function b(e){if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function S(e){return(S=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function E(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var _=function(e){g(r,e);var t=y(r);function r(e){v(this,r),E(b(n=t.call(this,e)),"id",void 0);var n,i=e.content.id;if(!i||"string"!=typeof i)throw new s.InvalidEventError("Answer ID must be a non-empty string");return n.id=i,n}return m(r,[{key:"serialize",value:function(){return{type:"org.matrix.sdk.poll.answer",content:function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?h(Object(r),!0).forEach(function(t){E(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):h(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}({id:this.id},this.serializeMMessageOnly())}}}],[{key:"from",value:function(e,t){return new r({type:"org.matrix.sdk.poll.answer",content:E({id:e},a.M_TEXT.name,t)})}}]),r}(o.MessageEvent);t.PollAnswerSubevent=_,t.PollStartEvent=function(e){g(r,e);var t=y(r);function r(e){v(this,r),E(b(n=t.call(this,e)),"question",void 0),E(b(n),"kind",void 0),E(b(n),"rawKind",void 0),E(b(n),"maxSelections",void 0),E(b(n),"answers",void 0);var n,a=i.M_POLL_START.findIn(n.wireContent);if(!a.question)throw new s.InvalidEventError("A question is required");if(n.question=new o.MessageEvent({type:"org.matrix.sdk.poll.question",content:a.question}),n.rawKind=a.kind,i.M_POLL_KIND_DISCLOSED.matches(n.rawKind)?n.kind=i.M_POLL_KIND_DISCLOSED:n.kind=i.M_POLL_KIND_UNDISCLOSED,n.maxSelections=Number.isFinite(a.max_selections)&&a.max_selections>0?a.max_selections:1,!Array.isArray(a.answers))throw new s.InvalidEventError("Poll answers must be an array");var l=a.answers.slice(0,20).map(function(e){return new _({type:"org.matrix.sdk.poll.answer",content:e})});if(l.length<=0)throw new s.InvalidEventError("No answers available");return n.answers=l,n}return m(r,[{key:"isEquivalentTo",value:function(e){return(0,c.isEventTypeSame)(e,i.M_POLL_START)}},{key:"serialize",value:function(){var e;return{type:i.M_POLL_START.name,content:(E(e={},i.M_POLL_START.name,{question:this.question.serialize().content,kind:this.rawKind,max_selections:this.maxSelections,answers:this.answers.map(function(e){return e.serialize().content})}),E(e,a.M_TEXT.name,"".concat(this.question.text,"\n").concat(this.answers.map(function(e,t){return"".concat(t+1,". ").concat(e.text)}).join("\n"))),e)}}}],[{key:"from",value:function(e,t,n){var o,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;return new r({type:i.M_POLL_START.name,content:(E(o={},a.M_TEXT.name,e),E(o,i.M_POLL_START.name,{question:E({},a.M_TEXT.name,e),kind:n instanceof l.NamespacedValue?n.name:n,max_selections:s,answers:t.map(function(e){var t;return E({id:((function(e){if(Array.isArray(e))return u(e)})(t=Array(16))||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(t)||function(e,t){if(e){if("string"==typeof e)return u(e,void 0);var r=Object.prototype.toString.call(e).slice(8,-1);if("Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return u(e,t)}}(t)||function(){throw TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()).map(function(){return w.charAt(Math.floor(Math.random()*w.length))}).join("")},a.M_TEXT.name,e)})}),o)})}}]),r}(d.ExtensibleEvent);var w="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"},80578:(e,t,r)=>{"use strict";r.d(t,{m:()=>u,x:()=>d});var n,i=r(84458),o=r(12411),a=r(5408),s=r(61219),l=r(15095),c=r(56118);n=a.vF.log.bind(a.vF);var d=function(e){return e.Ignore="ignore",e.Replace="replace",e}({});class u extends l.X{constructor(e){var t,r,n,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},s=arguments.length>2?arguments[2]:void 0,l=arguments.length>3?arguments[3]:void 0,d=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;super(),this.room=e,this.thread=l,this.threadListType=d,(0,i.A)(this,"relations",void 0),(0,i.A)(this,"timelineSupport",void 0),(0,i.A)(this,"displayPendingEvents",void 0),(0,i.A)(this,"liveTimeline",void 0),(0,i.A)(this,"timelines",void 0),(0,i.A)(this,"_eventIdToTimeline",new Map),(0,i.A)(this,"filter",void 0),this.timelineSupport=!!a.timelineSupport,this.liveTimeline=new o.q(this),this.displayPendingEvents=!1!==a.pendingEvents,this.timelines=[this.liveTimeline],this._eventIdToTimeline=new Map,this.filter=a.filter,this.relations=null!=(t=null==(r=this.room)?void 0:r.relations)?t:new c.t(null!=(n=null==e?void 0:e.client)?n:s)}getTimelines(){return this.timelines}getFilter(){return this.filter}setFilter(e){this.filter=e}getPendingEvents(){return this.room&&this.displayPendingEvents?this.room.getPendingEvents():[]}getLiveTimeline(){return this.liveTimeline}setLiveTimeline(e){this.liveTimeline=e}eventIdToTimeline(e){return this._eventIdToTimeline.get(e)}replaceEventId(e,t){var r=this._eventIdToTimeline.get(e);r&&(this._eventIdToTimeline.delete(e),this._eventIdToTimeline.set(t,r))}resetLiveTimeline(e,t){var r=!this.timelineSupport||!t,n=this.liveTimeline,i=r?n.forkLive(o.q.FORWARDS):n.fork(o.q.FORWARDS);r?(this.timelines=[i],this._eventIdToTimeline=new Map):this.timelines.push(i),t&&n.setPaginationToken(t,o.q.FORWARDS),i.setPaginationToken(null!=e?e:null,o.q.BACKWARDS),this.liveTimeline=i,this.emit(s.u9.TimelineReset,this.room,this,r)}getTimelineForEvent(e){if(null==e)return null;var t=this._eventIdToTimeline.get(e);return void 0===t?null:t}findEventById(e){var t=this.getTimelineForEvent(e);if(t)return t.getEvents().find(function(t){return t.getId()==e})}addTimeline(){if(!this.timelineSupport)throw Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");var e=new o.q(this);return this.timelines.push(e),e}addEventsToTimeline(e,t,r,i,s){if(!i)throw Error("'timeline' not specified for EventTimelineSet.addEventsToTimeline");if(!t&&i==this.liveTimeline)throw Error("EventTimelineSet.addEventsToTimeline cannot be used for adding events to the live timeline - use Room.addLiveEvents instead");if(!this.filter||(e=this.filter.filterRoomTimeline(e)).length){var l=t?o.q.BACKWARDS:o.q.FORWARDS,c=t?o.q.FORWARDS:o.q.BACKWARDS,d=!1,u=!1;for(var h of e){var v=h.getId(),p=this._eventIdToTimeline.get(v);if(!p){this.addEventToTimeline(h,i,{toStartOfTimeline:t,addToState:r}),u=!0,d=!0;continue}if(u=!1,p==i){n("Event "+v+" already in timeline "+i);continue}var m=i.getNeighbouringTimeline(l);if(m){p==m?n("Event "+v+" in neighbouring timeline - switching to "+p):n("Event "+v+" already in a different timeline "+p),i=p;continue}a.vF.info("Already have timeline for "+v+" - joining timeline "+i+" to "+p);var g=p===this.liveTimeline,f=i===this.liveTimeline,y=l===o.q.BACKWARDS&&g,b=l===o.q.FORWARDS&&f;if(y||b){y&&a.vF.warn("Refusing to set a preceding existingTimeLine on our timeline as the existingTimeLine is live ("+p+")"),b&&a.vF.warn("Refusing to set our preceding timeline on a existingTimeLine as our timeline is live ("+i+")");continue}i.setNeighbouringTimeline(p,l),p.setNeighbouringTimeline(i,c),i=p,d=!0}if(u||!d){if(l===o.q.FORWARDS&&i===this.liveTimeline){a.vF.warn({lastEventWasNew:u,didUpdate:d}),a.vF.warn("Refusing to set forwards pagination token of live timeline "+"".concat(i," to ").concat(s));return}i.setPaginationToken(null!=s?s:null,l)}}}addLiveEvent(e,t){var{duplicateStrategy:r,fromCache:i,roomState:a,timelineWasEmpty:s,addToState:l}=t;if(!this.filter||this.filter.filterRoomTimeline([e]).length){var c=this._eventIdToTimeline.get(e.getId());if(c){if(r===d.Replace){n("EventTimelineSet.addLiveEvent: replacing duplicate event "+e.getId());for(var u=c.getEvents(),h=0;h<u.length;h++)if(u[h].getId()===e.getId()){a||(a=c.getState(o.q.FORWARDS)),o.q.setEventMetadata(e,a,!1),u[h]=e;break}}else n("EventTimelineSet.addLiveEvent: ignoring duplicate event "+e.getId());return}this.addEventToTimeline(e,this.liveTimeline,{toStartOfTimeline:!1,fromCache:i,roomState:a,timelineWasEmpty:s,addToState:l})}}addEventToTimeline(e,t,r){var{toStartOfTimeline:n,fromCache:i=!1,roomState:o,timelineWasEmpty:l,addToState:c}=r;if(t.getTimelineSet()!==this)throw Error("EventTimelineSet.addEventToTimeline: Timeline=".concat(t.toString(),' does not belong " +\n                "in timelineSet(threadId=').concat(null==(u=this.thread)?void 0:u.id,")"));var d=e.getId();if(this.relations.aggregateParentEvent(e),this.relations.aggregateChildEvent(e,this),this.room&&!this.canContain(e)){var u,h,v="event=".concat(d);e.threadRootId&&(v+="(belongs to thread=".concat(e.threadRootId,")")),a.vF.warn("EventTimelineSet.addEventToTimeline: Ignoring ".concat(v," that does not belong ")+"in timeline=".concat(t.toString()," timelineSet(threadId=").concat(null==(h=this.thread)?void 0:h.id,")"));return}t.addEvent(e,{toStartOfTimeline:n,roomState:o,timelineWasEmpty:l,addToState:c}),this._eventIdToTimeline.set(d,t);var p={timeline:t,liveEvent:!n&&t==this.liveTimeline&&!i};this.emit(s.u9.Timeline,e,this.room,!!n,!1,p)}insertEventIntoTimeline(e,t,r,n){if(t.getTimelineSet()!==this)throw Error("EventTimelineSet.insertEventIntoTimeline: Timeline=".concat(t.toString(),' does not belong " +\n                "in timelineSet(threadId=').concat(null==(o=this.thread)?void 0:o.id,")"));var i=e.getId();if(this.relations.aggregateParentEvent(e),this.relations.aggregateChildEvent(e,this),this.room&&!this.canContain(e)){var o,l,c="event=".concat(i);e.threadRootId&&(c+="(belongs to thread=".concat(e.threadRootId,")")),a.vF.warn("EventTimelineSet.insertEventIntoTimeline: Ignoring ".concat(c," that does not belong ")+"in timeline=".concat(t.toString()," timelineSet(threadId=").concat(null==(l=this.thread)?void 0:l.id,")"));return}var d=e.relationEventId;if(!d)return void this.addEventToTimeline(e,t,{toStartOfTimeline:!1,fromCache:!1,timelineWasEmpty:!1,roomState:r,addToState:n});for(var u=this.findEventById(d),h=t.getEvents(),v=void 0!==u?h.indexOf(u):0;v<h.length&&!(h[v].getTs()>e.getTs());v++);t.insertEvent(e,v,r,n),this._eventIdToTimeline.set(i,t),this.emit(s.u9.Timeline,e,this.room,!1,!1,{timeline:t,liveEvent:!1})}handleRemoteEcho(e,t,r){var n=this._eventIdToTimeline.get(t);n?(this._eventIdToTimeline.delete(t),this._eventIdToTimeline.set(r,n)):(!this.filter||this.filter.filterRoomTimeline([e]).length)&&this.addEventToTimeline(e,this.liveTimeline,{toStartOfTimeline:!1,addToState:!1})}removeEvent(e){var t=this._eventIdToTimeline.get(e);if(!t)return null;var r=t.removeEvent(e);return r&&(this._eventIdToTimeline.delete(e),this.emit(s.u9.Timeline,r,this.room,void 0,!0,{timeline:t})),r}compareEventOrdering(e,t){if(e==t)return 0;var r=this._eventIdToTimeline.get(e),n=this._eventIdToTimeline.get(t);if(void 0===r||void 0===n)return null;if(r===n){for(var i=void 0,a=void 0,s=r.getEvents(),l=0;l<s.length&&(void 0===i||void 0===a);l++){var c=s[l].getId();c==e&&(i=l),c==t&&(a=l)}var d=i-a;return d<0?-1:+(d>0)}for(var u=r;u;){if(u===n)return -1;u=u.getNeighbouringTimeline(o.q.FORWARDS)}for(u=r;u;){if(u===n)return 1;u=u.getNeighbouringTimeline(o.q.BACKWARDS)}return null}canContain(e){if(!this.room)throw Error("Cannot call `EventTimelineSet::canContain without a `room` set. Set the room when creating the EventTimelineSet to call this method.");var t,{threadId:r,shouldLiveInRoom:n,shouldLiveInThread:i}=this.room.eventShouldLiveIn(e);return this.thread?this.thread.id===r:(n||i||a.vF.warn("EventTimelineSet:canContain event encountered which cannot be added to any timeline roomId=".concat(null==(t=this.room)?void 0:t.roomId," eventId=").concat(e.getId()," threadId=").concat(e.threadRootId)),n)}}},80646:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LEGACY_M_ROOM_MESSAGE=void 0,t.parseMRoomMessage=function(e){if(s.M_MESSAGE.findIn(e.content)||s.M_TEXT.findIn(e.content))return new n.MessageEvent(e);var t,r,a,l,u,h,v=null==(t=e.content)?void 0:t.msgtype,p=null==(r=e.content)?void 0:r.body,m=(null==(a=e.content)?void 0:a.format)==="org.matrix.custom.html"?e.content.formatted_body:null;return"m.text"===v?new n.MessageEvent(c(c({},e),{},{content:c(c({},e.content),{},(d(l={},s.M_TEXT.name,p),d(l,s.M_HTML.name,m),l))})):"m.notice"===v?new i.NoticeEvent(c(c({},e),{},{content:c(c({},e.content),{},(d(u={},s.M_TEXT.name,p),d(u,s.M_HTML.name,m),u))})):"m.emote"===v?new o.EmoteEvent(c(c({},e),{},{content:c(c({},e.content),{},(d(h={},s.M_TEXT.name,p),d(h,s.M_HTML.name,m),h))})):null};var n=r(62404),i=r(57023),o=r(98597),a=r(10393),s=r(47406);function l(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function c(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?l(Object(r),!0).forEach(function(t){d(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):l(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function d(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}t.LEGACY_M_ROOM_MESSAGE=new a.NamespacedValue("m.room.message")},81327:e=>{"use strict";e.exports=JSON.parse('{"0":"O","1":"l","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD805\uDCBF":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD804\uDF00":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD804\uDDCA":"","\uD805\uDCC3":"","\uD802\uDE3A":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD805\uDCC1":"","":"","":"","":"","":"","":"","":"","\\u2028":" ","\\u2029":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","\xa0":" ","":" ","":" ","":"_","":"_","":"_","":"_","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-.","":"","":",","":",","":",","\xb8":",","":",","":"","":"","":";","":"","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":"::=","":":","":"!","":"!","":"!","":"!!","":"!?","":"?","":"?","":"?","":"?","":"?","":"?!","":"??","":"","\uD834\uDD6D":".","":".","":".","":".","":".","\uD802\uDE50":".","":".","":".","":".","":".,","":"..","":"..","":"...","":"","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","\uD800\uDD01":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7\xb7\xb7","":"\xb7\xb7\xb7","":"\xb7<","":"\xb7>","":"\xb7>","":"\xb7>","":"\xb74","":"\xb7b","":"\xb7b","":"\xb7d","":"\xb7J","":"\xb7L","":"\xb7P","":"\xb7U","":"\xb7V","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"","":"","":"","":"","":"","":"","":"","\uD802\uDE57":"\uD802\uDE56\uD802\uDE56","\uD805\uDC4C":"\uD805\uDC4B\uD805\uDC4B","\uD805\uDE42":"\uD805\uDE41\uD805\uDE41","\uD807\uDC42":"\uD807\uDC41\uD807\uDC41","":"","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","`":"\'","":"\'","":"\'","\xb4":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","\uD81B\uDF51":"\'","\uD81B\uDF52":"\'","":"\'\'","\\"":"\'\'","":"\'\'","":"\'\'","":"\'\'","":"\'\'","":"\'\'","":"\'\'","":"\'\'","":"\'\'","":"\'\'","":"\'\'","":"\'\'","":"\'\'","":"\'\'","":"\'\'\'","":"\'\'\'","":"\'\'\'\'","":"\'B","":"\'D","":"\'n","":"\'P","":"\'T","":"\'Y","":"(","":"(","":"(","":"(","":"(","":"((","":"()","":"(2)","":"(2O)","":"(3)","":"(4)","":"(5)","":"(6)","":"(7)","":"(8)","":"(9)","":"(a)","\uD83C\uDD10":"(A)","":"(b)","\uD83C\uDD11":"(B)","":"(c)","\uD83C\uDD12":"(C)","":"(d)","\uD83C\uDD13":"(D)","":"(e)","\uD83C\uDD14":"(E)","":"(f)","\uD83C\uDD15":"(F)","":"(g)","\uD83C\uDD16":"(G)","":"(h)","\uD83C\uDD17":"(H)","":"(i)","":"(j)","\uD83C\uDD19":"(J)","":"(k)","\uD83C\uDD1A":"(K)","":"(l)","\uD83C\uDD18":"(l)","":"(l)","\uD83C\uDD1B":"(L)","":"(l2)","":"(l3)","":"(l4)","":"(l5)","":"(l6)","":"(l7)","":"(l8)","":"(l9)","":"(ll)","":"(lO)","\uD83C\uDD1C":"(M)","":"(n)","\uD83C\uDD1D":"(N)","":"(o)","\uD83C\uDD1E":"(O)","":"(p)","\uD83C\uDD1F":"(P)","":"(q)","\uD83C\uDD20":"(Q)","":"(r)","\uD83C\uDD21":"(R)","":"(rn)","":"(s)","\uD83C\uDD22":"(S)","\uD83C\uDD2A":"(S)","":"(t)","\uD83C\uDD23":"(T)","":"(u)","\uD83C\uDD24":"(U)","":"(v)","\uD83C\uDD25":"(V)","":"(w)","\uD83C\uDD26":"(W)","":"(x)","\uD83C\uDD27":"(X)","":"(y)","\uD83C\uDD28":"(Y)","":"(z)","\uD83C\uDD29":"(Z)","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","\uD83C\uDE41":"()","":"()","":"()","\uD83C\uDE42":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","\uD83C\uDE47":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","\uD83C\uDE43":"()","\uD83C\uDE45":"()","\uD83C\uDE48":"()","":"()","":"()","":"()","":"()","\uD83C\uDE40":"()","":"()","":"()","":"()","\uD83C\uDE44":"()","":"()","\uD83C\uDE46":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":")","":")","":")","":")","":")","":"))","":"{","\uD834\uDD14":"{","":"}","":"","":"","":"","":"","":"","":"","":"","\uD847\uDFE8":"","":"","":"","":"","":"","":"\xb6","":"*","":"*","":"*","\uD800\uDF1F":"*","":"/","":"/","":"/","":"/","":"/","":"/","":"/","\uD834\uDE3A":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"//","":"///","":"\\\\","":"\\\\","":"\\\\","":"\\\\","":"\\\\","":"\\\\","\uD834\uDE0F":"\\\\","\uD834\uDE3B":"\\\\","":"\\\\","":"\\\\","":"\\\\","":"\\\\\\\\","":"\\\\\\\\","":"\\\\","":"&","":"","\uD804\uDCBB":"","\uD804\uDDC7":"","":"","\uD804\uDDDB":"","":"","":"","":"","":"","":"","":"^","":"^","":"","":"","":"","":"","":"","":"","":"","\xaf":"","":"","":"","":"b","":"bi","":"","":"","":"","":"","":"","":"\xb0","":"\xb0","":"\xb0","":"\xb0","":"\xb0","":"\xb0","":"\xb0","":"\xb0C","":"\xb0F","":"","":"","":"","":"","":"","":"\xa9","":"\xae","":"","\uD834\uDE1B":"","":"","":"","":"","":"","":"","":"","":"","\uD835\uDEDB":"","\uD835\uDF15":"","\uD835\uDF4F":"","\uD835\uDF89":"","\uD835\uDFC3":"","\uD83A\uDCCC":"","\uD83A\uDCCD":"","\xf0":"","":"","\uD835\uDEC1":"","\uD835\uDEFB":"","\uD835\uDF35":"","\uD835\uDF6F":"","\uD835\uDFA9":"","\uD806\uDCA8":"","":"","":"","":"","":"","":"","":"+","":"+","\uD800\uDE9B":"+","":"+","":"+","":"+","":"+","":"+","":"+","":"+","":"\xf7","":"<","":"<","":"<","\uD834\uDE36":"<","":"<","":"<","":"<\xb7","":"<\xb7","":"<\xb7","":"<<","":"<<<","":"=","":"=","":"=","":"=","":"=","":"=","":"=","":"=","":"=","":"=","":"==","":"===","":"=","":">","":">","":">","\uD834\uDE37":">","":">","\uD81B\uDF3F":">","":">\xb7","":"><","":">>","":">>","":">>>","":"~","":"~","":"~","":"~","":"~","":"~","":"~","":"~","\uD83A\uDCC8":"","":"","":"","":"","":"","":"","":"","\uD804\uDDDE":"","":"","\uD83D\uDF5E":"","":"","":"","":"","\uD834\uDE38":"","\uD834\uDE39":"","":"","":"","":"","":"","\uD83D\uDF71":"","\uD83D\uDF55":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD83D\uDF0A":"","\uD83C\uDF12":"","\uD83C\uDF19":"","":"","\uD83C\uDF18":"","":"","\uD83D\uDF3A":"","":"","\uD800\uDDA0":"","":"\uD834\uDD58\uD834\uDD65","":"\uD834\uDD58\uD834\uDD65\uD834\uDD6E","":"\uD83C\uDD0D","":"\uD83C\uDD0E","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD83C\uDD0F":"$","":"\xa3","":"","":"","":"","":"","\uD805\uDCD1":"","":"","":"","":"","":"","":"","\uD835\uDFD0":"2","\uD835\uDFDA":"2","\uD835\uDFE4":"2","\uD835\uDFEE":"2","\uD835\uDFF8":"2","\uD83E\uDFF2":"2","":"2","":"2","":"2","":"2","":"2","":"2","":"","":"","":"","\uD805\uDCD2":"","":"","":"","":"2","\uD83C\uDD03":"2,","":"2.","":"22","":"22","":"23","":"23","":"24","":"24","":"25","":"26","":"27","":"28","":"29","":"2l","":"2l","":"2O.","":"2O","":"2O","":"","":"","":"2","":"2","":"2","\uD834\uDE06":"3","\uD835\uDFD1":"3","\uD835\uDFDB":"3","\uD835\uDFE5":"3","\uD835\uDFEF":"3","\uD835\uDFF9":"3","\uD83E\uDFF3":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"3","\uD81B\uDF3B":"3","\uD806\uDCCA":"3","":"","\uD83A\uDCC9":"","":"","":"","":"3","\uD83C\uDD04":"3,","":"3.","":"3l","":"3O","":"3","":"3","":"3","\uD835\uDFD2":"4","\uD835\uDFDC":"4","\uD835\uDFE6":"4","\uD835\uDFF0":"4","\uD835\uDFFA":"4","\uD83E\uDFF4":"4","":"4","\uD806\uDCAF":"4","":"","":"","":"","\uD83C\uDD05":"4,","":"4.","":"4\xb7","":"4","":"4","":"4","\uD835\uDFD3":"5","\uD835\uDFDD":"5","\uD835\uDFE7":"5","\uD835\uDFF1":"5","\uD835\uDFFB":"5","\uD83E\uDFF5":"5","":"5","\uD806\uDCBB":"5","":"","\uD83C\uDD06":"5,","":"5.","":"5","":"5","":"5","\uD835\uDFD4":"6","\uD835\uDFDE":"6","\uD835\uDFE8":"6","\uD835\uDFF2":"6","\uD835\uDFFC":"6","\uD83E\uDFF6":"6","":"6","":"6","":"6","\uD806\uDCD5":"6","":"","\uD805\uDCD6":"","":"","\uD83C\uDD07":"6,","":"6.","":"6","":"6","":"6","\uD834\uDE12":"7","\uD835\uDFD5":"7","\uD835\uDFDF":"7","\uD835\uDFE9":"7","\uD835\uDFF3":"7","\uD835\uDFFD":"7","\uD83E\uDFF7":"7","\uD801\uDCD2":"7","\uD806\uDCC6":"7","":"","\uD83C\uDD08":"7,","":"7.","":"7","":"7","":"7","":"8","":"8","":"8","\uD83A\uDCCB":"8","\uD835\uDFD6":"8","\uD835\uDFE0":"8","\uD835\uDFEA":"8","\uD835\uDFF4":"8","\uD835\uDFFE":"8","\uD83E\uDFF8":"8","":"8","":"8","\uD800\uDF1A":"8","":"","":"","\uD83C\uDD09":"8,","":"8.","":"8","":"8","":"8","":"9","":"9","":"9","":"9","\uD835\uDFD7":"9","\uD835\uDFE1":"9","\uD835\uDFEB":"9","\uD835\uDFF5":"9","\uD835\uDFFF":"9","\uD83E\uDFF9":"9","":"9","":"9","\uD806\uDCCC":"9","\uD806\uDCAC":"9","\uD806\uDCD6":"9","":"","\uD806\uDCE4":"","":"","":"","":"","\uD83C\uDD0A":"9,","":"9.","":"9","":"9","":"9","":"a","":"a","\uD835\uDC1A":"a","\uD835\uDC4E":"a","\uD835\uDC82":"a","\uD835\uDCB6":"a","\uD835\uDCEA":"a","\uD835\uDD1E":"a","\uD835\uDD52":"a","\uD835\uDD86":"a","\uD835\uDDBA":"a","\uD835\uDDEE":"a","\uD835\uDE22":"a","\uD835\uDE56":"a","\uD835\uDE8A":"a","":"a","":"a","\uD835\uDEC2":"a","\uD835\uDEFC":"a","\uD835\uDF36":"a","\uD835\uDF70":"a","\uD835\uDFAA":"a","":"a","":"","":"A","\uD835\uDC00":"A","\uD835\uDC34":"A","\uD835\uDC68":"A","\uD835\uDC9C":"A","\uD835\uDCD0":"A","\uD835\uDD04":"A","\uD835\uDD38":"A","\uD835\uDD6C":"A","\uD835\uDDA0":"A","\uD835\uDDD4":"A","\uD835\uDE08":"A","\uD835\uDE3C":"A","\uD835\uDE70":"A","":"A","\uD835\uDEA8":"A","\uD835\uDEE2":"A","\uD835\uDF1C":"A","\uD835\uDF56":"A","\uD835\uDF90":"A","":"A","":"A","":"A","":"A","\uD81B\uDF40":"A","\uD800\uDEA0":"A","":"a","":"","":"","":"\xe5","":"\xc5","":"","":"a/c","":"a/s","":"aa","":"AA","\xe6":"ae","":"ae","\xc6":"AE","":"AE","":"ao","":"AO","\uD83D\uDF07":"AR","":"au","":"AU","":"av","":"av","":"AV","":"AV","":"ay","":"AY","":"","":"","\uD834\uDE17":"","":"","":"","\uD801\uDC1F":"","\uD835\uDC1B":"b","\uD835\uDC4F":"b","\uD835\uDC83":"b","\uD835\uDCB7":"b","\uD835\uDCEB":"b","\uD835\uDD1F":"b","\uD835\uDD53":"b","\uD835\uDD87":"b","\uD835\uDDBB":"b","\uD835\uDDEF":"b","\uD835\uDE23":"b","\uD835\uDE57":"b","\uD835\uDE8B":"b","":"b","":"b","":"b","":"b","":"b","":"B","":"B","\uD835\uDC01":"B","\uD835\uDC35":"B","\uD835\uDC69":"B","\uD835\uDCD1":"B","\uD835\uDD05":"B","\uD835\uDD39":"B","\uD835\uDD6D":"B","\uD835\uDDA1":"B","\uD835\uDDD5":"B","\uD835\uDE09":"B","\uD835\uDE3D":"B","\uD835\uDE71":"B","":"B","":"B","\uD835\uDEA9":"B","\uD835\uDEE3":"B","\uD835\uDF1D":"B","\uD835\uDF57":"B","\uD835\uDF91":"B","":"B","":"B","":"B","":"B","\uD800\uDE82":"B","\uD800\uDEA1":"B","\uD800\uDF01":"B","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b\xb7","":"b\xb7","":"b\'","":"bl","":"","":"","":"c","":"c","\uD835\uDC1C":"c","\uD835\uDC50":"c","\uD835\uDC84":"c","\uD835\uDCB8":"c","\uD835\uDCEC":"c","\uD835\uDD20":"c","\uD835\uDD54":"c","\uD835\uDD88":"c","\uD835\uDDBC":"c","\uD835\uDDF0":"c","\uD835\uDE24":"c","\uD835\uDE58":"c","\uD835\uDE8C":"c","":"c","":"c","":"c","":"c","":"c","\uD801\uDC3D":"c","":"","\uD83D\uDF4C":"C","\uD806\uDCF2":"C","\uD806\uDCE9":"C","":"C","":"C","":"C","":"C","\uD835\uDC02":"C","\uD835\uDC36":"C","\uD835\uDC6A":"C","\uD835\uDC9E":"C","\uD835\uDCD2":"C","\uD835\uDD6E":"C","\uD835\uDDA2":"C","\uD835\uDDD6":"C","\uD835\uDE0A":"C","\uD835\uDE3E":"C","\uD835\uDE72":"C","":"C","":"C","":"C","":"C","":"C","\uD800\uDEA2":"C","\uD800\uDF02":"C","\uD801\uDC15":"C","\uD801\uDD1C":"C","\xa2":"c","":"c","":"C","\uD83C\uDD6E":"C","\xe7":"c","":"c","\xc7":"C","":"C","":"C\'","":"c/o","":"c/u","\uD83C\uDD6D":"\\t","":"","":"","":"","":"","\uD835\uDEC6":"","\uD835\uDEDC":"","\uD835\uDF00":"","\uD835\uDF16":"","\uD835\uDF3A":"","\uD835\uDF50":"","\uD835\uDF74":"","\uD835\uDF8A":"","\uD835\uDFAE":"","\uD835\uDFC4":"","":"","":"","":"","":"","\uD806\uDCCE":"","\uD801\uDC29":"","":"","":"","":"","":"","":"","":"","":"d","":"d","\uD835\uDC1D":"d","\uD835\uDC51":"d","\uD835\uDC85":"d","\uD835\uDCB9":"d","\uD835\uDCED":"d","\uD835\uDD21":"d","\uD835\uDD55":"d","\uD835\uDD89":"d","\uD835\uDDBD":"d","\uD835\uDDF1":"d","\uD835\uDE25":"d","\uD835\uDE59":"d","\uD835\uDE8D":"d","":"d","":"d","":"d","":"d","":"D","":"D","\uD835\uDC03":"D","\uD835\uDC37":"D","\uD835\uDC6B":"D","\uD835\uDC9F":"D","\uD835\uDCD3":"D","\uD835\uDD07":"D","\uD835\uDD3B":"D","\uD835\uDD6F":"D","\uD835\uDDA3":"D","\uD835\uDDD7":"D","\uD835\uDE0B":"D","\uD835\uDE3F":"D","\uD835\uDE73":"D","":"D","":"D","":"D","":"D","":"d","":"d","":"d","":"d","":"D","\xd0":"D","":"D","":"d","":"","":"d\xb7","":"d\'","":"d","":"dz","":"dz","":"Dz","":"DZ","":"d","":"D","":"D","":"d","":"","":"","":"","\uD835\uDEC5":"","\uD835\uDEFF":"","\uD835\uDF39":"","\uD835\uDF73":"","\uD835\uDFAD":"","":"","":"","":"e","":"e","":"e","":"e","\uD835\uDC1E":"e","\uD835\uDC52":"e","\uD835\uDC86":"e","\uD835\uDCEE":"e","\uD835\uDD22":"e","\uD835\uDD56":"e","\uD835\uDD8A":"e","\uD835\uDDBE":"e","\uD835\uDDF2":"e","\uD835\uDE26":"e","\uD835\uDE5A":"e","\uD835\uDE8E":"e","":"e","":"e","":"e","":"","":"E","":"E","":"E","\uD835\uDC04":"E","\uD835\uDC38":"E","\uD835\uDC6C":"E","\uD835\uDCD4":"E","\uD835\uDD08":"E","\uD835\uDD3C":"E","\uD835\uDD70":"E","\uD835\uDDA4":"E","\uD835\uDDD8":"E","\uD835\uDE0C":"E","\uD835\uDE40":"E","\uD835\uDE74":"E","":"E","\uD835\uDEAC":"E","\uD835\uDEE6":"E","\uD835\uDF20":"E","\uD835\uDF5A":"E","\uD835\uDF94":"E","":"E","":"E","":"E","":"E","\uD806\uDCA6":"E","\uD806\uDCAE":"E","\uD800\uDE86":"E","":"","":"","":"e","":"E","":"e","":"","":"","":"","":"","":"","":"","":"","":"o","":"o","":"o","":"","\uD834\uDE21":"","":"","":"","":"","\uD81B\uDF2D":"","\uD801\uDC01":"","":"","":"","":"","":"","\uD801\uDC42":"","":"","\uD801\uDC2A":"","\uD835\uDC1F":"f","\uD835\uDC53":"f","\uD835\uDC87":"f","\uD835\uDCBB":"f","\uD835\uDCEF":"f","\uD835\uDD23":"f","\uD835\uDD57":"f","\uD835\uDD8B":"f","\uD835\uDDBF":"f","\uD835\uDDF3":"f","\uD835\uDE27":"f","\uD835\uDE5B":"f","\uD835\uDE8F":"f","":"f","":"f","":"f","":"f","":"f","\uD834\uDE13":"F","":"F","\uD835\uDC05":"F","\uD835\uDC39":"F","\uD835\uDC6D":"F","\uD835\uDCD5":"F","\uD835\uDD09":"F","\uD835\uDD3D":"F","\uD835\uDD71":"F","\uD835\uDDA5":"F","\uD835\uDDD9":"F","\uD835\uDE0D":"F","\uD835\uDE41":"F","\uD835\uDE75":"F","":"F","":"F","\uD835\uDFCA":"F","":"F","":"F","\uD806\uDCC2":"F","\uD806\uDCA2":"F","\uD800\uDE87":"F","\uD800\uDEA5":"F","\uD801\uDD25":"F","":"f","":"F","":"f","":"FAX","":"ff","":"ffi","":"ffl","":"fi","":"fl","":"f","":"","":"","\uD834\uDE30":"","":"","":"g","":"g","\uD835\uDC20":"g","\uD835\uDC54":"g","\uD835\uDC88":"g","\uD835\uDCF0":"g","\uD835\uDD24":"g","\uD835\uDD58":"g","\uD835\uDD8C":"g","\uD835\uDDC0":"g","\uD835\uDDF4":"g","\uD835\uDE28":"g","\uD835\uDE5C":"g","\uD835\uDE90":"g","":"g","":"g","":"g","":"g","\uD835\uDC06":"G","\uD835\uDC3A":"G","\uD835\uDC6E":"G","\uD835\uDCA2":"G","\uD835\uDCD6":"G","\uD835\uDD0A":"G","\uD835\uDD3E":"G","\uD835\uDD72":"G","\uD835\uDDA6":"G","\uD835\uDDDA":"G","\uD835\uDE0E":"G","\uD835\uDE42":"G","\uD835\uDE76":"G","":"G","":"G","":"G","":"G","":"","":"g","":"","":"","":"","":"g","":"G","":"G\'","":"","":"","":"","":"h","":"h","\uD835\uDC21":"h","\uD835\uDC89":"h","\uD835\uDCBD":"h","\uD835\uDCF1":"h","\uD835\uDD25":"h","\uD835\uDD59":"h","\uD835\uDD8D":"h","\uD835\uDDC1":"h","\uD835\uDDF5":"h","\uD835\uDE29":"h","\uD835\uDE5D":"h","\uD835\uDE91":"h","":"h","":"h","":"h","":"H","":"H","":"H","":"H","\uD835\uDC07":"H","\uD835\uDC3B":"H","\uD835\uDC6F":"H","\uD835\uDCD7":"H","\uD835\uDD73":"H","\uD835\uDDA7":"H","\uD835\uDDDB":"H","\uD835\uDE0F":"H","\uD835\uDE43":"H","\uD835\uDE77":"H","":"H","\uD835\uDEAE":"H","\uD835\uDEE8":"H","\uD835\uDF22":"H","\uD835\uDF5C":"H","\uD835\uDF96":"H","":"H","":"H","":"H","":"H","":"H","\uD800\uDECF":"H","":"","":"h","":"h","":"h","":"H","":"H","":"h","":"h","":"h","":"H","":"H","":"H","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"i","":"i","":"i","":"i","":"i","":"i","\uD835\uDC22":"i","\uD835\uDC56":"i","\uD835\uDC8A":"i","\uD835\uDCBE":"i","\uD835\uDCF2":"i","\uD835\uDD26":"i","\uD835\uDD5A":"i","\uD835\uDD8E":"i","\uD835\uDDC2":"i","\uD835\uDDF6":"i","\uD835\uDE2A":"i","\uD835\uDE5E":"i","\uD835\uDE92":"i","":"i","\uD835\uDEA4":"i","":"i","":"i","":"i","":"i","":"i","\uD835\uDECA":"i","\uD835\uDF04":"i","\uD835\uDF3E":"i","\uD835\uDF78":"i","\uD835\uDFB2":"i","":"i","":"i","":"i","":"i","":"i","\uD806\uDCC3":"i","":"","":"i","":"","":"","":"i","":"i","":"i","":"ii","":"iii","":"ij","":"iv","":"ix","":"j","":"j","\uD835\uDC23":"j","\uD835\uDC57":"j","\uD835\uDC8B":"j","\uD835\uDCBF":"j","\uD835\uDCF3":"j","\uD835\uDD27":"j","\uD835\uDD5B":"j","\uD835\uDD8F":"j","\uD835\uDDC3":"j","\uD835\uDDF7":"j","\uD835\uDE2B":"j","\uD835\uDE5F":"j","\uD835\uDE93":"j","":"j","":"j","":"J","\uD835\uDC09":"J","\uD835\uDC3D":"J","\uD835\uDC71":"J","\uD835\uDCA5":"J","\uD835\uDCD9":"J","\uD835\uDD0D":"J","\uD835\uDD41":"J","\uD835\uDD75":"J","\uD835\uDDA9":"J","\uD835\uDDDD":"J","\uD835\uDE11":"J","\uD835\uDE45":"J","\uD835\uDE79":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"j","":"J","":"J\xb7","\uD835\uDEA5":"","":"","":"","\uD835\uDC24":"k","\uD835\uDC58":"k","\uD835\uDC8C":"k","\uD835\uDCC0":"k","\uD835\uDCF4":"k","\uD835\uDD28":"k","\uD835\uDD5C":"k","\uD835\uDD90":"k","\uD835\uDDC4":"k","\uD835\uDDF8":"k","\uD835\uDE2C":"k","\uD835\uDE60":"k","\uD835\uDE94":"k","":"K","":"K","\uD835\uDC0A":"K","\uD835\uDC3E":"K","\uD835\uDC72":"K","\uD835\uDCA6":"K","\uD835\uDCDA":"K","\uD835\uDD0E":"K","\uD835\uDD42":"K","\uD835\uDD76":"K","\uD835\uDDAA":"K","\uD835\uDDDE":"K","\uD835\uDE12":"K","\uD835\uDE46":"K","\uD835\uDE7A":"K","":"K","\uD835\uDEB1":"K","\uD835\uDEEB":"K","\uD835\uDF25":"K","\uD835\uDF5F":"K","\uD835\uDF99":"K","":"K","":"K","":"K","":"K","":"K","\uD801\uDD18":"K","":"k","":"K","":"K","":"K","":"K","":"K","":"K\'","":"l","|":"l","":"l","":"l","":"l","":"l","":"l","\uD800\uDF20":"l","\uD83A\uDCC7":"l","\uD835\uDFCF":"l","\uD835\uDFD9":"l","\uD835\uDFE3":"l","\uD835\uDFED":"l","\uD835\uDFF7":"l","\uD83E\uDFF1":"l","I":"l","":"l","":"l","":"l","":"l","\uD835\uDC08":"l","\uD835\uDC3C":"l","\uD835\uDC70":"l","\uD835\uDCD8":"l","\uD835\uDD40":"l","\uD835\uDD74":"l","\uD835\uDDA8":"l","\uD835\uDDDC":"l","\uD835\uDE10":"l","\uD835\uDE44":"l","\uD835\uDE78":"l","":"l","":"l","":"l","":"l","\uD835\uDC25":"l","\uD835\uDC59":"l","\uD835\uDC8D":"l","\uD835\uDCC1":"l","\uD835\uDCF5":"l","\uD835\uDD29":"l","\uD835\uDD5D":"l","\uD835\uDD91":"l","\uD835\uDDC5":"l","\uD835\uDDF9":"l","\uD835\uDE2D":"l","\uD835\uDE61":"l","\uD835\uDE95":"l","":"l","":"l","\uD835\uDEB0":"l","\uD835\uDEEA":"l","\uD835\uDF24":"l","\uD835\uDF5E":"l","\uD835\uDF98":"l","":"l","":"l","":"l","":"l","":"l","":"l","\uD83B\uDE00":"l","\uD83B\uDE80":"l","":"l","":"l","":"l","":"l","":"l","":"l","\uD81B\uDF28":"l","\uD800\uDE8A":"l","\uD800\uDF09":"l","\uD834\uDE2A":"L","":"L","":"L","\uD835\uDC0B":"L","\uD835\uDC3F":"L","\uD835\uDC73":"L","\uD835\uDCDB":"L","\uD835\uDD0F":"L","\uD835\uDD43":"L","\uD835\uDD77":"L","\uD835\uDDAB":"L","\uD835\uDDDF":"L","\uD835\uDE13":"L","\uD835\uDE47":"L","\uD835\uDE7B":"L","":"L","":"L","":"L","":"L","\uD81B\uDF16":"L","\uD806\uDCA3":"L","\uD806\uDCB2":"L","\uD801\uDC1B":"L","\uD801\uDD26":"L","":"l","":"l","":"l","":"L","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l\xb7","":"l\xb7","":"l\xb7","\uD83C\uDD02":"l,","":"l.","":"l\'","":"l2.","":"l2","":"l2","":"l2","":"l3.","":"l3","":"l3","":"l4.","":"l4","":"l4","":"l5.","":"l5","":"l5","":"l6.","":"l6","":"l6","":"l7.","":"l7","":"l7","":"l8.","":"l8","":"l8","":"l9.","":"l9","":"l9","":"lj","":"lJ","":"Lj","":"LJ","":"ll","":"ll","":"ll","":"ll","":"ll","\uD800\uDD99":"ll","":"ll.","":"lll","\uD800\uDD98":"llS","":"ll","":"ll","":"ll","":"lO","":"lO.","":"lO","":"lO","":"lO","":"ls","":"lt","":"lV","":"lX","":"l","":"lz","":"l","":"l","":"l","":"l","":"l","":"l","":"lo","":"l","":"l","":"l","":"","":"","\uD801\uDC43":"","":"M","":"M","":"M","\uD835\uDC0C":"M","\uD835\uDC40":"M","\uD835\uDC74":"M","\uD835\uDCDC":"M","\uD835\uDD10":"M","\uD835\uDD44":"M","\uD835\uDD78":"M","\uD835\uDDAC":"M","\uD835\uDDE0":"M","\uD835\uDE14":"M","\uD835\uDE48":"M","\uD835\uDE7C":"M","":"M","\uD835\uDEB3":"M","\uD835\uDEED":"M","\uD835\uDF27":"M","\uD835\uDF61":"M","\uD835\uDF9B":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","\uD800\uDEB0":"M","\uD800\uDF11":"M","":"M","\uD83D\uDF6B":"MB","":"","\uD835\uDC27":"n","\uD835\uDC5B":"n","\uD835\uDC8F":"n","\uD835\uDCC3":"n","\uD835\uDCF7":"n","\uD835\uDD2B":"n","\uD835\uDD5F":"n","\uD835\uDD93":"n","\uD835\uDDC7":"n","\uD835\uDDFB":"n","\uD835\uDE2F":"n","\uD835\uDE63":"n","\uD835\uDE97":"n","":"n","":"n","":"N","":"N","\uD835\uDC0D":"N","\uD835\uDC41":"N","\uD835\uDC75":"N","\uD835\uDCA9":"N","\uD835\uDCDD":"N","\uD835\uDD11":"N","\uD835\uDD79":"N","\uD835\uDDAD":"N","\uD835\uDDE1":"N","\uD835\uDE15":"N","\uD835\uDE49":"N","\uD835\uDE7D":"N","":"N","\uD835\uDEB4":"N","\uD835\uDEEE":"N","\uD835\uDF28":"N","\uD835\uDF62":"N","\uD835\uDF9C":"N","":"N","":"N","\uD801\uDD13":"N","\uD800\uDD8E":"N","":"n","":"n","":"n","\uD835\uDEC8":"n","\uD835\uDF02":"n","\uD835\uDF3C":"n","\uD835\uDF76":"n","\uD835\uDFB0":"n","":"N","":"n","":"nj","":"Nj","":"NJ","":"No","":"","":"","\uD801\uDC4D":"","":"","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","\uD835\uDC28":"o","\uD835\uDC5C":"o","\uD835\uDC90":"o","\uD835\uDCF8":"o","\uD835\uDD2C":"o","\uD835\uDD60":"o","\uD835\uDD94":"o","\uD835\uDDC8":"o","\uD835\uDDFC":"o","\uD835\uDE30":"o","\uD835\uDE64":"o","\uD835\uDE98":"o","":"o","":"o","":"o","":"o","\uD835\uDED0":"o","\uD835\uDF0A":"o","\uD835\uDF44":"o","\uD835\uDF7E":"o","\uD835\uDFB8":"o","":"o","\uD835\uDED4":"o","\uD835\uDF0E":"o","\uD835\uDF48":"o","\uD835\uDF82":"o","\uD835\uDFBC":"o","":"o","":"o","":"o","":"o","":"o","":"o","\uD83B\uDE24":"o","\uD83B\uDE64":"o","\uD83B\uDE84":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","\uD801\uDCEA":"o","\uD806\uDCC8":"o","\uD806\uDCD7":"o","\uD801\uDC2C":"o","":"O","":"O","":"O","":"O","\uD805\uDCD0":"O","\uD806\uDCE0":"O","\uD835\uDFCE":"O","\uD835\uDFD8":"O","\uD835\uDFE2":"O","\uD835\uDFEC":"O","\uD835\uDFF6":"O","\uD83E\uDFF0":"O","":"O","\uD835\uDC0E":"O","\uD835\uDC42":"O","\uD835\uDC76":"O","\uD835\uDCAA":"O","\uD835\uDCDE":"O","\uD835\uDD12":"O","\uD835\uDD46":"O","\uD835\uDD7A":"O","\uD835\uDDAE":"O","\uD835\uDDE2":"O","\uD835\uDE16":"O","\uD835\uDE4A":"O","\uD835\uDE7E":"O","":"O","\uD835\uDEB6":"O","\uD835\uDEF0":"O","\uD835\uDF2A":"O","\uD835\uDF64":"O","\uD835\uDF9E":"O","":"O","":"O","":"O","":"O","":"O","":"O","\uD801\uDCC2":"O","":"O","\uD806\uDCB5":"O","\uD800\uDE92":"O","\uD800\uDEAB":"O","\uD801\uDC04":"O","\uD801\uDD16":"O","":"\xba","":"\xba","":"","":"","":"o","":"\xd6","\xf8":"o","":"o","\xd8":"O","":"O","":"O","":"o","":"o","":"o","":"o","":"o","":"o","":"O","":"O","":"O","\uD834\uDE1A":"O","\uD83D\uDF14":"O","":"O","":"O","":"O","":"O","\uD835\uDEC9":"O","\uD835\uDEDD":"O","\uD835\uDF03":"O","\uD835\uDF17":"O","\uD835\uDF3D":"O","\uD835\uDF51":"O","\uD835\uDF77":"O","\uD835\uDF8B":"O","\uD835\uDFB1":"O","\uD835\uDFC5":"O","":"O","":"O","\uD835\uDEAF":"O","\uD835\uDEB9":"O","\uD835\uDEE9":"O","\uD835\uDEF3":"O","\uD835\uDF23":"O","\uD835\uDF2D":"O","\uD835\uDF5D":"O","\uD835\uDF67":"O","\uD835\uDF97":"O","\uD835\uDFA1":"O","":"O","":"O","":"O","":"O","":"O","":"o","":"o","\uD83C\uDD01":"O,","\uD83C\uDD00":"O.","":"o\'","":"O\'","":"O\'","%":"\xba/","":"\xba/","":"\xba/","":"\xba/","":"\xba/","":"\xba/","":"\xba/","":"oe","":"OE","":"o","":"oo","":"oo","":"oo","":"OO","":"OO","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"oo","":"o","":"O","":"","":"","":"","\uD801\uDC4B":"","":"","":"","":"","\uD801\uDC23":"","":"","":"e","\uD801\uDC3F":"","":"p","":"p","\uD835\uDC29":"p","\uD835\uDC5D":"p","\uD835\uDC91":"p","\uD835\uDCC5":"p","\uD835\uDCF9":"p","\uD835\uDD2D":"p","\uD835\uDD61":"p","\uD835\uDD95":"p","\uD835\uDDC9":"p","\uD835\uDDFD":"p","\uD835\uDE31":"p","\uD835\uDE65":"p","\uD835\uDE99":"p","":"p","":"p","\uD835\uDED2":"p","\uD835\uDEE0":"p","\uD835\uDF0C":"p","\uD835\uDF1A":"p","\uD835\uDF46":"p","\uD835\uDF54":"p","\uD835\uDF80":"p","\uD835\uDF8E":"p","\uD835\uDFBA":"p","\uD835\uDFC8":"p","":"p","":"p","":"P","":"P","\uD835\uDC0F":"P","\uD835\uDC43":"P","\uD835\uDC77":"P","\uD835\uDCAB":"P","\uD835\uDCDF":"P","\uD835\uDD13":"P","\uD835\uDD7B":"P","\uD835\uDDAF":"P","\uD835\uDDE3":"P","\uD835\uDE17":"P","\uD835\uDE4B":"P","\uD835\uDE7F":"P","":"P","\uD835\uDEB8":"P","\uD835\uDEF2":"P","\uD835\uDF2C":"P","\uD835\uDF66":"P","\uD835\uDFA0":"P","":"P","":"P","":"P","":"P","":"P","\uD800\uDE95":"P","":"p","":"p","":"p\xb7","":"P\'","":"","":"","":"","":"","\uD835\uDED7":"","\uD835\uDEDF":"","\uD835\uDF11":"","\uD835\uDF19":"","\uD835\uDF4B":"","\uD835\uDF53":"","\uD835\uDF85":"","\uD835\uDF8D":"","\uD835\uDFBF":"","\uD835\uDFC7":"","":"","":"","\uD835\uDC2A":"q","\uD835\uDC5E":"q","\uD835\uDC92":"q","\uD835\uDCC6":"q","\uD835\uDCFA":"q","\uD835\uDD2E":"q","\uD835\uDD62":"q","\uD835\uDD96":"q","\uD835\uDDCA":"q","\uD835\uDDFE":"q","\uD835\uDE32":"q","\uD835\uDE66":"q","\uD835\uDE9A":"q","":"q","":"q","":"q","":"Q","\uD835\uDC10":"Q","\uD835\uDC44":"Q","\uD835\uDC78":"Q","\uD835\uDCAC":"Q","\uD835\uDCE0":"Q","\uD835\uDD14":"Q","\uD835\uDD7C":"Q","\uD835\uDDB0":"Q","\uD835\uDDE4":"Q","\uD835\uDE18":"Q","\uD835\uDE4C":"Q","\uD835\uDE80":"Q","":"Q","":"q","\uD83D\uDF00":"QE","":"","":"","":"","":"","\uD835\uDECB":"","\uD835\uDEDE":"","\uD835\uDF05":"","\uD835\uDF18":"","\uD835\uDF3F":"","\uD835\uDF52":"","\uD835\uDF79":"","\uD835\uDF8C":"","\uD835\uDFB3":"","\uD835\uDFC6":"","":"","":"","":"","":"","":"","\uD835\uDC2B":"r","\uD835\uDC5F":"r","\uD835\uDC93":"r","\uD835\uDCC7":"r","\uD835\uDCFB":"r","\uD835\uDD2F":"r","\uD835\uDD63":"r","\uD835\uDD97":"r","\uD835\uDDCB":"r","\uD835\uDDFF":"r","\uD835\uDE33":"r","\uD835\uDE67":"r","\uD835\uDE9B":"r","":"r","":"r","":"r","":"r","":"r","":"r","\uD834\uDE16":"R","":"R","":"R","":"R","\uD835\uDC11":"R","\uD835\uDC45":"R","\uD835\uDC79":"R","\uD835\uDCE1":"R","\uD835\uDD7D":"R","\uD835\uDDB1":"R","\uD835\uDDE5":"R","\uD835\uDE19":"R","\uD835\uDE4D":"R","\uD835\uDE81":"R","":"R","":"R","":"R","\uD801\uDCB4":"R","":"R","":"R","\uD81B\uDF35":"R","":"r","":"r","":"r","":"r","":"r","":"r\'","\uD806\uDCE3":"rn","m":"rn","":"rn","\uD835\uDC26":"rn","\uD835\uDC5A":"rn","\uD835\uDC8E":"rn","\uD835\uDCC2":"rn","\uD835\uDCF6":"rn","\uD835\uDD2A":"rn","\uD835\uDD5E":"rn","\uD835\uDD92":"rn","\uD835\uDDC6":"rn","\uD835\uDDFA":"rn","\uD835\uDE2E":"rn","\uD835\uDE62":"rn","\uD835\uDE96":"rn","\uD805\uDF00":"rn","":"rn","":"rn","":"rn","":"Rs","":"","":"","":"","":"","":"","":"s","\uD835\uDC2C":"s","\uD835\uDC60":"s","\uD835\uDC94":"s","\uD835\uDCC8":"s","\uD835\uDCFC":"s","\uD835\uDD30":"s","\uD835\uDD64":"s","\uD835\uDD98":"s","\uD835\uDDCC":"s","\uD835\uDE00":"s","\uD835\uDE34":"s","\uD835\uDE68":"s","\uD835\uDE9C":"s","":"s","":"s","":"s","":"s","\uD806\uDCC1":"s","\uD801\uDC48":"s","":"S","\uD835\uDC12":"S","\uD835\uDC46":"S","\uD835\uDC7A":"S","\uD835\uDCAE":"S","\uD835\uDCE2":"S","\uD835\uDD16":"S","\uD835\uDD4A":"S","\uD835\uDD7E":"S","\uD835\uDDB2":"S","\uD835\uDDE6":"S","\uD835\uDE1A":"S","\uD835\uDE4E":"S","\uD835\uDE82":"S","":"S","":"S","":"S","":"S","":"S","\uD81B\uDF3A":"S","\uD800\uDE96":"S","\uD801\uDC20":"S","":"s","":"s","":"\xdf","":"\xdf","":"\xdf","\uD835\uDEC3":"\xdf","\uD835\uDEFD":"\xdf","\uD835\uDF37":"\xdf","\uD835\uDF71":"\xdf","\uD835\uDFAB":"\xdf","":"\xdf","\uD83D\uDF5C":"sss","":"st","":"","":"","":"","":"","":"","\uD835\uDEBA":"","\uD835\uDEF4":"","\uD835\uDF2E":"","\uD835\uDF68":"","\uD835\uDFA2":"","":"","":"","":"","":"","\uD835\uDC2D":"t","\uD835\uDC61":"t","\uD835\uDC95":"t","\uD835\uDCC9":"t","\uD835\uDCFD":"t","\uD835\uDD31":"t","\uD835\uDD65":"t","\uD835\uDD99":"t","\uD835\uDDCD":"t","\uD835\uDE01":"t","\uD835\uDE35":"t","\uD835\uDE69":"t","\uD835\uDE9D":"t","":"T","":"T","\uD83D\uDF68":"T","":"T","\uD835\uDC13":"T","\uD835\uDC47":"T","\uD835\uDC7B":"T","\uD835\uDCAF":"T","\uD835\uDCE3":"T","\uD835\uDD17":"T","\uD835\uDD4B":"T","\uD835\uDD7F":"T","\uD835\uDDB3":"T","\uD835\uDDE7":"T","\uD835\uDE1B":"T","\uD835\uDE4F":"T","\uD835\uDE83":"T","":"T","\uD835\uDEBB":"T","\uD835\uDEF5":"T","\uD835\uDF2F":"T","\uD835\uDF69":"T","\uD835\uDFA3":"T","":"T","":"T","":"T","":"T","\uD81B\uDF0A":"T","\uD806\uDCBC":"T","\uD800\uDE97":"T","\uD800\uDEB1":"T","\uD800\uDF15":"T","":"t","":"T","":"T","":"","":"T","":"T","":"T","":"t","":"T","":"t","":"","":"T3","":"t","":"TEL","":"tf","":"ts","":"t","":"t","":"","\uD835\uDED5":"","\uD835\uDF0F":"","\uD835\uDF49":"","\uD835\uDF83":"","\uD835\uDFBD":"","":"","":"","":"","":"","":"","":"","\uD835\uDC2E":"u","\uD835\uDC62":"u","\uD835\uDC96":"u","\uD835\uDCCA":"u","\uD835\uDCFE":"u","\uD835\uDD32":"u","\uD835\uDD66":"u","\uD835\uDD9A":"u","\uD835\uDDCE":"u","\uD835\uDE02":"u","\uD835\uDE36":"u","\uD835\uDE6A":"u","\uD835\uDE9E":"u","":"u","":"u","":"u","":"u","":"u","":"u","\uD835\uDED6":"u","\uD835\uDF10":"u","\uD835\uDF4A":"u","\uD835\uDF84":"u","\uD835\uDFBE":"u","":"u","\uD801\uDCF6":"u","\uD806\uDCD8":"u","":"U","":"U","\uD835\uDC14":"U","\uD835\uDC48":"U","\uD835\uDC7C":"U","\uD835\uDCB0":"U","\uD835\uDCE4":"U","\uD835\uDD18":"U","\uD835\uDD4C":"U","\uD835\uDD80":"U","\uD835\uDDB4":"U","\uD835\uDDE8":"U","\uD835\uDE1C":"U","\uD835\uDE50":"U","\uD835\uDE84":"U","":"U","":"U","\uD801\uDCCE":"U","":"U","":"U","\uD81B\uDF42":"U","\uD806\uDCB8":"U","":"","":"","":"u","":"u","":"U","":"U","":"U\xb7","":"U\'","":"ue","":"uo","":"","":"","":"","":"","":"","":"","":"","":"v","":"v","":"v","":"v","\uD835\uDC2F":"v","\uD835\uDC63":"v","\uD835\uDC97":"v","\uD835\uDCCB":"v","\uD835\uDCFF":"v","\uD835\uDD33":"v","\uD835\uDD67":"v","\uD835\uDD9B":"v","\uD835\uDDCF":"v","\uD835\uDE03":"v","\uD835\uDE37":"v","\uD835\uDE6B":"v","\uD835\uDE9F":"v","":"v","":"v","\uD835\uDECE":"v","\uD835\uDF08":"v","\uD835\uDF42":"v","\uD835\uDF7C":"v","\uD835\uDFB6":"v","":"v","":"v","\uD805\uDF06":"v","":"v","\uD806\uDCC0":"v","\uD834\uDE0D":"V","":"V","":"V","":"V","\uD835\uDC15":"V","\uD835\uDC49":"V","\uD835\uDC7D":"V","\uD835\uDCB1":"V","\uD835\uDCE5":"V","\uD835\uDD19":"V","\uD835\uDD4D":"V","\uD835\uDD81":"V","\uD835\uDDB5":"V","\uD835\uDDE9":"V","\uD835\uDE1D":"V","\uD835\uDE51":"V","\uD835\uDE85":"V","":"V","":"V","":"V","":"V","":"V","":"V","\uD81B\uDF08":"V","\uD806\uDCA0":"V","\uD801\uDD1D":"V","\uD800\uDD97":"V","":"V\xb7","\uD83D\uDF6C":"VB","":"vi","":"vii","":"viii","":"Vl","":"Vll","":"Vlll","\uD83D\uDF08":"V","":"","\uD801\uDCD8":"","":"","":"","":"","\uD835\uDEB2":"","\uD835\uDEEC":"","\uD835\uDF26":"","\uD835\uDF60":"","\uD835\uDF9A":"","":"","":"","\uD801\uDCB0":"","":"","":"","":"","\uD81B\uDF3D":"","\uD800\uDE8D":"","":"","":"\xb7","":"w","\uD835\uDC30":"w","\uD835\uDC64":"w","\uD835\uDC98":"w","\uD835\uDCCC":"w","\uD835\uDD00":"w","\uD835\uDD34":"w","\uD835\uDD68":"w","\uD835\uDD9C":"w","\uD835\uDDD0":"w","\uD835\uDE04":"w","\uD835\uDE38":"w","\uD835\uDE6C":"w","\uD835\uDEA0":"w","":"w","":"w","":"w","":"w","\uD805\uDF0A":"w","\uD805\uDF0E":"w","\uD805\uDF0F":"w","":"w","\uD806\uDCEF":"W","\uD806\uDCE6":"W","\uD835\uDC16":"W","\uD835\uDC4A":"W","\uD835\uDC7E":"W","\uD835\uDCB2":"W","\uD835\uDCE6":"W","\uD835\uDD1A":"W","\uD835\uDD4E":"W","\uD835\uDD82":"W","\uD835\uDDB6":"W","\uD835\uDDEA":"W","\uD835\uDE1E":"W","\uD835\uDE52":"W","\uD835\uDE86":"W","":"W","":"W","":"W","":"W","":"w","\uD805\uDCC5":"w","":"W","":"w","":"","":"","":"","":"","":"x","\xd7":"x","":"x","":"x","":"x","":"x","":"x","\uD835\uDC31":"x","\uD835\uDC65":"x","\uD835\uDC99":"x","\uD835\uDCCD":"x","\uD835\uDD01":"x","\uD835\uDD35":"x","\uD835\uDD69":"x","\uD835\uDD9D":"x","\uD835\uDDD1":"x","\uD835\uDE05":"x","\uD835\uDE39":"x","\uD835\uDE6D":"x","\uD835\uDEA1":"x","":"x","":"x","":"x","":"","":"X","":"X","\uD800\uDF22":"X","\uD806\uDCEC":"X","":"X","":"X","\uD835\uDC17":"X","\uD835\uDC4B":"X","\uD835\uDC7F":"X","\uD835\uDCB3":"X","\uD835\uDCE7":"X","\uD835\uDD1B":"X","\uD835\uDD4F":"X","\uD835\uDD83":"X","\uD835\uDDB7":"X","\uD835\uDDEB":"X","\uD835\uDE1F":"X","\uD835\uDE53":"X","\uD835\uDE87":"X","":"X","":"X","\uD835\uDEBE":"X","\uD835\uDEF8":"X","\uD835\uDF32":"X","\uD835\uDF6C":"X","\uD835\uDFA6":"X","":"X","":"X","":"X","":"X","":"X","\uD800\uDE90":"X","\uD800\uDEB4":"X","\uD800\uDF17":"X","\uD801\uDD27":"X","":"x","":"X","\uD800\uDD96":"X","":"xi","":"xii","":"Xl","":"Xll","":"y","":"y","":"y","\uD835\uDC32":"y","\uD835\uDC66":"y","\uD835\uDC9A":"y","\uD835\uDCCE":"y","\uD835\uDD02":"y","\uD835\uDD36":"y","\uD835\uDD6A":"y","\uD835\uDD9E":"y","\uD835\uDDD2":"y","\uD835\uDE06":"y","\uD835\uDE3A":"y","\uD835\uDE6E":"y","\uD835\uDEA2":"y","":"y","":"y","":"y","":"y","":"y","\uD835\uDEC4":"y","\uD835\uDEFE":"y","\uD835\uDF38":"y","\uD835\uDF72":"y","\uD835\uDFAC":"y","":"y","":"y","":"y","\uD806\uDCDC":"y","":"Y","\uD835\uDC18":"Y","\uD835\uDC4C":"Y","\uD835\uDC80":"Y","\uD835\uDCB4":"Y","\uD835\uDCE8":"Y","\uD835\uDD1C":"Y","\uD835\uDD50":"Y","\uD835\uDD84":"Y","\uD835\uDDB8":"Y","\uD835\uDDEC":"Y","\uD835\uDE20":"Y","\uD835\uDE54":"Y","\uD835\uDE88":"Y","":"Y","":"Y","\uD835\uDEBC":"Y","\uD835\uDEF6":"Y","\uD835\uDF30":"Y","\uD835\uDF6A":"Y","\uD835\uDFA4":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","\uD81B\uDF43":"Y","\uD806\uDCA4":"Y","\uD800\uDEB2":"Y","":"y","":"y","":"y","\xa5":"Y","":"Y","":"Y","":"","":"","":"","":"","":"","\uD835\uDC33":"z","\uD835\uDC67":"z","\uD835\uDC9B":"z","\uD835\uDCCF":"z","\uD835\uDD03":"z","\uD835\uDD37":"z","\uD835\uDD6B":"z","\uD835\uDD9F":"z","\uD835\uDDD3":"z","\uD835\uDE07":"z","\uD835\uDE3B":"z","\uD835\uDE6F":"z","\uD835\uDEA3":"z","":"z","":"z","\uD806\uDCC4":"z","\uD800\uDEF5":"Z","\uD806\uDCE5":"Z","":"Z","":"Z","":"Z","\uD835\uDC19":"Z","\uD835\uDC4D":"Z","\uD835\uDC81":"Z","\uD835\uDCB5":"Z","\uD835\uDCE9":"Z","\uD835\uDD85":"Z","\uD835\uDDB9":"Z","\uD835\uDDED":"Z","\uD835\uDE21":"Z","\uD835\uDE55":"Z","\uD835\uDE89":"Z","":"Z","\uD835\uDEAD":"Z","\uD835\uDEE7":"Z","\uD835\uDF21":"Z","\uD835\uDF5B":"Z","\uD835\uDF95":"Z","":"Z","":"Z","\uD806\uDCA9":"Z","":"z","":"z","":"Z","":"z","":"Z","":"z","":"\xfe","":"\xfe","":"\xde","\uD801\uDCC4":"\xde","":"","":"","":"","":"","":"","":"","":"i","":"","":"","":"","":"","":"","":"","":"","":"","\uD801\uDCC3":"","":"","\uD835\uDEAA":"","\uD835\uDEE4":"","\uD835\uDF1E":"","\uD835\uDF58":"","\uD835\uDF92":"","":"","":"","":"","":"","\uD81B\uDF07":"","":"","":"\xb7","":"\'","":"","":"","\uD83D\uDF02":"","\uD835\uDEAB":"","\uD835\uDEE5":"","\uD835\uDF1F":"","\uD835\uDF59":"","\uD835\uDF93":"","":"","":"","":"","\uD81B\uDF1A":"","\uD800\uDE85":"","\uD800\uDEA3":"","":"","":"\xb7","":"","\uD835\uDFCB":"","\uD835\uDEC7":"","\uD835\uDF01":"","\uD835\uDF3B":"","\uD835\uDF75":"","\uD835\uDFAF":"","":"","\uD835\uDECC":"","\uD835\uDF06":"","\uD835\uDF40":"","\uD835\uDF7A":"","\uD835\uDFB4":"","":"","\uD801\uDCDB":"","\xb5":"","\uD835\uDECD":"","\uD835\uDF07":"","\uD835\uDF41":"","\uD835\uDF7B":"","\uD835\uDFB5":"","\uD835\uDECF":"","\uD835\uDF09":"","\uD835\uDF43":"","\uD835\uDF7D":"","\uD835\uDFB7":"","\uD835\uDEB5":"","\uD835\uDEEF":"","\uD835\uDF29":"","\uD835\uDF63":"","\uD835\uDF9D":"","":"","":"","\uD835\uDED1":"","\uD835\uDEE1":"","\uD835\uDF0B":"","\uD835\uDF1B":"","\uD835\uDF45":"","\uD835\uDF55":"","\uD835\uDF7F":"","\uD835\uDF8F":"","\uD835\uDFB9":"","\uD835\uDFC9":"","":"","":"","":"","":"","\uD835\uDEB7":"","\uD835\uDEF1":"","\uD835\uDF2B":"","\uD835\uDF65":"","\uD835\uDF9F":"","":"","":"","":"","\uD800\uDEAD":"","\uD800\uDF12":"","":"","\uD835\uDED3":"","\uD835\uDF0D":"","\uD835\uDF47":"","\uD835\uDF81":"","\uD835\uDFBB":"","\uD835\uDEBD":"","\uD835\uDEF7":"","\uD835\uDF31":"","\uD835\uDF6B":"","\uD835\uDFA5":"","":"","":"","":"","":"","":"","\uD800\uDEB3":"","":"","":"","\uD835\uDED8":"","\uD835\uDF12":"","\uD835\uDF4C":"","\uD835\uDF86":"","\uD835\uDFC0":"","":"","\uD835\uDED9":"","\uD835\uDF13":"","\uD835\uDF4D":"","\uD835\uDF87":"","\uD835\uDFC1":"","":"","\uD801\uDCF9":"","\uD835\uDEBF":"","\uD835\uDEF9":"","\uD835\uDF33":"","\uD835\uDF6D":"","\uD835\uDFA7":"","":"","":"","\uD801\uDCD1":"","":"","\uD800\uDEB5":"","":"","":"","\uD835\uDEDA":"","\uD835\uDF14":"","\uD835\uDF4E":"","\uD835\uDF88":"","\uD835\uDFC2":"","":"","":"","":"","\uD835\uDEC0":"","\uD835\uDEFA":"","\uD835\uDF34":"","\uD835\uDF6E":"","\uD835\uDFA8":"","":"","":"","\uD800\uDEB6":"","":"","":"","":"","":"","":"","":"","\uD834\uDE0B":"","":"","":"","\uD801\uDC25":"","":"","":"","":"","":"","\uD801\uDCBC":"","":"","":"","":"","\uD801\uDCEB":"","":"","\uD801\uDCCD":"","\uD834\uDE02":"","\uD834\uDE22":"","":"","":"","":"","":"\xb7","":"","":"","":"","":"","":"","":"","":"l","":"","\uD83D\uDF01":"","\uD81B\uDF1C":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD834\uDE45":"","":"","":"","":"","":"\xb7","":"\'","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD83B\uDE01":"","\uD83B\uDE21":"","\uD83B\uDE61":"","\uD83B\uDE81":"","\uD83B\uDEA1":"","":"","":"","":"","":"","":"","":"","":"","":"o","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\xf6":"","":"","":"","":"","\uD83B\uDE15":"","\uD83B\uDE35":"","\uD83B\uDE75":"","\uD83B\uDE95":"","\uD83B\uDEB5":"","":"","":"","":"","":"","":"o","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD83B\uDE02":"","\uD83B\uDE22":"","\uD83B\uDE42":"","\uD83B\uDE62":"","\uD83B\uDE82":"","\uD83B\uDEA2":"","":"","":"","":"","":"","":"","":"","":"","":"","":" lo","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD83B\uDE07":"","\uD83B\uDE27":"","\uD83B\uDE47":"","\uD83B\uDE67":"","\uD83B\uDE87":"","\uD83B\uDEA7":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD83B\uDE17":"","\uD83B\uDE37":"","\uD83B\uDE57":"","\uD83B\uDE77":"","\uD83B\uDE97":"","\uD83B\uDEB7":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD800\uDEE1":"","\uD83B\uDE03":"","\uD83B\uDE83":"","\uD83B\uDEA3":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD83B\uDE18":"","\uD83B\uDE98":"","\uD83B\uDEB8":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD83B\uDE13":"","\uD83B\uDE93":"","\uD83B\uDEB3":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"l","\uD83B\uDE06":"","\uD83B\uDE86":"","\uD83B\uDEA6":"","":"","":"","":"","":"","\uD83B\uDE0E":"","\uD83B\uDE2E":"","\uD83B\uDE4E":"","\uD83B\uDE6E":"","\uD83B\uDE8E":"","\uD83B\uDEAE":"","":"","":"","":"","":"","":"","\uD83B\uDE14":"","\uD83B\uDE34":"","\uD83B\uDE54":"","\uD83B\uDE74":"","\uD83B\uDE94":"","\uD83B\uDEB4":"","":"","":"","":"","":"","":"","":"o","":"o","":"o","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD800\uDEF2":"","\uD83B\uDE11":"","\uD83B\uDE31":"","\uD83B\uDE51":"","\uD83B\uDE71":"","\uD83B\uDE91":"","\uD83B\uDEB1":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":" lo o ","":"","":"","":"","":"","":"","":"","":"","":"","\uD83B\uDE19":"","\uD83B\uDE39":"","\uD83B\uDE59":"","\uD83B\uDE79":"","\uD83B\uDE99":"","\uD83B\uDEB9":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD800\uDEE8":"","\uD83B\uDE08":"","\uD83B\uDE68":"","\uD83B\uDE88":"","\uD83B\uDEA8":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD83B\uDE1A":"","\uD83B\uDE7A":"","\uD83B\uDE9A":"","\uD83B\uDEBA":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD83B\uDE0F":"","\uD83B\uDE2F":"","\uD83B\uDE4F":"","\uD83B\uDE6F":"","\uD83B\uDE8F":"","\uD83B\uDEAF":"","":"","":"","":"","":"","":"","":"","":"","":"","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD83B\uDE1B":"","\uD83B\uDE3B":"","\uD83B\uDE5B":"","\uD83B\uDE7B":"","\uD83B\uDE9B":"","\uD83B\uDEBB":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD83B\uDE10":"","\uD83B\uDE30":"","\uD83B\uDE70":"","\uD83B\uDE90":"","\uD83B\uDEB0":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD83B\uDE1E":"","\uD83B\uDE7E":"","":"","":"","\uD83B\uDE1F":"","\uD83B\uDE5F":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD83B\uDE12":"","\uD83B\uDE32":"","\uD83B\uDE52":"","\uD83B\uDE72":"","\uD83B\uDE92":"","\uD83B\uDEB2":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD83B\uDE0A":"","\uD83B\uDE2A":"","\uD83B\uDE6A":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"l","":"l","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD83B\uDE0B":"","\uD83B\uDE2B":"","\uD83B\uDE4B":"","\uD83B\uDE8B":"","\uD83B\uDEAB":"","":"","":"","":"","":"","":"","":"","":"l","":"l","":"l","":"l","":"l","":"l","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD83B\uDE0C":"","\uD83B\uDE2C":"","\uD83B\uDE6C":"","\uD83B\uDE8C":"","\uD83B\uDEAC":"","":"","":"","":"","":"","":"","":"","":"l","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD83B\uDE0D":"","\uD83B\uDE2D":"","\uD83B\uDE4D":"","\uD83B\uDE6D":"","\uD83B\uDE8D":"","\uD83B\uDEAD":"","":"","":"","":"","":"","":"","":"","":"o","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD800\uDEE4":"","\uD83B\uDE05":"","\uD83B\uDE85":"","\uD83B\uDEA5":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD83B\uDE1C":"","\uD83B\uDE7C":"","":"","\uD83B\uDE1D":"","\uD83B\uDE5D":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD83B\uDE09":"","\uD83B\uDE29":"","\uD83B\uDE49":"","\uD83B\uDE69":"","\uD83B\uDE89":"","\uD83B\uDEA9":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD83B\uDE16":"","\uD83B\uDE36":"","\uD83B\uDE76":"","\uD83B\uDE96":"","\uD83B\uDEB6":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"o","":"o","":"o","":"","":"","":"","":"","":"","":"","":"l","":"l","":"o","":"o","":"o","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD800\uDEB8":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD804\uDDDC":"","\uD804\uDDCB":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD805\uDC92":"","\uD805\uDC94":"","\uD805\uDC96":"","\uD805\uDC98":"","\uD805\uDC99":"","\uD805\uDC9B":"","\uD805\uDCAA":"","\uD805\uDC9E":"","\uD805\uDC9F":"","\uD805\uDCA0":"","\uD805\uDCA1":"","\uD805\uDCA2":"","\uD805\uDCA3":"","\uD805\uDCA9":"","\uD805\uDCA7":"","\uD805\uDCA8":"","\uD805\uDCAB":"","\uD805\uDC9D":"","\uD805\uDCAD":"","\uD805\uDCAE":"","\uD805\uDCC4":"","\uD805\uDCB0":"","\uD805\uDCB1":"","\uD805\uDCB9":"","\uD805\uDCBC":"","\uD805\uDCBE":"","\uD805\uDCC2":"","\uD805\uDCBD":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD805\uDC13":"\uD805\uDC34\uD805\uDC42\uD805\uDC12","\uD805\uDC19":"\uD805\uDC34\uD805\uDC42\uD805\uDC18","\uD805\uDC24":"\uD805\uDC34\uD805\uDC42\uD805\uDC23","\uD805\uDC2A":"\uD805\uDC34\uD805\uDC42\uD805\uDC29","\uD805\uDC2D":"\uD805\uDC34\uD805\uDC42\uD805\uDC2C","\uD805\uDC2F":"\uD805\uDC34\uD805\uDC42\uD805\uDC2E","\uD805\uDDD8":"\uD805\uDD82","\uD805\uDDD9":"\uD805\uDD82","\uD805\uDDDA":"\uD805\uDD83","\uD805\uDDDB":"\uD805\uDD84","\uD805\uDDDC":"\uD805\uDDB2","\uD805\uDDDD":"\uD805\uDDB3","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD807\uDCB2":"\uD807\uDCAA","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"\xb7","":"","":"\xb7","":"\xb7","":"","":"\xb7","":"\xb7","":"","":"\xb7","":"","":"","":"","":"\xb7","":"\xb7","":"","":"\xb7","":"\xb7","":"","":"","":"\xb7","":"\'","":"/","":"","":"\xb7","":"","":"","":"\xb7","":"\'","":"\xb7","":"\xb7","":"\'","":"\xb7","":"\xb7","":"","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"<","":"b","":"","":"","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"","":"\xb7","":"","":"","":"\xb7","":"b","":"b","":"d","":"P","":"","":"","":"","":"","":"","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"J","":"","":"","":"","":"","":"","":"","":"","":"J","":"","":"","":"","":"","":"","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"\xb7","":"","":"","":"","":"\xb7","":"\xb7","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD834\uDE3F":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD83D\uDF54":"","\uD806\uDCB7":"","\uD800\uDE94":"","":"","":"","":"","\uD801\uDCD0":"","":"","\uD803\uDCFC":"\uD803\uDC82","\uD803\uDCFA":"\uD803\uDCA5","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD834\uDE1C":"","":"","":"","":"","":"","\uD834\uDE15":"","\uD834\uDE2B":"","\uD81B\uDF26":"","\uD801\uDC11":"","":"\uD81B\uDF00","\uD806\uDEE6":"\uD806\uDEE5\uD806\uDEEF","\uD806\uDEE8":"\uD806\uDEE5\uD806\uDEE5","\uD806\uDEE9":"\uD806\uDEE5\uD806\uDEE5\uD806\uDEEF","\uD806\uDEEA":"\uD806\uDEE5\uD806\uDEE5\uD806\uDEF0","\uD806\uDEE7":"\uD806\uDEE5\uD806\uDEF0","\uD806\uDEF4":"\uD806\uDEF3\uD806\uDEEF","\uD806\uDEF6":"\uD806\uDEF3\uD806\uDEF3","\uD806\uDEF7":"\uD806\uDEF3\uD806\uDEF3\uD806\uDEEF","\uD806\uDEF8":"\uD806\uDEF3\uD806\uDEF3\uD806\uDEF0","\uD806\uDEF5":"\uD806\uDEF3\uD806\uDEF0","\uD806\uDEEC":"\uD806\uDEEB\uD806\uDEEF","\uD806\uDEED":"\uD806\uDEEB\uD806\uDEEB","\uD806\uDEEE":"\uD806\uDEEB\uD806\uDEEB\uD806\uDEEF","":"\uD800\uDEA8","":"\uD800\uDEA8","\uD83D\uDF28":"\uD800\uDEA8","":"\uD800\uDEA8","":"\uD800\uDEBC","\uD834\uDE14":"\uD800\uDEBC","\uD83D\uDF04":"\uD800\uDEBC","":"\uD800\uDEC0","":"\uD801\uDC3A","":"\uD801\uDC12","\uD801\uDCA0":"\uD801\uDC86","\uD800\uDFD1":"\uD800\uDF82","\uD800\uDFD3":"\uD800\uDF93","\uD808\uDC38":"\uD800\uDF9A","":"\uD802\uDD9E","\uD80C\uDEF9":"\uD802\uDD9E","":"","":"","\uD87E\uDC00":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD87E\uDC01":"","":"","\uD87E\uDC02":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD87E\uDC03":"\uD840\uDD22","":"","":"","":"","":"","":"","":"","\uD87E\uDC19":"","":"","\uD87E\uDC04":"","":"","\uD87E\uDC07":"","":"","":"","":"","":"","\uD87E\uDC05":"","\uD87E\uDC06":"","":"","":"","":"","\uD87E\uDC08":"","\uD87E\uDC09":"","\uD87E\uDC0B":"","":"","":"","\uD87E\uDC0A":"","\uD87E\uDC0C":"","":"","":"","":"","":"","":"","\uD87E\uDC0E":"","\uD87E\uDC0F":"","\uD87E\uDC10":"","":"","\uD87E\uDC14":"","":"","":"","":"","":"","":"","\uD87E\uDC11":"","\uD87E\uDC12":"\uD841\uDD1C","\uD87E\uDD1B":"\uD841\uDD25","":"","\uD87E\uDC13":"","":"","\uD87E\uDC15":"","\uD87E\uDC16":"\uD841\uDD4B","\uD87E\uDCD2":"","\uD87E\uDCD3":"","\uD87E\uDDCA":"","\uD87E\uDCD4":"","":"","\uD87E\uDC17":"","\uD87E\uDC18":"","":"","\uD87E\uDC1A":"","":"","\uD87E\uDC1B":"","":"","":"","":"","":"","":"","":"","\uD87E\uDC0D":"\uD841\uDE3A","\uD87E\uDC1D":"","":"","":"","":"","\uD87E\uDC1E":"","":"","\uD87E\uDC50":"","":"","":"","\uD87E\uDC1F":"","":"","\uD87E\uDC20":"","\uD87E\uDC21":"","\uD87E\uDC22":"","\uD87E\uDC23":"","":"","\uD87E\uDDD9":"\uD842\uDC04","":"","":"","":"","":"","\uD87E\uDC24":"","\uD87E\uDD92":"","":"","\uD87E\uDC25":"","":"","\uD87E\uDC26":"","":"","":"","":"","\uD87E\uDC27":"","":"","":"","":"","\uD87E\uDC28":"","\uD87E\uDC29":"","\uD87E\uDC2A":"","\uD87E\uDDDD":"\uD842\uDCDE","":"","":"","\uD87E\uDC2B":"","":"","":"","":"","":"","":"","":"","\uD87E\uDC2C":"","":"","":"","":"","\uD87E\uDC2D":"","\uD87E\uDC2E":"","":"","":"","":"","":"","\uD87E\uDC2F":"","":"","\uD87E\uDC30":"","\uD87E\uDC31":"","\uD87E\uDC32":"","\uD87E\uDC33":"","":"","\uD87E\uDC34":"\uD842\uDE2C","":"","":"","":"","\uD87E\uDC36":"","\uD87E\uDC37":"","\uD87E\uDC38":"\uD842\uDF63","":"","":"","":"","":"","":"","\uD87E\uDC39":"","\uD87E\uDC3A":"","\uD87E\uDC3B":"","":"","":"","\uD87E\uDC3D":"","":"","\uD87E\uDC3E":"","\uD87E\uDC3F":"","\uD87E\uDC3C":"","\uD87E\uDC40":"","":"","":"","\uD87E\uDC41":"","\uD87E\uDC42":"","\uD87E\uDC43":"","":"","":"","\uD87E\uDC44":"","\uD87E\uDC45":"","\uD87E\uDC46":"","":"","":"","\uD87E\uDC47":"","":"","":"","\uD87E\uDC48":"","\uD87E\uDC49":"","":"","\uD87E\uDC4A":"","":"","":"","\uD87E\uDC4C":"","\uD87E\uDC4E":"","\uD87E\uDC4F":"","":"","":"","\uD87E\uDC4B":"","\uD87E\uDC4D":"","":"","":"","":"","\uD87E\uDC55":"","\uD87E\uDC52":"","":"","\uD87E\uDC53":"","\uD87E\uDC54":"","\uD87E\uDC57":"","\uD87E\uDC56":"","":"","":"","":"","":"","":"","":"","\uD87E\uDC58":"","":"","":"","":"","\uD87E\uDC59":"\uD845\uDCE4","\uD87E\uDC51":"","\uD87E\uDC5A":"","\uD87E\uDC5B":"","":"","\uD87E\uDC5C":"","":"","":"","":"","\uD87E\uDC5D":"","\uD87E\uDC5E":"","":"","":"","":"","":"","":"","\uD87E\uDC5F":"","":"","":"","\uD87E\uDC60":"\uD845\uDEA8","\uD87E\uDC61":"\uD845\uDEEA","\uD87E\uDC65":"","\uD87E\uDC62":"","\uD87E\uDC63":"","\uD87E\uDC64":"","":"","\uD87E\uDC66":"","":"","\uD87E\uDC67":"","\uD87E\uDC68":"","\uD87E\uDD86":"","\uD87E\uDC69":"","":"","\uD87E\uDC6A":"","\uD87E\uDC6B":"","":"","":"","":"","\uD87E\uDC6C":"\uD846\uDDC8","\uD87E\uDC6D":"","\uD87E\uDC6E":"","":"","":"","\uD87E\uDC6F":"","":"","\uD87E\uDC70":"","\uD87E\uDC71":"\uD846\uDF18","":"","\uD87E\uDC72":"","\uD87E\uDC73":"","":"","\uD87E\uDC75":"","":"","":"","":"","\uD87E\uDC76":"","":"","":"","\uD87E\uDC77":"","":"","":"","":"","":"","\uD87E\uDC78":"","":"","\uD87E\uDCF8":"\uD847\uDD0B","":"","\uD87E\uDC79":"","\uD87E\uDC7A":"","\uD87E\uDC7B":"\uD847\uDDE4","\uD87E\uDC7D":"\uD847\uDDE6","":"","\uD87E\uDC7C":"","":"","\uD87E\uDC7F":"","\uD87E\uDC7E":"","\uD87E\uDC80":"","\uD87E\uDDF4":"","":"","":"","\uD87E\uDC82":"","":"","":"","":"","":"","\uD87E\uDC83":"","\uD87E\uDC84":"","":"","":"","\uD87E\uDC85":"","\uD87E\uDC86":"","\uD87E\uDC87":"","\uD87E\uDC88":"","\uD87E\uDC89":"\uD848\uDD83","":"","":"","\uD87E\uDD39":"\uD848\uDD9F","":"","":"","":"","":"","\uD87E\uDC8A":"","\uD87E\uDC8B":"","\uD87E\uDC8C":"","\uD87E\uDC8D":"","":"","\uD87E\uDC8E":"","":"","":"","":"","":"","":"","":"","\uD87E\uDC90":"","":"","\uD87E\uDC91":"\uD848\uDF31","\uD87E\uDC92":"\uD848\uDF31","":"","":"","":"","\uD87E\uDC94":"","\uD87E\uDC95":"","":"","":"","\uD87E\uDC74":"","\uD87E\uDC96":"","":"","\uD87E\uDC99":"","":"","\uD87E\uDC9A":"","":"","":"","\uD87E\uDC9B":"","\uD87E\uDC9C":"","":"","":"","":"","":"","":"","\uD87E\uDC9D":"","\uD87E\uDC9E":"","":"","\uD87E\uDC9F":"","":"","":"","":"","\uD87E\uDCA2":"","\uD87E\uDCA1":"","\uD87E\uDCA0":"","":"","\uD87E\uDCA3":"","\uD87E\uDCA5":"","":"","":"","\uD87E\uDCA4":"\uD849\uDED4","":"","":"","":"","\uD87E\uDCA6":"","\uD87E\uDCA7":"","\uD87E\uDCA9":"","":"","\uD87E\uDCA8":"","":"","\uD87E\uDCAA":"","":"","":"","\uD87E\uDCAB":"","":"","\uD87E\uDCAD":"","\uD87E\uDCAE":"","\uD87E\uDCAC":"","":"\uD84A\uDC44","":"\uD84A\uDC4A","\uD87E\uDCAF":"","":"","":"","\uD87E\uDCB0":"","":"","\uD87E\uDCB1":"","":"","":"","\uD87E\uDCB2":"","\uD87E\uDCB3":"","":"","":"","":"","":"","":"","":"","\uD87E\uDCB4":"","\uD87E\uDCB5":"","":"","":"","":"","\uD87E\uDCB6":"","\uD87E\uDCBA":"","":"","\uD87E\uDCB8":"\uD84A\uDF0C","\uD87E\uDCB9":"","\uD87E\uDCB7":"","\uD87E\uDCBB":"","":"","\uD87E\uDCBC":"","":"","\uD87E\uDCC1":"","":"","\uD87E\uDCBD":"","":"","\uD87E\uDCBE":"\uD84A\uDFF1","":"","\uD87E\uDCBF":"","\uD87E\uDCC0":"","\uD87E\uDCC3":"","\uD87E\uDCC6":"","\uD87E\uDCC4":"","\uD87E\uDCC2":"","":"","":"","\uD87E\uDCC5":"","":"","\uD87E\uDCC7":"","":"","":"","":"","":"","\uD87E\uDCC8":"","":"","\uD87E\uDCC9":"","":"","\uD87E\uDCCA":"\uD84C\uDC0A","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD87E\uDCCB":"","":"","":"","":"","\uD87E\uDCD1":"","\uD87E\uDCCD":"","":"","":"","":"","":"","\uD87E\uDCCF":"","":"","\uD87E\uDCD0":"","\uD87E\uDCD5":"","":"","":"","\uD87E\uDCCE":"","\uD87E\uDC97":"\uD84C\uDEB8","":"","":"","\uD87E\uDCCC":"","":"","\uD87E\uDD80":"\uD84C\uDF5F","":"","":"","":"","":"","":"","":"","":"","\uD87E\uDCD8":"","":"","":"","\uD87E\uDCD9":"","":"","":"","\uD87E\uDD89":"\uD84C\uDF93","":"","\uD87E\uDD8A":"\uD84C\uDF9C","":"","":"","\uD87E\uDCDC":"","":"","\uD87E\uDCDB":"","\uD87E\uDCDD":"\uD84C\uDFC3","":"","":"","\uD87E\uDCE0":"","":"","\uD87E\uDCDE":"","":"\uD84C\uDFD5","":"","\uD87E\uDCDF":"","":"","\uD87E\uDCE5":"","\uD87E\uDCE1":"","\uD87E\uDCE3":"\uD84D\uDC6D","":"","":"","\uD87E\uDCE2":"","\uD87E\uDCE4":"","":"","\uD87E\uDCE6":"","\uD87E\uDCE8":"","":"","\uD87E\uDCE7":"","":"","":"","\uD87E\uDCE9":"","\uD87E\uDCEA":"","":"","":"","":"","":"","\uD87E\uDCEC":"\uD84D\uDEA3","\uD87E\uDCEB":"","":"","\uD87E\uDCED":"","":"","\uD87E\uDCEE":"","":"","\uD87E\uDCEF":"","\uD87E\uDCF0":"\uD84E\uDCA7","\uD87E\uDCF1":"","\uD87E\uDCF2":"","":"","":"","\uD87E\uDCF3":"","":"","":"","":"","":"","\uD87E\uDCF4":"","":"","":"","":"","":"","\uD87E\uDCF5":"","\uD87E\uDCF6":"","\uD87E\uDCF7":"\uD84E\uDE8D","":"","":"","\uD87E\uDCF9":"\uD84E\uDEFA","":"","":"","":"","":"","":"","":"","":"","":"","\uD87E\uDCFA":"","\uD87E\uDCFE":"","":"","\uD87E\uDCFC":"","":"","\uD87E\uDCFD":"","":"","\uD87E\uDCFB":"\uD84F\uDCBC","":"","":"","\uD87E\uDD07":"","\uD87E\uDD00":"","":"","":"","\uD87E\uDD02":"","\uD87E\uDCFF":"","\uD87E\uDD03":"","":"","":"","\uD87E\uDD01":"","\uD87E\uDD04":"","\uD87E\uDD05":"","\uD87E\uDD06":"\uD84F\uDD1E","":"","":"","":"","\uD87E\uDD0E":"","":"","\uD87E\uDD08":"","\uD87E\uDD09":"","":"","":"","\uD87E\uDD0B":"","":"","":"","\uD87E\uDD0C":"","":"","":"","\uD87E\uDD0A":"","":"","":"","":"","":"","\uD87E\uDD0D":"\uD84F\uDED1","\uD87E\uDD0F":"","\uD87E\uDD10":"\uD84F\uDF5E","\uD87E\uDD11":"\uD84F\uDF8E","\uD87E\uDD12":"","":"","":"","\uD87E\uDD15":"","":"","\uD87E\uDD14":"","\uD87E\uDD13":"","\uD87E\uDD17":"","\uD87E\uDD16":"","":"","":"","\uD87E\uDC35":"","\uD87E\uDD19":"","\uD87E\uDD18":"","":"","\uD87E\uDD1A":"","":"","":"","":"","":"","\uD87E\uDD1D":"\uD850\uDE63","\uD87E\uDD1C":"","":"","":"\uD850\uDEEE","\uD87E\uDD1E":"","":"","":"","\uD87E\uDD1F":"\uD850\uDFAB","":"","":"","\uD87E\uDD20":"","":"","":"","":"","":"","\uD87E\uDD21":"","":"","":"","":"","":"","":"","\uD87E\uDD22":"","":"","\uD87E\uDD23":"\uD851\uDE08","":"","":"","\uD87E\uDD24":"","\uD87E\uDD25":"","":"","":"","":"","":"","\uD87E\uDD26":"\uD851\uDF35","":"","":"","":"","\uD87E\uDD27":"\uD852\uDC14","":"","\uD87E\uDD28":"","":"","":"","":"","":"","\uD87E\uDD29":"","\uD87E\uDD2A":"","\uD87E\uDD2B":"","":"","\uD87E\uDD2C":"","\uD87E\uDD2D":"","":"","":"","":"","":"","\uD87E\uDD2E":"","\uD87E\uDD2F":"","":"","":"","\uD87E\uDD30":"","\uD87E\uDD31":"","":"","":"","\uD87E\uDD32":"","":"","":"","\uD87E\uDD33":"","":"","":"","":"","\uD87E\uDD34":"","":"","":"","":"","\uD87E\uDD36":"","\uD87E\uDD35":"\uD853\uDC36","":"","":"","":"","\uD87E\uDD38":"","\uD87E\uDD37":"\uD853\uDC92","":"","":"","":"","\uD87E\uDD3A":"","":"","":"","":"","":"","":"","":"","\uD87E\uDD3B":"\uD853\uDFA1","\uD87E\uDD3C":"\uD853\uDFB8","":"","":"","\uD87E\uDD3D":"\uD854\uDC44","\uD87E\uDD3E":"","":"","":"","":"","":"","\uD87E\uDD3F":"","":"","":"","\uD87E\uDD40":"","\uD87E\uDD42":"\uD854\uDCF2","\uD87E\uDD41":"\uD854\uDCF3","":"","":"","\uD87E\uDD43":"\uD854\uDD19","\uD87E\uDD45":"","\uD87E\uDD46":"","\uD87E\uDD47":"","\uD87E\uDD44":"\uD854\uDD33","":"","":"","\uD87E\uDD48":"","":"","":"","\uD87E\uDD49":"","":"","\uD87E\uDD4B":"","\uD87E\uDD4A":"","":"\uD854\uDE49","":"","":"","":"","":"","\uD87E\uDD4C":"","\uD87E\uDD4D":"\uD855\uDC1D","":"","\uD87E\uDD4E":"","":"","":"","\uD87E\uDD4F":"","":"","":"","":"","\uD87E\uDD50":"","":"","\uD87E\uDD51":"","":"","":"","":"","":"","":"","":"","":"","\uD87E\uDD52":"\uD855\uDE26","":"","":"","\uD87E\uDD53":"","":"","":"","":"","":"","":"","":"","\uD87E\uDD54":"\uD855\uDE9A","":"","":"","":"","\uD87E\uDD56":"","\uD87E\uDD55":"\uD855\uDEC5","":"","":"","":"","":"","\uD87E\uDD58":"","\uD87E\uDD57":"","":"","\uD87E\uDD5A":"","":"","\uD87E\uDD59":"","\uD87E\uDD5B":"","":"","":"","\uD87E\uDD5C":"\uD856\uDD7C","":"","":"","":"","":"","\uD87E\uDD5D":"\uD856\uDEA7","\uD87E\uDD5E":"\uD856\uDEA7","\uD87E\uDD5F":"","":"","":"","":"","":"","\uD87E\uDD60":"","\uD87E\uDD61":"\uD856\uDFAB","\uD87E\uDD62":"","\uD87E\uDD64":"","\uD87E\uDD63":"","\uD87E\uDD65":"\uD857\uDC80","":"\uD857\uDCD0","":"","":"","":"","":"","":"","":"","\uD87E\uDD66":"","":"","\uD87E\uDD68":"","\uD87E\uDD67":"","\uD87E\uDD69":"","":"","":"","":"","\uD87E\uDD6B":"\uD857\uDF86","\uD87E\uDD6A":"","":"","":"","":"","":"","\uD87E\uDD6C":"","":"","":"","":"","\uD87E\uDD6E":"","":"","":"","":"","\uD87E\uDD6F":"","\uD87E\uDD6D":"","":"","":"","":"","\uD87E\uDD70":"","\uD87E\uDC98":"\uD858\uDDDA","\uD87E\uDD71":"","":"","\uD87E\uDD72":"\uD858\uDE28","":"","\uD87E\uDD73":"\uD858\uDE47","":"","":"","":"","":"","\uD87E\uDD74":"","":"","\uD87E\uDD75":"\uD858\uDED9","":"","\uD87E\uDD76":"","":"","\uD87E\uDD77":"\uD858\uDF3E","":"","\uD87E\uDD78":"","":"","":"","":"","\uD87E\uDD79":"","":"","":"","":"","":"","":"","\uD87E\uDD7A":"","":"","\uD87E\uDD7B":"\uD859\uDCDA","":"","\uD87E\uDD7C":"\uD859\uDD23","":"","":"","\uD87E\uDD7D":"","\uD87E\uDD7E":"\uD859\uDDA8","":"","\uD87E\uDD7F":"","":"","":"","":"","":"","":"","\uD87E\uDCD6":"","\uD87E\uDD82":"","\uD87E\uDD81":"","\uD87E\uDCD7":"","":"","\uD87E\uDD83":"","\uD87E\uDD85":"","\uD87E\uDD84":"","\uD87E\uDCDA":"","\uD87E\uDD87":"\uD859\uDFA7","\uD87E\uDD88":"\uD859\uDFB5","":"","":"","":"","":"","":"","":"","":"","":"","\uD87E\uDC93":"","\uD87E\uDD8B":"","\uD87E\uDD8C":"","":"","":"","":"","":"","\uD87E\uDD8E":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD87E\uDD90":"","\uD87E\uDD8F":"","\uD87E\uDD91":"","\uD87E\uDD93":"","\uD87E\uDD94":"","\uD87E\uDD95":"","":"","\uD87E\uDD98":"","\uD87E\uDD96":"","\uD87E\uDD97":"\uD85A\uDF3C","":"","":"","\uD87E\uDD9A":"","\uD87E\uDD99":"","\uD87E\uDD9C":"","\uD87E\uDD9D":"","\uD87E\uDDA0":"","":"","\uD87E\uDDA1":"","\uD87E\uDDA2":"","\uD87E\uDDA3":"","\uD87E\uDD9E":"","":"","":"","":"","\uD87E\uDD9F":"","\uD87E\uDDA4":"\uD85B\uDC36","\uD87E\uDD9B":"","":"","":"","":"","\uD87E\uDDA6":"\uD85B\uDCD5","\uD87E\uDDA5":"\uD85B\uDD6B","":"","\uD87E\uDDA8":"","\uD87E\uDDA9":"","":"","\uD87E\uDDAA":"","\uD87E\uDDA7":"","\uD87E\uDDAC":"","\uD87E\uDDAD":"\uD85B\uDF2C","":"","\uD87E\uDDAE":"","\uD87E\uDDB0":"\uD85B\uDFB1","\uD87E\uDDAF":"","":"","":"","\uD87E\uDDB2":"","":"","":"","\uD87E\uDDB1":"\uD85C\uDCD2","":"","":"","":"","":"","\uD87E\uDDB3":"","":"","\uD87E\uDDB4":"","\uD87E\uDDB5":"","\uD87E\uDDB6":"","":"","\uD87E\uDDB7":"","\uD87E\uDDB8":"","\uD87E\uDDBA":"","\uD87E\uDDB9":"","\uD87E\uDDBC":"","\uD87E\uDDBD":"","\uD87E\uDDC0":"","":"","\uD87E\uDDBB":"","\uD87E\uDDBE":"","\uD87E\uDDBF":"","\uD87E\uDDAB":"\uD85C\uDFCA","":"","\uD87E\uDDC1":"","\uD87E\uDDC2":"","":"","":"","":"","":"","\uD87E\uDDC3":"","\uD87E\uDDC4":"","":"","":"","":"","\uD87E\uDDC5":"\uD85D\uDE67","":"","\uD87E\uDDC6":"","\uD87E\uDDC7":"","":"","":"","\uD87E\uDDC9":"","\uD87E\uDDC8":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD87E\uDDCB":"\uD85E\uDCAE","":"","":"","":"","\uD87E\uDDCC":"\uD85E\uDD66","":"","":"","\uD87E\uDDCD":"","\uD87E\uDDCE":"","\uD87E\uDDCF":"","":"","":"","":"","":"","":"","":"","":"","\uD87E\uDDD0":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD87E\uDDD1":"","":"","":"","":"","":"","\uD87E\uDDD2":"","":"","":"","":"","\uD87E\uDDD3":"\uD85F\uDCA8","":"","\uD87E\uDDD4":"","\uD87E\uDDD5":"","":"","":"","":"","":"","":"","\uD87E\uDDD6":"","":"","":"","":"","\uD87E\uDDD7":"","":"","":"\uD85F\uDED3","\uD87E\uDDD8":"\uD85F\uDF2F","":"","\uD87E\uDDDA":"","\uD87E\uDDDB":"","":"","":"","\uD87E\uDDDC":"","":"","":"","":"","":"","\uD87E\uDDDE":"","":"","":"","":"","":"","\uD87E\uDDDF":"","":"","":"","":"","":"","\uD87E\uDD8D":"","":"","":"","":"","":"","":"","":"","\uD87E\uDC81":"","":"","":"","":"","":"","":"","\uD87E\uDDE0":"\uD861\uDDD2","\uD87E\uDDE1":"\uD861\uDDED","":"","":"","\uD87E\uDDE2":"","":"","":"","":"","\uD87E\uDDE3":"","":"","\uD87E\uDDE5":"\uD861\uDF2E","\uD87E\uDDE4":"","\uD87E\uDDE6":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD87E\uDDE7":"","":"","\uD87E\uDDE8":"","\uD87E\uDDE9":"","\uD87E\uDDEA":"","":"","":"","":"","\uD87E\uDDEB":"","\uD87E\uDDEC":"","\uD87E\uDDED":"\uD862\uDFFA","":"","":"","":"","":"","":"","":"","\uD87E\uDDEE":"","\uD87E\uDDEF":"","":"","\uD87E\uDDF0":"","\uD87E\uDDF1":"\uD863\uDD77","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\uD87E\uDDF2":"","":"","":"","":"","":"","":"","\uD87E\uDDF3":"","":"","":"","":"","":"","":"","":"","\uD87E\uDDF5":"","\uD87E\uDDF6":"\uD864\uDD45","":"","":"","":"","":"","":"","":"","\uD87E\uDC1C":"\uD864\uDDDF","":"","":"","\uD87E\uDDF7":"\uD864\uDE1A","":"","\uD87E\uDDF8":"","\uD87E\uDDF9":"","":"","":"","\uD87E\uDDFA":"","":"","":"","\uD87E\uDDFB":"\uD865\uDC0A","":"","":"","":"","":"","\uD87E\uDDFC":"","":"","\uD87E\uDDFE":"","\uD87E\uDDFF":"","":"","\uD87E\uDE00":"","\uD87E\uDDFD":"\uD865\uDC96","":"","":"","":"","":"","":"","\uD87E\uDE01":"\uD865\uDDB6","":"","":"","":"","":"","":"","":"","\uD87E\uDE02":"","":"","":"","\uD87E\uDE03":"","":"","\uD87E\uDE04":"","":"","":"","":"","\uD87E\uDE05":"","":"","\uD87E\uDE06":"","":"","\uD87E\uDE07":"","":"","":"","":"","\uD87E\uDE08":"","":"","":"","\uD87E\uDE09":"\uD866\uDF30","":"","\uD87E\uDE0A":"","":"","":"","":"","":"","":"","":"","":"","\uD87E\uDE0B":"","":"","":"","":"","\uD87E\uDE0C":"","\uD87E\uDE0D":"","\uD87E\uDE0F":"","\uD87E\uDE0E":"","\uD87E\uDE10":"\uD868\uDCCE","":"","\uD87E\uDE12":"\uD868\uDD05","\uD87E\uDE11":"","":"","\uD87E\uDE13":"\uD868\uDE0E","":"","":"","":"","":"","":"","\uD87E\uDE14":"\uD868\uDE91","":"","":"","":"","":"","\uD87E\uDE15":"","":"","\uD87E\uDC8F":"\uD868\uDF92","":"","":"","":"","":"","\uD87E\uDE16":"","":"","":"","":"","\uD87E\uDE17":"","":"","":"","\uD87E\uDE19":"","\uD87E\uDE18":"","":"","\uD87E\uDE1A":"","":"","\uD87E\uDE1B":"","":"","\uD87E\uDE1C":"","":"","":"","":"","":"","":"","\uD87E\uDE1D":"\uD869\uDE00","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":""}')},81551:(e,t,r)=>{"use strict";r.d(t,{A:()=>s});var n=r(86042);let i=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return t.filter((e,t,r)=>!!e&&r.indexOf(e)===t).join(" ")};var o={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};let a=(0,n.forwardRef)((e,t)=>{let{color:r="currentColor",size:a=24,strokeWidth:s=2,absoluteStrokeWidth:l,className:c="",children:d,iconNode:u,...h}=e;return(0,n.createElement)("svg",{ref:t,...o,width:a,height:a,stroke:r,strokeWidth:l?24*Number(s)/Number(a):s,className:i("lucide",c),...h},[...u.map(e=>{let[t,r]=e;return(0,n.createElement)(t,r)}),...Array.isArray(d)?d:[d]])}),s=(e,t)=>{let r=(0,n.forwardRef)((r,o)=>{let{className:s,...l}=r;return(0,n.createElement)(a,{ref:o,iconNode:t,className:i("lucide-".concat(e.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase()),s),...l})});return r.displayName="".concat(e),r}},81626:(e,t,r)=>{"use strict";r.d(t,{M6:()=>o,qr:()=>a,xu:()=>i});var n=r(84458);class i{constructor(e,t){if(this.stable=e,this.unstable=t,!this.unstable&&!this.stable)throw Error("One of stable or unstable values must be supplied")}get name(){return this.stable?this.stable:this.unstable}get altName(){return this.stable?this.unstable:null}get names(){var e=[this.name],t=this.altName;return t&&e.push(t),e}matches(e){return this.name===e||this.altName===e}findIn(e){var t=void 0;return this.name&&(t=null==e?void 0:e[this.name]),!t&&this.altName&&(t=null==e?void 0:e[this.altName]),t}includedIn(e){var t=!1;return this.name&&(t=e.includes(this.name)),!t&&this.altName&&(t=e.includes(this.altName)),t}}class o extends i{constructor(){super(...arguments),(0,n.A)(this,"preferUnstable",!1)}setPreferUnstable(e){this.preferUnstable=e}get name(){return this.stable&&!this.preferUnstable?this.stable:this.unstable}}class a extends i{constructor(e,t){if(super(e,t),!this.unstable)throw Error("Unstable value must be supplied")}get name(){return this.unstable}get altName(){return this.stable}}},82393:(e,t,r)=>{"use strict";r.d(t,{OQ:()=>y,P0:()=>f,fb:()=>m.f,kl:()=>b});var n=r(29301),i=r(84458),o=r(19599),a=r(5408),s=r(9086),l=r(11749),c=r(37151),d=r(75525),u=r(15095),h=r(70489),v=r(12411),p=r(37858),m=r(96170),g=Object.freeze({visible:!0}),f=36e5,y=function(e){return e.Decrypted="Event.decrypted",e.BeforeRedaction="Event.beforeRedaction",e.VisibilityChange="Event.visibilityChange",e.LocalEventIdReplaced="Event.localEventIdReplaced",e.Status="Event.status",e.Replaced="Event.replaced",e.RelationsCreated="Event.relationsCreated",e.SentinelUpdated="Event.sentinelUpdated",e}({});class b extends u.X{setMetadata(e,t){var r,n,i=this.isState()&&this.getType()===s.Bx.RoomMember&&this.getSender()===this.getStateKey(),o=!1;if(i||!(null!=(r=this.sender)&&null!=(r=r.events)&&r.member)){var a=e.getSentinelMember(this.getSender());a!==this.sender&&(o=!0),this.sender=a}if(i||!(null!=(n=this.target)&&null!=(n=n.events)&&n.member)&&this.getType()===s.Bx.RoomMember){var l=e.getSentinelMember(this.getStateKey());l!==this.target&&(o=!0),this.target=l}this.isState()&&t&&(this.forwardLooking=!1),o&&this.emit(y.SentinelUpdated)}constructor(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super(),this.event=t,(0,i.A)(this,"pushDetails",{}),(0,i.A)(this,"_replacingEvent",null),(0,i.A)(this,"_localRedactionEvent",null),(0,i.A)(this,"_isCancelled",!1),(0,i.A)(this,"clearEvent",void 0),(0,i.A)(this,"visibility",g),(0,i.A)(this,"_hasCachedExtEv",!1),(0,i.A)(this,"_cachedExtEv",void 0),(0,i.A)(this,"_decryptionFailureReason",null),(0,i.A)(this,"senderCurve25519Key",null),(0,i.A)(this,"claimedEd25519Key",null),(0,i.A)(this,"keyForwardedBy",void 0),(0,i.A)(this,"decryptionPromise",null),(0,i.A)(this,"retryDecryption",!1),(0,i.A)(this,"txnId",void 0),(0,i.A)(this,"thread",void 0),(0,i.A)(this,"threadId",void 0),(0,i.A)(this,"localTimestamp",void 0),(0,i.A)(this,"sender",null),(0,i.A)(this,"target",null),(0,i.A)(this,"status",null),(0,i.A)(this,"error",null),(0,i.A)(this,"forwardLooking",!0),(0,i.A)(this,"reEmitter",void 0),(0,i.A)(this,"unstableStickyExpiresAt",void 0),["state_key","type","sender","room_id","membership"].forEach(e=>{"string"==typeof t[e]&&(t[e]=(0,l.yD)(t[e]))}),["membership","avatar_url","displayname"].forEach(e=>{var r;"string"==typeof(null==(r=t.content)?void 0:r[e])&&(t.content[e]=(0,l.yD)(t.content[e]))}),["rel_type"].forEach(e=>{var r;"string"==typeof(null==(r=t.content)||null==(r=r["m.relates_to"])?void 0:r[e])&&(t.content["m.relates_to"][e]=(0,l.yD)(t.content["m.relates_to"][e]))}),this.txnId=t.txn_id;var r=this.getAge(),n=Date.now();this.localTimestamp=void 0!==r?n-r:null!=(e=this.getTs())?e:n,this.reEmitter=new d.Q(this),this.unstableStickyInfo&&(this.unstableStickyInfo.duration_ttl_ms?this.unstableStickyExpiresAt=n+this.unstableStickyInfo.duration_ttl_ms:this.unstableStickyExpiresAt=Math.min(n,this.getTs())+this.unstableStickyInfo.duration_ms)}get unstableExtensibleEvent(){if(!this._hasCachedExtEv){var e;this._cachedExtEv=null!=(e=o.ExtensibleEvents.parse(this.getEffectiveEvent()))?e:void 0}return this._cachedExtEv}invalidateExtensibleEvent(){this._hasCachedExtEv=!1}getEffectiveEvent(){var e=Object.assign({},this.getContent());if(this.getWireType()===s.Bx.RoomMessageEncrypted)for(var[t,r]of Object.entries(this.getWireContent()))["algorithm","ciphertext","device_id","sender_key","session_id"].includes(t)||void 0===e[t]&&(e[t]=r);return Object.assign({},this.event,this.clearEvent,{content:e})}getId(){return this.event.event_id}getSender(){return this.event.sender}getType(){return this.clearEvent?this.clearEvent.type:this.event.type}getWireType(){return this.event.type}getRoomId(){return this.event.room_id}getTs(){return this.event.origin_server_ts}getDate(){return this.event.origin_server_ts?new Date(this.event.origin_server_ts):null}getDetails(){var e,t=this.getRoomId();if(t)return"id=".concat(this.getId()," type=").concat(this.getWireType()," sender=").concat(this.getSender()," room=").concat(t," ts=").concat(null==(e=this.getDate())?void 0:e.toISOString());var r=this.getContent()[s.wt];return"msgid=".concat(r," type=").concat(this.getWireType()," sender=").concat(this.getSender())}getOriginalContent(){var e,t;return this._localRedactionEvent?{}:this.clearEvent?null!=(t=this.clearEvent.content)?t:{}:null!=(e=this.event.content)?e:{}}getContent(){var e;return this._localRedactionEvent?{}:this._replacingEvent?null!=(e=this._replacingEvent.getContent()["m.new_content"])?e:{}:this.getOriginalContent()}getWireContent(){return this.event.content||{}}get threadRootId(){if(!this.isState()){var e,t=null==(e=this.getWireContent())?void 0:e["m.relates_to"];if((null==t?void 0:t.rel_type)===c.RN.name)return t.event_id;if(this.thread)return this.thread.id;if(void 0!==this.threadId)return this.threadId;var r=this.getUnsigned();if("string"==typeof r[s.Sr.name])return r[s.Sr.name]}}get isThreadRoot(){return!this.isState()&&(!!this.getServerAggregatedRelation(c.RN.name)||this.threadRootId===this.getId())}get replyEventId(){var e;return null==(e=this.getWireContent()["m.relates_to"])||null==(e=e["m.in_reply_to"])?void 0:e.event_id}get relationEventId(){var e;return null==(e=this.getWireContent())||null==(e=e["m.relates_to"])?void 0:e.event_id}getPrevContent(){return this.getUnsigned().prev_content||{}}getDirectionalContent(){return this.forwardLooking?this.getContent():this.getPrevContent()}getAge(){return this.getUnsigned().age}getLocalAge(){return Date.now()-this.localTimestamp}getStateKey(){return this.clearEvent?this.clearEvent.state_key:this.event.state_key}getWireStateKey(){return this.event.state_key}isState(){return void 0!==this.event.state_key}getMembershipAtEvent(){var e=this.getUnsigned();return s.SY.findIn(e)}makeEncrypted(e,t,r,n){this.clearEvent={type:this.event.type,content:this.event.content,state_key:this.event.state_key},this.event.type=e,this.event.content=t,this.senderCurve25519Key=r,this.claimedEd25519Key=n,this.isState()&&(this.event.state_key="".concat(this.clearEvent.type,":").concat(this.clearEvent.state_key))}isBeingDecrypted(){return null!=this.decryptionPromise}getDecryptionPromise(){return this.decryptionPromise}isDecryptionFailure(){return null!==this._decryptionFailureReason}get decryptionFailureReason(){return this._decryptionFailureReason}shouldAttemptDecryption(){return!(this.isRedacted()||this.isBeingDecrypted())&&!this.clearEvent&&!!this.isEncrypted()}attemptDecryption(e){var t=arguments,r=this;return(0,n.A)(function*(){var n=t.length>1&&void 0!==t[1]?t[1]:{};if(!r.isEncrypted())throw Error("Attempt to decrypt event which isn't encrypted");if(r.clearEvent&&!r.isDecryptionFailure())throw Error("Attempt to decrypt event which has already been decrypted");return r.decryptionPromise?(a.vF.log("Event ".concat(r.getId()," already being decrypted; queueing a retry")),r.retryDecryption=!0):r.decryptionPromise=r.decryptionLoop(e,n),r.decryptionPromise})()}getKeyRequestRecipients(e){return[{userId:e,deviceId:"*"}]}decryptionLoop(e){var t=arguments,r=this;return(0,n.A)(function*(){var n=t.length>1&&void 0!==t[1]?t[1]:{};for(yield Promise.resolve();;){r.retryDecryption=!1;var i=void 0;try{var o=yield e.decryptEvent(r);!0===n.isRetry&&a.vF.info("Decrypted event on retry (".concat(r.getDetails(),")")),r.setClearData(o),r._decryptionFailureReason=null}catch(e){var s=e instanceof h.O?e.detailedString:String(e);if(i=e,r.retryDecryption){a.vF.log("Error decrypting event (".concat(r.getDetails(),"), but retrying: ").concat(s));continue}a.vF.warn("Error decrypting event (".concat(r.getDetails(),"): ").concat(s)),r.setClearDataForDecryptionFailure(String(e)),r._decryptionFailureReason=e instanceof h.O?e.code:p.RT.UNKNOWN_ERROR}r.decryptionPromise=null,r.retryDecryption=!1,r.setPushDetails(),!1!==n.emit&&r.emit(y.Decrypted,r,i);return}})()}setClearData(e){var t,r;this.clearEvent=e.clearEvent,this.senderCurve25519Key=null!=(t=e.senderCurve25519Key)?t:null,this.claimedEd25519Key=null!=(r=e.claimedEd25519Key)?r:null,this.keyForwardedBy=e.keyForwardedBy,this.invalidateExtensibleEvent()}setClearDataForDecryptionFailure(e){this.clearEvent={type:s.Bx.RoomMessage,content:{msgtype:"m.bad.encrypted",body:"** Unable to decrypt: ".concat(e," **")}},this.senderCurve25519Key=null,this.claimedEd25519Key=null,this.invalidateExtensibleEvent()}getClearContent(){return this.clearEvent?this.clearEvent.content:null}isEncrypted(){return this.event.type===s.Bx.RoomMessageEncrypted}getSenderKey(){return this.senderCurve25519Key}getKeysClaimed(){return this.claimedEd25519Key?{ed25519:this.claimedEd25519Key}:{}}getClaimedEd25519Key(){return this.claimedEd25519Key}getForwardingCurve25519KeyChain(){return[]}isKeySourceUntrusted(){return!1}getKeyForwardingUser(){return this.keyForwardedBy}getUnsigned(){return this.event.unsigned||{}}setUnsigned(e){this.event.unsigned=e}unmarkLocallyRedacted(){var e=this._localRedactionEvent;return this._localRedactionEvent=null,this.event.unsigned&&(this.event.unsigned.redacted_because=void 0),!!e}markLocallyRedacted(e){this._localRedactionEvent||(this.emit(y.BeforeRedaction,this,e),this._localRedactionEvent=e,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=e.event)}applyVisibilityEvent(e){var t,r,n=null==(t=null==e?void 0:e.visible)||t,i=null!=(r=null==e?void 0:e.reason)?r:null,o=!1;this.visibility.visible!==n?o=!0:this.visibility.visible||this.visibility.reason===i||(o=!0),o&&(n?this.visibility=g:this.visibility=Object.freeze({visible:!1,reason:i}),this.emit(y.VisibilityChange,this,n))}messageVisibility(){return this.visibility}makeRedacted(e,t){if(!e.event)throw Error("invalid redactionEvent in makeRedacted");for(var r in this._localRedactionEvent=null,this.emit(y.BeforeRedaction,this,e),this._replacingEvent=null,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=e.event,this.event)this.event.hasOwnProperty(r)&&!S.has(r)&&delete this.event[r];this.isEncrypted()&&(this.clearEvent=void 0);var n=this.getType()in E?E[this.getType()]:{},i=this.getContent();for(var o in i)i.hasOwnProperty(o)&&!n[o]&&delete i[o];!this.isThreadRoot&&this.threadRootId&&this.threadRootId!==this.getId()&&(this.moveAllRelatedToMainTimeline(t),e.moveToMainTimeline(t)),this.invalidateExtensibleEvent()}moveAllRelatedToMainTimeline(e){var t,r=this.thread;if(this.moveToMainTimeline(e),r)for(var n of r.events)(null==(t=n.getRelation())?void 0:t.event_id)===this.getId()&&n.moveAllRelatedToMainTimeline(e)}moveToMainTimeline(e){null==(t=this.thread)||t.timelineSet.removeEvent(this.getId()),this.setThread(void 0);var t,r=e.getLiveTimeline();r.getTimelineSet().insertEventIntoTimeline(this,r,r.getState(v.q.FORWARDS),!1)}isRedacted(){return!!this.getUnsigned().redacted_because}isRedaction(){return this.getType()===s.Bx.RoomRedaction}asVisibilityChange(){if(!s.Yg.matches(this.getType()))return null;var e=this.getRelation();if(!e||"m.reference"!=e.rel_type)return null;var t=e.event_id;if(!t)return null;var r=this.getWireContent(),n=!!r.visible,i=r.reason;return i&&"string"!=typeof i?null:{visible:n,reason:i,eventId:t}}isVisibilityEvent(){return s.Yg.matches(this.getType())}getRedactionEvent(){var e,t,r,n;return this.isRedacted()?null!=(e=this.clearEvent)&&e.unsigned?null!=(r=null==(n=this.clearEvent)?void 0:n.unsigned.redacted_because)?r:null:null!=(t=this.event.unsigned)&&t.redacted_because?this.event.unsigned.redacted_because:{}:null}getPushActions(){return this.pushDetails.actions||null}getPushDetails(){return this.pushDetails}setPushDetails(e,t){this.pushDetails={actions:e,rule:t}}handleRemoteEcho(e){var t,r=this.getUnsigned(),n=this.getId();this.event=e,r.redacted_because&&(this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=r.redacted_because),this.setStatus(null),this.getId()!==n&&this.emit(y.LocalEventIdReplaced,this),this.localTimestamp=Date.now()-(null!=(t=this.getAge())?t:0)}isSending(){return!!this.status}setStatus(e){this.status=e,this.emit(y.Status,this,e)}replaceLocalEventId(e){this.event.event_id=e,this.emit(y.LocalEventIdReplaced,this)}isRelation(e){var t,r=null==(t=this.getWireContent())?void 0:t["m.relates_to"];return!(this.isState()&&null!=r&&r.rel_type&&[s.zZ.Replace,s.zZ.Thread].includes(r.rel_type))&&!!(null!=r&&r.rel_type&&r.event_id&&(!e||r.rel_type===e))}getRelation(){var e;return this.isRelation()&&null!=(e=this.getWireContent()["m.relates_to"])?e:null}makeReplaced(e){this.isRedacted()&&e||this.isState()||this._replacingEvent!==e&&(this._replacingEvent=null!=e?e:null,this.emit(y.Replaced,this),this.invalidateExtensibleEvent())}getAssociatedStatus(){return this._replacingEvent?this._replacingEvent.status:this._localRedactionEvent?this._localRedactionEvent.status:this.status}getServerAggregatedRelation(e){var t;return null==(t=this.getUnsigned()["m.relations"])?void 0:t[e]}replacingEventId(){var e=this.getServerAggregatedRelation(s.zZ.Replace);return e?e.event_id:this._replacingEvent?this._replacingEvent.getId():void 0}replacingEvent(){return this._replacingEvent}replacingEventDate(){var e,t=this.getServerAggregatedRelation(s.zZ.Replace);if(t){var r=t.origin_server_ts;if(Number.isFinite(r))return new Date(r)}else if(this._replacingEvent)return null!=(e=this._replacingEvent.getDate())?e:void 0}localRedactionEvent(){return this._localRedactionEvent}getAssociatedId(){var e=this.getRelation();return this.replyEventId?this.replyEventId:e?e.event_id:this.isRedaction()?this.event.redacts:void 0}hasAssociation(){return!!this.getAssociatedId()}updateAssociatedId(e){var t=this.getRelation();t?t.event_id=e:this.isRedaction()&&(this.event.redacts=e)}flagCancelled(){var e=!(arguments.length>0)||void 0===arguments[0]||arguments[0];this._isCancelled=e}isCancelled(){return this._isCancelled}toSnapshot(){var e=new b(JSON.parse(JSON.stringify(this.event)));for(var[t,r]of Object.entries(this))"event"!==t&&(e[t]=r);return e}isEquivalentTo(e){if(!e)return!1;if(e===this)return!0;var t=(0,l.hl)(this.event),r=(0,l.hl)(e.event);return JSON.stringify(t)===JSON.stringify(r)}toJSON(){var e=this.getEffectiveEvent();return this.isEncrypted()?{decrypted:e,encrypted:this.event}:e}setTxnId(e){this.txnId=e}getTxnId(){return this.txnId}setThread(e){!this.isState()&&(this.thread&&this.reEmitter.stopReEmitting(this.thread,[c.ju.Update]),this.thread=e,this.setThreadId(null==e?void 0:e.id),e&&this.reEmitter.reEmit(e,[c.ju.Update]))}getThread(){return this.thread}setThreadId(e){this.threadId=e}get unstableStickyInfo(){var e,t;if(null!=(e=this.event.msc4354_sticky)&&e.duration_ms)return{duration_ms:Math.min(f,this.event.msc4354_sticky.duration_ms),duration_ttl_ms:null==(t=this.event.unsigned)?void 0:t.msc4354_sticky_duration_ttl_ms}}}var S=new Set(["event_id","type","room_id","user_id","sender","state_key","prev_state","content","unsigned","origin_server_ts"]),E={[s.Bx.RoomMember]:{membership:1},[s.Bx.RoomJoinRules]:{join_rule:1},[s.Bx.RoomPowerLevels]:{ban:1,events:1,events_default:1,kick:1,redact:1,state_default:1,users:1,users_default:1}}},83656:(e,t,r)=>{"use strict";r.d(t,{y:()=>o});var n=/^(?:(?:\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})|(?:\[[\dA-Fa-f:.]{2,45}])|(?:[A-Za-z\d\-.]{1,255}))(?::\d{1,5})?$/,i=/^[\w-]+$/;function o(e,t,r,o,a){var s,l,c=arguments.length>5&&void 0!==arguments[5]&&arguments[5],d=arguments.length>6?arguments[6]:void 0,u=arguments.length>7?arguments[7]:void 0;if("string"!=typeof t||!t)return"";if(!t.startsWith("mxc://"))if(c)return t;else return"";var[h,v,...p]=t.slice(6).split("/");if(p.length>0||(null==(s=n.exec(h))?void 0:s[0])!==h||(null==(l=i.exec(v))?void 0:l[0])!==v)return"";u&&(d=!0);var m=r||o||a?"thumbnail":"download",g=new URL("".concat(u?"/_matrix/client/v1/media/".concat(m):"/_matrix/media/v3/".concat(m),"/").concat(h,"/").concat(v),e);return r&&g.searchParams.set("width",Math.round(r).toString()),o&&g.searchParams.set("height",Math.round(o).toString()),a&&g.searchParams.set("method",a),"boolean"==typeof d&&g.searchParams.set("allow_redirect",JSON.stringify(d)),g.href}},84119:(e,t,r)=>{"use strict";r.d(t,{I:()=>$});var n=r(29301),i=r(84458),o=r(49699),a=r(15095),s=r(29927),l=r(5408),c=r(12411),d=r(9086),u=r(5294),h=r(59741),v=r(11749),p=r(20748),m=r(35095);class g{static equal(e,t){return(0,v.ky)(null==e?void 0:e.membershipData,null==t?void 0:t.membershipData)}constructor(e,t,r,n){this.membershipData=t,this.rtcBackendIdentity=r,(0,i.A)(this,"logger",void 0),(0,i.A)(this,"matrixEventData",void 0);var[o,a,s]=[e.getId(),e.getSender(),e.getTs()];if(void 0===o)throw Error("parentEvent is missing eventId field");if(void 0===a)throw Error("parentEvent is missing sender field");this.matrixEventData={eventId:o,sender:a,ts:s},this.logger=null==n?void 0:n.getChild("[CallMembership ".concat(a,":").concat(this.deviceId,"]"))}static computeRtcBackendIdentity(e,t){return(0,n.A)(function*(){var{kind:r,data:n}=t;switch(r){case"rtc":return g.computeRtcIdentityRaw(n.member.user_id,n.member.device_id,n.member.id);case"session":return"".concat(e.getSender(),":").concat(n.device_id)}})()}static computeRtcIdentityRaw(e,t,r){return(0,n.A)(function*(){return(0,m.PP)((yield(0,p.s)("".concat(e,"|").concat(t,"|").concat(r))))})()}static membershipDataFromMatrixEvent(e){var t,[r,n,i]=[e.getId(),e.getSender(),e.getContent()];if(void 0===r)throw Error("parentEvent is missing eventId field");if(void 0===n)throw Error("parentEvent is missing sender field");var o=[],a=[];if("string"!=typeof i.device_id&&o.push(" - device_id must be string"),"string"!=typeof i.call_id&&o.push(" - call_id must be string"),"string"!=typeof i.application&&o.push(" - application must be a string"),"string"!=typeof(null==(t=i.focus_active)?void 0:t.type)&&o.push(" - focus_active.type must be a string"),void 0===i.focus_active&&o.push(" - focus_active has an invalid type"),void 0===i.foci_preferred||Array.isArray(i.foci_preferred)&&i.foci_preferred.every(e=>"object"==typeof e&&null!==e&&"string"==typeof e.type)||o.push(" - foci_preferred must be an array of transport objects"),void 0!==i.created_ts&&"number"!=typeof i.created_ts&&o.push(" - created_ts must be number"),void 0!==i.scope&&"string"!=typeof i.scope&&o.push(" - scope must be string"),void 0!==i["m.call.intent"]&&"string"!=typeof i["m.call.intent"]&&o.push(" - m.call.intent must be a string"),0===o.length)return{kind:"session",data:i};if(((e,t,r)=>{var n;if("string"!=typeof e.slot_id?t.push(" - slot_id must be string"):2!==e.slot_id.split("#").length&&t.push(' - slot_id must include exactly one "#"'),"object"!=typeof e.member||null===e.member?t.push(" - member must be an object"):("string"!=typeof e.member.user_id?t.push(" - member.user_id must be string"):h.sh.test(e.member.user_id)?e.member.user_id!==r&&t.push(" - member.user_id must match the sender"):t.push(" - member.user_id must be a valid mxid"),"string"!=typeof e.member.device_id&&t.push(" - member.device_id must be string"),"string"!=typeof e.member.id&&t.push(" - member.id must be string")),"object"!=typeof e.application||null===e.application?t.push(" - application must be an object"):"string"!=typeof e.application.type?t.push(" - application.type must be a string"):e.application.type.includes("#")&&t.push(' - application.type must not include "#"'),void 0!==e.rtc_transports&&Array.isArray(e.rtc_transports)){for(var i of e.rtc_transports)if("object"!=typeof i||null===i||"string"!=typeof i.type){t.push(" - rtc_transports entries must be objects with a string type");break}}else t.push(" - rtc_transports must be an array");if(void 0!==e.versions&&Array.isArray(e.versions)?e.versions.every(e=>"string"==typeof e)||t.push(" - versions must be an array of strings"):t.push(" - versions must be an array"),(null!=(n=e.sticky_key)?n:e.msc4354_sticky_key)===void 0&&t.push(" - sticky_key or msc4354_sticky_key must be a defined"),void 0!==e.sticky_key&&"string"!=typeof e.sticky_key&&t.push(" - sticky_key must be a string"),void 0!==e.msc4354_sticky_key&&"string"!=typeof e.msc4354_sticky_key&&t.push(" - msc4354_sticky_key must be a string"),void 0!==e.sticky_key&&void 0!==e.msc4354_sticky_key&&e.sticky_key!==e.msc4354_sticky_key&&t.push(" - sticky_key and msc4354_sticky_key must be equal if both are defined"),void 0!==e["m.relates_to"]){var o=e["m.relates_to"];"object"!=typeof o||null===o?t.push(" - m.relates_to must be an object if provided"):("string"!=typeof o.event_id&&t.push(" - m.relates_to.event_id must be a string"),"m.reference"!==o.rel_type&&t.push(" - m.relates_to.rel_type must be m.reference"))}return 0===t.length})(i,a,n))return{kind:"rtc",data:i};throw Error("unknown CallMembership data.\n"+(o.length<a.length?"Does not match MSC4143 m.call.member:\n".concat(o.join("\n"),"\n\n"):"Does not match MSC4143 m.rtc.member:\n".concat(a.join("\n"),"\n\n"))+"\nevent:\n"+JSON.stringify(i).replaceAll('"',"'"))}get sender(){return this.userId}get userId(){var{kind:e,data:t}=this.membershipData;return"rtc"===e?t.member.user_id:this.matrixEventData.sender}get eventId(){return this.matrixEventData.eventId}get slotId(){var{kind:e,data:t}=this.membershipData;return"rtc"===e?t.slot_id:G({application:this.application,id:""===t.call_id?"ROOM":t.call_id})}get deviceId(){var{kind:e,data:t}=this.membershipData;return"rtc"===e?t.member.device_id:t.device_id}get callIntent(){var{kind:e,data:t}=this.membershipData;if("rtc"!==e)return t["m.call.intent"];var r,n=t.application["m.call.intent"];return"string"==typeof n?n:void(null==(r=this.logger)||r.warn("RTC membership has invalid m.call.intent"))}get slotDescription(){return function(e){var[t,r]=e.split("#");return{application:t,id:r}}(this.slotId)}get application(){var{kind:e,data:t}=this.membershipData;return"rtc"===e?t.application.type:t.application}get applicationData(){var{kind:e,data:t}=this.membershipData;return"rtc"===e?t.application:{type:t.application,"m.call.intent":t["m.call.intent"]}}get scope(){var{kind:e,data:t}=this.membershipData;if("rtc"!==e)return t.scope}get membershipID(){return this.memberId}get memberId(){var e,{kind:t,data:r}=this.membershipData;return"rtc"===t?r.member.id:null!=(e=r.membershipID)?e:"".concat(this.matrixEventData.sender,":").concat(r.device_id)}createdTs(){var e,{kind:t,data:r}=this.membershipData;return"rtc"===t?this.matrixEventData.ts:null!=(e=r.created_ts)?e:this.matrixEventData.ts}getAbsoluteExpiry(){var e,{kind:t,data:r}=this.membershipData;if("rtc"!==t)return this.createdTs()+(null!=(e=r.expires)?e:144e5)}getMsUntilExpiry(){var{kind:e}=this.membershipData;if("rtc"!==e)return this.getAbsoluteExpiry()-Date.now()}isExpired(){var{kind:e}=this.membershipData;return"rtc"!==e&&0>=this.getMsUntilExpiry()}getTransport(e){var{kind:t,data:r}=this.membershipData;switch(t){case"rtc":return r.rtc_transports[0];case"session":switch(r.focus_active.focus_selection){case"multi_sfu":return r.foci_preferred[0];case"oldest_membership":if(g.equal(this,e))return r.foci_preferred[0];if(void 0!==e)return e.getTransport(e)}}}getFocusActive(){var{kind:e,data:t}=this.membershipData;if("session"===e)return t.focus_active}get transports(){var{kind:e,data:t}=this.membershipData;return"rtc"===e?t.rtc_transports:t.foci_preferred}get kind(){return this.membershipData.kind}}var f=r(24673),y=r(71453),b=function(e){return e.Disconnected="Disconnected",e.Connecting="Connecting",e.Connected="Connected",e.Disconnecting="Disconnecting",e.Unknown="Unknown",e}({}),S=(e,t,r)=>e.sender===t&&e.deviceId===r;class E{constructor(e,t){this.membershipLoopHandler=e,(0,i.A)(this,"logger",void 0),(0,i.A)(this,"running",!1),(0,i.A)(this,"wakeup",e=>{this.logger.error("Cannot call wakeup before calling `startWithJoin()`")}),(0,i.A)(this,"_actions",[]),this.logger=(null!=t?t:l.vF).getChild("[NewMembershipActionScheduler]")}get actions(){return this._actions}startWithJoin(){var e=this;return(0,n.A)(function*(){if(e.running)return void e.logger.error("Cannot call startWithJoin() on NewMembershipActionScheduler while already running");e.running=!0,e._actions=[{ts:Date.now(),type:A.SendDelayedEvent}];try{for(var t=function*(){e._actions.sort((e,t)=>e.ts-t.ts);var t=e._actions[0],r=void 0,n=new Promise(t=>{e.wakeup=e=>{r=e,t()}});t.ts>Date.now()&&(yield Promise.race([n,(0,v.yy)(t.ts-Date.now())]));var i={};if(!r){e.logger.debug("Current MembershipManager processing: ".concat(t.type,"\nQueue:"),e._actions,'\nDate.now: "'.concat(Date.now()));try{i=yield e.membershipLoopHandler(t.type)}catch(e){throw Error("The MembershipManager shut down because of the end condition: ".concat(e))}}e._actions.splice(0,1);var o=null!=r?r:i;"replace"in o?e._actions=o.replace:"insert"in o&&e._actions.push(...o.insert)};e._actions.length>0;)yield*t()}finally{e.running=!1}e.logger.debug("Leave MembershipManager ActionScheduler loop (no more actions)")})()}initiateJoin(){var e;null==(e=this.wakeup)||e.call(this,{replace:[{ts:Date.now(),type:A.SendDelayedEvent}]})}initiateLeave(){var e;null==(e=this.wakeup)||e.call(this,{replace:[{ts:Date.now(),type:A.SendScheduledDelayedLeaveEvent}]})}}var _=r(69103),w=function(e){return e.StatusChanged="StatusChanged",e.ProbablyLeft="ProbablyLeft",e.DelayIdChanged="DelayIdChanged",e}({});function T(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function I(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?T(Object(r),!0).forEach(function(t){(0,i.A)(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):T(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}var A=function(e){return e.SendDelayedEvent="SendDelayedEvent",e.SendJoinEvent="SendJoinEvent",e.RestartDelayedEvent="RestartDelayedEvent",e.UpdateExpiry="UpdateExpiry",e.SendScheduledDelayedLeaveEvent="SendScheduledDelayedLeaveEvent",e.SendLeaveEvent="SendLeaveEvent",e}({});function R(e,t){return{insert:[{ts:Date.now()+(null!=t?t:0),type:e}]}}function C(e,t){return{replace:[{ts:Date.now()+(null!=t?t:0),type:e}]}}class k extends a.X{isActivated(){return this.activated}isJoined(){return this.isActivated()}join(e,t,r){if(this.scheduler.running)return void this.logger.error("MembershipManager is already running. Ignoring join request.");this.fociPreferred=e,this.rtcTransport=t,this.leavePromiseResolvers=void 0,this.activated=!0,this.oldStatus=this.status,this.state=k.defaultState,this.scheduler.startWithJoin().catch(e=>{this.logger.error("MembershipManager stopped because: ",e),null==r||r(e)}).finally(()=>{if(this.activated=!1,this.oldStatus&&this.oldStatus!==this.status&&this.emit(w.StatusChanged,this.oldStatus,this.status),!this.scheduler.running){var e;null==(e=this.leavePromiseResolvers)||e.resolve(!0),this.leavePromiseResolvers=void 0}})}leave(e){return this.scheduler.running?(!this.leavePromiseResolvers&&(this.leavePromiseResolvers=Promise.withResolvers(),this.activated=!1,this.scheduler.initiateLeave(),e&&setTimeout(()=>{var e;return null==(e=this.leavePromiseResolvers)?void 0:e.resolve(!1)},e)),this.leavePromiseResolvers.promise):(this.logger.warn("Called MembershipManager.leave() even though the MembershipManager is not running"),Promise.resolve(!0))}onRTCSessionMemberUpdate(e){if(!this.isActivated())return Promise.resolve();if(this._ownMembership=e.find(e=>S(e,this.userId,this.deviceId)),!this._ownMembership){var t=[A.SendDelayedEvent,A.SendJoinEvent];this.logger.warn("Missing own membership: force re-join"),this.state.hasMemberStateEvent=!1,this.scheduler.actions.some(e=>t.includes(e.type))?this.logger.error("tried adding another `SendDelayedEvent` actions even though we already have one in the Queue\nActionQueueOnMemberUpdate:",this.scheduler.actions):this.scheduler.initiateJoin()}return Promise.resolve()}updateCallIntent(e){var t=this;return(0,n.A)(function*(){if(!t.activated||!t.ownMembership)throw Error("You cannot update your intent before joining the call");t.ownMembership.callIntent!==e&&(t.callIntent=e,yield t.sendJoinEvent())})()}constructor(e,t,r,n,o){super(),this.joinConfig=e,this.room=t,this.client=r,this.slotDescription=n,(0,i.A)(this,"activated",!1),(0,i.A)(this,"logger",void 0),(0,i.A)(this,"callIntent",void 0),(0,i.A)(this,"leavePromiseResolvers",void 0),(0,i.A)(this,"_ownMembership",void 0),(0,i.A)(this,"oldStatus",void 0),(0,i.A)(this,"scheduler",void 0),(0,i.A)(this,"state",void 0),(0,i.A)(this,"deviceId",void 0),(0,i.A)(this,"userId",void 0),(0,i.A)(this,"stateKey",void 0),(0,i.A)(this,"rtcTransport",void 0),(0,i.A)(this,"fociPreferred",void 0),(0,i.A)(this,"delayedLeaveEventDelayMsOverride",void 0),(0,i.A)(this,"clientSendDelayedDisconnectMembership",()=>this.client._unstable_sendDelayedStateEvent(this.room.roomId,{delay:this.delayedLeaveEventDelayMs},d.Bx.GroupCallMemberPrefix,{},this.stateKey)),(0,i.A)(this,"clientSendMembership",e=>this.client.sendStateEvent(this.room.roomId,d.Bx.GroupCallMemberPrefix,e,this.stateKey)),this.logger=(null!=o?o:l.vF).getChild("[MembershipManager]");var[a,s]=[this.client.getUserId(),this.client.getDeviceId()];if(null===a)throw Error("Missing userId in client");if(null===s)throw Error("Missing deviceId in client");this.deviceId=s,this.userId=a,this.stateKey=this.makeMembershipStateKey(a,s),this.state=k.defaultState,this.callIntent=null==e?void 0:e.callIntent,this.scheduler=new E(e=>(this.oldStatus&&(this.logger.debug("MembershipManager applied action changes. Status: ".concat(this.oldStatus," -> ").concat(this.status)),this.oldStatus!==this.status&&this.emit(w.StatusChanged,this.oldStatus,this.status)),this.oldStatus=this.status,this.logger.debug("MembershipManager before processing action. status=".concat(this.oldStatus)),this.membershipLoopHandler(e)),this.logger)}get ownMembership(){return this._ownMembership}static get defaultState(){return{hasMemberStateEvent:!1,delayId:void 0,startTime:0,rateLimitRetries:new Map,networkErrorRetries:new Map,expireUpdateIterations:1,probablyLeft:!1}}get networkErrorRetryMs(){var e,t;return null!=(e=null==(t=this.joinConfig)?void 0:t.networkErrorRetryMs)?e:3e3}get membershipEventExpiryMs(){var e,t;return null!=(e=null==(t=this.joinConfig)?void 0:t.membershipEventExpiryMs)?e:144e5}get membershipEventExpiryHeadroomMs(){var e,t;return null!=(e=null==(t=this.joinConfig)?void 0:t.membershipEventExpiryHeadroomMs)?e:5e3}computeNextExpiryActionTs(e){return this.state.startTime+Math.min(this.membershipEventExpiryMs,36e5)*e-this.membershipEventExpiryHeadroomMs}get delayedLeaveEventDelayMs(){var e,t,r;return null!=(e=null!=(t=this.delayedLeaveEventDelayMsOverride)?t:null==(r=this.joinConfig)?void 0:r.delayedLeaveEventDelayMs)?e:8e3}get delayedLeaveEventRestartMs(){var e,t;return null!=(e=null==(t=this.joinConfig)?void 0:t.delayedLeaveEventRestartMs)?e:5e3}get maximumRateLimitRetryCount(){var e,t;return null!=(e=null==(t=this.joinConfig)?void 0:t.maximumRateLimitRetryCount)?e:10}get maximumNetworkErrorRetryCount(){var e,t;return null!=(e=null==(t=this.joinConfig)?void 0:t.maximumNetworkErrorRetryCount)?e:10}get delayedLeaveEventRestartLocalTimeoutMs(){var e,t;return null!=(e=null==(t=this.joinConfig)?void 0:t.delayedLeaveEventRestartLocalTimeoutMs)?e:2e3}membershipLoopHandler(e){var t=this;return(0,n.A)(function*(){switch(e){case A.SendDelayedEvent:if(!t.state.delayId)return t.sendOrResendDelayedLeaveEvent();return t.cancelKnownDelayIdBeforeSendDelayedEvent(t.state.delayId);case A.RestartDelayedEvent:if(!t.state.delayId)return R(A.SendDelayedEvent);return t.restartDelayedEvent(t.state.delayId);case A.SendScheduledDelayedLeaveEvent:if(!t.state.hasMemberStateEvent)return{replace:[]};if(t.state.delayId)return t.sendScheduledDelayedLeaveEventOrFallbackToSendLeaveEvent(t.state.delayId);return R(A.SendLeaveEvent);case A.SendJoinEvent:return t.sendJoinEvent();case A.UpdateExpiry:return t.updateExpiryOnJoinedEvent();case A.SendLeaveEvent:if(!t.state.hasMemberStateEvent)return{replace:[]};return t.sendFallbackLeaveEvent()}})()}sendOrResendDelayedLeaveEvent(){var e=this;return(0,n.A)(function*(){return yield e.clientSendDelayedDisconnectMembership().then(t=>(e.state.expectedServerDelayLeaveTs=Date.now()+e.delayedLeaveEventDelayMs,e.setAndEmitProbablyLeft(!1),e.resetRateLimitCounter(A.SendDelayedEvent),e.setAndEmitDelayId(t.delay_id),e.state.hasMemberStateEvent)?R(A.RestartDelayedEvent,e.delayedLeaveEventRestartMs):R(A.SendJoinEvent)).catch(t=>{var r=A.SendDelayedEvent;if(e.manageMaxDelayExceededSituation(t))return R(r);var n=e.actionUpdateFromErrors(t,r,"_unstable_sendDelayedStateEvent");if(n)return n;if(!e.state.hasMemberStateEvent)return e.isUnsupportedDelayedEndpoint(t)?e.logger.info("Not using delayed event because the endpoint is not supported"):e.logger.info("Not using delayed event because: "+t),R(A.SendJoinEvent);if(e.isUnsupportedDelayedEndpoint(t))return{};throw Error("Could not send delayed event, even though delayed events are supported. "+t)})})()}cancelKnownDelayIdBeforeSendDelayedEvent(e){var t=this;return(0,n.A)(function*(){return yield t.client._unstable_cancelScheduledDelayedEvent(e).then(()=>(t.setAndEmitDelayId(void 0),t.resetRateLimitCounter(A.SendDelayedEvent),C(A.SendDelayedEvent))).catch(e=>{var r=A.SendDelayedEvent,n=t.actionUpdateFromErrors(e,r,"cancelScheduledDelayedEvent");if(n)return n;if(t.isNotFoundError(e))return t.setAndEmitDelayId(void 0),C(r);if(t.isUnsupportedDelayedEndpoint(e))return C(A.SendJoinEvent);throw Error("We failed to cancel a delayed event where we already had a delay id with an error we cannot automatically handle")})})()}setAndEmitProbablyLeft(e){this.state.probablyLeft!==e&&(this.state.probablyLeft=e,this.emit(w.ProbablyLeft,this.state.probablyLeft))}setAndEmitDelayId(e){this.state.delayId!==e&&(this.state.delayId=e,this.emit(w.DelayIdChanged,this.state.delayId))}restartDelayedEvent(e){var t=this;return(0,n.A)(function*(){var r=t.state.expectedServerDelayLeaveTs?t.state.expectedServerDelayLeaveTs-Date.now():void 0,n=new Promise((e,n)=>{setTimeout(()=>{n(new f.lc("Restart delayed event timed out before the HS responded"))},void 0===r||t.state.probablyLeft?t.delayedLeaveEventRestartLocalTimeoutMs:Math.min(t.delayedLeaveEventRestartLocalTimeoutMs,r))});return yield Promise.race([t.client._unstable_restartScheduledDelayedEvent(e),n]).then(()=>(t.state.expectedServerDelayLeaveTs=Date.now()+t.delayedLeaveEventDelayMs,t.resetRateLimitCounter(A.RestartDelayedEvent),t.setAndEmitProbablyLeft(!1),R(A.RestartDelayedEvent,t.delayedLeaveEventRestartMs))).catch(e=>{t.state.expectedServerDelayLeaveTs&&t.state.expectedServerDelayLeaveTs<=Date.now()&&t.setAndEmitProbablyLeft(!0);var r=A.RestartDelayedEvent;if(t.isNotFoundError(e))return t.setAndEmitDelayId(void 0),R(A.SendDelayedEvent);if(t.isUnsupportedDelayedEndpoint(e))return{};var n=t.actionUpdateFromErrors(e,r,"restartScheduledDelayedEvent");if(n)return n;throw Error("Could not restart delayed event, even though delayed events are supported. "+e)})})()}sendScheduledDelayedLeaveEventOrFallbackToSendLeaveEvent(e){var t=this;return(0,n.A)(function*(){return yield t.client._unstable_sendScheduledDelayedEvent(e).then(()=>(t.state.hasMemberStateEvent=!1,t.setAndEmitDelayId(void 0),t.resetRateLimitCounter(A.SendScheduledDelayedLeaveEvent),{replace:[]})).catch(e=>{var r=A.SendLeaveEvent;if(t.isUnsupportedDelayedEndpoint(e))return{};if(t.isNotFoundError(e))return t.setAndEmitDelayId(void 0),R(r);var n=t.actionUpdateFromErrors(e,r,"sendScheduledDelayedEvent");return n||(t.logger.warn("Encountered unexpected error during SendScheduledDelayedLeaveEvent. Falling back to SendLeaveEvent",e),R(r))})})()}sendJoinEvent(){var e=this;return(0,n.A)(function*(){return yield e.clientSendMembership(e.makeMyMembership(e.membershipEventExpiryMs)).then(()=>(e.setAndEmitProbablyLeft(!1),e.state.startTime=Date.now(),e.state.expireUpdateIterations=1,e.state.hasMemberStateEvent=!0,e.resetRateLimitCounter(A.SendJoinEvent),{replace:[...e.scheduler.actions.filter(e=>e.type!==A.UpdateExpiry&&e.type!==A.SendJoinEvent),{ts:Date.now(),type:A.RestartDelayedEvent},{ts:e.computeNextExpiryActionTs(e.state.expireUpdateIterations),type:A.UpdateExpiry}]})).catch(t=>{var r=e.actionUpdateFromErrors(t,A.SendJoinEvent,"sendStateEvent");if(r)return r;throw t})})()}updateExpiryOnJoinedEvent(){var e=this;return(0,n.A)(function*(){var t=e.state.expireUpdateIterations+1;return yield e.clientSendMembership(e.makeMyMembership(e.membershipEventExpiryMs*t)).then(()=>(e.resetRateLimitCounter(A.UpdateExpiry),e.state.expireUpdateIterations=t,{insert:[{ts:e.computeNextExpiryActionTs(t),type:A.UpdateExpiry}]})).catch(t=>{var r=e.actionUpdateFromErrors(t,A.UpdateExpiry,"sendStateEvent");if(r)return r;throw t})})()}sendFallbackLeaveEvent(){var e=this;return(0,n.A)(function*(){return yield e.clientSendMembership({}).then(()=>(e.resetRateLimitCounter(A.SendLeaveEvent),e.state.hasMemberStateEvent=!1,{replace:[]})).catch(t=>{var r=e.actionUpdateFromErrors(t,A.SendLeaveEvent,"sendStateEvent");if(r)return r;throw t})})()}makeMembershipStateKey(e,t){var r=this.slotDescription.application,n="ROOM"===this.slotDescription.id?"":this.slotDescription.id,i="".concat(e,"_").concat(t,"_").concat(r).concat(n);return/^org\.matrix\.msc(3757|3779)\b/.exec(this.room.getVersion())?i:"_".concat(i)}makeMyMembership(e){var t,r,n=this.ownMembership,i=void 0===this.rtcTransport?{focus_active:{type:"livekit",focus_selection:"oldest_membership"},foci_preferred:null!=(t=this.fociPreferred)?t:[]}:{focus_active:{type:"livekit",focus_selection:"multi_sfu"},foci_preferred:[this.rtcTransport,...null!=(r=this.fociPreferred)?r:[]]};return I(I({application:this.slotDescription.application,call_id:"ROOM"===this.slotDescription.id?"":this.slotDescription.id,scope:"m.room",device_id:this.deviceId,membershipID:"".concat(this.userId,":").concat(this.deviceId),expires:e,"m.call.intent":this.callIntent},i),void 0!==n?{created_ts:n.createdTs()}:void 0)}isNotFoundError(e){return e instanceof y.up&&"M_NOT_FOUND"===e.errcode}manageMaxDelayExceededSituation(e){if(e instanceof y.up&&"M_UNKNOWN"===e.errcode&&"M_MAX_DELAY_EXCEEDED"===e.data["org.matrix.msc4140.errcode"]){var t=e.data["org.matrix.msc4140.max_delay"];return"number"==typeof t&&this.delayedLeaveEventDelayMs>t&&(this.delayedLeaveEventDelayMsOverride=t),this.logger.warn("Retry sending delayed disconnection event due to server timeout limitations:",e),!0}return!1}actionUpdateFromErrors(e,t,r){var n=this.actionUpdateFromRateLimitError(e,r,t);if(n)return n;var i=this.actionUpdateFromNetworkErrorRetry(e,t);if(i)return i}actionUpdateFromRateLimitError(e,t,r){if((e instanceof y.Hl||e instanceof y.up)&&e.isRateLimitError()){var n,i,o,a=null!=(n=this.state.rateLimitRetries.get(r))?n:0;if(a<this.maximumRateLimitRetryCount){try{i=null!=(o=e.getRetryAfterMs())?o:5e3,this.logger.info("Rate limited by server, retrying in ".concat(i,"ms"))}catch(e){this.logger.warn("Error while retrieving a rate-limit retry delay, retrying after default delay of ".concat(5e3),e),i=5e3}return this.state.rateLimitRetries.set(r,a+1),R(r,i)}throw Error("Exceeded maximum retries for "+r+" attempts (client."+t+")",{cause:e})}}actionUpdateFromNetworkErrorRetry(e,t){var r,n=null!=(r=this.state.networkErrorRetries.get(t))?r:0,i=this.networkErrorRetryMs/1e3+"s",o="("+n+"/"+this.maximumNetworkErrorRetryCount+")",a=this.networkErrorRetryMs;if(e instanceof Error&&"AbortError"===e.name)a=0,this.logger.warn("Network local timeout error while sending event, immediate retry ("+o+")",e);else if(e instanceof Error&&e.message.includes("updating delayed event"))this.logger.warn("delayed event update timeout error, retrying in "+i+" "+o,e);else if(e instanceof y.Rc)this.logger.warn("Network connection error while sending event, retrying in "+i+" "+o,e);else{if(!(e instanceof y.Hl)&&!(e instanceof y.up)||"number"!=typeof e.httpStatus||!(e.httpStatus>=500)||!(e.httpStatus<600))return;this.logger.warn("Server error while sending event, retrying in "+i+" "+o,e)}if(n<this.maximumNetworkErrorRetryCount)return this.state.networkErrorRetries.set(t,n+1),R(t,a);throw Error("Reached maximum ("+this.maximumNetworkErrorRetryCount+") retries cause by: "+e)}isUnsupportedDelayedEndpoint(e){return e instanceof _.qK}resetRateLimitCounter(e){this.state.rateLimitRetries.set(e,0),this.state.networkErrorRetries.set(e,0)}get status(){var e=this.scheduler.actions;if(1===e.length){var{type:t}=e[0];switch(t){case A.SendDelayedEvent:case A.SendJoinEvent:return b.Connecting;case A.UpdateExpiry:return b.Connected;case A.SendScheduledDelayedLeaveEvent:case A.SendLeaveEvent:return b.Disconnecting}}else if(2===e.length){var r=e.map(e=>e.type);if((r.includes(A.RestartDelayedEvent)||r.includes(A.SendDelayedEvent)&&this.state.hasMemberStateEvent)&&r.includes(A.UpdateExpiry))return b.Connected}else if(3===e.length){var n=e.map(e=>e.type);if(2===n.filter(e=>e===A.RestartDelayedEvent).length&&n.includes(A.UpdateExpiry))return b.Connected}return this.scheduler.running?(this.logger.error("MembershipManager has an unknown state. Actions: ",e),b.Unknown):b.Disconnected}get probablyLeft(){return this.state.probablyLeft}get delayId(){return this.state.delayId}}class O extends k{constructor(e,t,r,n,o,a){super(e,t,r,n,a),this.clientWithSticky=r,this.memberId=o,(0,i.A)(this,"clientSendDelayedDisconnectMembership",()=>this.clientWithSticky._unstable_sendStickyDelayedEvent(this.room.roomId,36e5,{delay:this.delayedLeaveEventDelayMs},null,d.Bx.RTCMembership,{msc4354_sticky_key:this.memberId})),(0,i.A)(this,"clientSendMembership",e=>this.clientWithSticky._unstable_sendStickyEvent(this.room.roomId,36e5,null,d.Bx.RTCMembership,I(I({},e),{},{msc4354_sticky_key:this.memberId})))}actionUpdateFromErrors(e,t,r){var n;return super.actionUpdateFromErrors(e,t,null!=(n=O.nameMap.get(r))?n:"unknown")}makeMyMembership(e){let t;var r=this.ownMembership,n="livekit"===(t=this.rtcTransport).type&&"livekit_service_url"in t?this.rtcTransport:void 0,i=null!=r&&r.eventId?{"m.relation":{rel_type:d.zZ.Reference,event_id:null==r?void 0:r.eventId}}:{};return I({application:I({type:this.slotDescription.application},this.callIntent?{"m.call.intent":this.callIntent}:{}),slot_id:G(this.slotDescription),rtc_transports:n?[{type:n.type,livekit_service_url:n.livekit_service_url}]:[],member:{device_id:this.deviceId,user_id:this.userId,id:this.memberId},versions:[]},i)}}(0,i.A)(O,"nameMap",new Map([["sendStateEvent","_unstable_sendStickyEvent"],["sendDelayedStateEvent","_unstable_sendStickyDelayedEvent"]]));var M=r(5862),P=function(e){return e.ReceivedKeys="received_keys",e.NotSupportedError="not_supported_error",e}({});function D(e){return"".concat(e.userId,":").concat(e.deviceId,"(").concat(e.memberId,")")}class x{get updateEncryptionKeyThrottle(){var e,t;return null!=(e=null==(t=this.joinConfig)?void 0:t.updateEncryptionKeyThrottle)?e:3e3}get makeKeyDelay(){var e,t;return null!=(e=null==(t=this.joinConfig)?void 0:t.makeKeyDelay)?e:3e3}get useKeyDelay(){var e,t;return null!=(e=null==(t=this.joinConfig)?void 0:t.useKeyDelay)?e:5e3}constructor(e,t,r,o,a,s){var c=this;this.membership=e,this.getMemberships=t,this.transport=r,this.statistics=o,this.onEncryptionKeysChanged=a,(0,i.A)(this,"manageMediaKeys",!1),(0,i.A)(this,"keysEventUpdateTimeout",void 0),(0,i.A)(this,"makeNewKeyTimeout",void 0),(0,i.A)(this,"setNewKeyTimeouts",new Set),(0,i.A)(this,"encryptionKeys",new Map),(0,i.A)(this,"lastEncryptionKeyUpdateRequest",void 0),(0,i.A)(this,"lastMembershipFingerprints",void 0),(0,i.A)(this,"latestGeneratedKeyIndex",-1),(0,i.A)(this,"joinConfig",void 0),(0,i.A)(this,"logger",void 0),(0,i.A)(this,"joined",!1),(0,i.A)(this,"sendEncryptionKeysEvent",function(){var e=(0,n.A)(function*(e){if(void 0!==c.keysEventUpdateTimeout&&(clearTimeout(c.keysEventUpdateTimeout),c.keysEventUpdateTimeout=void 0),c.lastEncryptionKeyUpdateRequest=Date.now(),c.joined){var t=c.getKeysForParticipant(c.membership);if(!t)return void c.logger.warn("Tried to send encryption keys event but no keys found!");if("number"!=typeof e&&-1===c.latestGeneratedKeyIndex)return void c.logger.warn("Tried to send encryption keys event but no current key index found!");var r=null!=e?e:c.latestGeneratedKeyIndex;c.logger.info("Try sending encryption keys event. keyIndexToSend=".concat(r," (method parameter: ").concat(e,")"));var n=t[r];try{c.statistics.counters.roomEventEncryptionKeysSent+=1;var i=c.getMemberships().filter(e=>void 0!=e.sender).map(e=>({userId:e.sender,deviceId:e.deviceId,membershipTs:e.createdTs()}));yield c.transport.sendKey((0,m.PP)(n),r,i),c.logger.debug("sendEncryptionKeysEvent participantId=".concat(c.membership.userId,":").concat(c.membership.deviceId," numKeys=").concat(t.length," currentKeyIndex=").concat(c.latestGeneratedKeyIndex," keyIndexToSend=").concat(r))}catch(e){if(void 0===c.keysEventUpdateTimeout){var o=(0,y.eM)(e,5e3);c.logger.warn("Failed to send m.call.encryption_key, retrying in ".concat(o),e),c.keysEventUpdateTimeout=setTimeout(()=>void c.sendEncryptionKeysEvent(),o)}else c.logger.info("Not scheduling key resend as another re-send is already pending")}}});return function(t){return e.apply(this,arguments)}}()),(0,i.A)(this,"onNewKeyReceived",(e,t,r,n)=>{this.logger.debug("Received key over key transport ".concat(e.userId,":").concat(e.deviceId," at index ").concat(r)),this.setEncryptionKey(e,r,t,n)}),(0,i.A)(this,"onRotateKeyTimeout",()=>{if(this.manageMediaKeys){this.makeNewKeyTimeout=void 0,this.logger.info("Making new sender key for key rotation");var e=this.makeNewSenderKey(!0);this.sendEncryptionKeysEvent(e)}}),this.logger=(null!=s?s:l.vF).getChild("[EncryptionManager]")}rtcBackendIdentityFromMembershipParts(e){return"".concat(e.userId,":").concat(e.deviceId)}getEncryptionKeys(){var e=new Map;for(var[t,r]of this.encryptionKeys){var n=r.map((e,t)=>({key:e.key,membership:e.membership,keyIndex:t,rtcBackendIdentity:this.rtcBackendIdentityFromMembershipParts(e.membership)}));e.set(t,n)}return e}join(e){var t,r,n;this.joinConfig=e,this.joined=!0,this.manageMediaKeys=null!=(t=null==(r=this.joinConfig)?void 0:r.manageMediaKeys)?t:this.manageMediaKeys,this.transport.on(P.ReceivedKeys,this.onNewKeyReceived),this.transport.start(),null!=(n=this.joinConfig)&&n.manageMediaKeys&&(this.makeNewSenderKey(),this.requestSendCurrentKey())}leave(){for(var e of(this.encryptionKeys.set(D(this.membership),[]),this.transport.off(P.ReceivedKeys,this.onNewKeyReceived),this.transport.stop(),void 0!==this.makeNewKeyTimeout&&(clearTimeout(this.makeNewKeyTimeout),this.makeNewKeyTimeout=void 0),this.setNewKeyTimeouts))clearTimeout(e);this.setNewKeyTimeouts.clear(),this.manageMediaKeys=!1,this.joined=!1}onMembershipsUpdate(e){if(this.manageMediaKeys&&this.joined){var t=new Set(e.filter(e=>!S(e,this.membership.userId,this.membership.deviceId)).map(D)),r=new Set(this.getMemberships().filter(e=>!S(e,this.membership.userId,this.membership.deviceId)).map(D)),n=Array.from(t).some(e=>!r.has(e)),i=Array.from(r).some(e=>!t.has(e)),o=this.lastMembershipFingerprints;if(this.storeLastMembershipFingerprints(),n)this.makeNewKeyTimeout||(this.logger.debug("Member(s) have left: queueing sender key rotation"),this.makeNewKeyTimeout=setTimeout(this.onRotateKeyTimeout,this.makeKeyDelay));else if(i)this.logger.debug("New member(s) have joined: re-sending keys"),this.requestSendCurrentKey();else if(o){var a=this.lastMembershipFingerprints;(Array.from(o).some(e=>!a.has(e))||Array.from(a).some(e=>!o.has(e)))&&(this.logger.debug("Member(s) have updated/reconnected: re-sending keys to everyone"),this.requestSendCurrentKey())}}}makeNewSenderKey(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=(0,M.rl)(16),r=this.getNewEncryptionKeyIndex();return this.logger.info("Generated new key at index "+r),this.setEncryptionKey(this.membership,r,t,Date.now(),e),r}requestSendCurrentKey(){if(this.manageMediaKeys){if(this.lastEncryptionKeyUpdateRequest&&this.lastEncryptionKeyUpdateRequest+this.updateEncryptionKeyThrottle>Date.now()){this.logger.info("Last encryption key event sent too recently: postponing"),void 0===this.keysEventUpdateTimeout&&(this.keysEventUpdateTimeout=setTimeout(()=>void this.sendEncryptionKeysEvent(),this.updateEncryptionKeyThrottle));return}this.sendEncryptionKeysEvent()}}getKeysForParticipant(e){var t;return null==(t=this.encryptionKeys.get(D(e)))?void 0:t.map(e=>e.key)}storeLastMembershipFingerprints(){this.lastMembershipFingerprints=new Set(this.getMemberships().filter(e=>!S(e,this.membership.userId,this.membership.deviceId)).map(e=>"".concat(D(e),":").concat(e.createdTs())))}getNewEncryptionKeyIndex(){return -1===this.latestGeneratedKeyIndex?0:(this.latestGeneratedKeyIndex+1)%256}setEncryptionKey(e,t,r,n){var i,o,a=arguments.length>4&&void 0!==arguments[4]&&arguments[4];this.logger.debug("Setting encryption key for ".concat(e.userId,":").concat(e.deviceId," at index ").concat(t));var s=(0,m.y4)(r),l=D(e);this.encryptionKeys.has(l)||this.encryptionKeys.set(l,[]);var c=this.encryptionKeys.get(l),d=c[t];if(d){if(d.timestamp>n)return void this.logger.info("Ignoring new key at index ".concat(t," for ").concat(l," as it is older than existing known key"));if(i=d.key,i===(o=s)||i&&o&&i.length===o.length&&i.every((e,t)=>e===o[t])){d.timestamp=n;return}}if(e.userId===this.membership.userId&&e.deviceId===this.membership.deviceId&&(this.latestGeneratedKeyIndex=t),c[t]={key:s,timestamp:n,membership:e},a){var u=setTimeout(()=>{this.setNewKeyTimeouts.delete(u),this.logger.info("Delayed-emitting key changed event for ".concat(l," index ").concat(t)),this.onEncryptionKeysChanged(s,t,e,this.rtcBackendIdentityFromMembershipParts(e))},this.useKeyDelay);this.setNewKeyTimeouts.add(u)}else this.onEncryptionKeysChanged(s,t,e,this.rtcBackendIdentityFromMembershipParts(e))}}class F{constructor(){(0,i.A)(this,"tsBuffer",new Map)}isOutdated(e,t){var r,n=D(e);this.tsBuffer.has(n)||this.tsBuffer.set(n,new Map);var i=null==(r=this.tsBuffer.get(n))?void 0:r.get(t.keyIndex);return!!i&&i>t.creationTS||(this.tsBuffer.get(n).set(t.keyIndex,t.creationTS),!1)}}class L{constructor(e,t,r,n,o,a,s){this.ownMembership=e,this.getMemberships=t,this.transport=r,this.statistics=n,this.onEncryptionKeysChanged=o,(0,i.A)(this,"manageMediaKeys",!1),(0,i.A)(this,"useHashedRtcBackendIdentity",!1),(0,i.A)(this,"ownRtcBackendIdentityCache",void 0),(0,i.A)(this,"participantKeyRings",new Map),(0,i.A)(this,"outboundSession",null),(0,i.A)(this,"currentKeyDistributionPromise",null),(0,i.A)(this,"useKeyDelay",5e3),(0,i.A)(this,"keyRotationGracePeriodMs",1e4),(0,i.A)(this,"needToEnsureKeyAgain",!1),(0,i.A)(this,"keyBuffer",new F),(0,i.A)(this,"logger",void 0),(0,i.A)(this,"rtcIdentityProvider",void 0),(0,i.A)(this,"keysWithoutMatchingRTCMembership",[]),(0,i.A)(this,"onNewKeyReceived",(e,t,r,n)=>{if(!this.manageMediaKeys){null==(o=this.logger)||o.warn("Received key over transport ".concat(e.userId,":").concat(e.deviceId," at index ").concat(r," but media keys are disabled"));return}null==(i=this.logger)||i.debug("Received key over transport ".concat(e.userId,":").concat(e.deviceId," at index ").concat(r));var i,o,a,s={key:(0,m.y4)(t),membership:e,keyIndex:r,creationTS:n};this.keyBuffer.isOutdated(e,s)?null==(a=this.logger)||a.info("Received an out of order key for ".concat(e.userId,":").concat(e.deviceId,", dropping it")):(this.addKeyToParticipant(s.key,s.keyIndex,s.membership),this.statistics.counters.roomEventEncryptionKeysReceived+=1)}),this.logger=null==a?void 0:a.getChild("[EncryptionManager]"),this.rtcIdentityProvider=null!=s?s:g.computeRtcIdentityRaw}getOwnRtcBackendIdentity(){var e=this;return(0,n.A)(function*(){if(e.ownRtcBackendIdentityCache)return e.ownRtcBackendIdentityCache;if(e.useHashedRtcBackendIdentity){var t,{userId:r,deviceId:n,memberId:i}=e.ownMembership;null==(t=e.logger)||t.info("Computing RTC backend identity for ".concat(r,":").concat(n,":").concat(i," (SHOULD ONLY BE CALLED ONCE)")),e.ownRtcBackendIdentityCache=yield e.rtcIdentityProvider(r,n,i)}else e.ownRtcBackendIdentityCache="".concat(e.ownMembership.userId,":").concat(e.ownMembership.deviceId);return e.ownRtcBackendIdentityCache})()}getEncryptionKeys(){return new Map(this.participantKeyRings)}checkKeysWithoutMatchingRTCMembership(){var e=this.keysWithoutMatchingRTCMembership;this.keysWithoutMatchingRTCMembership=[],e.forEach(e=>{this.addKeyToParticipant(e.key,e.keyIndex,e.membership)})}addKeyToParticipant(e,t,r){var n,i=this.getMemberships().find(e=>e.userId===r.userId&&e.deviceId===r.deviceId);if(!i){null==(n=this.logger)||n.info("No matching RTC membership for key from ".concat(r.userId,":").concat(r.deviceId,", delaying key addition")),this.keysWithoutMatchingRTCMembership.push({key:e,keyIndex:t,membership:r});return}this.addKeyToParticipantWithBackendIdentity(e,t,r,i.rtcBackendIdentity)}addKeyToParticipantWithBackendIdentity(e,t,r,n){var i=D(r);this.participantKeyRings.has(i)||this.participantKeyRings.set(i,[]),this.participantKeyRings.get(i).push({key:e,keyIndex:t,membership:r,rtcBackendIdentity:n}),this.onEncryptionKeysChanged(e,t,r,n)}join(e){var t,r,n,i,o;this.manageMediaKeys=null==(t=null==e?void 0:e.manageMediaKeys)||t,this.useHashedRtcBackendIdentity=null!=(r=null==e?void 0:e.unstableSendStickyEvents)&&r,this.useKeyDelay=null!=(n=null==e?void 0:e.useKeyDelay)?n:1e3,this.keyRotationGracePeriodMs=null!=(i=null==e?void 0:e.keyRotationGracePeriodMs)?i:1e4,this.transport.on(P.ReceivedKeys,this.onNewKeyReceived),this.getOwnRtcBackendIdentity(),null==(o=this.logger)||o.info("Joining room"),this.transport.start()}leave(){this.transport.off(P.ReceivedKeys,this.onNewKeyReceived),this.transport.stop(),this.participantKeyRings.clear()}ensureKeyDistribution(){var e,t;this.manageMediaKeys&&(null==this.currentKeyDistributionPromise?(null==(e=this.logger)||e.debug("No active rollout, start a new one"),this.currentKeyDistributionPromise=this.rolloutOutboundKey().then(()=>{var e,t;null==(e=this.logger)||e.debug("Rollout completed"),this.currentKeyDistributionPromise=null,this.needToEnsureKeyAgain&&(null==(t=this.logger)||t.debug("New Rollout needed"),this.needToEnsureKeyAgain=!1,this.ensureKeyDistribution())})):(null==(t=this.logger)||t.debug("Rollout in progress, a new rollout will be started after the current one"),this.needToEnsureKeyAgain=!0))}onMembershipsUpdate(){var e;arguments.length>0&&void 0!==arguments[0]&&arguments[0],null==(e=this.logger)||e.trace("onMembershipsUpdate"),this.ensureKeyDistribution(),this.checkKeysWithoutMatchingRTCMembership()}rolloutOutboundKey(){var e=this;return(0,n.A)(function*(){if(null==e.outboundSession){var t={key:e.generateRandomKey(),creationTS:Date.now(),sharedWith:[],keyId:0};e.outboundSession=t,e.addKeyToParticipantWithBackendIdentity(t.key,t.keyId,e.ownMembership,(yield e.getOwnRtcBackendIdentity()))}var r=e.getMemberships().filter(e=>void 0!=e.sender).map(e=>({userId:e.sender,deviceId:e.deviceId,membershipTs:e.createdTs()})),n=null!=(f=null==(y=e.outboundSession)?void 0:y.sharedWith)?f:[],i=(n=n.filter(e=>!r.some(t=>e.userId==t.userId&&e.deviceId==t.deviceId&&e.membershipTs!=t.membershipTs))).filter(e=>!r.some(t=>e.userId==t.userId&&e.deviceId==t.deviceId&&e.membershipTs==t.membershipTs)),o=r.filter(e=>!n.some(t=>e.userId==t.userId&&e.deviceId==t.deviceId&&e.membershipTs==t.membershipTs)),a=[],s=!1;if(i.length>0){var l=e.createNewOutboundSession();s=!0,a=r,b=l}else{if(!(o.length>0))return;var c=Date.now()-e.outboundSession.creationTS;if(c<e.keyRotationGracePeriodMs)null==(S=e.logger)||S.debug("New joiners detected, but the key is recent enough (age:".concat(c,"), keeping it")),a=o,b=e.outboundSession;else{null==(E=e.logger)||E.debug("New joiners detected, rotating the key");var d,u,h,p,g,f,y,b,S,E,_=e.createNewOutboundSession();s=!0,a=r,b=_}}try{null==(d=e.logger)||d.trace("Sending key..."),yield e.transport.sendKey((0,m.WG)(b.key),b.keyId,a),e.statistics.counters.roomEventEncryptionKeysSent+=1,b.sharedWith.push(...a),null==(u=e.logger)||u.trace("key index:".concat(b.keyId," sent to ").concat(b.sharedWith.map(e=>"".concat(e.userId,":").concat(e.deviceId)).join(","))),s&&(null==(h=e.logger)||h.trace("Delay Rollout for key:".concat(b.keyId,"...")),yield(0,v.yy)(e.useKeyDelay),null==(p=e.logger)||p.trace("...Delayed rollout of index:".concat(b.keyId," ")),e.addKeyToParticipantWithBackendIdentity(b.key,b.keyId,e.ownMembership,(yield e.getOwnRtcBackendIdentity())))}catch(t){null==(g=e.logger)||g.error("Failed to rollout key",t)}})()}createNewOutboundSession(){var e,t={key:this.generateRandomKey(),creationTS:Date.now(),sharedWith:[],keyId:this.nextKeyIndex()};return null==(e=this.logger)||e.info("creating new outbound key index:".concat(t.keyId)),this.outboundSession=t,t}nextKeyIndex(){return this.outboundSession?(this.outboundSession.keyId+1)%256:0}generateRandomKey(){var e=new Uint8Array(16);return globalThis.crypto.getRandomValues(e),e}}class U extends Error{constructor(e){super(e)}get name(){return"NotSupportedError"}}class N extends a.X{setParentLogger(e){this.logger=e.getChild("[ToDeviceKeyTransport]")}constructor(e,t,r,n,o){super(),this.membership=e,this.roomId=t,this.client=r,this.statistics=n,(0,i.A)(this,"logger",l.vF),(0,i.A)(this,"onToDeviceEvent",e=>{if(e.getType()===d.Bx.CallEncryptionKeysPrefix){var t=this.getValidEventContent(e);t&&e.getSender()&&this.receiveCallKeyEvent(e.getSender(),t)}}),this.setParentLogger(null!=o?o:l.vF)}start(){this.client.on(o.AU.ToDeviceEvent,this.onToDeviceEvent)}stop(){this.client.off(o.AU.ToDeviceEvent,this.onToDeviceEvent)}sendKey(e,t,r){var i=this;return(0,n.A)(function*(){var n={keys:{index:t,key:e},room_id:i.roomId,member:{claimed_device_id:i.membership.deviceId,id:i.membership.memberId},session:{call_id:"",application:"m.call",scope:"m.room"},sent_ts:Date.now()},o=r.map(e=>({userId:e.userId,deviceId:e.deviceId})).filter(e=>e.userId!=i.membership.userId||e.deviceId!=i.membership.deviceId);o.length>0?(yield i.client.encryptAndSendToDevice(d.Bx.CallEncryptionKeysPrefix,o,n).catch(e=>{var t=e.message;if(t.includes("unknown variant")&&t.includes("send_to_device")||t.includes("not supported"))throw new U("The widget driver does not support to-device encryption")}),i.statistics.counters.roomEventEncryptionKeysSent+=1):i.logger.warn("No targets found for sending key")})()}receiveCallKeyEvent(e,t){this.statistics.counters.roomEventEncryptionKeysReceived+=1;var r,n=Date.now(),i=n-("number"==typeof t.sent_ts?t.sent_ts:n);this.statistics.totals.roomEventEncryptionKeysReceivedTotalAge+=i;var o="".concat(e,":").concat(t.member.claimed_device_id);this.emit(P.ReceivedKeys,{userId:e,deviceId:t.member.claimed_device_id,memberId:null!=(r=t.member.id)?r:o},t.keys.key,t.keys.index,n)}getValidEventContent(e){var t=e.getContent(),r=t.room_id;return r?r!==this.roomId?void this.logger.warn("Malformed Event: Mismatch roomId"):t.keys&&t.keys.key&&"number"==typeof t.keys.index?t.member&&t.member.claimed_device_id?t:void this.logger.warn("Malformed Event: Missing claimed_device_id"):void this.logger.warn("Malformed Event: Missing keys field"):void this.logger.warn("Malformed Event: invalid call encryption keys event, no roomId")}}var j=r(75525),B=r(94606),W=r(61219);class K extends a.X{setParentLogger(e){this.logger=e.getChild("[RoomKeyTransport]")}constructor(e,t,r,n){super(),this.room=e,this.client=t,this.statistics=r,(0,i.A)(this,"logger",l.vF),this.setParentLogger(null!=n?n:l.vF)}start(){this.room.on(W.u9.Timeline,e=>void this.consumeCallEncryptionEvent(e))}stop(){this.room.off(W.u9.Timeline,e=>void this.consumeCallEncryptionEvent(e))}consumeCallEncryptionEvent(e){var t=arguments,r=this;return(0,n.A)(function*(){var n=t.length>1&&void 0!==t[1]&&t[1];return(yield r.client.decryptEventIfNeeded(e),e.isDecryptionFailure())?void(n?r.logger.warn("Decryption failed for event ".concat(e.getId(),": ").concat(e.decryptionFailureReason)):(r.logger.warn("Decryption failed for event ".concat(e.getId(),": ").concat(e.decryptionFailureReason," will retry once only")),setTimeout(()=>void r.consumeCallEncryptionEvent(e,!0),1e3))):(n&&r.logger.info("Decryption succeeded for event ".concat(e.getId()," after retry")),e.getType()!==d.Bx.CallEncryptionKeysPrefix)?Promise.resolve():r.room?void r.onEncryptionEvent(e):(r.logger.error("Got room state event for unknown room ".concat(e.getRoomId(),"!")),Promise.resolve())})()}sendKey(e,t,r){var i=this;return(0,n.A)(function*(){var r={keys:[{index:t,key:e}],device_id:i.client.getDeviceId(),call_id:"",sent_ts:Date.now()};try{yield i.client.sendEvent(i.room.roomId,d.Bx.CallEncryptionKeysPrefix,r)}catch(e){throw i.logger.error("Failed to send call encryption keys",e),e.event&&i.client.cancelPendingEvent(e.event),e}})()}onEncryptionEvent(e){var t=e.getSender(),r=e.getContent(),n=r.device_id,i=r.call_id;if(!t)return void this.logger.warn("Received m.call.encryption_keys with no userId: callId=".concat(i));if(""!==i)return void this.logger.warn("Received m.call.encryption_keys with unsupported callId: userId=".concat(t,", deviceId=").concat(n,", callId=").concat(i));if(!Array.isArray(r.keys))return void this.logger.warn("Received m.call.encryption_keys where keys wasn't an array: callId=".concat(i));if(t===this.client.getUserId()&&n===this.client.getDeviceId())return void this.logger.info("Ignoring our own keys event");this.statistics.counters.roomEventEncryptionKeysReceived+=1;var o=Date.now()-("number"==typeof r.sent_ts?r.sent_ts:e.getTs());for(var a of(this.statistics.totals.roomEventEncryptionKeysReceivedTotalAge+=o,r.keys)){if(!a){this.logger.info("Ignoring false-y key in keys event");continue}var s=a.key,l=a.index;s&&null!=l&&null!=i&&"string"==typeof n&&"string"==typeof i&&"string"==typeof s&&"number"==typeof l?(this.logger.debug("onCallEncryption userId=".concat(t,":").concat(n," encryptionKeyIndex=").concat(l," age=").concat(o,"ms")),this.emit(P.ReceivedKeys,{userId:t,deviceId:n,memberId:"".concat(t,":").concat(n)},s,l,e.getTs())):this.logger.warn("Malformed call encryption_key: userId=".concat(t,", deviceId=").concat(n,", encryptionKeyIndex=").concat(l," callId=").concat(i))}}}function q(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function V(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?q(Object(r),!0).forEach(function(t){(0,i.A)(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):q(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}var H=function(e){return e.MembershipsChanged="memberships_changed",e.JoinStateChanged="join_state_changed",e.EncryptionKeyChanged="encryption_key_changed",e.MembershipManagerError="membership_manager_error",e.DidSendCallNotification="did_send_call_notification",e}({});function G(e){return"".concat(e.application,"#").concat(e.id)}var J={listenForStickyEvents:!0,listenForMemberStateEvents:!0};class z extends a.X{get membershipStatus(){var e;return null==(e=this.membershipManager)?void 0:e.status}get probablyLeft(){var e;return null==(e=this.membershipManager)?void 0:e.probablyLeft}get delayId(){var e;return null==(e=this.membershipManager)?void 0:e.delayId}get callId(){var e;return null==(e=this.slotDescription)?void 0:e.id}get slotId(){return G(this.slotDescription)}static sessionMembershipsForSlot(e,t){var r=arguments;return(0,n.A)(function*(){var n=r.length>2&&void 0!==r[2]?r[2]:J,i=l.vF.getChild("[MatrixRTCSession ".concat(e.roomId,"]")),o=function(e,t,r){var{listenForStickyEvents:n,listenForMemberStateEvents:i}=t,o=[];if(n&&(o=[...e._unstable_getStickyEvents()].filter(e=>e.getType()===d.Bx.RTCMembership)),i){var a=e.getLiveTimeline().getState(c.q.FORWARDS);if(!a)return r.warn("Couldn't get state for room "+e.roomId+"using empty membership array"),[];var s=a.getStateEvents(d.Bx.GroupCallMemberPrefix);o=o.concat(s.filter(e=>!o.some(t=>t.getContent().msc4354_sticky_key===e.getStateKey())))}return o}(e,n,i),a=yield function(e,t,r,n){return Y.apply(this,arguments)}(e,o,t,i);return a.sort((e,t)=>e.createdTs()-t.createdTs()),a.length>1&&i.debug("Call memberships in room ".concat(e.roomId,", in order: "),a.map(e=>[e.createdTs(),e.userId])),a})()}static sessionForSlot(e,t,r,n){return new z(e,t,r,n)}get room(){return this.roomSubset}constructor(e,t,r,o){var a;super(),a=this,this.client=e,this.roomSubset=t,this.slotDescription=r,this.calculateMembershipsOpts=o,(0,i.A)(this,"membershipManager",void 0),(0,i.A)(this,"encryptionManager",void 0),(0,i.A)(this,"joinConfig",void 0),(0,i.A)(this,"logger",void 0),(0,i.A)(this,"pendingNotificationToSend",void 0),(0,i.A)(this,"expiryTimeout",void 0),(0,i.A)(this,"memberships",[]),(0,i.A)(this,"statistics",{counters:{roomEventEncryptionKeysSent:0,roomEventEncryptionKeysReceived:0},totals:{roomEventEncryptionKeysReceivedTotalAge:0}}),(0,i.A)(this,"reEmitter",new j.Q(this)),(0,i.A)(this,"onRoomMemberUpdate",()=>{this.ensureRecalculateSessionMembers()}),(0,i.A)(this,"onStickyEventUpdate",(e,t,r)=>{[...e,...r,...t.flatMap(e=>[e.current,e.previous])].some(e=>e.getType()===d.Bx.RTCMembership)&&this.ensureRecalculateSessionMembers()}),(0,i.A)(this,"_onRTCSessionMemberUpdate",(0,n.A)(function*(){yield a.recalculateSessionMembers()})),(0,i.A)(this,"recalculateSessionMembersDirty",!1),(0,i.A)(this,"recalculateSessionMembersPromise",void 0),(0,i.A)(this,"recalculateSessionMembers",(0,n.A)(function*(){var e=a.memberships;if(a.memberships=yield z.sessionMembershipsForSlot(a.room,G(a.slotDescription),a.calculateMembershipsOpts),e.length!=a.memberships.length||e.some((e,t)=>!g.equal(e,a.memberships[t]))){a.logger.info("Memberships for call in room ".concat(a.roomSubset.roomId," have changed: emitting (").concat(a.memberships.length," members)")),(0,v.G$)(a.logger,"emit MatrixRTCSessionEvent.MembershipsChanged",()=>{a.emit(H.MembershipsChanged,e,a.memberships)}),null==(r=a.membershipManager)||r.onRTCSessionMemberUpdate(a.memberships);var t,r,n,i,o=null==(n=a.membershipManager)?void 0:n.ownMembership;a.pendingNotificationToSend&&o&&0===e.length&&(o.eventId&&null!=(i=a.joinConfig)&&i.notificationType?a.sendCallNotify(o.eventId,a.joinConfig.notificationType,o.callIntent):a.logger.warn("Own membership eventId is undefined, cannot send call notification")),a.memberships.length>0&&(a.pendingNotificationToSend=void 0)}else a.logger.debug("No membership changes detected for room ".concat(a.roomSubset.roomId));null==(t=a.encryptionManager)||t.onMembershipsUpdate(e),a.setExpiryTimer()})),this.logger=l.vF.getChild("[MatrixRTCSession ".concat(t.roomId,"]")),this.roomSubset.on(s.f.Members,this.onRoomMemberUpdate),this.roomSubset.on(B.m.Update,this.onStickyEventUpdate),this.ensureRecalculateSessionMembers(),this.setExpiryTimer()}isJoined(){var e,t;return null!=(e=null==(t=this.membershipManager)?void 0:t.isJoined())&&e}stop(){var e=this;return(0,n.A)(function*(){var t;yield null==(t=e.membershipManager)?void 0:t.leave(1e3),e.expiryTimeout&&(clearTimeout(e.expiryTimeout),e.expiryTimeout=void 0),e.roomSubset.off(s.f.Members,e.onRoomMemberUpdate),e.roomSubset.off(B.m.Update,e.onStickyEventUpdate)})()}joinRTCSession(e,t,r,n){var i;if(this.isJoined())return void this.logger.info("Already joined to session in room ".concat(this.roomSubset.roomId,": ignoring join call"));if(this.membershipManager=null!=n&&n.unstableSendStickyEvents?new O(n,this.roomSubset,this.client,this.slotDescription,e.memberId,this.logger):new k(n,this.roomSubset,this.client,this.slotDescription,this.logger),this.reEmitter.reEmit(this.membershipManager,[w.ProbablyLeft,w.StatusChanged,w.DelayIdChanged]),null!=n&&n.useExperimentalToDeviceTransport){this.logger.info("Using experimental to-device transport for encryption keys"),this.logger.info("Using to-device with room fallback transport for encryption keys");var o,[a,s,l]=[this.roomSubset,this.client,this.statistics],c=new N(e,a.roomId,s,l);this.encryptionManager=new L(e,()=>this.memberships,c,this.statistics,(e,t,r,n)=>{this.emit(H.EncryptionKeyChanged,e,t,r,n)},this.logger)}else o=new K(this.roomSubset,this.client,this.statistics),this.encryptionManager=new x(e,()=>this.memberships,o,this.statistics,(e,t,r,n)=>{this.emit(H.EncryptionKeyChanged,e,t,r,n)});this.joinConfig=n,this.pendingNotificationToSend=null==(i=this.joinConfig)?void 0:i.notificationType,this.membershipManager.join(t,r,e=>{this.logger.error("MembershipManager encountered an unrecoverable error: ",e),this.emit(H.MembershipManagerError,e),this.emit(H.JoinStateChanged,this.isJoined())}),this.encryptionManager.join(n),this.emit(H.JoinStateChanged,!0)}joinRoomSession(e,t,r){var[n,i]=[this.client.getUserId(),this.client.getDeviceId()],o="".concat(n,":").concat(i);this.joinRTCSession({userId:n,deviceId:i,memberId:o},e,t,r)}leaveRoomSession(){var e=arguments,t=this;return(0,n.A)(function*(){var r=e.length>0&&void 0!==e[0]?e[0]:void 0;if(!t.isJoined())return t.logger.info("Not joined to session in room ".concat(t.roomSubset.roomId,": ignoring leave call")),!1;t.logger.info("Leaving call session in room ".concat(t.roomSubset.roomId)),t.encryptionManager.leave();var n=t.membershipManager.leave(r);return t.emit(H.JoinStateChanged,!1),yield n})()}getFocusInUse(){var e=this.getOldestMembership();return null==e?void 0:e.getTransport(e)}getActiveFocus(){var e;return null==(e=this.getOldestMembership())?void 0:e.getFocusActive()}getOldestMembership(){return this.memberships[0]}getConsensusCallIntent(){var e,t=null==(e=this.memberships.find(e=>!!e.callIntent))?void 0:e.callIntent;if(t&&this.memberships.every(e=>!e.callIntent||e.callIntent===t))return t}updateCallIntent(e){var t=this;return(0,n.A)(function*(){var r,n;if(!(null==(r=t.membershipManager)?void 0:r.ownMembership))throw Error("Not connected yet");yield null==(n=t.membershipManager)?void 0:n.updateCallIntent(e)})()}reemitEncryptionKeys(){var e;null==(e=this.encryptionManager)||e.getEncryptionKeys().forEach((e,t)=>{e.forEach(e=>{this.emit(H.EncryptionKeyChanged,e.key,e.keyIndex,e.membership,e.rtcBackendIdentity)})})}setExpiryTimer(){for(var e of(this.expiryTimeout&&(clearTimeout(this.expiryTimeout),this.expiryTimeout=void 0),this.memberships)){var t,r=e.getMsUntilExpiry();void 0!==r&&(void 0===t||r<t)&&(t=r)}void 0!=t&&(this.expiryTimeout=setTimeout(this.ensureRecalculateSessionMembers.bind(this),t))}sendCallNotify(e,t,r){var i,o=this;(i=(0,n.A)(function*(){var n={"m.mentions":{user_ids:[],room:!0},notification_type:t,"m.relates_to":{event_id:e,rel_type:d.zZ.Reference},sender_ts:Date.now(),lifetime:3e4};return r&&(n["m.call.intent"]=r),{response:yield o.client.sendEvent(o.roomSubset.roomId,d.Bx.RTCNotification,n),content:n}}),function(){return i.apply(this,arguments)})().then(e=>{var t=V(V({},e.response),e.content);this.emit(H.DidSendCallNotification,t)}).catch(e=>{var[t,r]=e;return this.logger.error("Failed to send call notification",t,r)})}ensureRecalculateSessionMembers(){void 0===this.recalculateSessionMembersPromise?this.recalculateSessionMembersPromise=this.recalculateSessionMembers().then(()=>{this.recalculateSessionMembersPromise=void 0,this.recalculateSessionMembersDirty&&(this.ensureRecalculateSessionMembers(),this.recalculateSessionMembersDirty=!1)}):this.recalculateSessionMembersDirty=!0}}function Y(){return(Y=(0,n.A)(function*(e,t,r,n){var i=[];for(var o of t)if(function(e,t){var r=Object.keys(e).filter(e=>"msc4354_sticky_key"!==e).length;return 0!==r&&(r>1&&"application"in e||1===r&&"memberships"in e&&(t.warn("Legacy event found. Those are ignored, they do not contribute to the MatrixRTC session"),!1))}(o.getContent(),n))try{var a=g.membershipDataFromMatrixEvent(o),s=new g(o,a,(yield g.computeRtcBackendIdentity(o,a)),n);(function(e,t,r,n){var i;return e.slotId!==r?(n.info("Ignoring membership of user ".concat(e.userId," for a different slot:  user: ").concat(JSON.stringify(e.slotDescription),", slotId: ").concat(r,")")),!1):e.isExpired()?(n.info("Ignoring expired device membership ".concat(e.userId,"/").concat(e.deviceId)),!1):!!t.hasMembershipState(null!=(i=e.userId)?i:"",u.O.Join)||(n.info("Ignoring membership of user ".concat(e.userId," who is not in the room.")),!1)})(s,e,r,n)&&i.push(s)}catch(e){n.warn("Couldn't construct call membership: ",e)}return i})).apply(this,arguments)}var X=function(e){return e.SessionStarted="session_started",e.SessionEnded="session_ended",e}({});class $ extends a.X{constructor(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{application:"m.call",id:"ROOM"};super(),this.client=t,this.slotDescription=r,(0,i.A)(this,"roomSessions",new Map),(0,i.A)(this,"logger",void 0),(0,i.A)(this,"onRoom",e=>{this.refreshRoom(e)}),(0,i.A)(this,"onEvent",e=>{if(e.unstableStickyExpiresAt&&e.getType()===d.Bx.RTCMembership){var t=this.client.getRoom(e.getRoomId());t&&this.refreshRoom(t)}}),(0,i.A)(this,"onRoomState",e=>{if(e.getType()===d.Bx.GroupCallMemberPrefix){var t=this.client.getRoom(e.getRoomId());if(!t)return void this.logger.error("Got room state event for unknown room ".concat(e.getRoomId(),"!"));this.refreshRoom(t)}}),this.logger=e.getChild("[MatrixRTCSessionManager]")}start(){for(var e of null!=(t=this.client.getRooms())?t:[]){var t,r=z.sessionForSlot(this.client,e,this.slotDescription);r.memberships.length>0&&this.roomSessions.set(e.roomId,r)}this.client.on(o.AU.Room,this.onRoom),this.client.on(o.AU.Event,this.onEvent),this.client.on(s.f.Events,this.onRoomState)}stop(){for(var e of this.roomSessions.values())e.stop();this.roomSessions.clear(),this.client.off(o.AU.Room,this.onRoom),this.client.off(o.AU.Event,this.onEvent),this.client.off(s.f.Events,this.onRoomState)}getActiveRoomSession(e){return this.roomSessions.get(e.roomId)}getRoomSession(e){return this.roomSessions.has(e.roomId)||this.roomSessions.set(e.roomId,z.sessionForSlot(this.client,e,this.slotDescription)),this.roomSessions.get(e.roomId)}refreshRoom(e){var t=this;return(0,n.A)(function*(){var r=!t.roomSessions.has(e.roomId),n=t.getRoomSession(e),i=n.memberships.length>0&&!r;yield n._onRTCSessionMemberUpdate().catch(r=>{t.logger.error("Error updating RTC session members for ".concat(e.roomId,": ").concat(r))});var o=n.memberships.length>0;i&&!o?(t.logger.trace("Session ended for ".concat(e.roomId," (").concat(n.memberships.length," members)")),t.emit(X.SessionEnded,e.roomId,t.roomSessions.get(e.roomId))):!i&&o&&(t.logger.trace("Session started for ".concat(e.roomId," (").concat(n.memberships.length," members)")),t.emit(X.SessionStarted,e.roomId,t.roomSessions.get(e.roomId)))})()}}},84458:(e,t,r)=>{"use strict";function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function i(e,t,r){var i;return(i=function(e,t){if("object"!=n(e)||!e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var i=r.call(e,t||"default");if("object"!=n(i))return i;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"),(t="symbol"==n(i)?i:i+"")in e)?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}r.d(t,{A:()=>i})},84656:(e,t,r)=>{"use strict";r.d(t,{D7:()=>a,Jv:()=>l,bv:()=>n,dx:()=>o,k:()=>i,rF:()=>s});var n=function(e){return e.Public="public",e.Private="private",e}({}),i=function(e){return e.PrivateChat="private_chat",e.TrustedPrivateChat="trusted_private_chat",e.PublicChat="public_chat",e}({}),o=function(e){return e.Public="public",e.Invite="invite",e.Private="private",e.Knock="knock",e.Restricted="restricted",e}({}),a=function(e){return e.RoomMembership="m.room_membership",e}({}),s=function(e){return e.CanJoin="can_join",e.Forbidden="forbidden",e}({}),l=function(e){return e.Invited="invited",e.Joined="joined",e.Shared="shared",e.WorldReadable="world_readable",e}({})},85305:(e,t,r)=>{"use strict";r.d(t,{CD:()=>o,IJ:()=>a,Ji:()=>c,QN:()=>i,WM:()=>s,YU:()=>n,kq:()=>d,wp:()=>l});var n=function(e){return e.DontNotify="dont_notify",e.Notify="notify",e.Coalesce="coalesce",e}({}),i=function(e){return e.Highlight="highlight",e.Sound="sound",e}({}),o=function(e){return e.ExactEquals="==",e.LessThan="<",e.GreaterThan=">",e.GreaterThanOrEqual=">=",e.LessThanOrEqual="<=",e}({}),a="2";function s(e){return"==2"===e||"2"===e}var l=function(e){return e.EventMatch="event_match",e.EventPropertyIs="event_property_is",e.EventPropertyContains="event_property_contains",e.ContainsDisplayName="contains_display_name",e.RoomMemberCount="room_member_count",e.SenderNotificationPermission="sender_notification_permission",e.CallStarted="call_started",e.CallStartedPrefix="org.matrix.msc3914.call_started",e}({}),c=function(e){return e.Override="override",e.ContentSpecific="content",e.RoomSpecific="room",e.SenderSpecific="sender",e.Underride="underride",e}({}),d=function(e){return e.Master=".m.rule.master",e.IsUserMention=".m.rule.is_user_mention",e.IsRoomMention=".m.rule.is_room_mention",e.ContainsDisplayName=".m.rule.contains_display_name",e.ContainsUserName=".m.rule.contains_user_name",e.AtRoomNotification=".m.rule.roomnotif",e.DM=".m.rule.room_one_to_one",e.EncryptedDM=".m.rule.encrypted_room_one_to_one",e.Message=".m.rule.message",e.EncryptedMessage=".m.rule.encrypted",e.InviteToSelf=".m.rule.invite_for_me",e.MemberEvent=".m.rule.member_event",e.IncomingCall=".m.rule.call",e.SuppressNotices=".m.rule.suppress_notices",e.Tombstone=".m.rule.tombstone",e.PollStart=".m.rule.poll_start",e.PollStartUnstable=".org.matrix.msc3930.rule.poll_start",e.PollEnd=".m.rule.poll_end",e.PollEndUnstable=".org.matrix.msc3930.rule.poll_end",e.PollStartOneToOne=".m.rule.poll_start_one_to_one",e.PollStartOneToOneUnstable=".org.matrix.msc3930.rule.poll_start_one_to_one",e.PollEndOneToOne=".m.rule.poll_end_one_to_one",e.PollEndOneToOneUnstable=".org.matrix.msc3930.rule.poll_end_one_to_one",e}({})},85590:(e,t,r)=>{"use strict";r.d(t,{HY:()=>a,cQ:()=>s,ns:()=>o}),r(29301);var n=r(84458),i=(r(5408),r(15095)),o=(r(11749),function(e){return e.RequestFinished="FINISHED",e.Complete="COMPLETE",e}({})),a=function(e){return e.PreProcess="ExtState.PreProcess",e.PostProcess="ExtState.PostProcess",e}({}),s=function(e){return e.RoomData="SlidingSync.RoomData",e.Lifecycle="SlidingSync.Lifecycle",e}({});i.X},88767:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(17495);Object.keys(n).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===n[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return n[e]}}))});var i=r(40898);Object.keys(i).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===i[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return i[e]}}))});var o=r(79178);Object.keys(o).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===o[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return o[e]}}))});var a=r(109);Object.keys(a).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===a[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return a[e]}}))});var s=r(39706);Object.keys(s).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===s[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return s[e]}}))});var l=r(99472);Object.keys(l).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===l[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return l[e]}}))});var c=r(61904);Object.keys(c).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===c[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return c[e]}}))});var d=r(96039);Object.keys(d).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===d[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return d[e]}}))});var u=r(55090);Object.keys(u).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===u[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return u[e]}}))});var h=r(72368);Object.keys(h).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===h[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return h[e]}}))});var v=r(11257);Object.keys(v).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===v[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return v[e]}}))});var p=r(93368);Object.keys(p).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===p[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return p[e]}}))});var m=r(70593);Object.keys(m).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===m[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return m[e]}}))});var g=r(9678);Object.keys(g).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===g[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return g[e]}}))});var f=r(59879);Object.keys(f).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===f[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return f[e]}}))});var y=r(12826);Object.keys(y).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===y[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return y[e]}}))});var b=r(50533);Object.keys(b).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===b[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return b[e]}}))});var S=r(94457);Object.keys(S).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===S[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return S[e]}}))});var E=r(60484);Object.keys(E).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===E[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return E[e]}}))});var _=r(17719);Object.keys(_).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===_[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return _[e]}}))});var w=r(89043);Object.keys(w).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===w[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return w[e]}}))});var T=r(45093);Object.keys(T).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===T[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return T[e]}}))});var I=r(78858);Object.keys(I).forEach(function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===I[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return I[e]}}))})},89043:(e,t)=>{"use strict";function r(e){return null==e?"".concat(e):String(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.runTemplate=function(e,t,n){for(var i=Object.assign({},t.data,{matrix_room_id:n.widgetRoomId||"",matrix_user_id:n.currentUserId,matrix_display_name:n.userDisplayName||n.currentUserId,matrix_avatar_url:n.userHttpAvatarUrl||"",matrix_widget_id:t.id,"org.matrix.msc2873.client_id":n.clientId||"","org.matrix.msc2873.client_theme":n.clientTheme||"","org.matrix.msc2873.client_language":n.clientLanguage||"","org.matrix.msc3819.matrix_device_id":n.deviceId||"","org.matrix.msc4039.matrix_base_url":n.baseUrl||""}),o=e,a=0,s=Object.keys(i);a<s.length;a++){var l=s[a],c=RegExp("$".concat(l).replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"g");o=o.replace(c,encodeURIComponent(r(i[l])))}return o},t.toString=r},90426:(e,t,r)=>{"use strict";r.d(t,{eO:()=>z,BF:()=>q,AZ:()=>W,MC:()=>N,F_:()=>G,xt:()=>K,Ad:()=>j,Iy:()=>H});var n=r(29301),i=r(84458),o=r(15095),a=r(4002),s=r(25097),l=r(29927),c=r(5408),d=r(75525),u=r(69007),h=r(9086),v=r(76150),p=r(40977),m=r(11749);class g{constructor(){(0,i.A)(this,"bandwidth",{}),(0,i.A)(this,"bitrate",{}),(0,i.A)(this,"packetLoss",{}),(0,i.A)(this,"transport",[])}}class f{static buildBandwidthReport(e){var t=e.availableIncomingBitrate,r=e.availableOutgoingBitrate;return{download:t?Math.round(t/1e3):0,upload:r?Math.round(r/1e3):0}}}class y{static buildReport(e,t,r,n){var i=null==e?void 0:e.get(t.localCandidateId),o=null==e?void 0:e.get(t.remoteCandidateId);if(o&&i){var a=void 0!==o.ip?o.ip:o.address,s=o.port,l="".concat(a,":").concat(s),c=void 0!==i.ip?i.ip:i.address,d=i.port,u="".concat(c,":").concat(d),h=o.protocol;r.some(e=>e.ip===l&&e.type===h&&e.localIp===u)||r.push({ip:l,type:h,localIp:u,isFocus:n,localCandidateType:i.candidateType,remoteCandidateType:o.candidateType,networkType:i.networkType,rtt:t.currentRoundTripTime?1e3*t.currentRoundTripTime:NaN})}return r}}var b=r(47105);class S{constructor(){(0,i.A)(this,"ssrcToMid",{local:new Map,remote:new Map})}findMidBySsrc(e,t){var r;return this.ssrcToMid[t].forEach((t,n)=>{if(t.find(t=>t==e)){r=n;return}}),r}parse(e,t){var r=(0,b.qg)(e),n=new Map;r.media.forEach(e=>{if(e.mid&&"video"===e.type||"audio"===e.type){var t,r=[];null==(t=e.ssrcs)||t.forEach(e=>{"cname"===e.attribute&&r.push("".concat(e.id))}),n.set("".concat(e.mid),r)}}),this.ssrcToMid[t]=n}getSsrcToMidMap(e){return this.ssrcToMid[e]}}class E{constructor(e){this.pc=e}getLocalTracks(e){return this.pc.getTransceivers().filter(e=>"sendonly"===e.currentDirection||"sendrecv"===e.currentDirection).filter(e=>null!==e.sender).map(e=>e.sender).map(e=>e.track).filter(t=>null!==t&&t.kind===e)}getTackById(e){return this.pc.getTransceivers().map(t=>(null==t?void 0:t.sender.track)!==null&&t.sender.track.id===e?t.sender.track:(null==t?void 0:t.receiver.track)!==null&&t.receiver.track.id===e?t.receiver.track:void 0).find(e=>void 0!==e)}getLocalTrackIdByMid(e){var t,r=this.pc.getTransceivers().find(t=>t.mid===e);return null==r||null==(t=r.sender)||null==(t=t.track)?void 0:t.id}getRemoteTrackIdByMid(e){var t,r=this.pc.getTransceivers().find(t=>t.mid===e);return null==r||null==(t=r.receiver)||null==(t=t.track)?void 0:t.id}getActiveSimulcastStreams(){return 3}getTransceiverByTrackId(e){return this.pc.getTransceivers().find(t=>t.receiver.track.id===e||null!==t.sender.track&&t.sender.track.id===e)}}class _{constructor(e,t,r){this.trackId=e,this.type=t,this.kind=r,(0,i.A)(this,"loss",{packetsTotal:0,packetsLost:0,isDownloadStream:!1}),(0,i.A)(this,"bitrate",{download:0,upload:0}),(0,i.A)(this,"resolution",{width:-1,height:-1}),(0,i.A)(this,"audioConcealment",{concealedAudio:0,totalAudioDuration:0}),(0,i.A)(this,"framerate",0),(0,i.A)(this,"jitter",0),(0,i.A)(this,"codec",""),(0,i.A)(this,"isAlive",!0),(0,i.A)(this,"isMuted",!1),(0,i.A)(this,"isEnabled",!0)}getType(){return this.type}setLoss(e){this.loss=e}getLoss(){return this.loss}setResolution(e){this.resolution=e}getResolution(){return this.resolution}setFramerate(e){this.framerate=e}getFramerate(){return this.framerate}setBitrate(e){this.bitrate=e}getBitrate(){return this.bitrate}setCodec(e){return this.codec=e,!0}getCodec(){return this.codec}resetBitrate(){this.bitrate={download:0,upload:0}}set alive(e){this.isAlive=e}get alive(){return this.isAlive}set muted(e){this.isMuted=e}get muted(){return this.isMuted}set enabled(e){this.isEnabled=e}get enabled(){return this.isEnabled}setJitter(e){this.jitter=e}getJitter(){return this.jitter}setAudioConcealment(e,t){this.audioConcealment.concealedAudio=e,this.audioConcealment.totalAudioDuration=t}getAudioConcealment(){return this.audioConcealment}}class w{constructor(e,t){this.mediaSsrcHandler=e,this.mediaTrackHandler=t,(0,i.A)(this,"track2stats",new Map)}findTrack2Stats(e,t){if(e.trackIdentifier)r=e.trackIdentifier;else if(e.mid)r="remote"===t?this.mediaTrackHandler.getRemoteTrackIdByMid(e.mid):this.mediaTrackHandler.getLocalTrackIdByMid(e.mid);else if(e.ssrc){var r;if(!this.mediaSsrcHandler.findMidBySsrc(e.ssrc,t))return;r="remote"===t?this.mediaTrackHandler.getRemoteTrackIdByMid(e.mid):this.mediaTrackHandler.getLocalTrackIdByMid(e.mid)}if(r){var n=this.track2stats.get(r);if(!n){var i=this.mediaTrackHandler.getTackById(r);if(void 0===i)return;n=new _(r,t,"audio"===i.kind?i.kind:"video"),this.track2stats.set(r,n)}return n}}findLocalVideoTrackStats(e){if(0!==this.mediaTrackHandler.getLocalTracks("video").length)return this.findTrack2Stats(e,"local")}getTrack2stats(){return this.track2stats}findTransceiverByTrackId(e){return this.mediaTrackHandler.getTransceiverByTrackId(e)}}class T{static getNonNegativeValue(e){var t=e;return("number"!=typeof t&&(t=Number(t)),isNaN(t))?0:Math.max(0,t)}}class I{static buildFramerateResolution(e,t){var r={height:t.frameHeight,width:t.frameWidth},n=t.framesPerSecond;r.height&&r.width&&e.setResolution(r),e.setFramerate(Math.round(n||0))}static calculateSimulcastFramerate(e,t,r,n){var i=e.getFramerate();if(!i){if(r){var o=t.timestamp-r.timestamp;o>0&&t.framesSent&&(i=(t.framesSent-r.framesSent)/o*1e3)}if(!i)return}i=n?Math.round(i/n):0,e.setFramerate(i)}static buildCodec(e,t,r){var n=null==e?void 0:e.get(r.codecId);if(n){var i=n.mimeType.split("/")[1];i&&t.setCodec(i)}}static buildBitrateReceived(e,t,r){e.setBitrate({download:I.calculateBitrate(t.bytesReceived,r.bytesReceived,t.timestamp,r.timestamp),upload:0})}static buildBitrateSend(e,t,r){e.setBitrate({download:0,upload:this.calculateBitrate(t.bytesSent,r.bytesSent,t.timestamp,r.timestamp)})}static buildPacketsLost(e,t,r){var n="outbound-rtp"===t.type?"packetsSent":"packetsReceived",i=t[n];(!i||i<0)&&(i=0);var o=Math.max(0,i-T.getNonNegativeValue(r[n])),a=Math.max(0,T.getNonNegativeValue(t.packetsLost)-T.getNonNegativeValue(r.packetsLost));e.setLoss({packetsTotal:o+a,packetsLost:a,isDownloadStream:"outbound-rtp"!==t.type})}static calculateBitrate(e,t,r,n){var i=Math.max(0,T.getNonNegativeValue(e)-T.getNonNegativeValue(t)),o=r-n,a=0;return o>0&&(a=Math.round(8*i/o)),a}static setTrackStatsState(e,t){if(void 0===t){e.alive=!1;return}var r,n="remote"===e.getType()?t.receiver.track:null==t||null==(r=t.sender)?void 0:r.track;if(null==n||"ended"===n.readyState){e.alive=!1;return}e.muted=n.muted,e.enabled=n.enabled,e.alive=!0}static buildTrackSummary(e){var t={count:0,muted:0,maxJitter:0,maxPacketLoss:0,concealedAudio:0,totalAudio:0},r={count:0,muted:0,maxJitter:0,maxPacketLoss:0,concealedAudio:0,totalAudio:0},n=e.filter(e=>"remote"===e.getType()),i=n.filter(e=>"audio"===e.kind);return n.forEach(e=>{var n,o,a="video"===e.kind?t:r;a.count++,e.alive&&e.muted&&a.muted++,a.maxJitter<e.getJitter()&&(a.maxJitter=e.getJitter()),a.maxPacketLoss<e.getLoss().packetsLost&&(a.maxPacketLoss=e.getLoss().packetsLost),i.length>0&&(a.concealedAudio+=null==(n=e.getAudioConcealment())?void 0:n.concealedAudio,a.totalAudio+=null==(o=e.getAudioConcealment())?void 0:o.totalAudioDuration)}),{audioTrackSummary:r,videoTrackSummary:t}}static buildJitter(e,t){if("inbound-rtp"===t.type){var r=null==t?void 0:t.jitter;if(void 0!==r){var n=T.getNonNegativeValue(r);e.setJitter(Math.round(1e3*n))}else e.setJitter(-1)}}static buildAudioConcealment(e,t){if("inbound-rtp"===t.type){var r=1e3*(null==t?void 0:t.totalSamplesDuration)/(null==t?void 0:t.totalSamplesReceived)*(null==t?void 0:t.concealedSamples),n=1e3*(null==t?void 0:t.totalSamplesDuration);e.setAudioConcealment(r,n)}}}class A{static build(e){var t={},r={download:0,upload:0},n={download:0,upload:0},i=0,o=0,a={local:new Map,remote:new Map},s={local:new Map,remote:new Map},l={local:new Map,remote:new Map},c=new Map,d=new Map,u=0,h=0,v=0,p=0,m=0,g=0;for(var[f,y]of e){var b=y.getLoss(),S=b.isDownloadStream?"download":"upload";if(r[S]+=b.packetsTotal,n[S]+=b.packetsLost,i+=y.getBitrate().download,o+=y.getBitrate().upload,"audio"===y.kind){var E=y.getAudioConcealment();m+=E.concealedAudio,g+=E.totalAudioDuration,u+=y.getBitrate().download,h+=y.getBitrate().upload}else v+=y.getBitrate().download,p+=y.getBitrate().upload;a[y.getType()].set(f,y.getResolution()),s[y.getType()].set(f,y.getFramerate()),l[y.getType()].set(f,y.getCodec()),"remote"===y.getType()&&(c.set(f,y.getJitter()),"audio"===y.kind&&d.set(f,y.getAudioConcealment())),y.resetBitrate()}return t.bitrate={upload:o,download:i},t.bitrate.audio={upload:h,download:u},t.bitrate.video={upload:p,download:v},t.packetLoss={total:A.calculatePacketLoss(n.download+n.upload,r.download+r.upload),download:A.calculatePacketLoss(n.download,r.download),upload:A.calculatePacketLoss(n.upload,r.upload)},t.audioConcealment=d,t.totalAudioConcealment={concealedAudio:m,totalAudioDuration:g},t.framerate=s,t.resolution=a,t.codec=l,t.jitter=c,t}static calculatePacketLoss(e,t){return!t||t<=0||!e||e<=0?0:Math.round(e/t*100)}}class R{static buildCallFeedReport(e,t,r){var n=r.getTransceivers(),i=[];return n.forEach(e=>{var t,r=null!=(t=e.sender)&&t.track?R.buildTrackStats(e.sender.track,"sender"):null,n=R.buildTrackStats(e.receiver.track,"receiver");i.push({mid:null==e.mid?"null":e.mid,direction:e.direction,currentDirection:null==e.currentDirection?"null":e.currentDirection,sender:r,receiver:n})}),{callId:e,opponentMemberId:t,transceiver:i,callFeeds:[]}}static buildTrackStats(e){var t,r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"--",i=null==(t=e.getSettings())?void 0:t.deviceId,o=null==(r=e.getConstraints())?void 0:r.deviceId;return{id:e.id,kind:e.kind,settingDeviceId:null!=i?i:"unknown",constrainDeviceId:null!=o?o:"unknown",muted:e.muted,enabled:e.enabled,readyState:e.readyState,label:n}}static expandCallFeedReport(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"unknown";return t.forEach(t=>{var n=t.stream.getAudioTracks(),i=t.stream.getVideoTracks(),o=n.length>0?R.buildTrackStats(t.stream.getAudioTracks()[0],t.purpose):null,a=i.length>0?R.buildTrackStats(t.stream.getVideoTracks()[0],t.purpose):null,s={stream:t.stream.id,type:t.isLocal()?"local":"remote",audio:o,video:a,purpose:t.purpose,prefix:r,isVideoMuted:t.isVideoMuted(),isAudioMuted:t.isAudioMuted()};e.callFeeds.push(s)}),e}}function C(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function k(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?C(Object(r),!0).forEach(function(t){(0,i.A)(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):C(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}class O{constructor(e,t,r,n){var o=!(arguments.length>4)||void 0===arguments[4]||arguments[4];this.callId=e,this.opponentMemberId=t,this.pc=r,this.emitter=n,this.isFocus=o,(0,i.A)(this,"isActive",!0),(0,i.A)(this,"previousStatsReport",void 0),(0,i.A)(this,"currentStatsReport",void 0),(0,i.A)(this,"connectionStats",new g),(0,i.A)(this,"trackStats",void 0),r.addEventListener("signalingstatechange",this.onSignalStateChange.bind(this)),this.trackStats=new w(new S,new E(r))}processStats(e,t){var r=this;return(0,n.A)(function*(){var n={isFirstCollection:void 0===r.previousStatsReport,receivedMedia:0,receivedAudioMedia:0,receivedVideoMedia:0,audioTrackSummary:{count:0,muted:0,maxPacketLoss:0,maxJitter:0,concealedAudio:0,totalAudio:0},videoTrackSummary:{count:0,muted:0,maxPacketLoss:0,maxJitter:0,concealedAudio:0,totalAudio:0}};if(r.isActive){var i=r.pc.getStats();if("function"==typeof(null==i?void 0:i.then))return i.then(i=>{r.currentStatsReport="function"==typeof(null==i?void 0:i.result)?i.result():i;try{r.processStatsReport(e,t)}catch(e){return r.handleError(e),n}r.previousStatsReport=r.currentStatsReport,n.receivedMedia=r.connectionStats.bitrate.download,n.receivedAudioMedia=(null==(o=r.connectionStats.bitrate.audio)?void 0:o.download)||0,n.receivedVideoMedia=(null==(a=r.connectionStats.bitrate.video)?void 0:a.download)||0;var o,a,s=I.buildTrackSummary(Array.from(r.trackStats.getTrack2stats().values()));return k(k({},n),{},{audioTrackSummary:s.audioTrackSummary,videoTrackSummary:s.videoTrackSummary})}).catch(e=>(r.handleError(e),n));r.isActive=!1}return Promise.resolve(n)})()}processStatsReport(e,t){var r,n=new Map;n.callId=this.callId,n.opponentMemberId=this.opponentMemberId,null==(r=this.currentStatsReport)||r.forEach(e=>{var t=this.previousStatsReport?this.previousStatsReport.get(e.id):null;if("candidate-pair"===e.type&&e.nominated&&"succeeded"===e.state)this.connectionStats.bandwidth=f.buildBandwidthReport(e),this.connectionStats.transport=y.buildReport(this.currentStatsReport,e,this.connectionStats.transport,this.isFocus);else if("inbound-rtp"===e.type||"outbound-rtp"===e.type){var r=this.trackStats.findTrack2Stats(e,"inbound-rtp"===e.type?"remote":"local");if(!r)return;if(t&&I.buildPacketsLost(r,e,t),"inbound-rtp"===e.type){I.buildFramerateResolution(r,e),t&&I.buildBitrateReceived(r,e,t);var i=this.trackStats.findTransceiverByTrackId(r.trackId);I.setTrackStatsState(r,i),I.buildJitter(r,e),I.buildAudioConcealment(r,e)}else t&&(n.set(r.trackId,T.getNonNegativeValue(e.bytesSent)),I.buildBitrateSend(r,e,t));I.buildCodec(this.currentStatsReport,r,e)}else if("track"===e.type&&"video"===e.kind&&!e.remoteSource){var o=this.trackStats.findLocalVideoTrackStats(e);if(!o)return;I.buildFramerateResolution(o,e),I.calculateSimulcastFramerate(o,e,t,this.trackStats.mediaTrackHandler.getActiveSimulcastStreams())}}),this.emitter.emitByteSendReport(n),this.emitter.emitCallFeedReport(R.buildCallFeedReport(this.callId,this.opponentMemberId,this.pc)),this.processAndEmitConnectionStatsReport()}setActive(e){this.isActive=e}getActive(){return this.isActive}handleError(e){this.isActive=!1,c.vF.warn("CallStatsReportGatherer ".concat(this.callId," processStatsReport fails and set to inactive ").concat(e))}processAndEmitConnectionStatsReport(){var e=A.build(this.trackStats.getTrack2stats());e.callId=this.callId,e.opponentMemberId=this.opponentMemberId,this.connectionStats.bandwidth=e.bandwidth,this.connectionStats.bitrate=e.bitrate,this.connectionStats.packetLoss=e.packetLoss,this.emitter.emitConnectionStatsReport(k(k({},e),{},{transport:this.connectionStats.transport})),this.connectionStats.transport=[]}stopProcessingStats(){}onSignalStateChange(){"stable"===this.pc.signalingState&&(this.pc.currentRemoteDescription&&this.trackStats.mediaSsrcHandler.parse(this.pc.currentRemoteDescription.sdp,"remote"),this.pc.currentLocalDescription&&this.trackStats.mediaSsrcHandler.parse(this.pc.currentLocalDescription.sdp,"local"))}setOpponentMemberId(e){this.opponentMemberId=e}}var M=r(17351);class P extends o.X{emitByteSendReport(e){this.emit(M.I.BYTE_SENT_STATS,e)}emitConnectionStatsReport(e){this.emit(M.I.CONNECTION_STATS,e)}emitCallFeedReport(e){this.emit(M.I.CALL_FEED_REPORT,e)}emitSummaryStatsReport(e){this.emit(M.I.SUMMARY_STATS,e)}}class D{constructor(e){this.emitter=e}build(e){var t=e.filter(e=>!e.isFirstCollection),r=t.length,n=e.length;if(0!==r){var i={receivedAudio:0,receivedVideo:0,receivedMedia:0,concealedAudio:0,totalAudio:0},o=0,a=0;t.forEach(e=>{this.countTrackListReceivedMedia(i,e),this.countConcealedAudio(i,e),o=this.buildMaxJitter(o,e),a=this.buildMaxPacketLoss(a,e)});var s={percentageReceivedMedia:Number((i.receivedMedia/r).toFixed(5)),percentageReceivedVideoMedia:Number((i.receivedVideo/r).toFixed(5)),percentageReceivedAudioMedia:Number((i.receivedAudio/r).toFixed(5)),maxJitter:o,maxPacketLoss:a,percentageConcealedAudio:Number(i.totalAudio>0?(i.concealedAudio/i.totalAudio).toFixed(5):0),peerConnections:n};this.emitter.emitSummaryStatsReport(s)}}static extendSummaryReport(e,t){var r=[],n=[];for(var i of t)for(var o of(n.push(i),i[1]))r.push(o);e.opponentDevicesInCall=Math.max(0,r.length-1),e.opponentUsersInCall=Math.max(0,n.length-1),e.diffDevicesToPeerConnections=Math.max(0,r.length-1)-e.peerConnections,e.ratioPeerConnectionToDevices=0==Math.max(0,r.length-1)?0:e.peerConnections/(r.length-1)}countTrackListReceivedMedia(e,t){var r=!1,n=!1;(t.receivedAudioMedia>0||0===t.audioTrackSummary.count)&&(e.receivedAudio++,r=!0),t.receivedVideoMedia>0||0===t.videoTrackSummary.count?(e.receivedVideo++,n=!0):t.videoTrackSummary.muted>0&&t.videoTrackSummary.muted===t.videoTrackSummary.count&&(e.receivedVideo++,n=!0),n&&r&&e.receivedMedia++}buildMaxJitter(e,t){return e<t.videoTrackSummary.maxJitter&&(e=t.videoTrackSummary.maxJitter),e<t.audioTrackSummary.maxJitter&&(e=t.audioTrackSummary.maxJitter),e}buildMaxPacketLoss(e,t){return e<t.videoTrackSummary.maxPacketLoss&&(e=t.videoTrackSummary.maxPacketLoss),e<t.audioTrackSummary.maxPacketLoss&&(e=t.audioTrackSummary.maxPacketLoss),e}countConcealedAudio(e,t){e.concealedAudio+=t.audioTrackSummary.concealedAudio,e.totalAudio+=t.audioTrackSummary.totalAudio}}class x{constructor(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e4;this.groupCallId=e,this.userId=t,this.interval=r,(0,i.A)(this,"timer",void 0),(0,i.A)(this,"gatherers",new Map),(0,i.A)(this,"reports",new P),(0,i.A)(this,"summaryStatsReportGatherer",new D(this.reports))}start(){void 0===this.timer&&this.interval>0&&(this.timer=setInterval(()=>{this.processStats()},this.interval))}stop(){void 0!==this.timer&&(clearInterval(this.timer),this.gatherers.forEach(e=>e.stopProcessingStats()))}hasStatsReportGatherer(e){return this.gatherers.has(e)}addStatsReportGatherer(e,t,r){return!this.hasStatsReportGatherer(e)&&(this.gatherers.set(e,new O(e,t,r,this.reports)),!0)}removeStatsReportGatherer(e){return this.gatherers.delete(e)}getStatsReportGatherer(e){return this.hasStatsReportGatherer(e)?this.gatherers.get(e):void 0}updateOpponentMember(e,t){var r;null==(r=this.getStatsReportGatherer(e))||r.setOpponentMemberId(t)}processStats(){var e=[];this.gatherers.forEach(t=>{e.push(t.processStats(this.groupCallId,this.userId))}),Promise.all(e).then(e=>this.summaryStatsReportGatherer.build(e)).catch(e=>{c.vF.error("Could not build summary stats report",e)})}setInterval(e){this.interval=e}}var F=r(5294);function L(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function U(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?L(Object(r),!0).forEach(function(t){(0,i.A)(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):L(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}var N=function(e){return e.Ring="m.ring",e.Prompt="m.prompt",e.Room="m.room",e}({}),j=function(e){return e.Video="m.video",e.Voice="m.voice",e}({}),B=function(e){return e.CallEnded="call_ended",e}({}),W=function(e){return e.GroupCallStateChanged="group_call_state_changed",e.ActiveSpeakerChanged="active_speaker_changed",e.CallsChanged="calls_changed",e.UserMediaFeedsChanged="user_media_feeds_changed",e.ScreenshareFeedsChanged="screenshare_feeds_changed",e.LocalScreenshareStateChanged="local_screenshare_state_changed",e.LocalMuteStateChanged="local_mute_state_changed",e.ParticipantsChanged="participants_changed",e.Error="group_call_error",e}({}),K=function(e){return e.ConnectionStats="GroupCall.connection_stats",e.ByteSentStats="GroupCall.byte_sent_stats",e.SummaryStats="GroupCall.summary_stats",e.CallFeedStats="GroupCall.call_feed_stats",e}({}),q=function(e){return e.NoUserMedia="no_user_media",e.UnknownDevice="unknown_device",e.PlaceCallFailed="place_call_failed",e}({});class V extends Error{constructor(e,t,r){r?super(t+": "+r):super(t),(0,i.A)(this,"code",void 0),this.code=e}}class H extends V{constructor(e){super(q.UnknownDevice,"No device found for "+e),this.userId=e}}var G=function(e){return e.LocalCallFeedUninitialized="local_call_feed_uninitialized",e.InitializingLocalCallFeed="initializing_local_call_feed",e.LocalCallFeedInitialized="local_call_feed_initialized",e.Entered="entered",e.Ended="ended",e}({});function J(e){var t;return(null==(t=e.getOpponentMember())?void 0:t.userId)||e.invitee||null}class z extends o.X{constructor(e,t,r,n,o,u,v,p,m){var g,f,y=arguments.length>9&&void 0!==arguments[9]&&arguments[9],b=arguments.length>10?arguments[10]:void 0;super(),this.client=e,this.room=t,this.type=r,this.isPtt=n,this.intent=o,this.dataChannelsEnabled=v,this.dataChannelOptions=p,this.useLivekit=y,(0,i.A)(this,"activeSpeakerInterval",1e3),(0,i.A)(this,"retryCallInterval",5e3),(0,i.A)(this,"participantTimeout",15e3),(0,i.A)(this,"pttMaxTransmitTime",2e4),(0,i.A)(this,"activeSpeaker",void 0),(0,i.A)(this,"localCallFeed",void 0),(0,i.A)(this,"localScreenshareFeed",void 0),(0,i.A)(this,"localDesktopCapturerSourceId",void 0),(0,i.A)(this,"userMediaFeeds",[]),(0,i.A)(this,"screenshareFeeds",[]),(0,i.A)(this,"groupCallId",void 0),(0,i.A)(this,"allowCallWithoutVideoAndAudio",void 0),(0,i.A)(this,"calls",new Map),(0,i.A)(this,"callHandlers",new Map),(0,i.A)(this,"activeSpeakerLoopInterval",void 0),(0,i.A)(this,"retryCallLoopInterval",void 0),(0,i.A)(this,"retryCallCounts",new Map),(0,i.A)(this,"reEmitter",void 0),(0,i.A)(this,"transmitTimer",null),(0,i.A)(this,"participantsExpirationTimer",null),(0,i.A)(this,"resendMemberStateTimer",null),(0,i.A)(this,"initWithAudioMuted",!1),(0,i.A)(this,"initWithVideoMuted",!1),(0,i.A)(this,"initCallFeedPromise",void 0),(0,i.A)(this,"_livekitServiceURL",void 0),(0,i.A)(this,"stats",void 0),(0,i.A)(this,"statsCollectIntervalTime",0),(0,i.A)(this,"onConnectionStats",e=>{this.emit(K.ConnectionStats,{report:e})}),(0,i.A)(this,"onByteSentStats",e=>{this.emit(K.ByteSentStats,{report:e})}),(0,i.A)(this,"onSummaryStats",e=>{D.extendSummaryReport(e,this.participants),this.emit(K.SummaryStats,{report:e})}),(0,i.A)(this,"onCallFeedReport",e=>{this.localCallFeed&&(e=R.expandCallFeedReport(e,[this.localCallFeed],"from-local-feed"));var t=[];this.forEachCall(r=>{r.callId===e.callId&&r.getFeeds().forEach(e=>t.push(e))}),e=R.expandCallFeedReport(e,t,"from-call-feed"),this.emit(K.CallFeedStats,{report:e})}),(0,i.A)(this,"_state",G.LocalCallFeedUninitialized),(0,i.A)(this,"_participants",new Map),(0,i.A)(this,"_creationTs",null),(0,i.A)(this,"_enteredViaAnotherSession",!1),(0,i.A)(this,"onIncomingCall",e=>{if(e.roomId===this.room.roomId){if(e.state!==s.iP.Ringing)return void c.vF.warn("GroupCall ".concat(this.groupCallId," onIncomingCall() incoming call no longer in ringing state - ignoring"));if(!e.groupCallId||e.groupCallId!==this.groupCallId){c.vF.log("GroupCall ".concat(this.groupCallId," onIncomingCall() ignored because it doesn't match the current group call")),e.reject();return}var t,r,n=null==(t=e.getOpponentMember())?void 0:t.userId;if(void 0===n)return void c.vF.warn("GroupCall ".concat(this.groupCallId," onIncomingCall() incoming call with no member - ignoring"));if(this.useLivekit)return void c.vF.info("Received incoming call whilst in signaling-only mode! Ignoring.");var i=null!=(r=this.calls.get(n))?r:new Map,o=i.get(e.getOpponentDeviceId());if((null==o?void 0:o.callId)!==e.callId){c.vF.log("GroupCall ".concat(this.groupCallId," onIncomingCall() incoming call (userId=").concat(n,", callId=").concat(e.callId,")")),o&&o.hangup(s.Il.Replaced,!1),i.set(e.getOpponentDeviceId(),e),this.calls.set(n,i),this.initCall(e);var a=this.getLocalFeeds().map(e=>e.clone());if(!this.callExpected(e))for(var l of a)(0,s.ms)(l.stream.getAudioTracks(),!1),(0,s.ms)(l.stream.getVideoTracks(),!1);e.answerWithCallFeeds(a),this.emit(W.CallsChanged,this.calls)}}}),(0,i.A)(this,"onRetryCallLoop",()=>{var e=!1;for(var[{userId:t},r]of this.participants){var n=this.calls.get(t),i=this.retryCallCounts.get(t);for(var[o,a]of r){var s,l,c=null==n?void 0:n.get(o),d=null!=(s=null==(l=i)?void 0:l.get(o))?s:0;(null==c?void 0:c.getOpponentSessionId())!==a.sessionId&&this.wantsOutgoingCall(t,o)&&d<3&&(void 0===i&&(i=new Map,this.retryCallCounts.set(t,i)),i.set(o,d+1),e=!0)}}e&&this.placeOutgoingCalls()}),(0,i.A)(this,"onCallFeedsChanged",e=>{var t=J(e),r=e.getOpponentDeviceId();if(!t)throw Error("Cannot change call feeds without user id");var n=this.getUserMediaFeed(t,r),i=e.remoteUsermediaFeed,o=i!==n,a=this.calls.get(t),s=null==a?void 0:a.get(r);if((null==s?void 0:s.callId)===e.callId){o&&(!n&&i?this.addUserMediaFeed(i):n&&i?this.replaceUserMediaFeed(n,i):n&&!i&&this.removeUserMediaFeed(n));var l=this.getScreenshareFeed(t,r),c=e.remoteScreensharingFeed;c!==l&&(!l&&c?this.addScreenshareFeed(c):l&&c?this.replaceScreenshareFeed(l,c):l&&!c&&this.removeScreenshareFeed(l))}}),(0,i.A)(this,"onCallStateChanged",(e,t,r)=>{if(t!==s.iP.Ended){var n,i=this.localCallFeed.isAudioMuted();e.localUsermediaStream&&e.isMicrophoneMuted()!==i&&e.setMicrophoneMuted(i);var o=this.localCallFeed.isVideoMuted();e.localUsermediaStream&&e.isLocalVideoMuted()!==o&&e.setLocalVideoMuted(o);var a=null==(n=e.getOpponentMember())?void 0:n.userId;if(t===s.iP.Connected&&a){var l=this.retryCallCounts.get(a);null==l||l.delete(e.getOpponentDeviceId()),(null==l?void 0:l.size)===0&&this.retryCallCounts.delete(a)}}}),(0,i.A)(this,"onCallHangup",e=>{if(e.hangupReason!==s.Il.Replaced){var t,r,n=null!=(t=null==(r=e.getOpponentMember())?void 0:r.userId)?t:this.room.getMember(e.invitee).userId,i=this.calls.get(n);(null==i?void 0:i.get(e.getOpponentDeviceId()))===e&&(this.disposeCall(e,e.hangupReason),i.delete(e.getOpponentDeviceId()),0===i.size&&this.calls.delete(n),this.emit(W.CallsChanged,this.calls))}}),(0,i.A)(this,"onCallReplaced",(e,t)=>{var r=e.getOpponentMember().userId,n=this.calls.get(r);void 0===n&&(n=new Map,this.calls.set(r,n)),e.hangup(s.Il.Replaced,!1),this.initCall(t),n.set(e.getOpponentDeviceId(),t),this.emit(W.CallsChanged,this.calls)}),(0,i.A)(this,"onActiveSpeakerLoop",()=>{var e=void 0,t=void 0;for(var r of this.userMediaFeeds)if(!r.isLocal()||!(this.userMediaFeeds.length>1)){var n=r.speakingVolumeSamples.reduce((e,t)=>e+Math.max(t,a.Tw))/r.speakingVolumeSamples.length;(!e||n>e)&&(e=n,t=r)}t&&this.activeSpeaker!==t&&e&&e>a.Tw&&(this.activeSpeaker=t,this.emit(W.ActiveSpeakerChanged,this.activeSpeaker))}),(0,i.A)(this,"onRoomState",()=>this.updateParticipants()),(0,i.A)(this,"onParticipantsChanged",()=>{this.forEachCall(e=>{var t=this.callExpected(e);for(var r of e.getLocalFeeds())(0,s.ms)(r.stream.getAudioTracks(),!r.isAudioMuted()&&t),(0,s.ms)(r.stream.getVideoTracks(),!r.isVideoMuted()&&t)}),this.state!==G.Entered||this.useLivekit||this.placeOutgoingCalls()}),(0,i.A)(this,"onStateChanged",(e,t)=>{(e===G.Entered||t===G.Entered||e===G.Ended)&&(this.updateParticipants(),this.updateMemberState().catch(e=>c.vF.error("GroupCall ".concat(this.groupCallId,' onStateChanged() failed to update member state devices"'),e)))}),(0,i.A)(this,"onLocalFeedsChanged",()=>{this.state===G.Entered&&this.updateMemberState().catch(e=>c.vF.error("GroupCall ".concat(this.groupCallId," onLocalFeedsChanged() failed to update member state feeds"),e))}),this.reEmitter=new d.K(this),this.groupCallId=null!=u?u:(0,s.WE)(),this._livekitServiceURL=b,this.creationTs=null!=(g=null==(f=t.currentState.getStateEvents(h.Bx.GroupCallPrefix,this.groupCallId))?void 0:f.getTs())?g:null,this.updateParticipants(),t.on(l.f.Update,this.onRoomState),this.on(W.ParticipantsChanged,this.onParticipantsChanged),this.on(W.GroupCallStateChanged,this.onStateChanged),this.on(W.LocalScreenshareStateChanged,this.onLocalFeedsChanged),this.allowCallWithoutVideoAndAudio=!!m}create(){var e=this;return(0,n.A)(function*(){return e.creationTs=Date.now(),e.client.groupCallEventHandler.groupCalls.set(e.room.roomId,e),e.client.emit(p.o.Outgoing,e),yield e.sendCallStateEvent(),e})()}sendCallStateEvent(){var e=this;return(0,n.A)(function*(){var t={"m.intent":e.intent,"m.type":e.type,"io.element.ptt":e.isPtt,dataChannelsEnabled:e.dataChannelsEnabled,dataChannelOptions:e.dataChannelsEnabled?e.dataChannelOptions:void 0};e.livekitServiceURL&&(t["io.element.livekit_service_url"]=e.livekitServiceURL),yield e.client.sendStateEvent(e.room.roomId,h.Bx.GroupCallPrefix,t,e.groupCallId)})()}get livekitServiceURL(){return this._livekitServiceURL}updateLivekitServiceURL(e){return this._livekitServiceURL=e,this.sendCallStateEvent()}get state(){return this._state}set state(e){var t=this._state;e!==t&&(this._state=e,this.emit(W.GroupCallStateChanged,e,t))}get participants(){return this._participants}set participants(e){var t=this._participants,r=(e,t)=>e.sessionId===t.sessionId&&e.screensharing===t.screensharing;(0,m.kg)(e,t,(e,t)=>(0,m.kg)(e,t,r))||(this._participants=e,this.emit(W.ParticipantsChanged,e))}get creationTs(){return this._creationTs}set creationTs(e){this._creationTs=e}get enteredViaAnotherSession(){return this._enteredViaAnotherSession}set enteredViaAnotherSession(e){this._enteredViaAnotherSession=e,this.updateParticipants()}forEachCall(e){for(var t of this.calls.values())for(var r of t.values())e(r)}getLocalFeeds(){var e=[];return this.localCallFeed&&e.push(this.localCallFeed),this.localScreenshareFeed&&e.push(this.localScreenshareFeed),e}hasLocalParticipant(){var e,t;return null!=(e=null==(t=this.participants.get(this.room.getMember(this.client.getUserId())))?void 0:t.has(this.client.getDeviceId()))&&e}callExpected(e){var t,r=J(e),n=null===r?null:this.room.getMember(r),i=e.getOpponentDeviceId();return null!==n&&void 0!==i&&(null==(t=this.participants.get(n))?void 0:t.get(i))!==void 0}initLocalCallFeed(){var e=this;return(0,n.A)(function*(){if(e.useLivekit)return void c.vF.info("Livekit group call: not starting local call feed.");if(e.state!==G.LocalCallFeedUninitialized)throw Error('Cannot initialize local call feed in the "'.concat(e.state,'" state.'));if(e.state=G.InitializingLocalCallFeed,e.initCallFeedPromise)return e.initCallFeedPromise;try{e.initCallFeedPromise=e.initLocalCallFeedInternal(),yield e.initCallFeedPromise}finally{e.initCallFeedPromise=void 0}})()}initLocalCallFeedInternal(){var e=this;return(0,n.A)(function*(){c.vF.log("GroupCall ".concat(e.groupCallId," initLocalCallFeedInternal() running"));try{t=yield e.client.getMediaHandler().getUserMediaStream(!0,e.type===j.Video)}catch(r){if(e.allowCallWithoutVideoAndAudio)t=new MediaStream;else throw e.state=G.LocalCallFeedUninitialized,r}if(e._state!==G.InitializingLocalCallFeed)throw e.client.getMediaHandler().stopUserMediaStream(t),Error("Group call disposed while gathering media stream");var t,r=new a.Hh({client:e.client,roomId:e.room.roomId,userId:e.client.getUserId(),deviceId:e.client.getDeviceId(),stream:t,purpose:u.h.Usermedia,audioMuted:e.initWithAudioMuted||0===t.getAudioTracks().length||e.isPtt,videoMuted:e.initWithVideoMuted||0===t.getVideoTracks().length});(0,s.ms)(t.getAudioTracks(),!r.isAudioMuted()),(0,s.ms)(t.getVideoTracks(),!r.isVideoMuted()),e.localCallFeed=r,e.addUserMediaFeed(r),e.state=G.LocalCallFeedInitialized})()}updateLocalUsermediaStream(e){var t=this;return(0,n.A)(function*(){if(t.localCallFeed){var r=t.localCallFeed.stream;t.localCallFeed.setNewStream(e);var n=t.localCallFeed.isAudioMuted(),i=t.localCallFeed.isVideoMuted();c.vF.log("GroupCall ".concat(t.groupCallId," updateLocalUsermediaStream() (oldStreamId=").concat(r.id,", newStreamId=").concat(e.id,", micShouldBeMuted=").concat(n,", vidShouldBeMuted=").concat(i,")")),(0,s.ms)(e.getAudioTracks(),!n),(0,s.ms)(e.getVideoTracks(),!i),t.client.getMediaHandler().stopUserMediaStream(r)}})()}enter(){var e=this;return(0,n.A)(function*(){if(e.state===G.LocalCallFeedUninitialized)yield e.initLocalCallFeed();else if(e.state!==G.LocalCallFeedInitialized)throw Error('Cannot enter call in the "'.concat(e.state,'" state'));for(var t of(c.vF.log("GroupCall ".concat(e.groupCallId," enter() running")),e.state=G.Entered,e.client.on(v.B.Incoming,e.onIncomingCall),e.client.callEventHandler.calls.values()))e.onIncomingCall(t);e.useLivekit||(e.retryCallLoopInterval=setInterval(e.onRetryCallLoop,e.retryCallInterval),e.activeSpeaker=void 0,e.onActiveSpeakerLoop(),e.activeSpeakerLoopInterval=setInterval(e.onActiveSpeakerLoop,e.activeSpeakerInterval))})()}dispose(){var e;this.localCallFeed&&(this.removeUserMediaFeed(this.localCallFeed),this.localCallFeed=void 0),this.localScreenshareFeed&&(this.client.getMediaHandler().stopScreensharingStream(this.localScreenshareFeed.stream),this.removeScreenshareFeed(this.localScreenshareFeed),this.localScreenshareFeed=void 0,this.localDesktopCapturerSourceId=void 0),this.client.getMediaHandler().stopAllStreams(),null!==this.transmitTimer&&(clearTimeout(this.transmitTimer),this.transmitTimer=null),void 0!==this.retryCallLoopInterval&&(clearInterval(this.retryCallLoopInterval),this.retryCallLoopInterval=void 0),null!==this.participantsExpirationTimer&&(clearTimeout(this.participantsExpirationTimer),this.participantsExpirationTimer=null),this.state===G.Entered&&(this.forEachCall(e=>e.hangup(s.Il.UserHangup,!1)),this.activeSpeaker=void 0,clearInterval(this.activeSpeakerLoopInterval),this.retryCallCounts.clear(),clearInterval(this.retryCallLoopInterval),this.client.removeListener(v.B.Incoming,this.onIncomingCall),null==(e=this.stats)||e.stop())}leave(){this.dispose(),this.state=G.LocalCallFeedUninitialized}terminate(){var e=arguments,t=this;return(0,n.A)(function*(){var r=!(e.length>0)||void 0===e[0]||e[0];if(t.dispose(),t.room.off(l.f.Update,t.onRoomState),t.client.groupCallEventHandler.groupCalls.delete(t.room.roomId),t.client.emit(p.o.Ended,t),t.state=G.Ended,r){var n=t.room.currentState.getStateEvents(h.Bx.GroupCallPrefix,t.groupCallId);yield t.client.sendStateEvent(t.room.roomId,h.Bx.GroupCallPrefix,U(U({},n.getContent()),{},{"m.terminated":B.CallEnded}),t.groupCallId)}})()}isLocalVideoMuted(){return!this.localCallFeed||this.localCallFeed.isVideoMuted()}isMicrophoneMuted(){return!this.localCallFeed||this.localCallFeed.isAudioMuted()}setMicrophoneMuted(e){var t=this;return(0,n.A)(function*(){if(!e&&!(yield t.client.getMediaHandler().hasAudioDevice()))return!1;var r,i=!e&&t.isPtt;t.isPtt&&(!e&&t.isMicrophoneMuted()?t.transmitTimer=setTimeout(()=>{t.setMicrophoneMuted(!0)},t.pttMaxTransmitTime):e&&!t.isMicrophoneMuted()&&(null!==t.transmitTimer&&clearTimeout(t.transmitTimer),t.transmitTimer=null)),t.forEachCall(t=>{var r;return null==(r=t.localUsermediaFeed)?void 0:r.setAudioVideoMuted(e,null)});var o=(r=(0,n.A)(function*(){var e=[];t.forEachCall(t=>e.push(t.sendMetadataUpdate())),yield Promise.all(e).catch(e=>c.vF.info("GroupCall ".concat(t.groupCallId," setMicrophoneMuted() failed to send some metadata updates"),e))}),function(){return r.apply(this,arguments)});if(i&&(yield o()),t.localCallFeed){if(c.vF.log("GroupCall ".concat(t.groupCallId," setMicrophoneMuted() (streamId=").concat(t.localCallFeed.stream.id,", muted=").concat(e,")")),!(yield t.checkAudioPermissionIfNecessary(e)))return!1;t.localCallFeed.setAudioVideoMuted(e,null),(0,s.ms)(t.localCallFeed.stream.getAudioTracks(),!e)}else c.vF.log("GroupCall ".concat(t.groupCallId," setMicrophoneMuted() no stream muted (muted=").concat(e,")")),t.initWithAudioMuted=e;return t.forEachCall(r=>(0,s.ms)(r.localUsermediaFeed.stream.getAudioTracks(),!e&&t.callExpected(r))),t.emit(W.LocalMuteStateChanged,e,t.isLocalVideoMuted()),i||(yield o()),!0})()}checkAudioPermissionIfNecessary(e){var t=this;return(0,n.A)(function*(){try{if(!e&&t.localCallFeed&&!t.localCallFeed.hasAudioTrack){var r=yield t.client.getMediaHandler().getUserMediaStream(!0,!t.localCallFeed.isVideoMuted());if((null==r?void 0:r.getTracks().length)===0)return c.vF.log("GroupCall ".concat(t.groupCallId," setMicrophoneMuted() no device to receive local stream, muted=").concat(e)),!1}}catch(r){return c.vF.log("GroupCall ".concat(t.groupCallId," setMicrophoneMuted() no device or permission to receive local stream, muted=").concat(e)),!1}return!0})()}setLocalVideoMuted(e){var t=this;return(0,n.A)(function*(){if(!e&&!(yield t.client.getMediaHandler().hasVideoDevice()))return!1;if(t.localCallFeed){c.vF.log("GroupCall ".concat(t.groupCallId," setLocalVideoMuted() (stream=").concat(t.localCallFeed.stream.id,", muted=").concat(e,")"));try{var r=yield t.client.getMediaHandler().getUserMediaStream(!0,!e);yield t.updateLocalUsermediaStream(r),t.localCallFeed.setAudioVideoMuted(null,e),(0,s.ms)(t.localCallFeed.stream.getVideoTracks(),!e)}catch(r){return c.vF.log("GroupCall ".concat(t.groupCallId," setLocalVideoMuted() no device or permission to receive local stream, muted=").concat(e)),!1}}else c.vF.log("GroupCall ".concat(t.groupCallId," setLocalVideoMuted() no stream muted (muted=").concat(e,")")),t.initWithVideoMuted=e;var n=[];return t.forEachCall(t=>n.push(t.setLocalVideoMuted(e))),yield Promise.all(n),t.forEachCall(r=>(0,s.ms)(r.localUsermediaFeed.stream.getVideoTracks(),!e&&t.callExpected(r))),t.emit(W.LocalMuteStateChanged,t.isMicrophoneMuted(),e),!0})()}setScreensharingEnabled(e){var t=arguments,r=this;return(0,n.A)(function*(){var n=t.length>1&&void 0!==t[1]?t[1]:{};if(e===r.isScreensharing())return e;if(!e)return r.forEachCall(e=>{e.localScreensharingFeed&&e.removeLocalFeed(e.localScreensharingFeed)}),r.client.getMediaHandler().stopScreensharingStream(r.localScreenshareFeed.stream),r.removeScreenshareFeed(r.localScreenshareFeed),r.localScreenshareFeed=void 0,r.localDesktopCapturerSourceId=void 0,r.emit(W.LocalScreenshareStateChanged,!1,void 0,void 0),!1;try{c.vF.log("GroupCall ".concat(r.groupCallId," setScreensharingEnabled() is asking for screensharing permissions"));var i=yield r.client.getMediaHandler().getScreensharingStream(n),o=function*(e){var t=()=>{r.setScreensharingEnabled(!1),e.removeEventListener("ended",t)};e.addEventListener("ended",t)};for(var s of i.getTracks())yield*o(s);return c.vF.log("GroupCall ".concat(r.groupCallId," setScreensharingEnabled() granted screensharing permissions. Setting screensharing enabled on all calls")),r.localDesktopCapturerSourceId=n.desktopCapturerSourceId,r.localScreenshareFeed=new a.Hh({client:r.client,roomId:r.room.roomId,userId:r.client.getUserId(),deviceId:r.client.getDeviceId(),stream:i,purpose:u.h.Screenshare,audioMuted:!1,videoMuted:!1}),r.addScreenshareFeed(r.localScreenshareFeed),r.emit(W.LocalScreenshareStateChanged,!0,r.localScreenshareFeed,r.localDesktopCapturerSourceId),r.forEachCall(e=>e.pushLocalFeed(r.localScreenshareFeed.clone())),!0}catch(e){if(n.throwOnFail)throw e;return c.vF.error("GroupCall ".concat(r.groupCallId," setScreensharingEnabled() enabling screensharing error"),e),r.emit(W.Error,new V(q.NoUserMedia,"Failed to get screen-sharing stream: ",e)),!1}})()}isScreensharing(){return!!this.localScreenshareFeed}wantsOutgoingCall(e,t){var r=this.client.getUserId(),n=this.client.getDeviceId();return e>=r&&(e!==r||t>n)}placeOutgoingCalls(){var e=this,t=!1,r=function(r){var n,o=null!=(n=e.calls.get(r))?n:new Map,a=function(n){var i=o.get(n);if((null==i?void 0:i.getOpponentSessionId())!==d.sessionId&&e.wantsOutgoingCall(r,n)){t=!0,void 0!==i&&(c.vF.debug("GroupCall ".concat(e.groupCallId," placeOutgoingCalls() replacing call (userId=").concat(r,", deviceId=").concat(n,", callId=").concat(i.callId,")")),i.hangup(s.Il.NewSession,!1));var a=(0,s.sv)(e.client,e.room.roomId,{invitee:r,opponentDeviceId:n,opponentSessionId:d.sessionId,groupCallId:e.groupCallId});null===a?(c.vF.error("GroupCall ".concat(e.groupCallId," placeOutgoingCalls() failed to create call (userId=").concat(r,", device=").concat(n,")")),o.delete(n)):(e.initCall(a),o.set(n,a),c.vF.debug("GroupCall ".concat(e.groupCallId," placeOutgoingCalls() placing call (userId=").concat(r,", deviceId=").concat(n,", sessionId=").concat(d.sessionId,")")),a.placeCallWithCallFeeds(e.getLocalFeeds().map(e=>e.clone()),d.screensharing).then(()=>{e.dataChannelsEnabled&&a.createDataChannel("datachannel",e.dataChannelOptions)}).catch(t=>{c.vF.warn("GroupCall ".concat(e.groupCallId," placeOutgoingCalls() failed to place call (userId=").concat(r,")"),t),t instanceof s.RA&&t.code===q.UnknownDevice?e.emit(W.Error,t):e.emit(W.Error,new V(q.PlaceCallFailed,"Failed to place call to ".concat(r))),a.hangup(s.Il.SignallingFailed,!1),o.get(n)===a&&o.delete(n)}))}};for(var[l,d]of i)a(l);o.size>0?e.calls.set(r,o):e.calls.delete(r)};for(var[{userId:n},i]of this.participants)r(n);t&&this.emit(W.CallsChanged,this.calls)}getMemberStateEvents(e){return void 0===e?this.room.currentState.getStateEvents(h.Bx.GroupCallMemberPrefix):this.room.currentState.getStateEvents(h.Bx.GroupCallMemberPrefix,e)}initCall(e){var t=J(e);if(!t)throw Error("Cannot init call without user id");var r=()=>this.onCallFeedsChanged(e),n=(t,r)=>this.onCallStateChanged(e,t,r),i=this.onCallHangup,o=t=>this.onCallReplaced(e,t),a=this.callHandlers.get(t);void 0===a&&(a=new Map,this.callHandlers.set(t,a)),a.set(e.getOpponentDeviceId(),{onCallFeedsChanged:r,onCallStateChanged:n,onCallHangup:i,onCallReplaced:o}),e.on(s.$E.FeedsChanged,r),e.on(s.$E.State,n),e.on(s.$E.Hangup,i),e.on(s.$E.Replaced,o),e.isPtt=this.isPtt,this.reEmitter.reEmit(e,Object.values(s.$E)),e.initStats(this.getGroupCallStats()),r()}disposeCall(e,t){var r=J(e),n=e.getOpponentDeviceId();if(!r)throw Error("Cannot dispose call without user id");var i=this.callHandlers.get(r),{onCallFeedsChanged:o,onCallStateChanged:a,onCallHangup:l,onCallReplaced:c}=i.get(n);if(e.removeListener(s.$E.FeedsChanged,o),e.removeListener(s.$E.State,a),e.removeListener(s.$E.Hangup,l),e.removeListener(s.$E.Replaced,c),i.delete(r),0===i.size&&this.callHandlers.delete(r),e.hangupReason!==s.Il.Replaced){var d=this.getUserMediaFeed(r,n);d&&this.removeUserMediaFeed(d);var u=this.getScreenshareFeed(r,n);u&&this.removeScreenshareFeed(u)}}getUserMediaFeed(e,t){return this.userMediaFeeds.find(r=>r.userId===e&&r.deviceId===t)}addUserMediaFeed(e){this.userMediaFeeds.push(e),e.measureVolumeActivity(!0),this.emit(W.UserMediaFeedsChanged,this.userMediaFeeds)}replaceUserMediaFeed(e,t){var r=this.userMediaFeeds.findIndex(t=>t.userId===e.userId&&t.deviceId===e.deviceId);if(-1===r)throw Error("Couldn't find user media feed to replace");this.userMediaFeeds.splice(r,1,t),e.dispose(),t.measureVolumeActivity(!0),this.emit(W.UserMediaFeedsChanged,this.userMediaFeeds)}removeUserMediaFeed(e){var t=this.userMediaFeeds.findIndex(t=>t.userId===e.userId&&t.deviceId===e.deviceId);if(-1===t)throw Error("Couldn't find user media feed to remove");this.userMediaFeeds.splice(t,1),e.dispose(),this.emit(W.UserMediaFeedsChanged,this.userMediaFeeds),this.activeSpeaker===e&&(this.activeSpeaker=this.userMediaFeeds[0],this.emit(W.ActiveSpeakerChanged,this.activeSpeaker))}getScreenshareFeed(e,t){return this.screenshareFeeds.find(r=>r.userId===e&&r.deviceId===t)}addScreenshareFeed(e){this.screenshareFeeds.push(e),this.emit(W.ScreenshareFeedsChanged,this.screenshareFeeds)}replaceScreenshareFeed(e,t){var r=this.screenshareFeeds.findIndex(t=>t.userId===e.userId&&t.deviceId===e.deviceId);if(-1===r)throw Error("Couldn't find screenshare feed to replace");this.screenshareFeeds.splice(r,1,t),e.dispose(),this.emit(W.ScreenshareFeedsChanged,this.screenshareFeeds)}removeScreenshareFeed(e){var t=this.screenshareFeeds.findIndex(t=>t.userId===e.userId&&t.deviceId===e.deviceId);if(-1===t)throw Error("Couldn't find screenshare feed to remove");this.screenshareFeeds.splice(t,1),e.dispose(),this.emit(W.ScreenshareFeedsChanged,this.screenshareFeeds)}updateParticipants(){var e=this.room.getMember(this.client.getSafeUserId());if(!e)return void c.vF.warn("GroupCall ".concat(this.groupCallId," updateParticipants() tried to update participants before local room member is available"));if(null!==this.participantsExpirationTimer&&(clearTimeout(this.participantsExpirationTimer),this.participantsExpirationTimer=null),this.state===G.Ended){this.participants=new Map;return}var t=new Map,r=Date.now(),n=this.state===G.Entered||this.enteredViaAnotherSession,i=1/0;for(var o of this.getMemberStateEvents()){var a=this.room.getMember(o.getStateKey()),s=o.getContent(),l=(Array.isArray(s["m.calls"])?s["m.calls"]:[]).find(e=>e["m.call_id"]===this.groupCallId),d=(Array.isArray(null==l?void 0:l["m.devices"])?l["m.devices"]:[]).filter(e=>"string"==typeof e.device_id&&"string"==typeof e.session_id&&"number"==typeof e.expires_ts&&e.expires_ts>r&&Array.isArray(e.feeds));if(n||(null==a?void 0:a.userId)!==this.client.getUserId()||(d=d.filter(e=>e.device_id!==this.client.getDeviceId())),d.length>0&&(null==a?void 0:a.membership)===F.O.Join){var h=new Map;for(var v of(t.set(a,h),d))h.set(v.device_id,{sessionId:v.session_id,screensharing:v.feeds.some(e=>e.purpose===u.h.Screenshare)}),v.expires_ts<i&&(i=v.expires_ts)}}if(n){var p=t.get(e);void 0===p&&(p=new Map,t.set(e,p)),p.has(this.client.getDeviceId())||p.set(this.client.getDeviceId(),{sessionId:this.client.getSessionId(),screensharing:this.getLocalFeeds().some(e=>e.purpose===u.h.Screenshare)})}this.participants=t,i<1/0&&(this.participantsExpirationTimer=setTimeout(()=>this.updateParticipants(),i-r))}updateDevices(e){var t=arguments,r=this;return(0,n.A)(function*(){var n,i=t.length>1&&void 0!==t[1]&&t[1],o=Date.now(),a=r.client.getUserId(),s=r.getMemberStateEvents(a),l=null!=(n=null==s?void 0:s.getContent())?n:{},c=Array.isArray(l["m.calls"])?l["m.calls"]:[],d=null,u=[];for(var v of c)v["m.call_id"]===r.groupCallId?d=v:u.push(v);null===d&&(d={});var p=e((Array.isArray(d["m.devices"])?d["m.devices"]:[]).filter(e=>"string"==typeof e.device_id&&"string"==typeof e.session_id&&"number"==typeof e.expires_ts&&e.expires_ts>o&&Array.isArray(e.feeds)));if(null!==p){var m=[...u];p.length>0&&m.push(U(U({},d),{},{"m.call_id":r.groupCallId,"m.devices":p})),yield r.client.sendStateEvent(r.room.roomId,h.Bx.GroupCallMemberPrefix,{"m.calls":m},a,{keepAlive:i})}})()}addDeviceToMemberState(){var e=this;return(0,n.A)(function*(){yield e.updateDevices(t=>[...t.filter(t=>t.device_id!==e.client.getDeviceId()),{device_id:e.client.getDeviceId(),session_id:e.client.getSessionId(),expires_ts:Date.now()+36e5,feeds:e.getLocalFeeds().map(e=>({purpose:e.purpose}))}])})()}updateMemberState(){var e=this;return(0,n.A)(function*(){null!==e.resendMemberStateTimer&&(clearInterval(e.resendMemberStateTimer),e.resendMemberStateTimer=null),e.state===G.Entered?(yield e.addDeviceToMemberState(),e.resendMemberStateTimer=setInterval((0,n.A)(function*(){c.vF.log("GroupCall ".concat(e.groupCallId,' updateMemberState() resending call member state"'));try{yield e.addDeviceToMemberState()}catch(t){c.vF.error("GroupCall ".concat(e.groupCallId," updateMemberState() failed to resend call member state"),t)}}),27e5)):yield e.updateDevices(t=>t.filter(t=>t.device_id!==e.client.getDeviceId()),!0)})()}cleanMemberState(){var e=this;return(0,n.A)(function*(){var{devices:t}=yield e.client.getDevices(),r=new Map(t.map(e=>[e.device_id,e]));yield e.updateDevices(t=>{var n=t.filter(t=>{var n=r.get(t.device_id);return(null==n?void 0:n.last_seen_ts)!==void 0&&!(t.device_id===e.client.getDeviceId()&&e.state!==G.Entered&&!e.enteredViaAnotherSession)});return n.length===t.length?null:n})})()}getGroupCallStats(){if(void 0===this.stats){var e=this.client.getUserId()||"unknown";this.stats=new x(this.groupCallId,e,this.statsCollectIntervalTime),this.stats.reports.on(M.I.CONNECTION_STATS,this.onConnectionStats),this.stats.reports.on(M.I.BYTE_SENT_STATS,this.onByteSentStats),this.stats.reports.on(M.I.SUMMARY_STATS,this.onSummaryStats),this.stats.reports.on(M.I.CALL_FEED_REPORT,this.onCallFeedReport)}return this.stats}setGroupCallStatsInterval(e){this.statsCollectIntervalTime=e,void 0!==this.stats&&(this.stats.stop(),this.stats.setInterval(e),e>0&&this.stats.start())}}},91699:e=>{"use strict";var t,r="object"==typeof Reflect?Reflect:null,n=r&&"function"==typeof r.apply?r.apply:function(e,t,r){return Function.prototype.apply.call(e,t,r)};t=r&&"function"==typeof r.ownKeys?r.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var i=Number.isNaN||function(e){return e!=e};function o(){o.init.call(this)}e.exports=o,e.exports.once=function(e,t){return new Promise(function(r,n){var i,o,a;function s(r){e.removeListener(t,l),n(r)}function l(){"function"==typeof e.removeListener&&e.removeListener("error",s),r([].slice.call(arguments))}m(e,t,l,{once:!0}),"error"!==t&&(i=e,o=s,a={once:!0},"function"==typeof i.on&&m(i,"error",o,a))})},o.EventEmitter=o,o.prototype._events=void 0,o.prototype._eventsCount=0,o.prototype._maxListeners=void 0;var a=10;function s(e){if("function"!=typeof e)throw TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function l(e){return void 0===e._maxListeners?o.defaultMaxListeners:e._maxListeners}function c(e,t,r,n){if(s(r),void 0===(o=e._events)?(o=e._events=Object.create(null),e._eventsCount=0):(void 0!==o.newListener&&(e.emit("newListener",t,r.listener?r.listener:r),o=e._events),a=o[t]),void 0===a)a=o[t]=r,++e._eventsCount;else if("function"==typeof a?a=o[t]=n?[r,a]:[a,r]:n?a.unshift(r):a.push(r),(i=l(e))>0&&a.length>i&&!a.warned){a.warned=!0;var i,o,a,c=Error("Possible EventEmitter memory leak detected. "+a.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");c.name="MaxListenersExceededWarning",c.emitter=e,c.type=t,c.count=a.length,console&&console.warn&&console.warn(c)}return e}function d(){if(!this.fired)return(this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0==arguments.length)?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function u(e,t,r){var n={fired:!1,wrapFn:void 0,target:e,type:t,listener:r},i=d.bind(n);return i.listener=r,n.wrapFn=i,i}function h(e,t,r){var n=e._events;if(void 0===n)return[];var i=n[t];return void 0===i?[]:"function"==typeof i?r?[i.listener||i]:[i]:r?function(e){for(var t=Array(e.length),r=0;r<t.length;++r)t[r]=e[r].listener||e[r];return t}(i):p(i,i.length)}function v(e){var t=this._events;if(void 0!==t){var r=t[e];if("function"==typeof r)return 1;if(void 0!==r)return r.length}return 0}function p(e,t){for(var r=Array(t),n=0;n<t;++n)r[n]=e[n];return r}function m(e,t,r,n){if("function"==typeof e.on)n.once?e.once(t,r):e.on(t,r);else if("function"==typeof e.addEventListener)e.addEventListener(t,function i(o){n.once&&e.removeEventListener(t,i),r(o)});else throw TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e)}Object.defineProperty(o,"defaultMaxListeners",{enumerable:!0,get:function(){return a},set:function(e){if("number"!=typeof e||e<0||i(e))throw RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");a=e}}),o.init=function(){(void 0===this._events||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},o.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||i(e))throw RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},o.prototype.getMaxListeners=function(){return l(this)},o.prototype.emit=function(e){for(var t=[],r=1;r<arguments.length;r++)t.push(arguments[r]);var i="error"===e,o=this._events;if(void 0!==o)i=i&&void 0===o.error;else if(!i)return!1;if(i){if(t.length>0&&(a=t[0]),a instanceof Error)throw a;var a,s=Error("Unhandled error."+(a?" ("+a.message+")":""));throw s.context=a,s}var l=o[e];if(void 0===l)return!1;if("function"==typeof l)n(l,this,t);else for(var c=l.length,d=p(l,c),r=0;r<c;++r)n(d[r],this,t);return!0},o.prototype.addListener=function(e,t){return c(this,e,t,!1)},o.prototype.on=o.prototype.addListener,o.prototype.prependListener=function(e,t){return c(this,e,t,!0)},o.prototype.once=function(e,t){return s(t),this.on(e,u(this,e,t)),this},o.prototype.prependOnceListener=function(e,t){return s(t),this.prependListener(e,u(this,e,t)),this},o.prototype.removeListener=function(e,t){var r,n,i,o,a;if(s(t),void 0===(n=this._events)||void 0===(r=n[e]))return this;if(r===t||r.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete n[e],n.removeListener&&this.emit("removeListener",e,r.listener||t));else if("function"!=typeof r){for(i=-1,o=r.length-1;o>=0;o--)if(r[o]===t||r[o].listener===t){a=r[o].listener,i=o;break}if(i<0)return this;0===i?r.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(r,i),1===r.length&&(n[e]=r[0]),void 0!==n.removeListener&&this.emit("removeListener",e,a||t)}return this},o.prototype.off=o.prototype.removeListener,o.prototype.removeAllListeners=function(e){var t,r,n;if(void 0===(r=this._events))return this;if(void 0===r.removeListener)return 0==arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==r[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete r[e]),this;if(0==arguments.length){var i,o=Object.keys(r);for(n=0;n<o.length;++n)"removeListener"!==(i=o[n])&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=r[e]))this.removeListener(e,t);else if(void 0!==t)for(n=t.length-1;n>=0;n--)this.removeListener(e,t[n]);return this},o.prototype.listeners=function(e){return h(this,e,!0)},o.prototype.rawListeners=function(e){return h(this,e,!1)},o.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):v.call(e,t)},o.prototype.listenerCount=v,o.prototype.eventNames=function(){return this._eventsCount>0?t(this._events):[]}},91841:(e,t,r)=>{"use strict";r.d(t,{k:()=>d});var n=r(29301),i=r(84458),o=r(9086),a=r(49699),s=r(389),l=r(64763),c=r(11749);class d{constructor(e,t){var r=this;this.client=e,this.logger=t,(0,i.A)(this,"sending",!1),(0,i.A)(this,"running",!0),(0,i.A)(this,"retryTimeout",null),(0,i.A)(this,"retryAttempts",0),(0,i.A)(this,"sendQueue",(0,n.A)(function*(){if(null!==r.retryTimeout&&clearTimeout(r.retryTimeout),r.retryTimeout=null,!r.sending&&r.running){r.logger.debug("Attempting to send queued to-device messages"),r.sending=!0;try{for(;r.running&&(e=yield r.client.store.getOldestToDeviceBatch(),null!==e);)yield r.sendBatch(e),yield r.client.store.removeToDeviceBatch(e.id),r.retryAttempts=0;if(!r.running)return;r.logger.debug("All queued to-device messages sent")}catch(n){++r.retryAttempts;var e,t=s.b.RETRY_BACKOFF_RATELIMIT(null,r.retryAttempts,n);if(-1===t)return void(4===Math.floor(n.httpStatus/100)?(r.logger.error("Fatal error when sending to-device message - dropping to-device batch!",n),yield r.client.store.removeToDeviceBatch(e.id)):r.logger.info("Automatic retry limit reached for to-device messages."));r.logger.info("Failed to send batch of to-device messages. Will retry in ".concat(t,"ms"),n),r.retryTimeout=setTimeout(r.sendQueue,t)}finally{r.sending=!1}}})),(0,i.A)(this,"onResumedSync",(e,t)=>{e===l.Lm.Syncing&&t!==l.Lm.Syncing&&(this.logger.info("Resuming queue after resumed sync"),this.sendQueue())})}start(){this.running=!0,this.sendQueue(),this.client.on(a.AU.Sync,this.onResumedSync)}stop(){this.running=!1,null!==this.retryTimeout&&clearTimeout(this.retryTimeout),this.retryTimeout=null,this.client.removeListener(a.AU.Sync,this.onResumedSync)}queueBatch(e){var t=this;return(0,n.A)(function*(){for(var r=[],n=0;n<e.batch.length;n+=20){var i={eventType:e.eventType,batch:e.batch.slice(n,n+20),txnId:t.client.makeTxnId()};r.push(i);var a=i.batch.map(e=>"".concat(e.userId,"/").concat(e.deviceId," (msgid ").concat(e.payload[o.wt],")"));t.logger.info("Enqueuing batch of to-device messages. type=".concat(e.eventType," txnid=").concat(i.txnId),a)}yield t.client.store.saveToDeviceBatches(r),t.sendQueue()})()}sendBatch(e){var t=this;return(0,n.A)(function*(){var r=new c.kG(()=>new Map);for(var n of e.batch)r.getOrCreate(n.userId).set(n.deviceId,n.payload);t.logger.info("Sending batch of ".concat(e.batch.length," to-device messages with ID ").concat(e.id," and txnId ").concat(e.txnId)),yield t.client.sendToDevice(e.eventType,r,e.txnId)})()}}},93368:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WidgetKind=void 0,t.WidgetKind=function(e){return e.Room="room",e.Account="account",e.Modal="modal",e}({})},94457:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.assertPresent=function(e,t){if(!e[t])throw Error("".concat(String(t)," is required"))}},94606:(e,t,r)=>{"use strict";r.d(t,{m:()=>s,x:()=>c});var n=r(84458),i=r(5408),o=r(15095),a=i.vF.getChild("RoomStickyEvents"),s=function(e){return e.Update="RoomStickyEvents.Update",e}({});function l(e){if("string"!=typeof e)throw Error("Not a string");if(!e.startsWith("@"))throw Error("Not a userId")}class c extends o.X{constructor(){super(...arguments),(0,n.A)(this,"stickyEventsMap",new Map),(0,n.A)(this,"unkeyedStickyEvents",new Set),(0,n.A)(this,"stickyEventTimer",void 0),(0,n.A)(this,"nextStickyEventExpiryTs",Number.MAX_SAFE_INTEGER),(0,n.A)(this,"cleanExpiredStickyEvents",()=>{var e,t=Date.now(),r=[];for(var[n,i]of(this.nextStickyEventExpiryTs=Number.MAX_SAFE_INTEGER,this.stickyEventsMap.entries())){for(var[o,[l,...c]]of i)t>=l.unstableStickyExpiresAt?(a.debug("Expiring sticky event",l.getId()),r.push(l),this.stickyEventsMap.get(n).delete(o)):(this.stickyEventsMap.get(n).set(o,[l,...c.filter(e=>e.unstableStickyExpiresAt<=t)]),this.nextStickyEventExpiryTs=Math.min(this.nextStickyEventExpiryTs,l.unstableStickyExpiresAt));(null==(e=this.stickyEventsMap.get(n))?void 0:e.size)===0&&this.stickyEventsMap.delete(n)}for(var d of this.unkeyedStickyEvents)t>=d.unstableStickyExpiresAt?(a.debug("Expiring sticky event",d.getId()),this.unkeyedStickyEvents.delete(d),r.push(d)):this.nextStickyEventExpiryTs=Math.min(this.nextStickyEventExpiryTs,d.unstableStickyExpiresAt);r.length&&this.emit(s.Update,[],[],r),this.scheduleStickyTimer()})}static sortStickyEvent(e,t){var r,n;if(t.getTs()!==e.getTs())return t.getTs()-e.getTs();if((null!=(r=t.getId())?r:"")>(null!=(n=e.getId())?n:""))return 1;throw Error("Comparing two sticky events with the same event ID is not allowed.")}static stickyMapKey(e,t){return"".concat(e).concat(t)}*getStickyEvents(){for(var e of(yield*this.unkeyedStickyEvents,this.stickyEventsMap.values()))for(var t of e.values())yield t[0]}getKeyedStickyEvent(e,t,r){var n;return l(e),null==(n=this.stickyEventsMap.get(t))||null==(n=n.get(c.stickyMapKey(r,e)))?void 0:n[0]}getUnkeyedStickyEvent(e,t){return[...this.unkeyedStickyEvents].filter(r=>r.getType()===t&&r.getSender()===e)}addStickyEvent(e){var t,r,n,i=e.getContent().msc4354_sticky_key;if("string"!=typeof i&&void 0!==i)throw Error("".concat(e.getId()," is missing msc4354_sticky_key"));if(void 0===e.unstableStickyExpiresAt)throw Error("".concat(e.getId()," is missing msc4354_sticky.duration_ms"));var o=e.getSender(),s=e.getType();if(l(o),e.unstableStickyExpiresAt<=Date.now())return a.info("ignored sticky event with older expiration time than current time",i),{added:!1};if(!o.startsWith("@"))throw Error("Expected sender to start with @");if(void 0===i)return this.unkeyedStickyEvents.add(e),this.nextStickyEventExpiryTs=Math.min(e.unstableStickyExpiresAt,this.nextStickyEventExpiryTs),this.scheduleStickyTimer(),{added:!0};var d=c.stickyMapKey(i,o),u=[e,...null!=(t=null==(r=this.stickyEventsMap.get(s))?void 0:r.get(d))?t:[]].sort(c.sortStickyEvent);return this.stickyEventsMap.has(s)||this.stickyEventsMap.set(s,new Map),null==(n=this.stickyEventsMap.get(s))||n.set(d,u),this.nextStickyEventExpiryTs=Math.min(e.unstableStickyExpiresAt,this.nextStickyEventExpiryTs),this.scheduleStickyTimer(),{added:u[0]===e,prevEvent:null==u?void 0:u[1]}}addStickyEvents(e){var t=[],r=[];for(var n of e)try{var i=this.addStickyEvent(n);i.added&&(i.prevEvent?r.push({current:n,previous:i.prevEvent}):t.push(n))}catch(e){a.warn("ignored invalid sticky event",e)}(t.length||r.length)&&this.emit(s.Update,t,r,[]),this.scheduleStickyTimer()}scheduleStickyTimer(){this.stickyEventTimer&&(clearTimeout(this.stickyEventTimer),this.stickyEventTimer=void 0),this.nextStickyEventExpiryTs!==Number.MAX_SAFE_INTEGER&&(this.stickyEventTimer=setTimeout(this.cleanExpiredStickyEvents,this.nextStickyEventExpiryTs-Date.now()))}handleRedaction(e){var t="string"==typeof e?e:e.getId();for(var r of this.unkeyedStickyEvents)if(r.getId()===t){this.unkeyedStickyEvents.delete(r),this.emit(s.Update,[],[],[r]);return}if("string"!=typeof e&&!e.isRedacted()){var n,i,o=e.getContent().msc4354_sticky_key;if("string"!=typeof o&&void 0!==o)return;var d=e.getType(),u=e.getSender();l(u);var h=this.stickyEventsMap.get(d);if(!h)return;var v=c.stickyMapKey(o,u),[p,...m]=null!=(n=h.get(v))?n:[];if(!p)return;a.debug("Redaction for ".concat(t," under sticky key ").concat(o));var g=m.filter(e=>!e.isRedacted()).sort(c.sortStickyEvent);null==(i=this.stickyEventsMap.get(d))||i.set(v,g),g.length?this.emit(s.Update,[],[{previous:p,current:g[0]}],[]):(h.delete(v),0===h.size&&this.stickyEventsMap.delete(d),this.emit(s.Update,[],[],[p]));return}for(var f of this.stickyEventsMap.values())for(var[y]of f.values())if(y.getId()===t)return this.handleRedaction(y)}clear(){this.stickyEventsMap.clear(),this.nextStickyEventExpiryTs=Number.MAX_SAFE_INTEGER,this.scheduleStickyTimer()}}},96039:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WidgetApiDirection=void 0,t.invertedDirection=function(e){if(e===r.ToWidget)return r.FromWidget;if(e===r.FromWidget)return r.ToWidget;throw Error("Invalid direction")};var r=function(e){return e.ToWidget="toWidget",e.FromWidget="fromWidget",e}({});t.WidgetApiDirection=r},96170:(e,t,r)=>{"use strict";r.d(t,{f:()=>n});var n=function(e){return e.NOT_SENT="not_sent",e.ENCRYPTING="encrypting",e.SENDING="sending",e.QUEUED="queued",e.SENT="sent",e.CANCELLED="cancelled",e}({})},97709:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ExtensibleEvents=void 0;var n=r(31642),i=r(66866),o=r(80646),a=r(50703),s=r(47406),l=r(77990),c=r(52621);function d(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}function u(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function h(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var v=function(){var e,t;function r(){if(!(this instanceof r))throw TypeError("Cannot call a class as a function");h(this,"interpreters",new n.NamespacedMap([[o.LEGACY_M_ROOM_MESSAGE,o.parseMRoomMessage],[s.M_MESSAGE,a.parseMMessage],[s.M_EMOTE,a.parseMMessage],[s.M_NOTICE,a.parseMMessage],[l.M_POLL_START,c.parseMPoll],[l.M_POLL_RESPONSE,c.parseMPoll],[l.M_POLL_END,c.parseMPoll]])),h(this,"_unknownInterpretOrder",[s.M_MESSAGE])}return e=[{key:"unknownInterpretOrder",get:function(){var e;return null!=(e=this._unknownInterpretOrder)?e:[]},set:function(e){this._unknownInterpretOrder=e}},{key:"registerInterpreter",value:function(e,t){this.interpreters.set(e,t)}},{key:"parse",value:function(e){try{if(this.interpreters.hasNamespaced(e.type))return this.interpreters.getNamespaced(e.type)(e);var t,r=function(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return d(e,void 0);var r=Object.prototype.toString.call(e).slice(8,-1);if("Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return d(e,t)}}(e))){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return a=e.done,e},e:function(e){s=!0,o=e},f:function(){try{a||null==r.return||r.return()}finally{if(s)throw o}}}}(this.unknownInterpretOrder);try{for(r.s();!(t=r.n()).done;){var n=t.value;if(this.interpreters.has(n)){var o=this.interpreters.get(n)(e);if(o)return o}}}catch(e){r.e(e)}finally{r.f()}return null}catch(e){if(e instanceof i.InvalidEventError)return null;throw e}}}],t=[{key:"defaultInstance",get:function(){return r._defaultInstance}},{key:"unknownInterpretOrder",get:function(){return r.defaultInstance.unknownInterpretOrder},set:function(e){r.defaultInstance.unknownInterpretOrder=e}},{key:"registerInterpreter",value:function(e,t){r.defaultInstance.registerInterpreter(e,t)}},{key:"parse",value:function(e){return r.defaultInstance.parse(e)}}],e&&u(r.prototype,e),t&&u(r,t),Object.defineProperty(r,"prototype",{writable:!1}),r}();t.ExtensibleEvents=v,h(v,"_defaultInstance",new v)},98597:(e,t,r)=>{"use strict";function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.EmoteEvent=void 0;var i=r(62404),o=r(47406),a=r(52337);function s(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function l(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function c(){return(c="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,r){var n=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=u(e)););return e}(e,t);if(n){var i=Object.getOwnPropertyDescriptor(n,t);return i.get?i.get.call(arguments.length<3?e:r):i.value}}).apply(this,arguments)}function d(e,t){return(d=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function u(e){return(u=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}t.EmoteEvent=function(e){if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");v.prototype=Object.create(e&&e.prototype,{constructor:{value:v,writable:!0,configurable:!0}}),Object.defineProperty(v,"prototype",{writable:!1}),e&&d(v,e);var t,r,i,h=(t=function(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}(),function(){var e,r=u(v);return e=t?Reflect.construct(r,arguments,u(this).constructor):r.apply(this,arguments),function(e,t){if(t&&("object"===n(t)||"function"==typeof t))return t;if(void 0!==t)throw TypeError("Derived constructors may only return object or undefined");var r=e;if(void 0===r)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return r}(this,e)});function v(e){if(!(this instanceof v))throw TypeError("Cannot call a class as a function");return h.call(this,e)}return r=[{key:"isEmote",get:function(){return!0}},{key:"isEquivalentTo",value:function(e){return(0,a.isEventTypeSame)(e,o.M_EMOTE)||c(u(v.prototype),"isEquivalentTo",this).call(this,e)}},{key:"serialize",value:function(){var e=c(u(v.prototype),"serialize",this).call(this);return e.content.msgtype="m.emote",e}}],i=[{key:"from",value:function(e,t){var r;return new v({type:o.M_EMOTE.name,content:(s(r={},o.M_TEXT.name,e),s(r,o.M_HTML.name,t),r)})}}],r&&l(v.prototype,r),i&&l(v,i),Object.defineProperty(v,"prototype",{writable:!1}),v}(i.MessageEvent)},98973:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.REFERENCE_RELATION=void 0,t.REFERENCE_RELATION=new(r(10393)).NamespacedValue("m.reference")},99472:(e,t)=>{"use strict";function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.isErrorResponse=function(e){var t=e.error;return"object"===r(t)&&null!==t&&"message"in t&&"string"==typeof t.message}}}]);