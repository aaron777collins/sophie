"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[796],{49699:(e,t,r)=>{r.d(t,{A0:()=>eh,AU:()=>ey,HF:()=>eo,JM:()=>ev,NB:()=>eu,Xb:()=>eT,eO:()=>ea,fN:()=>eE,hx:()=>ed,it:()=>em,jB:()=>ep,mD:()=>eS,pB:()=>ef,rG:()=>ec,uD:()=>el});var n=r(24302),i=r(29301),s=r(84458),o=r(64763),a=r(82393),d=r(72678),l=r(25097),u=r(74411),h=r(76150),c=r(40977),v=r(11749),p=r(12411),m=r(47208),g=r(40055),y=r(35095),R=r(75525),f=r(5408),I=r(11007),S=r(36963),T=r(65920),E=r(83656),b=r(21401),k=r(20213),_=r(61219),P=r(59741),A=r(54120),w=r(9086),$=r(84656),x=r(46546),C=r(5862),U=r(74280),q=r(26954),D=r(85305),O=r(90426),N=r(61554),F=r(15095),M=r(33234),B=r(14699),L=r(37151),G=r(12922),K=r(81626),j=r(91841),V=r(19187),W=r(38178),H=r(52066),J=r(37858),Q=r(3662),X=r(84119),z=r(71700),Y=r(5294),Z=r(43957),ee=r(20748),et=r(26268),er=r(69103),en=["server","limit","since"];function ei(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function es(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?ei(Object(r),!0).forEach(function(t){(0,s.A)(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):ei(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}var eo=new K.qr("last_seen_user_agent","org.matrix.msc3852.last_seen_user_agent"),ea=function(e){return e.Chronological="chronological",e.Detached="detached",e}({}),ed=new K.xu("m.get_login_token","org.matrix.msc3882.get_login_token"),el="uk.half-shot.msc2666",eu="uk.half-shot.msc2666.mutual_rooms",eh="uk.half-shot.msc2666.query_mutual_rooms",ec="org.matrix.msc4140",ev="org.matrix.msc4354",ep="uk.tcpip.msc4133",em="uk.tcpip.msc4133.stable",eg=function(e){return e.MasterKey="master_key",e.SelfSigningKey="self_signing_key",e.UserSigningKey="user_signing_key",e}(eg||{}),ey=function(e){return e.Sync="sync",e.Event="event",e.ToDeviceEvent="toDeviceEvent",e.ReceivedToDeviceMessage="receivedToDeviceMessage",e.AccountData="accountData",e.Room="Room",e.DeleteRoom="deleteRoom",e.SyncUnexpectedError="sync.unexpectedError",e.ClientWellKnown="WellKnown.client",e.ReceivedVoipEvent="received_voip_event",e.TurnServers="turnServers",e.TurnServersError="turnServers.error",e}({}),eR=new K.qr("action","org.matrix.msc3824.action");class ef extends F.X{constructor(e){super(),n=this,(0,s.A)(this,"logger",void 0),(0,s.A)(this,"reEmitter",new R.Q(this)),(0,s.A)(this,"olmVersion",null),(0,s.A)(this,"usingExternalCrypto",!1),(0,s.A)(this,"_store",void 0),(0,s.A)(this,"deviceId",void 0),(0,s.A)(this,"credentials",void 0),(0,s.A)(this,"legacyPickleKey",void 0),(0,s.A)(this,"scheduler",void 0),(0,s.A)(this,"clientRunning",!1),(0,s.A)(this,"timelineSupport",!1),(0,s.A)(this,"urlPreviewCache",{}),(0,s.A)(this,"identityServer",void 0),(0,s.A)(this,"http",void 0),(0,s.A)(this,"cryptoBackend",void 0),(0,s.A)(this,"enableEncryptedStateEvents",void 0),(0,s.A)(this,"cryptoCallbacks",void 0),(0,s.A)(this,"callEventHandler",void 0),(0,s.A)(this,"groupCallEventHandler",void 0),(0,s.A)(this,"supportsCallTransfer",!1),(0,s.A)(this,"forceTURN",!1),(0,s.A)(this,"iceCandidatePoolSize",0),(0,s.A)(this,"idBaseUrl",void 0),(0,s.A)(this,"baseUrl",void 0),(0,s.A)(this,"isVoipWithNoMediaAllowed",void 0),(0,s.A)(this,"disableVoip",void 0),(0,s.A)(this,"useLivekitForGroupCalls",void 0),(0,s.A)(this,"canSupportVoip",!1),(0,s.A)(this,"peekSync",null),(0,s.A)(this,"isGuestAccount",!1),(0,s.A)(this,"ongoingScrollbacks",{}),(0,s.A)(this,"notifTimelineSet",null),(0,s.A)(this,"legacyCryptoStore",void 0),(0,s.A)(this,"verificationMethods",void 0),(0,s.A)(this,"fallbackICEServerAllowed",!1),(0,s.A)(this,"syncApi",void 0),(0,s.A)(this,"roomNameGenerator",void 0),(0,s.A)(this,"pushRules",void 0),(0,s.A)(this,"syncLeftRoomsPromise",void 0),(0,s.A)(this,"syncedLeftRooms",!1),(0,s.A)(this,"clientOpts",void 0),(0,s.A)(this,"clientWellKnownIntervalID",void 0),(0,s.A)(this,"canResetTimelineCallback",void 0),(0,s.A)(this,"canSupport",new Map),(0,s.A)(this,"pushProcessor",new m.j(this)),(0,s.A)(this,"serverVersionsPromise",void 0),(0,s.A)(this,"clientWellKnown",void 0),(0,s.A)(this,"clientWellKnownPromise",void 0),(0,s.A)(this,"turnServers",[]),(0,s.A)(this,"turnServersExpiry",0),(0,s.A)(this,"checkTurnServersIntervalID",void 0),(0,s.A)(this,"txnCtr",0),(0,s.A)(this,"mediaHandler",new N.L(this)),(0,s.A)(this,"sessionId",void 0),(0,s.A)(this,"eventsBeingEncrypted",new Set),(0,s.A)(this,"useE2eForGroupCall",!0),(0,s.A)(this,"toDeviceMessageQueue",void 0),(0,s.A)(this,"livekitServiceURL",void 0),(0,s.A)(this,"_secretStorage",void 0),(0,s.A)(this,"ignoredInvites",void 0),(0,s.A)(this,"matrixRTC",void 0),(0,s.A)(this,"serverCapabilitiesService",void 0),(0,s.A)(this,"startCallEventHandler",()=>{this.isInitialSyncComplete()&&((0,l.sj)()&&(this.callEventHandler.start(),this.groupCallEventHandler.start()),this.off(ey.Sync,this.startCallEventHandler))}),(0,s.A)(this,"startMatrixRTC",()=>{this.isInitialSyncComplete()&&(this.matrixRTC.start(),this.off(ey.Sync,this.startMatrixRTC))}),(0,s.A)(this,"fixupRoomNotifications",()=>{if(this.isInitialSyncComplete()){var e;for(var t of(null!=(e=this.getRooms())?e:[]).filter(e=>e.getUnreadNotificationCount(_.X5.Total)>0)){var r=this.getSafeUserId();t.fixupNotifications(r)}this.off(ey.Sync,this.fixupRoomNotifications)}}),this.logger=null!=(t=e.logger)?t:f.vF,e.baseUrl=v.hc(e.baseUrl),e.idBaseUrl=v.hc(e.idBaseUrl),this.baseUrl=e.baseUrl,this.idBaseUrl=e.idBaseUrl,this.identityServer=e.identityServer,this.usingExternalCrypto=null!=(r=e.usingExternalCrypto)&&r,this.store=e.store||new d.E,this.deviceId=e.deviceId||null,this.sessionId=(0,C.US)(10);var t,r,n,o,u,p,g=e.userId||null;this.credentials={userId:g},this.http=new S.ED(this,{fetchFn:e.fetchFn,baseUrl:e.baseUrl,idBaseUrl:e.idBaseUrl,accessToken:e.accessToken,refreshToken:e.refreshToken,tokenRefreshFunction:e.tokenRefreshFunction,prefix:S.iD.V3,onlyData:!0,extraParams:e.queryParams,localTimeoutMs:e.localTimeoutMs,useAuthorizationHeader:e.useAuthorizationHeader,logger:this.logger}),e.pickleKey&&(this.legacyPickleKey=e.pickleKey),this.useLivekitForGroupCalls=!!e.useLivekitForGroupCalls,this.scheduler=e.scheduler,this.scheduler&&this.scheduler.setProcessFunction(function(){var e=(0,i.A)(function*(e){var t=n.getRoom(e.getRoomId());e.status!==a.fb.SENDING&&n.updatePendingEventStatus(t,e,a.fb.SENDING);var r=yield n.sendEventHttpRequest(e);return t&&t.updatePendingEvent(e,a.fb.SENT,r.event_id),r});return function(t){return e.apply(this,arguments)}}()),this.disableVoip=null!=(o=e.disableVoip)&&o,!this.disableVoip&&(0,l.sj)()&&(this.callEventHandler=new h.N(this),this.groupCallEventHandler=new c.e(this),this.canSupportVoip=!0,this.on(ey.Sync,this.startCallEventHandler)),this.matrixRTC=new X.I(this.logger,this),this.serverCapabilitiesService=new Z.K(this.logger,this.http),this.on(ey.Sync,this.fixupRoomNotifications),this.timelineSupport=!!e.timelineSupport,this.legacyCryptoStore=e.cryptoStore,this.verificationMethods=e.verificationMethods,this.cryptoCallbacks=e.cryptoCallbacks||{},this.enableEncryptedStateEvents=null!=(u=e.enableEncryptedStateEvents)&&u,this.forceTURN=e.forceTURN||!1,this.iceCandidatePoolSize=void 0===e.iceCandidatePoolSize?0:e.iceCandidatePoolSize,this.supportsCallTransfer=e.supportsCallTransfer||!1,this.fallbackICEServerAllowed=e.fallbackICEServerAllowed||!1,this.isVoipWithNoMediaAllowed=e.isVoipWithNoMediaAllowed||!1,void 0!==e.useE2eForGroupCall&&(this.useE2eForGroupCall=e.useE2eForGroupCall),this.livekitServiceURL=e.livekitServiceURL,this.roomNameGenerator=e.roomNameGenerator,this.toDeviceMessageQueue=new j.k(this,this.logger),this.on(a.OQ.Decrypted,e=>{eS(this,e)}),this.ignoredInvites=new V.bp(this),this._secretStorage=new Q.ServerSideSecretStorageImpl(this,null!=(p=e.cryptoCallbacks)?p:{}),this.setMaxListeners(0)}set store(e){this._store=e,this._store.setUserCreator(e=>T.K.createUser(e,this))}get store(){return this._store}startClient(e){var t=this;return(0,i.A)(function*(){if(!t.clientRunning){t.clientRunning=!0,t.on(ey.Sync,t.startMatrixRTC);var r=t.getUserId();r&&t.store.storeUser(new T.K(r)),t.supportsVoip()&&(t.checkTurnServersIntervalID=setInterval(()=>{t.checkTurnServers()},6e5),t.checkTurnServers()),t.syncApi&&(t.logger.error("Still have sync object whilst not running: stopping old one"),t.syncApi.stop());try{yield t.getVersions();var{threads:n,list:i,fwdPagination:s}=yield t.doesServerSupportThread();L.jV.setServerSideSupport(n),L.jV.setServerSideListSupport(i),L.jV.setServerSideFwdPaginationSupport(s)}catch(e){t.logger.error("Can't fetch server versions, continuing to initialise sync, this will be retried later",e)}t.clientOpts=null!=e?e:{},t.clientOpts.slidingSync?t.syncApi=new B.m(t.clientOpts.slidingSync,t,t.clientOpts,t.buildSyncApiOptions()):t.syncApi=new o.w_(t,t.clientOpts,t.buildSyncApiOptions()),t.syncApi.sync().catch(e=>t.logger.info("Sync startup aborted with an error:",e)),void 0!==t.clientOpts.clientWellKnownPollPeriod&&(t.clientWellKnownIntervalID=setInterval(()=>{t.fetchClientWellKnown()},1e3*t.clientOpts.clientWellKnownPollPeriod),t.fetchClientWellKnown()),t.toDeviceMessageQueue.start(),t.serverCapabilitiesService.start()}})()}buildSyncApiOptions(){return{cryptoCallbacks:this.cryptoBackend,canResetEntireTimeline:e=>!!this.canResetTimelineCallback&&this.canResetTimelineCallback(e),logger:this.logger.getChild("sync")}}stopClient(){var e,t,r,n,i;null==(e=this.cryptoBackend)||e.stop(),this.off(ey.Sync,this.startMatrixRTC),this.clientRunning&&(this.logger.debug("stopping MatrixClient"),this.clientRunning=!1,null==(t=this.syncApi)||t.stop(),this.syncApi=void 0,null==(r=this.peekSync)||r.stopPeeking(),null==(n=this.callEventHandler)||n.stop(),null==(i=this.groupCallEventHandler)||i.stop(),this.callEventHandler=void 0,this.groupCallEventHandler=void 0,globalThis.clearInterval(this.checkTurnServersIntervalID),this.checkTurnServersIntervalID=void 0,void 0!==this.clientWellKnownIntervalID&&globalThis.clearInterval(this.clientWellKnownIntervalID),this.toDeviceMessageQueue.stop(),this.matrixRTC.stop(),this.serverCapabilitiesService.stop())}clearStores(){var e,t=this,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(this.clientRunning)throw Error("Cannot clear stores while client is running");var n=[];return n.push(this.store.deleteAllData()),this.legacyCryptoStore&&n.push(this.legacyCryptoStore.deleteAllData()),n.push((e=(0,i.A)(function*(){try{if(!(e=globalThis.indexedDB))return}catch(e){return}var e,n,i,s=function*(r){var n=new Promise((n,i)=>{t.logger.info("Removing IndexedDB instance ".concat(r));var s=e.deleteDatabase(r);s.onsuccess=e=>{t.logger.info("Removed IndexedDB instance ".concat(r)),n(0)},s.onerror=e=>{t.logger.warn("Failed to remove IndexedDB instance ".concat(r,":"),e),n(0)},s.onblocked=e=>{t.logger.info("cannot yet remove IndexedDB instance ".concat(r))}});yield n};for(var o of["".concat(null!=(n=r.cryptoDatabasePrefix)?n:H.J,"::matrix-sdk-crypto"),"".concat(null!=(i=r.cryptoDatabasePrefix)?i:H.J,"::matrix-sdk-crypto-meta")])yield*s(o)}),function(){return e.apply(this,arguments)})()),Promise.all(n).then()}getUserId(){var e,t;return null!=(e=null==(t=this.credentials)?void 0:t.userId)?e:null}getSafeUserId(){var e=this.getUserId();if(!e)throw Error("Expected logged in user but found none.");return e}getDomain(){var e;return null!=(e=this.credentials)&&e.userId?this.credentials.userId.replace(/^.*?:/,""):null}getUserIdLocalpart(){var e,t;return null!=(e=null==(t=this.credentials)||null==(t=t.userId)?void 0:t.split(":")[0].substring(1))?e:null}getDeviceId(){return this.deviceId}getSessionId(){return this.sessionId}supportsVoip(){return!this.disableVoip&&this.canSupportVoip}getMediaHandler(){return this.mediaHandler}setForceTURN(e){this.forceTURN=e}setSupportsCallTransfer(e){this.supportsCallTransfer=e}getUseE2eForGroupCall(){return this.useE2eForGroupCall}createCall(e){return(0,l.sv)(this,e)}createGroupCall(e,t,r,n,s,o){var a=this;return(0,i.A)(function*(){if(a.getGroupCallForRoom(e))throw Error("".concat(e," already has an existing group call"));var i=a.getRoom(e);if(!i)throw Error("Cannot find room ".concat(e));return new O.eO(a,i,t,r,n,void 0,s||a.isVoipWithNoMediaAllowed,o,a.isVoipWithNoMediaAllowed,a.useLivekitForGroupCalls,a.livekitServiceURL).create()})()}getLivekitServiceURL(){return this.livekitServiceURL}setLivekitServiceURL(e){this.livekitServiceURL=e}waitUntilRoomReadyForGroupCalls(e){return this.groupCallEventHandler.waitUntilRoomReadyForGroupCalls(e)}getGroupCallForRoom(e){return this.groupCallEventHandler.groupCalls.get(e)||null}getSyncState(){var e,t;return null!=(e=null==(t=this.syncApi)?void 0:t.getSyncState())?e:null}getSyncStateData(){return this.syncApi?this.syncApi.getSyncStateData():null}isInitialSyncComplete(){var e=this.getSyncState();return!!e&&(e===o.Lm.Prepared||e===o.Lm.Syncing)}isGuest(){return this.isGuestAccount}setGuest(e){this.isGuestAccount=e}getScheduler(){return this.scheduler}retryImmediately(){var e,t;return this.toDeviceMessageQueue.sendQueue(),null!=(e=null==(t=this.syncApi)?void 0:t.retryImmediately())&&e}getNotifTimelineSet(){return this.notifTimelineSet}setNotifTimelineSet(e){this.notifTimelineSet=e}getCapabilities(){var e=this;return(0,i.A)(function*(){var t=e.serverCapabilitiesService.getCachedCapabilities();return t||e.serverCapabilitiesService.fetchCapabilities()})()}getCachedCapabilities(){return this.serverCapabilitiesService.getCachedCapabilities()}fetchCapabilities(){return this.serverCapabilitiesService.fetchCapabilities()}initRustCrypto(){var e=arguments,t=this;return(0,i.A)(function*(){var n,i,s=e.length>0&&void 0!==e[0]?e[0]:{};if(t.cryptoBackend)return void t.logger.warn("Attempt to re-initialise e2e encryption on MatrixClient");var o=t.getUserId();if(null===o)throw Error("Cannot enable encryption on MatrixClient with unknown userId: ensure userId is passed in createClient().");var a=t.getDeviceId();if(null===a)throw Error("Cannot enable encryption on MatrixClient with unknown deviceId: ensure deviceId is passed in createClient().");t.logger.debug("Downloading Rust crypto library");var d=yield Promise.all([r.e(415),r.e(296)]).then(r.bind(r,85296)),l=yield d.initRustCrypto({logger:t.logger,http:t.http,userId:o,deviceId:a,secretStorage:t.secretStorage,cryptoCallbacks:t.cryptoCallbacks,storePrefix:!1===s.useIndexedDB?null:null!=(n=s.cryptoDatabasePrefix)?n:H.J,storeKey:s.storageKey,storePassphrase:s.storagePassword,legacyCryptoStore:t.legacyCryptoStore,legacyPickleKey:null!=(i=t.legacyPickleKey)?i:"DEFAULT_KEY",legacyMigrationProgressListener:(e,r)=>{t.emit(J.cr.LegacyCryptoStoreMigrationProgress,e,r)},enableEncryptedStateEvents:t.enableEncryptedStateEvents});l.setSupportedVerificationMethods(t.verificationMethods),t.cryptoBackend=l,t.on(P.o5.Membership,l.onRoomMembership.bind(l)),t.on(ey.Event,e=>{l.onLiveEventFromSync(e)}),t.reEmitter.reEmit(l,[J.cr.VerificationRequestReceived,J.cr.UserTrustStatusChanged,J.cr.KeyBackupStatus,J.cr.KeyBackupSessionsRemaining,J.cr.KeyBackupFailed,J.cr.KeyBackupDecryptionKeyCached,J.cr.KeysChanged,J.cr.DevicesUpdated,J.cr.WillUpdateDevices,J.cr.DehydratedDeviceCreated,J.cr.DehydratedDeviceUploaded,J.cr.RehydrationStarted,J.cr.RehydrationProgress,J.cr.RehydrationCompleted,J.cr.RehydrationError,J.cr.DehydrationKeyCached,J.cr.DehydratedDeviceRotationError])})()}get secretStorage(){return this._secretStorage}getCrypto(){return this.cryptoBackend}isRoomEncrypted(e){var t=this.getRoom(e);return!!t&&t.hasEncryptionStateEvent()}isKeyBackupKeyStored(){return Promise.resolve(this.secretStorage.isStored("m.megolm_backup.v1"))}makeKeyBackupPath(e,t,r){return{path:void 0!==t?v.RR("/room_keys/keys/$roomId/$sessionId",{$roomId:e,$sessionId:t}):void 0!==e?v.RR("/room_keys/keys/$roomId",{$roomId:e}):"/room_keys/keys",queryData:void 0===r?void 0:{version:r}}}deleteKeysFromBackup(e,t,r){var n=this;return(0,i.A)(function*(){var i=n.makeKeyBackupPath(e,t,r);yield n.http.authedRequest(S.IT.Delete,i.path,i.queryData,void 0,{prefix:S.iD.V3})})()}getMediaConfig(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return this.http.authedRequest(S.IT.Get,e?"/media/config":"/config",void 0,void 0,{prefix:e?S.iD.V1:S.zs.V3})}getRoom(e){return e?this.store.getRoom(e):null}getRooms(){return this.store.getRooms()}getVisibleRooms(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=new Set(this.store.getRooms());for(var r of t)for(var n of this.findPredecessorRooms(r,!0,e))t.delete(n);return Array.from(t)}getUser(e){return this.store.getUser(e)}getUsers(){return this.store.getUsers()}setAccountData(e,t){var r=this;return(0,i.A)(function*(){if(!r.clientRunning)return r.logger.warn("Calling `setAccountData` before the client is started: `getAccountData` may return inconsistent results."),yield(0,S.Y6)(5,()=>r.setAccountDataRaw(e,t));var n=r.store.getAccountData(e);if(n&&(0,v.ky)(n.event.content,t))return{};var i=Promise.withResolvers();function s(t){t.getType()===e&&i.resolve()}r.addListener(ey.AccountData,s);try{var o=yield(0,S.Y6)(5,()=>r.setAccountDataRaw(e,t));return yield i.promise,o}finally{r.removeListener(ey.AccountData,s)}})()}setAccountDataRaw(e,t){var r=v.RR("/user/$userId/account_data/$type",{$userId:this.credentials.userId,$type:e});return this.http.authedRequest(S.IT.Put,r,void 0,t)}getAccountData(e){return this.store.getAccountData(e)}getAccountDataFromServer(e){var t=this;return(0,i.A)(function*(){if(t.isInitialSyncComplete()){var r,n=t.store.getAccountData(e);return n?n.getContent():null}var i=v.RR("/user/$userId/account_data/$type",{$userId:t.credentials.userId,$type:e});try{return yield t.http.authedRequest(S.IT.Get,i)}catch(e){if((null==(r=e.data)?void 0:r.errcode)==="M_NOT_FOUND")return null;throw e}})()}deleteAccountData(e){var t=this;return(0,i.A)(function*(){var r=t.canSupport.get(W.Xj.AccountDataDeletion);if(r===W.Tj.Unsupported)return void(yield t.setAccountData(e,{}));var n=v.RR("/user/$userId/account_data/$type",{$userId:t.getSafeUserId(),$type:e}),i=r===W.Tj.Unstable?{prefix:"/_matrix/client/unstable/org.matrix.msc3391"}:void 0;return yield t.http.authedRequest(S.IT.Delete,n,void 0,void 0,i)})()}getIgnoredUsers(){var e=this.getAccountData(w.Bx.IgnoredUserList);return null!=e&&e.getContent().ignored_users?Object.keys(e.getContent().ignored_users):[]}setIgnoredUsers(e){var t={ignored_users:{}};return e.forEach(e=>{t.ignored_users[e]={}}),this.setAccountData(w.Bx.IgnoredUserList,t)}isUserIgnored(e){return this.getIgnoredUsers().includes(e)}joinRoom(e){var t=arguments,r=this;return(0,i.A)(function*(){var n,i,s=t.length>1&&void 0!==t[1]?t[1]:{},a=r.getRoom(e),d=null==a?void 0:a.getMember(r.getSafeUserId()),l=null==d?void 0:d.membership,u=l==Y.O.Invite&&null!=(n=null==d||null==(i=d.events.member)?void 0:i.getSender())?n:null;if(r.logger.debug("joinRoom[".concat(e,"]: preJoinMembership=").concat(l,", inviter=").concat(u,", opts=").concat(JSON.stringify(s))),l==Y.O.Join)return a;var h=Promise.resolve();if(s.inviteSignUrl){var c=new URL(s.inviteSignUrl);c.searchParams.set("mxid",r.credentials.userId),h=r.http.requestOtherUrl(S.IT.Post,c)}var p={};s.viaServers&&(p.via=p.server_name=s.viaServers.slice(0,3));var m={},g=yield h;g&&(m.third_party_signed=g);var y=v.RR("/join/$roomid",{$roomid:e}),R=(yield r.http.authedRequest(S.IT.Post,y,p,m)).room_id;s.acceptSharedHistory&&u&&r.cryptoBackend&&((yield r.cryptoBackend.maybeAcceptKeyBundle(R,u))||r.cryptoBackend.markRoomAsPendingKeyBundle(R,u));var f=r.getRoom(R);return null!=f&&f.hasMembershipState(r.credentials.userId,Y.O.Join)?f:new o.w_(r,r.clientOpts,r.buildSyncApiOptions()).createRoom(R)})()}knockRoom(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=this.getRoom(e);if(null!=r&&r.hasMembershipState(this.credentials.userId,Y.O.Knock))return Promise.resolve({room_id:r.roomId});var n=v.RR("/knock/$roomIdOrAlias",{$roomIdOrAlias:e}),i={};if(t.viaServers){var s=Array.isArray(t.viaServers)?t.viaServers.slice(0,3):[t.viaServers];i.server_name=s,i.via=s}var o={};return t.reason&&(o.reason=t.reason),this.http.authedRequest(S.IT.Post,n,i,o)}resendEvent(e,t){return this.toDeviceMessageQueue.sendQueue(),this.updatePendingEventStatus(t,e,a.fb.SENDING),this.encryptAndSendEvent(t,e)}cancelPendingEvent(e){if(![a.fb.QUEUED,a.fb.NOT_SENT,a.fb.ENCRYPTING].includes(e.status))throw Error("cannot cancel an event with status "+e.status);e.status===a.fb.ENCRYPTING?this.eventsBeingEncrypted.delete(e.getId()):this.scheduler&&e.status===a.fb.QUEUED&&this.scheduler.removeEventFromQueue(e);var t=this.getRoom(e.getRoomId());this.updatePendingEventStatus(t,e,a.fb.CANCELLED)}setRoomName(e,t){return this.sendStateEvent(e,w.Bx.RoomName,{name:t})}setRoomTopic(e,t,r){var n=k.makeTopicContent(t,r);return this.sendStateEvent(e,w.Bx.RoomTopic,n)}getRoomTags(e){var t=v.RR("/user/$userId/rooms/$roomId/tags",{$userId:this.credentials.userId,$roomId:e});return this.http.authedRequest(S.IT.Get,t)}setRoomTag(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=v.RR("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:e,$tag:t});return this.http.authedRequest(S.IT.Put,n,void 0,r)}deleteRoomTag(e,t){var r=v.RR("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:e,$tag:t});return this.http.authedRequest(S.IT.Delete,r)}setRoomAccountData(e,t,r){var n=v.RR("/user/$userId/rooms/$roomId/account_data/$type",{$userId:this.credentials.userId,$roomId:e,$type:t});return this.http.authedRequest(S.IT.Put,n,void 0,r)}setPowerLevel(e,t,r){var n=this;return(0,i.A)(function*(){var i,s,o;if(n.clientRunning&&n.isInitialSyncComplete()&&(s=null==(o=n.getRoom(e))||null==(o=o.currentState)||null==(o=o.getStateEvents(w.Bx.RoomPowerLevels,""))?void 0:o.getContent()),!s)try{s=yield n.getStateEvent(e,w.Bx.RoomPowerLevels,"")}catch(e){if(e instanceof S.up&&"M_NOT_FOUND"===e.errcode)s={};else throw e}for(var a of(null!=(i=s=v.A4(s))&&i.users||(s.users={}),Array.isArray(t)?t:[t]))null==r?delete s.users[a]:s.users[a]=r;return n.sendStateEvent(e,w.Bx.RoomPowerLevels,s,"")})()}unstable_createLiveBeacon(e,t){var r=this;return(0,i.A)(function*(){return r.unstable_setLiveBeacon(e,t)})()}unstable_setLiveBeacon(e,t){var r=this;return(0,i.A)(function*(){return r.sendStateEvent(e,G.E.name,t,r.getUserId())})()}sendEvent(e,t,r,n,i){var s,o,a,d;return null!=t&&t.startsWith("$")||null===t?(d=i,a=n,o=r,s=t):(d=n,a=r,o=t,s=null),this.addThreadRelationIfNeeded(a,s,e),this.sendCompleteEvent({roomId:e,threadId:s,eventObject:{type:o,content:a},txnId:d})}addThreadRelationIfNeeded(e,t,r){var n;if(t&&!(null!=(n=e["m.relates_to"])&&n.rel_type)){var i,s,o,a,d=!!(null!=(i=e["m.relates_to"])&&i["m.in_reply_to"]);e["m.relates_to"]=es(es({},e["m.relates_to"]),{},{rel_type:L.RN.name,event_id:t,is_falling_back:!d});var l=null==(s=this.getRoom(r))?void 0:s.getThread(t);l&&!d&&(e["m.relates_to"]["m.in_reply_to"]={event_id:null!=(o=null==(a=l.lastReply(e=>e.isRelation(L.RN.name)&&!e.status))?void 0:a.getId())?o:t})}}sendCompleteEvent(e){var{roomId:t,threadId:r,eventObject:n,delayOpts:i,queryDict:s,txnId:o}=e;o||(o=this.makeTxnId());var d=new a.kl(Object.assign(n,{event_id:"~"+t+":"+o,user_id:this.credentials.userId,sender:this.credentials.userId,room_id:t,origin_server_ts:new Date().getTime()})),l=this.getRoom(t),u=r?null==l?void 0:l.getThread(r):void 0;u&&d.setThread(u),i||(this.reEmitter.reEmit(d,[a.OQ.Replaced,a.OQ.VisibilityChange]),null==l||l.reEmitter.reEmit(d,[a.OQ.BeforeRedaction]));var h=d.getAssociatedId();if(null!=h&&h.startsWith("~")){var c=null==l?void 0:l.getPendingEvents().find(e=>e.getId()===h);null==c||c.once(a.OQ.LocalEventIdReplaced,()=>{d.updateAssociatedId(c.getId())})}var v=d.getType();return(this.logger.debug("sendEvent of type ".concat(v," in ").concat(t," with txnId ").concat(o).concat(i?" (delayed event)":"").concat(s?" query params: "+JSON.stringify(s):"")),d.setTxnId(o),d.setStatus(a.fb.SENDING),i)?this.encryptAndSendEvent(l,d,i,s):(null==l||l.addPendingEvent(d,o),d.status===a.fb.NOT_SENT)?Promise.reject(Error("Event blocked by other events not yet sent")):this.encryptAndSendEvent(l,d,s)}encryptAndSendEvent(e,t,r,n){var s=this;return(0,i.A)(function*(){var i=n;if(r&&(0,A.U)(r))return s.sendEventHttpRequest(t,r,i);i||(i=r);try{s.eventsBeingEncrypted.add(t.getId());try{yield s.encryptEventIfNeeded(t,null!=e?e:void 0)}finally{o=!s.eventsBeingEncrypted.delete(t.getId())}if(o)return{};t.status===a.fb.ENCRYPTING&&s.updatePendingEventStatus(e,t,a.fb.SENDING);var o,d=null;return s.scheduler&&(d=s.scheduler.queueEvent(t))&&s.scheduler.getQueueForEvent(t).length>1&&s.updatePendingEventStatus(e,t,a.fb.QUEUED),!d&&(d=s.sendEventHttpRequest(t,i),e&&(d=d.then(r=>(e.updatePendingEvent(t,a.fb.SENT,r.event_id),r)))),yield d}catch(r){s.logger.error("Error sending event",r);try{t.error=r,s.updatePendingEventStatus(e,t,a.fb.NOT_SENT)}catch(e){s.logger.error("Exception in error handler!",e)}throw r instanceof S.up&&(r.event=t),r}})()}encryptEventIfNeeded(e,t){var r=this;return(0,i.A)(function*(){if(t&&(yield r.shouldEncryptEventForRoom(e,t))&&(r.cryptoBackend||!r.usingExternalCrypto)){if(!r.cryptoBackend)throw Error("This room is configured to use encryption, but your client does not support encryption.");r.updatePendingEventStatus(t,e,a.fb.ENCRYPTING),yield r.cryptoBackend.encryptEvent(e,t)}})()}shouldEncryptEventForRoom(e,t){var r=this;return(0,i.A)(function*(){var n;return!(e.isEncrypted()||e.getType()===w.Bx.Reaction||e.isRedaction())&&!!(t.hasEncryptionStateEvent()||(yield null==(n=r.cryptoBackend)?void 0:n.isEncryptionEnabledInRoom(t.roomId)))})()}getEncryptedIfNeededEventType(e,t){var r;return t===w.Bx.Reaction?t:null!=(r=this.getRoom(e))&&r.hasEncryptionStateEvent()?w.Bx.RoomMessageEncrypted:t}updatePendingEventStatus(e,t,r){e?e.updatePendingEvent(t,r):t.setStatus(r)}sendEventHttpRequest(e,t,r){var n,i=e.getTxnId();i||(i=this.makeTxnId(),e.setTxnId(i));var s={$roomId:e.getRoomId(),$eventType:e.getWireType(),$stateKey:e.getStateKey(),$txnId:i};if(e.isState()){var o="/rooms/$roomId/state/$eventType";e.getStateKey()&&e.getStateKey().length>0&&(o="/rooms/$roomId/state/$eventType/$stateKey"),n=v.RR(o,s)}else n=e.isRedaction()&&e.event.redacts?v.RR("/rooms/$roomId/redact/$redactsEventId/$txnId",es({$redactsEventId:e.event.redacts},s)):v.RR("/rooms/$roomId/send/$eventType/$txnId",s);var a=t&&(0,A.U)(t)?t:void 0,d=a?r:t,l=e.getWireContent();return a?this.http.authedRequest(S.IT.Put,n,es(es({},eI(a)),d),l):this.http.authedRequest(S.IT.Put,n,d,l).then(t=>(this.logger.debug("Event sent to ".concat(e.getRoomId()," with event id ").concat(t.event_id)),t))}redactEvent(e,t,r,n,i){null!=(s=r)&&s.startsWith("$")||(i=n,n=r,r=t,t=null);var s,o,a,d={reason:null==(o=i)?void 0:o.reason};if((null==(a=i)?void 0:a.with_rel_types)!==void 0){if(this.canSupport.get(W.Xj.RelationBasedRedactions)===W.Tj.Unsupported)throw Error("Server does not support relation based redactions "+"roomId ".concat(e," eventId ").concat(r," txnId: ").concat(n," threadId ").concat(t));d[this.canSupport.get(W.Xj.RelationBasedRedactions)===W.Tj.Stable?w.Z3.stable:w.Z3.unstable]=i.with_rel_types}return this.sendCompleteEvent({roomId:e,threadId:t,eventObject:{type:w.Bx.RoomRedaction,content:d,redacts:r},txnId:n})}sendMessage(e,t,r,n){"string"!=typeof t&&null!==t&&(n=r,r=t,t=null);var i=w.Bx.RoomMessage,s=r;return this.sendEvent(e,t,i,s,n)}sendTextMessage(e,t,r,n){null!=(i=t)&&i.startsWith("$")||null===t||(n=r,r=t,t=null);var i,s=k.makeTextMessage(r);return this.sendMessage(e,t,s,n)}sendNotice(e,t,r,n){null!=(i=t)&&i.startsWith("$")||null===t||(n=r,r=t,t=null);var i,s=k.makeNotice(r);return this.sendMessage(e,t,s,n)}sendEmoteMessage(e,t,r,n){null!=(i=t)&&i.startsWith("$")||null===t||(n=r,r=t,t=null);var i,s=k.makeEmoteMessage(r);return this.sendMessage(e,t,s,n)}sendImageMessage(e,t,r,n){var i,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"Image";null!=(i=t)&&i.startsWith("$")||null===t||(s=n||"Image",n=r,r=t,t=null);var o={msgtype:w.Wr.Image,url:r,info:n,body:s};return this.sendMessage(e,t,o)}sendStickerMessage(e,t,r,n){var i,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"Sticker";null!=(i=t)&&i.startsWith("$")||null===t||(s=n||"Sticker",n=r,r=t,t=null);var o={url:r,info:n,body:s};return this.sendEvent(e,t,w.Bx.Sticker,o)}sendHtmlMessage(e,t,r,n){null!=(i=t)&&i.startsWith("$")||null===t||(n=r,r=t,t=null);var i,s=k.makeHtmlMessage(r,n);return this.sendMessage(e,t,s)}sendHtmlNotice(e,t,r,n){null!=(i=t)&&i.startsWith("$")||null===t||(n=r,r=t,t=null);var i,s=k.makeHtmlNotice(r,n);return this.sendMessage(e,t,s)}sendHtmlEmote(e,t,r,n){null!=(i=t)&&i.startsWith("$")||null===t||(n=r,r=t,t=null);var i,s=k.makeHtmlEmote(r,n);return this.sendMessage(e,t,s)}_unstable_sendDelayedEvent(e,t,r,n,s,o){var a=this;return(0,i.A)(function*(){if(!(yield a.doesServerSupportUnstableFeature(ec)))throw new er.qK("Server does not support the delayed events API","sendDelayedEvent");return a.addThreadRelationIfNeeded(s,r,e),a.sendCompleteEvent({roomId:e,threadId:r,eventObject:{type:n,content:s},delayOpts:t,txnId:o})})()}_unstable_sendStickyDelayedEvent(e,t,r,n,s,o,a){var d=this;return(0,i.A)(function*(){if(!(yield d.doesServerSupportUnstableFeature(ec)))throw new er.qK("Server does not support the delayed events API","getDelayedEvents");if(!(yield d.doesServerSupportUnstableFeature(ev)))throw new er.xp("Server does not support the sticky events","sendStickyEvent");return d.addThreadRelationIfNeeded(o,n,e),d.sendCompleteEvent({roomId:e,threadId:n,eventObject:{type:s,content:o},queryDict:{"org.matrix.msc4354.sticky_duration_ms":t},delayOpts:r,txnId:a})})()}_unstable_sendDelayedStateEvent(e,t,r,n){var s=arguments,o=this;return(0,i.A)(function*(){var i=s.length>4&&void 0!==s[4]?s[4]:"",a=s.length>5&&void 0!==s[5]?s[5]:{};if(!(yield o.doesServerSupportUnstableFeature(ec)))throw new er.qK("Server does not support the delayed events API","sendDelayedStateEvent");var d={$roomId:e,$eventType:r,$stateKey:i},l=v.RR("/rooms/$roomId/state/$eventType",d);return void 0!==i&&(l=v.RR(l+"/$stateKey",d)),o.http.authedRequest(S.IT.Put,l,eI(t),n,a)})()}_unstable_sendStickyEvent(e,t,r,n,s,o){var a=this;return(0,i.A)(function*(){if(!(yield a.doesServerSupportUnstableFeature(ev)))throw new er.xp("Server does not support the sticky events","sendStickyEvent");return a.addThreadRelationIfNeeded(s,r,e),a.sendCompleteEvent({roomId:e,threadId:r,eventObject:{type:n,content:s},queryDict:{"org.matrix.msc4354.sticky_duration_ms":t},txnId:o})})()}_unstable_getDelayedEvents(e,t,r){var n=this;return(0,i.A)(function*(){if(!(yield n.doesServerSupportUnstableFeature(ec)))throw new er.qK("Server does not support the delayed events API","getDelayedEvents");return yield n.http.authedRequest(S.IT.Get,"/delayed_events",{from:r,status:e,delay_id:t},void 0,{prefix:"".concat(S.iD.Unstable,"/").concat(ec)})})()}_unstable_updateDelayedEvent(e,t){var r=arguments,n=this;return(0,i.A)(function*(){var i=r.length>2&&void 0!==r[2]?r[2]:{};if(!(yield n.doesServerSupportUnstableFeature(ec)))throw new er.qK("Server does not support the delayed events API","updateDelayedEvent");return yield n.updateScheduledDelayedEventWithActionInBody(e,t,i)})()}_unstable_cancelScheduledDelayedEvent(e){var t=arguments,r=this;return(0,i.A)(function*(){var n=t.length>1&&void 0!==t[1]?t[1]:{};return yield r.updateScheduledDelayedEvent(e,A.e.Cancel,n)})()}_unstable_restartScheduledDelayedEvent(e){var t=arguments,r=this;return(0,i.A)(function*(){var n=t.length>1&&void 0!==t[1]?t[1]:{};return yield r.updateScheduledDelayedEvent(e,A.e.Restart,n)})()}_unstable_sendScheduledDelayedEvent(e){var t=arguments,r=this;return(0,i.A)(function*(){var n=t.length>1&&void 0!==t[1]?t[1]:{};return yield r.updateScheduledDelayedEvent(e,A.e.Send,n)})()}updateScheduledDelayedEvent(e,t){var r=arguments,n=this;return(0,i.A)(function*(){var i=r.length>2&&void 0!==r[2]?r[2]:{};if(!(yield n.doesServerSupportUnstableFeature(ec)))throw new er.qK("Server does not support the delayed events API","".concat(t,"ScheduledDelayedEvent"));try{var s=v.RR("/delayed_events/$delayId/$action",{$delayId:e,$action:t});return yield n.http.request(S.IT.Post,s,void 0,void 0,es(es({},i),{},{prefix:"".concat(S.iD.Unstable,"/").concat(ec)}))}catch(r){if(r instanceof S.up&&"M_UNRECOGNIZED"===r.errcode)return yield n.updateScheduledDelayedEventWithActionInBody(e,t,i);throw r}})()}updateScheduledDelayedEventWithActionInBody(e,t){var r=arguments,n=this;return(0,i.A)(function*(){var i=r.length>2&&void 0!==r[2]?r[2]:{},s=v.RR("/delayed_events/$delayId",{$delayId:e}),o={action:t};try{return yield n.http.request(S.IT.Post,s,void 0,o,es(es({},i),{},{prefix:"".concat(S.iD.Unstable,"/").concat(ec)}))}catch(e){if(e instanceof S.up&&"M_MISSING_TOKEN"===e.errcode)return yield n.http.authedRequest(S.IT.Post,s,void 0,o,es(es({},i),{},{prefix:"".concat(S.iD.Unstable,"/").concat(ec)}));throw e}})()}sendReceipt(e,t,r){var n=arguments,s=this;return(0,i.A)(function*(){var i=n.length>3&&void 0!==n[3]&&n[3];if(s.isGuest())return Promise.resolve({});var o=v.RR("/rooms/$roomId/receipt/$receiptType/$eventId",{$roomId:e.getRoomId(),$receiptType:t,$eventId:e.getId()}),a=!i&&s.supportsThreads()?es(es({},r),{},{thread_id:eT(e)}):r,d=s.http.authedRequest(S.IT.Post,o,void 0,a||{}),l=s.getRoom(e.getRoomId());return l&&s.credentials.userId&&l.addLocalEchoReceipt(s.credentials.userId,e,t,i),d})()}sendReadReceipt(e){var t=arguments,r=this;return(0,i.A)(function*(){var n=t.length>1&&void 0!==t[1]?t[1]:M.L.Read,i=t.length>2&&void 0!==t[2]&&t[2];if(e){var s=e.getId(),o=r.getRoom(e.getRoomId());if(null!=o&&o.hasPendingEvent(s))throw Error("Cannot set read receipt to a pending event (".concat(s,")"));return r.sendReceipt(e,n,{},i)}})()}setRoomReadMarkers(e,t,r,n){var s=this;return(0,i.A)(function*(){var i,o,a=s.getRoom(e);if(null!=a&&a.hasPendingEvent(t))throw Error("Cannot set read marker to a pending event (".concat(t,")"));if(r){if(i=r.getId(),null!=a&&a.hasPendingEvent(i))throw Error("Cannot set read receipt to a pending event (".concat(i,")"));null==a||a.addLocalEchoReceipt(s.credentials.userId,r,M.L.Read)}if(n){if(o=n.getId(),null!=a&&a.hasPendingEvent(o))throw Error("Cannot set read receipt to a pending event (".concat(o,")"));null==a||a.addLocalEchoReceipt(s.credentials.userId,n,M.L.ReadPrivate)}return yield s.setRoomReadMarkersHttpRequest(e,t,i,o)})()}sendRtcDecline(e,t){return this.sendEvent(e,w.Bx.RTCDecline,{"m.relates_to":{event_id:t,rel_type:w.zZ.Reference}})}getUrlPreview(e,t){t=6e4*Math.floor(t/6e4);var r=new URL(e);r.hash="",e=r.toString();var n=t+"_"+e;if(n in this.urlPreviewCache)return this.urlPreviewCache[n];var i=this.http.authedRequest(S.IT.Get,"/preview_url",{url:e,ts:t.toString()},void 0,{prefix:S.zs.V3,priority:"low"});return this.urlPreviewCache[n]=i,i}sendTyping(e,t,r){if(this.isGuest())return Promise.resolve({});var n=v.RR("/rooms/$roomId/typing/$userId",{$roomId:e,$userId:this.getUserId()}),i={typing:t};return t&&(i.timeout=r||2e4),this.http.authedRequest(S.IT.Put,n,void 0,i)}getRoomUpgradeHistory(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=this.getRoom(e);if(!n)return[];var i=this.findPredecessorRooms(n,t,r),s=this.findSuccessorRooms(n,t,r);return[...i,n,...s]}findPredecessorRooms(e,t,r){for(var n=[],i=new Set([e.roomId]),s=null==(o=e.findPredecessor(r))?void 0:o.roomId;null!==s;){if(s){if(i.has(s))break;i.add(s)}var o,a,d=this.getRoom(s);if(null===d)break;if(t){var l=d.currentState.getStateEvents(w.Bx.RoomTombstone,"");if(!l||l.getContent().replacement_room!==e.roomId)break}n.splice(0,0,d),s=null==(a=(e=d).findPredecessor(r))?void 0:a.roomId}return n}findSuccessorRooms(e,t,r){for(var n=[],i=e.currentState.getStateEvents(w.Bx.RoomTombstone,"");i;){var s=this.getRoom(i.getContent().replacement_room);if(!s||s.roomId===e.roomId)break;if(t){var o,a=null==(o=s.findPredecessor(r))?void 0:o.roomId;if(!a||a!==e.roomId)break}if(n.push(s),new Set(n.map(e=>e.roomId)).size<n.length)return n.slice(0,n.length-1);i=(e=s).currentState.getStateEvents(w.Bx.RoomTombstone,"")}return n}invite(e,t){var r=arguments,n=this;return(0,i.A)(function*(){var i,s=r.length>2&&void 0!==r[2]?r[2]:{};return"object"!=typeof s&&(s={reason:s}),s.shareEncryptedHistory&&(yield null==(i=n.cryptoBackend)?void 0:i.shareRoomHistoryWithUser(e,t)),yield n.membershipChange(e,t,Y.O.Invite,s.reason)})()}inviteByEmail(e,t){return this.inviteByThreePid(e,"email",t)}inviteByThreePid(e,t,r){var n=this;return(0,i.A)(function*(){var i,s=v.RR("/rooms/$roomId/invite",{$roomId:e}),o=n.getIdentityServerUrl(!0);if(!o)return Promise.reject(new S.up({error:"No supplied identity server URL",errcode:"ORG.MATRIX.JSSDK_MISSING_PARAM"}));var a={id_server:o,medium:t,address:r};if(null!=(i=n.identityServer)&&i.getAccessToken){var d=yield n.identityServer.getAccessToken();d&&(a.id_access_token=d)}return n.http.authedRequest(S.IT.Post,s,void 0,a)})()}leave(e){return this.membershipChange(e,void 0,Y.O.Leave)}leaveRoomChain(e){var t=!(arguments.length>1)||void 0===arguments[1]||arguments[1],r=this.getRoomUpgradeHistory(e,!0),n=r;if(!t){for(var i of(n=[],r))if(n.push(i),i.roomId===e)break}var s={},o=[],a=e=>this.leave(e).then(()=>{delete s[e]}).catch(t=>{s[e]=t});for(var d of n)o.push(a(d.roomId));return Promise.all(o).then(()=>s)}ban(e,t,r){return this.membershipChange(e,t,Y.O.Ban,r)}forget(e){var t=arguments,r=this;return(0,i.A)(function*(){var n=!(t.length>1)||void 0===t[1]||t[1],i=v.RR("/rooms/$room_id/forget",{$room_id:e}),s=yield r.http.authedRequest(S.IT.Post,i);return n&&(r.store.removeRoom(e),r.emit(ey.DeleteRoom,e)),s})()}unban(e,t){var r=v.RR("/rooms/$roomId/unban",{$roomId:e});return this.http.authedRequest(S.IT.Post,r,void 0,{user_id:t})}kick(e,t,r){var n=v.RR("/rooms/$roomId/kick",{$roomId:e});return this.http.authedRequest(S.IT.Post,n,void 0,{user_id:t,reason:r})}membershipChange(e,t,r,n){var i=v.RR("/rooms/$room_id/$membership",{$room_id:e,$membership:r});return this.http.authedRequest(S.IT.Post,i,void 0,{user_id:t,reason:n})}getPushActionsForEvent(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!e.getPushActions()||t){var{actions:r,rule:n}=this.pushProcessor.actionsAndRuleForEvent(e);e.setPushDetails(r,n)}return e.getPushActions()}getPushDetailsForEvent(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!e.getPushDetails()||t){var{actions:r,rule:n}=this.pushProcessor.actionsAndRuleForEvent(e);e.setPushDetails(r,n)}return e.getPushDetails()}setProfileInfo(e,t){var r=v.RR("/profile/$userId/$info",{$userId:this.credentials.userId,$info:e});return this.http.authedRequest(S.IT.Put,r,void 0,t)}setDisplayName(e){var t=this;return(0,i.A)(function*(){var r=yield t.setProfileInfo("displayname",{displayname:e}),n=t.getUser(t.getUserId());return n&&(n.displayName=e,n.emit(T.U.DisplayName,n.events.presence,n)),r})()}setAvatarUrl(e){var t=this;return(0,i.A)(function*(){var r=yield t.setProfileInfo("avatar_url",{avatar_url:e}),n=t.getUser(t.getUserId());return n&&(n.avatarUrl=e,n.emit(T.U.AvatarUrl,n.events.presence,n)),r})()}mxcUrlToHttp(e,t,r,n,i,s,o){return(0,E.y)(this.baseUrl,e,t,r,n,i,s,o)}setSyncPresence(e){var t=this;return(0,i.A)(function*(){var r;null==(r=t.syncApi)||r.setPresence(e)})()}setPresence(e){var t=this;return(0,i.A)(function*(){var r=v.RR("/presence/$userId/status",{$userId:t.credentials.userId});if(-1===["offline","online","unavailable"].indexOf(e.presence))throw Error("Bad presence value: "+e.presence);yield t.http.authedRequest(S.IT.Put,r,void 0,e)})()}getPresence(e){var t=v.RR("/presence/$userId/status",{$userId:e});return this.http.authedRequest(S.IT.Get,t)}scrollback(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:30,r=0,n=this.ongoingScrollbacks[e.roomId]||{};if(n.promise)return n.promise;if(n.errorTs&&(r=Math.max(3e3-(Date.now()-n.errorTs),0)),null===e.oldState.paginationToken)return Promise.resolve(e);var i=this.store.scrollback(e,t).length;if(i===t)return Promise.resolve(e);t-=i;var s=new Promise((n,i)=>{(0,v.yy)(r).then(()=>this.createMessagesRequest(e.roomId,e.oldState.paginationToken,t,p.O.Backward)).then(t=>{var r,i,s=t.chunk.map(this.getEventMapper());if(t.state){var o=t.state.map(this.getEventMapper());e.currentState.setUnknownStateEvents(o)}var[a,d,l]=e.partitionThreadedEvents(s);this.processAggregatedTimelineEvents(e,a),e.addEventsToTimeline(a,!0,!0,e.getLiveTimeline()),this.processThreadEvents(e,d,!0),l.forEach(t=>e.relations.aggregateChildEvent(t)),e.oldState.paginationToken=null!=(r=t.end)?r:null,0===t.chunk.length&&(e.oldState.paginationToken=null),this.store.storeEvents(e,s,null!=(i=t.end)?i:null,!0),delete this.ongoingScrollbacks[e.roomId],n(e)}).catch(t=>{this.ongoingScrollbacks[e.roomId]={errorTs:Date.now()},i(t)})});return n={promise:s},this.ongoingScrollbacks[e.roomId]=n,s}getEventMapper(e){return(0,x.t)(this,e||{})}getEventContext(e,t){var r=this;return(0,i.A)(function*(){var n,i,s,o,a=v.RR("/rooms/$roomId/context/$eventId",{$roomId:e,$eventId:t}),d={limit:"0"};null!=(n=r.clientOpts)&&n.lazyLoadMembers&&(d.filter=JSON.stringify(u.d.LAZY_LOADING_MESSAGES_FILTER));var l=yield r.http.authedRequest(S.IT.Get,a,d);if(l.event)return{start:l.start,end:l.end,event:l.event,events_after:null!=(i=l.events_after)?i:[],events_before:null!=(s=l.events_before)?s:[],state:null!=(o=l.state)?o:[]};throw Error("'event' not in '/context' result - homeserver too old?")})()}getEventTimeline(e,t){var r=this;return(0,i.A)(function*(){if(!r.timelineSupport)throw Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");if(!(null!=e&&e.room))throw Error("getEventTimeline only supports room timelines");if(e.getTimelineForEvent(t))return e.getTimelineForEvent(t);if(e.thread&&r.supportsThreads())return null!=(o=yield r.getThreadTimeline(e,t))?o:null;var n,i,s,o,a,d=yield r.getEventContext(e.room.roomId,t);if(e.getTimelineForEvent(t))return e.getTimelineForEvent(t);var l=r.getEventMapper(),u=l(d.event);if(u.isRelation(L.RN.name))return r.logger.warn("Tried loading a regular timeline at the position of a thread event"),null;var h=[...d.events_after.reverse().map(l),u,...d.events_before.map(l)],c=e.getTimelineForEvent(h[0].getId());c?c.getState(p.q.BACKWARDS).setUnknownStateEvents(d.state.map(l)):((c=e.addTimeline()).initialiseState(d.state.map(l)),c.getState(p.q.FORWARDS).paginationToken=null!=(a=d.end)?a:null);var[v,m,g]=e.room.partitionThreadedEvents(h);return e.addEventsToTimeline(v,!0,!1,c,d.start),r.processThreadEvents(e.room,m,!0),r.processAggregatedTimelineEvents(e.room,v),g.forEach(t=>e.relations.aggregateChildEvent(t)),null!=(n=null!=(i=e.getTimelineForEvent(t))?i:null==(s=e.room.findThreadForEvent(u))?void 0:s.liveTimeline)?n:c})()}getThreadTimeline(e,t){var r=this;return(0,i.A)(function*(){if(!r.supportsThreads())throw Error("could not get thread timeline: no client support");if(!e.room)throw Error("could not get thread timeline: not a room timeline");if(!e.thread)throw Error("could not get thread timeline: not a thread timeline");var n=yield r.getEventContext(e.room.roomId,t),i=r.getEventMapper(),s=i(n.event);if(e.canContain(s)){var o=r.canSupport.get(W.Xj.RelationsRecursion)!==W.Tj.Unsupported;if(L.jV.hasServerSideSupport)if(L.jV.hasServerSideFwdPaginationSupport){if(!e.thread)throw Error("could not get thread timeline: not a thread timeline");var a,d,l,u,h=e.thread,c=yield r.fetchRelations(e.room.roomId,h.id,null,null,{dir:p.O.Backward,from:n.start,recurse:o||void 0}),v=yield r.fetchRelations(e.room.roomId,h.id,null,null,{dir:p.O.Forward,from:n.end,recurse:o||void 0}),m=[...v.chunk.reverse().filter((0,z.q)(h.id)).map(i),s,...c.chunk.filter((0,z.q)(h.id)).map(i)];for(var g of m)yield null==(u=e.thread)?void 0:u.processEvent(g);var y=e.getTimelineForEvent(s.getId());if(y?y.getState(p.q.BACKWARDS).setUnknownStateEvents(n.state.map(i)):(y=e.addTimeline()).initialiseState(n.state.map(i)),e.addEventsToTimeline(m,!0,!1,y,v.next_batch),!c.next_batch){var R=yield r.fetchRoomEvent(e.room.roomId,h.id);e.addEventsToTimeline([i(R)],!0,!1,y,null)}return y.setPaginationToken(null!=(a=c.next_batch)?a:null,p.O.Backward),y.setPaginationToken(null!=(d=v.next_batch)?d:null,p.O.Forward),r.processAggregatedTimelineEvents(e.room,m),null!=(l=e.getTimelineForEvent(t))?l:y}else{for(var f,I,S=e.thread,T=yield r.fetchRelations(e.room.roomId,S.id,L.RN.name,null,{dir:p.O.Backward,from:n.start,recurse:o||void 0}),E=[],b=n.end;b;){var k=yield r.fetchRelations(e.room.roomId,S.id,L.RN.name,null,{dir:p.O.Forward,from:b,recurse:o||void 0});b=k.next_batch,E.push(...k.chunk)}var _=[...E.reverse().map(i),s,...T.chunk.map(i)];for(var P of _)yield null==(I=e.thread)?void 0:I.processEvent(P);var A=e.getLiveTimeline();if(A.getState(p.q.BACKWARDS).setUnknownStateEvents(n.state.map(i)),e.addEventsToTimeline(_,!0,!1,A,null),!T.next_batch){var w=yield r.fetchRoomEvent(e.room.roomId,S.id);e.addEventsToTimeline([i(w)],!0,!1,A,null)}return A.setPaginationToken(null!=(f=T.next_batch)?f:null,p.O.Backward),A.setPaginationToken(null,p.O.Forward),r.processAggregatedTimelineEvents(e.room,_),A}}})()}getLatestTimeline(e){var t=this;return(0,i.A)(function*(){if(!t.timelineSupport)throw Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");if(!e.room)throw Error("getLatestTimeline only supports room timelines");if(null!==e.threadListType){var r,n;r=null==(n=(yield t.createThreadListMessagesRequest(e.room.roomId,null,1,p.O.Backward,e.threadListType,e.getFilter())).chunk)?void 0:n[0]}else if(e.thread&&L.jV.hasServerSideSupport){var i,s=t.canSupport.get(W.Xj.RelationsRecursion)!==W.Tj.Unsupported;r=null==(i=(yield t.fetchRelations(e.room.roomId,e.thread.id,L.RN.name,null,{dir:p.O.Backward,limit:1,recurse:s||void 0})).chunk)?void 0:i[0]}else{var o,a,d=v.RR("/rooms/$roomId/messages",{$roomId:e.room.roomId}),l={dir:"b"};null!=(o=t.clientOpts)&&o.lazyLoadMembers&&(l.filter=JSON.stringify(u.d.LAZY_LOADING_MESSAGES_FILTER)),r=null==(a=(yield t.http.authedRequest(S.IT.Get,d,l)).chunk)?void 0:a[0]}if(!r)throw Error("No message returned when trying to construct getLatestTimeline");return t.getEventTimeline(e,r.event_id)})()}createMessagesRequest(e,t){var r,n,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:30,s=arguments.length>3?arguments[3]:void 0,o=arguments.length>4?arguments[4]:void 0,a=v.RR("/rooms/$roomId/messages",{$roomId:e}),d={limit:i.toString(),dir:s};t&&(d.from=t);var l=null;return null!=(r=this.clientOpts)&&r.lazyLoadMembers&&(l=Object.assign({},u.d.LAZY_LOADING_MESSAGES_FILTER)),o&&Object.assign(l=l||{},null==(n=o.getRoomTimelineFilterComponent())?void 0:n.toJSON()),l&&(d.filter=JSON.stringify(l)),this.http.authedRequest(S.IT.Get,a,d)}createThreadListMessagesRequest(e,t){var r,n,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:30,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:p.O.Backward,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:L.x3.All,a=arguments.length>5?arguments[5]:void 0,d=v.RR("/rooms/$roomId/threads",{$roomId:e}),l={limit:i.toString(),dir:s,include:(0,L.UR)(o)};t&&(l.from=t);var h={};null!=(r=this.clientOpts)&&r.lazyLoadMembers&&(h=es({},u.d.LAZY_LOADING_MESSAGES_FILTER)),a&&(h=es(es({},h),null==(n=a.getRoomTimelineFilterComponent())?void 0:n.toJSON())),Object.keys(h).length&&(l.filter=JSON.stringify(h));var c={prefix:L.jV.hasServerSideListSupport===L.c1.Stable?S.iD.V1:"/_matrix/client/unstable/org.matrix.msc3856"};return this.http.authedRequest(S.IT.Get,d,l,void 0,c).then(e=>{var t;return es(es({},e),{},{chunk:null==(t=e.chunk)?void 0:t.reverse(),start:e.prev_batch,end:e.next_batch})})}paginateEventTimeline(e,t){var r=this,n=e.getTimelineSet()===this.notifTimelineSet,s=this.getRoom(e.getRoomId()),o=e.getTimelineSet().threadListType,a=e.getTimelineSet().thread,d=(t=t||{}).backwards||!1;if(n&&!d)throw Error("paginateNotifTimeline can only paginate backwards");var l=d?p.q.BACKWARDS:p.q.FORWARDS,u=e.getPaginationToken(l),h=e.paginationRequests[l];if(h)return h;if(n)g={limit:(null!=(R=t.limit)?R:30).toString(),only:"highlight"},u&&"end"!==u&&(g.from=u),y=this.http.authedRequest(S.IT.Get,"/notifications",g).then((c=(0,i.A)(function*(t){var n=t.next_token,i=[];t.notifications=t.notifications.filter(v.O5);for(var s=0;s<t.notifications.length;s++){var o=t.notifications[s],a=r.getEventMapper()(o.event);r.getPushDetailsForEvent(a,!0),a.event.room_id=o.room_id,i[s]=a}var u=e.getTimelineSet();return u.addEventsToTimeline(i,d,!1,e,n),r.processAggregatedTimelineEvents(u.room,i),d&&!t.next_token&&e.setPaginationToken(null,l),!!t.next_token}),function(e){return c.apply(this,arguments)})).finally(()=>{e.paginationRequests[l]=null}),e.paginationRequests[l]=y;else if(null!==o){if(!s)throw Error("Unknown room "+e.getRoomId());if(!L.jV.hasServerSideFwdPaginationSupport&&l===p.O.Forward)throw Error("Cannot paginate threads forwards without server-side support for MSC 3715");y=this.createThreadListMessagesRequest(e.getRoomId(),u,t.limit,l,o,e.getFilter()).then(t=>{if(t.state){var r=e.getState(l),n=t.state.filter(v.O5).map(this.getEventMapper());r.setUnknownStateEvents(n)}var i=t.end,o=t.chunk.filter(v.O5).map(this.getEventMapper());return e.getTimelineSet().addEventsToTimeline(o,d,!1,e,i),this.processAggregatedTimelineEvents(s,o),this.processThreadRoots(s,o,d),d&&t.end==t.start&&e.setPaginationToken(null,l),t.end!==t.start}).finally(()=>{e.paginationRequests[l]=null}),e.paginationRequests[l]=y}else if(a){var c,m,g,y,R,f,I,T=this.getRoom(null!=(f=e.getRoomId())?f:void 0);if(!T)throw Error("Unknown room "+e.getRoomId());var E=this.canSupport.get(W.Xj.RelationsRecursion)!==W.Tj.Unsupported;y=this.fetchRelations(null!=(I=e.getRoomId())?I:"",a.id,null,null,{dir:l,limit:t.limit,from:null!=u?u:void 0,recurse:E||void 0}).then((m=(0,i.A)(function*(t){var n=r.getEventMapper(),i=t.chunk.filter(v.O5).filter((0,z.q)(a.id)).map(n);for(var s of i.slice().reverse()){yield null==a?void 0:a.processEvent(s);var o=s.getSender();d&&(null==a?void 0:a.getEventReadUpTo(o))!==null||T.addLocalEchoReceipt(o,s,M.L.Read)}var u=t.next_batch,h=e.getTimelineSet();if(h.addEventsToTimeline(i,d,!1,e,null!=u?u:null),!u&&d){var c,p,m=null!=(c=a.rootEvent)?c:n((yield r.fetchRoomEvent(null!=(p=e.getRoomId())?p:"",a.id)));h.addEventsToTimeline([m],!0,!1,e,null)}return r.processAggregatedTimelineEvents(h.room,i),d&&!u&&e.setPaginationToken(null,l),!!u}),function(e){return m.apply(this,arguments)})).finally(()=>{e.paginationRequests[l]=null}),e.paginationRequests[l]=y}else{if(!s)throw Error("Unknown room "+e.getRoomId());y=this.createMessagesRequest(e.getRoomId(),u,t.limit,l,e.getFilter()).then(t=>{if(t.state){var r=e.getState(l),n=t.state.filter(v.O5).map(this.getEventMapper());r.setUnknownStateEvents(n)}var i=t.end,o=t.chunk.filter(v.O5).map(this.getEventMapper()),a=e.getTimelineSet(),[u,,h]=s.partitionThreadedEvents(o);a.addEventsToTimeline(u,d,!1,e,i),this.processAggregatedTimelineEvents(s,u),this.processThreadRoots(s,u.filter(e=>e.getServerAggregatedRelation(L.RN.name)),!1),h.forEach(e=>s.relations.aggregateChildEvent(e));var c=void 0===t.end||t.end===t.start;return d&&c&&e.setPaginationToken(null,l),!c}).finally(()=>{e.paginationRequests[l]=null}),e.paginationRequests[l]=y}return y}resetNotifTimelineSet(){this.notifTimelineSet&&this.notifTimelineSet.resetLiveTimeline("end")}peekInRoom(e){var t,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:20;return null==(t=this.peekSync)||t.stopPeeking(),this.peekSync=new o.w_(this,this.clientOpts,this.buildSyncApiOptions()),this.peekSync.peek(e,r)}stopPeeking(){this.peekSync&&(this.peekSync.stopPeeking(),this.peekSync=null)}setGuestAccess(e,t){var r=this.sendStateEvent(e,w.Bx.RoomGuestAccess,{guest_access:t.allowJoin?$.rF.CanJoin:$.rF.Forbidden},""),n=Promise.resolve();return t.allowRead&&(n=this.sendStateEvent(e,w.Bx.RoomHistoryVisibility,{history_visibility:$.Jv.WorldReadable},"")),Promise.all([n,r]).then()}requestRegisterEmailToken(e,t,r,n){return this.requestTokenFromEndpoint("/register/email/requestToken",{email:e,client_secret:t,send_attempt:r,next_link:n})}requestRegisterMsisdnToken(e,t,r,n,i){return this.requestTokenFromEndpoint("/register/msisdn/requestToken",{country:e,phone_number:t,client_secret:r,send_attempt:n,next_link:i})}requestAdd3pidEmailToken(e,t,r,n){return this.requestTokenFromEndpoint("/account/3pid/email/requestToken",{email:e,client_secret:t,send_attempt:r,next_link:n})}requestAdd3pidMsisdnToken(e,t,r,n,i){return this.requestTokenFromEndpoint("/account/3pid/msisdn/requestToken",{country:e,phone_number:t,client_secret:r,send_attempt:n,next_link:i})}requestPasswordEmailToken(e,t,r,n){return this.requestTokenFromEndpoint("/account/password/email/requestToken",{email:e,client_secret:t,send_attempt:r,next_link:n})}requestPasswordMsisdnToken(e,t,r,n,i){return this.requestTokenFromEndpoint("/account/password/msisdn/requestToken",{country:e,phone_number:t,client_secret:r,send_attempt:n,next_link:i})}requestTokenFromEndpoint(e,t){var r=this;return(0,i.A)(function*(){var n=Object.assign({},t);return r.http.request(S.IT.Post,e,void 0,n)})()}getRoomPushRule(e,t){if(this.pushRules){var r;return null==(r=this.pushRules[e])||null==(r=r.room)?void 0:r.find(e=>e.rule_id===t)}throw Error("SyncApi.sync() must be done before accessing to push rules.")}setRoomMutePushRule(e,t,r){var n,i=!1,s=this.getRoomPushRule(e,t);if(null!=s&&s.actions.includes(D.YU.DontNotify)&&(i=!0),r)if(s){if(!i){var o=Promise.withResolvers();this.deletePushRule(e,D.Ji.RoomSpecific,s.rule_id).then(()=>{this.addPushRule(e,D.Ji.RoomSpecific,t,{actions:[D.YU.DontNotify]}).then(()=>{o.resolve()}).catch(e=>{o.reject(e)})}).catch(e=>{o.reject(e)}),n=o.promise}}else n=this.addPushRule(e,D.Ji.RoomSpecific,t,{actions:[D.YU.DontNotify]});else i&&(n=this.deletePushRule(e,D.Ji.RoomSpecific,s.rule_id));if(n)return new Promise((e,t)=>{n.then(()=>{this.getPushRules().then(t=>{this.pushRules=t,e()}).catch(e=>{t(e)})}).catch(e=>{this.getPushRules().then(r=>{this.pushRules=r,t(e)}).catch(r=>{t(e)})})})}searchMessageText(e){var t={search_term:e.query};return"keys"in e&&(t.keys=e.keys),this.search({body:{search_categories:{room_events:t}}})}searchRoomEvents(e){var t={search_categories:{room_events:{search_term:e.term,filter:e.filter,order_by:q.g.Recent,event_context:{before_limit:1,after_limit:1,include_profile:!0}}}},r={_query:t,results:[],highlights:[]};return this.search({body:t}).then(e=>this.processRoomEventsSearch(r,e))}backPaginateRoomEventsSearch(e){if(!e.next_batch)return Promise.reject(Error("Cannot backpaginate event search any further"));if(e.pendingRequest)return e.pendingRequest;var t={body:e._query,next_batch:e.next_batch},r=this.search(t,e.abortSignal).then(t=>this.processRoomEventsSearch(e,t)).finally(()=>{e.pendingRequest=void 0});return e.pendingRequest=r,r}processRoomEventsSearch(e,t){var r,n,i=t.search_categories.room_events;e.count=i.count,e.next_batch=i.next_batch;var s=new Set(i.highlights);e.highlights.forEach(e=>{s.add(e)}),e.highlights=Array.from(s);for(var o=this.getEventMapper(),a=null!=(r=null==(n=i.results)?void 0:n.length)?r:0,d=0;d<a;d++){var l=b.q.fromJson(i.results[d],o),u=this.getRoom(l.context.getEvent().getRoomId());if(u)for(var h of l.context.getTimeline())h.setMetadata(u.currentState,!1);e.results.push(l)}return e}syncLeftRooms(){if(this.syncedLeftRooms)return Promise.resolve([]);if(this.syncLeftRoomsPromise)return this.syncLeftRoomsPromise;var e=new o.w_(this,this.clientOpts,this.buildSyncApiOptions());return this.syncLeftRoomsPromise=e.syncLeftRooms(),this.syncLeftRoomsPromise.then(()=>{this.logger.debug("Marking success of sync left room request"),this.syncedLeftRooms=!0}).finally(()=>{this.syncLeftRoomsPromise=void 0}),this.syncLeftRoomsPromise}createFilter(e){var t=v.RR("/user/$userId/filter",{$userId:this.credentials.userId});return this.http.authedRequest(S.IT.Post,t,void 0,e).then(t=>{var r=u.d.fromJson(this.credentials.userId,t.filter_id,e);return this.store.storeFilter(r),r})}getFilter(e,t,r){if(r){var n=this.store.getFilter(e,t);if(n)return Promise.resolve(n)}var i=v.RR("/user/$userId/filter/$filterId",{$userId:e,$filterId:t});return this.http.authedRequest(S.IT.Get,i).then(r=>{var n=u.d.fromJson(e,t,r);return this.store.storeFilter(n),n})}getOrCreateFilter(e,t){var r=this;return(0,i.A)(function*(){var n,i=r.store.getFilterIdByName(e);if(i){try{var s=yield r.getFilter(r.credentials.userId,i,!0);if(s){var o=s.getDefinition(),a=t.getDefinition();v.ky(o,a)&&(n=i)}}catch(e){if("M_UNKNOWN"!==e.errcode&&"M_NOT_FOUND"!==e.errcode)throw e}n||r.store.setFilterIdByName(e,void 0)}if(n)return n;var d=yield r.createFilter(t.getDefinition());return r.store.setFilterIdByName(e,d.filterId),d.filterId})()}getOpenIdToken(){var e=v.RR("/user/$userId/openid/request_token",{$userId:this.credentials.userId});return this.http.authedRequest(S.IT.Post,e,void 0,{})}turnServer(){return this.http.authedRequest(S.IT.Get,"/voip/turnServer")}getTurnServers(){return this.turnServers||[]}getTurnServersExpiry(){return this.turnServersExpiry}get pollingTurnServers(){return void 0!==this.checkTurnServersIntervalID}checkTurnServers(){var e=this;return(0,i.A)(function*(){if(e.supportsVoip()){var t=!1,r=e.turnServersExpiry-Date.now();if(r>6e5)e.logger.debug("TURN creds are valid for another "+r+" ms: not fetching new ones."),t=!0;else{e.logger.debug("Fetching new TURN credentials");try{var n=yield e.turnServer();n.uris&&(e.logger.debug("Got TURN URIs: "+n.uris+" refresh in "+n.ttl+" secs"),e.turnServers=[{urls:n.uris,username:n.username,credential:n.password}],e.turnServersExpiry=Date.now()+1e3*n.ttl,t=!0,e.emit(ey.TurnServers,e.turnServers))}catch(t){e.logger.error("Failed to get TURN URIs",t),403===t.httpStatus?(e.logger.info("TURN access unavailable for this account: stopping credentials checks"),null!==e.checkTurnServersIntervalID&&globalThis.clearInterval(e.checkTurnServersIntervalID),e.checkTurnServersIntervalID=void 0,e.emit(ey.TurnServersError,t,!0)):e.emit(ey.TurnServersError,t,!1)}}return t}})()}setFallbackICEServerAllowed(e){this.fallbackICEServerAllowed=e}isFallbackICEServerAllowed(){return this.fallbackICEServerAllowed}isSynapseAdministrator(){var e=v.RR("/_synapse/admin/v1/users/$userId/admin",{$userId:this.getUserId()});return this.http.authedRequest(S.IT.Get,e,void 0,void 0,{prefix:""}).then(e=>e.admin)}whoisSynapseUser(e){var t=v.RR("/_synapse/admin/v1/whois/$userId",{$userId:e});return this.http.authedRequest(S.IT.Get,t,void 0,void 0,{prefix:""})}deactivateSynapseUser(e){var t=v.RR("/_synapse/admin/v1/deactivate/$userId",{$userId:e});return this.http.authedRequest(S.IT.Post,t,void 0,void 0,{prefix:""})}fetchClientWellKnown(){var e=this;return(0,i.A)(function*(){var t;e.clientWellKnownPromise=g.MN.getRawClientConfig(null!=(t=e.getDomain())?t:void 0),e.clientWellKnown=yield e.clientWellKnownPromise,e.emit(ey.ClientWellKnown,e.clientWellKnown)})()}getClientWellKnown(){return this.clientWellKnown}waitForClientWellKnown(){if(!this.clientRunning)throw Error("Client is not running");return this.clientWellKnownPromise}storeClientOptions(){var e=["boolean","string","number"],t=Object.entries(this.clientOpts).filter(t=>{var[r,n]=t;return e.includes(typeof n)}).reduce((e,t)=>{var[r,n]=t;return e[r]=n,e},{});return this.store.storeClientOptions(t)}_unstable_getSharedRooms(e){var t=this;return(0,i.A)(function*(){var r,n,i=yield t.doesServerSupportUnstableFeature(el),s=yield t.doesServerSupportUnstableFeature(eu),o=yield t.doesServerSupportUnstableFeature(eh);if(!i&&!s&&!o)throw Error("Server does not support the Mutual Rooms API");o?(r="/uk.half-shot.msc2666/user/mutual_rooms",n={user_id:e}):(r=v.RR("/uk.half-shot.msc2666/user/".concat(s?"mutual_rooms":"shared_rooms","/$userId"),{$userId:e}),n={});var a=[],d=null;do{var l={};null!=d&&o&&(l.batch_token=d);var u=yield t.http.authedRequest(S.IT.Get,r,es(es({},n),l),void 0,{prefix:S.iD.Unstable});a.push(...u.joined),d=void 0!==u.next_batch_token?u.next_batch_token:null}while(null!=d);return a})()}_unstable_getRTCTransports(){var e=this;return(0,i.A)(function*(){return(yield e.http.authedRequest(S.IT.Get,"/rtc/transports",void 0,void 0,{prefix:"".concat(S.iD.Unstable,"/org.matrix.msc4143")})).rtc_transports})()}getVersions(){var e=this;return(0,i.A)(function*(){if(e.serverVersionsPromise)return e.serverVersionsPromise;e.serverVersionsPromise=e.http.authedRequest(S.IT.Get,"/_matrix/client/versions",void 0,void 0,{prefix:""}).catch(t=>{throw e.serverVersionsPromise=void 0,t});var t=yield e.serverVersionsPromise;return e.canSupport=yield(0,W.yk)(t),e.serverVersionsPromise})()}isVersionSupported(e){var t=this;return(0,i.A)(function*(){var{versions:r}=yield t.getVersions();return r&&r.includes(e)})()}doesServerSupportUnstableFeature(e){var t=this;return(0,i.A)(function*(){var r=yield t.getVersions();if(!r)return!1;var n=r.unstable_features;return n&&!!n[e]})()}doesServerForceEncryptionForPreset(e){var t=this;return(0,i.A)(function*(){var r=yield t.getVersions();if(!r)return!1;var n=r.unstable_features,i=e.includes("_chat")?e.substring(0,e.indexOf("_chat")):e;return n&&!!n["io.element.e2ee_forced.".concat(i)]})()}doesServerSupportThread(){var e=this;return(0,i.A)(function*(){if(yield e.isVersionSupported("v1.4"))return{threads:L.c1.Stable,list:L.c1.Stable,fwdPagination:L.c1.Stable};try{var[t,r,n,i,s,o]=yield Promise.all([e.doesServerSupportUnstableFeature("org.matrix.msc3440"),e.doesServerSupportUnstableFeature("org.matrix.msc3440.stable"),e.doesServerSupportUnstableFeature("org.matrix.msc3856"),e.doesServerSupportUnstableFeature("org.matrix.msc3856.stable"),e.doesServerSupportUnstableFeature("org.matrix.msc3715"),e.doesServerSupportUnstableFeature("org.matrix.msc3715.stable")]);return{threads:(0,L.FD)(r,t),list:(0,L.FD)(i,n),fwdPagination:(0,L.FD)(o,s)}}catch(e){return{threads:L.c1.None,list:L.c1.None,fwdPagination:L.c1.None}}})()}hasLazyLoadMembersEnabled(){var e;return!!(null!=(e=this.clientOpts)&&e.lazyLoadMembers)}setCanResetTimelineCallback(e){this.canResetTimelineCallback=e}getCanResetTimelineCallback(){return this.canResetTimelineCallback}relations(e,t,r,n){var s=arguments,o=this;return(0,i.A)(function*(){var i,a,d=s.length>4&&void 0!==s[4]?s[4]:{dir:p.O.Backward},l=n?o.getEncryptedIfNeededEventType(e,n):null,[u,h]=yield Promise.all([o.fetchRoomEvent(e,t),o.fetchRelations(e,t,r,l,d)]),c=o.getEventMapper(),v=u?c(u):void 0,m=h.chunk.map(c);if(l===w.Bx.RoomMessageEncrypted){var g=v?m.concat(v):m;yield Promise.all(g.map(e=>o.decryptEventIfNeeded(e))),null!==n&&(m=m.filter(e=>e.getType()===n))}return v&&r===w.zZ.Replace&&(m=m.filter(e=>e.getSender()===v.getSender())),{originalEvent:null!=v?v:null,events:m,nextBatch:null!=(i=h.next_batch)?i:null,prevBatch:null!=(a=h.prev_batch)?a:null}})()}generateClientSecret(){return(0,C.US)(32)}decryptEventIfNeeded(e,t){return e.isState()&&!this.enableEncryptedStateEvents?Promise.resolve():(e.shouldAttemptDecryption()&&this.getCrypto()&&e.attemptDecryption(this.cryptoBackend,t),e.isBeingDecrypted())?e.getDecryptionPromise():Promise.resolve()}termsUrlForService(e,t){switch(e){case I.S.IS:return this.http.getUrl("/terms",void 0,S.Pw.V2,t);case I.S.IM:return this.http.getUrl("/terms",void 0,"/_matrix/integrations/v1",t);default:throw Error("Unsupported service type")}}getHomeserverUrl(){return this.baseUrl}getIdentityServerUrl(){var e,t,r=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return r&&(null!=(e=this.idBaseUrl)&&e.startsWith("http://")||null!=(t=this.idBaseUrl)&&t.startsWith("https://"))?this.idBaseUrl.split("://")[1]:this.idBaseUrl}setIdentityServerUrl(e){this.idBaseUrl=v.hc(e),this.http.setIdBaseUrl(this.idBaseUrl)}getAccessToken(){return this.http.opts.accessToken||null}getRefreshToken(){var e;return null!=(e=this.http.opts.refreshToken)?e:null}setAccessToken(e){this.http.opts.accessToken=e,this.serverVersionsPromise=void 0}isLoggedIn(){return void 0!==this.http.opts.accessToken}makeTxnId(){return"m"+new Date().getTime()+"."+this.txnCtr++}isUsernameAvailable(e){return this.http.authedRequest(S.IT.Get,"/register/available",{username:e}).then(e=>e.available).catch(e=>"M_USER_IN_USE"!==e.errcode&&Promise.reject(e))}register(e,t,r,n,i,s,o){r&&(n.session=r);var a={auth:n,refresh_token:!0};return null!=e&&(a.username=e),null!=t&&(a.password=t),null!=s&&(a.guest_access_token=s),null!=o&&(a.inhibit_login=o),this.registerRequest(a)}registerGuest(){var{body:e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.registerRequest(e||{},"guest")}registerRequest(e,t){var r={};return t&&(r.kind=t),this.http.request(S.IT.Post,"/register",r,e)}refreshToken(e){var t=t=>this.http.authedRequest(S.IT.Post,"/refresh",void 0,{refresh_token:e},{prefix:t,inhibitLogoutEmit:!0});return t(S.iD.V3).catch(e=>{if("M_UNRECOGNIZED"===e.errcode)return t(S.iD.V1);throw e})}loginFlows(){return this.http.request(S.IT.Get,"/login")}login(e,t){return this.loginRequest(es(es({},t),{},{type:e})).then(e=>(e.access_token&&e.user_id&&(this.http.opts.accessToken=e.access_token,this.credentials={userId:e.user_id}),e))}loginWithPassword(e,t){return this.login("m.login.password",{user:e,password:t})}getCasLoginUrl(e){return this.getSsoLoginUrl(e,"cas")}getSsoLoginUrl(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"sso",r=arguments.length>2?arguments[2]:void 0,n=arguments.length>3?arguments[3]:void 0,i="/login/"+t+"/redirect";r&&(i+="/"+r);var s={redirectUrl:e,[eR.stable]:n,[eR.unstable]:n};return this.http.getUrl(i,s).href}loginWithToken(e){return this.login("m.login.token",{token:e})}loginRequest(e){var t=this;return(0,i.A)(function*(){return yield t.http.authedRequest(S.IT.Post,"/login",void 0,e)})()}logout(){var e=arguments,t=this;return(0,i.A)(function*(){return e.length>0&&void 0!==e[0]&&e[0]&&(t.stopClient(),t.http.abort()),t.http.authedRequest(S.IT.Post,"/logout")})()}deactivateAccount(e,t){var r={};return e&&(r.auth=e),void 0!==t&&(r.erase=t),this.http.authedRequest(S.IT.Post,"/account/deactivate",void 0,r)}requestLoginToken(e){var t=this;return(0,i.A)(function*(){return t.http.authedRequest(S.IT.Post,"/login/get_token",void 0,{auth:e},{prefix:S.iD.V1})})()}getFallbackAuthUrl(e,t){var r=v.RR("/auth/$loginType/fallback/web",{$loginType:e});return this.http.getUrl(r,{session:t}).href}createRoom(e){var t=this;return(0,i.A)(function*(){var r,n=(e.invite_3pid||[]).filter(e=>!e.id_access_token);if(n.length>0&&null!=(r=t.identityServer)&&r.getAccessToken){var i=yield t.identityServer.getAccessToken();if(i)for(var s of n)s.id_access_token=i}return t.http.authedRequest(S.IT.Post,"/createRoom",void 0,e)})()}fetchRelations(e,t,r,n){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{dir:p.O.Backward},s=i;L.jV.hasServerSideFwdPaginationSupport===L.c1.Experimental&&(s=(0,v.Ab)("dir","org.matrix.msc3715.dir",s)),this.canSupport.get(W.Xj.RelationsRecursion)===W.Tj.Unstable&&(s=(0,v.Ab)("recurse","org.matrix.msc3981.recurse",s));var o=v.hm(s),a="/rooms/$roomId/relations/$eventId";null!==r?(a+="/$relationType",null!==n&&(a+="/$eventType")):null!==n&&(this.logger.warn("eventType: ".concat(n," ignored when fetching\n            relations as relationType is null")),n=null);var d=v.RR(a+"?"+o,{$roomId:e,$eventId:t,$relationType:r,$eventType:n});return this.http.authedRequest(S.IT.Get,d,void 0,void 0,{prefix:S.iD.V1})}roomState(e){var t=v.RR("/rooms/$roomId/state",{$roomId:e});return this.http.authedRequest(S.IT.Get,t)}fetchRoomEvent(e,t){var r=v.RR("/rooms/$roomId/event/$eventId",{$roomId:e,$eventId:t});return this.http.authedRequest(S.IT.Get,r)}members(e,t,r,n){var i={};t&&(i.membership=t),r&&(i.not_membership=r),n&&(i.at=n);var s=v.hm(i),o=v.RR("/rooms/$roomId/members?"+s,{$roomId:e});return this.http.authedRequest(S.IT.Get,o)}upgradeRoom(e,t,r){var n=v.RR("/rooms/$roomId/upgrade",{$roomId:e});return this.http.authedRequest(S.IT.Post,n,void 0,{new_version:t,additional_creators:r})}getStateEvent(e,t,r){var n={$roomId:e,$eventType:t,$stateKey:r},i=v.RR("/rooms/$roomId/state/$eventType",n);return void 0!==r&&(i=v.RR(i+"/$stateKey",n)),this.http.authedRequest(S.IT.Get,i)}sendStateEvent(e,t,r){var n=arguments,s=this;return(0,i.A)(function*(){var i=n.length>3&&void 0!==n[3]?n[3]:"",o=n.length>4&&void 0!==n[4]?n[4]:{},d=s.getRoom(e),l=new a.kl({room_id:e,type:t,state_key:i,content:r});yield s.encryptStateEventIfNeeded(l,null!=d?d:void 0);var u={$roomId:e,$eventType:l.getWireType(),$stateKey:l.getWireStateKey()},h=v.RR("/rooms/$roomId/state/$eventType",u);return void 0!==i&&(h=v.RR(h+"/$stateKey",u)),s.http.authedRequest(S.IT.Put,h,void 0,l.getWireContent(),o)})()}encryptStateEventIfNeeded(e,t){var r=this;return(0,i.A)(function*(){if(r.enableEncryptedStateEvents&&t&&(r.cryptoBackend||!r.usingExternalCrypto)){if(!r.cryptoBackend)throw Error("This room is configured to use encryption, but your client does not support encryption.");(yield r.shouldEncryptEventForRoom(e,t))&&(yield r.cryptoBackend.isStateEncryptionEnabledInRoom(t.roomId))&&(["m.room.create","m.room.member","m.room.join_rules","m.room.power_levels","m.room.third_party_invite","m.room.history_visibility","m.room.guest_access","m.room.encryption"].includes(e.getType())||(yield r.cryptoBackend.encryptEvent(e,t)))}})()}roomInitialSync(e,t){var r,n=v.RR("/rooms/$roomId/initialSync",{$roomId:e});return this.http.authedRequest(S.IT.Get,n,{limit:null!=(r=null==t?void 0:t.toString())?r:"30"})}setRoomReadMarkersHttpRequest(e,t,r,n){var s=this;return(0,i.A)(function*(){var i=v.RR("/rooms/$roomId/read_markers",{$roomId:e}),o={[M.L.FullyRead]:t,[M.L.Read]:r};return((yield s.doesServerSupportUnstableFeature("org.matrix.msc2285.stable"))||(yield s.isVersionSupported("v1.4")))&&(o[M.L.ReadPrivate]=n),s.http.authedRequest(S.IT.Post,i,void 0,o)})()}getJoinedRooms(){var e=v.RR("/joined_rooms",{});return this.http.authedRequest(S.IT.Get,e)}getJoinedRoomMembers(e){var t=v.RR("/rooms/$roomId/joined_members",{$roomId:e});return this.http.authedRequest(S.IT.Get,t)}publicRooms(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{server:t,limit:r,since:i}=e,s=(0,n.A)(e,en);if(0===Object.keys(s).length)return this.http.authedRequest(S.IT.Get,"/publicRooms",{server:t,limit:r,since:i});var o=es({limit:r,since:i},s);return this.http.authedRequest(S.IT.Post,"/publicRooms",{server:t},o)}createAlias(e,t){var r=v.RR("/directory/room/$alias",{$alias:e});return this.http.authedRequest(S.IT.Put,r,void 0,{room_id:t})}deleteAlias(e){var t=v.RR("/directory/room/$alias",{$alias:e});return this.http.authedRequest(S.IT.Delete,t)}getLocalAliases(e){var t=v.RR("/rooms/$roomId/aliases",{$roomId:e}),r=S.iD.V3;return this.http.authedRequest(S.IT.Get,t,void 0,void 0,{prefix:r})}getRoomIdForAlias(e){var t=v.RR("/directory/room/$alias",{$alias:e});return this.http.authedRequest(S.IT.Get,t)}getRoomDirectoryVisibility(e){var t=v.RR("/directory/list/room/$roomId",{$roomId:e});return this.http.authedRequest(S.IT.Get,t)}setRoomDirectoryVisibility(e,t){var r=v.RR("/directory/list/room/$roomId",{$roomId:e});return this.http.authedRequest(S.IT.Put,r,void 0,{visibility:t})}searchUserDirectory(e){var{term:t,limit:r}=e,n={search_term:t};return void 0!==r&&(n.limit=r),this.http.authedRequest(S.IT.Post,"/user_directory/search",void 0,n)}uploadContent(e,t){return this.http.uploadContent(e,t)}cancelUpload(e){return this.http.cancelUpload(e)}getCurrentUploads(){return this.http.getCurrentUploads()}getProfileInfo(e,t){var r=t?v.RR("/profile/$userId/$info",{$userId:e,$info:t}):v.RR("/profile/$userId",{$userId:e});return this.http.authedRequest(S.IT.Get,r)}doesServerSupportExtendedProfiles(){var e=this;return(0,i.A)(function*(){return(yield e.isVersionSupported("v1.16"))||(yield e.doesServerSupportUnstableFeature(ep))||(yield e.doesServerSupportUnstableFeature(em))})()}getExtendedProfileRequestPrefix(){var e=this;return(0,i.A)(function*(){return(yield e.isVersionSupported("v1.16"))||(yield e.doesServerSupportUnstableFeature("uk.tcpip.msc4133.stable"))?S.iD.V3:"/_matrix/client/unstable/uk.tcpip.msc4133"})()}getExtendedProfile(e){var t=this;return(0,i.A)(function*(){if(!(yield t.doesServerSupportExtendedProfiles()))throw Error("Server does not support extended profiles");return t.http.authedRequest(S.IT.Get,v.RR("/profile/$userId",{$userId:e}),void 0,void 0,{prefix:yield t.getExtendedProfileRequestPrefix()})})()}getExtendedProfileProperty(e,t){var r=this;return(0,i.A)(function*(){if(!(yield r.doesServerSupportExtendedProfiles()))throw Error("Server does not support extended profiles");return(yield r.http.authedRequest(S.IT.Get,v.RR("/profile/$userId/$key",{$userId:e,$key:t}),void 0,void 0,{prefix:yield r.getExtendedProfileRequestPrefix()}))[t]})()}setExtendedProfileProperty(e,t){var r=this;return(0,i.A)(function*(){if(!(yield r.doesServerSupportExtendedProfiles()))throw Error("Server does not support extended profiles");var n=r.getUserId();yield r.http.authedRequest(S.IT.Put,v.RR("/profile/$userId/$key",{$userId:n,$key:e}),void 0,{[e]:t},{prefix:yield r.getExtendedProfileRequestPrefix()})})()}deleteExtendedProfileProperty(e){var t=this;return(0,i.A)(function*(){if(!(yield t.doesServerSupportExtendedProfiles()))throw Error("Server does not support extended profiles");var r=t.getUserId();yield t.http.authedRequest(S.IT.Delete,v.RR("/profile/$userId/$key",{$userId:r,$key:e}),void 0,void 0,{prefix:yield t.getExtendedProfileRequestPrefix()})})()}patchExtendedProfile(e){var t=this;return(0,i.A)(function*(){if(!(yield t.doesServerSupportExtendedProfiles()))throw Error("Server does not support extended profiles");var r=t.getUserId();return t.http.authedRequest(S.IT.Patch,v.RR("/profile/$userId",{$userId:r}),{},e,{prefix:yield t.getExtendedProfileRequestPrefix()})})()}setExtendedProfile(e){var t=this;return(0,i.A)(function*(){if(!(yield t.doesServerSupportExtendedProfiles()))throw Error("Server does not support extended profiles");var r=t.getUserId();yield t.http.authedRequest(S.IT.Put,v.RR("/profile/$userId",{$userId:r}),{},e,{prefix:yield t.getExtendedProfileRequestPrefix()})})()}getThreePids(){return this.http.authedRequest(S.IT.Get,"/account/3pid")}addThreePidOnly(e){var t=this;return(0,i.A)(function*(){return t.http.authedRequest(S.IT.Post,"/account/3pid/add",void 0,e)})()}bindThreePid(e){var t=this;return(0,i.A)(function*(){return t.http.authedRequest(S.IT.Post,"/account/3pid/bind",void 0,e)})()}unbindThreePid(e,t){var r=this;return(0,i.A)(function*(){var n={medium:e,address:t,id_server:r.getIdentityServerUrl(!0)};return r.http.authedRequest(S.IT.Post,"/account/3pid/unbind",void 0,n)})()}deleteThreePid(e,t){return this.http.authedRequest(S.IT.Post,"/account/3pid/delete",void 0,{medium:e,address:t})}setPassword(e,t,r){return this.http.authedRequest(S.IT.Post,"/account/password",void 0,{auth:e,new_password:t,logout_devices:r})}getDevices(){return this.http.authedRequest(S.IT.Get,"/devices")}getDevice(e){var t=v.RR("/devices/$device_id",{$device_id:e});return this.http.authedRequest(S.IT.Get,t)}setDeviceDetails(e,t){var r=v.RR("/devices/$device_id",{$device_id:e});return this.http.authedRequest(S.IT.Put,r,void 0,t)}deleteDevice(e,t){var r=v.RR("/devices/$device_id",{$device_id:e}),n={};return t&&(n.auth=t),this.http.authedRequest(S.IT.Delete,r,void 0,n)}deleteMultipleDevices(e,t){var r={devices:e};return t&&(r.auth=t),this.http.authedRequest(S.IT.Post,"/delete_devices",void 0,r)}getPushers(){var e=this;return(0,i.A)(function*(){var t=yield e.http.authedRequest(S.IT.Get,"/pushers");return(yield e.doesServerSupportUnstableFeature("org.matrix.msc3881"))||(t.pushers=t.pushers.map(e=>(e.hasOwnProperty(w.cr.name)||(e[w.cr.name]=!0),e))),t})()}setPusher(e){return this.http.authedRequest(S.IT.Post,"/pushers/set",void 0,e)}removePusher(e,t){return this.http.authedRequest(S.IT.Post,"/pushers/set",void 0,{pushkey:e,app_id:t,kind:null})}setLocalNotificationSettings(e,t){var r="".concat(w.Xs.name,".").concat(e);return this.setAccountData(r,t)}getPushRules(){return this.http.authedRequest(S.IT.Get,"/pushrules/").then(e=>(this.setPushRules(e),this.pushRules))}setPushRules(e){this.pushRules=m.j.rewriteDefaultRules(this.logger,e,this.getUserId()),this.pushProcessor.updateCachedPushRuleKeys(this.pushRules)}addPushRule(e,t,r,n){var i=v.RR("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:r});return this.http.authedRequest(S.IT.Put,i,void 0,n)}deletePushRule(e,t,r){var n=v.RR("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:r});return this.http.authedRequest(S.IT.Delete,n)}setPushRuleEnabled(e,t,r,n){var i=v.RR("/pushrules/"+e+"/$kind/$ruleId/enabled",{$kind:t,$ruleId:r});return this.http.authedRequest(S.IT.Put,i,void 0,{enabled:n})}setPushRuleActions(e,t,r,n){var i=v.RR("/pushrules/"+e+"/$kind/$ruleId/actions",{$kind:t,$ruleId:r});return this.http.authedRequest(S.IT.Put,i,void 0,{actions:n})}search(e,t){var{body:r,next_batch:n}=e,i={};return n&&(i.next_batch=n),this.http.authedRequest(S.IT.Post,"/search",i,r,{abortSignal:t})}uploadKeysRequest(e,t){return this.http.authedRequest(S.IT.Post,"/keys/upload",void 0,e)}uploadKeySignatures(e){return this.http.authedRequest(S.IT.Post,"/keys/signatures/upload",void 0,e)}downloadKeysForUsers(e){var{token:t}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r={device_keys:{}};return void 0!==t&&(r.token=t),e.forEach(e=>{r.device_keys[e]=[]}),this.http.authedRequest(S.IT.Post,"/keys/query",void 0,r)}claimOneTimeKeys(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"signed_curve25519",r=arguments.length>2?arguments[2]:void 0,n={};for(var[i,s]of(void 0===t&&(t="signed_curve25519"),e)){var o=n[i]||{};(0,v.C6)(n,i,o),(0,v.C6)(o,s,t)}var a={one_time_keys:n};return r&&(a.timeout=r),this.http.authedRequest(S.IT.Post,"/keys/claim",void 0,a)}getKeyChanges(e,t){return this.http.authedRequest(S.IT.Get,"/keys/changes",{from:e,to:t})}uploadDeviceSigningKeys(e,t){var r=Object.assign({},t);return e&&Object.assign(r,{auth:e}),this.http.authedRequest(S.IT.Post,"/keys/device_signing/upload",void 0,r,{prefix:S.iD.Unstable})}registerWithIdentityServer(e){if(!this.idBaseUrl)throw Error("No identity server base URL set");var t=this.http.getUrl("/account/register",void 0,S.Pw.V2,this.idBaseUrl);return this.http.requestOtherUrl(S.IT.Post,t,e)}requestEmailToken(e,t,r,n,i){var s={client_secret:t,email:e,send_attempt:null==r?void 0:r.toString()};return n&&(s.next_link=n),this.http.idServerRequest(S.IT.Post,"/validate/email/requestToken",s,S.Pw.V2,i)}requestMsisdnToken(e,t,r,n,i,s){var o={client_secret:r,country:e,phone_number:t,send_attempt:null==n?void 0:n.toString()};return i&&(o.next_link=i),this.http.idServerRequest(S.IT.Post,"/validate/msisdn/requestToken",o,S.Pw.V2,s)}submitMsisdnToken(e,t,r,n){return this.http.idServerRequest(S.IT.Post,"/validate/msisdn/submitToken",{sid:e,client_secret:t,token:r},S.Pw.V2,null!=n?n:void 0)}submitMsisdnTokenOtherUrl(e,t,r,n){return this.http.requestOtherUrl(S.IT.Post,e,{sid:t,client_secret:r,token:n})}getIdentityHashDetails(e){return this.http.idServerRequest(S.IT.Get,"/hash_details",void 0,S.Pw.V2,e)}identityHashedLookup(e,t){var r=this;return(0,i.A)(function*(){var n,s={},o=yield r.getIdentityHashDetails(t);if(!o||!o.lookup_pepper||!o.algorithms)throw Error("Unsupported identity server: bad response");s.pepper=o.lookup_pepper;var a={};if(o.algorithms.includes("sha256"))s.addresses=yield Promise.all(e.map((n=(0,i.A)(function*(e){var t=e[0].toLowerCase(),r=e[1].toLowerCase(),n=yield(0,ee.s)("".concat(t," ").concat(r," ").concat(s.pepper)),i=(0,y.A4)(n);return a[i]=e[0],i}),function(e){return n.apply(this,arguments)}))),s.algorithm="sha256";else if(o.algorithms.includes("none"))s.addresses=e.map(e=>{var t=e[0].toLowerCase(),r=e[1].toLowerCase(),n="".concat(t," ").concat(r);return a[n]=e[0],n}),s.algorithm="none";else throw Error("Unsupported identity server: unknown hash algorithm");var d=yield r.http.idServerRequest(S.IT.Post,"/lookup",s,S.Pw.V2,t);if(!(null!=d&&d.mappings))return[];var l=[];for(var u of Object.keys(d.mappings)){var h=d.mappings[u],c=a[u];if(!c)throw Error("Identity server returned more results than expected");l.push({address:c,mxid:h})}return l})()}lookupThreePid(e,t,r){var n=this;return(0,i.A)(function*(){var i=(yield n.identityHashedLookup([[t,e]],r)).find(e=>e.address===t);return i?{address:t,medium:e,mxid:i.mxid}:{}})()}bulkLookupThreePids(e,t){var r=this;return(0,i.A)(function*(){var n=yield r.identityHashedLookup(e.map(e=>[e[1],e[0]]),t),i=[],s=function*(t){var r=e.find(e=>e[1]===t.address);if(!r)throw Error("Identity sever returned unexpected results");i.push([r[0],t.address,t.mxid])};for(var o of n)yield*s(o);return{threepids:i}})()}getIdentityAccount(e){return this.http.idServerRequest(S.IT.Get,"/account",void 0,S.Pw.V2,e)}sendToDevice(e,t,r){var n=v.RR("/sendToDevice/$eventType/$txnId",{$eventType:e,$txnId:r||this.makeTxnId()}),i={messages:v.HF(t)},s=new Map;for(var[o,a]of t)s.set(o,Array.from(a.keys()));return this.logger.debug("PUT ".concat(n),s),this.http.authedRequest(S.IT.Put,n,void 0,i)}encryptAndSendToDevice(e,t,r){var n=this;return(0,i.A)(function*(){if(!n.cryptoBackend)throw Error("Cannot encrypt to device event, your client does not support encryption.");var i=yield n.cryptoBackend.encryptToDeviceMessages(e,t,r);yield n.queueToDevice(i)})()}queueToDevice(e){return this.toDeviceMessageQueue.queueBatch(e)}getThirdpartyProtocols(){return this.http.authedRequest(S.IT.Get,"/thirdparty/protocols").then(e=>{if(!e||"object"!=typeof e)throw Error("/thirdparty/protocols did not return an object: ".concat(e));return e})}getThirdpartyLocation(e,t){var r=v.RR("/thirdparty/location/$protocol",{$protocol:e});return this.http.authedRequest(S.IT.Get,r,t)}getThirdpartyUser(e,t){var r=v.RR("/thirdparty/user/$protocol",{$protocol:e});return this.http.authedRequest(S.IT.Get,r,t)}getTerms(e,t){var r=this.termsUrlForService(e,t);return this.http.requestOtherUrl(S.IT.Get,r)}agreeToTerms(e,t,r,n){var i=this.termsUrlForService(e,t);return this.http.requestOtherUrl(S.IT.Post,i,{user_accepts:n},{headers:{Authorization:"Bearer "+r}})}reportEvent(e,t,r,n){var i=v.RR("/rooms/$roomId/report/$eventId",{$roomId:e,$eventId:t});return this.http.authedRequest(S.IT.Post,i,void 0,{score:r,reason:n})}reportRoom(e,t){var r=v.RR("/rooms/$roomId/report",{$roomId:e});return this.http.authedRequest(S.IT.Post,r,void 0,{reason:t})}getRoomHierarchy(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]&&arguments[3],i=arguments.length>4?arguments[4]:void 0,s=v.RR("/rooms/$roomId/hierarchy",{$roomId:e}),o={suggested_only:String(n),max_depth:null==r?void 0:r.toString(),from:i,limit:null==t?void 0:t.toString()};return this.http.authedRequest(S.IT.Get,s,o,void 0,{prefix:S.iD.V1}).catch(e=>{if("M_UNRECOGNIZED"===e.errcode)return this.http.authedRequest(S.IT.Get,s,o,void 0,{prefix:"/_matrix/client/unstable/org.matrix.msc2946"});throw e})}unstableCreateFileTree(e){var t=this;return(0,i.A)(function*(){var{room_id:r}=yield t.createRoom({name:e,preset:$.k.PrivateChat,power_level_content_override:es(es({},U.mG),{},{users:{[t.getUserId()]:100}}),creation_content:{[w.Ct]:w.CJ.Space},initial_state:[{type:w.D7.name,state_key:w.nN.name,content:{[w.ud.name]:!0}},{type:w.Bx.RoomEncryption,state_key:"",content:{algorithm:"m.megolm.v1.aes-sha2"}}]});return new U.wZ(t,r)})()}unstableGetFileTreeSpace(e){var t,r,n=this.getRoom(e);if((null==n?void 0:n.getMyMembership())!==Y.O.Join)return null;var i=n.currentState.getStateEvents(w.Bx.RoomCreate,""),s=n.currentState.getStateEvents(w.D7.name,w.nN.name);if(!i)throw Error("Expected single room create event");return null!=s&&null!=(t=s.getContent())&&t[w.ud.name]&&(null==(r=i.getContent())?void 0:r[w.Ct])===w.CJ.Space?new U.wZ(this,e):null}slidingSync(e,t,r){var n={};e.pos&&(n.pos=e.pos,delete e.pos),e.timeout&&(n.timeout=e.timeout,delete e.timeout);var i=e.clientTimeout;return delete e.clientTimeout,this.http.authedRequest(S.IT.Post,"/sync",n,e,{prefix:"/_matrix/client/unstable/org.matrix.simplified_msc3575",baseUrl:t,localTimeoutMs:i,abortSignal:r})}supportsThreads(){var e;return(null==(e=this.clientOpts)?void 0:e.threadSupport)||!1}supportsIntentionalMentions(){return this.canSupport.get(W.Xj.IntentionalMentions)!==W.Tj.Unsupported}getRoomSummary(e,t){var r=this;return(0,i.A)(function*(){var n={prefix:"/_matrix/client/unstable/im.nheko.summary"};try{var i=v.RR("/summary/$roomid",{$roomid:e});return yield r.http.authedRequest(S.IT.Get,i,{via:t},void 0,n)}catch(i){if(i instanceof S.up&&"M_UNRECOGNIZED"===i.errcode){var s=v.RR("/rooms/$roomid/summary",{$roomid:e});return yield r.http.authedRequest(S.IT.Get,s,{via:t},void 0,n)}throw i}})()}processThreadEvents(e,t,r){e.processThreadedEvents(t,r)}processThreadRoots(e,t,r){this.supportsThreads()&&e.processThreadRoots(t,r)}processBeaconEvents(e,t){this.processAggregatedTimelineEvents(e,t)}processAggregatedTimelineEvents(e,t){null!=t&&t.length&&e&&(e.currentState.processBeaconEvents(t,this),e.processPollEvents(t))}whoami(){var e=this;return(0,i.A)(function*(){return e.http.authedRequest(S.IT.Get,"/account/whoami")})()}timestampToEvent(e,t,r){var n=this;return(0,i.A)(function*(){var i=v.RR("/rooms/$roomId/timestamp_to_event",{$roomId:e}),s={ts:t.toString(),dir:r};try{return yield n.http.authedRequest(S.IT.Get,i,s,void 0,{prefix:S.iD.V1})}catch(e){if("M_UNRECOGNIZED"===e.errcode&&(400===e.httpStatus||404===e.httpStatus||405===e.httpStatus))return yield n.http.authedRequest(S.IT.Get,i,s,void 0,{prefix:"/_matrix/client/unstable/org.matrix.msc3030"});throw e}})()}getAuthMetadata(){var e=this;return(0,i.A)(function*(){var t;try{var r=yield e.isVersionSupported("v1.15");t=yield e.http.request(S.IT.Get,"/auth_metadata",void 0,void 0,{prefix:r?S.iD.V1:S.iD.Unstable+"/org.matrix.msc2965"})}catch(t){if(t instanceof S.up&&"M_UNRECOGNIZED"===t.errcode){var{issuer:n}=yield e.http.request(S.IT.Get,"/auth_issuer",void 0,void 0,{prefix:S.iD.Unstable+"/org.matrix.msc2965"});return(0,et.k8)(n)}throw t}return(0,et.Pl)(t)})()}}function eI(e){return Object.fromEntries(Object.entries(e).map(e=>{var[t,r]=e;return["".concat(ec,".").concat(t),r]}))}function eS(e,t){var r,n,i=e.getUserId(),s=t.getId(),o=e.getRoom(t.getRoomId());if(o&&i&&s){if(!o.findEventById(s))return void f.vF.info("Decrypted event ".concat(t.getId()," is not in room ").concat(o.roomId,": ignoring"));var a=!!t.threadRootId&&!t.isThreadRoot;if(a){var d=o.getThread(t.threadRootId);n=!d||d.hasUserReadEvent(i,s)}else n=o.hasUserReadEvent(i,s);if(!n){var l=e.getPushActionsForEvent(t,!0);if(null!=l&&null!=(r=l.tweaks)&&r.highlight){var u=o.getUnreadCountForEventContext(_.X5.Highlight,t)+1;a?o.setThreadUnreadNotificationCount(t.threadRootId,_.X5.Highlight,u):o.setUnreadNotificationCount(_.X5.Highlight,u)}if(null!=l&&l.notify){var h=o.getUnreadCountForEventContext(_.X5.Total,t)+1;a?o.setThreadUnreadNotificationCount(t.threadRootId,_.X5.Total,h):o.setUnreadNotificationCount(_.X5.Total,h)}}}}function eT(e){return eE(e)?M.S:e.threadRootId}function eE(e){return!e.threadRootId||!!e.isThreadRoot||(e.isRelation()?!e.isRelation(L.RN.name)&&e.relationEventId===e.threadRootId:(f.vF.warn("Event is not a relation or a thread root, but still has a threadRootId! id=".concat(e.getId())),!0))}(0,s.A)(ef,"RESTORE_BACKUP_ERROR_BAD_KEY","RESTORE_BACKUP_ERROR_BAD_KEY")}}]);